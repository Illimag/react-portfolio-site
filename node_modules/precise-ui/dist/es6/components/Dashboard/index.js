var __rest = (this && this.__rest) || function (s, e) {
    var t = {};
    for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)
        t[p] = s[p];
    if (s != null && typeof Object.getOwnPropertySymbols === "function")
        for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) if (e.indexOf(p[i]) < 0)
            t[p[i]] = s[p[i]];
    return t;
};
import * as React from 'react';
import styled from '../../utils/styled';
import { InteractiveSurface } from '../InteractiveSurface';
import { Grid } from '../Grid';
import { GridArea } from '../GridArea';
function clamp(lower, value, upper) {
    return Math.min(Math.max(lower, value), upper);
}
function calc(rel, off, total, dim) {
    const value = clamp(0, rel * total - off, total - dim);
    return `${value}px`;
}
function repeat(count, dim) {
    const value = dim !== undefined ? `${dim}px` : '1fr';
    if (count !== undefined) {
        const values = [];
        for (let i = 0; i < count; i++) {
            values.push(value);
        }
        return values;
    }
    return value;
}
function collides(a, b) {
    if (a.hidden || b.hidden) {
        return false;
    }
    else if (a.column !== undefined && a.row !== undefined && b.column !== undefined && b.row !== undefined) {
        const { colSpan: acp = 1, rowSpan: arp = 1 } = a;
        const { colSpan: bcp = 1, rowSpan: brp = 1 } = b;
        const acs = a.column;
        const ace = a.column + acp - 1;
        const ars = a.row;
        const are = a.row + arp - 1;
        const bcs = b.column;
        const bce = b.column + bcp - 1;
        const brs = b.row;
        const bre = b.row + brp - 1;
        return acs <= bce && ace >= bcs && ars <= bre && are >= brs;
    }
    return false;
}
function notEqual(a, b) {
    if (a !== b) {
        if (a.length !== b.length) {
            return true;
        }
        for (let i = a.length; i--;) {
            const at = a[i];
            const bt = b[i];
            if (at !== bt ||
                at.colSpan !== bt.colSpan ||
                at.column !== bt.column ||
                at.id !== bt.id ||
                at.row !== bt.row ||
                at.rowSpan !== bt.rowSpan) {
                return true;
            }
        }
    }
    return false;
}
function resetStyle(node) {
    // tslint:disable-next-line
    const defaultValue = null;
    const style = node.style;
    style.position = 'static';
    style.cursor = defaultValue;
    style.width = defaultValue;
    style.height = defaultValue;
    style.left = defaultValue;
    style.top = defaultValue;
    style.zIndex = defaultValue;
}
const Preview = styled.div `
  background: #eee;
  border: 1px dashed #ccc;
  width: 100%;
  height: 100%;
`;
function getPreview(preview, tile) {
    const content = preview === true ? React.createElement(Preview, null) : preview;
    return (React.createElement(GridArea, { colSpan: tile.colSpan, rowSpan: tile.rowSpan, column: tile.column, row: tile.row }, content));
}
const defaultActiveTile = {
    x: 0,
    y: 0,
    width: 0,
    height: 0,
};
function changeTile(oldTiles, newTile) {
    let changed = false;
    const newTiles = oldTiles.map(tile => {
        if (tile.id === newTile.id) {
            changed =
                changed ||
                    tile.colSpan !== newTile.colSpan ||
                    tile.column !== newTile.column ||
                    tile.hidden !== newTile.hidden ||
                    tile.row !== newTile.row ||
                    tile.rowSpan !== newTile.rowSpan;
            return newTile;
        }
        else if (collides(tile, newTile)) {
            changed = true;
            return {
                id: tile.id,
                colSpan: tile.colSpan,
                rowSpan: tile.rowSpan,
            };
        }
        return tile;
    });
    return changed ? newTiles : oldTiles;
}
/**
 * Dashboard component.
 */
export class Dashboard extends React.Component {
    constructor(props) {
        super(props);
        this.setters = [];
        this.dragTile = (e) => {
            const { activeTile } = this;
            if (activeTile) {
                const node = activeTile.node;
                const current = activeTile.current;
                if (!e.moved) {
                }
                else if (e.active) {
                    const style = node.style;
                    style.left = calc(e.x, activeTile.x, e.rect.width, activeTile.width);
                    style.top = calc(e.y, activeTile.y, e.rect.height, activeTile.height);
                    this.previewDrag(e.x, e.y, current);
                }
                else {
                    const pos = this.getTargetPosition(e.x, e.y, current);
                    resetStyle(node);
                    this.finishDrag(Object.assign({}, current, { column: pos.column, row: pos.row }));
                }
            }
            else {
                e.release();
            }
        };
        this.setLayout = ({ layout }) => {
            this.layout = layout;
        };
        const { defaultTiles = [] } = props;
        this.state = {
            tiles: [...defaultTiles],
            live: undefined,
        };
    }
    UNSAFE_componentWillReceiveProps(nextProps) {
        const { defaultTiles: currTiles = [] } = this.props;
        const { defaultTiles: nextTiles = [] } = nextProps;
        if (notEqual(currTiles, nextTiles)) {
            this.setState({
                tiles: [...nextTiles],
                live: undefined,
            });
        }
    }
    finishDrag(newTile) {
        const { onChange } = this.props;
        const { tiles: oldTiles } = this.state;
        const newTiles = changeTile(oldTiles, newTile);
        this.activeTile = undefined;
        if (newTiles !== oldTiles) {
            this.setState({
                tiles: newTiles,
                live: undefined,
            });
            if (typeof onChange === 'function') {
                onChange({
                    tile: newTile,
                    tiles: newTiles,
                });
            }
        }
        else {
            this.setState({
                live: undefined,
            });
        }
    }
    previewDrag(h, v, tile) {
        const active = this.activeTile;
        const { preview } = this.props;
        const { live, tiles } = this.state;
        if (preview && active && live) {
            const current = active.current;
            const pos = this.getTargetPosition(h, v, tile);
            const last = live[active.index];
            if (pos.column !== last.column || pos.row !== last.row) {
                this.setState({
                    live: changeTile(tiles, Object.assign({}, current, { column: pos.column, row: pos.row })),
                });
            }
        }
    }
    getTargetPosition(h, v, tile) {
        const { columns, rows } = this.layout;
        const { colSpan = 1, rowSpan = 1 } = tile;
        const { x, y, width, height } = this.activeTile || defaultActiveTile;
        const totalRows = rows.length;
        const totalColumns = columns.length;
        const columnOffset = ~~((x * colSpan) / width);
        const rowOffset = ~~((y * rowSpan) / height);
        return {
            column: clamp(0, ~~(h * totalColumns) - columnOffset, totalColumns - colSpan),
            row: clamp(0, ~~(v * totalRows) - rowOffset, totalRows - rowSpan),
        };
    }
    setActiveTile(e, index) {
        const { disabled } = this.props;
        const { tiles } = this.state;
        const current = tiles[index];
        if (!disabled) {
            this.activeTile = Object.assign({}, e, { index,
                current });
            const style = e.node.style;
            style.cursor = 'move';
            style.position = 'absolute';
            style.width = `${e.width}px`;
            style.height = `${e.height}px`;
            style.zIndex = '100000000';
            this.setState({
                live: tiles,
            });
        }
    }
    render() {
        const _a = this.props, { columnWidth, columnCount = 5, rowHeight, rowCount, spacing = 10, theme, children, disabled, preview, defaultTiles: _0, onChange: _1, emptyTiles } = _a, props = __rest(_a, ["columnWidth", "columnCount", "rowHeight", "rowCount", "spacing", "theme", "children", "disabled", "preview", "defaultTiles", "onChange", "emptyTiles"]);
        const { tiles, live } = this.state;
        const currentTiles = live || tiles;
        const columns = repeat(columnCount, columnWidth);
        const rows = repeat(rowCount, rowHeight);
        const active = this.activeTile;
        return (React.createElement(InteractiveSurface, { theme: theme, onChange: this.dragTile, disabled: disabled },
            React.createElement(Grid, Object.assign({ theme: theme, rows: rows, columns: columns, spacing: `${spacing}px`, showEmptyCells: emptyTiles, onLayout: this.setLayout }, props),
                React.Children.map(children, (child, index) => {
                    const tile = currentTiles[index];
                    const setters = this.setters;
                    if (setters[index] === undefined) {
                        setters[index] = e => this.setActiveTile(e, index);
                    }
                    return (tile && (React.createElement(GridArea, { key: tile.id, theme: theme, onTap: setters[index], column: tile.column, colSpan: tile.colSpan, rowSpan: tile.rowSpan, hidden: tile.hidden, row: tile.row }, child)));
                }),
                preview && active && getPreview(preview, currentTiles[active.index]))));
    }
}
Dashboard.inner = {
    get InteractiveSurface() { return InteractiveSurface; },
    get Grid() { return Grid; },
    get GridArea() { return GridArea; }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvY29tcG9uZW50cy9EYXNoYm9hcmQvaW5kZXgudHN4Il0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQUFBLE9BQU8sS0FBSyxLQUFLLE1BQU0sT0FBTyxDQUFDO0FBQy9CLE9BQU8sTUFBTSxNQUFNLG9CQUFvQixDQUFDO0FBRXhDLE9BQU8sRUFBRSxrQkFBa0IsRUFBaUMsTUFBTSx1QkFBdUIsQ0FBQztBQUMxRixPQUFPLEVBQUUsSUFBSSxFQUFjLE1BQU0sU0FBUyxDQUFDO0FBQzNDLE9BQU8sRUFBRSxRQUFRLEVBQW9CLE1BQU0sYUFBYSxDQUFDO0FBeUd6RCxTQUFTLEtBQUssQ0FBQyxLQUFhLEVBQUUsS0FBYSxFQUFFLEtBQWE7SUFDdEQsT0FBTyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsS0FBSyxFQUFFLEtBQUssQ0FBQyxFQUFFLEtBQUssQ0FBQyxDQUFDO0FBQ25ELENBQUM7QUFDRCxTQUFTLElBQUksQ0FBQyxHQUFXLEVBQUUsR0FBVyxFQUFFLEtBQWEsRUFBRSxHQUFXO0lBQzlELE1BQU0sS0FBSyxHQUFHLEtBQUssQ0FBQyxDQUFDLEVBQUUsR0FBRyxHQUFHLEtBQUssR0FBRyxHQUFHLEVBQUUsS0FBSyxHQUFHLEdBQUcsQ0FBQyxDQUFDO0lBQ3ZELE9BQU8sR0FBRyxLQUFLLElBQUksQ0FBQztBQUN4QixDQUFDO0FBQ0QsU0FBUyxNQUFNLENBQUMsS0FBeUIsRUFBRSxHQUFZO0lBQ25ELE1BQU0sS0FBSyxHQUFHLEdBQUcsS0FBSyxTQUFTLENBQUMsQ0FBQyxDQUFDLEdBQUcsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQztJQUNyRCxJQUFJLEtBQUssS0FBSyxTQUFTLEVBQUU7UUFDckIsTUFBTSxNQUFNLEdBQWtCLEVBQUUsQ0FBQztRQUNqQyxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMs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Q0FBQyxDQUNoRSxDQUNZLENBQUMsQ0FBQztJQUN6QixDQUFDOztBQUNNLGVBQUssR0FBRztJQUNYLElBQUksa0JBQWtCLEtBQUssT0FBTyxrQkFBK0MsQ0FBQyxDQUFDLENBQUM7SUFDcEYsSUFBSSxJQUFJLEtBQUssT0FBTyxJQUFtQixDQUFDLENBQUMsQ0FBQztJQUMxQyxJQUFJLFFBQVEsS0FBSyxPQUFPLFFBQTJCLENBQUMsQ0FBQyxDQUFDO0NBQ3pELENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBSZWFjdCBmcm9tICdyZWFjdCc7XG5pbXBvcnQgc3R5bGVkIGZyb20gJy4uLy4uL3V0aWxzL3N0eWxlZCc7XG5pbXBvcnQgeyBTdGFuZGFyZFByb3BzIH0gZnJvbSAnLi4vLi4vY29tbW9uJztcbmltcG9ydCB7IEludGVyYWN0aXZlU3VyZmFjZSwgSW50ZXJhY3RpdmVTdXJmYWNlQ2hhbmdlRXZlbnQgfSBmcm9tICcuLi9JbnRlcmFjdGl2ZVN1cmZhY2UnO1xuaW1wb3J0IHsgR3JpZCwgR3JpZExheW91dCB9IGZyb20gJy4uL0dyaWQnO1xuaW1wb3J0IHsgR3JpZEFyZWEsIEdyaWRBcmVhVGFwRXZlbnQgfSBmcm9tICcuLi9HcmlkQXJlYSc7XG5leHBvcnQgaW50ZXJmYWNlIERhc2hib2FyZFRpbGUge1xuICAgIC8qKlxuICAgICAqIElkIG9mIHRoZSB0aWxlLCBtdXN0IGJlIHVuaXF1ZS5cbiAgICAgKi9cbiAgICBpZDogc3RyaW5nO1xuICAgIC8qKlxuICAgICAqIFRoZSBjb2x1bW4gcGxhY2VtZW50IGZvciB0aGUgdGlsZS4gQnkgZGVmYXVsdCBhdXRvLlxuICAgICAqIEBkZWZhdWx0IGF1dG9cbiAgICAgKi9cbiAgICBjb2x1bW4/OiBudW1iZXI7XG4gICAgLyoqXG4gICAgICogVGhlIHJvdyBwbGFjZW1lbnQgZm9yIHRoZSB0aWxlLiBCeSBkZWZhdWx0IGF1dG8uXG4gICAgICogQGRlZmF1bHQgYXV0b1xuICAgICAqL1xuICAgIHJvdz86IG51bWJlcjtcbiAgICAvKipcbiAgICAgKiBUaGUgbnVtYmVyIG9mIGNvbHVtbnMgc3Bhbm5lZCBieSB0aGUgdGlsZS4gQnkgZGVmYXVsdCAxLlxuICAgICAqIEBkZWZhdWx0IDFcbiAgICAgKi9cbiAgICBjb2xTcGFuPzogbnVtYmVyO1xuICAgIC8qKlxuICAgICAqIFRoZSBudW1iZXIgb2Ygcm93cyBzcGFubmVkIGJ5IHRoZSB0aWxlLiBCeSBkZWZhdWx0IDEuXG4gICAgICogQGRlZmF1bHQgMVxuICAgICAqL1xuICAgIHJvd1NwYW4/OiBudW1iZXI7XG4gICAgLyoqXG4gICAgICogRGV0ZXJtaW5lcyB3aGV0aGVyIHRoZSB0aWxlIGlzIGhpZGRlbiBvciBub3QuXG4gICAgICogQGRlZmF1bHQgZmFsc2VcbiAgICAgKi9cbiAgICBoaWRkZW4/OiBib29sZWFuO1xufVxuZXhwb3J0IGludGVyZmFjZSBEYXNoYm9hcmRDaGFuZ2VFdmVudCB7XG4gICAgLyoqXG4gICAgICogVGhlIHRpbGUgdGhhdCBvcmlnaW5hdGVkIHRoZSBjaGFuZ2UuXG4gICAgICovXG4gICAgdGlsZTogRGFzaGJvYXJkVGlsZTtcbiAgICAvKipcbiAgICAgKiBUaGUgcmVjb25zdHJ1Y3RlZCBkYXNoYm9hcmQgbGF5b3V0LlxuICAgICAqL1xuICAgIHRpbGVzOiBBcnJheTxEYXNoYm9hcmRUaWxlPjtcbn1cbmV4cG9ydCBpbnRlcmZhY2UgRGFzaGJvYXJkUHJvcHMgZXh0ZW5kcyBTdGFuZGFyZFByb3BzIHtcbiAgICAvKipcbiAgICAgKiBUaGUgbnVtYmVyIG9mIHJvd3MgaW4gdGhlIGRhc2hib2FyZCBncmlkLiBCeSBkZWZhdWx0IGZsZXhpYmxlLlxuICAgICAqIEBkZWZhdWx0IGF1dG9cbiAgICAgKi9cbiAgICByb3dDb3VudD86IG51bWJlcjtcbiAgICAvKipcbiAgICAgKiBUaGUgaGVpZ2h0IHBlciByb3cgaW4gcGl4ZWwuIEJ5IGRlZmF1bHQgYXV0by5cbiAgICAgKiBAZGVmYXVsdCBhdXRvXG4gICAgICovXG4gICAgcm93SGVpZ2h0PzogbnVtYmVyO1xuICAgIC8qKlxuICAgICAqIFRoZSBudW1iZXIgb2YgY29sdW1ucyBpbiB0aGUgZGFzaGJvYXJkIGdyaWQuIEJ5IGRlZmF1bHQgNS5cbiAgICAgKiBAZGVmYXVsdCA1XG4gICAgICovXG4gICAgY29sdW1uQ291bnQ/OiBudW1iZXI7XG4gICAgLyoqXG4gICAgICogVGhlIGhlaWdodCBwZXIgcm93IGluIHBpeGVsLiBCeSBkZWZhdWx0IGF1dG8uXG4gICAgICogQGRlZmF1bHQgYXV0b1xuICAgICAqL1xuICAgIGNvbHVtbldpZHRoPzogbnVtYmVyO1xuICAgIC8qKlxuICAgICAqIFRoZSBzcGFjaW5nIGJldHdlZW4gdGhlIGdyaWQgY2VsbHMgaW4gcGl4ZWwuIEJ5IGRlZmF1bHQgMTAuXG4gICAgICogQGRlZmF1bHQgMTBcbiAgICAgKi9cbiAgICBzcGFjaW5nPzogbnVtYmVyO1xuICAgIC8qKlxuICAgICAqIFRoZSBkZWZhdWx0IHRpbGUgYXJyYW5nZW1lbnQgdG8gdXNlLiBPbmx5IG1hbmFnZWQgbW9kZSBleGlzdC4gU2V0dGluZ1xuICAgICAqIHRoaXMgcHJvcGVydHkgbGF0ZXIgd2lsbCByZXNldCB0aGUgdGlsZSBsYXlvdXQgdG8gdGhlIGdpdmVuIG9uZS5cbiAgICAgKi9cbiAgICBkZWZhdWx0VGlsZXM6IEFycmF5PERhc2hib2FyZFRpbGU+O1xuICAgIC8qKlxuICAgICAqIEZpcmVkIHdoZW4gdGhlIGRhc2hib2FyZCBsYXlvdXQgaXMgY2hhbmdlZC5cbiAgICAgKi9cbiAgICBvbkNoYW5nZT8oZTogRGFzaGJvYXJkQ2hhbmdlRXZlbnQpOiB2b2lkO1xuICAgIC8qKlxuICAgICAqIERpc2FibGVzIHRoZSBhYmlsaXR5IHRvIGNoYW5nZSB0aGUgbGF5b3V0LiBCeSBkZWZhdWx0IGZhbHNlLlxuICAgICAqIEBkZWZhdWx0IGZhbHNlXG4gICAgICovXG4gICAgZGlzYWJsZWQ/OiBib29sZWFuO1xuICAgIC8qKlxuICAgICAqIEVuYWJsZXMgdGhlIGxpdmUgcHJldmlldyBkdXJpbmcgdGhlIHRpbGUgZHJhZyB3aXRoIGEgc3RhbmRhcmRcbiAgICAgKiBvciBjdXN0b20gZWxlbWVudC5cbiAgICAgKi9cbiAgICBwcmV2aWV3PzogUmVhY3QuUmVhY3RDaGlsZCB8IGJvb2xlYW47XG4gICAgLyoqXG4gICAgICogQnkgcHJvdmlkaW5nIHRoZSBzaG93IHRpbGUgcHJvcGVydHksIHRoZSBkYXNoYm9hcmQgd2lsbCByZW5kZXJcbiAgICAgKiB0aGUgdW51c2VkIHRpbGVzLlxuICAgICAqL1xuICAgIGVtcHR5VGlsZXM/OiBib29sZWFuO1xuICAgIC8qKlxuICAgICAqIFRoZSBjb250ZW50IHRvIGNvbnNpZGVyIGZvciB0aGUgZGFzaGJvYXJkLlxuICAgICAqL1xuICAgIGNoaWxkcmVuPzogUmVhY3QuUmVhY3ROb2RlO1xuICAgIC8qKlxuICAgICAqIEdldHMgdGhlIHJlZmVyZW5jZSB0byB0aGUgdW5kZXJseWluZyBIVE1MIERPTSBlbGVtZW50LlxuICAgICAqL1xuICAgIGlubmVyUmVmPyhpbnN0YW5jZTogSFRNTEVsZW1lbnQgfCBudWxsKTogdm9pZDtcbn1cbmV4cG9ydCBpbnRlcmZhY2UgRGFzaGJvYXJkU3RhdGUge1xuICAgIHRpbGVzOiBBcnJheTxEYXNoYm9hcmRUaWxlPjtcbiAgICBsaXZlPzogQXJyYXk8RGFzaGJvYXJkVGlsZT47XG59XG5mdW5jdGlvbiBjbGFtcChsb3dlcjogbnVtYmVyLCB2YWx1ZTogbnVtYmVyLCB1cHBlcjogbnVtYmVyKSB7XG4gICAgcmV0dXJuIE1hdGgubWluKE1hdGgubWF4KGxvd2VyLCB2YWx1ZSksIHVwcGVyKTtcbn1cbmZ1bmN0aW9uIGNhbGMocmVsOiBudW1iZXIsIG9mZjogbnVtYmVyLCB0b3RhbDogbnVtYmVyLCBkaW06IG51bWJlcikge1xuICAgIGNvbnN0IHZhbHVlID0gY2xhbXAoMCwgcmVsICogdG90YWwgLSBvZmYsIHRvdGFsIC0gZGltKTtcbiAgICByZXR1cm4gYCR7dmFsdWV9cHhgO1xufVxuZnVuY3Rpb24gcmVwZWF0KGNvdW50OiBudW1iZXIgfCB1bmRlZmluZWQsIGRpbT86IG51bWJlcikge1xuICAgIGNvbnN0IHZhbHVlID0gZGltICE9PSB1bmRlZmluZWQgPyBgJHtkaW19cHhgIDogJzFmcic7XG4gICAgaWYgKGNvdW50ICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgY29uc3QgdmFsdWVzOiBBcnJheTxzdHJpbmc+ID0gW107XG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY291bnQ7IGkrKykge1xuICAgICAgICAgICAgdmFsdWVzLnB1c2godmFsdWUpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB2YWx1ZXM7XG4gICAgfVxuICAgIHJldHVybiB2YWx1ZTtcbn1cbmZ1bmN0aW9uIGNvbGxpZGVzKGE6IERhc2hib2FyZFRpbGUsIGI6IERhc2hib2FyZFRpbGUpIHtcbiAgICBpZiAoYS5oaWRkZW4gfHwgYi5oaWRkZW4pIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICBlbHNlIGlmIChhLmNvbHVtbiAhPT0gdW5kZWZpbmVkICYmIGEucm93ICE9PSB1bmRlZmluZWQgJiYgYi5jb2x1bW4gIT09IHVuZGVmaW5lZCAmJiBiLnJvdyAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIGNvbnN0IHsgY29sU3BhbjogYWNwID0gMSwgcm93U3BhbjogYXJwID0gMSB9ID0gYTtcbiAgICAgICAgY29uc3QgeyBjb2xTcGFuOiBiY3AgPSAxLCByb3dTcGFuOiBicnAgPSAxIH0gPSBiO1xuICAgICAgICBjb25zdCBhY3MgPSBhLmNvbHVtbjtcbiAgICAgICAgY29uc3QgYWNlID0gYS5jb2x1bW4gKyBhY3AgLSAxO1xuICAgICAgICBjb25zdCBhcnMgPSBhLnJvdztcbiAgICAgICAgY29uc3QgYXJlID0gYS5yb3cgKyBhcnAgLSAxO1xuICAgICAgICBjb25zdCBiY3MgPSBiLmNvbHVtbjtcbiAgICAgICAgY29uc3QgYmNlID0gYi5jb2x1bW4gKyBiY3AgLSAxO1xuICAgICAgICBjb25zdCBicnMgPSBiLnJvdztcbiAgICAgICAgY29uc3QgYnJlID0gYi5yb3cgKyBicnAgLSAxO1xuICAgICAgICByZXR1cm4gYWNzIDw9IGJjZSAmJiBhY2UgPj0gYmNzICYmIGFycyA8PSBicmUgJiYgYXJlID49IGJycztcbiAgICB9XG4gICAgcmV0dXJuIGZhbHNlO1xufVxuZnVuY3Rpb24gbm90RXF1YWwoYTogQXJyYXk8RGFzaGJvYXJkVGlsZT4sIGI6IEFycmF5PERhc2hib2FyZFRpbGU+KSB7XG4gICAgaWYgKGEgIT09IGIpIHtcbiAgICAgICAgaWYgKGEubGVuZ3RoICE9PSBiLmxlbmd0aCkge1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgZm9yIChsZXQgaSA9IGEubGVuZ3RoOyBpLS07KSB7XG4gICAgICAgICAgICBjb25zdCBhdCA9IGFbaV07XG4gICAgICAgICAgICBjb25zdCBidCA9IGJbaV07XG4gICAgICAgICAgICBpZiAoYXQgIT09IGJ0IHx8XG4gICAgICAgICAgICAgICAgYXQuY29sU3BhbiAhPT0gYnQuY29sU3BhbiB8fFxuICAgICAgICAgICAgICAgIGF0LmNvbHVtbiAhPT0gYnQuY29sdW1uIHx8XG4gICAgICAgICAgICAgICAgYXQuaWQgIT09IGJ0LmlkIHx8XG4gICAgICAgICAgICAgICAgYXQucm93ICE9PSBidC5yb3cgfHxcbiAgICAgICAgICAgICAgICBhdC5yb3dTcGFuICE9PSBidC5yb3dTcGFuKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGZhbHNlO1xufVxuZnVuY3Rpb24gcmVzZXRTdHlsZShub2RlOiBIVE1MRWxlbWVudCkge1xuICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZVxuICAgIGNvbnN0IGRlZmF1bHRWYWx1ZSA9IG51bGw7XG4gICAgY29uc3Qgc3R5bGUgPSBub2RlLnN0eWxlO1xuICAgIHN0eWxlLnBvc2l0aW9uID0gJ3N0YXRpYyc7XG4gICAgc3R5bGUuY3Vyc29yID0gZGVmYXVsdFZhbHVlO1xuICAgIHN0eWxlLndpZHRoID0gZGVmYXVsdFZhbHVlO1xuICAgIHN0eWxlLmhlaWdodCA9IGRlZmF1bHRWYWx1ZTtcbiAgICBzdHlsZS5sZWZ0ID0gZGVmYXVsdFZhbHVlO1xuICAgIHN0eWxlLnRvcCA9IGRlZmF1bHRWYWx1ZTtcbiAgICBzdHlsZS56SW5kZXggPSBkZWZhdWx0VmFsdWU7XG59XG5jb25zdCBQcmV2aWV3ID0gc3R5bGVkLmRpdiBgXG4gIGJhY2tncm91bmQ6ICNlZWU7XG4gIGJvcmRlcjogMXB4IGRhc2hlZCAjY2NjO1xuICB3aWR0aDogMTAwJTtcbiAgaGVpZ2h0OiAxMDAlO1xuYDtcbmZ1bmN0aW9uIGdldFByZXZpZXcocHJldmlldzogUmVhY3QuUmVhY3RDaGlsZCB8IGJvb2xlYW4sIHRpbGU6IERhc2hib2FyZFRpbGUpIHtcbiAgICBjb25zdCBjb250ZW50ID0gcHJldmlldyA9PT0gdHJ1ZSA/IDxQcmV2aWV3IC8+IDogcHJldmlldztcbiAgICByZXR1cm4gKDxHcmlkQXJlYSBjb2xTcGFuPXt0aWxlLmNvbFNwYW59IHJvd1NwYW49e3RpbGUucm93U3Bhbn0gY29sdW1uPXt0aWxlLmNvbHVtbn0gcm93PXt0aWxlLnJvd30+XG4gICAgICB7Y29udGVudH1cbiAgICA8L0dyaWRBcmVhPik7XG59XG5jb25zdCBkZWZhdWx0QWN0aXZlVGlsZSA9IHtcbiAgICB4OiAwLFxuICAgIHk6IDAsXG4gICAgd2lkdGg6IDAsXG4gICAgaGVpZ2h0OiAwLFxufTtcbmZ1bmN0aW9uIGNoYW5nZVRpbGUob2xkVGlsZXM6IEFycmF5PERhc2hib2FyZFRpbGU+LCBuZXdUaWxlOiBEYXNoYm9hcmRUaWxlKSB7XG4gICAgbGV0IGNoYW5nZWQgPSBmYWxzZTtcbiAgICBjb25zdCBuZXdUaWxlcyA9IG9sZFRpbGVzLm1hcCh0aWxlID0+IHtcbiAgICAgICAgaWYgKHRpbGUuaWQgPT09IG5ld1RpbGUuaWQpIHtcbiAgICAgICAgICAgIGNoYW5nZWQgPVxuICAgICAgICAgICAgICAgIGNoYW5nZWQgfHxcbiAgICAgICAgICAgICAgICAgICAgdGlsZS5jb2xTcGFuICE9PSBuZXdUaWxlLmNvbFNwYW4gfHxcbiAgICAgICAgICAgICAgICAgICAgdGlsZS5jb2x1bW4gIT09IG5ld1RpbGUuY29sdW1uIHx8XG4gICAgICAgICAgICAgICAgICAgIHRpbGUuaGlkZGVuICE9PSBuZXdUaWxlLmhpZGRlbiB8fFxuICAgICAgICAgICAgICAgICAgICB0aWxlLnJvdyAhPT0gbmV3VGlsZS5yb3cgfHxcbiAgICAgICAgICAgICAgICAgICAgdGlsZS5yb3dTcGFuICE9PSBuZXdUaWxlLnJvd1NwYW47XG4gICAgICAgICAgICByZXR1cm4gbmV3VGlsZTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIGlmIChjb2xsaWRlcyh0aWxlLCBuZXdUaWxlKSkge1xuICAgICAgICAgICAgY2hhbmdlZCA9IHRydWU7XG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgIGlkOiB0aWxlLmlkLFxuICAgICAgICAgICAgICAgIGNvbFNwYW46IHRpbGUuY29sU3BhbixcbiAgICAgICAgICAgICAgICByb3dTcGFuOiB0aWxlLnJvd1NwYW4sXG4gICAgICAgICAgICB9O1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aWxlO1xuICAgIH0pO1xuICAgIHJldHVybiBjaGFuZ2VkID8gbmV3VGlsZXMgOiBvbGRUaWxlcztcbn1cbi8qKlxuICogRGFzaGJvYXJkIGNvbXBvbmVudC5cbiAqL1xuZXhwb3J0IGNsYXNzIERhc2hib2FyZCBleHRlbmRzIFJlYWN0LkNvbXBvbmVudDxEYXNoYm9hcmRQcm9wcywgRGFzaGJvYXJkU3RhdGU+IHtcbiAgICBwcml2YXRlIHNldHRlcnM6IEFycmF5PChlOiBHcmlkQXJlYVRhcEV2ZW50KSA9PiB2b2lkPiA9IFtdO1xuICAgIHByaXZhdGUgbGF5b3V0OiBHcmlkTGF5b3V0O1xuICAgIHByaXZhdGUgYWN0aXZlVGlsZToge1xuICAgICAgICBub2RlOiBIVE1MRWxlbWVudDtcbiAgICAgICAgeDogbnVtYmVyO1xuICAgICAgICB5OiBudW1iZXI7XG4gICAgICAgIHdpZHRoOiBudW1iZXI7XG4gICAgICAgIGhlaWdodDogbnVtYmVyO1xuICAgICAgICBpbmRleDogbnVtYmVyO1xuICAgICAgICBjdXJyZW50OiBEYXNoYm9hcmRUaWxlO1xuICAgIH0gfCB1bmRlZmluZWQ7XG4gICAgY29uc3RydWN0b3IocHJvcHM6IERhc2hib2FyZFByb3BzKSB7XG4gICAgICAgIHN1cGVyKHByb3BzKTtcbiAgICAgICAgY29uc3QgeyBkZWZhdWx0VGlsZXMgPSBbXSB9ID0gcHJvcHM7XG4gICAgICAgIHRoaXMuc3RhdGUgPSB7XG4gICAgICAgICAgICB0aWxlczogWy4uLmRlZmF1bHRUaWxlc10sXG4gICAgICAgICAgICBsaXZlOiB1bmRlZmluZWQsXG4gICAgICAgIH07XG4gICAgfVxuICAgIFVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzKG5leHRQcm9wczogRGFzaGJvYXJkUHJvcHMpIHtcbiAgICAgICAgY29uc3QgeyBkZWZhdWx0VGlsZXM6IGN1cnJUaWxlcyA9IFtdIH0gPSB0aGlzLnByb3BzO1xuICAgICAgICBjb25zdCB7IGRlZmF1bHRUaWxlczogbmV4dFRpbGVzID0gW10gfSA9IG5leHRQcm9wcztcbiAgICAgICAgaWYgKG5vdEVxdWFsKGN1cnJUaWxlcywgbmV4dFRpbGVzKSkge1xuICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICAgICAgdGlsZXM6IFsuLi5uZXh0VGlsZXNdLFxuICAgICAgICAgICAgICAgIGxpdmU6IHVuZGVmaW5lZCxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfVxuICAgIHByaXZhdGUgZmluaXNoRHJhZyhuZXdUaWxlOiBEYXNoYm9hcmRUaWxlKSB7XG4gICAgICAgIGNvbnN0IHsgb25DaGFuZ2UgfSA9IHRoaXMucHJvcHM7XG4gICAgICAgIGNvbnN0IHsgdGlsZXM6IG9sZFRpbGVzIH0gPSB0aGlzLnN0YXRlO1xuICAgICAgICBjb25zdCBuZXdUaWxlcyA9IGNoYW5nZVRpbGUob2xkVGlsZXMsIG5ld1RpbGUpO1xuICAgICAgICB0aGlzLmFjdGl2ZVRpbGUgPSB1bmRlZmluZWQ7XG4gICAgICAgIGlmIChuZXdUaWxlcyAhPT0gb2xkVGlsZXMpIHtcbiAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgICAgIHRpbGVzOiBuZXdUaWxlcyxcbiAgICAgICAgICAgICAgICBsaXZlOiB1bmRlZmluZWQsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGlmICh0eXBlb2Ygb25DaGFuZ2UgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgICAgICAgICBvbkNoYW5nZSh7XG4gICAgICAgICAgICAgICAgICAgIHRpbGU6IG5ld1RpbGUsXG4gICAgICAgICAgICAgICAgICAgIHRpbGVzOiBuZXdUaWxlcyxcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgICAgIGxpdmU6IHVuZGVmaW5lZCxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfVxuICAgIHByaXZhdGUgZHJhZ1RpbGUgPSAoZTogSW50ZXJhY3RpdmVTdXJmYWNlQ2hhbmdlRXZlbnQpID0+IHtcbiAgICAgICAgY29uc3QgeyBhY3RpdmVUaWxlIH0gPSB0aGlzO1xuICAgICAgICBpZiAoYWN0aXZlVGlsZSkge1xuICAgICAgICAgICAgY29uc3Qgbm9kZSA9IGFjdGl2ZVRpbGUubm9kZTtcbiAgICAgICAgICAgIGNvbnN0IGN1cnJlbnQgPSBhY3RpdmVUaWxlLmN1cnJlbnQ7XG4gICAgICAgICAgICBpZiAoIWUubW92ZWQpIHtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2UgaWYgKGUuYWN0aXZlKSB7XG4gICAgICAgICAgICAgICAgY29uc3Qgc3R5bGUgPSBub2RlLnN0eWxlO1xuICAgICAgICAgICAgICAgIHN0eWxlLmxlZnQgPSBjYWxjKGUueCwgYWN0aXZlVGlsZS54LCBlLnJlY3Qud2lkdGgsIGFjdGl2ZVRpbGUud2lkdGgpO1xuICAgICAgICAgICAgICAgIHN0eWxlLnRvcCA9IGNhbGMoZS55LCBhY3RpdmVUaWxlLnksIGUucmVjdC5oZWlnaHQsIGFjdGl2ZVRpbGUuaGVpZ2h0KTtcbiAgICAgICAgICAgICAgICB0aGlzLnByZXZpZXdEcmFnKGUueCwgZS55LCBjdXJyZW50KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIGNvbnN0IHBvcyA9IHRoaXMuZ2V0VGFyZ2V0UG9zaXRpb24oZS54LCBlLnksIGN1cnJlbnQpO1xuICAgICAgICAgICAgICAgIHJlc2V0U3R5bGUobm9kZSk7XG4gICAgICAgICAgICAgICAgdGhpcy5maW5pc2hEcmFnKHtcbiAgICAgICAgICAgICAgICAgICAgLi4uY3VycmVudCxcbiAgICAgICAgICAgICAgICAgICAgY29sdW1uOiBwb3MuY29sdW1uLFxuICAgICAgICAgICAgICAgICAgICByb3c6IHBvcy5yb3csXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICBlLnJlbGVhc2UoKTtcbiAgICAgICAgfVxuICAgIH07XG4gICAgcHJpdmF0ZSBwcmV2aWV3RHJhZyhoOiBudW1iZXIsIHY6IG51bWJlciwgdGlsZTogRGFzaGJvYXJkVGlsZSkge1xuICAgICAgICBjb25zdCBhY3RpdmUgPSB0aGlzLmFjdGl2ZVRpbGU7XG4gICAgICAgIGNvbnN0IHsgcHJldmlldyB9ID0gdGhpcy5wcm9wcztcbiAgICAgICAgY29uc3QgeyBsaXZlLCB0aWxlcyB9ID0gdGhpcy5zdGF0ZTtcbiAgICAgICAgaWYgKHByZXZpZXcgJiYgYWN0aXZlICYmIGxpdmUpIHtcbiAgICAgICAgICAgIGNvbnN0IGN1cnJlbnQgPSBhY3RpdmUuY3VycmVudDtcbiAgICAgICAgICAgIGNvbnN0IHBvcyA9IHRoaXMuZ2V0VGFyZ2V0UG9zaXRpb24oaCwgdiwgdGlsZSk7XG4gICAgICAgICAgICBjb25zdCBsYXN0ID0gbGl2ZVthY3RpdmUuaW5kZXhdO1xuICAgICAgICAgICAgaWYgKHBvcy5jb2x1bW4gIT09IGxhc3QuY29sdW1uIHx8IHBvcy5yb3cgIT09IGxhc3Qucm93KSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICAgICAgICAgIGxpdmU6IGNoYW5nZVRpbGUodGlsZXMsIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC4uLmN1cnJlbnQsXG4gICAgICAgICAgICAgICAgICAgICAgICBjb2x1bW46IHBvcy5jb2x1bW4sXG4gICAgICAgICAgICAgICAgICAgICAgICByb3c6IHBvcy5yb3csXG4gICAgICAgICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIHByaXZhdGUgZ2V0VGFyZ2V0UG9zaXRpb24oaDogbnVtYmVyLCB2OiBudW1iZXIsIHRpbGU6IERhc2hib2FyZFRpbGUpIHtcbiAgICAgICAgY29uc3QgeyBjb2x1bW5zLCByb3dzIH0gPSB0aGlzLmxheW91dDtcbiAgICAgICAgY29uc3QgeyBjb2xTcGFuID0gMSwgcm93U3BhbiA9IDEgfSA9IHRpbGU7XG4gICAgICAgIGNvbnN0IHsgeCwgeSwgd2lkdGgsIGhlaWdodCB9ID0gdGhpcy5hY3RpdmVUaWxlIHx8IGRlZmF1bHRBY3RpdmVUaWxlO1xuICAgICAgICBjb25zdCB0b3RhbFJvd3MgPSByb3dzLmxlbmd0aDtcbiAgICAgICAgY29uc3QgdG90YWxDb2x1bW5zID0gY29sdW1ucy5sZW5ndGg7XG4gICAgICAgIGNvbnN0IGNvbHVtbk9mZnNldCA9IH5+KCh4ICogY29sU3BhbikgLyB3aWR0aCk7XG4gICAgICAgIGNvbnN0IHJvd09mZnNldCA9IH5+KCh5ICogcm93U3BhbikgLyBoZWlnaHQpO1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgY29sdW1uOiBjbGFtcCgwLCB+fihoICogdG90YWxDb2x1bW5zKSAtIGNvbHVtbk9mZnNldCwgdG90YWxDb2x1bW5zIC0gY29sU3BhbiksXG4gICAgICAgICAgICByb3c6IGNsYW1wKDAsIH5+KHYgKiB0b3RhbFJvd3MpIC0gcm93T2Zmc2V0LCB0b3RhbFJvd3MgLSByb3dTcGFuKSxcbiAgICAgICAgfTtcbiAgICB9XG4gICAgcHJpdmF0ZSBzZXRBY3RpdmVUaWxlKGU6IEdyaWRBcmVhVGFwRXZlbnQsIGluZGV4OiBudW1iZXIpIHtcbiAgICAgICAgY29uc3QgeyBkaXNhYmxlZCB9ID0gdGhpcy5wcm9wcztcbiAgICAgICAgY29uc3QgeyB0aWxlcyB9ID0gdGhpcy5zdGF0ZTtcbiAgICAgICAgY29uc3QgY3VycmVudCA9IHRpbGVzW2luZGV4XTtcbiAgICAgICAgaWYgKCFkaXNhYmxlZCkge1xuICAgICAgICAgICAgdGhpcy5hY3RpdmVUaWxlID0ge1xuICAgICAgICAgICAgICAgIC4uLmUsXG4gICAgICAgICAgICAgICAgaW5kZXgsXG4gICAgICAgICAgICAgICAgY3VycmVudCxcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBjb25zdCBzdHlsZSA9IGUubm9kZS5zdHlsZTtcbiAgICAgICAgICAgIHN0eWxlLmN1cnNvciA9ICdtb3ZlJztcbiAgICAgICAgICAgIHN0eWxlLnBvc2l0aW9uID0gJ2Fic29sdXRlJztcbiAgICAgICAgICAgIHN0eWxlLndpZHRoID0gYCR7ZS53aWR0aH1weGA7XG4gICAgICAgICAgICBzdHlsZS5oZWlnaHQgPSBgJHtlLmhlaWdodH1weGA7XG4gICAgICAgICAgICBzdHlsZS56SW5kZXggPSAnMTAwMDAwMDAwJztcbiAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgICAgIGxpdmU6IHRpbGVzLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcHJpdmF0ZSBzZXRMYXlvdXQgPSAoeyBsYXlvdXQgfToge1xuICAgICAgICBsYXlvdXQ6IEdyaWRMYXlvdXQ7XG4gICAgfSkgPT4ge1xuICAgICAgICB0aGlzLmxheW91dCA9IGxheW91dDtcbiAgICB9O1xuICAgIHJlbmRlcigpIHtcbiAgICAgICAgY29uc3QgeyBjb2x1bW5XaWR0aCwgY29sdW1uQ291bnQgPSA1LCByb3dIZWlnaHQsIHJvd0NvdW50LCBzcGFjaW5nID0gMTAsIHRoZW1lLCBjaGlsZHJlbiwgZGlzYWJsZWQsIHByZXZpZXcsIGRlZmF1bHRUaWxlczogXzAsIG9uQ2hhbmdlOiBfMSwgZW1wdHlUaWxlcywgLi4ucHJvcHMgfSA9IHRoaXMucHJvcHM7XG4gICAgICAgIGNvbnN0IHsgdGlsZXMsIGxpdmUgfSA9IHRoaXMuc3RhdGU7XG4gICAgICAgIGNvbnN0IGN1cnJlbnRUaWxlcyA9IGxpdmUgfHwgdGlsZXM7XG4gICAgICAgIGNvbnN0IGNvbHVtbnMgPSByZXBlYXQoY29sdW1uQ291bnQsIGNvbHVtbldpZHRoKTtcbiAgICAgICAgY29uc3Qgcm93cyA9IHJlcGVhdChyb3dDb3VudCwgcm93SGVpZ2h0KTtcbiAgICAgICAgY29uc3QgYWN0aXZlID0gdGhpcy5hY3RpdmVUaWxlO1xuICAgICAgICByZXR1cm4gKDxJbnRlcmFjdGl2ZVN1cmZhY2UgdGhlbWU9e3RoZW1lfSBvbkNoYW5nZT17dGhpcy5kcmFnVGlsZX0gZGlzYWJsZWQ9e2Rpc2FibGVkfT5cbiAgICAgICAgPEdyaWQgdGhlbWU9e3RoZW1lfSByb3dzPXtyb3dzfSBjb2x1bW5zPXtjb2x1bW5zfSBzcGFjaW5nPXtgJHtzcGFjaW5nfXB4YH0gc2hvd0VtcHR5Q2VsbHM9e2VtcHR5VGlsZXN9IG9uTGF5b3V0PXt0aGlzLnNldExheW91dH0gey4uLnByb3BzfT5cbiAgICAgICAgICB7UmVhY3QuQ2hpbGRyZW4ubWFwKGNoaWxkcmVuLCAoY2hpbGQsIGluZGV4KSA9PiB7XG4gICAgICAgICAgICBjb25zdCB0aWxlID0gY3VycmVudFRpbGVzW2luZGV4XTtcbiAgICAgICAgICAgIGNvbnN0IHNldHRlcnMgPSB0aGlzLnNldHRlcnM7XG4gICAgICAgICAgICBpZiAoc2V0dGVyc1tpbmRleF0gPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICAgIHNldHRlcnNbaW5kZXhdID0gZSA9PiB0aGlzLnNldEFjdGl2ZVRpbGUoZSwgaW5kZXgpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuICh0aWxlICYmICg8R3JpZEFyZWEga2V5PXt0aWxlLmlkfSB0aGVtZT17dGhlbWV9IG9uVGFwPXtzZXR0ZXJzW2luZGV4XX0gY29sdW1uPXt0aWxlLmNvbHVtbn0gY29sU3Bhbj17dGlsZS5jb2xTcGFufSByb3dTcGFuPXt0aWxlLnJvd1NwYW59IGhpZGRlbj17dGlsZS5oaWRkZW59IHJvdz17dGlsZS5yb3d9PlxuICAgICAgICAgICAgICAgICAge2NoaWxkfVxuICAgICAgICAgICAgICAgIDwvR3JpZEFyZWE+KSk7XG4gICAgICAgIH0pfVxuICAgICAgICAgIHtwcmV2aWV3ICYmIGFjdGl2ZSAmJiBnZXRQcmV2aWV3KHByZXZpZXcsIGN1cnJlbnRUaWxlc1thY3RpdmUuaW5kZXhdKX1cbiAgICAgICAgPC9HcmlkPlxuICAgICAgPC9JbnRlcmFjdGl2ZVN1cmZhY2U+KTtcbiAgICB9XG4gICAgc3RhdGljIGlubmVyID0ge1xuICAgICAgICBnZXQgSW50ZXJhY3RpdmVTdXJmYWNlKCkgeyByZXR1cm4gSW50ZXJhY3RpdmVTdXJmYWNlIGFzIHR5cGVvZiBJbnRlcmFjdGl2ZVN1cmZhY2U7IH0sXG4gICAgICAgIGdldCBHcmlkKCkgeyByZXR1cm4gR3JpZCBhcyB0eXBlb2YgR3JpZDsgfSxcbiAgICAgICAgZ2V0IEdyaWRBcmVhKCkgeyByZXR1cm4gR3JpZEFyZWEgYXMgdHlwZW9mIEdyaWRBcmVhOyB9XG4gICAgfTtcbn1cbiJdfQ==