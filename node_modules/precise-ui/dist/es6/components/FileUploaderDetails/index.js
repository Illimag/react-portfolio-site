var __rest = (this && this.__rest) || function (s, e) {
    var t = {};
    for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)
        t[p] = s[p];
    if (s != null && typeof Object.getOwnPropertySymbols === "function")
        for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) if (e.indexOf(p[i]) < 0)
            t[p[i]] = s[p[i]];
    return t;
};
import * as React from 'react';
import styled from '../../utils/styled';
import { eventManagers } from '../../utils/eventManager';
import { FileUploadActions, } from './FileUploaderDetails.types.part';
import { UploaderProgressBar } from './UploaderProgressBar.part';
import { UploaderProgressDetails } from './UploaderProgressDetails.part';
import { mergeData } from './helpers';
import { distance } from '../../distance';
export { FileUploadActions };
const initialState = {
    files: [],
    showDetails: false,
    showUploader: false,
};
const StyledUploaderHost = styled.div `
  z-index: 10001;
  width: 100%;
  position: fixed;
  left: 0;
  bottom: ${distance.large};
  height: 0px;
  overflow: visible;
  display: flex;
  align-items: flex-end;
`;
const StyledDetailsHost = styled.div `
  // We override the 'z-index' of the styled component 'FixedContainer' of 'Blocker' (which is called by 'Modal').
  // This fixes the problem of showing 'UploadProgressDetails' behind modal in IE.
  & > div:first-child {
    z-index: 10001;
  }
`;
/**
 * The host element for global async file upload process. Use as a singleton only.
 */
export class FileUploaderDetails extends React.Component {
    constructor(props) {
        super(props);
        this.onStart = (e) => {
            this.props.onUpload(e);
            this.setState({
                showUploader: true,
            });
        };
        this.onChange = ({ files }) => {
            const { files: currentFiles } = this.state;
            this.setState({
                files: mergeData(files, currentFiles),
            });
        };
        this.onCancel = ({ files }) => {
            const { onCancel } = this.props;
            if (typeof onCancel === 'function') {
                onCancel({
                    files: files.filter(item => item.progress < 100 && !item.canceled && !item.error),
                });
            }
        };
        this.onDelete = ({ files }) => {
            const { onDelete } = this.props;
            if (typeof onDelete === 'function') {
                onDelete({
                    files: files.filter(item => item.progress >= 100 && !item.canceled && !item.error),
                });
            }
        };
        this.onClear = (uploaderId) => {
            const { files: currentFiles } = this.state;
            const newFiles = currentFiles.filter(item => item.uploaderId !== uploaderId);
            const oldFiles = currentFiles.filter(item => item.uploaderId === uploaderId);
            this.setState({
                files: newFiles,
            }, () => {
                this.onCancel({
                    files: oldFiles,
                });
            });
        };
        this.closeUploader = () => {
            const { onClose } = this.props;
            if (typeof onClose === 'function') {
                onClose();
            }
            this.setState(Object.assign({}, initialState));
        };
        this.hideDetails = () => {
            this.setState({
                showDetails: false,
            });
        };
        this.showDetails = () => {
            this.setState({
                showDetails: true,
            });
        };
        const { events } = props;
        this.eventManager = events || eventManagers[0];
        this.state = Object.assign({}, initialState);
    }
    componentDidMount() {
        const em = this.eventManager;
        em.on(FileUploadActions.startUpload, this.onStart);
        em.on(FileUploadActions.cancelUpload, this.onCancel);
        em.on(FileUploadActions.uploadProgress, this.onChange);
        em.on(FileUploadActions.uploadFailure, this.onChange);
        em.on(FileUploadActions.showUploads, this.showDetails);
        em.on(FileUploadActions.clearUploads, this.onClear);
        em.on(FileUploadActions.deleteUploads, this.onDelete);
        eventManagers.push(em);
    }
    componentWillUnmount() {
        const em = this.eventManager;
        em.off(FileUploadActions.startUpload, this.onStart);
        em.off(FileUploadActions.cancelUpload, this.onCancel);
        em.off(FileUploadActions.uploadProgress, this.onChange);
        em.off(FileUploadActions.uploadFailure, this.onChange);
        em.off(FileUploadActions.showUploads, this.showDetails);
        em.off(FileUploadActions.clearUploads, this.onClear);
        em.off(FileUploadActions.deleteUploads, this.onDelete);
        eventManagers.splice(eventManagers.lastIndexOf(em), 1);
    }
    render() {
        const _a = this.props, { events, onCancel, onClose, onDelete, onUpload } = _a, props = __rest(_a, ["events", "onCancel", "onClose", "onDelete", "onUpload"]);
        const { showDetails, showUploader, files } = this.state;
        const inprogressFiles = files.filter(item => !(item.canceled || item.error)).map(item => item.progress);
        const errorFiles = files.filter(item => item.canceled || item.error);
        const totalProgress = inprogressFiles.length > 0 ? inprogressFiles.reduce((acc, curr) => acc + curr, 0) / inprogressFiles.length : 100;
        const scanning = files.filter(item => item.scanning && !item.canceled).length > 0;
        const show = showUploader && files.length > 0;
        return (show && (React.createElement(React.Fragment, null,
            React.createElement(StyledDetailsHost, null,
                React.createElement(UploaderProgressDetails, Object.assign({}, props, { open: showDetails, files: files, onCancel: this.onCancel, onDelete: this.onDelete, onHide: this.hideDetails, progressValue: totalProgress }))),
            !showDetails && (React.createElement(StyledUploaderHost, null,
                React.createElement(UploaderProgressBar, Object.assign({}, props, { scanning: scanning, progressValue: totalProgress, inProgress: inprogressFiles.length, errors: errorFiles.length, total: files.length, onShow: this.showDetails, onClose: this.closeUploader })))))));
    }
}
FileUploaderDetails.inner = {
    get StyledDetailsHost() { return StyledDetailsHost; },
    get UploaderProgressDetails() { return UploaderProgressDetails; },
    get StyledUploaderHost() { return StyledUploaderHost; },
    get UploaderProgressBar() { return UploaderProgressBar; }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvY29tcG9uZW50cy9GaWxlVXBsb2FkZXJEZXRhaWxzL2luZGV4LnRzeCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFBQSxPQUFPLEtBQUssS0FBSyxNQUFNLE9BQU8sQ0FBQztBQUMvQixPQUFPLE1BQU0sTUFBTSxvQkFBb0IsQ0FBQztBQUV4QyxPQUFPLEVBQWdCLGFBQWEsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBQ3ZFLE9BQU8sRUFBb0MsaUJBQWlCLEdBQTZCLE1BQU0sa0NBQWtDLENBQUM7QUFDbEksT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFDakUsT0FBTyxFQUFFLHVCQUF1QixFQUFFLE1BQU0sZ0NBQWdDLENBQUM7QUFDekUsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUN0QyxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDMUMsT0FBTyxFQUFFLGlCQUFpQixFQUE4RCxDQUFDO0FBNEJ6RixNQUFNLFlBQVksR0FBNkI7SUFDM0MsS0FBSyxFQUFFLEVBQUU7SUFDVCxXQUFXLEVBQUUsS0FBSztJQUNsQixZQUFZLEVBQUUsS0FBSztDQUN0QixDQUFDO0FBQ0YsTUFBTSxrQkFBa0IsR0FBRyxNQUFNLENBQUMsR0FBRyxDQUFDOzs7OztZQUsxQixRQUFRLENBQUMsS0FBSzs7Ozs7Q0FLekIsQ0FBQztBQUNGLE1BQU0saUJBQWlCLEdBQUcsTUFBTSxDQUFDLEdBQUcsQ0FBQzs7Ozs7O0NBTXBDLENBQUM7QUFDRjs7R0FFRztBQUNILE1BQU0sT0FBTyxtQkFBb0IsU0FBUSxLQUFLLENBQUMsU0FBNkQ7SUFFeEcsWUFBWSxLQUErQjtRQUN2QyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUM7UUE2QlQsWUFBTyxHQUFHLENBQUMsQ0FBcUMsRUFBRSxFQUFFO1lBQ3hELElB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QVUsQ0FBQyxNQUFNLEVBQUUsS0FBSyxFQUFFLEtBQUssQ0FBQyxNQUFNLEVBQUUsTUFBTSxFQUFFLElBQUksQ0FBQyxXQUFXLEVBQUUsT0FBTyxFQUFFLElBQUksQ0FBQyxhQUFhLElBQUcsQ0FDM00sQ0FBQyxDQUN2QixDQUFDLENBQUMsQ0FBQztJQUNWLENBQUM7O0FBQ00seUJBQUssR0FBRztJQUNYLElBQUksaUJBQWlCLEtBQUssT0FBTyxpQkFBNkMsQ0FBQyxDQUFDLENBQUM7SUFDakYsSUFBSSx1QkFBdUIsS0FBSyxPQUFPLHVCQUF5RCxDQUFDLENBQUMsQ0FBQztJQUNuRyxJQUFJLGtCQUFrQixLQUFLLE9BQU8sa0JBQStDLENBQUMsQ0FBQyxDQUFDO0lBQ3BGLElBQUksbUJBQW1CLEtBQUssT0FBTyxtQkFBaUQsQ0FBQyxDQUFDLENBQUM7Q0FDMUYsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIFJlYWN0IGZyb20gJ3JlYWN0JztcbmltcG9ydCBzdHlsZWQgZnJvbSAnLi4vLi4vdXRpbHMvc3R5bGVkJztcbmltcG9ydCB7IFVwbG9hZFByb2dyZXNzRGV0YWlsc0xhYmVscywgVXBsb2FkZXJQcm9ncmVzc0JhckxhYmVscyB9IGZyb20gJy4uLy4uL3V0aWxzL2xhYmVscyc7XG5pbXBvcnQgeyBFdmVudE1hbmFnZXIsIGV2ZW50TWFuYWdlcnMgfSBmcm9tICcuLi8uLi91dGlscy9ldmVudE1hbmFnZXInO1xuaW1wb3J0IHsgRmlsZUJhc2UsIEZpbGVJdGVtLCBGaWxlUHJvZ3Jlc3MsIEZpbGVVcGxvYWRBY3Rpb25zLCBGaWxlVXBsb2FkZXJEZXRhaWxzRXZlbnQsIH0gZnJvbSAnLi9GaWxlVXBsb2FkZXJEZXRhaWxzLnR5cGVzLnBhcnQnO1xuaW1wb3J0IHsgVXBsb2FkZXJQcm9ncmVzc0JhciB9IGZyb20gJy4vVXBsb2FkZXJQcm9ncmVzc0Jhci5wYXJ0JztcbmltcG9ydCB7IFVwbG9hZGVyUHJvZ3Jlc3NEZXRhaWxzIH0gZnJvbSAnLi9VcGxvYWRlclByb2dyZXNzRGV0YWlscy5wYXJ0JztcbmltcG9ydCB7IG1lcmdlRGF0YSB9IGZyb20gJy4vaGVscGVycyc7XG5pbXBvcnQgeyBkaXN0YW5jZSB9IGZyb20gJy4uLy4uL2Rpc3RhbmNlJztcbmV4cG9ydCB7IEZpbGVVcGxvYWRBY3Rpb25zLCBGaWxlSXRlbSwgRmlsZVByb2dyZXNzLCBGaWxlQmFzZSwgRmlsZVVwbG9hZGVyRGV0YWlsc0V2ZW50IH07XG5leHBvcnQgaW50ZXJmYWNlIEZpbGVVcGxvYWRlckRldGFpbHNQcm9wcyBleHRlbmRzIFVwbG9hZFByb2dyZXNzRGV0YWlsc0xhYmVscywgVXBsb2FkZXJQcm9ncmVzc0JhckxhYmVscyB7XG4gICAgLyoqXG4gICAgICogU2V0cyB0aGUgZXZlbnQgbWFuYWdlciB0byB1c2UuIEJ5IGRlZmF1bHQgYSBzdGFuZGFyZCBldmVudCBtYW5hZ2VyIGlzIHVzZWQuXG4gICAgICovXG4gICAgZXZlbnRzPzogRXZlbnRNYW5hZ2VyO1xuICAgIC8qKlxuICAgICAqIEV2ZW50IGVtaXR0ZWQgd2hlbiBmaWxlcyB0byB1cGxvYWQgYXJlIHNlbGVjdGVkLlxuICAgICAqL1xuICAgIG9uVXBsb2FkKGU6IEZpbGVVcGxvYWRlckRldGFpbHNFdmVudDxGaWxlSXRlbT4pOiB2b2lkO1xuICAgIC8qKlxuICAgICAqIEV2ZW50IGVtaXR0ZWQgd2hlbiBmaWxlIHVwbG9hZCBoYXMgYmVlbiBjYW5jZWxlZC5cbiAgICAgKi9cbiAgICBvbkNhbmNlbD8oZTogRmlsZVVwbG9hZGVyRGV0YWlsc0V2ZW50PEZpbGVQcm9ncmVzcz4pOiB2b2lkO1xuICAgIC8qKlxuICAgICAqIEV2ZW50IGVtaXR0ZWQgd2hlbiBmaWxlIHVwbG9hZCBzaG91bGQgYmUgZGVsZXRlZC5cbiAgICAgKi9cbiAgICBvbkRlbGV0ZT8oZTogRmlsZVVwbG9hZGVyRGV0YWlsc0V2ZW50PEZpbGVQcm9ncmVzcz4pOiB2b2lkO1xuICAgIC8qKlxuICAgICAqIEV2ZW50IGVtaXR0ZWQgd2hlbiB0b3RhbCBwcm9ncmVzcyBvdmVybGF5IGlzIGNsb3NlZC5cbiAgICAgKi9cbiAgICBvbkNsb3NlPygpOiB2b2lkO1xufVxuZXhwb3J0IGludGVyZmFjZSBGaWxlVXBsb2FkZXJEZXRhaWxzU3RhdGUge1xuICAgIGZpbGVzOiBBcnJheTxGaWxlUHJvZ3Jlc3M+O1xuICAgIHNob3dEZXRhaWxzOiBib29sZWFuO1xuICAgIHNob3dVcGxvYWRlcjogYm9vbGVhbjtcbn1cbmNvbnN0IGluaXRpYWxTdGF0ZTogRmlsZVVwbG9hZGVyRGV0YWlsc1N0YXRlID0ge1xuICAgIGZpbGVzOiBbXSxcbiAgICBzaG93RGV0YWlsczogZmFsc2UsXG4gICAgc2hvd1VwbG9hZGVyOiBmYWxzZSxcbn07XG5jb25zdCBTdHlsZWRVcGxvYWRlckhvc3QgPSBzdHlsZWQuZGl2IGBcbiAgei1pbmRleDogMTAwMDE7XG4gIHdpZHRoOiAxMDAlO1xuICBwb3NpdGlvbjogZml4ZWQ7XG4gIGxlZnQ6IDA7XG4gIGJvdHRvbTogJHtkaXN0YW5jZS5sYXJnZX07XG4gIGhlaWdodDogMHB4O1xuICBvdmVyZmxvdzogdmlzaWJsZTtcbiAgZGlzcGxheTogZmxleDtcbiAgYWxpZ24taXRlbXM6IGZsZXgtZW5kO1xuYDtcbmNvbnN0IFN0eWxlZERldGFpbHNIb3N0ID0gc3R5bGVkLmRpdiBgXG4gIC8vIFdlIG92ZXJyaWRlIHRoZSAnei1pbmRleCcgb2YgdGhlIHN0eWxlZCBjb21wb25lbnQgJ0ZpeGVkQ29udGFpbmVyJyBvZiAnQmxvY2tlcicgKHdoaWNoIGlzIGNhbGxlZCBieSAnTW9kYWwnKS5cbiAgLy8gVGhpcyBmaXhlcyB0aGUgcHJvYmxlbSBvZiBzaG93aW5nICdVcGxvYWRQcm9ncmVzc0RldGFpbHMnIGJlaGluZCBtb2RhbCBpbiBJRS5cbiAgJiA+IGRpdjpmaXJzdC1jaGlsZCB7XG4gICAgei1pbmRleDogMTAwMDE7XG4gIH1cbmA7XG4vKipcbiAqIFRoZSBob3N0IGVsZW1lbnQgZm9yIGdsb2JhbCBhc3luYyBmaWxlIHVwbG9hZCBwcm9jZXNzLiBVc2UgYXMgYSBzaW5nbGV0b24gb25seS5cbiAqL1xuZXhwb3J0IGNsYXNzIEZpbGVVcGxvYWRlckRldGFpbHMgZXh0ZW5kcyBSZWFjdC5Db21wb25lbnQ8RmlsZVVwbG9hZGVyRGV0YWlsc1Byb3BzLCBGaWxlVXBsb2FkZXJEZXRhaWxzU3RhdGU+IHtcbiAgICBwcml2YXRlIGV2ZW50TWFuYWdlcjogRXZlbnRNYW5hZ2VyO1xuICAgIGNvbnN0cnVjdG9yKHByb3BzOiBGaWxlVXBsb2FkZXJEZXRhaWxzUHJvcHMpIHtcbiAgICAgICAgc3VwZXIocHJvcHMpO1xuICAgICAgICBjb25zdCB7IGV2ZW50cyB9ID0gcHJvcHM7XG4gICAgICAgIHRoaXMuZXZlbnRNYW5hZ2VyID0gZXZlbnRzIHx8IGV2ZW50TWFuYWdlcnNbMF07XG4gICAgICAgIHRoaXMuc3RhdGUgPSB7XG4gICAgICAgICAgICAuLi5pbml0aWFsU3RhdGUsXG4gICAgICAgIH07XG4gICAgfVxuICAgIGNvbXBvbmVudERpZE1vdW50KCkge1xuICAgICAgICBjb25zdCBlbSA9IHRoaXMuZXZlbnRNYW5hZ2VyO1xuICAgICAgICBlbS5vbihGaWxlVXBsb2FkQWN0aW9ucy5zdGFydFVwbG9hZCwgdGhpcy5vblN0YXJ0KTtcbiAgICAgICAgZW0ub24oRmlsZVVwbG9hZEFjdGlvbnMuY2FuY2VsVXBsb2FkLCB0aGlzLm9uQ2FuY2VsKTtcbiAgICAgICAgZW0ub24oRmlsZVVwbG9hZEFjdGlvbnMudXBsb2FkUHJvZ3Jlc3MsIHRoaXMub25DaGFuZ2UpO1xuICAgICAgICBlbS5vbihGaWxlVXBsb2FkQWN0aW9ucy51cGxvYWRGYWlsdXJlLCB0aGlzLm9uQ2hhbmdlKTtcbiAgICAgICAgZW0ub24oRmlsZVVwbG9hZEFjdGlvbnMuc2hvd1VwbG9hZHMsIHRoaXMuc2hvd0RldGFpbHMpO1xuICAgICAgICBlbS5vbihGaWxlVXBsb2FkQWN0aW9ucy5jbGVhclVwbG9hZHMsIHRoaXMub25DbGVhcik7XG4gICAgICAgIGVtLm9uKEZpbGVVcGxvYWRBY3Rpb25zLmRlbGV0ZVVwbG9hZHMsIHRoaXMub25EZWxldGUpO1xuICAgICAgICBldmVudE1hbmFnZXJzLnB1c2goZW0pO1xuICAgIH1cbiAgICBjb21wb25lbnRXaWxsVW5tb3VudCgpIHtcbiAgICAgICAgY29uc3QgZW0gPSB0aGlzLmV2ZW50TWFuYWdlcjtcbiAgICAgICAgZW0ub2ZmKEZpbGVVcGxvYWRBY3Rpb25zLnN0YXJ0VXBsb2FkLCB0aGlzLm9uU3RhcnQpO1xuICAgICAgICBlbS5vZmYoRmlsZVVwbG9hZEFjdGlvbnMuY2FuY2VsVXBsb2FkLCB0aGlzLm9uQ2FuY2VsKTtcbiAgICAgICAgZW0ub2ZmKEZpbGVVcGxvYWRBY3Rpb25zLnVwbG9hZFByb2dyZXNzLCB0aGlzLm9uQ2hhbmdlKTtcbiAgICAgICAgZW0ub2ZmKEZpbGVVcGxvYWRBY3Rpb25zLnVwbG9hZEZhaWx1cmUsIHRoaXMub25DaGFuZ2UpO1xuICAgICAgICBlbS5vZmYoRmlsZVVwbG9hZEFjdGlvbnMuc2hvd1VwbG9hZHMsIHRoaXMuc2hvd0RldGFpbHMpO1xuICAgICAgICBlbS5vZmYoRmlsZVVwbG9hZEFjdGlvbnMuY2xlYXJVcGxvYWRzLCB0aGlzLm9uQ2xlYXIpO1xuICAgICAgICBlbS5vZmYoRmlsZVVwbG9hZEFjdGlvbnMuZGVsZXRlVXBsb2FkcywgdGhpcy5vbkRlbGV0ZSk7XG4gICAgICAgIGV2ZW50TWFuYWdlcnMuc3BsaWNlKGV2ZW50TWFuYWdlcnMubGFzdEluZGV4T2YoZW0pLCAxKTtcbiAgICB9XG4gICAgcHJpdmF0ZSBvblN0YXJ0ID0gKGU6IEZpbGVVcGxvYWRlckRldGFpbHNFdmVudDxGaWxlSXRlbT4pID0+IHtcbiAgICAgICAgdGhpcy5wcm9wcy5vblVwbG9hZChlKTtcbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICBzaG93VXBsb2FkZXI6IHRydWUsXG4gICAgICAgIH0pO1xuICAgIH07XG4gICAgcHJpdmF0ZSBvbkNoYW5nZSA9ICh7IGZpbGVzIH06IEZpbGVVcGxvYWRlckRldGFpbHNFdmVudDxGaWxlUHJvZ3Jlc3M+KSA9PiB7XG4gICAgICAgIGNvbnN0IHsgZmlsZXM6IGN1cnJlbnRGaWxlcyB9ID0gdGhpcy5zdGF0ZTtcbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICBmaWxlczogbWVyZ2VEYXRhKGZpbGVzLCBjdXJyZW50RmlsZXMpLFxuICAgICAgICB9KTtcbiAgICB9O1xuICAgIHByaXZhdGUgb25DYW5jZWwgPSAoeyBmaWxlcyB9OiBGaWxlVXBsb2FkZXJEZXRhaWxzRXZlbnQ8RmlsZVByb2dyZXNzPikgPT4ge1xuICAgICAgICBjb25zdCB7IG9uQ2FuY2VsIH0gPSB0aGlzLnByb3BzO1xuICAgICAgICBpZiAodHlwZW9mIG9uQ2FuY2VsID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICBvbkNhbmNlbCh7XG4gICAgICAgICAgICAgICAgZmlsZXM6IGZpbGVzLmZpbHRlcihpdGVtID0+IGl0ZW0ucHJvZ3Jlc3MgPCAxMDAgJiYgIWl0ZW0uY2FuY2VsZWQgJiYgIWl0ZW0uZXJyb3IpLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9O1xuICAgIHByaXZhdGUgb25EZWxldGUgPSAoeyBmaWxlcyB9OiBGaWxlVXBsb2FkZXJEZXRhaWxzRXZlbnQ8RmlsZVByb2dyZXNzPikgPT4ge1xuICAgICAgICBjb25zdCB7IG9uRGVsZXRlIH0gPSB0aGlzLnByb3BzO1xuICAgICAgICBpZiAodHlwZW9mIG9uRGVsZXRlID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICBvbkRlbGV0ZSh7XG4gICAgICAgICAgICAgICAgZmlsZXM6IGZpbGVzLmZpbHRlcihpdGVtID0+IGl0ZW0ucHJvZ3Jlc3MgPj0gMTAwICYmICFpdGVtLmNhbmNlbGVkICYmICFpdGVtLmVycm9yKSxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfTtcbiAgICBwcml2YXRlIG9uQ2xlYXIgPSAodXBsb2FkZXJJZDogc3RyaW5nKSA9PiB7XG4gICAgICAgIGNvbnN0IHsgZmlsZXM6IGN1cnJlbnRGaWxlcyB9ID0gdGhpcy5zdGF0ZTtcbiAgICAgICAgY29uc3QgbmV3RmlsZXMgPSBjdXJyZW50RmlsZXMuZmlsdGVyKGl0ZW0gPT4gaXRlbS51cGxvYWRlcklkICE9PSB1cGxvYWRlcklkKTtcbiAgICAgICAgY29uc3Qgb2xkRmlsZXMgPSBjdXJyZW50RmlsZXMuZmlsdGVyKGl0ZW0gPT4gaXRlbS51cGxvYWRlcklkID09PSB1cGxvYWRlcklkKTtcbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICBmaWxlczogbmV3RmlsZXMsXG4gICAgICAgIH0sICgpID0+IHtcbiAgICAgICAgICAgIHRoaXMub25DYW5jZWwoe1xuICAgICAgICAgICAgICAgIGZpbGVzOiBvbGRGaWxlcyxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICB9O1xuICAgIHByaXZhdGUgY2xvc2VVcGxvYWRlciA9ICgpID0+IHtcbiAgICAgICAgY29uc3QgeyBvbkNsb3NlIH0gPSB0aGlzLnByb3BzO1xuICAgICAgICBpZiAodHlwZW9mIG9uQ2xvc2UgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgICAgIG9uQ2xvc2UoKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICAgIC4uLmluaXRpYWxTdGF0ZSxcbiAgICAgICAgfSk7XG4gICAgfTtcbiAgICBwcml2YXRlIGhpZGVEZXRhaWxzID0gKCkgPT4ge1xuICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICAgIHNob3dEZXRhaWxzOiBmYWxzZSxcbiAgICAgICAgfSk7XG4gICAgfTtcbiAgICBwcml2YXRlIHNob3dEZXRhaWxzID0gKCkgPT4ge1xuICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICAgIHNob3dEZXRhaWxzOiB0cnVlLFxuICAgICAgICB9KTtcbiAgICB9O1xuICAgIHJlbmRlcigpIHtcbiAgICAgICAgY29uc3QgeyBldmVudHMsIG9uQ2FuY2VsLCBvbkNsb3NlLCBvbkRlbGV0ZSwgb25VcGxvYWQsIC4uLnByb3BzIH0gPSB0aGlzLnByb3BzO1xuICAgICAgICBjb25zdCB7IHNob3dEZXRhaWxzLCBzaG93VXBsb2FkZXIsIGZpbGVzIH0gPSB0aGlzLnN0YXRlO1xuICAgICAgICBjb25zdCBpbnByb2dyZXNzRmlsZXMgPSBmaWxlcy5maWx0ZXIoaXRlbSA9PiAhKGl0ZW0uY2FuY2VsZWQgfHwgaXRlbS5lcnJvcikpLm1hcChpdGVtID0+IGl0ZW0ucHJvZ3Jlc3MpO1xuICAgICAgICBjb25zdCBlcnJvckZpbGVzID0gZmlsZXMuZmlsdGVyKGl0ZW0gPT4gaXRlbS5jYW5jZWxlZCB8fCBpdGVtLmVycm9yKTtcbiAgICAgICAgY29uc3QgdG90YWxQcm9ncmVzcyA9IGlucHJvZ3Jlc3NGaWxlcy5sZW5ndGggPiAwID8gaW5wcm9ncmVzc0ZpbGVzLnJlZHVjZSgoYWNjLCBjdXJyKSA9PiBhY2MgKyBjdXJyLCAwKSAvIGlucHJvZ3Jlc3NGaWxlcy5sZW5ndGggOiAxMDA7XG4gICAgICAgIGNvbnN0IHNjYW5uaW5nID0gZmlsZXMuZmlsdGVyKGl0ZW0gPT4gaXRlbS5zY2FubmluZyAmJiAhaXRlbS5jYW5jZWxlZCkubGVuZ3RoID4gMDtcbiAgICAgICAgY29uc3Qgc2hvdyA9IHNob3dVcGxvYWRlciAmJiBmaWxlcy5sZW5ndGggPiAwO1xuICAgICAgICByZXR1cm4gKHNob3cgJiYgKDw+XG4gICAgICAgICAgPFN0eWxlZERldGFpbHNIb3N0PlxuICAgICAgICAgICAgPFVwbG9hZGVyUHJvZ3Jlc3NEZXRhaWxzIHsuLi5wcm9wc30gb3Blbj17c2hvd0RldGFpbHN9IGZpbGVzPXtmaWxlc30gb25DYW5jZWw9e3RoaXMub25DYW5jZWx9IG9uRGVsZXRlPXt0aGlzLm9uRGVsZXRlfSBvbkhpZGU9e3RoaXMuaGlkZURldGFpbHN9IHByb2dyZXNzVmFsdWU9e3RvdGFsUHJvZ3Jlc3N9Lz5cbiAgICAgICAgICA8L1N0eWxlZERldGFpbHNIb3N0PlxuICAgICAgICAgIHshc2hvd0RldGFpbHMgJiYgKDxTdHlsZWRVcGxvYWRlckhvc3Q+XG4gICAgICAgICAgICAgIDxVcGxvYWRlclByb2dyZXNzQmFyIHsuLi5wcm9wc30gc2Nhbm5pbmc9e3NjYW5uaW5nfSBwcm9ncmVzc1ZhbHVlPXt0b3RhbFByb2dyZXNzfSBpblByb2dyZXNzPXtpbnByb2dyZXNzRmlsZXMubGVuZ3RofSBlcnJvcnM9e2Vycm9yRmlsZXMubGVuZ3RofSB0b3RhbD17ZmlsZXMubGVuZ3RofSBvblNob3c9e3RoaXMuc2hvd0RldGFpbHN9IG9uQ2xvc2U9e3RoaXMuY2xvc2VVcGxvYWRlcn0vPlxuICAgICAgICAgICAgPC9TdHlsZWRVcGxvYWRlckhvc3Q+KX1cbiAgICAgICAgPC8+KSk7XG4gICAgfVxuICAgIHN0YXRpYyBpbm5lciA9IHtcbiAgICAgICAgZ2V0IFN0eWxlZERldGFpbHNIb3N0KCkgeyByZXR1cm4gU3R5bGVkRGV0YWlsc0hvc3QgYXMgdHlwZW9mIFN0eWxlZERldGFpbHNIb3N0OyB9LFxuICAgICAgICBnZXQgVXBsb2FkZXJQcm9ncmVzc0RldGFpbHMoKSB7IHJldHVybiBVcGxvYWRlclByb2dyZXNzRGV0YWlscyBhcyB0eXBlb2YgVXBsb2FkZXJQcm9ncmVzc0RldGFpbHM7IH0sXG4gICAgICAgIGdldCBTdHlsZWRVcGxvYWRlckhvc3QoKSB7IHJldHVybiBTdHlsZWRVcGxvYWRlckhvc3QgYXMgdHlwZW9mIFN0eWxlZFVwbG9hZGVySG9zdDsgfSxcbiAgICAgICAgZ2V0IFVwbG9hZGVyUHJvZ3Jlc3NCYXIoKSB7IHJldHVybiBVcGxvYWRlclByb2dyZXNzQmFyIGFzIHR5cGVvZiBVcGxvYWRlclByb2dyZXNzQmFyOyB9XG4gICAgfTtcbn1cbiJdfQ==