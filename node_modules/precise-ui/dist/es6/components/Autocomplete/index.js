var __rest = (this && this.__rest) || function (s, e) {
    var t = {};
    for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)
        t[p] = s[p];
    if (s != null && typeof Object.getOwnPropertySymbols === "function")
        for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) if (e.indexOf(p[i]) < 0)
            t[p[i]] = s[p[i]];
    return t;
};
import * as React from 'react';
import styled, { themed, css } from '../../utils/styled';
import { TextField } from '../TextField';
import { withFormContext } from '../../hoc/withFormContext';
import { InteractiveList, InteractiveListDirection, } from '../InteractiveList';
const AutocompleteWrapper = styled.div `
  position: relative;
  width: 100%;
`;
const StyledInteractiveList = styled(InteractiveList) `
  position: static;
`;
const StyledAutosuggestWrapper = styled.ul(themed(({ direction, theme: { ui1, ui4 } }) => css `
      list-style: none;
      width: 100%;
      box-sizing: border-box;
      box-shadow: none;
      margin: 0;
      padding: 0;
      background: ${ui1};
      border: 1px solid ${ui4};
      ${direction === InteractiveListDirection.normal
    ? 'border-top-color: transparent'
    : 'border-bottom-color: transparent'};
      max-height: 50vh;
      position: absolute;
      top: ${direction === InteractiveListDirection.normal ? '100%' : '0px'};
      transform: translateY(${direction === InteractiveListDirection.normal ? 0 : -100}%);
      overflow-y: auto;
      z-index: 100;
    `));
function defaultSuggestionRenderer(suggestion) {
    const value = String(suggestion);
    return {
        content: value,
        key: value,
    };
}
function defaultInputRenderer(props) {
    return React.createElement(TextField, Object.assign({}, props));
}
const NotOpenComponent = React.createElement(React.Fragment, null);
const AutosuggestWrapper = Object.assign(((_a) => {
    var { border: _0, open } = _a, props = __rest(_a, ["border", "open"]);
    return open ? React.createElement(StyledAutosuggestWrapper, Object.assign({}, props)) : NotOpenComponent;
}), { inner: {
        get StyledAutosuggestWrapper() { return StyledAutosuggestWrapper; }
    } });
AutosuggestWrapper.displayName = 'AutosuggestWrapper';
class AutocompleteInt extends React.Component {
    constructor(props) {
        super(props);
        this.handleKeyDown = (e) => {
            const { keyCode } = e;
            switch (keyCode) {
                case 40 /* down */:
                case 38 /* up */:
                    e.preventDefault();
                    const { open } = this.state;
                    open &&
                        this.setState(() => ({
                            listFocus: true,
                            focus: false,
                        }));
                    break;
            }
        };
        this.handleListChange = (e) => {
            const { suggestions = [] } = this.props;
            const index = e.value[0];
            const suggestion = suggestions[index];
            this.handle(suggestion);
        };
        this.show = () => {
            this.setState({ open: true });
        };
        this.hide = () => {
            this.setState(() => ({ open: false }), this.props.onBlur);
        };
        this.handleFocus = () => {
            const { onFocus } = this.props;
            cancelAnimationFrame(this.delayedBlur);
            this.show();
            this.setState(() => ({ focus: true, listFocus: false }));
            typeof onFocus === 'function' && onFocus();
        };
        this.handleBlur = () => {
            cancelAnimationFrame(this.delayedBlur);
            this.delayedBlur = requestAnimationFrame(() => {
                this.setState(() => ({
                    focus: false,
                    listFocus: false,
                }), this.hide);
            });
        };
        this.changed = (e) => {
            this.updateValue(e.value);
        };
        this.setNode = (node) => {
            this._element = node;
            const { inputRef } = this.props;
            typeof inputRef === 'function' && inputRef(node);
        };
        this.state = {
            controlled: props.value !== undefined,
            value: props.value || props.defaultValue || '',
            open: false,
            listFocus: false,
            focus: false,
            error: props.error,
        };
    }
    UNSAFE_componentWillReceiveProps({ value = '', error }) {
        if (this.state.controlled) {
            this.setState({ value });
        }
        this.setState({ error });
    }
    componentDidMount() {
        const { form } = this.props;
        const { controlled } = this.state;
        if (!controlled && form) {
            form.subscribe(this);
        }
    }
    componentWillUnmount() {
        const { form } = this.props;
        const { controlled } = this.state;
        if (!controlled && form) {
            form.unsubscribe(this);
        }
    }
    updateValue(value, suggestionSelected = false) {
        const { onChange, name = '', form } = this.props;
        if (!this.state.controlled) {
            form ? form.change({ name, value }) : this.setState({ value });
        }
        suggestionSelected ? this.hide() : this.show();
        typeof onChange === 'function' && onChange({ value });
    }
    handle(suggestion) {
        const { getSuggestionValue, onSuggestionSelected } = this.props;
        if (typeof getSuggestionValue === 'function') {
            const value = getSuggestionValue(suggestion);
            this.updateValue(value, true);
        }
        else if (typeof suggestion === 'string') {
            this.updateValue(suggestion, true);
        }
        typeof onSuggestionSelected === 'function' && onSuggestionSelected({ value: suggestion });
    }
    render() {
        const _a = this.props, { suggestions = [], noSuggestionsMessage, renderSuggestion = defaultSuggestionRenderer, inputRenderer = defaultInputRenderer, getSuggestionValue: _1, onChange: _2, children: _3, onBlur: _4, onFocus: _5, defaultValue: _6, inputRef: _7, onSuggestionSelected: _8, info } = _a, props = __rest(_a, ["suggestions", "noSuggestionsMessage", "renderSuggestion", "inputRenderer", "getSuggestionValue", "onChange", "children", "onBlur", "onFocus", "defaultValue", "inputRef", "onSuggestionSelected", "info"]);
        const { open, listFocus, value, error } = this.state;
        const isListOpen = open && (!!suggestions.length || !!noSuggestionsMessage);
        return (React.createElement(AutocompleteWrapper, { onKeyDown: this.handleKeyDown, onFocus: this.handleFocus, onBlur: this.handleBlur },
            inputRenderer(Object.assign({}, props, { clearable: true, info: isListOpen ? undefined : info, onChange: this.changed, inputRef: this.setNode, value,
                error })),
            React.createElement(StyledInteractiveList, { data: suggestions.length ? suggestions.map(renderSuggestion) : [{ key: 'default', content: noSuggestionsMessage }], disabled: suggestions.length === 0, customWrapper: AutosuggestWrapper, focus: listFocus, onChange: this.handleListChange, autoPosition: true, open: isListOpen }),
            isListOpen && info && React.createElement("div", null, info)));
    }
}
AutocompleteInt.inner = {
    get AutocompleteWrapper() { return AutocompleteWrapper; },
    get StyledInteractiveList() { return StyledInteractiveList; }
};
/**
 * Extends a TextField with autocompletion capabilities.
 */
export const Autocomplete = withFormContext(AutocompleteInt);
Autocomplete.displayName = 'Autocomplete';
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvY29tcG9uZW50cy9BdXRvY29tcGxldGUvaW5kZXgudHN4Il0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQUFBLE9BQU8sS0FBSyxLQUFLLE1BQU0sT0FBTyxDQUFDO0FBQy9CLE9BQU8sTUFBTSxFQUFFLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQ3pELE9BQU8sRUFBRSxTQUFTLEVBQXdDLE1BQU0sY0FBYyxDQUFDO0FBQy9FLE9BQU8sRUFBb0IsZUFBZSxFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFDOUUsT0FBTyxFQUFFLGVBQWUsRUFBK0Isd0JBQXdCLEdBQStCLE1BQU0sb0JBQW9CLENBQUM7QUE4RHpJLE1BQU0sbUJBQW1CLEdBQUcsTUFBTSxDQUFDLEdBQUcsQ0FBQzs7O0NBR3RDLENBQUM7QUFDRixNQUFNLHFCQUFxQixHQUFHLE1BQU0sQ0FBQyxlQUFlLENBQUMsQ0FBQzs7Q0FFckQsQ0FBQztBQUlGLE1BQU0sd0JBQXdCLEdBQUcsTUFBTSxDQUFDLEVBQUUsQ0FBZ0MsTUFBTSxDQUFDLENBQUMsRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFFLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxFQUFFLEVBQUUsRUFBRSxDQUFDLEdBQUcsQ0FBQzs7Ozs7OztvQkFPekcsR0FBRzswQkFDRyxHQUFHO1FBQ3JCLFNBQVMsS0FBSyx3QkFBd0IsQ0FBQyxNQUFNO0lBQ2pELENBQUMsQ0FBQywrQkFBK0I7SUFDakMsQ0FBQyxDQUFDLGtDQUFrQzs7O2FBRzNCLFNBQVMsS0FBSyx3QkFBd0IsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsS0FBSzs4QkFDN0MsU0FBUyxLQUFLLHdCQUF3QixDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUc7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QztJQUMxQixDQUFDOztBQUNNLHFCQUFLLEdBQUc7SUFDWCxJQUFJLG1CQUFtQixLQUFLLE9BQU8sbUJBQWlELENBQUMsQ0FBQyxDQUFDO0lBQ3ZGLElBQUkscUJBQXFCLEtBQUssT0FBTyxxQkFBcUQsQ0FBQyxDQUFDLENBQUM7Q0FDaEcsQ0FBQztBQUVOOztHQUVHO0FBQ0gsTUFBTSxDQUFDLE1BQU0sWUFBWSxHQUFHLGVBQWUsQ0FBQyxlQUFlLENBQUMsQ0FBQztBQUM3RCxZQUFZLENBQUMsV0FBVyxHQUFHLGNBQWMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIFJlYWN0IGZyb20gJ3JlYWN0JztcbmltcG9ydCBzdHlsZWQsIHsgdGhlbWVkLCBjc3MgfSBmcm9tICcuLi8uLi91dGlscy9zdHlsZWQnO1xuaW1wb3J0IHsgVGV4dEZpZWxkLCBUZXh0RmllbGRQcm9wcywgVGV4dEZpZWxkQ2hhbmdlRXZlbnQgfSBmcm9tICcuLi9UZXh0RmllbGQnO1xuaW1wb3J0IHsgRm9ybUNvbnRleHRQcm9wcywgd2l0aEZvcm1Db250ZXh0IH0gZnJvbSAnLi4vLi4vaG9jL3dpdGhGb3JtQ29udGV4dCc7XG5pbXBvcnQgeyBJbnRlcmFjdGl2ZUxpc3QsIEludGVyYWN0aXZlTGlzdFdyYXBwZXJQcm9wcywgSW50ZXJhY3RpdmVMaXN0RGlyZWN0aW9uLCBJbnRlcmFjdGl2ZUxpc3RDaGFuZ2VFdmVudCwgfSBmcm9tICcuLi9JbnRlcmFjdGl2ZUxpc3QnO1xuaW1wb3J0IHsgS2V5Q29kZXMgfSBmcm9tICcuLi8uLi91dGlscy9rZXlDb2Rlcyc7XG5pbXBvcnQgeyBJbnB1dENoYW5nZUV2ZW50LCBPbWl0IH0gZnJvbSAnLi4vLi4vY29tbW9uJztcbmV4cG9ydCBpbnRlcmZhY2UgQXV0b3N1Z2dlc3RJdGVtIHtcbiAgICBrZXk6IHN0cmluZztcbiAgICBjb250ZW50PzogUmVhY3QuUmVhY3RDaGlsZDtcbn1cbmV4cG9ydCBpbnRlcmZhY2UgQXV0b3N1Z2dlc3RTZWxlY3RFdmVudDxUPiB7XG4gICAgdmFsdWU6IFQ7XG59XG5leHBvcnQgaW50ZXJmYWNlIEF1dG9jb21wbGV0ZUlucHV0UHJvcHMge1xuICAgIG9uQ2hhbmdlKGU6IElucHV0Q2hhbmdlRXZlbnQ8c3RyaW5nPik6IHZvaWQ7XG4gICAgY2xlYXJhYmxlOiBib29sZWFuO1xuICAgIGlucHV0UmVmPyhpbnN0YW5jZTogSFRNTEVsZW1lbnQgfCBudWxsKTogdm9pZDtcbiAgICB2YWx1ZTogc3RyaW5nO1xuICAgIGVycm9yOiBhbnk7XG4gICAgW2luZGV4OiBzdHJpbmddOiBhbnk7XG59XG5leHBvcnQgaW50ZXJmYWNlIEF1dG9jb21wbGV0ZVByb3BzPFQ+IGV4dGVuZHMgVGV4dEZpZWxkUHJvcHMge1xuICAgIC8qKlxuICAgICAqIFRoZSBvcHRpb25hbCBtZXNzYWdlIHRvIHNob3cgaW4gY2FzZSB0ZWhyZSBhcmUgbm8gc3VnZ2VzdGlvbnMgdG8gZGlzcGxheS5cbiAgICAgKi9cbiAgICBub1N1Z2dlc3Rpb25zTWVzc2FnZT86IFJlYWN0LlJlYWN0Q2hpbGQ7XG4gICAgLyoqXG4gICAgICogVGhlIGN1cnJlbnQgdmFsdWUgb2YgdGhlIHRleHQgZmllbGQsIGxlYWRpbmcgdG8gYSBjb250cm9sbGVkIHRleHQgZmllbGQuXG4gICAgICovXG4gICAgc3VnZ2VzdGlvbnM/OiBBcnJheTxUPjtcbiAgICAvKipcbiAgICAgKiBIb3cgdG8gcmVuZGVyIGVhY2ggc3VnZ2VzdGlvbiBpbiB0aGUgSW50ZXJhY3RpdmVMaXN0XG4gICAgICovXG4gICAgcmVuZGVyU3VnZ2VzdGlvbj8oZGF0YTogVCk6IEF1dG9zdWdnZXN0SXRlbTtcbiAgICAvKipcbiAgICAgKiBFdmVudCBlbWl0dGVkIGV2ZXJ5IHRpbWUgc3VnZ2VzdGlvbiBpcyBzZWxlY3RlZCB2aWEgbW91c2Ugb3Iga2V5Ym9hcmQuXG4gICAgICovXG4gICAgb25TdWdnZXN0aW9uU2VsZWN0ZWQ/KGU6IEF1dG9zdWdnZXN0U2VsZWN0RXZlbnQ8VD4pOiB2b2lkO1xuICAgIC8qKlxuICAgICAqIEdldHMgdGhlIHN1Z2dlc3Rpb24gdmFsdWUuXG4gICAgICovXG4gICAgZ2V0U3VnZ2VzdGlvblZhbHVlPyhpdGVtOiBUKTogc3RyaW5nO1xuICAgIC8qKlxuICAgICAqIFRoZSByZW5kZXJlciBvZiBpbnB1dCBmaWVsZC5cbiAgICAgKi9cbiAgICBpbnB1dFJlbmRlcmVyPyhwcm9wczogQXV0b2NvbXBsZXRlSW5wdXRQcm9wcyk6IEpTWC5FbGVtZW50O1xuICAgIC8qKlxuICAgICAqIEFsd2F5cyBgdHJ1ZWAgb24gQXV0b2NvbXBsZXRlIGNvbXBvbmVudHMuXG4gICAgICogQGlnbm9yZVxuICAgICAqL1xuICAgIGNsZWFyYWJsZT86IGJvb2xlYW47XG4gICAgLyoqXG4gICAgICogQGlnbm9yZVxuICAgICAqL1xuICAgIGlucHV0UmVmPyhpbnN0YW5jZTogSFRNTEVsZW1lbnQgfCBudWxsKTogdm9pZDtcbn1cbmV4cG9ydCB0eXBlIFN1cHBvcnRlZEF1dG9jb21wbGV0ZVByb3BzPFQ+ID0gT21pdDxBdXRvY29tcGxldGVQcm9wczxUPiwgJ2NsZWFyYWJsZSc+O1xuZXhwb3J0IGludGVyZmFjZSBBdXRvY29tcGxldGVTdGF0ZSB7XG4gICAgY29udHJvbGxlZDogYm9vbGVhbjtcbiAgICBsaXN0Rm9jdXM6IGJvb2xlYW47XG4gICAgZm9jdXM6IGJvb2xlYW47XG4gICAgb3BlbjogYm9vbGVhbjtcbiAgICB2YWx1ZTogc3RyaW5nO1xuICAgIGVycm9yPzogUmVhY3QuUmVhY3RDaGlsZDtcbn1cbmNvbnN0IEF1dG9jb21wbGV0ZVdyYXBwZXIgPSBzdHlsZWQuZGl2IGBcbiAgcG9zaXRpb246IHJlbGF0aXZlO1xuICB3aWR0aDogMTAwJTtcbmA7XG5jb25zdCBTdHlsZWRJbnRlcmFjdGl2ZUxpc3QgPSBzdHlsZWQoSW50ZXJhY3RpdmVMaXN0KSBgXG4gIHBvc2l0aW9uOiBzdGF0aWM7XG5gO1xuaW50ZXJmYWNlIFN0eWxlZEF1dG9zdWdnZXN0V3JhcHBlclByb3BzIHtcbiAgICBkaXJlY3Rpb246IEludGVyYWN0aXZlTGlzdERpcmVjdGlvbjtcbn1cbmNvbnN0IFN0eWxlZEF1dG9zdWdnZXN0V3JhcHBlciA9IHN0eWxlZC51bDxTdHlsZWRBdXRvc3VnZ2VzdFdyYXBwZXJQcm9wcz4odGhlbWVkKCh7IGRpcmVjdGlvbiwgdGhlbWU6IHsgdWkxLCB1aTQgfSB9KSA9PiBjc3MgYFxuICAgICAgbGlzdC1zdHlsZTogbm9uZTtcbiAgICAgIHdpZHRoOiAxMDAlO1xuICAgICAgYm94LXNpemluZzogYm9yZGVyLWJveDtcbiAgICAgIGJveC1zaGFkb3c6IG5vbmU7XG4gICAgICBtYXJnaW46IDA7XG4gICAgICBwYWRkaW5nOiAwO1xuICAgICAgYmFja2dyb3VuZDogJHt1aTF9O1xuICAgICAgYm9yZGVyOiAxcHggc29saWQgJHt1aTR9O1xuICAgICAgJHtkaXJlY3Rpb24gPT09IEludGVyYWN0aXZlTGlzdERpcmVjdGlvbi5ub3JtYWxcbiAgICA/ICdib3JkZXItdG9wLWNvbG9yOiB0cmFuc3BhcmVudCdcbiAgICA6ICdib3JkZXItYm90dG9tLWNvbG9yOiB0cmFuc3BhcmVudCd9O1xuICAgICAgbWF4LWhlaWdodDogNTB2aDtcbiAgICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTtcbiAgICAgIHRvcDogJHtkaXJlY3Rpb24gPT09IEludGVyYWN0aXZlTGlzdERpcmVjdGlvbi5ub3JtYWwgPyAnMTAwJScgOiAnMHB4J307XG4gICAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZVkoJHtkaXJlY3Rpb24gPT09IEludGVyYWN0aXZlTGlzdERpcmVjdGlvbi5ub3JtYWwgPyAwIDogLTEwMH0lKTtcbiAgICAgIG92ZXJmbG93LXk6IGF1dG87XG4gICAgICB6LWluZGV4OiAxMDA7XG4gICAgYCkpO1xuZnVuY3Rpb24gZGVmYXVsdFN1Z2dlc3Rpb25SZW5kZXJlcjxUPihzdWdnZXN0aW9uOiBUKTogQXV0b3N1Z2dlc3RJdGVtIHtcbiAgICBjb25zdCB2YWx1ZSA9IFN0cmluZyhzdWdnZXN0aW9uKTtcbiAgICByZXR1cm4ge1xuICAgICAgICBjb250ZW50OiB2YWx1ZSxcbiAgICAgICAga2V5OiB2YWx1ZSxcbiAgICB9O1xufVxuZnVuY3Rpb24gZGVmYXVsdElucHV0UmVuZGVyZXIocHJvcHM6IEF1dG9jb21wbGV0ZUlucHV0UHJvcHMpOiBKU1guRWxlbWVudCB7XG4gICAgcmV0dXJuIDxUZXh0RmllbGQgey4uLnByb3BzfS8+O1xufVxuY29uc3QgTm90T3BlbkNvbXBvbmVudCA9IDw+PC8+O1xuY29uc3QgQXV0b3N1Z2dlc3RXcmFwcGVyID0gT2JqZWN0LmFzc2lnbigoKCh7IGJvcmRlcjogXzAsIG9wZW4sIC4uLnByb3BzIH0pID0+IG9wZW4gPyA8U3R5bGVkQXV0b3N1Z2dlc3RXcmFwcGVyIHsuLi5wcm9wc30vPiA6IE5vdE9wZW5Db21wb25lbnQpIGFzIFJlYWN0LkZDPEludGVyYWN0aXZlTGlzdFdyYXBwZXJQcm9wcz4pLCB7IGlubmVyOiB7XG4gICAgICAgIGdldCBTdHlsZWRBdXRvc3VnZ2VzdFdyYXBwZXIoKSB7IHJldHVybiBTdHlsZWRBdXRvc3VnZ2VzdFdyYXBwZXIgYXMgdHlwZW9mIFN0eWxlZEF1dG9zdWdnZXN0V3JhcHBlcjsgfVxuICAgIH0gfSk7XG5BdXRvc3VnZ2VzdFdyYXBwZXIuZGlzcGxheU5hbWUgPSAnQXV0b3N1Z2dlc3RXcmFwcGVyJztcbmNsYXNzIEF1dG9jb21wbGV0ZUludDxUPiBleHRlbmRzIFJlYWN0LkNvbXBvbmVudDxTdXBwb3J0ZWRBdXRvY29tcGxldGVQcm9wczxUPiAmIEZvcm1Db250ZXh0UHJvcHMsIEF1dG9jb21wbGV0ZVN0YXRlPiB7XG4gICAgcHJpdmF0ZSBkZWxheWVkQmx1cjogbnVtYmVyO1xuICAgIHByaXZhdGUgX2VsZW1lbnQ6IEhUTUxFbGVtZW50IHwgbnVsbDtcbiAgICBjb25zdHJ1Y3Rvcihwcm9wczogQXV0b2NvbXBsZXRlUHJvcHM8VD4pIHtcbiAgICAgICAgc3VwZXIocHJvcHMpO1xuICAgICAgICB0aGlzLnN0YXRlID0ge1xuICAgICAgICAgICAgY29udHJvbGxlZDogcHJvcHMudmFsdWUgIT09IHVuZGVmaW5lZCxcbiAgICAgICAgICAgIHZhbHVlOiBwcm9wcy52YWx1ZSB8fCBwcm9wcy5kZWZhdWx0VmFsdWUgfHwgJycsXG4gICAgICAgICAgICBvcGVuOiBmYWxzZSxcbiAgICAgICAgICAgIGxpc3RGb2N1czogZmFsc2UsXG4gICAgICAgICAgICBmb2N1czogZmFsc2UsXG4gICAgICAgICAgICBlcnJvcjogcHJvcHMuZXJyb3IsXG4gICAgICAgIH07XG4gICAgfVxuICAgIFVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzKHsgdmFsdWUgPSAnJywgZXJyb3IgfTogQXV0b2NvbXBsZXRlUHJvcHM8VD4pIHtcbiAgICAgICAgaWYgKHRoaXMuc3RhdGUuY29udHJvbGxlZCkge1xuICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7IHZhbHVlIH0pO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuc2V0U3RhdGUoeyBlcnJvciB9KTtcbiAgICB9XG4gICAgY29tcG9uZW50RGlkTW91bnQoKSB7XG4gICAgICAgIGNvbnN0IHsgZm9ybSB9ID0gdGhpcy5wcm9wcztcbiAgICAgICAgY29uc3QgeyBjb250cm9sbGVkIH0gPSB0aGlzLnN0YXRlO1xuICAgICAgICBpZiAoIWNvbnRyb2xsZWQgJiYgZm9ybSkge1xuICAgICAgICAgICAgZm9ybS5zdWJzY3JpYmUodGhpcyk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgY29tcG9uZW50V2lsbFVubW91bnQoKSB7XG4gICAgICAgIGNvbnN0IHsgZm9ybSB9ID0gdGhpcy5wcm9wcztcbiAgICAgICAgY29uc3QgeyBjb250cm9sbGVkIH0gPSB0aGlzLnN0YXRlO1xuICAgICAgICBpZiAoIWNvbnRyb2xsZWQgJiYgZm9ybSkge1xuICAgICAgICAgICAgZm9ybS51bnN1YnNjcmliZSh0aGlzKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBwcml2YXRlIHVwZGF0ZVZhbHVlKHZhbHVlOiBzdHJpbmcsIHN1Z2dlc3Rpb25TZWxlY3RlZDogYm9vbGVhbiA9IGZhbHNlKSB7XG4gICAgICAgIGNvbnN0IHsgb25DaGFuZ2UsIG5hbWUgPSAnJywgZm9ybSB9ID0gdGhpcy5wcm9wcztcbiAgICAgICAgaWYgKCF0aGlzLnN0YXRlLmNvbnRyb2xsZWQpIHtcbiAgICAgICAgICAgIGZvcm0gPyBmb3JtLmNoYW5nZSh7IG5hbWUsIHZhbHVlIH0pIDogdGhpcy5zZXRTdGF0ZSh7IHZhbHVlIH0pO1xuICAgICAgICB9XG4gICAgICAgIHN1Z2dlc3Rpb25TZWxlY3RlZCA/IHRoaXMuaGlkZSgpIDogdGhpcy5zaG93KCk7XG4gICAgICAgIHR5cGVvZiBvbkNoYW5nZSA9PT0gJ2Z1bmN0aW9uJyAmJiBvbkNoYW5nZSh7IHZhbHVlIH0pO1xuICAgIH1cbiAgICBwcml2YXRlIGhhbmRsZUtleURvd24gPSAoZTogUmVhY3QuS2V5Ym9hcmRFdmVudDxIVE1MRWxlbWVudD4pID0+IHtcbiAgICAgICAgY29uc3QgeyBrZXlDb2RlIH0gPSBlO1xuICAgICAgICBzd2l0Y2ggKGtleUNvZGUpIHtcbiAgICAgICAgICAgIGNhc2UgS2V5Q29kZXMuZG93bjpcbiAgICAgICAgICAgIGNhc2UgS2V5Q29kZXMudXA6XG4gICAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgICAgIGNvbnN0IHsgb3BlbiB9ID0gdGhpcy5zdGF0ZTtcbiAgICAgICAgICAgICAgICBvcGVuICYmXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoKCkgPT4gKHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxpc3RGb2N1czogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvY3VzOiBmYWxzZSxcbiAgICAgICAgICAgICAgICAgICAgfSkpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgfTtcbiAgICBwcml2YXRlIGhhbmRsZUxpc3RDaGFuZ2UgPSAoZTogSW50ZXJhY3RpdmVMaXN0Q2hhbmdlRXZlbnQpID0+IHtcbiAgICAgICAgY29uc3QgeyBzdWdnZXN0aW9ucyA9IFtdIH0gPSB0aGlzLnByb3BzO1xuICAgICAgICBjb25zdCBpbmRleCA9IGUudmFsdWVbMF07XG4gICAgICAgIGNvbnN0IHN1Z2dlc3Rpb24gPSBzdWdnZXN0aW9uc1tpbmRleF07XG4gICAgICAgIHRoaXMuaGFuZGxlKHN1Z2dlc3Rpb24pO1xuICAgIH07XG4gICAgcHJpdmF0ZSBoYW5kbGUoc3VnZ2VzdGlvbjogVCkge1xuICAgICAgICBjb25zdCB7IGdldFN1Z2dlc3Rpb25WYWx1ZSwgb25TdWdnZXN0aW9uU2VsZWN0ZWQgfSA9IHRoaXMucHJvcHM7XG4gICAgICAgIGlmICh0eXBlb2YgZ2V0U3VnZ2VzdGlvblZhbHVlID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICBjb25zdCB2YWx1ZSA9IGdldFN1Z2dlc3Rpb25WYWx1ZShzdWdnZXN0aW9uKTtcbiAgICAgICAgICAgIHRoaXMudXBkYXRlVmFsdWUodmFsdWUsIHRydWUpO1xuICAgICAgICB9XG4gICAgICAgIGVsc2UgaWYgKHR5cGVvZiBzdWdnZXN0aW9uID09PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgdGhpcy51cGRhdGVWYWx1ZShzdWdnZXN0aW9uLCB0cnVlKTtcbiAgICAgICAgfVxuICAgICAgICB0eXBlb2Ygb25TdWdnZXN0aW9uU2VsZWN0ZWQgPT09ICdmdW5jdGlvbicgJiYgb25TdWdnZXN0aW9uU2VsZWN0ZWQoeyB2YWx1ZTogc3VnZ2VzdGlvbiB9KTtcbiAgICB9XG4gICAgcHJpdmF0ZSBzaG93ID0gKCkgPT4ge1xuICAgICAgICB0aGlzLnNldFN0YXRlKHsgb3BlbjogdHJ1ZSB9KTtcbiAgICB9O1xuICAgIHByaXZhdGUgaGlkZSA9ICgpID0+IHtcbiAgICAgICAgdGhpcy5zZXRTdGF0ZSgoKSA9PiAoeyBvcGVuOiBmYWxzZSB9KSwgdGhpcy5wcm9wcy5vbkJsdXIpO1xuICAgIH07XG4gICAgcHJpdmF0ZSBoYW5kbGVGb2N1cyA9ICgpID0+IHtcbiAgICAgICAgY29uc3QgeyBvbkZvY3VzIH0gPSB0aGlzLnByb3BzO1xuICAgICAgICBjYW5jZWxBbmltYXRpb25GcmFtZSh0aGlzLmRlbGF5ZWRCbHVyKTtcbiAgICAgICAgdGhpcy5zaG93KCk7XG4gICAgICAgIHRoaXMuc2V0U3RhdGUoKCkgPT4gKHsgZm9jdXM6IHRydWUsIGxpc3RGb2N1czogZmFsc2UgfSkpO1xuICAgICAgICB0eXBlb2Ygb25Gb2N1cyA9PT0gJ2Z1bmN0aW9uJyAmJiBvbkZvY3VzKCk7XG4gICAgfTtcbiAgICBwcml2YXRlIGhhbmRsZUJsdXIgPSAoKSA9PiB7XG4gICAgICAgIGNhbmNlbEFuaW1hdGlvbkZyYW1lKHRoaXMuZGVsYXllZEJsdXIpO1xuICAgICAgICB0aGlzLmRlbGF5ZWRCbHVyID0gcmVxdWVzdEFuaW1hdGlvbkZyYW1lKCgpID0+IHtcbiAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoKCkgPT4gKHtcbiAgICAgICAgICAgICAgICBmb2N1czogZmFsc2UsXG4gICAgICAgICAgICAgICAgbGlzdEZvY3VzOiBmYWxzZSxcbiAgICAgICAgICAgIH0pLCB0aGlzLmhpZGUpO1xuICAgICAgICB9KTtcbiAgICB9O1xuICAgIHByaXZhdGUgY2hhbmdlZCA9IChlOiBUZXh0RmllbGRDaGFuZ2VFdmVudCkgPT4ge1xuICAgICAgICB0aGlzLnVwZGF0ZVZhbHVlKGUudmFsdWUpO1xuICAgIH07XG4gICAgcHJpdmF0ZSBzZXROb2RlID0gKG5vZGU6IEhUTUxFbGVtZW50IHwgbnVsbCkgPT4ge1xuICAgICAgICB0aGlzLl9lbGVtZW50ID0gbm9kZTtcbiAgICAgICAgY29uc3QgeyBpbnB1dFJlZiB9ID0gdGhpcy5wcm9wcztcbiAgICAgICAgdHlwZW9mIGlucHV0UmVmID09PSAnZnVuY3Rpb24nICYmIGlucHV0UmVmKG5vZGUpO1xuICAgIH07XG4gICAgcmVuZGVyKCkge1xuICAgICAgICBjb25zdCB7IHN1Z2dlc3Rpb25zID0gW10sIG5vU3VnZ2VzdGlvbnNNZXNzYWdlLCByZW5kZXJTdWdnZXN0aW9uID0gZGVmYXVsdFN1Z2dlc3Rpb25SZW5kZXJlciwgaW5wdXRSZW5kZXJlciA9IGRlZmF1bHRJbnB1dFJlbmRlcmVyLCBnZXRTdWdnZXN0aW9uVmFsdWU6IF8xLCBvbkNoYW5nZTogXzIsIGNoaWxkcmVuOiBfMywgb25CbHVyOiBfNCwgb25Gb2N1czogXzUsIGRlZmF1bHRWYWx1ZTogXzYsIGlucHV0UmVmOiBfNywgb25TdWdnZXN0aW9uU2VsZWN0ZWQ6IF84LCBpbmZvLCAuLi5wcm9wcyB9ID0gdGhpcy5wcm9wcztcbiAgICAgICAgY29uc3QgeyBvcGVuLCBsaXN0Rm9jdXMsIHZhbHVlLCBlcnJvciB9ID0gdGhpcy5zdGF0ZTtcbiAgICAgICAgY29uc3QgaXNMaXN0T3BlbiA9IG9wZW4gJiYgKCEhc3VnZ2VzdGlvbnMubGVuZ3RoIHx8ICEhbm9TdWdnZXN0aW9uc01lc3NhZ2UpO1xuICAgICAgICByZXR1cm4gKDxBdXRvY29tcGxldGVXcmFwcGVyIG9uS2V5RG93bj17dGhpcy5oYW5kbGVLZXlEb3dufSBvbkZvY3VzPXt0aGlzLmhhbmRsZUZvY3VzfSBvbkJsdXI9e3RoaXMuaGFuZGxlQmx1cn0+XG4gICAgICAgIHtpbnB1dFJlbmRlcmVyKHtcbiAgICAgICAgICAgIC4uLnByb3BzLFxuICAgICAgICAgICAgY2xlYXJhYmxlOiB0cnVlLFxuICAgICAgICAgICAgaW5mbzogaXNMaXN0T3BlbiA/IHVuZGVmaW5lZCA6IGluZm8sXG4gICAgICAgICAgICBvbkNoYW5nZTogdGhpcy5jaGFuZ2VkLFxuICAgICAgICAgICAgaW5wdXRSZWY6IHRoaXMuc2V0Tm9kZSxcbiAgICAgICAgICAgIHZhbHVlLFxuICAgICAgICAgICAgZXJyb3IsXG4gICAgICAgIH0pfVxuICAgICAgICA8U3R5bGVkSW50ZXJhY3RpdmVMaXN0IGRhdGE9e3N1Z2dlc3Rpb25zLmxlbmd0aCA/IHN1Z2dlc3Rpb25zLm1hcChyZW5kZXJTdWdnZXN0aW9uKSA6IFt7IGtleTogJ2RlZmF1bHQnLCBjb250ZW50OiBub1N1Z2dlc3Rpb25zTWVzc2FnZSB9XX0gZGlzYWJsZWQ9e3N1Z2dlc3Rpb25zLmxlbmd0aCA9PT0gMH0gY3VzdG9tV3JhcHBlcj17QXV0b3N1Z2dlc3RXcmFwcGVyfSBmb2N1cz17bGlzdEZvY3VzfSBvbkNoYW5nZT17dGhpcy5oYW5kbGVMaXN0Q2hhbmdlfSBhdXRvUG9zaXRpb24gb3Blbj17aXNMaXN0T3Blbn0vPlxuICAgICAgICB7aXNMaXN0T3BlbiAmJiBpbmZvICYmIDxkaXY+e2luZm99PC9kaXY+fVxuICAgICAgPC9BdXRvY29tcGxldGVXcmFwcGVyPik7XG4gICAgfVxuICAgIHN0YXRpYyBpbm5lciA9IHtcbiAgICAgICAgZ2V0IEF1dG9jb21wbGV0ZVdyYXBwZXIoKSB7IHJldHVybiBBdXRvY29tcGxldGVXcmFwcGVyIGFzIHR5cGVvZiBBdXRvY29tcGxldGVXcmFwcGVyOyB9LFxuICAgICAgICBnZXQgU3R5bGVkSW50ZXJhY3RpdmVMaXN0KCkgeyByZXR1cm4gU3R5bGVkSW50ZXJhY3RpdmVMaXN0IGFzIHR5cGVvZiBTdHlsZWRJbnRlcmFjdGl2ZUxpc3Q7IH1cbiAgICB9O1xufVxuLyoqXG4gKiBFeHRlbmRzIGEgVGV4dEZpZWxkIHdpdGggYXV0b2NvbXBsZXRpb24gY2FwYWJpbGl0aWVzLlxuICovXG5leHBvcnQgY29uc3QgQXV0b2NvbXBsZXRlID0gd2l0aEZvcm1Db250ZXh0KEF1dG9jb21wbGV0ZUludCk7XG5BdXRvY29tcGxldGUuZGlzcGxheU5hbWUgPSAnQXV0b2NvbXBsZXRlJztcbiJdfQ==