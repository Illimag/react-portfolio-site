import * as React from 'react';
import { eventManagers } from '../../utils/eventManager';
import { Dropzone } from '../Dropzone';
import { FileUploadActions } from '../FileUploaderDetails';
import { generateId, getSimpleStatus } from './helpers';
export class UploadData {
    constructor(events) {
        this.filesChanged = ({ files }) => {
            const filteredFiles = files.filter(item => item.uploaderId === this.id);
            if (filteredFiles.length > 0) {
                const ids = filteredFiles.map(item => item.fileId);
                let changed = false;
                for (const file of this.files) {
                    const index = ids.indexOf(file.id);
                    if (index !== -1) {
                        const updatedFile = filteredFiles[index];
                        const updatedStatus = getSimpleStatus(updatedFile);
                        const hasChanged = updatedFile.data !== file.data || updatedFile.progress !== file.progress || file.status !== updatedStatus;
                        if (hasChanged) {
                            changed = true;
                            file.data = updatedFile.data;
                            file.progress = updatedFile.progress;
                            file.status = updatedStatus;
                        }
                    }
                }
                if (changed) {
                    this.emit('change');
                    if (this.ready) {
                        this.emit('ready');
                    }
                }
            }
        };
        this.id = generateId();
        this.events = events || eventManagers[0];
        this.files = [];
        this.notifications = [];
    }
    get completedFiles() {
        return this.files.filter(m => m.status === 'complete');
    }
    get ready() {
        return this.files.reduce((prev, curr) => prev && (curr.status === 'complete' || curr.status === 'canceled'), true);
    }
    get total() {
        return this.files.filter(file => file.status !== 'canceled').length;
    }
    commit(cb) {
        const handler = () => cb(this.completedFiles);
        if (this.ready) {
            handler();
        }
        else {
            this.once('ready', handler);
        }
    }
    once(type, cb) {
        const handler = () => {
            this.off(type, handler);
            cb();
        };
        this.on(type, handler);
    }
    on(type, cb) {
        if (this.notifications.length === 0) {
            this.connect();
        }
        this.notifications.push({ type, cb });
    }
    off(type, cb) {
        for (let i = this.notifications.length; i--;) {
            const notification = this.notifications[i];
            if (notification.type === type && notification.cb === cb) {
                this.notifications.splice(i, 1);
            }
        }
        if (this.notifications.length === 0) {
            this.disconnect();
        }
    }
    connect() {
        const em = this.events;
        em.on(FileUploadActions.uploadProgress, this.filesChanged);
        em.on(FileUploadActions.uploadFailure, this.filesChanged);
        em.on(FileUploadActions.uploadSuccess, this.filesChanged);
    }
    disconnect() {
        const em = this.events;
        em.off(FileUploadActions.uploadProgress, this.filesChanged);
        em.off(FileUploadActions.uploadFailure, this.filesChanged);
        em.off(FileUploadActions.uploadSuccess, this.filesChanged);
        em.emit(FileUploadActions.clearUploads, this.id);
    }
    emit(type) {
        for (const notification of this.notifications) {
            if (notification.type === type) {
                notification.cb();
            }
        }
    }
    push(files) {
        /**
         * TODO:
         * Update `FileSelect` component to assign generated id
         * to a file to enable multiple selection of the same file
         */
        const names = this.files.map(item => (item.status !== 'canceled' ? item.name : ''));
        const newUploadFiles = [];
        for (const file of files) {
            if (names.indexOf(file.name) === -1) {
                const id = generateId();
                const added = new Date();
                const data = {};
                newUploadFiles.push({
                    name: file.name,
                    fileId: id,
                    content: file,
                    type: file.type,
                    uploaderId: this.id,
                    timestamp: added,
                    data,
                });
                this.files.push({
                    id,
                    added,
                    status: 'new',
                    data,
                    name: file.name,
                    progress: 0,
                    type: file.type,
                });
            }
        }
        if (newUploadFiles.length) {
            this.emit('change');
            this.events.emit(FileUploadActions.startUpload, { files: newUploadFiles });
        }
    }
}
/**
 * The file uploader component that passes selected files to global uploader. Should be used with `FileUploaderDetails` component.
 */
export class FileUploader extends React.Component {
    constructor(props) {
        super(props);
        this.emitChange = () => {
            const { onChange } = this.props;
            if (typeof onChange === 'function') {
                const { files, ready, total } = this.data;
                onChange({
                    files: files.map(file => ({
                        data: file.data,
                        id: file.id,
                        name: file.name,
                        progress: file.progress,
                        state: file.status,
                        type: file.type,
                    })),
                    ready,
                    total,
                });
            }
        };
        this.filesAdded = (e) => {
            this.data.push(e.value);
        };
        this.fileSelect = (e) => {
            const { multiple } = this.props;
            const { files, events } = this.data;
            const notCanceledFiles = files.filter(file => file.status !== 'canceled');
            if (!multiple && notCanceledFiles.length === 1) {
                const completedFiles = notCanceledFiles.filter(file => file.status === 'complete');
                if (completedFiles.length === 0) {
                    e.preventDefault();
                    events.emit(FileUploadActions.showUploads, {});
                }
            }
        };
        const { data = new UploadData() } = props;
        this.data = data;
    }
    componentDidMount() {
        this.data.on('change', this.emitChange);
    }
    componentWillUnmount() {
        this.data.off('change', this.emitChange);
    }
    render() {
        const { multiple, message, children, showFileList } = this.props;
        const additionalProps = !showFileList ? { value: [] } : {};
        return (React.createElement(Dropzone, Object.assign({ multiple: multiple, onChange: this.filesAdded, onOpen: this.fileSelect, message: message }, additionalProps), children));
    }
}
FileUploader.inner = {
    get Dropzone() { return Dropzone; }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvY29tcG9uZW50cy9GaWxlVXBsb2FkZXIvaW5kZXgudHN4Il0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sS0FBSyxLQUFLLE1BQU0sT0FBTyxDQUFDO0FBQy9CLE9BQU8sRUFBZ0IsYUFBYSxFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFDdkUsT0FBTyxFQUFFLFFBQVEsRUFBMEMsTUFBTSxhQUFhLENBQUM7QUFDL0UsT0FBTyxFQUFFLGlCQUFpQixFQUFvRCxNQUFNLHdCQUF3QixDQUFDO0FBQzdHLE9BQU8sRUFBRSxVQUFVLEVBQUUsZUFBZSxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBa0Z4RCxNQUFNLE9BQU8sVUFBVTtJQUtuQixZQUFZLE1BQXFCO1FBb0V6QixpQkFBWSxHQUFHLENBQUMsRUFBRSxLQUFLLEVBQTBDLEVBQUUsRUFBRTtZQUN6RSxNQUFNLGFBQWEsR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLFVBQVUsS0FBSyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUM7WUFDeEUsSUFBSSxhQUFhLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtnQkFDMUIsTUFBTSxHQUFHLEdBQUcsYUFBYSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztnQkFDbkQsSUFBSSxPQUFPLEdBQUcsS0FBSyxDQUFDO2dCQUNwQixLQUFLLE1BQU0sSUFBSSxJQUFJLElBQUksQ0FBQyxLQUFLLEVBQUU7b0JBQzNCLE1BQU0sS0FBSyxHQUFHLEdBQUcsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO29CQUNuQyxJQUFJLEtBQUssS0FBSyxDQUFDLENBQUMsRUFBRTt3QkFDZCxNQUFNLFdBQVcsR0FBRyxhQUFhLENBQUMsS0FBSyxDQUFDLENB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QUUsRUFBRSxHQUFHLEtBQUssQ0FBQztRQUMxQyxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztJQUNyQixDQUFDO0lBQ0QsaUJBQWlCO1FBQ2IsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQztJQUM1QyxDQUFDO0lBQ0Qsb0JBQW9CO1FBQ2hCLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUM7SUFDN0MsQ0FBQztJQWtDRCxNQUFNO1FBQ0YsTUFBTSxFQUFFLFFBQVEsRUFBRSxPQUFPLEVBQUUsUUFBUSxFQUFFLFlBQVksRUFBRSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUM7UUFDakUsTUFBTSxlQUFlLEdBQUcsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLEVBQUUsS0FBSyxFQUFFLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7UUFDM0QsT0FBTyxDQUFDLG9CQUFDLFFBQVEsa0JBQUMsUUFBUSxFQUFFLFFBQVEsRUFBRSxRQUFRLEVBQUUsSUFBSSxDQUFDLFVBQVUsRUFBRSxNQUFNLEVBQUUsSUFBSSxDQUFDLFVBQVUsRUFBRSxPQUFPLEVBQUUsT0FBTyxJQUFNLGVBQWUsR0FDOUgsUUFBUSxDQUNBLENBQUMsQ0FBQztJQUNmLENBQUM7O0FBQ00sa0JBQUssR0FBRztJQUNYLElBQUksUUFBUSxLQUFLLE9BQU8sUUFBMkIsQ0FBQyxDQUFDLENBQUM7Q0FDekQsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIFJlYWN0IGZyb20gJ3JlYWN0JztcbmltcG9ydCB7IEV2ZW50TWFuYWdlciwgZXZlbnRNYW5hZ2VycyB9IGZyb20gJy4uLy4uL3V0aWxzL2V2ZW50TWFuYWdlcic7XG5pbXBvcnQgeyBEcm9wem9uZSwgRHJvcHpvbmVPcGVuRXZlbnQsIERyb3B6b25lQ2hhbmdlRXZlbnQgfSBmcm9tICcuLi9Ecm9wem9uZSc7XG5pbXBvcnQgeyBGaWxlVXBsb2FkQWN0aW9ucywgRmlsZUl0ZW0sIEZpbGVQcm9ncmVzcywgRmlsZVVwbG9hZGVyRGV0YWlsc0V2ZW50IH0gZnJvbSAnLi4vRmlsZVVwbG9hZGVyRGV0YWlscyc7XG5pbXBvcnQgeyBnZW5lcmF0ZUlkLCBnZXRTaW1wbGVTdGF0dXMgfSBmcm9tICcuL2hlbHBlcnMnO1xuZXhwb3J0IHR5cGUgVXBsb2FkRmlsZVN0YXRlID0gJ25ldycgfCAnYWN0aXZlJyB8ICdjYW5jZWxlZCcgfCAnY29tcGxldGUnO1xuZXhwb3J0IGludGVyZmFjZSBVcGxvYWRGaWxlU3RhdHVzIHtcbiAgICAvKipcbiAgICAgKiBUaGUgaWQgb2YgdGhlIGZpbGUgZm9yIGlkZW50aWZpY2F0aW9uLlxuICAgICAqL1xuICAgIGlkOiBzdHJpbmc7XG4gICAgLyoqXG4gICAgICogVGhlIG5hbWUgb2YgdGhlIGZpbGUuXG4gICAgICovXG4gICAgbmFtZTogc3RyaW5nO1xuICAgIC8qKlxuICAgICAqIFRoZSBjb250ZW50LXR5cGUgb2YgdGhlIGZpbGUuXG4gICAgICovXG4gICAgdHlwZTogc3RyaW5nO1xuICAgIC8qKlxuICAgICAqIFRoZSBjdXJyZW50IHByb2dyZXNzIG9mIHRoZSBmaWxlLlxuICAgICAqL1xuICAgIHByb2dyZXNzOiBudW1iZXI7XG4gICAgLyoqXG4gICAgICogVGhlIGN1cnJlbnQgc3RhdGUgb2YgdGhlIGZpbGUuXG4gICAgICovXG4gICAgc3RhdGU6IFVwbG9hZEZpbGVTdGF0ZTtcbiAgICAvKipcbiAgICAgKiBBcmJpdHJhcnkgZGF0YSBhc3NvY2lhdGVkIHdpdGggdGhlIGZpbGUsIHdoaWNoIGlzIHNldCBieSB0aGUgdXBsb2FkIGhvc3QuXG4gICAgICovXG4gICAgZGF0YTogYW55O1xufVxuZXhwb3J0IGludGVyZmFjZSBGaWxlVXBsb2FkZXJDaGFuZ2VFdmVudCB7XG4gICAgLyoqXG4gICAgICogVGhlIGZpbGVzIHRoYXQgY2hhbmdlZC5cbiAgICAgKi9cbiAgICBmaWxlczogQXJyYXk8VXBsb2FkRmlsZVN0YXR1cz47XG4gICAgLyoqXG4gICAgICogVGhlIHRvdGFsIG51bWJlciBvZiBzZWxlY3RlZCBmaWxlcy5cbiAgICAgKi9cbiAgICB0b3RhbDogbnVtYmVyO1xuICAgIC8qKlxuICAgICAqIFN0YXR1cyBpZiB0aGUgc2VsZWN0ZWQgZmlsZXMgYXJlIGFsbCB1cGxvYWRlZCBhbmQgdmVyaWZpZWQuXG4gICAgICovXG4gICAgcmVhZHk6IGJvb2xlYW47XG59XG5leHBvcnQgaW50ZXJmYWNlIEZpbGVVcGxvYWRlclByb3BzIHtcbiAgICAvKipcbiAgICAgKiBBbGxvdyBzZWxlY3RpbmcgbXVsdGlwbGUgZmlsZXMuXG4gICAgICovXG4gICAgbXVsdGlwbGU/OiBib29sZWFuO1xuICAgIC8qKlxuICAgICAqIEV2ZW50IGVtaXR0ZWQgd2hlbiBmaWxlIHVwbG9hZCBjaGFuZ2VzLlxuICAgICAqL1xuICAgIG9uQ2hhbmdlPyhlOiBGaWxlVXBsb2FkZXJDaGFuZ2VFdmVudCk6IHZvaWQ7XG4gICAgLyoqXG4gICAgICogT3B0aW9uYWxseSB1c2VzIGFuIGV4cGxpY2l0IHVwbG9hZCBkYXRhIGNvbm5lY3Rvci5cbiAgICAgKi9cbiAgICBkYXRhPzogVXBsb2FkRGF0YTtcbiAgICAvKipcbiAgICAgKiBNZXNzYWdlIGZvciBkcmFnZ2luZyBmaWxlcyB0byBzaG93IG9uIGRyb3AgYXJlYS5cbiAgICAgKiBAZGVmYXVsdCBcIkRyb3AgZmlsZXMgaGVyZSB0byB1cGxvYWRcIlxuICAgICAqL1xuICAgIG1lc3NhZ2U/OiBzdHJpbmc7XG4gICAgLyoqXG4gICAgICogU2hvdyB0aGUgZmlsZSBsaXN0IHVuZGVyIHRoZSBkcm9wIHpvbmVcbiAgICAgKi9cbiAgICBzaG93RmlsZUxpc3Q/OiBib29sZWFuO1xufVxuZXhwb3J0IGludGVyZmFjZSBVcGxvYWRGaWxlIHtcbiAgICBpZDogc3RyaW5nO1xuICAgIG5hbWU6IHN0cmluZztcbiAgICB0eXBlOiBzdHJpbmc7XG4gICAgcHJvZ3Jlc3M6IG51bWJlcjtcbiAgICBkYXRhOiBhbnk7XG4gICAgYWRkZWQ6IERhdGU7XG4gICAgc3RhdHVzOiBVcGxvYWRGaWxlU3RhdGU7XG59XG5leHBvcnQgdHlwZSBVcGxvYWREYXRhRXZlbnRUeXBlID0gJ2NoYW5nZScgfCAncmVhZHknO1xuZXhwb3J0IGludGVyZmFjZSBVcGxvYWREYXRhRXZlbnRMaXN0ZW5lciB7XG4gICAgKCk6IHZvaWQ7XG59XG5pbnRlcmZhY2UgVXBsb2FkRGF0YU5vdGlmaWNhdGlvbiB7XG4gICAgdHlwZTogVXBsb2FkRGF0YUV2ZW50VHlwZTtcbiAgICBjYjogVXBsb2FkRGF0YUV2ZW50TGlzdGVuZXI7XG59XG5leHBvcnQgY2xhc3MgVXBsb2FkRGF0YSB7XG4gICAgcmVhZG9ubHkgaWQ6IHN0cmluZztcbiAgICByZWFkb25seSBldmVudHM6IEV2ZW50TWFuYWdlcjtcbiAgICByZWFkb25seSBmaWxlczogQXJyYXk8VXBsb2FkRmlsZT47XG4gICAgcHJpdmF0ZSByZWFkb25seSBub3RpZmljYXRpb25zOiBBcnJheTxVcGxvYWREYXRhTm90aWZpY2F0aW9uPjtcbiAgICBjb25zdHJ1Y3RvcihldmVudHM/OiBFdmVudE1hbmFnZXIpIHtcbiAgICAgICAgdGhpcy5pZCA9IGdlbmVyYXRlSWQoKTtcbiAgICAgICAgdGhpcy5ldmVudHMgPSBldmVudHMgfHwgZXZlbnRNYW5hZ2Vyc1swXTtcbiAgICAgICAgdGhpcy5maWxlcyA9IFtdO1xuICAgICAgICB0aGlzLm5vdGlmaWNhdGlvbnMgPSBbXTtcbiAgICB9XG4gICAgZ2V0IGNvbXBsZXRlZEZpbGVzKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5maWxlcy5maWx0ZXIobSA9PiBtLnN0YXR1cyA9PT0gJ2NvbXBsZXRlJyk7XG4gICAgfVxuICAgIGdldCByZWFkeSgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZmlsZXMucmVkdWNlKChwcmV2LCBjdXJyKSA9PiBwcmV2ICYmIChjdXJyLnN0YXR1cyA9PT0gJ2NvbXBsZXRlJyB8fCBjdXJyLnN0YXR1cyA9PT0gJ2NhbmNlbGVkJyksIHRydWUpO1xuICAgIH1cbiAgICBnZXQgdG90YWwoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmZpbGVzLmZpbHRlcihmaWxlID0+IGZpbGUuc3RhdHVzICE9PSAnY2FuY2VsZWQnKS5sZW5ndGg7XG4gICAgfVxuICAgIGNvbW1pdChjYjogKGNvbXBsZXRlZEZpbGVzOiBBcnJheTxVcGxvYWRGaWxlPikgPT4gdm9pZCkge1xuICAgICAgICBjb25zdCBoYW5kbGVyID0gKCkgPT4gY2IodGhpcy5jb21wbGV0ZWRGaWxlcyk7XG4gICAgICAgIGlmICh0aGlzLnJlYWR5KSB7XG4gICAgICAgICAgICBoYW5kbGVyKCk7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICB0aGlzLm9uY2UoJ3JlYWR5JywgaGFuZGxlcik7XG4gICAgICAgIH1cbiAgICB9XG4gICAgb25jZSh0eXBlOiBVcGxvYWREYXRhRXZlbnRUeXBlLCBjYjogVXBsb2FkRGF0YUV2ZW50TGlzdGVuZXIpIHtcbiAgICAgICAgY29uc3QgaGFuZGxlciA9ICgpID0+IHtcbiAgICAgICAgICAgIHRoaXMub2ZmKHR5cGUsIGhhbmRsZXIpO1xuICAgICAgICAgICAgY2IoKTtcbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy5vbih0eXBlLCBoYW5kbGVyKTtcbiAgICB9XG4gICAgb24odHlwZTogVXBsb2FkRGF0YUV2ZW50VHlwZSwgY2I6IFVwbG9hZERhdGFFdmVudExpc3RlbmVyKSB7XG4gICAgICAgIGlmICh0aGlzLm5vdGlmaWNhdGlvbnMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICB0aGlzLmNvbm5lY3QoKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLm5vdGlmaWNhdGlvbnMucHVzaCh7IHR5cGUsIGNiIH0pO1xuICAgIH1cbiAgICBvZmYodHlwZTogVXBsb2FkRGF0YUV2ZW50VHlwZSwgY2I6IFVwbG9hZERhdGFFdmVudExpc3RlbmVyKSB7XG4gICAgICAgIGZvciAobGV0IGkgPSB0aGlzLm5vdGlmaWNhdGlvbnMubGVuZ3RoOyBpLS07KSB7XG4gICAgICAgICAgICBjb25zdCBub3RpZmljYXRpb24gPSB0aGlzLm5vdGlmaWNhdGlvbnNbaV07XG4gICAgICAgICAgICBpZiAobm90aWZpY2F0aW9uLnR5cGUgPT09IHR5cGUgJiYgbm90aWZpY2F0aW9uLmNiID09PSBjYikge1xuICAgICAgICAgICAgICAgIHRoaXMubm90aWZpY2F0aW9ucy5zcGxpY2UoaSwgMSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMubm90aWZpY2F0aW9ucy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgIHRoaXMuZGlzY29ubmVjdCgpO1xuICAgICAgICB9XG4gICAgfVxuICAgIHByaXZhdGUgY29ubmVjdCgpIHtcbiAgICAgICAgY29uc3QgZW0gPSB0aGlzLmV2ZW50cztcbiAgICAgICAgZW0ub24oRmlsZVVwbG9hZEFjdGlvbnMudXBsb2FkUHJvZ3Jlc3MsIHRoaXMuZmlsZXNDaGFuZ2VkKTtcbiAgICAgICAgZW0ub24oRmlsZVVwbG9hZEFjdGlvbnMudXBsb2FkRmFpbHVyZSwgdGhpcy5maWxlc0NoYW5nZWQpO1xuICAgICAgICBlbS5vbihGaWxlVXBsb2FkQWN0aW9ucy51cGxvYWRTdWNjZXNzLCB0aGlzLmZpbGVzQ2hhbmdlZCk7XG4gICAgfVxuICAgIHByaXZhdGUgZGlzY29ubmVjdCgpIHtcbiAgICAgICAgY29uc3QgZW0gPSB0aGlzLmV2ZW50cztcbiAgICAgICAgZW0ub2ZmKEZpbGVVcGxvYWRBY3Rpb25zLnVwbG9hZFByb2dyZXNzLCB0aGlzLmZpbGVzQ2hhbmdlZCk7XG4gICAgICAgIGVtLm9mZihGaWxlVXBsb2FkQWN0aW9ucy51cGxvYWRGYWlsdXJlLCB0aGlzLmZpbGVzQ2hhbmdlZCk7XG4gICAgICAgIGVtLm9mZihGaWxlVXBsb2FkQWN0aW9ucy51cGxvYWRTdWNjZXNzLCB0aGlzLmZpbGVzQ2hhbmdlZCk7XG4gICAgICAgIGVtLmVtaXQoRmlsZVVwbG9hZEFjdGlvbnMuY2xlYXJVcGxvYWRzLCB0aGlzLmlkKTtcbiAgICB9XG4gICAgcHJpdmF0ZSBlbWl0KHR5cGU6IFVwbG9hZERhdGFFdmVudFR5cGUpIHtcbiAgICAgICAgZm9yIChjb25zdCBub3RpZmljYXRpb24gb2YgdGhpcy5ub3RpZmljYXRpb25zKSB7XG4gICAgICAgICAgICBpZiAobm90aWZpY2F0aW9uLnR5cGUgPT09IHR5cGUpIHtcbiAgICAgICAgICAgICAgICBub3RpZmljYXRpb24uY2IoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICBwcml2YXRlIGZpbGVzQ2hhbmdlZCA9ICh7IGZpbGVzIH06IEZpbGVVcGxvYWRlckRldGFpbHNFdmVudDxGaWxlUHJvZ3Jlc3M+KSA9PiB7XG4gICAgICAgIGNvbnN0IGZpbHRlcmVkRmlsZXMgPSBmaWxlcy5maWx0ZXIoaXRlbSA9PiBpdGVtLnVwbG9hZGVySWQgPT09IHRoaXMuaWQpO1xuICAgICAgICBpZiAoZmlsdGVyZWRGaWxlcy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICBjb25zdCBpZHMgPSBmaWx0ZXJlZEZpbGVzLm1hcChpdGVtID0+IGl0ZW0uZmlsZUlkKTtcbiAgICAgICAgICAgIGxldCBjaGFuZ2VkID0gZmFsc2U7XG4gICAgICAgICAgICBmb3IgKGNvbnN0IGZpbGUgb2YgdGhpcy5maWxlcykge1xuICAgICAgICAgICAgICAgIGNvbnN0IGluZGV4ID0gaWRzLmluZGV4T2YoZmlsZS5pZCk7XG4gICAgICAgICAgICAgICAgaWYgKGluZGV4ICE9PSAtMSkge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCB1cGRhdGVkRmlsZSA9IGZpbHRlcmVkRmlsZXNbaW5kZXhdO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCB1cGRhdGVkU3RhdHVzID0gZ2V0U2ltcGxlU3RhdHVzKHVwZGF0ZWRGaWxlKTtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgaGFzQ2hhbmdlZCA9IHVwZGF0ZWRGaWxlLmRhdGEgIT09IGZpbGUuZGF0YSB8fCB1cGRhdGVkRmlsZS5wcm9ncmVzcyAhPT0gZmlsZS5wcm9ncmVzcyB8fCBmaWxlLnN0YXR1cyAhPT0gdXBkYXRlZFN0YXR1cztcbiAgICAgICAgICAgICAgICAgICAgaWYgKGhhc0NoYW5nZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNoYW5nZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgZmlsZS5kYXRhID0gdXBkYXRlZEZpbGUuZGF0YTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZpbGUucHJvZ3Jlc3MgPSB1cGRhdGVkRmlsZS5wcm9ncmVzcztcbiAgICAgICAgICAgICAgICAgICAgICAgIGZpbGUuc3RhdHVzID0gdXBkYXRlZFN0YXR1cztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChjaGFuZ2VkKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5lbWl0KCdjaGFuZ2UnKTtcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5yZWFkeSkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmVtaXQoJ3JlYWR5Jyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfTtcbiAgICBwdXNoKGZpbGVzOiBBcnJheTxGaWxlPikge1xuICAgICAgICAvKipcbiAgICAgICAgICogVE9ETzpcbiAgICAgICAgICogVXBkYXRlIGBGaWxlU2VsZWN0YCBjb21wb25lbnQgdG8gYXNzaWduIGdlbmVyYXRlZCBpZFxuICAgICAgICAgKiB0byBhIGZpbGUgdG8gZW5hYmxlIG11bHRpcGxlIHNlbGVjdGlvbiBvZiB0aGUgc2FtZSBmaWxlXG4gICAgICAgICAqL1xuICAgICAgICBjb25zdCBuYW1lcyA9IHRoaXMuZmlsZXMubWFwKGl0ZW0gPT4gKGl0ZW0uc3RhdHVzICE9PSAnY2FuY2VsZWQnID8gaXRlbS5uYW1lIDogJycpKTtcbiAgICAgICAgY29uc3QgbmV3VXBsb2FkRmlsZXM6IEFycmF5PEZpbGVJdGVtPiA9IFtdO1xuICAgICAgICBmb3IgKGNvbnN0IGZpbGUgb2YgZmlsZXMpIHtcbiAgICAgICAgICAgIGlmIChuYW1lcy5pbmRleE9mKGZpbGUubmFtZSkgPT09IC0xKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgaWQgPSBnZW5lcmF0ZUlkKCk7XG4gICAgICAgICAgICAgICAgY29uc3QgYWRkZWQgPSBuZXcgRGF0ZSgpO1xuICAgICAgICAgICAgICAgIGNvbnN0IGRhdGEgPSB7fTtcbiAgICAgICAgICAgICAgICBuZXdVcGxvYWRGaWxlcy5wdXNoKHtcbiAgICAgICAgICAgICAgICAgICAgbmFtZTogZmlsZS5uYW1lLFxuICAgICAgICAgICAgICAgICAgICBmaWxlSWQ6IGlkLFxuICAgICAgICAgICAgICAgICAgICBjb250ZW50OiBmaWxlLFxuICAgICAgICAgICAgICAgICAgICB0eXBlOiBmaWxlLnR5cGUsXG4gICAgICAgICAgICAgICAgICAgIHVwbG9hZGVySWQ6IHRoaXMuaWQsXG4gICAgICAgICAgICAgICAgICAgIHRpbWVzdGFtcDogYWRkZWQsXG4gICAgICAgICAgICAgICAgICAgIGRhdGEsXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgdGhpcy5maWxlcy5wdXNoKHtcbiAgICAgICAgICAgICAgICAgICAgaWQsXG4gICAgICAgICAgICAgICAgICAgIGFkZGVkLFxuICAgICAgICAgICAgICAgICAgICBzdGF0dXM6ICduZXcnLFxuICAgICAgICAgICAgICAgICAgICBkYXRhLFxuICAgICAgICAgICAgICAgICAgICBuYW1lOiBmaWxlLm5hbWUsXG4gICAgICAgICAgICAgICAgICAgIHByb2dyZXNzOiAwLFxuICAgICAgICAgICAgICAgICAgICB0eXBlOiBmaWxlLnR5cGUsXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKG5ld1VwbG9hZEZpbGVzLmxlbmd0aCkge1xuICAgICAgICAgICAgdGhpcy5lbWl0KCdjaGFuZ2UnKTtcbiAgICAgICAgICAgIHRoaXMuZXZlbnRzLmVtaXQoRmlsZVVwbG9hZEFjdGlvbnMuc3RhcnRVcGxvYWQsIHsgZmlsZXM6IG5ld1VwbG9hZEZpbGVzIH0pO1xuICAgICAgICB9XG4gICAgfVxufVxuLyoqXG4gKiBUaGUgZmlsZSB1cGxvYWRlciBjb21wb25lbnQgdGhhdCBwYXNzZXMgc2VsZWN0ZWQgZmlsZXMgdG8gZ2xvYmFsIHVwbG9hZGVyLiBTaG91bGQgYmUgdXNlZCB3aXRoIGBGaWxlVXBsb2FkZXJEZXRhaWxzYCBjb21wb25lbnQuXG4gKi9cbmV4cG9ydCBjbGFzcyBGaWxlVXBsb2FkZXIgZXh0ZW5kcyBSZWFjdC5Db21wb25lbnQ8RmlsZVVwbG9hZGVyUHJvcHM+IHtcbiAgICBwcml2YXRlIHJlYWRvbmx5IGRhdGE6IFVwbG9hZERhdGE7XG4gICAgY29uc3RydWN0b3IocHJvcHM6IEZpbGVVcGxvYWRlclByb3BzKSB7XG4gICAgICAgIHN1cGVyKHByb3BzKTtcbiAgICAgICAgY29uc3QgeyBkYXRhID0gbmV3IFVwbG9hZERhdGEoKSB9ID0gcHJvcHM7XG4gICAgICAgIHRoaXMuZGF0YSA9IGRhdGE7XG4gICAgfVxuICAgIGNvbXBvbmVudERpZE1vdW50KCkge1xuICAgICAgICB0aGlzLmRhdGEub24oJ2NoYW5nZScsIHRoaXMuZW1pdENoYW5nZSk7XG4gICAgfVxuICAgIGNvbXBvbmVudFdpbGxVbm1vdW50KCkge1xuICAgICAgICB0aGlzLmRhdGEub2ZmKCdjaGFuZ2UnLCB0aGlzLmVtaXRDaGFuZ2UpO1xuICAgIH1cbiAgICBwcml2YXRlIGVtaXRDaGFuZ2UgPSAoKSA9PiB7XG4gICAgICAgIGNvbnN0IHsgb25DaGFuZ2UgfSA9IHRoaXMucHJvcHM7XG4gICAgICAgIGlmICh0eXBlb2Ygb25DaGFuZ2UgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgICAgIGNvbnN0IHsgZmlsZXMsIHJlYWR5LCB0b3RhbCB9ID0gdGhpcy5kYXRhO1xuICAgICAgICAgICAgb25DaGFuZ2Uoe1xuICAgICAgICAgICAgICAgIGZpbGVzOiBmaWxlcy5tYXA8VXBsb2FkRmlsZVN0YXR1cz4oZmlsZSA9PiAoe1xuICAgICAgICAgICAgICAgICAgICBkYXRhOiBmaWxlLmRhdGEsXG4gICAgICAgICAgICAgICAgICAgIGlkOiBmaWxlLmlkLFxuICAgICAgICAgICAgICAgICAgICBuYW1lOiBmaWxlLm5hbWUsXG4gICAgICAgICAgICAgICAgICAgIHByb2dyZXNzOiBmaWxlLnByb2dyZXNzLFxuICAgICAgICAgICAgICAgICAgICBzdGF0ZTogZmlsZS5zdGF0dXMsXG4gICAgICAgICAgICAgICAgICAgIHR5cGU6IGZpbGUudHlwZSxcbiAgICAgICAgICAgICAgICB9KSksXG4gICAgICAgICAgICAgICAgcmVhZHksXG4gICAgICAgICAgICAgICAgdG90YWwsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH07XG4gICAgcHJpdmF0ZSBmaWxlc0FkZGVkID0gKGU6IERyb3B6b25lQ2hhbmdlRXZlbnQpID0+IHtcbiAgICAgICAgdGhpcy5kYXRhLnB1c2goZS52YWx1ZSk7XG4gICAgfTtcbiAgICBwcml2YXRlIGZpbGVTZWxlY3QgPSAoZTogRHJvcHpvbmVPcGVuRXZlbnQpID0+IHtcbiAgICAgICAgY29uc3QgeyBtdWx0aXBsZSB9ID0gdGhpcy5wcm9wcztcbiAgICAgICAgY29uc3QgeyBmaWxlcywgZXZlbnRzIH0gPSB0aGlzLmRhdGE7XG4gICAgICAgIGNvbnN0IG5vdENhbmNlbGVkRmlsZXMgPSBmaWxlcy5maWx0ZXIoZmlsZSA9PiBmaWxlLnN0YXR1cyAhPT0gJ2NhbmNlbGVkJyk7XG4gICAgICAgIGlmICghbXVsdGlwbGUgJiYgbm90Q2FuY2VsZWRGaWxlcy5sZW5ndGggPT09IDEpIHtcbiAgICAgICAgICAgIGNvbnN0IGNvbXBsZXRlZEZpbGVzID0gbm90Q2FuY2VsZWRGaWxlcy5maWx0ZXIoZmlsZSA9PiBmaWxlLnN0YXR1cyA9PT0gJ2NvbXBsZXRlJyk7XG4gICAgICAgICAgICBpZiAoY29tcGxldGVkRmlsZXMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgICAgIGV2ZW50cy5lbWl0KEZpbGVVcGxvYWRBY3Rpb25zLnNob3dVcGxvYWRzLCB7fSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9O1xuICAgIHJlbmRlcigpIHtcbiAgICAgICAgY29uc3QgeyBtdWx0aXBsZSwgbWVzc2FnZSwgY2hpbGRyZW4sIHNob3dGaWxlTGlzdCB9ID0gdGhpcy5wcm9wcztcbiAgICAgICAgY29uc3QgYWRkaXRpb25hbFByb3BzID0gIXNob3dGaWxlTGlzdCA/IHsgdmFsdWU6IFtdIH0gOiB7fTtcbiAgICAgICAgcmV0dXJuICg8RHJvcHpvbmUgbXVsdGlwbGU9e211bHRpcGxlfSBvbkNoYW5nZT17dGhpcy5maWxlc0FkZGVkfSBvbk9wZW49e3RoaXMuZmlsZVNlbGVjdH0gbWVzc2FnZT17bWVzc2FnZX0gey4uLmFkZGl0aW9uYWxQcm9wc30+XG4gICAgICAgIHtjaGlsZHJlbn1cbiAgICAgIDwvRHJvcHpvbmU+KTtcbiAgICB9XG4gICAgc3RhdGljIGlubmVyID0ge1xuICAgICAgICBnZXQgRHJvcHpvbmUoKSB7IHJldHVybiBEcm9wem9uZSBhcyB0eXBlb2YgRHJvcHpvbmU7IH1cbiAgICB9O1xufVxuIl19