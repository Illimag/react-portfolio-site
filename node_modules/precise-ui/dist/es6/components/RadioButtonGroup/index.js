import * as React from 'react';
import { withFormContext } from '../../hoc/withFormContext';
import { RadioButtonGroupContext, } from '../../contexts/RadioButtonGroupContext';
class RadioButtonGroupInt extends React.PureComponent {
    constructor(props) {
        super(props);
        this.buttons = [];
        this.ctx = this.createContext();
        this.getNextValue = (groupItemName) => {
            const { multiple } = this.props;
            const { value } = this.state;
            if (value && Array.isArray(value) && groupItemName) {
                if (value.indexOf(groupItemName) !== -1) {
                    return value.filter(f => f !== groupItemName);
                }
                return [...value, groupItemName];
            }
            return multiple && groupItemName ? [groupItemName] : groupItemName;
        };
        const controlled = props.value !== undefined;
        const { value: propValue, defaultValue } = props;
        const value = controlled ? propValue : defaultValue;
        this.state = {
            controlled,
            value,
        };
    }
    setState(state) {
        const value = state.value;
        if (value) {
            for (const button of this.buttons) {
                const selected = Array.isArray(value) && button.name ? value.indexOf(button.name) !== -1 : button.name === value;
                button.setValue(selected);
            }
            super.setState(Object.assign({}, state, { value }));
        }
        super.setState(state);
    }
    componentDidMount() {
        const { form } = this.props;
        const { controlled } = this.state;
        if (!controlled && form) {
            form.subscribe(this);
        }
    }
    componentWillUnmount() {
        const { form } = this.props;
        const { controlled } = this.state;
        if (!controlled && form) {
            form.unsubscribe(this);
        }
    }
    UNSAFE_componentWillReceiveProps({ value }) {
        const { controlled } = this.state;
        if (controlled) {
            this.setState({
                value,
            });
        }
    }
    createContext() {
        return {
            select: (rb) => {
                const { onChange, form, name = '' } = this.props;
                const { controlled } = this.state;
                const value = this.getNextValue(rb.name);
                if (!controlled) {
                    if (form) {
                        form.change({
                            name,
                            value,
                        });
                    }
                    else if (value) {
                        this.setState({
                            value,
                        });
                    }
                    else {
                        for (const button of this.buttons) {
                            button.setValue(button === rb);
                        }
                        super.setState({
                            value: undefined,
                        });
                    }
                }
                if (typeof onChange === 'function' && value) {
                    onChange({
                        value,
                    });
                }
            },
            subscribe: (rb) => {
                const { value } = this.state;
                this.buttons.push(rb);
                if (value !== undefined) {
                    const selected = Array.isArray(value) && rb.name ? value.indexOf(rb.name) !== -1 : rb.name === value;
                    rb.setValue(selected);
                }
            },
            unsubscribe: (rb) => {
                const index = this.buttons.indexOf(rb);
                index >= 0 && this.buttons.splice(index, 1);
            },
        };
    }
    render() {
        return React.createElement(RadioButtonGroupContext.Provider, { value: this.ctx }, this.props.children);
    }
}
/**
 * The radio button group manages a group of radio buttons.
 */
export const RadioButtonGroup = withFormContext(RadioButtonGroupInt);
RadioButtonGroup.displayName = 'RadioButtonGroup';
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvY29tcG9uZW50cy9SYWRpb0J1dHRvbkdyb3VwL2luZGV4LnRzeCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEtBQUssS0FBSyxNQUFNLE9BQU8sQ0FBQztBQUUvQixPQUFPLEVBQW9CLGVBQWUsRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBQzlFLE9BQU8sRUFBRSx1QkFBdUIsR0FBMEQsTUFBTSx3Q0FBd0MsQ0FBQztBQWN6SSxNQUFNLG1CQUFvQixTQUFRLEtBQUssQ0FBQyxhQUE4RTtJQUdsSCxZQUFZLEtBQTRCO1FBQ3BDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUhBLFlBQU8sR0FBb0MsRUFBRSxDQUFDO1FBQzlDLFFBQUcsR0FBZ0MsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO1FBNENqRSxpQkFBWSxHQUFHLENBQUMsYUFBc0IsRUFBRSxFQUFFO1lBQzlDLE1BQU0sRUFBRSxRQUFRLEVBQUUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDO1lBQ2hDLE1BQU0sRUFBRSxLQUFLLEVBQUUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDO1lBQzdCLElBQUksS0FBSyxJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLElBQUksYUFBYSxFQUFFO2dCQUNoRCxJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUU7b0JBQ3JDLE9BQU8sS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsS0FBSyxhQUFhLENBQUMsQ0FBQztpQkFDakQ7Z0JBQ0QsT0FBTyxDQUFDLEdBQUcsS0FBSyxFQUFFLGFBQWEsQ0FBQyxDQUFDO2FBQ3BDO1lBQ0QsT0FBTyxRQUFRLElBQUksYUFBYSxDQUFDLENBQUMsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxhQUFhLENB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Q04sQ0FBQztJQUNELE1BQU07UUFDRixPQUFPLG9CQUFDLHVCQUF1QixDQUFDLFFBQVEsSUFBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLEdBQUcsSUFBRyxJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBb0MsQ0FBQztJQUN2SCxDQUFDO0NBQ0o7QUFDRDs7R0FFRztBQUNILE1BQU0sQ0FBQyxNQUFNLGdCQUFnQixHQUFHLGVBQWUsQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO0FBQ3JFLGdCQUFnQixDQUFDLFdBQVcsR0FBRyxrQkFBa0IsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIFJlYWN0IGZyb20gJ3JlYWN0JztcbmltcG9ydCB7IElucHV0UHJvcHMsIElucHV0Q2hhbmdlRXZlbnQgfSBmcm9tICcuLi8uLi9jb21tb24nO1xuaW1wb3J0IHsgRm9ybUNvbnRleHRQcm9wcywgd2l0aEZvcm1Db250ZXh0IH0gZnJvbSAnLi4vLi4vaG9jL3dpdGhGb3JtQ29udGV4dCc7XG5pbXBvcnQgeyBSYWRpb0J1dHRvbkdyb3VwQ29udGV4dCwgUmFkaW9CdXR0b25Hcm91cENvbnRleHRUeXBlLCBSYWRpb0J1dHRvbkdyb3VwTm90aWZpZXIsIH0gZnJvbSAnLi4vLi4vY29udGV4dHMvUmFkaW9CdXR0b25Hcm91cENvbnRleHQnO1xuZXhwb3J0IHR5cGUgUmFkaW9CdXR0b25Hcm91cENoYW5nZUV2ZW50ID0gSW5wdXRDaGFuZ2VFdmVudDxzdHJpbmc+O1xuZXhwb3J0IGludGVyZmFjZSBSYWRpb0J1dHRvbkdyb3VwUHJvcHMgZXh0ZW5kcyBJbnB1dFByb3BzPHN0cmluZyB8IEFycmF5PHN0cmluZz4+IHtcbiAgICAvKipcbiAgICAgKiBTZXRzIHRoZSBncm91cCdzIGNoaWxkcmVuLlxuICAgICAqL1xuICAgIGNoaWxkcmVuPzogUmVhY3QuUmVhY3ROb2RlO1xuICAgIG11bHRpcGxlPzogYm9vbGVhbjtcbn1cbmV4cG9ydCB0eXBlIFN0YXRlVmFsdWUgPSBBcnJheTxzdHJpbmc+IHwgc3RyaW5nIHwgdW5kZWZpbmVkO1xuZXhwb3J0IGludGVyZmFjZSBSYWRpb0J1dHRvbkdyb3VwU3RhdGUge1xuICAgIGNvbnRyb2xsZWQ6IGJvb2xlYW47XG4gICAgdmFsdWU6IFN0YXRlVmFsdWU7XG59XG5jbGFzcyBSYWRpb0J1dHRvbkdyb3VwSW50IGV4dGVuZHMgUmVhY3QuUHVyZUNvbXBvbmVudDxSYWRpb0J1dHRvbkdyb3VwUHJvcHMgJiBGb3JtQ29udGV4dFByb3BzLCBSYWRpb0J1dHRvbkdyb3VwU3RhdGU+IHtcbiAgICBwcml2YXRlIHJlYWRvbmx5IGJ1dHRvbnM6IEFycmF5PFJhZGlvQnV0dG9uR3JvdXBOb3RpZmllcj4gPSBbXTtcbiAgICBwcml2YXRlIHJlYWRvbmx5IGN0eDogUmFkaW9CdXR0b25Hcm91cENvbnRleHRUeXBlID0gdGhpcy5jcmVhdGVDb250ZXh0KCk7XG4gICAgY29uc3RydWN0b3IocHJvcHM6IFJhZGlvQnV0dG9uR3JvdXBQcm9wcykge1xuICAgICAgICBzdXBlcihwcm9wcyk7XG4gICAgICAgIGNvbnN0IGNvbnRyb2xsZWQgPSBwcm9wcy52YWx1ZSAhPT0gdW5kZWZpbmVkO1xuICAgICAgICBjb25zdCB7IHZhbHVlOiBwcm9wVmFsdWUsIGRlZmF1bHRWYWx1ZSB9ID0gcHJvcHM7XG4gICAgICAgIGNvbnN0IHZhbHVlID0gY29udHJvbGxlZCA/IHByb3BWYWx1ZSA6IGRlZmF1bHRWYWx1ZTtcbiAgICAgICAgdGhpcy5zdGF0ZSA9IHtcbiAgICAgICAgICAgIGNvbnRyb2xsZWQsXG4gICAgICAgICAgICB2YWx1ZSxcbiAgICAgICAgfTtcbiAgICB9XG4gICAgc2V0U3RhdGU8SyBleHRlbmRzIGtleW9mIFJhZGlvQnV0dG9uR3JvdXBTdGF0ZT4oc3RhdGU6IFBpY2s8UmFkaW9CdXR0b25Hcm91cFN0YXRlLCBLPikge1xuICAgICAgICBjb25zdCB2YWx1ZSA9IChzdGF0ZSBhcyBQaWNrPFJhZGlvQnV0dG9uR3JvdXBTdGF0ZSwgJ3ZhbHVlJz4pLnZhbHVlO1xuICAgICAgICBpZiAodmFsdWUpIHtcbiAgICAgICAgICAgIGZvciAoY29uc3QgYnV0dG9uIG9mIHRoaXMuYnV0dG9ucykge1xuICAgICAgICAgICAgICAgIGNvbnN0IHNlbGVjdGVkID0gQXJyYXkuaXNBcnJheSh2YWx1ZSkgJiYgYnV0dG9uLm5hbWUgPyB2YWx1ZS5pbmRleE9mKGJ1dHRvbi5uYW1lKSAhPT0gLTEgOiBidXR0b24ubmFtZSA9PT0gdmFsdWU7XG4gICAgICAgICAgICAgICAgYnV0dG9uLnNldFZhbHVlKHNlbGVjdGVkKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHN1cGVyLnNldFN0YXRlKHsgLi4uc3RhdGUsIHZhbHVlIH0pO1xuICAgICAgICB9XG4gICAgICAgIHN1cGVyLnNldFN0YXRlKHN0YXRlKTtcbiAgICB9XG4gICAgY29tcG9uZW50RGlkTW91bnQoKSB7XG4gICAgICAgIGNvbnN0IHsgZm9ybSB9ID0gdGhpcy5wcm9wcztcbiAgICAgICAgY29uc3QgeyBjb250cm9sbGVkIH0gPSB0aGlzLnN0YXRlO1xuICAgICAgICBpZiAoIWNvbnRyb2xsZWQgJiYgZm9ybSkge1xuICAgICAgICAgICAgZm9ybS5zdWJzY3JpYmUodGhpcyk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgY29tcG9uZW50V2lsbFVubW91bnQoKSB7XG4gICAgICAgIGNvbnN0IHsgZm9ybSB9ID0gdGhpcy5wcm9wcztcbiAgICAgICAgY29uc3QgeyBjb250cm9sbGVkIH0gPSB0aGlzLnN0YXRlO1xuICAgICAgICBpZiAoIWNvbnRyb2xsZWQgJiYgZm9ybSkge1xuICAgICAgICAgICAgZm9ybS51bnN1YnNjcmliZSh0aGlzKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBVTlNBRkVfY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyh7IHZhbHVlIH06IFJhZGlvQnV0dG9uR3JvdXBQcm9wcykge1xuICAgICAgICBjb25zdCB7IGNvbnRyb2xsZWQgfSA9IHRoaXMuc3RhdGU7XG4gICAgICAgIGlmIChjb250cm9sbGVkKSB7XG4gICAgICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICAgICAgICB2YWx1ZSxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfVxuICAgIHByaXZhdGUgZ2V0TmV4dFZhbHVlID0gKGdyb3VwSXRlbU5hbWU/OiBzdHJpbmcpID0+IHtcbiAgICAgICAgY29uc3QgeyBtdWx0aXBsZSB9ID0gdGhpcy5wcm9wcztcbiAgICAgICAgY29uc3QgeyB2YWx1ZSB9ID0gdGhpcy5zdGF0ZTtcbiAgICAgICAgaWYgKHZhbHVlICYmIEFycmF5LmlzQXJyYXkodmFsdWUpICYmIGdyb3VwSXRlbU5hbWUpIHtcbiAgICAgICAgICAgIGlmICh2YWx1ZS5pbmRleE9mKGdyb3VwSXRlbU5hbWUpICE9PSAtMSkge1xuICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZS5maWx0ZXIoZiA9PiBmICE9PSBncm91cEl0ZW1OYW1lKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBbLi4udmFsdWUsIGdyb3VwSXRlbU5hbWVdO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBtdWx0aXBsZSAmJiBncm91cEl0ZW1OYW1lID8gW2dyb3VwSXRlbU5hbWVdIDogZ3JvdXBJdGVtTmFtZTtcbiAgICB9O1xuICAgIHByaXZhdGUgY3JlYXRlQ29udGV4dCgpOiBSYWRpb0J1dHRvbkdyb3VwQ29udGV4dFR5cGUge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgc2VsZWN0OiAocmI6IFJhZGlvQnV0dG9uR3JvdXBOb3RpZmllcikgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IHsgb25DaGFuZ2UsIGZvcm0sIG5hbWUgPSAnJyB9ID0gdGhpcy5wcm9wcztcbiAgICAgICAgICAgICAgICBjb25zdCB7IGNvbnRyb2xsZWQgfSA9IHRoaXMuc3RhdGU7XG4gICAgICAgICAgICAgICAgY29uc3QgdmFsdWUgPSB0aGlzLmdldE5leHRWYWx1ZShyYi5uYW1lKTtcbiAgICAgICAgICAgICAgICBpZiAoIWNvbnRyb2xsZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGZvcm0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvcm0uY2hhbmdlKHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlLFxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAodmFsdWUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlLFxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IGJ1dHRvbiBvZiB0aGlzLmJ1dHRvbnMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBidXR0b24uc2V0VmFsdWUoYnV0dG9uID09PSByYik7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBzdXBlci5zZXRTdGF0ZSh7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IHVuZGVmaW5lZCxcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygb25DaGFuZ2UgPT09ICdmdW5jdGlvbicgJiYgdmFsdWUpIHtcbiAgICAgICAgICAgICAgICAgICAgb25DaGFuZ2Uoe1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUsXG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBzdWJzY3JpYmU6IChyYjogUmFkaW9CdXR0b25Hcm91cE5vdGlmaWVyKSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgeyB2YWx1ZSB9ID0gdGhpcy5zdGF0ZTtcbiAgICAgICAgICAgICAgICB0aGlzLmJ1dHRvbnMucHVzaChyYik7XG4gICAgICAgICAgICAgICAgaWYgKHZhbHVlICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2VsZWN0ZWQgPSBBcnJheS5pc0FycmF5KHZhbHVlKSAmJiByYi5uYW1lID8gdmFsdWUuaW5kZXhPZihyYi5uYW1lKSAhPT0gLTEgOiByYi5uYW1lID09PSB2YWx1ZTtcbiAgICAgICAgICAgICAgICAgICAgcmIuc2V0VmFsdWUoc2VsZWN0ZWQpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB1bnN1YnNjcmliZTogKHJiOiBSYWRpb0J1dHRvbkdyb3VwTm90aWZpZXIpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBpbmRleCA9IHRoaXMuYnV0dG9ucy5pbmRleE9mKHJiKTtcbiAgICAgICAgICAgICAgICBpbmRleCA+PSAwICYmIHRoaXMuYnV0dG9ucy5zcGxpY2UoaW5kZXgsIDEpO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgfTtcbiAgICB9XG4gICAgcmVuZGVyKCkge1xuICAgICAgICByZXR1cm4gPFJhZGlvQnV0dG9uR3JvdXBDb250ZXh0LlByb3ZpZGVyIHZhbHVlPXt0aGlzLmN0eH0+e3RoaXMucHJvcHMuY2hpbGRyZW59PC9SYWRpb0J1dHRvbkdyb3VwQ29udGV4dC5Qcm92aWRlcj47XG4gICAgfVxufVxuLyoqXG4gKiBUaGUgcmFkaW8gYnV0dG9uIGdyb3VwIG1hbmFnZXMgYSBncm91cCBvZiByYWRpbyBidXR0b25zLlxuICovXG5leHBvcnQgY29uc3QgUmFkaW9CdXR0b25Hcm91cCA9IHdpdGhGb3JtQ29udGV4dChSYWRpb0J1dHRvbkdyb3VwSW50KTtcblJhZGlvQnV0dG9uR3JvdXAuZGlzcGxheU5hbWUgPSAnUmFkaW9CdXR0b25Hcm91cCc7XG4iXX0=