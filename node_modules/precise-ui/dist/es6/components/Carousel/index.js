var __rest = (this && this.__rest) || function (s, e) {
    var t = {};
    for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)
        t[p] = s[p];
    if (s != null && typeof Object.getOwnPropertySymbols === "function")
        for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) if (e.indexOf(p[i]) < 0)
            t[p[i]] = s[p[i]];
    return t;
};
import * as React from 'react';
import styled, { css } from '../../utils/styled';
import { remCalc } from '../../utils/remCalc';
import { InteractiveSurface } from '../InteractiveSurface';
import { Icon } from '../Icon';
import { distance } from '../../distance';
import { getFontStyle } from '../../textStyles';
const shiftThreshold = 0.3;
const animationDuration = '0.3s';
const animationFunction = 'ease-in-out';
const RootContainer = styled.div `
  outline: none;
`;
const DefaultBulletsContainer = styled.div `
  box-sizing: border-box;
  display: flex;
  justify-content: center;
`;
const ActiveBullet = css `
  background-color: rgba(116, 118, 120, 1);
`;
const DefaultBullet = styled.div `
  height: ${remCalc('12px')};
  width: ${remCalc('12px')};
  background-color: rgba(224, 225, 221, 1);
  border-radius: 50%;
  display: inline-block;
  cursor: pointer;
  margin: ${distance.xsmall};
  ${props => (props.active ? ActiveBullet : '')};
`;
const PageItem = styled.div `
  min-width: 100%;
`;
const PagesContainer = styled.div `
  box-sizing: border-box;
  display: flex;
  position: relative;
  left: ${props => -props.selectedIndex * 100}%;
  transition: left ${animationDuration} ${animationFunction};
`;
const Mask = styled.div `
  position: relative;
  box-sizing: border-box;
  overflow: hidden;
`;
const Arrow = styled.button `
  ${getFontStyle({ size: 'medium' })}

  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  background-color: transparent;
  padding: 0;
  border: none;
  align-self: start;
  cursor: pointer;
  > i {
    vertical-align: middle;
  }
`;
const ArrowLeft = styled(Arrow) `
  left: 8px;
`;
const ArrowRight = styled(Arrow) `
  right: 8px;
`;
function calcNextPage(currentPage, totalPages, infinite = false) {
    const maxIndex = totalPages - 1;
    const nextPage = currentPage + 1;
    return infinite && nextPage > maxIndex ? 0 : Math.min(nextPage, maxIndex);
}
function calcPrevPage(currentPage, totalPages, infinite = false) {
    const prevPage = currentPage - 1;
    const maxIndex = totalPages - 1;
    return infinite && prevPage < 0 ? maxIndex : Math.max(prevPage, 0);
}
function calcLeftShiftPercent(selectedIndex) {
    return selectedIndex * -100;
}
const defaultAutoPlayTime = 3000;
/**
 * The Carousel component displays a toggling list of content. Page can be changed using bullet
 * controls or swiping gestures.
 */
export class Carousel extends React.PureComponent {
    constructor(props) {
        super(props);
        this.selects = [];
        this.resume = () => {
            if (!this.autoPlayTimeout) {
                this.tryToPlay();
            }
        };
        this.dragTile = (e) => {
            const { controlled, selectedIndex, dragStatus } = this.state;
            const shift = dragStatus.start ? e.x - dragStatus.start.x : 0;
            if (controlled) {
                e.release();
            }
            if (this.pagesContainer) {
                if (e.active) {
                    if (!dragStatus.isDragging) {
                        this.setState({ dragStatus: { isDragging: true, start: { x: e.x, y: e.y } } });
                        this.setDragStyle(this.pagesContainer);
                    }
                    this.pagesContainer.style.left = `${calcLeftShiftPercent(selectedIndex) + shift * 100}%`;
                }
                else {
                    this.setState({ dragStatus: { isDragging: false, start: undefined } });
                    this.resetInitialStyle(this.pagesContainer);
                    this.checkPageChange(shift);
                }
            }
        };
        this.swipeLeft = () => {
            this.swipe(-1, true);
        };
        this.swipeRight = () => {
            this.swipe(1, true);
        };
        this.swipeRightAuto = () => {
            this.swipe(1, false);
        };
        this.handleKeyDown = (e) => {
            const { children, infinite } = this.props;
            const { selectedIndex } = this.state;
            const childrenCount = React.Children.count(children);
            let nextIndex = selectedIndex;
            switch (e.keyCode) {
                case 37 /* left */:
                    nextIndex = calcPrevPage(selectedIndex, childrenCount, infinite);
                    break;
                case 39 /* right */:
                    nextIndex = calcNextPage(selectedIndex, childrenCount, infinite);
                    break;
                case 35 /* end */:
                    nextIndex = childrenCount - 1;
                    break;
                case 36 /* home */:
                    nextIndex = 0;
                    break;
                default:
                    return;
            }
            this.changePage(nextIndex);
        };
        this.state = {
            selectedIndex: props.selectedIndex || props.defaultIndex || 0,
            controlled: props.selectedIndex !== undefined,
            dragStatus: { isDragging: false },
        };
    }
    UNSAFE_componentWillReceiveProps(nextProps) {
        const { selectedIndex } = nextProps;
        const { controlled } = this.state;
        if (controlled && typeof selectedIndex === 'number') {
            this.setState({
                selectedIndex,
            });
        }
    }
    componentDidMount() {
        this.tryToPlay();
    }
    componentWillUnmount() {
        this.stop();
    }
    tryToPlay() {
        this.stop();
        const { autoplay } = this.props;
        if (autoplay) {
            this.play(typeof autoplay === 'number' ? autoplay : defaultAutoPlayTime);
        }
    }
    play(time) {
        this.autoPlayTimeout = setInterval(this.swipeRightAuto, time);
    }
    stop() {
        this.autoPlayTimeout = clearInterval(this.autoPlayTimeout);
    }
    changePage(target, manual = true) {
        const { onPageChange, onStop, children } = this.props;
        const childrenCount = React.Children.count(children);
        const { controlled, selectedIndex } = this.state;
        const shouldStop = target >= childrenCount || target < 0;
        if (manual || shouldStop) {
            if (this.autoPlayTimeout) {
                this.stop();
                if (typeof onStop === 'function') {
                    onStop({
                        reason: manual ? 'manual' : 'ended',
                        resume: this.resume,
                    });
                }
            }
        }
        if (!shouldStop) {
            if (typeof onPageChange === 'function') {
                onPageChange({
                    previousIndex: selectedIndex,
                    selectedIndex: target,
                });
            }
            if (!controlled) {
                this.setState(() => ({
                    selectedIndex: target,
                }));
            }
        }
    }
    checkPageChange(shift) {
        const { selectedIndex } = this.state;
        if (shift <= -shiftThreshold) {
            const nextIndex = calcNextPage(selectedIndex, React.Children.count(this.props.children), this.props.infinite);
            this.changePage(nextIndex);
        }
        else if (shift >= shiftThreshold) {
            const prevIndex = calcPrevPage(selectedIndex, React.Children.count(this.props.children), this.props.infinite);
            this.changePage(prevIndex);
        }
    }
    setDragStyle(node) {
        const style = node.style;
        style.transitionProperty = 'unset';
        style.transitionDuration = 'unset';
        style.transitionTimingFunction = 'unset';
    }
    resetInitialStyle(node) {
        const style = node.style;
        // tslint:disable-next-line
        style.left = null;
        style.transitionProperty = 'left';
        style.transitionDuration = animationDuration;
        style.transitionTimingFunction = animationFunction;
    }
    swipe(direction, manual) {
        const { selectedIndex } = this.state;
        const { children, infinite } = this.props;
        const childrenCount = React.Children.count(children);
        let nextIndex = selectedIndex;
        if (direction === 1) {
            nextIndex = calcNextPage(selectedIndex, childrenCount, infinite);
        }
        else if (direction === -1) {
            nextIndex = calcPrevPage(selectedIndex, childrenCount, infinite);
        }
        this.changePage(nextIndex, manual);
    }
    render() {
        const { selectedIndex } = this.state;
        const _a = this.props, { children, theme, selectedIndex: _0, defaultIndex: _1, onPageChange: _2, bulletsContainer: CustomBulletsContainer, bullet: CustomBullet, arrows = false, infinite = false, opaque = false } = _a, props = __rest(_a, ["children", "theme", "selectedIndex", "defaultIndex", "onPageChange", "bulletsContainer", "bullet", "arrows", "infinite", "opaque"]);
        const childrenCount = React.Children.count(children);
        const bullets = [];
        const items = [];
        const selects = this.selects;
        const BulletsContainer = CustomBulletsContainer || DefaultBulletsContainer;
        const Bullet = CustomBullet || DefaultBullet;
        React.Children.forEach(children, (element, index) => {
            if (element && React.isValidElement(element)) {
                const active = index === selectedIndex;
                if (selects[index] === undefined) {
                    selects[index] = () => this.changePage(index);
                }
                bullets.push(React.createElement(Bullet, { theme: theme, key: `bullet-${index}`, active: active, index: index, onClick: selects[index] }));
                items.push(React.createElement(PageItem, { key: `item-${index}` }, element));
            }
        });
        const disableLeft = !infinite && selectedIndex < 1;
        const disableRight = !infinite && selectedIndex > childrenCount - 2;
        return (React.createElement(RootContainer, Object.assign({}, props, { onKeyDown: this.handleKeyDown, tabIndex: 0 }),
            React.createElement(Mask, null,
                React.createElement(InteractiveSurface, { theme: theme, onChange: this.dragTile, opaque: opaque },
                    React.createElement(PagesContainer, { ref: node => (this.pagesContainer = node), selectedIndex: selectedIndex }, items)),
                arrows && (React.createElement("div", null,
                    React.createElement(ArrowLeft, { onClick: this.swipeLeft, disabled: disableLeft, type: "button" },
                        React.createElement(Icon, { name: "KeyboardArrowLeft", size: 2 })),
                    React.createElement(ArrowRight, { onClick: this.swipeRight, disabled: disableRight, type: "button" },
                        React.createElement(Icon, { name: "KeyboardArrowRight", size: 2 }))))),
            React.createElement(BulletsContainer, null, bullets)));
    }
}
Carousel.inner = {
    get PageItem() { return PageItem; },
    get RootContainer() { return RootContainer; },
    get Mask() { return Mask; },
    get InteractiveSurface() { return InteractiveSurface; },
    get PagesContainer() { return PagesContainer; },
    get ArrowLeft() { return ArrowLeft; },
    get Icon() { return Icon; },
    get ArrowRight() { return ArrowRight; }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvY29tcG9uZW50cy9DYXJvdXNlbC9pbmRleC50c3giXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBQUEsT0FBTyxLQUFLLEtBQUssTUFBTSxPQUFPLENBQUM7QUFDL0IsT0FBTyxNQUFNLEVBQUUsRUFBRSxHQUFHLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUVqRCxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDOUMsT0FBTyxFQUFFLGtCQUFrQixFQUEwRCxNQUFNLHVCQUF1QixDQUFDO0FBQ25ILE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFFL0IsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzFDLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQThGaEQsTUFBTSxjQUFjLEdBQUcsR0FBRyxDQUFDO0FBQzNCLE1BQU0saUJBQWlCLEdBQUcsTUFBTSxDQUFDO0FBQ2pDLE1BQU0saUJBQWlCLEdBQUcsYUFBYSxDQUFDO0FBQ3hDLE1BQU0sYUFBYSxHQUFHLE1BQU0sQ0FBQyxHQUFHLENBQUM7O0NBRWhDLENBQUM7QUFDRixNQUFNLHVCQUF1QixHQUFHLE1BQU0sQ0FBQyxHQUFHLENBQUM7Ozs7Q0FJMUMsQ0FBQztBQWVGLE1BQU0sWUFBWSxHQUFHLEdBQUcsQ0FBQzs7Q0FFeEIsQ0FBQztBQUNGLE1BQU0sYUFBYSxHQUFHLE1BQU0sQ0FBQyxHQUFHLENBQWM7WUFDbEMsT0FBTyxDQUFDLE1BQU0sQ0FBQztXQUNoQixPQUFPLENBQUMsTUFBTSxDQUFDOzs7OztZQUtkLFFBQVEsQ0FBQyxNQUFNO0lBQ3ZCLEtBQUssQ0FBQyxFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQztD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QUFRLEVBQUUsV0FBVyxFQUFFLElBQUksRUFBQyxRQUFRO3dCQUN0RSxvQkFBQyxJQUFJLElBQUMsSUFBSSxFQUFDLG1CQUFtQixFQUFDLElBQUksRUFBRSxDQUFDLEdBQUcsQ0FDL0I7b0JBQ1osb0JBQUMsVUFBVSxJQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsVUFBVSxFQUFFLFFBQVEsRUFBRSxZQUFZLEVBQUUsSUFBSSxFQUFDLFFBQVE7d0JBQ3pFLG9CQUFDLElBQUksSUFBQyxJQUFJLEVBQUMsb0JBQW9CLEVBQUMsSUFBSSxFQUFFLENBQUMsR0FBRyxDQUMvQixDQUNULENBQUMsQ0FDSjtZQUNQLG9CQUFDLGdCQUFnQixRQUFFLE9BQU8sQ0FBb0IsQ0FDaEMsQ0FBQyxDQUFDO0lBQ3BCLENBQUM7O0FBQ00sY0FBSyxHQUFHO0lBQ1gsSUFBSSxRQUFRLEtBQUssT0FBTyxRQUEyQixDQUFDLENBQUMsQ0FBQztJQUN0RCxJQUFJLGFBQWEsS0FBSyxPQUFPLGFBQXFDLENBQUMsQ0FBQyxDQUFDO0lBQ3JFLElBQUksSUFBSSxLQUFLLE9BQU8sSUFBbUIsQ0FBQyxDQUFDLENBQUM7SUFDMUMsSUFBSSxrQkFBa0IsS0FBSyxPQUFPLGtCQUErQyxDQUFDLENBQUMsQ0FBQztJQUNwRixJQUFJLGNBQWMsS0FBSyxPQUFPLGNBQXVDLENBQUMsQ0FBQyxDQUFDO0lBQ3hFLElBQUksU0FBUyxLQUFLLE9BQU8sU0FBNkIsQ0FBQyxDQUFDLENBQUM7SUFDekQsSUFBSSxJQUFJLEtBQUssT0FBTyxJQUFtQixDQUFDLENBQUMsQ0FBQztJQUMxQyxJQUFJLFVBQVUsS0FBSyxPQUFPLFVBQStCLENBQUMsQ0FBQyxDQUFDO0NBQy9ELENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBSZWFjdCBmcm9tICdyZWFjdCc7XG5pbXBvcnQgc3R5bGVkLCB7IGNzcyB9IGZyb20gJy4uLy4uL3V0aWxzL3N0eWxlZCc7XG5pbXBvcnQgeyBLZXlDb2RlcyB9IGZyb20gJy4uLy4uL3V0aWxzL2tleUNvZGVzJztcbmltcG9ydCB7IHJlbUNhbGMgfSBmcm9tICcuLi8uLi91dGlscy9yZW1DYWxjJztcbmltcG9ydCB7IEludGVyYWN0aXZlU3VyZmFjZSwgSW50ZXJhY3RpdmVTdXJmYWNlQ2hhbmdlRXZlbnQsIEludGVyYWN0aXZlU3VyZmFjZVByb3BzIH0gZnJvbSAnLi4vSW50ZXJhY3RpdmVTdXJmYWNlJztcbmltcG9ydCB7IEljb24gfSBmcm9tICcuLi9JY29uJztcbmltcG9ydCB7IFN0YW5kYXJkUHJvcHMgfSBmcm9tICcuLi8uLi9jb21tb24nO1xuaW1wb3J0IHsgZGlzdGFuY2UgfSBmcm9tICcuLi8uLi9kaXN0YW5jZSc7XG5pbXBvcnQgeyBnZXRGb250U3R5bGUgfSBmcm9tICcuLi8uLi90ZXh0U3R5bGVzJztcbmV4cG9ydCBpbnRlcmZhY2UgQ2Fyb3VzZWxDaGFuZ2VFdmVudCB7XG4gICAgLyoqXG4gICAgICogVGhlIHByZXZpb3VzbHkgc2VsZWN0ZWQgcGFnZSBpbmRleC5cbiAgICAgKi9cbiAgICBwcmV2aW91c0luZGV4OiBudW1iZXI7XG4gICAgLyoqXG4gICAgICogVGhlIGN1cnJlbnRseSBzZWxlY3RlZCBwYWdlIGluZGV4LlxuICAgICAqL1xuICAgIHNlbGVjdGVkSW5kZXg6IG51bWJlcjtcbn1cbmV4cG9ydCBpbnRlcmZhY2UgQ2Fyb3VzZWxTdG9wRXZlbnQge1xuICAgIC8qKlxuICAgICAqIFRoZSByZWFzb24gZm9yIHN0b3BwaW5nIHRoZSBhdXRvcGxheSBtb2RlLlxuICAgICAqL1xuICAgIHJlYXNvbjogJ2VuZGVkJyB8ICdtYW51YWwnO1xuICAgIC8qKlxuICAgICAqIFJlc3VtZXMgZXhlY3V0aW9uIG9mIHRoZSBhdXRvcGxheSBtb2RlLlxuICAgICAqL1xuICAgIHJlc3VtZSgpOiB2b2lkO1xufVxuZXhwb3J0IGludGVyZmFjZSBDYXJvdXNlbFByb3BzIGV4dGVuZHMgU3RhbmRhcmRQcm9wcyB7XG4gICAgLyoqXG4gICAgICogVGhlIGRlZmF1bHQgcGFnZSBpbmRleCAtIG9ubHkgc2V0IGZvciB1c2UgaW4gYXV0b21hdGljIG1vZGUuXG4gICAgICovXG4gICAgZGVmYXVsdEluZGV4PzogbnVtYmVyO1xuICAgIC8qKlxuICAgICAqIFRoZSBjdXJyZW50bHkgc2VsZWN0ZWQgcGFnZSBpbmRleCAtIHVzZWQgaW4gdGhlIGNvbnRyb2xsZWQgbW9kZS5cbiAgICAgKi9cbiAgICBzZWxlY3RlZEluZGV4PzogbnVtYmVyO1xuICAgIC8qKlxuICAgICAqIE5vdGlmaWNhdGlvbiBjYWxsYmFjayBpZiB0aGUgc2VsZWN0ZWQgcGFnZSBpbmRleCBzaG91bGQgY2hhbmdlLlxuICAgICAqL1xuICAgIG9uUGFnZUNoYW5nZT8oZTogQ2Fyb3VzZWxDaGFuZ2VFdmVudCk6IHZvaWQ7XG4gICAgLyoqXG4gICAgICogVGhlIGNoaWxkcmVuLCB1c3VhbGx5IHBhc3NlZCBhcyBhIGNvbGxlY3Rpb24gb2YgZWxlbWVudHMuXG4gICAgICovXG4gICAgY2hpbGRyZW4/OiBSZWFjdC5SZWFjdE5vZGU7XG4gICAgLyoqXG4gICAgICogT3ZlcnJpZGVzIHRoZSBkZWZhdWx0IGNvbnRhaW5lciBmb3IgYnVsbGV0cy5cbiAgICAgKi9cbiAgICBidWxsZXRzQ29udGFpbmVyPzogUmVhY3QuQ29tcG9uZW50VHlwZTtcbiAgICAvKipcbiAgICAgKiBPdmVycmlkZXMgdGhlIGRlZmF1bHQgYnVsbGV0IHBvaW50IGNvbXBvbmVudC5cbiAgICAgKi9cbiAgICBidWxsZXQ/OiBSZWFjdC5Db21wb25lbnRUeXBlPEJ1bGxldFByb3BzPjtcbiAgICAvKipcbiAgICAgKiBEaXNwbGF5cyB0aGUgcHJldmlvdXMgLyBuZXh0IGFycm93LiBCeSBkZWZhdWx0IGRpc2FibGVkLlxuICAgICAqIEBkZWZhdWx0IGZhbHNlXG4gICAgICovXG4gICAgYXJyb3dzPzogYm9vbGVhbjtcbiAgICAvKipcbiAgICAgKiBFdmVudCBlbWl0dGVkIG9uY2UgdGhlIENhcm91c2VsIGF1dG9wbGF5IHN0b3BzLlxuICAgICAqL1xuICAgIG9uU3RvcD8oZTogQ2Fyb3VzZWxTdG9wRXZlbnQpOiB2b2lkO1xuICAgIC8qKlxuICAgICAqIEFjdGl2YXRlIHRoZSBhdXRvcGxheSBtb2RlLCBwb3RlbnRpYWxseSB3aXRoIHRoZSB0aW1lIHBlciBzbGlkZVxuICAgICAqIGluIG1pbGxpc2Vjb25kcy4gQnkgZGVmYXVsdCAzMDAwLlxuICAgICAqIEBkZWZhdWx0IGZhbHNlXG4gICAgICovXG4gICAgYXV0b3BsYXk/OiBib29sZWFuIHwgbnVtYmVyO1xuICAgIC8qKlxuICAgICAqIFdoZXRoZXIgdGhlIENhcm91c2VsIGNhbiBsb29wIHdpdGhvdXQgc3RvcHBpbmcuXG4gICAgICogQGRlZmF1bHQgZmFsc2VcbiAgICAgKi9cbiAgICBpbmZpbml0ZT86IGJvb2xlYW47XG4gICAgLyoqXG4gICAgICogV2hldGhlciB0aGUgQ2Fyb3VzZWwgY2FuIHN0b3AgcHJvcGFnYXRpb24gc28gdGhhdCBsaW5rcyBjYW4gYmUgY2xpY2tlZFxuICAgICAqIEBkZWZhdWx0IGZhbHNlXG4gICAgICovXG4gICAgb3BhcXVlPzogSW50ZXJhY3RpdmVTdXJmYWNlUHJvcHNbJ29wYXF1ZSddO1xufVxuZXhwb3J0IGludGVyZmFjZSBEcmFnU3RhdHVzIHtcbiAgICBpc0RyYWdnaW5nOiBib29sZWFuO1xuICAgIHN0YXJ0PzogUG9pbnQ7XG59XG5leHBvcnQgaW50ZXJmYWNlIFBvaW50IHtcbiAgICB4OiBudW1iZXI7XG4gICAgeTogbnVtYmVyO1xufVxuZXhwb3J0IGludGVyZmFjZSBDYXJvdXNlbFN0YXRlIHtcbiAgICAvKipcbiAgICAgKiBUaGUgY3VycmVudGx5IHNlbGVjdGVkIHBhZ2UgaW5kZXguXG4gICAgICovXG4gICAgc2VsZWN0ZWRJbmRleDogbnVtYmVyO1xuICAgIC8qKlxuICAgICAqIERldGVybWluZXMgaWYgdGhlIHRhYiBjb21wb25lbnQgaXMgY29udHJvbGxlZCBmcm9tIHRoZSBvdXRzaWRlIG9yIG5vdC5cbiAgICAgKi9cbiAgICBjb250cm9sbGVkOiBib29sZWFuO1xuICAgIC8qKlxuICAgICAqIFN0YXR1cyBvZiB0aGUgY3VycmVudCBzd2lwZSBtb3ZlLlxuICAgICAqL1xuICAgIGRyYWdTdGF0dXM6IERyYWdTdGF0dXM7XG59XG5jb25zdCBzaGlmdFRocmVzaG9sZCA9IDAuMztcbmNvbnN0IGFuaW1hdGlvbkR1cmF0aW9uID0gJzAuM3MnO1xuY29uc3QgYW5pbWF0aW9uRnVuY3Rpb24gPSAnZWFzZS1pbi1vdXQnO1xuY29uc3QgUm9vdENvbnRhaW5lciA9IHN0eWxlZC5kaXYgYFxuICBvdXRsaW5lOiBub25lO1xuYDtcbmNvbnN0IERlZmF1bHRCdWxsZXRzQ29udGFpbmVyID0gc3R5bGVkLmRpdiBgXG4gIGJveC1zaXppbmc6IGJvcmRlci1ib3g7XG4gIGRpc3BsYXk6IGZsZXg7XG4gIGp1c3RpZnktY29udGVudDogY2VudGVyO1xuYDtcbmV4cG9ydCBpbnRlcmZhY2UgQnVsbGV0UHJvcHMgZXh0ZW5kcyBTdGFuZGFyZFByb3BzIHtcbiAgICAvKipcbiAgICAgKiBEZXRlcm1pbmVzIGlmIHRoZSBidWxsZXQgaXMgYWN0aXZlIG9yIG5vdC5cbiAgICAgKi9cbiAgICBhY3RpdmU6IGJvb2xlYW47XG4gICAgLyoqXG4gICAgICogRmlyZWQgb25jZSB0aGUgYnVsbGV0IGhhcyBiZWVuIGNsaWNrZWQuXG4gICAgICovXG4gICAgb25DbGljaygpOiB2b2lkO1xuICAgIC8qKlxuICAgICAqIFNldHMgdGhlIGJ1bGxldCdzIGluZGV4LlxuICAgICAqL1xuICAgIGluZGV4OiBudW1iZXI7XG59XG5jb25zdCBBY3RpdmVCdWxsZXQgPSBjc3MgYFxuICBiYWNrZ3JvdW5kLWNvbG9yOiByZ2JhKDExNiwgMTE4LCAxMjAsIDEpO1xuYDtcbmNvbnN0IERlZmF1bHRCdWxsZXQgPSBzdHlsZWQuZGl2PEJ1bGxldFByb3BzPiBgXG4gIGhlaWdodDogJHtyZW1DYWxjKCcxMnB4Jyl9O1xuICB3aWR0aDogJHtyZW1DYWxjKCcxMnB4Jyl9O1xuICBiYWNrZ3JvdW5kLWNvbG9yOiByZ2JhKDIyNCwgMjI1LCAyMjEsIDEpO1xuICBib3JkZXItcmFkaXVzOiA1MCU7XG4gIGRpc3BsYXk6IGlubGluZS1ibG9jaztcbiAgY3Vyc29yOiBwb2ludGVyO1xuICBtYXJnaW46ICR7ZGlzdGFuY2UueHNtYWxsfTtcbiAgJHtwcm9wcyA9PiAocHJvcHMuYWN0aXZlID8gQWN0aXZlQnVsbGV0IDogJycpfTtcbmA7XG5jb25zdCBQYWdlSXRlbSA9IHN0eWxlZC5kaXYgYFxuICBtaW4td2lkdGg6IDEwMCU7XG5gO1xuaW50ZXJmYWNlIFBhZ2VzQ29udGFpbmVyUHJvcHMgZXh0ZW5kcyBTdGFuZGFyZFByb3BzIHtcbiAgICBzZWxlY3RlZEluZGV4OiBudW1iZXI7XG59XG5jb25zdCBQYWdlc0NvbnRhaW5lciA9IHN0eWxlZC5kaXY8UGFnZXNDb250YWluZXJQcm9wcz4gYFxuICBib3gtc2l6aW5nOiBib3JkZXItYm94O1xuICBkaXNwbGF5OiBmbGV4O1xuICBwb3NpdGlvbjogcmVsYXRpdmU7XG4gIGxlZnQ6ICR7cHJvcHMgPT4gLXByb3BzLnNlbGVjdGVkSW5kZXggKiAxMDB9JTtcbiAgdHJhbnNpdGlvbjogbGVmdCAke2FuaW1hdGlvbkR1cmF0aW9ufSAke2FuaW1hdGlvbkZ1bmN0aW9ufTtcbmA7XG5jb25zdCBNYXNrID0gc3R5bGVkLmRpdiBgXG4gIHBvc2l0aW9uOiByZWxhdGl2ZTtcbiAgYm94LXNpemluZzogYm9yZGVyLWJveDtcbiAgb3ZlcmZsb3c6IGhpZGRlbjtcbmA7XG5jb25zdCBBcnJvdyA9IHN0eWxlZC5idXR0b24gYFxuICAke2dldEZvbnRTdHlsZSh7IHNpemU6ICdtZWRpdW0nIH0pfVxuXG4gIHBvc2l0aW9uOiBhYnNvbHV0ZTtcbiAgdG9wOiA1MCU7XG4gIHRyYW5zZm9ybTogdHJhbnNsYXRlWSgtNTAlKTtcbiAgYmFja2dyb3VuZC1jb2xvcjogdHJhbnNwYXJlbnQ7XG4gIHBhZGRpbmc6IDA7XG4gIGJvcmRlcjogbm9uZTtcbiAgYWxpZ24tc2VsZjogc3RhcnQ7XG4gIGN1cnNvcjogcG9pbnRlcjtcbiAgPiBpIHtcbiAgICB2ZXJ0aWNhbC1hbGlnbjogbWlkZGxlO1xuICB9XG5gO1xuY29uc3QgQXJyb3dMZWZ0ID0gc3R5bGVkKEFycm93KSBgXG4gIGxlZnQ6IDhweDtcbmA7XG5jb25zdCBBcnJvd1JpZ2h0ID0gc3R5bGVkKEFycm93KSBgXG4gIHJpZ2h0OiA4cHg7XG5gO1xuZnVuY3Rpb24gY2FsY05leHRQYWdlKGN1cnJlbnRQYWdlOiBudW1iZXIsIHRvdGFsUGFnZXM6IG51bWJlciwgaW5maW5pdGU6IGJvb2xlYW4gPSBmYWxzZSkge1xuICAgIGNvbnN0IG1heEluZGV4ID0gdG90YWxQYWdlcyAtIDE7XG4gICAgY29uc3QgbmV4dFBhZ2UgPSBjdXJyZW50UGFnZSArIDE7XG4gICAgcmV0dXJuIGluZmluaXRlICYmIG5leHRQYWdlID4gbWF4SW5kZXggPyAwIDogTWF0aC5taW4obmV4dFBhZ2UsIG1heEluZGV4KTtcbn1cbmZ1bmN0aW9uIGNhbGNQcmV2UGFnZShjdXJyZW50UGFnZTogbnVtYmVyLCB0b3RhbFBhZ2VzOiBudW1iZXIsIGluZmluaXRlOiBib29sZWFuID0gZmFsc2UpIHtcbiAgICBjb25zdCBwcmV2UGFnZSA9IGN1cnJlbnRQYWdlIC0gMTtcbiAgICBjb25zdCBtYXhJbmRleCA9IHRvdGFsUGFnZXMgLSAxO1xuICAgIHJldHVybiBpbmZpbml0ZSAmJiBwcmV2UGFnZSA8IDAgPyBtYXhJbmRleCA6IE1hdGgubWF4KHByZXZQYWdlLCAwKTtcbn1cbmZ1bmN0aW9uIGNhbGNMZWZ0U2hpZnRQZXJjZW50KHNlbGVjdGVkSW5kZXg6IG51bWJlcikge1xuICAgIHJldHVybiBzZWxlY3RlZEluZGV4ICogLTEwMDtcbn1cbmNvbnN0IGRlZmF1bHRBdXRvUGxheVRpbWUgPSAzMDAwO1xuLyoqXG4gKiBUaGUgQ2Fyb3VzZWwgY29tcG9uZW50IGRpc3BsYXlzIGEgdG9nZ2xpbmcgbGlzdCBvZiBjb250ZW50LiBQYWdlIGNhbiBiZSBjaGFuZ2VkIHVzaW5nIGJ1bGxldFxuICogY29udHJvbHMgb3Igc3dpcGluZyBnZXN0dXJlcy5cbiAqL1xuZXhwb3J0IGNsYXNzIENhcm91c2VsIGV4dGVuZHMgUmVhY3QuUHVyZUNvbXBvbmVudDxDYXJvdXNlbFByb3BzLCBDYXJvdXNlbFN0YXRlPiB7XG4gICAgcHJpdmF0ZSBzZWxlY3RzOiBBcnJheTwoKSA9PiB2b2lkPiA9IFtdO1xuICAgIHByaXZhdGUgcGFnZXNDb250YWluZXI6IEhUTUxEaXZFbGVtZW50IHwgbnVsbDtcbiAgICBwcml2YXRlIGF1dG9QbGF5VGltZW91dDogYW55O1xuICAgIGNvbnN0cnVjdG9yKHByb3BzOiBDYXJvdXNlbFByb3BzKSB7XG4gICAgICAgIHN1cGVyKHByb3BzKTtcbiAgICAgICAgdGhpcy5zdGF0ZSA9IHtcbiAgICAgICAgICAgIHNlbGVjdGVkSW5kZXg6IHByb3BzLnNlbGVjdGVkSW5kZXggfHwgcHJvcHMuZGVmYXVsdEluZGV4IHx8IDAsXG4gICAgICAgICAgICBjb250cm9sbGVkOiBwcm9wcy5zZWxlY3RlZEluZGV4ICE9PSB1bmRlZmluZWQsXG4gICAgICAgICAgICBkcmFnU3RhdHVzOiB7IGlzRHJhZ2dpbmc6IGZhbHNlIH0sXG4gICAgICAgIH07XG4gICAgfVxuICAgIFVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzKG5leHRQcm9wczogQ2Fyb3VzZWxQcm9wcykge1xuICAgICAgICBjb25zdCB7IHNlbGVjdGVkSW5kZXggfSA9IG5leHRQcm9wcztcbiAgICAgICAgY29uc3QgeyBjb250cm9sbGVkIH0gPSB0aGlzLnN0YXRlO1xuICAgICAgICBpZiAoY29udHJvbGxlZCAmJiB0eXBlb2Ygc2VsZWN0ZWRJbmRleCA9PT0gJ251bWJlcicpIHtcbiAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgICAgIHNlbGVjdGVkSW5kZXgsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBjb21wb25lbnREaWRNb3VudCgpIHtcbiAgICAgICAgdGhpcy50cnlUb1BsYXkoKTtcbiAgICB9XG4gICAgY29tcG9uZW50V2lsbFVubW91bnQoKSB7XG4gICAgICAgIHRoaXMuc3RvcCgpO1xuICAgIH1cbiAgICBwcml2YXRlIHRyeVRvUGxheSgpIHtcbiAgICAgICAgdGhpcy5zdG9wKCk7XG4gICAgICAgIGNvbnN0IHsgYXV0b3BsYXkgfSA9IHRoaXMucHJvcHM7XG4gICAgICAgIGlmIChhdXRvcGxheSkge1xuICAgICAgICAgICAgdGhpcy5wbGF5KHR5cGVvZiBhdXRvcGxheSA9PT0gJ251bWJlcicgPyBhdXRvcGxheSA6IGRlZmF1bHRBdXRvUGxheVRpbWUpO1xuICAgICAgICB9XG4gICAgfVxuICAgIHByaXZhdGUgcGxheSh0aW1lOiBudW1iZXIpIHtcbiAgICAgICAgdGhpcy5hdXRvUGxheVRpbWVvdXQgPSBzZXRJbnRlcnZhbCh0aGlzLnN3aXBlUmlnaHRBdXRvLCB0aW1lKTtcbiAgICB9XG4gICAgcHJpdmF0ZSBzdG9wKCkge1xuICAgICAgICB0aGlzLmF1dG9QbGF5VGltZW91dCA9IGNsZWFySW50ZXJ2YWwodGhpcy5hdXRvUGxheVRpbWVvdXQpO1xuICAgIH1cbiAgICBwcml2YXRlIHJlc3VtZSA9ICgpID0+IHtcbiAgICAgICAgaWYgKCF0aGlzLmF1dG9QbGF5VGltZW91dCkge1xuICAgICAgICAgICAgdGhpcy50cnlUb1BsYXkoKTtcbiAgICAgICAgfVxuICAgIH07XG4gICAgcHJpdmF0ZSBjaGFuZ2VQYWdlKHRhcmdldDogbnVtYmVyLCBtYW51YWwgPSB0cnVlKSB7XG4gICAgICAgIGNvbnN0IHsgb25QYWdlQ2hhbmdlLCBvblN0b3AsIGNoaWxkcmVuIH0gPSB0aGlzLnByb3BzO1xuICAgICAgICBjb25zdCBjaGlsZHJlbkNvdW50ID0gUmVhY3QuQ2hpbGRyZW4uY291bnQoY2hpbGRyZW4pO1xuICAgICAgICBjb25zdCB7IGNvbnRyb2xsZWQsIHNlbGVjdGVkSW5kZXggfSA9IHRoaXMuc3RhdGU7XG4gICAgICAgIGNvbnN0IHNob3VsZFN0b3AgPSB0YXJnZXQgPj0gY2hpbGRyZW5Db3VudCB8fCB0YXJnZXQgPCAwO1xuICAgICAgICBpZiAobWFudWFsIHx8IHNob3VsZFN0b3ApIHtcbiAgICAgICAgICAgIGlmICh0aGlzLmF1dG9QbGF5VGltZW91dCkge1xuICAgICAgICAgICAgICAgIHRoaXMuc3RvcCgpO1xuICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygb25TdG9wID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICAgICAgICAgIG9uU3RvcCh7XG4gICAgICAgICAgICAgICAgICAgICAgICByZWFzb246IG1hbnVhbCA/ICdtYW51YWwnIDogJ2VuZGVkJyxcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VtZTogdGhpcy5yZXN1bWUsXG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAoIXNob3VsZFN0b3ApIHtcbiAgICAgICAgICAgIGlmICh0eXBlb2Ygb25QYWdlQ2hhbmdlID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICAgICAgb25QYWdlQ2hhbmdlKHtcbiAgICAgICAgICAgICAgICAgICAgcHJldmlvdXNJbmRleDogc2VsZWN0ZWRJbmRleCxcbiAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWRJbmRleDogdGFyZ2V0LFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKCFjb250cm9sbGVkKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSgoKSA9PiAoe1xuICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZEluZGV4OiB0YXJnZXQsXG4gICAgICAgICAgICAgICAgfSkpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIHByaXZhdGUgZHJhZ1RpbGUgPSAoZTogSW50ZXJhY3RpdmVTdXJmYWNlQ2hhbmdlRXZlbnQpID0+IHtcbiAgICAgICAgY29uc3QgeyBjb250cm9sbGVkLCBzZWxlY3RlZEluZGV4LCBkcmFnU3RhdHVzIH0gPSB0aGlzLnN0YXRlO1xuICAgICAgICBjb25zdCBzaGlmdCA9IGRyYWdTdGF0dXMuc3RhcnQgPyBlLnggLSBkcmFnU3RhdHVzLnN0YXJ0LnggOiAwO1xuICAgICAgICBpZiAoY29udHJvbGxlZCkge1xuICAgICAgICAgICAgZS5yZWxlYXNlKCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMucGFnZXNDb250YWluZXIpIHtcbiAgICAgICAgICAgIGlmIChlLmFjdGl2ZSkge1xuICAgICAgICAgICAgICAgIGlmICghZHJhZ1N0YXR1cy5pc0RyYWdnaW5nKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoeyBkcmFnU3RhdHVzOiB7IGlzRHJhZ2dpbmc6IHRydWUsIHN0YXJ0OiB7IHg6IGUueCwgeTogZS55IH0gfSB9KTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXREcmFnU3R5bGUodGhpcy5wYWdlc0NvbnRhaW5lcik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHRoaXMucGFnZXNDb250YWluZXIuc3R5bGUubGVmdCA9IGAke2NhbGNMZWZ0U2hpZnRQZXJjZW50KHNlbGVjdGVkSW5kZXgpICsgc2hpZnQgKiAxMDB9JWA7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLnNldFN0YXRlKHsgZHJhZ1N0YXR1czogeyBpc0RyYWdnaW5nOiBmYWxzZSwgc3RhcnQ6IHVuZGVmaW5lZCB9IH0pO1xuICAgICAgICAgICAgICAgIHRoaXMucmVzZXRJbml0aWFsU3R5bGUodGhpcy5wYWdlc0NvbnRhaW5lcik7XG4gICAgICAgICAgICAgICAgdGhpcy5jaGVja1BhZ2VDaGFuZ2Uoc2hpZnQpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfTtcbiAgICBwcml2YXRlIGNoZWNrUGFnZUNoYW5nZShzaGlmdDogbnVtYmVyKSB7XG4gICAgICAgIGNvbnN0IHsgc2VsZWN0ZWRJbmRleCB9ID0gdGhpcy5zdGF0ZTtcbiAgICAgICAgaWYgKHNoaWZ0IDw9IC1zaGlmdFRocmVzaG9sZCkge1xuICAgICAgICAgICAgY29uc3QgbmV4dEluZGV4ID0gY2FsY05leHRQYWdlKHNlbGVjdGVkSW5kZXgsIFJlYWN0LkNoaWxkcmVuLmNvdW50KHRoaXMucHJvcHMuY2hpbGRyZW4pLCB0aGlzLnByb3BzLmluZmluaXRlKTtcbiAgICAgICAgICAgIHRoaXMuY2hhbmdlUGFnZShuZXh0SW5kZXgpO1xuICAgICAgICB9XG4gICAgICAgIGVsc2UgaWYgKHNoaWZ0ID49IHNoaWZ0VGhyZXNob2xkKSB7XG4gICAgICAgICAgICBjb25zdCBwcmV2SW5kZXggPSBjYWxjUHJldlBhZ2Uoc2VsZWN0ZWRJbmRleCwgUmVhY3QuQ2hpbGRyZW4uY291bnQodGhpcy5wcm9wcy5jaGlsZHJlbiksIHRoaXMucHJvcHMuaW5maW5pdGUpO1xuICAgICAgICAgICAgdGhpcy5jaGFuZ2VQYWdlKHByZXZJbmRleCk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcHJpdmF0ZSBzZXREcmFnU3R5bGUobm9kZTogSFRNTEVsZW1lbnQpIHtcbiAgICAgICAgY29uc3Qgc3R5bGUgPSBub2RlLnN0eWxlO1xuICAgICAgICBzdHlsZS50cmFuc2l0aW9uUHJvcGVydHkgPSAndW5zZXQnO1xuICAgICAgICBzdHlsZS50cmFuc2l0aW9uRHVyYXRpb24gPSAndW5zZXQnO1xuICAgICAgICBzdHlsZS50cmFuc2l0aW9uVGltaW5nRnVuY3Rpb24gPSAndW5zZXQnO1xuICAgIH1cbiAgICBwcml2YXRlIHJlc2V0SW5pdGlhbFN0eWxlKG5vZGU6IEhUTUxFbGVtZW50KSB7XG4gICAgICAgIGNvbnN0IHN0eWxlID0gbm9kZS5zdHlsZTtcbiAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lXG4gICAgICAgIHN0eWxlLmxlZnQgPSBudWxsO1xuICAgICAgICBzdHlsZS50cmFuc2l0aW9uUHJvcGVydHkgPSAnbGVmdCc7XG4gICAgICAgIHN0eWxlLnRyYW5zaXRpb25EdXJhdGlvbiA9IGFuaW1hdGlvbkR1cmF0aW9uO1xuICAgICAgICBzdHlsZS50cmFuc2l0aW9uVGltaW5nRnVuY3Rpb24gPSBhbmltYXRpb25GdW5jdGlvbjtcbiAgICB9XG4gICAgcHJpdmF0ZSBzd2lwZShkaXJlY3Rpb246IG51bWJlciwgbWFudWFsOiBib29sZWFuKSB7XG4gICAgICAgIGNvbnN0IHsgc2VsZWN0ZWRJbmRleCB9ID0gdGhpcy5zdGF0ZTtcbiAgICAgICAgY29uc3QgeyBjaGlsZHJlbiwgaW5maW5pdGUgfSA9IHRoaXMucHJvcHM7XG4gICAgICAgIGNvbnN0IGNoaWxkcmVuQ291bnQgPSBSZWFjdC5DaGlsZHJlbi5jb3VudChjaGlsZHJlbik7XG4gICAgICAgIGxldCBuZXh0SW5kZXggPSBzZWxlY3RlZEluZGV4O1xuICAgICAgICBpZiAoZGlyZWN0aW9uID09PSAxKSB7XG4gICAgICAgICAgICBuZXh0SW5kZXggPSBjYWxjTmV4dFBhZ2Uoc2VsZWN0ZWRJbmRleCwgY2hpbGRyZW5Db3VudCwgaW5maW5pdGUpO1xuICAgICAgICB9XG4gICAgICAgIGVsc2UgaWYgKGRpcmVjdGlvbiA9PT0gLTEpIHtcbiAgICAgICAgICAgIG5leHRJbmRleCA9IGNhbGNQcmV2UGFnZShzZWxlY3RlZEluZGV4LCBjaGlsZHJlbkNvdW50LCBpbmZpbml0ZSk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5jaGFuZ2VQYWdlKG5leHRJbmRleCwgbWFudWFsKTtcbiAgICB9XG4gICAgcHJpdmF0ZSBzd2lwZUxlZnQgPSAoKSA9PiB7XG4gICAgICAgIHRoaXMuc3dpcGUoLTEsIHRydWUpO1xuICAgIH07XG4gICAgcHJpdmF0ZSBzd2lwZVJpZ2h0ID0gKCkgPT4ge1xuICAgICAgICB0aGlzLnN3aXBlKDEsIHRydWUpO1xuICAgIH07XG4gICAgcHJpdmF0ZSBzd2lwZVJpZ2h0QXV0byA9ICgpID0+IHtcbiAgICAgICAgdGhpcy5zd2lwZSgxLCBmYWxzZSk7XG4gICAgfTtcbiAgICBwcml2YXRlIGhhbmRsZUtleURvd24gPSAoZTogUmVhY3QuS2V5Ym9hcmRFdmVudDxIVE1MRGl2RWxlbWVudD4pID0+IHtcbiAgICAgICAgY29uc3QgeyBjaGlsZHJlbiwgaW5maW5pdGUgfSA9IHRoaXMucHJvcHM7XG4gICAgICAgIGNvbnN0IHsgc2VsZWN0ZWRJbmRleCB9ID0gdGhpcy5zdGF0ZTtcbiAgICAgICAgY29uc3QgY2hpbGRyZW5Db3VudCA9IFJlYWN0LkNoaWxkcmVuLmNvdW50KGNoaWxkcmVuKTtcbiAgICAgICAgbGV0IG5leHRJbmRleCA9IHNlbGVjdGVkSW5kZXg7XG4gICAgICAgIHN3aXRjaCAoZS5rZXlDb2RlKSB7XG4gICAgICAgICAgICBjYXNlIEtleUNvZGVzLmxlZnQ6XG4gICAgICAgICAgICAgICAgbmV4dEluZGV4ID0gY2FsY1ByZXZQYWdlKHNlbGVjdGVkSW5kZXgsIGNoaWxkcmVuQ291bnQsIGluZmluaXRlKTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgS2V5Q29kZXMucmlnaHQ6XG4gICAgICAgICAgICAgICAgbmV4dEluZGV4ID0gY2FsY05leHRQYWdlKHNlbGVjdGVkSW5kZXgsIGNoaWxkcmVuQ291bnQsIGluZmluaXRlKTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgS2V5Q29kZXMuZW5kOlxuICAgICAgICAgICAgICAgIG5leHRJbmRleCA9IGNoaWxkcmVuQ291bnQgLSAxO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSBLZXlDb2Rlcy5ob21lOlxuICAgICAgICAgICAgICAgIG5leHRJbmRleCA9IDA7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmNoYW5nZVBhZ2UobmV4dEluZGV4KTtcbiAgICB9O1xuICAgIHJlbmRlcigpIHtcbiAgICAgICAgY29uc3QgeyBzZWxlY3RlZEluZGV4IH0gPSB0aGlzLnN0YXRlO1xuICAgICAgICBjb25zdCB7IGNoaWxkcmVuLCB0aGVtZSwgc2VsZWN0ZWRJbmRleDogXzAsIGRlZmF1bHRJbmRleDogXzEsIG9uUGFnZUNoYW5nZTogXzIsIGJ1bGxldHNDb250YWluZXI6IEN1c3RvbUJ1bGxldHNDb250YWluZXIsIGJ1bGxldDogQ3VzdG9tQnVsbGV0LCBhcnJvd3MgPSBmYWxzZSwgaW5maW5pdGUgPSBmYWxzZSwgb3BhcXVlID0gZmFsc2UsIC4uLnByb3BzIH0gPSB0aGlzLnByb3BzO1xuICAgICAgICBjb25zdCBjaGlsZHJlbkNvdW50ID0gUmVhY3QuQ2hpbGRyZW4uY291bnQoY2hpbGRyZW4pO1xuICAgICAgICBjb25zdCBidWxsZXRzOiBBcnJheTxSZWFjdC5SZWFjdENoaWxkPiA9IFtdO1xuICAgICAgICBjb25zdCBpdGVtczogQXJyYXk8UmVhY3QuUmVhY3RDaGlsZD4gPSBbXTtcbiAgICAgICAgY29uc3Qgc2VsZWN0cyA9IHRoaXMuc2VsZWN0cztcbiAgICAgICAgY29uc3QgQnVsbGV0c0NvbnRhaW5lciA9IEN1c3RvbUJ1bGxldHNDb250YWluZXIgfHwgRGVmYXVsdEJ1bGxldHNDb250YWluZXI7XG4gICAgICAgIGNvbnN0IEJ1bGxldCA9IEN1c3RvbUJ1bGxldCB8fCBEZWZhdWx0QnVsbGV0O1xuICAgICAgICBSZWFjdC5DaGlsZHJlbi5mb3JFYWNoKGNoaWxkcmVuLCAoZWxlbWVudCwgaW5kZXgpID0+IHtcbiAgICAgICAgICAgIGlmIChlbGVtZW50ICYmIFJlYWN0LmlzVmFsaWRFbGVtZW50KGVsZW1lbnQpKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgYWN0aXZlID0gaW5kZXggPT09IHNlbGVjdGVkSW5kZXg7XG4gICAgICAgICAgICAgICAgaWYgKHNlbGVjdHNbaW5kZXhdID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgc2VsZWN0c1tpbmRleF0gPSAoKSA9PiB0aGlzLmNoYW5nZVBhZ2UoaW5kZXgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBidWxsZXRzLnB1c2goPEJ1bGxldCB0aGVtZT17dGhlbWV9IGtleT17YGJ1bGxldC0ke2luZGV4fWB9IGFjdGl2ZT17YWN0aXZlfSBpbmRleD17aW5kZXh9IG9uQ2xpY2s9e3NlbGVjdHNbaW5kZXhdfS8+KTtcbiAgICAgICAgICAgICAgICBpdGVtcy5wdXNoKDxQYWdlSXRlbSBrZXk9e2BpdGVtLSR7aW5kZXh9YH0+e2VsZW1lbnR9PC9QYWdlSXRlbT4pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgY29uc3QgZGlzYWJsZUxlZnQgPSAhaW5maW5pdGUgJiYgc2VsZWN0ZWRJbmRleCA8IDE7XG4gICAgICAgIGNvbnN0IGRpc2FibGVSaWdodCA9ICFpbmZpbml0ZSAmJiBzZWxlY3RlZEluZGV4ID4gY2hpbGRyZW5Db3VudCAtIDI7XG4gICAgICAgIHJldHVybiAoPFJvb3RDb250YWluZXIgey4uLnByb3BzfSBvbktleURvd249e3RoaXMuaGFuZGxlS2V5RG93bn0gdGFiSW5kZXg9ezB9PlxuICAgICAgICA8TWFzaz5cbiAgICAgICAgICA8SW50ZXJhY3RpdmVTdXJmYWNlIHRoZW1lPXt0aGVtZX0gb25DaGFuZ2U9e3RoaXMuZHJhZ1RpbGV9IG9wYXF1ZT17b3BhcXVlfT5cbiAgICAgICAgICAgIDxQYWdlc0NvbnRhaW5lciByZWY9e25vZGUgPT4gKHRoaXMucGFnZXNDb250YWluZXIgPSBub2RlKX0gc2VsZWN0ZWRJbmRleD17c2VsZWN0ZWRJbmRleH0+XG4gICAgICAgICAgICAgIHtpdGVtc31cbiAgICAgICAgICAgIDwvUGFnZXNDb250YWluZXI+XG4gICAgICAgICAgPC9JbnRlcmFjdGl2ZVN1cmZhY2U+XG4gICAgICAgICAge2Fycm93cyAmJiAoPGRpdj5cbiAgICAgICAgICAgICAgPEFycm93TGVmdCBvbkNsaWNrPXt0aGlzLnN3aXBlTGVmdH0gZGlzYWJsZWQ9e2Rpc2FibGVMZWZ0fSB0eXBlPVwiYnV0dG9uXCI+XG4gICAgICAgICAgICAgICAgPEljb24gbmFtZT1cIktleWJvYXJkQXJyb3dMZWZ0XCIgc2l6ZT17Mn0vPlxuICAgICAgICAgICAgICA8L0Fycm93TGVmdD5cbiAgICAgICAgICAgICAgPEFycm93UmlnaHQgb25DbGljaz17dGhpcy5zd2lwZVJpZ2h0fSBkaXNhYmxlZD17ZGlzYWJsZVJpZ2h0fSB0eXBlPVwiYnV0dG9uXCI+XG4gICAgICAgICAgICAgICAgPEljb24gbmFtZT1cIktleWJvYXJkQXJyb3dSaWdodFwiIHNpemU9ezJ9Lz5cbiAgICAgICAgICAgICAgPC9BcnJvd1JpZ2h0PlxuICAgICAgICAgICAgPC9kaXY+KX1cbiAgICAgICAgPC9NYXNrPlxuICAgICAgICA8QnVsbGV0c0NvbnRhaW5lcj57YnVsbGV0c308L0J1bGxldHNDb250YWluZXI+XG4gICAgICA8L1Jvb3RDb250YWluZXI+KTtcbiAgICB9XG4gICAgc3RhdGljIGlubmVyID0ge1xuICAgICAgICBnZXQgUGFnZUl0ZW0oKSB7IHJldHVybiBQYWdlSXRlbSBhcyB0eXBlb2YgUGFnZUl0ZW07IH0sXG4gICAgICAgIGdldCBSb290Q29udGFpbmVyKCkgeyByZXR1cm4gUm9vdENvbnRhaW5lciBhcyB0eXBlb2YgUm9vdENvbnRhaW5lcjsgfSxcbiAgICAgICAgZ2V0IE1hc2soKSB7IHJldHVybiBNYXNrIGFzIHR5cGVvZiBNYXNrOyB9LFxuICAgICAgICBnZXQgSW50ZXJhY3RpdmVTdXJmYWNlKCkgeyByZXR1cm4gSW50ZXJhY3RpdmVTdXJmYWNlIGFzIHR5cGVvZiBJbnRlcmFjdGl2ZVN1cmZhY2U7IH0sXG4gICAgICAgIGdldCBQYWdlc0NvbnRhaW5lcigpIHsgcmV0dXJuIFBhZ2VzQ29udGFpbmVyIGFzIHR5cGVvZiBQYWdlc0NvbnRhaW5lcjsgfSxcbiAgICAgICAgZ2V0IEFycm93TGVmdCgpIHsgcmV0dXJuIEFycm93TGVmdCBhcyB0eXBlb2YgQXJyb3dMZWZ0OyB9LFxuICAgICAgICBnZXQgSWNvbigpIHsgcmV0dXJuIEljb24gYXMgdHlwZW9mIEljb247IH0sXG4gICAgICAgIGdldCBBcnJvd1JpZ2h0KCkgeyByZXR1cm4gQXJyb3dSaWdodCBhcyB0eXBlb2YgQXJyb3dSaWdodDsgfVxuICAgIH07XG59XG4iXX0=