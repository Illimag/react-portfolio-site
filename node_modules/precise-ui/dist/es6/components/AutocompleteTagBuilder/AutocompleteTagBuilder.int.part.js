var __rest = (this && this.__rest) || function (s, e) {
    var t = {};
    for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)
        t[p] = s[p];
    if (s != null && typeof Object.getOwnPropertySymbols === "function")
        for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) if (e.indexOf(p[i]) < 0)
            t[p[i]] = s[p[i]];
    return t;
};
import * as React from 'react';
import memoize from 'memoize-one';
import { debounce } from '../../utils';
import { TagBuilder } from '../TagBuilder';
import { Autocomplete } from '../Autocomplete';
export class AutocompleteTagBuilderInt extends React.Component {
    constructor(props) {
        super(props);
        this.removeValueByIndex = (index) => {
            const { value } = this.state;
            const keys = Array.from(value.keys());
            index = index >= 0 ? index : keys.length + index;
            if (index >= 0 && index < keys.length) {
                value.splice(index, 1);
                const newValue = [...value];
                this.updateValue(newValue);
            }
        };
        this.getTagsArray = memoize((value) => {
            return value.map(x => this.getSuggestionValue(x));
        });
        this.tagRemoveHandler = (index) => {
            this.removeValueByIndex(index);
        };
        this.suggestionSelectedHandler = (e) => {
            this.addSuggestion(e.value);
        };
        this.inputChangeHandler = (e) => {
            this.changeInputValue(e.value);
        };
        this.inputRefHandler = (node) => {
            this._inputNode = node;
        };
        this.tagBuilderRenderer = (inputProps) => {
            const { disabled, tagRenderer, borderless = false } = this.props;
            const { value } = this.state;
            const { onChange, value: inputValue } = inputProps, restProps = __rest(inputProps, ["onChange", "value"]);
            const tagBuilderValue = this.getTagsArray(value);
            return (React.createElement(TagBuilder, Object.assign({}, restProps, { disabled: disabled, inputValue: inputValue, onInput: onChange, value: tagBuilderValue, tagRenderer: tagRenderer, borderless: borderless, onBeforeTagRemove: this.tagRemoveHandler })));
        };
        const { value: nullableValue, defaultValue, onInputChange, inputValue, delay = 0 } = this.props;
        const value = nullableValue || defaultValue || [];
        this.state = {
            value: value,
            inputValue: inputValue || '',
            controlled: props.value !== undefined || inputValue !== undefined,
        };
        this._fireOnInputChange = debounce((value) => {
            onInputChange && onInputChange({ value });
        }, delay);
    }
    UNSAFE_componentWillReceiveProps(nextProps) {
        if (this.state.controlled) {
            const { value, inputValue } = nextProps;
            this.setState({
                value: value || [],
                inputValue: inputValue || '',
            });
        }
    }
    componentDidMount() {
        const { form } = this.props;
        const { controlled } = this.state;
        if (!controlled && form) {
            form.subscribe(this);
        }
    }
    componentWillUnmount() {
        const { form } = this.props;
        const { controlled } = this.state;
        if (!controlled && form) {
            form.unsubscribe(this);
        }
    }
    addSuggestion(suggestion) {
        const { value } = this.state;
        const key = this.getSuggestionKey(suggestion);
        const suggestionAlreadyAdded = value.some(x => this.getSuggestionKey(x) === key);
        if (!suggestionAlreadyAdded) {
            const newValue = [...value];
            newValue.push(suggestion);
            this.updateValue(newValue);
        }
        this.changeInputValue('');
    }
    updateValue(newValue) {
        const { onChange, name = '', form } = this.props;
        if (!this.state.controlled) {
            if (form) {
                form.change({
                    name,
                    value: newValue,
                });
            }
            else {
                this.setState({
                    value: newValue,
                });
            }
        }
        if (this._inputNode) {
            this._inputNode.focus();
        }
        if (typeof onChange === 'function') {
            onChange({ value: newValue });
        }
    }
    changeInputValue(newValue) {
        if (!this.state.controlled) {
            this.setState({
                inputValue: newValue,
            });
        }
        this._fireOnInputChange(newValue);
    }
    getSuggestionValue(item) {
        const { getSuggestionValue } = this.props;
        if (typeof item === 'string') {
            return item;
        }
        else if (typeof getSuggestionValue === 'function') {
            return getSuggestionValue(item);
        }
        else {
            throw new Error('Get suggestion value should be specified');
        }
    }
    getSuggestionKey(item) {
        const { getSuggestionKey } = this.props;
        if (typeof item === 'string') {
            return item;
        }
        else if (typeof getSuggestionKey === 'function') {
            return getSuggestionKey(item);
        }
        else {
            throw new Error('Get suggestion key should be specified');
        }
    }
    defaultSuggestionRenderer(suggestion) {
        return {
            content: this.getSuggestionValue(suggestion),
            key: this.getSuggestionKey(suggestion),
        };
    }
    render() {
        const { suggestions = [], noSuggestionsMessage, disabled, renderSuggestion = (item) => this.defaultSuggestionRenderer(item), label, placeholder, info, borderless = false, error, onBlur, onFocus, } = this.props;
        const { inputValue } = this.state;
        return (React.createElement(Autocomplete, { noSuggestionsMessage: noSuggestionsMessage, suggestions: suggestions, inputRenderer: this.tagBuilderRenderer, renderSuggestion: renderSuggestion, disabled: disabled, value: inputValue, onChange: this.inputChangeHandler, onSuggestionSelected: this.suggestionSelectedHandler, inputRef: this.inputRefHandler, label: label, placeholder: placeholder, info: info, error: error, borderless: borderless, onBlur: onBlur, onFocus: onFocus }));
    }
}
AutocompleteTagBuilderInt.inner = {
    get TagBuilder() { return TagBuilder; },
    get Autocomplete() { return Autocomplete; }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQXV0b2NvbXBsZXRlVGFnQnVpbGRlci5pbnQucGFydC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL0F1dG9jb21wbGV0ZVRhZ0J1aWxkZXIvQXV0b2NvbXBsZXRlVGFnQnVpbGRlci5pbnQucGFydC50c3giXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBQUEsT0FBTyxLQUFLLEtBQUssTUFBTSxPQUFPLENBQUM7QUFDL0IsT0FBTyxPQUFPLE1BQU0sYUFBYSxDQUFDO0FBSWxDLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDdkMsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsWUFBWSxFQUFrRCxNQUFNLGlCQUFpQixDQUFDO0FBQy9GLE1BQU0sT0FBTyx5QkFBNkIsU0FBUSxLQUFLLENBQUMsU0FBNEY7SUFHaEosWUFBbUIsS0FBcUM7UUFDcEQsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBOENULHVCQUFrQixHQUFHLENBQUMsS0FBYSxFQUFFLEVBQUU7WUFDM0MsTUFBTSxFQUFFLEtBQUssRUFBRSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUM7WUFDN0IsTUFBTSxJQUFJLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQztZQUN0QyxLQUFLLEdBQUcsS0FBSyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxHQUFHLEtBQUssQ0FBQztZQUNqRCxJQUFJLEtBQUssSUFBSSxDQUFDLElBQUksS0FBSyxHQUFHLElBQUksQ0FBQyxNQUFNLEVBQUU7Z0JBQ25DLEtBQUssQ0FBQyxNQUFNLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQyxDQUFDO2dCQUN2QixNQUFNLFFBQVEsR0FBRyxDQUFDLEdBQUcsS0FBSyxDQUFD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LEVBQUUsSUFBSSxDQUFDLGtCQUFrQixFQUFFLGdCQUFnQixFQUFFLGdCQUFnQixFQUFFLFFBQVEsRUFBRSxRQUFRLEVBQUUsS0FBSyxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsSUFBSSxDQUFDLGtCQUFrQixFQUFFLG9CQUFvQixFQUFFLElBQUksQ0FBQyx5QkFBeUIsRUFBRSxRQUFRLEVBQUUsSUFBSSxDQUFDLGVBQWUsRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLFdBQVcsRUFBRSxXQUFXLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLFVBQVUsRUFBRSxVQUFVLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxPQUFPLEVBQUUsT0FBTyxHQUFHLENBQUMsQ0FBQztJQUMzYyxDQUFDOztBQUNNLCtCQUFLLEdBQUc7SUFDWCxJQUFJLFVBQVUsS0FBSyxPQUFPLFVBQStCLENBQUMsQ0FBQyxDQUFDO0lBQzVELElBQUksWUFBWSxLQUFLLE9BQU8sWUFBbUMsQ0FBQyxDQUFDLENBQUM7Q0FDckUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIFJlYWN0IGZyb20gJ3JlYWN0JztcbmltcG9ydCBtZW1vaXplIGZyb20gJ21lbW9pemUtb25lJztcbmltcG9ydCB7IEZvcm1Db250ZXh0UHJvcHMgfSBmcm9tICcuLi8uLi9ob2Mvd2l0aEZvcm1Db250ZXh0JztcbmltcG9ydCB7IElucHV0Q2hhbmdlRXZlbnQgfSBmcm9tICcuLi8uLi9jb21tb24nO1xuaW1wb3J0IHsgQXV0b2NvbXBsZXRlVGFnQnVpbGRlclByb3BzLCBBdXRvY29tcGxldGVUYWdCdWlsZGVyU3RhdGUgfSBmcm9tICcuL0F1dG9jb21wbGV0ZVRhZ0J1aWxkZXIudHlwZXMucGFydCc7XG5pbXBvcnQgeyBkZWJvdW5jZSB9IGZyb20gJy4uLy4uL3V0aWxzJztcbmltcG9ydCB7IFRhZ0J1aWxkZXIgfSBmcm9tICcuLi9UYWdCdWlsZGVyJztcbmltcG9ydCB7IEF1dG9jb21wbGV0ZSwgQXV0b2NvbXBsZXRlSW5wdXRQcm9wcywgQXV0b3N1Z2dlc3RTZWxlY3RFdmVudCB9IGZyb20gJy4uL0F1dG9jb21wbGV0ZSc7XG5leHBvcnQgY2xhc3MgQXV0b2NvbXBsZXRlVGFnQnVpbGRlckludDxUPiBleHRlbmRzIFJlYWN0LkNvbXBvbmVudDxBdXRvY29tcGxldGVUYWdCdWlsZGVyUHJvcHM8VD4gJiBGb3JtQ29udGV4dFByb3BzLCBBdXRvY29tcGxldGVUYWdCdWlsZGVyU3RhdGU8VD4+IHtcbiAgICBwcml2YXRlIF9maXJlT25JbnB1dENoYW5nZTogKHE6IHN0cmluZykgPT4gdm9pZDtcbiAgICBwcml2YXRlIF9pbnB1dE5vZGU6IEhUTUxFbGVtZW50IHwgbnVsbDtcbiAgICBwdWJsaWMgY29uc3RydWN0b3IocHJvcHM6IEF1dG9jb21wbGV0ZVRhZ0J1aWxkZXJQcm9wczxUPikge1xuICAgICAgICBzdXBlcihwcm9wcyk7XG4gICAgICAgIGNvbnN0IHsgdmFsdWU6IG51bGxhYmxlVmFsdWUsIGRlZmF1bHRWYWx1ZSwgb25JbnB1dENoYW5nZSwgaW5wdXRWYWx1ZSwgZGVsYXkgPSAwIH0gPSB0aGlzLnByb3BzO1xuICAgICAgICBjb25zdCB2YWx1ZSA9IG51bGxhYmxlVmFsdWUgfHwgZGVmYXVsdFZhbHVlIHx8IFtdO1xuICAgICAgICB0aGlzLnN0YXRlID0ge1xuICAgICAgICAgICAgdmFsdWU6IHZhbHVlLFxuICAgICAgICAgICAgaW5wdXRWYWx1ZTogaW5wdXRWYWx1ZSB8fCAnJyxcbiAgICAgICAgICAgIGNvbnRyb2xsZWQ6IHByb3BzLnZhbHVlICE9PSB1bmRlZmluZWQgfHwgaW5wdXRWYWx1ZSAhPT0gdW5kZWZpbmVkLFxuICAgICAgICB9O1xuICAgICAgICB0aGlzLl9maXJlT25JbnB1dENoYW5nZSA9IGRlYm91bmNlKCh2YWx1ZTogc3RyaW5nKSA9PiB7XG4gICAgICAgICAgICBvbklucHV0Q2hhbmdlICYmIG9uSW5wdXRDaGFuZ2UoeyB2YWx1ZSB9KTtcbiAgICAgICAgfSwgZGVsYXkpO1xuICAgIH1cbiAgICBwdWJsaWMgVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMobmV4dFByb3BzOiBBdXRvY29tcGxldGVUYWdCdWlsZGVyUHJvcHM8VD4pIHtcbiAgICAgICAgaWYgKHRoaXMuc3RhdGUuY29udHJvbGxlZCkge1xuICAgICAgICAgICAgY29uc3QgeyB2YWx1ZSwgaW5wdXRWYWx1ZSB9ID0gbmV4dFByb3BzO1xuICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICAgICAgdmFsdWU6IHZhbHVlIHx8IFtdLFxuICAgICAgICAgICAgICAgIGlucHV0VmFsdWU6IGlucHV0VmFsdWUgfHwgJycsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBwdWJsaWMgY29tcG9uZW50RGlkTW91bnQoKSB7XG4gICAgICAgIGNvbnN0IHsgZm9ybSB9ID0gdGhpcy5wcm9wcztcbiAgICAgICAgY29uc3QgeyBjb250cm9sbGVkIH0gPSB0aGlzLnN0YXRlO1xuICAgICAgICBpZiAoIWNvbnRyb2xsZWQgJiYgZm9ybSkge1xuICAgICAgICAgICAgZm9ybS5zdWJzY3JpYmUodGhpcyk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcHVibGljIGNvbXBvbmVudFdpbGxVbm1vdW50KCkge1xuICAgICAgICBjb25zdCB7IGZvcm0gfSA9IHRoaXMucHJvcHM7XG4gICAgICAgIGNvbnN0IHsgY29udHJvbGxlZCB9ID0gdGhpcy5zdGF0ZTtcbiAgICAgICAgaWYgKCFjb250cm9sbGVkICYmIGZvcm0pIHtcbiAgICAgICAgICAgIGZvcm0udW5zdWJzY3JpYmUodGhpcyk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcHJpdmF0ZSBhZGRTdWdnZXN0aW9uKHN1Z2dlc3Rpb246IFQpIHtcbiAgICAgICAgY29uc3QgeyB2YWx1ZSB9ID0gdGhpcy5zdGF0ZTtcbiAgICAgICAgY29uc3Qga2V5ID0gdGhpcy5nZXRTdWdnZXN0aW9uS2V5KHN1Z2dlc3Rpb24pO1xuICAgICAgICBjb25zdCBzdWdnZXN0aW9uQWxyZWFkeUFkZGVkID0gdmFsdWUuc29tZSh4ID0+IHRoaXMuZ2V0U3VnZ2VzdGlvbktleSh4KSA9PT0ga2V5KTtcbiAgICAgICAgaWYgKCFzdWdnZXN0aW9uQWxyZWFkeUFkZGVkKSB7XG4gICAgICAgICAgICBjb25zdCBuZXdWYWx1ZSA9IFsuLi52YWx1ZV07XG4gICAgICAgICAgICBuZXdWYWx1ZS5wdXNoKHN1Z2dlc3Rpb24pO1xuICAgICAgICAgICAgdGhpcy51cGRhdGVWYWx1ZShuZXdWYWx1ZSk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5jaGFuZ2VJbnB1dFZhbHVlKCcnKTtcbiAgICB9XG4gICAgcHJpdmF0ZSByZW1vdmVWYWx1ZUJ5SW5kZXggPSAoaW5kZXg6IG51bWJlcikgPT4ge1xuICAgICAgICBjb25zdCB7IHZhbHVlIH0gPSB0aGlzLnN0YXRlO1xuICAgICAgICBjb25zdCBrZXlzID0gQXJyYXkuZnJvbSh2YWx1ZS5rZXlzKCkpO1xuICAgICAgICBpbmRleCA9IGluZGV4ID49IDAgPyBpbmRleCA6IGtleXMubGVuZ3RoICsgaW5kZXg7XG4gICAgICAgIGlmIChpbmRleCA+PSAwICYmIGluZGV4IDwga2V5cy5sZW5ndGgpIHtcbiAgICAgICAgICAgIHZhbHVlLnNwbGljZShpbmRleCwgMSk7XG4gICAgICAgICAgICBjb25zdCBuZXdWYWx1ZSA9IFsuLi52YWx1ZV07XG4gICAgICAgICAgICB0aGlzLnVwZGF0ZVZhbHVlKG5ld1ZhbHVlKTtcbiAgICAgICAgfVxuICAgIH07XG4gICAgcHJpdmF0ZSB1cGRhdGVWYWx1ZShuZXdWYWx1ZTogQXJyYXk8VD4pIHtcbiAgICAgICAgY29uc3QgeyBvbkNoYW5nZSwgbmFtZSA9ICcnLCBmb3JtIH0gPSB0aGlzLnByb3BzO1xuICAgICAgICBpZiAoIXRoaXMuc3RhdGUuY29udHJvbGxlZCkge1xuICAgICAgICAgICAgaWYgKGZvcm0pIHtcbiAgICAgICAgICAgICAgICBmb3JtLmNoYW5nZSh7XG4gICAgICAgICAgICAgICAgICAgIG5hbWUsXG4gICAgICAgICAgICAgICAgICAgIHZhbHVlOiBuZXdWYWx1ZSxcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgICAgICAgICB2YWx1ZTogbmV3VmFsdWUsXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMuX2lucHV0Tm9kZSkge1xuICAgICAgICAgICAgdGhpcy5faW5wdXROb2RlLmZvY3VzKCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHR5cGVvZiBvbkNoYW5nZSA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgICAgb25DaGFuZ2UoeyB2YWx1ZTogbmV3VmFsdWUgfSk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcHJpdmF0ZSBjaGFuZ2VJbnB1dFZhbHVlKG5ld1ZhbHVlOiBzdHJpbmcpIHtcbiAgICAgICAgaWYgKCF0aGlzLnN0YXRlLmNvbnRyb2xsZWQpIHtcbiAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgICAgIGlucHV0VmFsdWU6IG5ld1ZhbHVlLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5fZmlyZU9uSW5wdXRDaGFuZ2UobmV3VmFsdWUpO1xuICAgIH1cbiAgICBwcml2YXRlIGdldFN1Z2dlc3Rpb25WYWx1ZShpdGVtOiBUKSB7XG4gICAgICAgIGNvbnN0IHsgZ2V0U3VnZ2VzdGlvblZhbHVlIH0gPSB0aGlzLnByb3BzO1xuICAgICAgICBpZiAodHlwZW9mIGl0ZW0gPT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICByZXR1cm4gaXRlbTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIGlmICh0eXBlb2YgZ2V0U3VnZ2VzdGlvblZhbHVlID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICByZXR1cm4gZ2V0U3VnZ2VzdGlvblZhbHVlKGl0ZW0pO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdHZXQgc3VnZ2VzdGlvbiB2YWx1ZSBzaG91bGQgYmUgc3BlY2lmaWVkJyk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcHJpdmF0ZSBnZXRTdWdnZXN0aW9uS2V5KGl0ZW06IFQpIHtcbiAgICAgICAgY29uc3QgeyBnZXRTdWdnZXN0aW9uS2V5IH0gPSB0aGlzLnByb3BzO1xuICAgICAgICBpZiAodHlwZW9mIGl0ZW0gPT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICByZXR1cm4gaXRlbTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIGlmICh0eXBlb2YgZ2V0U3VnZ2VzdGlvbktleSA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgICAgcmV0dXJuIGdldFN1Z2dlc3Rpb25LZXkoaXRlbSk7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0dldCBzdWdnZXN0aW9uIGtleSBzaG91bGQgYmUgc3BlY2lmaWVkJyk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcHJpdmF0ZSBnZXRUYWdzQXJyYXkgPSBtZW1vaXplKCh2YWx1ZTogQXJyYXk8VD4pID0+IHtcbiAgICAgICAgcmV0dXJuIHZhbHVlLm1hcCh4ID0+IHRoaXMuZ2V0U3VnZ2VzdGlvblZhbHVlKHgpKTtcbiAgICB9KTtcbiAgICBwcml2YXRlIGRlZmF1bHRTdWdnZXN0aW9uUmVuZGVyZXIoc3VnZ2VzdGlvbjogVCkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgY29udGVudDogdGhpcy5nZXRTdWdnZXN0aW9uVmFsdWUoc3VnZ2VzdGlvbiksXG4gICAgICAgICAgICBrZXk6IHRoaXMuZ2V0U3VnZ2VzdGlvbktleShzdWdnZXN0aW9uKSxcbiAgICAgICAgfTtcbiAgICB9XG4gICAgcHJpdmF0ZSB0YWdSZW1vdmVIYW5kbGVyID0gKGluZGV4OiBudW1iZXIpID0+IHtcbiAgICAgICAgdGhpcy5yZW1vdmVWYWx1ZUJ5SW5kZXgoaW5kZXgpO1xuICAgIH07XG4gICAgcHJpdmF0ZSBzdWdnZXN0aW9uU2VsZWN0ZWRIYW5kbGVyID0gKGU6IEF1dG9zdWdnZXN0U2VsZWN0RXZlbnQ8VD4pID0+IHtcbiAgICAgICAgdGhpcy5hZGRTdWdnZXN0aW9uKGUudmFsdWUpO1xuICAgIH07XG4gICAgcHJpdmF0ZSBpbnB1dENoYW5nZUhhbmRsZXIgPSAoZTogSW5wdXRDaGFuZ2VFdmVudDxzdHJpbmc+KSA9PiB7XG4gICAgICAgIHRoaXMuY2hhbmdlSW5wdXRWYWx1ZShlLnZhbHVlKTtcbiAgICB9O1xuICAgIHByaXZhdGUgaW5wdXRSZWZIYW5kbGVyID0gKG5vZGU6IEhUTUxFbGVtZW50IHwgbnVsbCkgPT4ge1xuICAgICAgICB0aGlzLl9pbnB1dE5vZGUgPSBub2RlO1xuICAgIH07XG4gICAgcHJpdmF0ZSB0YWdCdWlsZGVyUmVuZGVyZXIgPSAoaW5wdXRQcm9wczogQXV0b2NvbXBsZXRlSW5wdXRQcm9wcykgPT4ge1xuICAgICAgICBjb25zdCB7IGRpc2FibGVkLCB0YWdSZW5kZXJlciwgYm9yZGVybGVzcyA9IGZhbHNlIH0gPSB0aGlzLnByb3BzO1xuICAgICAgICBjb25zdCB7IHZhbHVlIH0gPSB0aGlzLnN0YXRlO1xuICAgICAgICBjb25zdCB7IG9uQ2hhbmdlLCB2YWx1ZTogaW5wdXRWYWx1ZSwgLi4ucmVzdFByb3BzIH0gPSBpbnB1dFByb3BzO1xuICAgICAgICBjb25zdCB0YWdCdWlsZGVyVmFsdWUgPSB0aGlzLmdldFRhZ3NBcnJheSh2YWx1ZSk7XG4gICAgICAgIHJldHVybiAoPFRhZ0J1aWxkZXIgey4uLnJlc3RQcm9wc30gZGlzYWJsZWQ9e2Rpc2FibGVkfSBpbnB1dFZhbHVlPXtpbnB1dFZhbHVlfSBvbklucHV0PXtvbkNoYW5nZX0gdmFsdWU9e3RhZ0J1aWxkZXJWYWx1ZX0gdGFnUmVuZGVyZXI9e3RhZ1JlbmRlcmVyfSBib3JkZXJsZXNzPXtib3JkZXJsZXNzfSBvbkJlZm9yZVRhZ1JlbW92ZT17dGhpcy50YWdSZW1vdmVIYW5kbGVyfS8+KTtcbiAgICB9O1xuICAgIHB1YmxpYyByZW5kZXIoKSB7XG4gICAgICAgIGNvbnN0IHsgc3VnZ2VzdGlvbnMgPSBbXSwgbm9TdWdnZXN0aW9uc01lc3NhZ2UsIGRpc2FibGVkLCByZW5kZXJTdWdnZXN0aW9uID0gKGl0ZW06IFQpID0+IHRoaXMuZGVmYXVsdFN1Z2dlc3Rpb25SZW5kZXJlcihpdGVtKSwgbGFiZWwsIHBsYWNlaG9sZGVyLCBpbmZvLCBib3JkZXJsZXNzID0gZmFsc2UsIGVycm9yLCBvbkJsdXIsIG9uRm9jdXMsIH0gPSB0aGlzLnByb3BzO1xuICAgICAgICBjb25zdCB7IGlucHV0VmFsdWUgfSA9IHRoaXMuc3RhdGU7XG4gICAgICAgIHJldHVybiAoPEF1dG9jb21wbGV0ZSBub1N1Z2dlc3Rpb25zTWVzc2FnZT17bm9TdWdnZXN0aW9uc01lc3NhZ2V9IHN1Z2dlc3Rpb25zPXtzdWdnZXN0aW9uc30gaW5wdXRSZW5kZXJlcj17dGhpcy50YWdCdWlsZGVyUmVuZGVyZXJ9IHJlbmRlclN1Z2dlc3Rpb249e3JlbmRlclN1Z2dlc3Rpb259IGRpc2FibGVkPXtkaXNhYmxlZH0gdmFsdWU9e2lucHV0VmFsdWV9IG9uQ2hhbmdlPXt0aGlzLmlucHV0Q2hhbmdlSGFuZGxlcn0gb25TdWdnZXN0aW9uU2VsZWN0ZWQ9e3RoaXMuc3VnZ2VzdGlvblNlbGVjdGVkSGFuZGxlcn0gaW5wdXRSZWY9e3RoaXMuaW5wdXRSZWZIYW5kbGVyfSBsYWJlbD17bGFiZWx9IHBsYWNlaG9sZGVyPXtwbGFjZWhvbGRlcn0gaW5mbz17aW5mb30gZXJyb3I9e2Vycm9yfSBib3JkZXJsZXNzPXtib3JkZXJsZXNzfSBvbkJsdXI9e29uQmx1cn0gb25Gb2N1cz17b25Gb2N1c30vPik7XG4gICAgfVxuICAgIHN0YXRpYyBpbm5lciA9IHtcbiAgICAgICAgZ2V0IFRhZ0J1aWxkZXIoKSB7IHJldHVybiBUYWdCdWlsZGVyIGFzIHR5cGVvZiBUYWdCdWlsZGVyOyB9LFxuICAgICAgICBnZXQgQXV0b2NvbXBsZXRlKCkgeyByZXR1cm4gQXV0b2NvbXBsZXRlIGFzIHR5cGVvZiBBdXRvY29tcGxldGU7IH1cbiAgICB9O1xufVxuIl19