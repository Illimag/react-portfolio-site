import * as React from 'react';
import styled, { themed } from '../../utils/styled';
import { showInputInfo } from '../../utils/input';
import { lowerize } from '../../utils/text';
import { Icon } from '../Icon';
import { InputIcon } from '../InputIcon';
import { transparent, dark, purpleRed } from '../../colors';
import { distance } from '../../distance';
import { withFormContext } from '../../hoc/withFormContext';
import { StyledInputRow, StyledInputBox, getTextFieldBorderType, StyledTagItem } from '../../quarks';
import { getFontStyle, getFontSize } from '../../textStyles';
const finishTagKeys = [13 /* enter */, 32 /* space */, 188 /* comma */, 186 /* semicolon */];
const StyledIcon = styled(Icon) `
  ${getFontStyle({ size: 'small' })}

  cursor: pointer;
  vertical-align: middle;
  color: ${themed(props => props.theme.ui5)};
  font-family: ${themed(props => props.theme.fontFamily)};
  margin-left: ${distance.small};
`;
const TagBuilderContainer = styled.div ``;
function getContainerPadding(props) {
    const { tagRenderer, labelShown } = props;
    if (!tagRenderer) {
        return !labelShown
            ? `${distance.medium} ${distance.medium} ${distance.small}`
            : `${distance.large} ${distance.medium} 0`;
    }
    return !labelShown ? `${distance.medium}` : `${distance.large} ${distance.medium} ${distance.small}`;
}
const StyledTagsContainer = styled.div `
  padding: ${getContainerPadding};
  margin: 0;
  width: 100%;
  height: 100%;
  box-sizing: border-box;
  display: flex;
  flex-wrap: wrap;
  align-items: center;
`;
const StyledInput = styled('input') `
  ${getFontSize('medium')}
  box-sizing: content-box;
  box-shadow: none;
  border: none;
  border-radius: 0;
  margin: 0;
  outline: none;
  outline-color: transparent !important;
  background: ${transparent};
  width: ${props => (props.value.length > 2 ? props.value.length * 10 + 'px' : '20px')};
  color: ${themed(({ disabled, theme, valid }) => (valid ? (disabled ? theme.textDisabled : dark) : purpleRed))};
  cursor: ${props => (props.disabled ? 'not-allowed' : 'auto')};
  font-family: inherit;
`;
const RestyledTagItem = styled(StyledTagItem) `
  margin: 0 ${distance.small} ${distance.small} 0;
`;
const InputContainer = styled('div') `
  display: inline;
  padding-bottom: ${({ tagRenderer }) => (!tagRenderer ? `${distance.small}` : '0')};
`;
const StyledText = styled.span `
  display: inline-block;
  vertical-align: middle;
`;
const CloseIcon = Object.assign((({ theme, onClick, onMouseDown }) => (React.createElement(StyledIcon, { theme: theme, name: "Close", onClick: onClick, onMouseDown: onMouseDown }))), { inner: {
        get StyledIcon() { return StyledIcon; }
    } });
export class TagBuilderInt extends React.Component {
    constructor(props) {
        super(props);
        this.inputChanged = (e) => {
            const { onInput } = this.props;
            const { controlled, value: prevTags } = this.state;
            const { value } = e.currentTarget;
            if (typeof onInput === 'function') {
                onInput({ value: value });
            }
            if (!controlled) {
                this.setState({ inputValue: value, valid: value.length > 0 ? prevTags.indexOf(value) === -1 : true });
            }
        };
        this.keyDownHandler = (e) => {
            const { inputValue, controlled } = this.state;
            const { shouldFinishTag } = this.props;
            let isHandled = false;
            const handleKeyEvent = () => {
                e.stopPropagation();
                e.preventDefault();
                isHandled = true;
            };
            if (inputValue.length === 0) {
                switch (e.keyCode) {
                    case 8 /* backspace */:
                        this.removePrevTag();
                        handleKeyEvent();
                        break;
                    case 46 /* delete */:
                        this.removeNextTag();
                        handleKeyEvent();
                        break;
                }
            }
            if (!isHandled && !controlled) {
                if (typeof shouldFinishTag === 'function') {
                    if (shouldFinishTag(e)) {
                        this.addTag(inputValue);
                        handleKeyEvent();
                        return;
                    }
                }
                else if (finishTagKeys.indexOf(e.keyCode) !== -1) {
                    this.addTag(inputValue);
                    handleKeyEvent();
                }
                if (inputValue.length === 0) {
                    switch (e.keyCode) {
                        case 35 /* end */:
                            this.inputMoveEnd();
                            handleKeyEvent();
                            break;
                        case 36 /* home */:
                            this.inputMoveHome();
                            handleKeyEvent();
                            break;
                        case 37 /* left */:
                            this.inputMoveLeft();
                            handleKeyEvent();
                            break;
                        case 39 /* right */:
                            this.inputMoveRight();
                            handleKeyEvent();
                            break;
                    }
                }
            }
        };
        this.inputFocused = () => {
            const { onFocus } = this.props;
            this.setState({
                focused: true,
            }, onFocus);
        };
        this.inputBlurred = () => {
            const { onBlur, appendTagOnBlur } = this.props;
            if (!!appendTagOnBlur && !this.state.controlled) {
                const { inputValue } = this.state;
                if (inputValue) {
                    this.addTag(inputValue);
                }
            }
            this.setState({
                focused: false,
            }, onBlur);
        };
        this.setFocus = () => {
            this._input && this._input.focus();
        };
        this.removeTagMouseDownHandler = (event) => {
            event.preventDefault();
        };
        this.renderTag = (e) => {
            const { theme, disabled } = this.props;
            return (React.createElement(RestyledTagItem, { theme: theme, key: e.item + e.index },
                React.createElement(StyledText, null, e.item),
                !disabled && (React.createElement(CloseIcon, { theme: theme, onMouseDown: this.removeTagMouseDownHandler, onClick: () => this.removeTag(e.index) }))));
        };
        this.setContainer = (node) => {
            this._input = node;
            const { inputRef } = this.props;
            if (typeof inputRef === 'function') {
                inputRef(node);
            }
        };
        const tags = (props.value || props.defaultValue || []).map(lowerize);
        this.state = {
            value: tags,
            inputValue: props.inputValue || '',
            controlled: props.value !== undefined || props.inputValue !== undefined,
            focused: false,
            valid: true,
            error: props.error,
        };
    }
    UNSAFE_componentWillReceiveProps({ value, inputValue = '', error }) {
        if (this.state.controlled && value !== undefined) {
            this.setState({
                value: [...value],
                inputValue: inputValue,
            });
        }
        this.setState({ error });
    }
    componentDidMount() {
        const { form } = this.props;
        const { controlled } = this.state;
        if (!controlled && form) {
            form.subscribe(this);
        }
    }
    componentWillUnmount() {
        const { form } = this.props;
        const { controlled } = this.state;
        if (!controlled && form) {
            form.unsubscribe(this);
        }
    }
    fireBeforeTagRemoveEvent(index) {
        const { onBeforeTagRemove } = this.props;
        if (typeof onBeforeTagRemove === 'function') {
            onBeforeTagRemove(index);
        }
    }
    inputMoveLeft() {
        const { value } = this.state;
        const { inputPosition = value.length } = this.state;
        if (inputPosition > 0) {
            this.setState({ inputPosition: inputPosition - 1 });
        }
    }
    inputMoveRight() {
        const { value, inputPosition } = this.state;
        if (inputPosition !== undefined && inputPosition < value.length) {
            this.setState({ inputPosition: inputPosition + 1 });
        }
    }
    inputMoveEnd() {
        const { value } = this.state;
        this.setState({ inputPosition: value.length });
    }
    inputMoveHome() {
        this.setState({ inputPosition: 0 });
    }
    addTag(inputValue) {
        const { value: prevTags, valid } = this.state;
        const { inputPosition = prevTags.length } = this.state;
        inputValue = inputValue.trim().toLowerCase();
        if (inputValue.length > 0 && valid) {
            const tags = [...prevTags];
            tags.splice(inputPosition, 0, inputValue);
            this.setState({ inputValue: '', inputPosition: inputPosition + 1 }, () => this.onChange(tags));
        }
    }
    removePrevTag() {
        const { value: prevTags } = this.state;
        const { inputPosition = prevTags.length } = this.state;
        if (inputPosition > 0) {
            this.removeTag(inputPosition - 1);
            this.setState({ inputPosition: inputPosition - 1 });
        }
    }
    removeNextTag() {
        const { value: prevTags, inputPosition } = this.state;
        if (inputPosition !== undefined && inputPosition < prevTags.length) {
            this.removeTag(inputPosition);
        }
    }
    removeTag(index) {
        const { value: prevTags } = this.state;
        this.fireBeforeTagRemoveEvent(index);
        const tags = [...prevTags.slice(0, index), ...prevTags.slice(index + 1)];
        this.onChange(tags);
    }
    onChange(value) {
        const { onChange, name = '', form } = this.props;
        if (!this.state.controlled) {
            if (form) {
                form.change({
                    name,
                    value,
                });
            }
            else {
                this.setState({
                    value,
                });
            }
        }
        if (typeof onChange === 'function') {
            onChange({
                value,
            });
        }
    }
    render() {
        const { tagRenderer, info, disabled, borderless, theme, label, placeholder } = this.props;
        const { value, inputValue, focused, valid, error } = this.state;
        const { inputPosition = value.length } = this.state;
        const border = getTextFieldBorderType(borderless, !!error, focused);
        const renderer = tagRenderer || this.renderTag;
        const children = value.map((item, index) => renderer({ item, index, tags: value }));
        const hasValue = !!inputValue || value.length > 0;
        children.splice(inputPosition, 0, React.createElement(InputContainer, { key: "input", onKeyDown: this.keyDownHandler, tagRenderer: !!tagRenderer },
            React.createElement(StyledInput, { theme: theme, disabled: disabled, ref: this.setContainer, type: "text", value: inputValue, onChange: this.inputChanged, onFocus: this.inputFocused, onBlur: this.inputBlurred, valid: valid })));
        return (React.createElement(TagBuilderContainer, null,
            React.createElement(StyledInputBox, { border: border, disabled: disabled, focused: focused, hasValue: hasValue },
                React.createElement(StyledInputRow, { onClick: this.setFocus, label: label, hasValue: hasValue, placeholder: placeholder, error: !!error, focused: focused },
                    React.createElement(StyledTagsContainer, { labelShown: !!label, tagRenderer: !!tagRenderer }, children)),
                React.createElement(InputIcon, { disabled: disabled, theme: theme, error: error, hasValue: hasValue })),
            showInputInfo(error, info)));
    }
}
TagBuilderInt.inner = {
    get RestyledTagItem() { return RestyledTagItem; },
    get StyledText() { return StyledText; },
    get CloseIcon() { return CloseIcon; },
    get InputContainer() { return InputContainer; },
    get StyledInput() { return StyledInput; },
    get TagBuilderContainer() { return TagBuilderContainer; },
    get StyledInputBox() { return StyledInputBox; },
    get StyledInputRow() { return StyledInputRow; },
    get StyledTagsContainer() { return StyledTagsContainer; },
    get InputIcon() { return InputIcon; }
};
export const TagBuilder = withFormContext(TagBuilderInt);
TagBuilder.displayName = 'TagBuilder';
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVGFnQnVpbGRlckludC5wYXJ0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2NvbXBvbmVudHMvVGFnQnVpbGRlci9UYWdCdWlsZGVySW50LnBhcnQudHN4Il0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sS0FBSyxLQUFLLE1BQU0sT0FBTyxDQUFDO0FBQy9CLE9BQU8sTUFBTSxFQUFFLEVBQUUsTUFBTSxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFFcEQsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBRWxELE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUM1QyxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBQy9CLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFDekMsT0FBTyxFQUFFLFdBQVcsRUFBRSxJQUFJLEVBQUUsU0FBUyxFQUFFLE1BQU0sY0FBYyxDQUFDO0FBQzVELE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUMxQyxPQUFPLEVBQW9CLGVBQWUsRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBRTlFLE9BQU8sRUFBRSxjQUFjLEVBQUUsY0FBYyxFQUFFLHNCQUFzQixFQUFFLGFBQWEsRUFBRSxNQUFNLGNBQWMsQ0FBQztBQUNyRyxPQUFPLEVBQUUsWUFBWSxFQUFFLFdBQVcsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQzdELE1BQU0sYUFBYSxHQUFHLHNFQUFvRSxDQUFDO0FBQzNGLE1BQU0sVUFBVSxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUM1QixZQUFZLENBQUMsRUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFFLENBQUM7Ozs7V0FJeEIsTUFBTSxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUM7aUJBQzFCLE1BQU0sQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFDO2lCQUN2QyxRQUFRLENBQUMsS0FBSztDQUM5QixDQUFDO0FBQ0YsTUFBTSxtQkFBbUIsR0FBRyxNQUFNLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQztBQUsxQyxTQUFTLG1CQUFtQixDQUFDLEtBQStCO0lBQ3hELE1BQU0sRUFBRSxXQUFXLEVBQUUsVUFBVSxFQUFFLEdBQUcsS0FBSyxDQUFDO0lBQzFDLElBQUksQ0FBQyxXQUFXLEVBQUU7UUFDZCxPQUFPLENBQUMsVUFBVTtZQUNkLENBQUMsQ0FBQyxHQUFHLFFBQVEsQ0FBQyxNQUFNLElBQUksUUFBUSxDQUFDLE1BQU0sSUFBSSxRQUFRLENBQUMsS0FBSyxFQUFFO1lBQzNELENBQUMsQ0FBQyxHQUFHLFFBQVEsQ0FBQyxLQUFLLElBQUksUUFBUSxDQUFDLE1BQU0sSUFBSSxDQUFDO0tBQ2xEO0lBQ0QsT0FBTyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsR0FBRyxRQUFRLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQyxDQUFDLEdBQUcsUUFBUSxDQUFDLEtBQUssSUFBSSxRQUFRLENBQUMsTUFBTSxJQUFJLFFBQVEsQ0FBQyxLQUFLLEVBQUUsQ0FBQztBQUN6RyxDQUFDO0FBQ0QsTUFBTSxtQkFBbUIsR0FBRyxNQUFNLENBQUMsR0FBRyxDQUFDO2FBQzFCLG1CQUFtQjs7Ozs7Ozs7Q0FRL0IsQ0FBQztBQU9GLE1BQU0sV0FBVyxHQUFHLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBbUI7SUFDbEQsV0FBVyxDQUFDLFFBQVEsQ0FBQzs7Ozs7Ozs7Z0JBUVQsV0FBVztXQUNoQixLQUFLLENBQUMsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLE1BQU0sR0FBRyxFQUFFLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUM7V0FDM0UsTUFBTSxDQUFDLENBQUMsRUFBRSxRQUFRLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUNuRyxLQUFLLENBQUMsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUM7O0NBRTdELENBQUM7QUFDRixNQUFNLGVBQWUsR0FBRyxNQUFNLENBQUMsYUFBYSxDQUFDLENBQUM7Y0FDaEMsUUFBUSxDQUFDLEtBQUssSUFBSSxRQUFRLENBQUMsS0FBSztDQUM3QyxDQUFDO0FBSUYsTUFBTSxjQUFjLEdBQUcsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFzQjs7b0JBRXRDLENBQUMsRUFBRSxXQUFXLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsR0FBRyxRQUFRLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQztDQUNsRixDQUFDO0FBQ0YsTUFBTSxVQUFVLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQzs7O0NBRzlCLENBQUM7QUFNRixNQUFNLFNBQVMsR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFFLENBQUMsQ0FBQyxFQUFFLEtBQUssRUFBRSxPQUFPLEVBQUUsV0FBVyxFQUFFLEVBQUUsRUFBRSxDQUFDLENBQUMsb0JBQUMsVUFBVSxJQUFDLEtBQUssRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFDLE9BQU8sRUFBQyxPQUFPLEVBQUUsT0FBTyxFQUFFLFdBQVcsRUFBRSxXQUFXLEdBQUcsQ0FBQyxDQUErQixFQUFFLEVBQUUsS0FBSyxFQUFFO1FBQy9MLElBQUksVUFBVSxLQUFLLE9BQU8sVUFBK0IsQ0FBQyxDQUFDLENBQUM7S0FDL0QsRUFBRSxDQUFDLENBQUM7QUFVVCxNQUFNLE9BQU8sYUFBYyxTQUFRLEtBQUssQ0FBQyxTQUE4RDtJQUVuRyxZQUFZLEtBQXNCO1FBQzlCLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztRQXdDVCxpQkFBWSxHQUFHLENBQUMsQ0FBc0MsRUFBRSxFQUFFO1lBQzlELE1BQU0sRUFBRSxPQUFPLEVBQUUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDO1lBQy9CLE1BQU0sRUFBRSxVQUFVLEVBQUUsS0FBSyxFQUFFLFFBQVEsRUFBRSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUM7WUFDbkQsTUFBTSxFQUFFLEtBQUssRUFBRSxHQUFHLENBQUMsQ0FBQyxhQUFhLENBQUM7WUFDbEMsSUFBSSxPQUFPLE9BQU8sS0FBSyxVQUFVLEVBQUU7Z0JBQy9CLE9BQU8sQ0FBQyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDO2FBQzdCO1lBQ0QsSUFBSSxDQUFDLFVBQVUsRUFBRTtnQkFDYixJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUUsVUFBVSxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsS0FBSyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUM7YUFDekc7UUFDTCxDQUFDLENBQUM7UUFDTSxtQkFBYyxHQUFHLENBQUMsQ0FBc0MsRUFBRSxFQUFFO1lBQ2hFLE1BQU0sRUFBRSxVQUFVLEVBQUUsVUFBVSxFQUFFLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQztZQUM5QyxNQUFNLEVBQUUsZUFBZSxFQUFFLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQztZQUN2QyxJQUFJLFNBQVMsR0FBRyxLQUFLLENBQUM7WUFDdEIsTUFBTSxjQUFjLEdBQUcsR0FBRyxFQUFFO2dCQUN4QixDQUFDLENBQUMsZUFBZSxFQUFFLENBQUM7Z0JBQ3BCLENBQUMsQ0FBQyxjQUFjLEVBQUUsQ0FBQztnQkFDbkIsU0FBUyxHQUFHLElBQUksQ0FBQztZQUNyQixDQUFDLENBQUM7WUFDRixJQUFJLFVBQVUsQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO2dCQUN6QixRQUFRLENBQUMsQ0FBQyxPQUFPLEVBQUU7b0JBQ2Y7d0JBQ0ksSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO3dCQUNyQixjQUFjLEVBQUUsQ0FBQzt3QkFDakIsTUFBTTtvQkFDVjt3QkFDSSxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7d0JBQ3JCLGNBQWMsRUFBRSxDQUFDO3dCQUNqQixNQUFNO2lCQUNiO2FBQ0o7WUFDRCxJQUFJLENBQUMsU0FBUyxJQUFJLENBQUMsVUFBVSxFQUFFO2dCQUMzQixJQUFJLE9BQU8sZUFBZSxLQUFLLFVBQVUsRUFBRTtvQkFDdkMsSUFBSSxlQUFlLENBQUMsQ0FBQyxDQUFDLEVBQUU7d0JBQ3BCLElBQUksQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLENBQUM7d0JBQ3hCLGNBQWMsRUFBRSxDQUFDO3dCQUNqQixPQUFPO3FCQUNWO2lCQUNKO3FCQUNJLElBQUksYUFBYSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUU7b0JBQzlDLElBQUksQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLENBQUM7b0JBQ3hCLGNBQWMsRUFBRSxDQUFDO2lCQUNwQjtnQkFDRCxJQUFJLFVBQVUsQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO29CQUN6QixRQUFRLENBQUMsQ0FBQyxPQUFPLEVBQUU7d0JBQ2Y7NEJBQ0ksSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDOzRCQUNwQixjQUFjLEVBQUUsQ0FBQzs0QkFDakIsTUFBTTt3QkFDVjs0QkFDSSxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7NEJBQ3JCLGNBQWMsRUFBRSxDQUFDOzRCQUNqQixNQUFNO3dCQUNWOzRCQUNJLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQzs0QkFDckIsY0FBYyxFQUFFLENBQUM7NEJBQ2pCLE1BQU07d0JBQ1Y7NEJBQ0ksSUFBSSxDQUFDLGNBQWMsRUFBRSxDQUFDOzRCQUN0QixjQUFjLEVBQUUsQ0FBQzs0QkFDakIsTUFBTTtxQkFDYjtpQkFDSjthQUNKO1FBQ0wsQ0FBQyxDQUFDO1FBQ00saUJBQVksR0FBRyxHQUFHLEVBQUU7WUFDeEIsTUFBTSxFQUFFLE9BQU8sRUFBRSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUM7WUFDL0IsSUFBSSxDQUFDLFFBQVEsQ0FBQztnQkFDVixPQUFPLEVBQUUsSUFBSTthQUNoQixFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBQ2hCLENBQUMsQ0FBQztRQUNNLGlCQUFZLEdBQUcsR0FBRyxFQUFFO1lBQ3hCLE1BQU0sRUFBRSxNQUFNLEVBQUUsZUFBZSxFQUFFLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQztZQUMvQyxJQUFJLENBQUMsQ0FBQyxlQUFlLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLFVBQVUsRUFBRTtnQkFDN0MsTUFBTSxFQUFFLFVBQVUsRUFBRSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUM7Z0JBQ2xDLElBQUksVUFBVSxFQUFFO29CQUNaLElBQUksQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLENBQUM7aUJBQzNCO2FBQ0o7WUFDRCxJQUFJLENBQUMsUUFBUSxDQUFDO2dCQUNWLE9BQU8sRUFBRSxLQUFLO2FBQ2pCLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFDZixDQUFDLENBQUM7UUFxQk0sYUFBUSxHQUFHLEdBQUcsRUFBRTtZQUNwQixJQUFJLENBQUMsTUFBTSxJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxFQUFFLENBQUM7UUFDdkMsQ0FBQyxDQUFDO1FBb0RNLDhCQUF5QixHQUFHLENBQUMsS0FBdUIsRUFBRSxFQUFFO1lBQzVELEtBQUssQ0FBQyxjQUFjLEVBQUUsQ0FBQztRQUMzQixDQUFDLENBQUM7UUFDTSxjQUFTLEdBQUcsQ0FBQyxDQUF3QixFQUFFLEVBQUU7WUFDN0MsTUFBTSxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDO1lBQ3ZDLE9BQU8sQ0FBQyxvQkFBQyxlQUFlLElBQUMsS0FBSyxFQUFFLEtBQUssRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDLElBQUksR0FBRyxDQUFDLENBQUMsS0FBSztnQkFDNUQsb0JBQUMsVUFBVSxRQUFFLENBQUMsQ0FBQyxJQUFJLENBQWM7Z0JBQ2hDLENBQUMsUUFBUSxJQUFJLENBQUMsb0JBQUMsU0FBUyxJQUFDLEtBQUssRUFBRSxLQUFLLEVBQUUsV0FBVyxFQUFFLElBQUksQ0FBQyx5QkFBeUIsRUFBRSxPQUFPLEVBQUUsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUMvRyxDQUFDLENBQUM7UUFDdEIsQ0FBQyxDQUFDO1FBQ00saUJBQVksR0FBRyxDQUFDLElBQTZCLEVBQUUsRUFBRTtZQUNyRCxJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQztZQUNuQixNQUFNLEVBQUUsUUFBUSxFQUFFLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQztZQUNoQyxJQUFJLE9BQU8sUUFBUSxLQUFLLFVBQVUsRUFBRTtnQkFDaEMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDO2FBQ2xCO1FBQ0wsQ0FBQyxDQUFDO1FBck5FLE1BQU0sSUFBSSxHQUFHLENBQUMsS0FBSyxDQUFDLEtBQUssSUFBSSxLQUFLLENBQUMsWUFBWSxJQUFJLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUNyRSxJQUFJLENBQUMsS0FBSyxHQUFHO1lBQ1QsS0FBSyxFQUFFLElBQUk7WUFDWCxVQUFVLEVBQUUsS0FBSyxDQUFDLFVBQVUsSUFBSSxFQUFFO1lBQ2xDLFVBQVUsRUFBRSxLQUFLLENBQUMsS0FBSyxLQUFLLFNBQVMsSUFBSSxLQUFLLENBQUMsVUFBVSxLQUFLLFNBQVM7WUFDdkUsT0FBTyxFQUFFLEtBQUs7WUFDZCxLQUFLLEVBQUUsSUFBSTtZQUNYLEtBQUssRUFBRSxLQUFLLENBQUMsS0FBSztTQUNyQixDQUFDO0lBQ04sQ0FBQztJQUNELGdDQUFnQyxDQUFDLEVBQUUsS0FBSyxFQUFFLFVBQVUsR0FBRyxFQUFFLEVBQUUsS0FBSyxFQUFtQjtRQUMvRSxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsVUFBVSxJQUFJLEtBQUssS0FBSyxTQUFTLEVBQUU7WUFDOUMsSUFBSSxDQUFDLFFBQVEsQ0FBQztnQkFDVixLQUFLLEVBQUUsQ0FBQyxHQUFHLEtBQUssQ0FBQztnQkFDakIsVUFBVSxFQUFFLFVBQVU7YUFDekIsQ0FBQyxDQUFDO1NBQ047UUFDRCxJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQztJQUM3QixDQUFDO0lBQ0QsaUJBQWlCO1FBQ2IsTUFBTSxFQUFFLElBQUksRUFBRSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUM7UUFDNUIsTUFBTSxFQUFFLFVBQVUsRUFBRSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUM7UUFDbEMsSUFBSSxDQUFDLFVBQVUsSUFBSSxJQUFJLEVBQUU7WUFDckIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUN4QjtJQUNMLENBQUM7SUFDRCxvQkFBb0I7UUFDaEIsTUFBTSxFQUFFLElBQUksRUFBRSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUM7UUFDNUIsTUFBTSxFQUFFLFVBQVUsRUFBRSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUM7UUFDbEMsSUFBSSxDQUFDLFVBQVUsSUFBSSxJQUFJLEVBQUU7WUFDckIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUMxQjtJQUNMLENBQUM7SUFDTyx3QkFBd0IsQ0FBQyxLQUFhO1FBQzFDLE1BQU0sRUFBRSxpQkFBaUIsRUFBRSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUM7UUFDekMsSUFBSSxPQUFPLGlCQUFpQixLQUFLLFVBQVUsRUFBRTtZQUN6QyxpQkFBaUIsQ0FBQyxLQUFLLENBQUMsQ0FBQztTQUM1QjtJQUNMLENBQUM7SUFxRk8sYUFBYTtRQUNqQixNQUFNLEVBQUUsS0FBSyxFQUFFLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQztRQUM3QixNQUFNLEVBQUUsYUFBYSxHQUFHLEtBQUssQ0FBQyxNQUFNLEVBQUUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDO1FBQ3BELElBQUksYUFBYSxHQUFHLENBQUMsRUFBRTtZQUNuQixJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUUsYUFBYSxFQUFFLGFBQWEsR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1NBQ3ZEO0lBQ0wsQ0FBQztJQUNPLGNBQWM7UUFDbEIsTUFBTSxFQUFFLEtBQUssRUFBRSxhQUFhLEVBQUUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDO1FBQzVDLElBQUksYUFBYSxLQUFLLFNBQVMsSUFBSSxhQUFhLEdBQUcsS0FBSyxDQUFDLE1BQU0sRUFBRTtZQUM3RCxJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUUsYUFBYSxFQUFFLGFBQWEsR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1NBQ3ZEO0lBQ0wsQ0FBQztJQUNPLFlBQVk7UUFDaEIsTUFBTSxFQUFFLEtBQUssRUFBRSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUM7UUFDN0IsSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUFFLGFBQWEsRUFBRSxLQUFLLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQztJQUNuRCxDQUFDO0lBQ08sYUFBYTtRQUNqQixJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUUsYUFBYSxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDeEMsQ0FBQztJQUlPLE1BQU0sQ0FBQyxVQUFrQjtRQUM3QixNQUFNLEVBQUUsS0FBSyxFQUFFLFFBQVEsRUFBRSxLQUFLLEVBQUUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDO1FBQzlDLE1BQU0sRUFBRSxhQUFhLEdBQUcsUUFBUSxDQUFDLE1BQU0sRUFBRSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUM7UUFDdkQsVUFBVSxHQUFHLFVBQVUsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUM3QyxJQUFJLFVBQVUsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxJQUFJLEtBQUssRUFBRTtZQUNoQyxNQUFNLElBQUksR0FBRyxDQUFDLEdBQUcsUUFBUSxDQUFDLENBQUM7WUFDM0IsSUFBSSxDQUFDLE1BQU0sQ0FBQyxhQUFhLEVBQUUsQ0FBQyxFQUFFLFVBQVUsQ0FBQyxDQUFDO1lBQzFDLElBQUksQ0FBQyxRQUFRLENBQUMsRUFBRSxVQUFVLEVBQUUsRUFBRSxFQUFFLGFBQWEsRUFBRSxhQUFhLEdBQUcsQ0FBQyxFQUFFLEVBQUUsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1NBQ2xHO0lBQ0wsQ0FBQztJQUNPLGFBQWE7UUFDakIsTUFBTSxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDO1FBQ3ZDLE1BQU0sRUFBRSxhQUFhLEdBQUcsUUFBUSxDQUFDLE1BQU0sRUFBRSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUM7UUFDdkQsSUFBSSxhQUFhLEdBQUcsQ0FBQyxFQUFFO1lBQ25CLElBQUksQ0FBQyxTQUFTLENBQUMsYUFBYSxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQ2xDLElBQUksQ0FBQyxRQUFRLENBQUMsRUFBRSxhQUFhLEVBQUUsYUFBYSxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUM7U0FDdkQ7SUFDTCxDQUFDO0lBQ08sYUFBYTtRQUNqQixNQUFNLEVBQUUsS0FBSyxFQUFFLFFBQVEsRUFBRSxhQUFhLEVBQUUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDO1FBQ3RELElBQUksYUFBYSxLQUFLLFNBQVMsSUFBSSxhQUFhLEdBQUcsUUFBUSxDQUFDLE1BQU0sRUFBRTtZQUNoRSxJQUFJLENBQUMsU0FBUyxDQUFDLGFBQWEsQ0FBQyxDQUFDO1NBQ2pDO0lBQ0wsQ0FBQztJQUNPLFNBQVMsQ0FBQyxLQUFhO1FBQzNCLE1BQU0sRUFBRSxLQUFLLEVBQUUsUUFBUSxFQUFFLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQztRQUN2QyxJQUFJLENBQUMsd0JBQXdCLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDckMsTUFBTSxJQUFJLEdBQUcsQ0FBQyxHQUFHLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLEtBQUssQ0FBQyxFQUFFLEdBQUcsUUFBUSxDQUFDLEtBQUssQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUN6RSxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3hCLENBQUM7SUFDTyxRQUFRLENBQUMsS0FBb0I7UUFDakMsTUFBTSxFQUFFLFFBQVEsRUFBRSxJQUFJLEdBQUcsRUFBRSxFQUFFLElBQUksRUFBRSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUM7UUFDakQsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsVUFBVSxFQUFFO1lBQ3hCLElBQUksSUFBSSxFQUFFO2dCQUNOLElBQUksQ0FBQyxNQUFNLENBQUM7b0JBQ1IsSUFBSTtvQkFDSixLQUFLO2lCQUNSLENBQUMsQ0FBQzthQUNOO2lCQUNJO2dCQUNELElBQUksQ0FBQyxRQUFRLENBQUM7b0JBQ1YsS0FBSztpQkFDUixDQUFDLENBQUM7YUFDTjtTQUNKO1FBQ0QsSUFBSSxPQUFPLFFBQVEsS0FBSyxVQUFVLEVBQUU7WUFDaEMsUUFBUSxDQUFDO2dCQUNMLEtBQUs7YUFDUixDQUFDLENBQUM7U0FDTjtJQUNMLENBQUM7SUFrQkQsTUFBTTtRQUNGLE1BQU0sRUFBRSxXQUFXLEVBQUUsSUFBSSxFQUFFLFFBQVEsRUFBRSxVQUFVLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxXQUFXLEVBQUUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDO1FBQzFGLE1BQU0sRUFBRSxLQUFLLEVBQUUsVUFBVSxFQUFFLE9BQU8sRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQztRQUNoRSxNQUFNLEVBQUUsYUFBYSxHQUFHLEtBQUssQ0FBQyxNQUFNLEVBQUUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDO1FBQ3BELE1BQU0sTUFBTSxHQUFHLHNCQUFzQixDQUFDLFVBQVUsRUFBRSxDQUFDLENBQUMsS0FBSyxFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBQ3BFLE1BQU0sUUFBUSxHQUFHLFdBQVcsSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFDO1FBQy9DLE1BQU0sUUFBUSxHQUFHLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLEVBQUUsS0FBSyxFQUFFLEVBQUUsQ0FBQyxRQUFRLENBQUMsRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDcEYsTUFBTSxRQUFRLEdBQUcsQ0FBQyxDQUFDLFVBQVUsSUFBSSxLQUFLLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQztRQUNsRCxRQUFRLENBQUMsTUFBTSxDQUFDLGFBQWEsRUFBRSxDQUFDLEVBQUUsb0JBQUMsY0FBYyxJQUFDLEdBQUcsRUFBQyxPQUFPLEVBQUMsU0FBUyxFQUFFLElBQUksQ0FBQyxjQUFjLEVBQUUsV0FBVyxFQUFFLENBQUMsQ0FBQyxXQUFXO1lBQ3hILG9CQUFDLFdBQVcsSUFBQyxLQUFLLEVBQUUsS0FBSyxFQUFFLFFBQVEsRUFBRSxRQUFRLEVBQUUsR0FBRyxFQUFFLElBQUksQ0FBQyxZQUFZLEVBQUUsSUFBSSxFQUFDLE1BQU0sRUFBQyxLQUFLLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxJQUFJLENBQUMsWUFBWSxFQUFFLE9BQU8sRUFBRSxJQUFJLENBQUMsWUFBWSxFQUFFLE1BQU0sRUFBRSxJQUFJLENBQUMsWUFBWSxFQUFFLEtBQUssRUFBRSxLQUFLLEdBQUcsQ0FDMUwsQ0FBQyxDQUFDO1FBQ2pCLE9BQU8sQ0FBQyxvQkFBQyxtQkFBbUI7WUFDNUIsb0JBQUMsY0FBYyxJQUFDLE1BQU0sRUFBRSxNQUFNLEVBQUUsUUFBUSxFQUFFLFFBQVEsRUFBRSxPQUFPLEVBQUUsT0FBTyxFQUFFLFFBQVEsRUFBRSxRQUFRO2dCQUN0RixvQkFBQyxjQUFjLElBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxRQUFRLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFFLFdBQVcsRUFBRSxXQUFXLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQyxLQUFLLEVBQUUsT0FBTyxFQUFFLE9BQU87b0JBQ2xJLG9CQUFDLG1CQUFtQixJQUFDLFVBQVUsRUFBRSxDQUFDLENBQUMsS0FBSyxFQUFFLFdBQVcsRUFBRSxDQUFDLENBQUMsV0FBVyxJQUNqRSxRQUFRLENBQ1csQ0FDUDtnQkFDakIsb0JBQUMsU0FBUyxJQUFDLFFBQVEsRUFBRSxRQUFRLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLFFBQVEsRUFBRSxRQUFRLEdBQUcsQ0FDakU7WUFDaEIsYUFBYSxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsQ0FDUCxDQUFDLENBQUM7SUFDMUIsQ0FBQzs7QUFDTSxtQkFBSyxHQUFHO0lBQ1gsSUFBSSxlQUFlLEtBQUssT0FBTyxlQUF5QyxDQUFDLENBQUMsQ0FBQztJQUMzRSxJQUFJLFVBQVUsS0FBSyxPQUFPLFVBQStCLENBQUMsQ0FBQyxDQUFDO0lBQzVELElBQUksU0FBUyxLQUFLLE9BQU8sU0FBNkIsQ0FBQyxDQUFDLENBQUM7SUFDekQsSUFBSSxjQUFjLEtBQUssT0FBTyxjQUF1QyxDQUFDLENBQUMsQ0FBQztJQUN4RSxJQUFJLFdBQVcsS0FBSyxPQUFPLFdBQWlDLENBQUMsQ0FBQyxDQUFDO0lBQy9ELElBQUksbUJBQW1CLEtBQUssT0FBTyxtQkFBaUQsQ0FBQyxDQUFDLENBQUM7SUFDdkYsSUFBSSxjQUFjLEtBQUssT0FBTyxjQUF1QyxDQUFDLENBQUMsQ0FBQztJQUN4RSxJQUFJLGNBQWMsS0FBSyxPQUFPLGNBQXVDLENBQUMsQ0FBQyxDQUFDO0lBQ3hFLElBQUksbUJBQW1CLEtBQUssT0FBTyxtQkFBaUQsQ0FBQyxDQUFDLENBQUM7SUFDdkYsSUFBSSxTQUFTLEtBQUssT0FBTyxTQUE2QixDQUFDLENBQUMsQ0FBQztDQUM1RCxDQUFDO0FBRU4sTUFBTSxDQUFDLE1BQU0sVUFBVSxHQUFHLGVBQWUsQ0FBQyxhQUFhLENBQUMsQ0FBQztBQUN6RCxVQUFVLENBQUMsV0FBVyxHQUFHLFlBQVksQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIFJlYWN0IGZyb20gJ3JlYWN0JztcbmltcG9ydCBzdHlsZWQsIHsgdGhlbWVkIH0gZnJvbSAnLi4vLi4vdXRpbHMvc3R5bGVkJztcbmltcG9ydCB7IFByZWNpc2VUaGVtZSB9IGZyb20gJy4uLy4uL2NvbW1vbic7XG5pbXBvcnQgeyBzaG93SW5wdXRJbmZvIH0gZnJvbSAnLi4vLi4vdXRpbHMvaW5wdXQnO1xuaW1wb3J0IHsgS2V5Q29kZXMgfSBmcm9tICcuLi8uLi91dGlscy9rZXlDb2Rlcyc7XG5pbXBvcnQgeyBsb3dlcml6ZSB9IGZyb20gJy4uLy4uL3V0aWxzL3RleHQnO1xuaW1wb3J0IHsgSWNvbiB9IGZyb20gJy4uL0ljb24nO1xuaW1wb3J0IHsgSW5wdXRJY29uIH0gZnJvbSAnLi4vSW5wdXRJY29uJztcbmltcG9ydCB7IHRyYW5zcGFyZW50LCBkYXJrLCBwdXJwbGVSZWQgfSBmcm9tICcuLi8uLi9jb2xvcnMnO1xuaW1wb3J0IHsgZGlzdGFuY2UgfSBmcm9tICcuLi8uLi9kaXN0YW5jZSc7XG5pbXBvcnQgeyBGb3JtQ29udGV4dFByb3BzLCB3aXRoRm9ybUNvbnRleHQgfSBmcm9tICcuLi8uLi9ob2Mvd2l0aEZvcm1Db250ZXh0JztcbmltcG9ydCB7IFRhZ0J1aWxkZXJSZW5kZXJFdmVudCwgVGFnQnVpbGRlclByb3BzIH0gZnJvbSAnLi9UYWdCdWlsZGVyLnR5cGVzLnBhcnQnO1xuaW1wb3J0IHsgU3R5bGVkSW5wdXRSb3csIFN0eWxlZElucHV0Qm94LCBnZXRUZXh0RmllbGRCb3JkZXJUeXBlLCBTdHlsZWRUYWdJdGVtIH0gZnJvbSAnLi4vLi4vcXVhcmtzJztcbmltcG9ydCB7IGdldEZvbnRTdHlsZSwgZ2V0Rm9udFNpemUgfSBmcm9tICcuLi8uLi90ZXh0U3R5bGVzJztcbmNvbnN0IGZpbmlzaFRhZ0tleXMgPSBbS2V5Q29kZXMuZW50ZXIsIEtleUNvZGVzLnNwYWNlLCBLZXlDb2Rlcy5jb21tYSwgS2V5Q29kZXMuc2VtaWNvbG9uXTtcbmNvbnN0IFN0eWxlZEljb24gPSBzdHlsZWQoSWNvbikgYFxuICAke2dldEZvbnRTdHlsZSh7IHNpemU6ICdzbWFsbCcgfSl9XG5cbiAgY3Vyc29yOiBwb2ludGVyO1xuICB2ZXJ0aWNhbC1hbGlnbjogbWlkZGxlO1xuICBjb2xvcjogJHt0aGVtZWQocHJvcHMgPT4gcHJvcHMudGhlbWUudWk1KX07XG4gIGZvbnQtZmFtaWx5OiAke3RoZW1lZChwcm9wcyA9PiBwcm9wcy50aGVtZS5mb250RmFtaWx5KX07XG4gIG1hcmdpbi1sZWZ0OiAke2Rpc3RhbmNlLnNtYWxsfTtcbmA7XG5jb25zdCBUYWdCdWlsZGVyQ29udGFpbmVyID0gc3R5bGVkLmRpdiBgYDtcbmludGVyZmFjZSBTdHlsZWRUYWdzQ29udGFpbmVyUHJvcHMge1xuICAgIGxhYmVsU2hvd246IGJvb2xlYW47XG4gICAgdGFnUmVuZGVyZXI6IGJvb2xlYW47XG59XG5mdW5jdGlvbiBnZXRDb250YWluZXJQYWRkaW5nKHByb3BzOiBTdHlsZWRUYWdzQ29udGFpbmVyUHJvcHMpIHtcbiAgICBjb25zdCB7IHRhZ1JlbmRlcmVyLCBsYWJlbFNob3duIH0gPSBwcm9wcztcbiAgICBpZiAoIXRhZ1JlbmRlcmVyKSB7XG4gICAgICAgIHJldHVybiAhbGFiZWxTaG93blxuICAgICAgICAgICAgPyBgJHtkaXN0YW5jZS5tZWRpdW19ICR7ZGlzdGFuY2UubWVkaXVtfSAke2Rpc3RhbmNlLnNtYWxsfWBcbiAgICAgICAgICAgIDogYCR7ZGlzdGFuY2UubGFyZ2V9ICR7ZGlzdGFuY2UubWVkaXVtfSAwYDtcbiAgICB9XG4gICAgcmV0dXJuICFsYWJlbFNob3duID8gYCR7ZGlzdGFuY2UubWVkaXVtfWAgOiBgJHtkaXN0YW5jZS5sYXJnZX0gJHtkaXN0YW5jZS5tZWRpdW19ICR7ZGlzdGFuY2Uuc21hbGx9YDtcbn1cbmNvbnN0IFN0eWxlZFRhZ3NDb250YWluZXIgPSBzdHlsZWQuZGl2IGBcbiAgcGFkZGluZzogJHtnZXRDb250YWluZXJQYWRkaW5nfTtcbiAgbWFyZ2luOiAwO1xuICB3aWR0aDogMTAwJTtcbiAgaGVpZ2h0OiAxMDAlO1xuICBib3gtc2l6aW5nOiBib3JkZXItYm94O1xuICBkaXNwbGF5OiBmbGV4O1xuICBmbGV4LXdyYXA6IHdyYXA7XG4gIGFsaWduLWl0ZW1zOiBjZW50ZXI7XG5gO1xuaW50ZXJmYWNlIFN0eWxlZElucHV0UHJvcHMge1xuICAgIHZhbHVlOiBzdHJpbmc7XG4gICAgZGlzYWJsZWQ/OiBib29sZWFuO1xuICAgIHRoZW1lOiBhbnk7XG4gICAgdmFsaWQ/OiBib29sZWFuO1xufVxuY29uc3QgU3R5bGVkSW5wdXQgPSBzdHlsZWQoJ2lucHV0Jyk8U3R5bGVkSW5wdXRQcm9wcz4gYFxuICAke2dldEZvbnRTaXplKCdtZWRpdW0nKX1cbiAgYm94LXNpemluZzogY29udGVudC1ib3g7XG4gIGJveC1zaGFkb3c6IG5vbmU7XG4gIGJvcmRlcjogbm9uZTtcbiAgYm9yZGVyLXJhZGl1czogMDtcbiAgbWFyZ2luOiAwO1xuICBvdXRsaW5lOiBub25lO1xuICBvdXRsaW5lLWNvbG9yOiB0cmFuc3BhcmVudCAhaW1wb3J0YW50O1xuICBiYWNrZ3JvdW5kOiAke3RyYW5zcGFyZW50fTtcbiAgd2lkdGg6ICR7cHJvcHMgPT4gKHByb3BzLnZhbHVlLmxlbmd0aCA+IDIgPyBwcm9wcy52YWx1ZS5sZW5ndGggKiAxMCArICdweCcgOiAnMjBweCcpfTtcbiAgY29sb3I6ICR7dGhlbWVkKCh7IGRpc2FibGVkLCB0aGVtZSwgdmFsaWQgfSkgPT4gKHZhbGlkID8gKGRpc2FibGVkID8gdGhlbWUudGV4dERpc2FibGVkIDogZGFyaykgOiBwdXJwbGVSZWQpKX07XG4gIGN1cnNvcjogJHtwcm9wcyA9PiAocHJvcHMuZGlzYWJsZWQgPyAnbm90LWFsbG93ZWQnIDogJ2F1dG8nKX07XG4gIGZvbnQtZmFtaWx5OiBpbmhlcml0O1xuYDtcbmNvbnN0IFJlc3R5bGVkVGFnSXRlbSA9IHN0eWxlZChTdHlsZWRUYWdJdGVtKSBgXG4gIG1hcmdpbjogMCAke2Rpc3RhbmNlLnNtYWxsfSAke2Rpc3RhbmNlLnNtYWxsfSAwO1xuYDtcbmludGVyZmFjZSBJbnB1dENvbnRhaW5lclByb3BzIHtcbiAgICB0YWdSZW5kZXJlcjogYm9vbGVhbjtcbn1cbmNvbnN0IElucHV0Q29udGFpbmVyID0gc3R5bGVkKCdkaXYnKTxJbnB1dENvbnRhaW5lclByb3BzPiBgXG4gIGRpc3BsYXk6IGlubGluZTtcbiAgcGFkZGluZy1ib3R0b206ICR7KHsgdGFnUmVuZGVyZXIgfSkgPT4gKCF0YWdSZW5kZXJlciA/IGAke2Rpc3RhbmNlLnNtYWxsfWAgOiAnMCcpfTtcbmA7XG5jb25zdCBTdHlsZWRUZXh0ID0gc3R5bGVkLnNwYW4gYFxuICBkaXNwbGF5OiBpbmxpbmUtYmxvY2s7XG4gIHZlcnRpY2FsLWFsaWduOiBtaWRkbGU7XG5gO1xuaW50ZXJmYWNlIENsb3NlSWNvblByb3BzIHtcbiAgICBvbkNsaWNrPygpOiB2b2lkO1xuICAgIG9uTW91c2VEb3duPyhldmVudDogUmVhY3QuTW91c2VFdmVudCk6IHZvaWQ7XG4gICAgdGhlbWU/OiBQcmVjaXNlVGhlbWU7XG59XG5jb25zdCBDbG9zZUljb24gPSBPYmplY3QuYXNzaWduKCgoKHsgdGhlbWUsIG9uQ2xpY2ssIG9uTW91c2VEb3duIH0pID0+ICg8U3R5bGVkSWNvbiB0aGVtZT17dGhlbWV9IG5hbWU9XCJDbG9zZVwiIG9uQ2xpY2s9e29uQ2xpY2t9IG9uTW91c2VEb3duPXtvbk1vdXNlRG93bn0vPikpIGFzIFJlYWN0LlNGQzxDbG9zZUljb25Qcm9wcz4pLCB7IGlubmVyOiB7XG4gICAgICAgIGdldCBTdHlsZWRJY29uKCkgeyByZXR1cm4gU3R5bGVkSWNvbiBhcyB0eXBlb2YgU3R5bGVkSWNvbjsgfVxuICAgIH0gfSk7XG5leHBvcnQgaW50ZXJmYWNlIFRhZ0J1aWxkZXJTdGF0ZSB7XG4gICAgaW5wdXRWYWx1ZTogc3RyaW5nO1xuICAgIHZhbHVlOiBBcnJheTxzdHJpbmc+O1xuICAgIGVycm9yPzogUmVhY3QuUmVhY3RDaGlsZDtcbiAgICBmb2N1c2VkOiBib29sZWFuO1xuICAgIGNvbnRyb2xsZWQ6IGJvb2xlYW47XG4gICAgaW5wdXRQb3NpdGlvbj86IG51bWJlcjtcbiAgICB2YWxpZD86IGJvb2xlYW47XG59XG5leHBvcnQgY2xhc3MgVGFnQnVpbGRlckludCBleHRlbmRzIFJlYWN0LkNvbXBvbmVudDxUYWdCdWlsZGVyUHJvcHMgJiBGb3JtQ29udGV4dFByb3BzLCBUYWdCdWlsZGVyU3RhdGU+IHtcbiAgICBwcml2YXRlIF9pbnB1dDogSFRNTElucHV0RWxlbWVudCB8IG51bGw7XG4gICAgY29uc3RydWN0b3IocHJvcHM6IFRhZ0J1aWxkZXJQcm9wcykge1xuICAgICAgICBzdXBlcihwcm9wcyk7XG4gICAgICAgIGNvbnN0IHRhZ3MgPSAocHJvcHMudmFsdWUgfHwgcHJvcHMuZGVmYXVsdFZhbHVlIHx8IFtdKS5tYXAobG93ZXJpemUpO1xuICAgICAgICB0aGlzLnN0YXRlID0ge1xuICAgICAgICAgICAgdmFsdWU6IHRhZ3MsXG4gICAgICAgICAgICBpbnB1dFZhbHVlOiBwcm9wcy5pbnB1dFZhbHVlIHx8ICcnLFxuICAgICAgICAgICAgY29udHJvbGxlZDogcHJvcHMudmFsdWUgIT09IHVuZGVmaW5lZCB8fCBwcm9wcy5pbnB1dFZhbHVlICE9PSB1bmRlZmluZWQsXG4gICAgICAgICAgICBmb2N1c2VkOiBmYWxzZSxcbiAgICAgICAgICAgIHZhbGlkOiB0cnVlLFxuICAgICAgICAgICAgZXJyb3I6IHByb3BzLmVycm9yLFxuICAgICAgICB9O1xuICAgIH1cbiAgICBVTlNBRkVfY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyh7IHZhbHVlLCBpbnB1dFZhbHVlID0gJycsIGVycm9yIH06IFRhZ0J1aWxkZXJQcm9wcykge1xuICAgICAgICBpZiAodGhpcy5zdGF0ZS5jb250cm9sbGVkICYmIHZhbHVlICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgICAgIHZhbHVlOiBbLi4udmFsdWVdLFxuICAgICAgICAgICAgICAgIGlucHV0VmFsdWU6IGlucHV0VmFsdWUsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnNldFN0YXRlKHsgZXJyb3IgfSk7XG4gICAgfVxuICAgIGNvbXBvbmVudERpZE1vdW50KCkge1xuICAgICAgICBjb25zdCB7IGZvcm0gfSA9IHRoaXMucHJvcHM7XG4gICAgICAgIGNvbnN0IHsgY29udHJvbGxlZCB9ID0gdGhpcy5zdGF0ZTtcbiAgICAgICAgaWYgKCFjb250cm9sbGVkICYmIGZvcm0pIHtcbiAgICAgICAgICAgIGZvcm0uc3Vic2NyaWJlKHRoaXMpO1xuICAgICAgICB9XG4gICAgfVxuICAgIGNvbXBvbmVudFdpbGxVbm1vdW50KCkge1xuICAgICAgICBjb25zdCB7IGZvcm0gfSA9IHRoaXMucHJvcHM7XG4gICAgICAgIGNvbnN0IHsgY29udHJvbGxlZCB9ID0gdGhpcy5zdGF0ZTtcbiAgICAgICAgaWYgKCFjb250cm9sbGVkICYmIGZvcm0pIHtcbiAgICAgICAgICAgIGZvcm0udW5zdWJzY3JpYmUodGhpcyk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcHJpdmF0ZSBmaXJlQmVmb3JlVGFnUmVtb3ZlRXZlbnQoaW5kZXg6IG51bWJlcik6IHZvaWQge1xuICAgICAgICBjb25zdCB7IG9uQmVmb3JlVGFnUmVtb3ZlIH0gPSB0aGlzLnByb3BzO1xuICAgICAgICBpZiAodHlwZW9mIG9uQmVmb3JlVGFnUmVtb3ZlID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICBvbkJlZm9yZVRhZ1JlbW92ZShpbmRleCk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcHJpdmF0ZSBpbnB1dENoYW5nZWQgPSAoZTogUmVhY3QuQ2hhbmdlRXZlbnQ8SFRNTElucHV0RWxlbWVudD4pID0+IHtcbiAgICAgICAgY29uc3QgeyBvbklucHV0IH0gPSB0aGlzLnByb3BzO1xuICAgICAgICBjb25zdCB7IGNvbnRyb2xsZWQsIHZhbHVlOiBwcmV2VGFncyB9ID0gdGhpcy5zdGF0ZTtcbiAgICAgICAgY29uc3QgeyB2YWx1ZSB9ID0gZS5jdXJyZW50VGFyZ2V0O1xuICAgICAgICBpZiAodHlwZW9mIG9uSW5wdXQgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgICAgIG9uSW5wdXQoeyB2YWx1ZTogdmFsdWUgfSk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCFjb250cm9sbGVkKSB7XG4gICAgICAgICAgICB0aGlzLnNldFN0YXRlKHsgaW5wdXRWYWx1ZTogdmFsdWUsIHZhbGlkOiB2YWx1ZS5sZW5ndGggPiAwID8gcHJldlRhZ3MuaW5kZXhPZih2YWx1ZSkgPT09IC0xIDogdHJ1ZSB9KTtcbiAgICAgICAgfVxuICAgIH07XG4gICAgcHJpdmF0ZSBrZXlEb3duSGFuZGxlciA9IChlOiBSZWFjdC5LZXlib2FyZEV2ZW50PEhUTUxEaXZFbGVtZW50PikgPT4ge1xuICAgICAgICBjb25zdCB7IGlucHV0VmFsdWUsIGNvbnRyb2xsZWQgfSA9IHRoaXMuc3RhdGU7XG4gICAgICAgIGNvbnN0IHsgc2hvdWxkRmluaXNoVGFnIH0gPSB0aGlzLnByb3BzO1xuICAgICAgICBsZXQgaXNIYW5kbGVkID0gZmFsc2U7XG4gICAgICAgIGNvbnN0IGhhbmRsZUtleUV2ZW50ID0gKCkgPT4ge1xuICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgICAgIGlzSGFuZGxlZCA9IHRydWU7XG4gICAgICAgIH07XG4gICAgICAgIGlmIChpbnB1dFZhbHVlLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgc3dpdGNoIChlLmtleUNvZGUpIHtcbiAgICAgICAgICAgICAgICBjYXNlIEtleUNvZGVzLmJhY2tzcGFjZTpcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZW1vdmVQcmV2VGFnKCk7XG4gICAgICAgICAgICAgICAgICAgIGhhbmRsZUtleUV2ZW50KCk7XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgIGNhc2UgS2V5Q29kZXMuZGVsZXRlOlxuICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbW92ZU5leHRUYWcoKTtcbiAgICAgICAgICAgICAgICAgICAgaGFuZGxlS2V5RXZlbnQoKTtcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCFpc0hhbmRsZWQgJiYgIWNvbnRyb2xsZWQpIHtcbiAgICAgICAgICAgIGlmICh0eXBlb2Ygc2hvdWxkRmluaXNoVGFnID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICAgICAgaWYgKHNob3VsZEZpbmlzaFRhZyhlKSkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmFkZFRhZyhpbnB1dFZhbHVlKTtcbiAgICAgICAgICAgICAgICAgICAgaGFuZGxlS2V5RXZlbnQoKTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2UgaWYgKGZpbmlzaFRhZ0tleXMuaW5kZXhPZihlLmtleUNvZGUpICE9PSAtMSkge1xuICAgICAgICAgICAgICAgIHRoaXMuYWRkVGFnKGlucHV0VmFsdWUpO1xuICAgICAgICAgICAgICAgIGhhbmRsZUtleUV2ZW50KCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoaW5wdXRWYWx1ZS5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICBzd2l0Y2ggKGUua2V5Q29kZSkge1xuICAgICAgICAgICAgICAgICAgICBjYXNlIEtleUNvZGVzLmVuZDpcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaW5wdXRNb3ZlRW5kKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBoYW5kbGVLZXlFdmVudCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgIGNhc2UgS2V5Q29kZXMuaG9tZTpcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaW5wdXRNb3ZlSG9tZSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgaGFuZGxlS2V5RXZlbnQoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICBjYXNlIEtleUNvZGVzLmxlZnQ6XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmlucHV0TW92ZUxlZnQoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGhhbmRsZUtleUV2ZW50KCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgY2FzZSBLZXlDb2Rlcy5yaWdodDpcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaW5wdXRNb3ZlUmlnaHQoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGhhbmRsZUtleUV2ZW50KCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9O1xuICAgIHByaXZhdGUgaW5wdXRGb2N1c2VkID0gKCkgPT4ge1xuICAgICAgICBjb25zdCB7IG9uRm9jdXMgfSA9IHRoaXMucHJvcHM7XG4gICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgZm9jdXNlZDogdHJ1ZSxcbiAgICAgICAgfSwgb25Gb2N1cyk7XG4gICAgfTtcbiAgICBwcml2YXRlIGlucHV0Qmx1cnJlZCA9ICgpID0+IHtcbiAgICAgICAgY29uc3QgeyBvbkJsdXIsIGFwcGVuZFRhZ09uQmx1ciB9ID0gdGhpcy5wcm9wcztcbiAgICAgICAgaWYgKCEhYXBwZW5kVGFnT25CbHVyICYmICF0aGlzLnN0YXRlLmNvbnRyb2xsZWQpIHtcbiAgICAgICAgICAgIGNvbnN0IHsgaW5wdXRWYWx1ZSB9ID0gdGhpcy5zdGF0ZTtcbiAgICAgICAgICAgIGlmIChpbnB1dFZhbHVlKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5hZGRUYWcoaW5wdXRWYWx1ZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICBmb2N1c2VkOiBmYWxzZSxcbiAgICAgICAgfSwgb25CbHVyKTtcbiAgICB9O1xuICAgIHByaXZhdGUgaW5wdXRNb3ZlTGVmdCgpIHtcbiAgICAgICAgY29uc3QgeyB2YWx1ZSB9ID0gdGhpcy5zdGF0ZTtcbiAgICAgICAgY29uc3QgeyBpbnB1dFBvc2l0aW9uID0gdmFsdWUubGVuZ3RoIH0gPSB0aGlzLnN0YXRlO1xuICAgICAgICBpZiAoaW5wdXRQb3NpdGlvbiA+IDApIHtcbiAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoeyBpbnB1dFBvc2l0aW9uOiBpbnB1dFBvc2l0aW9uIC0gMSB9KTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBwcml2YXRlIGlucHV0TW92ZVJpZ2h0KCkge1xuICAgICAgICBjb25zdCB7IHZhbHVlLCBpbnB1dFBvc2l0aW9uIH0gPSB0aGlzLnN0YXRlO1xuICAgICAgICBpZiAoaW5wdXRQb3NpdGlvbiAhPT0gdW5kZWZpbmVkICYmIGlucHV0UG9zaXRpb24gPCB2YWx1ZS5sZW5ndGgpIHtcbiAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoeyBpbnB1dFBvc2l0aW9uOiBpbnB1dFBvc2l0aW9uICsgMSB9KTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBwcml2YXRlIGlucHV0TW92ZUVuZCgpIHtcbiAgICAgICAgY29uc3QgeyB2YWx1ZSB9ID0gdGhpcy5zdGF0ZTtcbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7IGlucHV0UG9zaXRpb246IHZhbHVlLmxlbmd0aCB9KTtcbiAgICB9XG4gICAgcHJpdmF0ZSBpbnB1dE1vdmVIb21lKCkge1xuICAgICAgICB0aGlzLnNldFN0YXRlKHsgaW5wdXRQb3NpdGlvbjogMCB9KTtcbiAgICB9XG4gICAgcHJpdmF0ZSBzZXRGb2N1cyA9ICgpID0+IHtcbiAgICAgICAgdGhpcy5faW5wdXQgJiYgdGhpcy5faW5wdXQuZm9jdXMoKTtcbiAgICB9O1xuICAgIHByaXZhdGUgYWRkVGFnKGlucHV0VmFsdWU6IHN0cmluZykge1xuICAgICAgICBjb25zdCB7IHZhbHVlOiBwcmV2VGFncywgdmFsaWQgfSA9IHRoaXMuc3RhdGU7XG4gICAgICAgIGNvbnN0IHsgaW5wdXRQb3NpdGlvbiA9IHByZXZUYWdzLmxlbmd0aCB9ID0gdGhpcy5zdGF0ZTtcbiAgICAgICAgaW5wdXRWYWx1ZSA9IGlucHV0VmFsdWUudHJpbSgpLnRvTG93ZXJDYXNlKCk7XG4gICAgICAgIGlmIChpbnB1dFZhbHVlLmxlbmd0aCA+IDAgJiYgdmFsaWQpIHtcbiAgICAgICAgICAgIGNvbnN0IHRhZ3MgPSBbLi4ucHJldlRhZ3NdO1xuICAgICAgICAgICAgdGFncy5zcGxpY2UoaW5wdXRQb3NpdGlvbiwgMCwgaW5wdXRWYWx1ZSk7XG4gICAgICAgICAgICB0aGlzLnNldFN0YXRlKHsgaW5wdXRWYWx1ZTogJycsIGlucHV0UG9zaXRpb246IGlucHV0UG9zaXRpb24gKyAxIH0sICgpID0+IHRoaXMub25DaGFuZ2UodGFncykpO1xuICAgICAgICB9XG4gICAgfVxuICAgIHByaXZhdGUgcmVtb3ZlUHJldlRhZygpIHtcbiAgICAgICAgY29uc3QgeyB2YWx1ZTogcHJldlRhZ3MgfSA9IHRoaXMuc3RhdGU7XG4gICAgICAgIGNvbnN0IHsgaW5wdXRQb3NpdGlvbiA9IHByZXZUYWdzLmxlbmd0aCB9ID0gdGhpcy5zdGF0ZTtcbiAgICAgICAgaWYgKGlucHV0UG9zaXRpb24gPiAwKSB7XG4gICAgICAgICAgICB0aGlzLnJlbW92ZVRhZyhpbnB1dFBvc2l0aW9uIC0gMSk7XG4gICAgICAgICAgICB0aGlzLnNldFN0YXRlKHsgaW5wdXRQb3NpdGlvbjogaW5wdXRQb3NpdGlvbiAtIDEgfSk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcHJpdmF0ZSByZW1vdmVOZXh0VGFnKCkge1xuICAgICAgICBjb25zdCB7IHZhbHVlOiBwcmV2VGFncywgaW5wdXRQb3NpdGlvbiB9ID0gdGhpcy5zdGF0ZTtcbiAgICAgICAgaWYgKGlucHV0UG9zaXRpb24gIT09IHVuZGVmaW5lZCAmJiBpbnB1dFBvc2l0aW9uIDwgcHJldlRhZ3MubGVuZ3RoKSB7XG4gICAgICAgICAgICB0aGlzLnJlbW92ZVRhZyhpbnB1dFBvc2l0aW9uKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBwcml2YXRlIHJlbW92ZVRhZyhpbmRleDogbnVtYmVyKSB7XG4gICAgICAgIGNvbnN0IHsgdmFsdWU6IHByZXZUYWdzIH0gPSB0aGlzLnN0YXRlO1xuICAgICAgICB0aGlzLmZpcmVCZWZvcmVUYWdSZW1vdmVFdmVudChpbmRleCk7XG4gICAgICAgIGNvbnN0IHRhZ3MgPSBbLi4ucHJldlRhZ3Muc2xpY2UoMCwgaW5kZXgpLCAuLi5wcmV2VGFncy5zbGljZShpbmRleCArIDEpXTtcbiAgICAgICAgdGhpcy5vbkNoYW5nZSh0YWdzKTtcbiAgICB9XG4gICAgcHJpdmF0ZSBvbkNoYW5nZSh2YWx1ZTogQXJyYXk8c3RyaW5nPikge1xuICAgICAgICBjb25zdCB7IG9uQ2hhbmdlLCBuYW1lID0gJycsIGZvcm0gfSA9IHRoaXMucHJvcHM7XG4gICAgICAgIGlmICghdGhpcy5zdGF0ZS5jb250cm9sbGVkKSB7XG4gICAgICAgICAgICBpZiAoZm9ybSkge1xuICAgICAgICAgICAgICAgIGZvcm0uY2hhbmdlKHtcbiAgICAgICAgICAgICAgICAgICAgbmFtZSxcbiAgICAgICAgICAgICAgICAgICAgdmFsdWUsXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICAgICAgICAgICAgdmFsdWUsXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHR5cGVvZiBvbkNoYW5nZSA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgICAgb25DaGFuZ2Uoe1xuICAgICAgICAgICAgICAgIHZhbHVlLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcHJpdmF0ZSByZW1vdmVUYWdNb3VzZURvd25IYW5kbGVyID0gKGV2ZW50OiBSZWFjdC5Nb3VzZUV2ZW50KSA9PiB7XG4gICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgfTtcbiAgICBwcml2YXRlIHJlbmRlclRhZyA9IChlOiBUYWdCdWlsZGVyUmVuZGVyRXZlbnQpID0+IHtcbiAgICAgICAgY29uc3QgeyB0aGVtZSwgZGlzYWJsZWQgfSA9IHRoaXMucHJvcHM7XG4gICAgICAgIHJldHVybiAoPFJlc3R5bGVkVGFnSXRlbSB0aGVtZT17dGhlbWV9IGtleT17ZS5pdGVtICsgZS5pbmRleH0+XG4gICAgICAgIDxTdHlsZWRUZXh0PntlLml0ZW19PC9TdHlsZWRUZXh0PlxuICAgICAgICB7IWRpc2FibGVkICYmICg8Q2xvc2VJY29uIHRoZW1lPXt0aGVtZX0gb25Nb3VzZURvd249e3RoaXMucmVtb3ZlVGFnTW91c2VEb3duSGFuZGxlcn0gb25DbGljaz17KCkgPT4gdGhpcy5yZW1vdmVUYWcoZS5pbmRleCl9Lz4pfVxuICAgICAgPC9SZXN0eWxlZFRhZ0l0ZW0+KTtcbiAgICB9O1xuICAgIHByaXZhdGUgc2V0Q29udGFpbmVyID0gKG5vZGU6IEhUTUxJbnB1dEVsZW1lbnQgfCBudWxsKSA9PiB7XG4gICAgICAgIHRoaXMuX2lucHV0ID0gbm9kZTtcbiAgICAgICAgY29uc3QgeyBpbnB1dFJlZiB9ID0gdGhpcy5wcm9wcztcbiAgICAgICAgaWYgKHR5cGVvZiBpbnB1dFJlZiA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgICAgaW5wdXRSZWYobm9kZSk7XG4gICAgICAgIH1cbiAgICB9O1xuICAgIHJlbmRlcigpIHtcbiAgICAgICAgY29uc3QgeyB0YWdSZW5kZXJlciwgaW5mbywgZGlzYWJsZWQsIGJvcmRlcmxlc3MsIHRoZW1lLCBsYWJlbCwgcGxhY2Vob2xkZXIgfSA9IHRoaXMucHJvcHM7XG4gICAgICAgIGNvbnN0IHsgdmFsdWUsIGlucHV0VmFsdWUsIGZvY3VzZWQsIHZhbGlkLCBlcnJvciB9ID0gdGhpcy5zdGF0ZTtcbiAgICAgICAgY29uc3QgeyBpbnB1dFBvc2l0aW9uID0gdmFsdWUubGVuZ3RoIH0gPSB0aGlzLnN0YXRlO1xuICAgICAgICBjb25zdCBib3JkZXIgPSBnZXRUZXh0RmllbGRCb3JkZXJUeXBlKGJvcmRlcmxlc3MsICEhZXJyb3IsIGZvY3VzZWQpO1xuICAgICAgICBjb25zdCByZW5kZXJlciA9IHRhZ1JlbmRlcmVyIHx8IHRoaXMucmVuZGVyVGFnO1xuICAgICAgICBjb25zdCBjaGlsZHJlbiA9IHZhbHVlLm1hcCgoaXRlbSwgaW5kZXgpID0+IHJlbmRlcmVyKHsgaXRlbSwgaW5kZXgsIHRhZ3M6IHZhbHVlIH0pKTtcbiAgICAgICAgY29uc3QgaGFzVmFsdWUgPSAhIWlucHV0VmFsdWUgfHwgdmFsdWUubGVuZ3RoID4gMDtcbiAgICAgICAgY2hpbGRyZW4uc3BsaWNlKGlucHV0UG9zaXRpb24sIDAsIDxJbnB1dENvbnRhaW5lciBrZXk9XCJpbnB1dFwiIG9uS2V5RG93bj17dGhpcy5rZXlEb3duSGFuZGxlcn0gdGFnUmVuZGVyZXI9eyEhdGFnUmVuZGVyZXJ9PlxuICAgICAgICA8U3R5bGVkSW5wdXQgdGhlbWU9e3RoZW1lfSBkaXNhYmxlZD17ZGlzYWJsZWR9IHJlZj17dGhpcy5zZXRDb250YWluZXJ9IHR5cGU9XCJ0ZXh0XCIgdmFsdWU9e2lucHV0VmFsdWV9IG9uQ2hhbmdlPXt0aGlzLmlucHV0Q2hhbmdlZH0gb25Gb2N1cz17dGhpcy5pbnB1dEZvY3VzZWR9IG9uQmx1cj17dGhpcy5pbnB1dEJsdXJyZWR9IHZhbGlkPXt2YWxpZH0vPlxuICAgICAgPC9JbnB1dENvbnRhaW5lcj4pO1xuICAgICAgICByZXR1cm4gKDxUYWdCdWlsZGVyQ29udGFpbmVyPlxuICAgICAgICA8U3R5bGVkSW5wdXRCb3ggYm9yZGVyPXtib3JkZXJ9IGRpc2FibGVkPXtkaXNhYmxlZH0gZm9jdXNlZD17Zm9jdXNlZH0gaGFzVmFsdWU9e2hhc1ZhbHVlfT5cbiAgICAgICAgICA8U3R5bGVkSW5wdXRSb3cgb25DbGljaz17dGhpcy5zZXRGb2N1c30gbGFiZWw9e2xhYmVsfSBoYXNWYWx1ZT17aGFzVmFsdWV9IHBsYWNlaG9sZGVyPXtwbGFjZWhvbGRlcn0gZXJyb3I9eyEhZXJyb3J9IGZvY3VzZWQ9e2ZvY3VzZWR9PlxuICAgICAgICAgICAgPFN0eWxlZFRhZ3NDb250YWluZXIgbGFiZWxTaG93bj17ISFsYWJlbH0gdGFnUmVuZGVyZXI9eyEhdGFnUmVuZGVyZXJ9PlxuICAgICAgICAgICAgICB7Y2hpbGRyZW59XG4gICAgICAgICAgICA8L1N0eWxlZFRhZ3NDb250YWluZXI+XG4gICAgICAgICAgPC9TdHlsZWRJbnB1dFJvdz5cbiAgICAgICAgICA8SW5wdXRJY29uIGRpc2FibGVkPXtkaXNhYmxlZH0gdGhlbWU9e3RoZW1lfSBlcnJvcj17ZXJyb3J9IGhhc1ZhbHVlPXtoYXNWYWx1ZX0vPlxuICAgICAgICA8L1N0eWxlZElucHV0Qm94PlxuICAgICAgICB7c2hvd0lucHV0SW5mbyhlcnJvciwgaW5mbyl9XG4gICAgICA8L1RhZ0J1aWxkZXJDb250YWluZXI+KTtcbiAgICB9XG4gICAgc3RhdGljIGlubmVyID0ge1xuICAgICAgICBnZXQgUmVzdHlsZWRUYWdJdGVtKCkgeyByZXR1cm4gUmVzdHlsZWRUYWdJdGVtIGFzIHR5cGVvZiBSZXN0eWxlZFRhZ0l0ZW07IH0sXG4gICAgICAgIGdldCBTdHlsZWRUZXh0KCkgeyByZXR1cm4gU3R5bGVkVGV4dCBhcyB0eXBlb2YgU3R5bGVkVGV4dDsgfSxcbiAgICAgICAgZ2V0IENsb3NlSWNvbigpIHsgcmV0dXJuIENsb3NlSWNvbiBhcyB0eXBlb2YgQ2xvc2VJY29uOyB9LFxuICAgICAgICBnZXQgSW5wdXRDb250YWluZXIoKSB7IHJldHVybiBJbnB1dENvbnRhaW5lciBhcyB0eXBlb2YgSW5wdXRDb250YWluZXI7IH0sXG4gICAgICAgIGdldCBTdHlsZWRJbnB1dCgpIHsgcmV0dXJuIFN0eWxlZElucHV0IGFzIHR5cGVvZiBTdHlsZWRJbnB1dDsgfSxcbiAgICAgICAgZ2V0IFRhZ0J1aWxkZXJDb250YWluZXIoKSB7IHJldHVybiBUYWdCdWlsZGVyQ29udGFpbmVyIGFzIHR5cGVvZiBUYWdCdWlsZGVyQ29udGFpbmVyOyB9LFxuICAgICAgICBnZXQgU3R5bGVkSW5wdXRCb3goKSB7IHJldHVybiBTdHlsZWRJbnB1dEJveCBhcyB0eXBlb2YgU3R5bGVkSW5wdXRCb3g7IH0sXG4gICAgICAgIGdldCBTdHlsZWRJbnB1dFJvdygpIHsgcmV0dXJuIFN0eWxlZElucHV0Um93IGFzIHR5cGVvZiBTdHlsZWRJbnB1dFJvdzsgfSxcbiAgICAgICAgZ2V0IFN0eWxlZFRhZ3NDb250YWluZXIoKSB7IHJldHVybiBTdHlsZWRUYWdzQ29udGFpbmVyIGFzIHR5cGVvZiBTdHlsZWRUYWdzQ29udGFpbmVyOyB9LFxuICAgICAgICBnZXQgSW5wdXRJY29uKCkgeyByZXR1cm4gSW5wdXRJY29uIGFzIHR5cGVvZiBJbnB1dEljb247IH1cbiAgICB9O1xufVxuZXhwb3J0IGNvbnN0IFRhZ0J1aWxkZXIgPSB3aXRoRm9ybUNvbnRleHQoVGFnQnVpbGRlckludCk7XG5UYWdCdWlsZGVyLmRpc3BsYXlOYW1lID0gJ1RhZ0J1aWxkZXInO1xuIl19