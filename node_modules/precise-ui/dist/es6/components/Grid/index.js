var __rest = (this && this.__rest) || function (s, e) {
    var t = {};
    for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)
        t[p] = s[p];
    if (s != null && typeof Object.getOwnPropertySymbols === "function")
        for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) if (e.indexOf(p[i]) < 0)
            t[p[i]] = s[p[i]];
    return t;
};
import * as React from 'react';
import styled from '../../utils/styled';
import { calcLayout } from '../../utils/gridLayout';
import { isIE } from '../../utils/browser';
const StyledGridWrapper = styled.div `
  position: relative;
`;
function addPx(original, space) {
    if (original.endsWith('px')) {
        const dim = +original.replace('px', '');
        return `${dim + space}px`;
    }
    return original;
}
function computeIeRows(rows, spacing) {
    if (isIE === 'IE11') {
        const [, rowSpace] = spacing;
        if (rowSpace && rowSpace.endsWith('px')) {
            const space = +rowSpace.replace('px', '');
            if (space) {
                const end = rows.length - 1;
                return rows.map((row, i) => (i !== end ? addPx(row, space) : row)).join(' ');
            }
        }
    }
    return rows.join(' ');
}
const BasicGridLayout = styled.div `
  height: 100%;
  width: 100%;
  display: -ms-grid;
  display: grid;
  -ms-grid-columns: ${props => props.columns.join(' ')};
  grid-template-columns: ${props => props.columns.join(' ')};
  -ms-grid-rows: ${props => computeIeRows(props.rows, props.spacing)};
  grid-template-rows: ${props => props.rows.join(' ')};
  grid-gap: ${props => props.spacing.join(' ')};
`;
const GridLayout = styled(BasicGridLayout) `
  opacity: 0.9999;
`;
const ShadowGrid = styled(BasicGridLayout) `
  position: absolute;
`;
const DefaultUnusedCell = styled.div `
  width: 100%;
  height: 100%;
  background: #f1f1f1;
`;
// Remark:
// At PR #258 a fix for "complex content that overflows" was introduced
// which caused some problem. If this fix should be required in the future
// again we should bring in something like the following:
//
// ```css
// overflow: auto;
// margin: -1em;
// padding: 1em;
// ```
const GridCell = styled.div `
  -ms-grid-row: ${props => props.ri + 1};
  -ms-grid-row-span: ${props => props.rf - props.ri};
  grid-row: ${props => props.ri + 1} / span ${props => props.rf - props.ri};
  -ms-grid-column: ${props => props.ci + 1};
  -ms-grid-column-span: ${props => props.cf - props.ci};
  grid-column: ${props => props.ci + 1} / span ${props => props.cf - props.ci};
  max-width: 100%;
`;
const HiddenGridCell = styled.div `
  width: 0;
  height: 0;
  overflow: hidden;
`;
function repeat(n, dim = '1fr') {
    if (typeof n === 'number') {
        const arr = [];
        for (let i = 0; i < n; i++) {
            arr.push(dim);
        }
        return arr;
    }
    else if (!n) {
        return [dim];
    }
    return n;
}
function period(unit) {
    if (typeof unit === 'string') {
        return [unit, unit];
    }
    else if (!unit) {
        return ['0', '0'];
    }
    return unit;
}
function getEmptyComponent(showEmptyCells) {
    if (showEmptyCells === true) {
        return (row, col) => React.createElement(DefaultUnusedCell, { key: `uc-${row}-${col}` });
    }
    else if (typeof showEmptyCells === 'object') {
        return (row, col) => React.cloneElement(showEmptyCells, { key: `uc-${row}-${col}` });
    }
    else {
        return showEmptyCells;
    }
}
function computeAllocations(props) {
    const { children, rows, columns } = props;
    const allocation = [];
    const layout = calcLayout(children, {
        rows: typeof rows !== 'string' ? rows : undefined,
        columns: typeof columns !== 'string' ? columns : undefined,
    });
    const cells = React.Children.map(children, (child, index) => {
        const position = layout.cells[index];
        if (child && position) {
            allocation.push(position);
            const { colSpan, column, row, rowSpan } = position;
            if (!colSpan || !rowSpan) {
                return React.createElement(HiddenGridCell, null, child);
            }
            return (React.createElement(GridCell, { ci: column, cf: column + colSpan, ri: row, rf: row + rowSpan, key: index }, child));
        }
        return undefined;
    }) || [];
    return {
        allocation,
        cells,
        rows: typeof rows === 'string' ? repeat(layout.rows, rows) : repeat(rows || layout.rows),
        columns: typeof columns === 'string' ? repeat(layout.columns, columns) : repeat(columns || layout.columns),
    };
}
function computeUnused(props, layout) {
    const { showEmptyCells } = props;
    const { rows, columns } = layout;
    const unusedCells = [];
    if (showEmptyCells) {
        const renderer = getEmptyComponent(showEmptyCells);
        const rowCount = rows.length;
        const colCount = columns.length;
        for (let i = 0; i < rowCount; i++) {
            for (let j = 0; j < colCount; j++) {
                const cell = renderer(i, j);
                unusedCells.push(cell);
            }
        }
    }
    return unusedCells;
}
/**
 * The `Grid` component represents a uniform grid, i.e., a grid that does not change its column layout from row to row.
 */
export class Grid extends React.PureComponent {
    constructor(props) {
        super(props);
        const layout = computeAllocations(props);
        this.state = {
            layout,
            unused: computeUnused(props, layout),
        };
    }
    UNSAFE_componentWillReceiveProps(nextProps) {
        const currLayout = this.state.layout;
        const nextLayout = computeAllocations(nextProps);
        this.setState({
            layout: nextLayout,
        });
        if (nextProps.showEmptyCells !== this.props.showEmptyCells ||
            nextLayout.rows !== currLayout.rows ||
            nextLayout.columns !== currLayout.columns) {
            this.setState({
                unused: computeUnused(nextProps, nextLayout),
            });
        }
    }
    render() {
        const _a = this.props, { rows: _0, columns: _1, spacing = 0, showEmptyCells: _2, onLayout, innerRef } = _a, props = __rest(_a, ["rows", "columns", "spacing", "showEmptyCells", "onLayout", "innerRef"]);
        const { layout, unused } = this.state;
        const space = typeof spacing === 'number' ? `${spacing}px` : spacing;
        const selectedSpacing = period(space);
        if (typeof onLayout === 'function') {
            onLayout({
                layout,
            });
        }
        return (React.createElement(StyledGridWrapper, { ref: innerRef },
            !!unused.length && (React.createElement(ShadowGrid, { rows: layout.rows, columns: layout.columns, spacing: selectedSpacing }, unused)),
            React.createElement(GridLayout, Object.assign({ rows: layout.rows, columns: layout.columns, spacing: selectedSpacing }, props), layout.cells)));
    }
}
Grid.inner = {
    get StyledGridWrapper() { return StyledGridWrapper; },
    get ShadowGrid() { return ShadowGrid; },
    get GridLayout() { return GridLayout; }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvY29tcG9uZW50cy9HcmlkL2luZGV4LnRzeCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFBQSxPQUFPLEtBQUssS0FBSyxNQUFNLE9BQU8sQ0FBQztBQUMvQixPQUFPLE1BQU0sTUFBTSxvQkFBb0IsQ0FBQztBQUd4QyxPQUFPLEVBQUUsVUFBVSxFQUFrQixNQUFNLHdCQUF3QixDQUFDO0FBQ3BFLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQWtFM0MsTUFBTSxpQkFBaUIsR0FBRyxNQUFNLENBQUMsR0FBRyxDQUFDOztDQUVwQyxDQUFDO0FBQ0YsU0FBUyxLQUFLLENBQUMsUUFBZ0IsRUFBRSxLQUFhO0lBQzFDLElBQUksUUFBUSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsRUFBRTtRQUN6QixNQUFNLEdBQUcsR0FBRyxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBQ3hDLE9BQU8sR0FBRyxHQUFHLEdBQUcsS0FBSyxJQUFJLENBQUM7S0FDN0I7SUFDRCxPQUFPLFFBQVEsQ0FBQztBQUNwQixDQUFDO0FBQ0QsU0FBUyxhQUFhLENBQUMsSUFBbUIsRUFBRSxPQUF5QjtJQUNqRSxJQUFJLElBQUksS0FBSyxNQUFNLEVBQUU7UUFDakIsTUFBTSxDQUFDLEVBQUUsUUFBUSxDQUFDLEdBQUcsT0FBTyxDQUFDO1FBQzdCLElBQUksUUFBUSxJQUFJLFFBQVEsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLEVBQUU7WUFDckMsTUFBTSxLQUFLLEdBQUcsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsQ0FBQztZQUMxQyxJQUFJLEtBQUssRUFBRTtnQkFDUCxNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQztnQkFDNUIsT0FBTyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQzthQUNoRjtTQUNKO0tBQ0o7SUFDRCxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7QUFDMUIsQ0FBQztBQUNELE1BQU0sZUFBZSxHQUFHLE1BQU0sQ0FBQyxHQUFHLENBQWtCOzs7OztzQkFLOUIsS0FBSyxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUM7MkJBQzNCLEtBQUssQ0FBQyxFQUFFLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDO21CQUN4QyxLQUFLLENBQUMsRUFBRSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQyxPQUFPLENBQUM7d0JBQzVDLEtBQUssQ0FBQyxFQUFFLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDO2NBQ3ZDLEtBQUssQ0FBQyxFQUFFLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDO0NBQzdDLENBQUM7QUFDRixNQUFNLFVBQVUsR0FBRyxNQUFNLENBQUMsZUFBZSxDQUFDLENBQUM7O0NBRTFDLENBQUM7QUFDRixNQUFNLFVBQVUsR0FBRyxNQUFNLENBQUMsZUFBZSxDQUFDLENBQUM7O0NBRTFDLENBQUM7QUFDRixNQUFNLGlCQUFpQixHQUFHLE1BQU0sQ0FBQyxHQUFHLENBQUM7Ozs7Q0FJcEMsQ0FBQztBQU9GLFVBQVU7QUFDVix1RUFBdUU7QUFDdkUsMEVBQTBFO0FBQzFFLHlEQUF5RDtBQUN6RCxFQUFFO0FBQ0YsU0FBUztBQUNULGtCQUFrQjtBQUNsQixnQkFBZ0I7QUFDaEIsZ0JBQWdCO0FBQ2hCLE1BQU07QUFDTixNQUFNLFFBQVEsR0FBRyxNQUFNLENBQUMsR0FBRyxDQUFnQjtrQkFDekIsS0FBSyxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUMsRUFBRSxHQUFHLENBQUM7dUJBQ2hCLEtBQUssQ0FBQyxFQUFFLENBQUMsS0FBSyxDQUFDLEVBQUUsR0FBRyxLQUFLLENBQUMsRUFBRTtjQUNyQyxLQUFLLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxFQUFFLEdBQUcsQ0FBQyxXQUFXLEtBQUssQ0FBQyxFQUFFLENBQUMsS0FBSyxDQUFDLEVBQUUsR0FBRyxLQUFLLENBQUMsRUFBRTtxQkFDckQsS0FBSyxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUMsRUFBRSxHQUFHLENBQUM7MEJBQ2hCLEtBQUssQ0FBQyxFQUFFLENBQUMsS0FBSyxDQUFDLEVBQUUsR0FBRyxLQUFLLENBQUMsRUFBRTtpQkFDckMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUMsRUFBRSxHQUFHLENBQUMsV0FBVyxLQUFLLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxFQUFFLEdBQUcsS0FBSyxDQUFDLEVBQUU7O0NBRTVFLENBQUM7QUFDRixNQUFNLGNBQWMsR0FBRyxNQUFNLENBQUMsR0FBRyxDQUFDOzs7O0NBSWpDLENBQUM7QUFDRixTQUFTLE1BQU0sQ0FBQyxDQUFxQyxFQUFFLEdBQUcsR0FBRyxLQUFLO0lBQzlELElBQUksT0FBTyxDQUFDLEtBQUssUUFBUSxFQUFFO1FBQ3ZCLE1BQU0sR0FBRyxHQUFrQixFQUFFLENBQUM7UUFDOUIsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRTtZQUN4QixHQUFHLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1NBQ2pCO1FBQ0QsT0FBTyxHQUFHLENBQUM7S0FDZDtTQUNJLElBQUksQ0FBQyxDQUFDLEVBQUU7UUFDVCxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUM7S0FDaEI7SUFDRCxPQUFPLENBQUMsQ0FBQztBQUNiLENBQUM7QUFDRCxTQUFTLE1BQU0sQ0FBQyxJQUEyQztJQUN2RCxJQUFJLE9BQU8sSUFBSSxLQUFLLFFBQVEsRUFBRTtRQUMxQixPQUFPLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO0tBQ3ZCO1NBQ0ksSUFBSSxDQUFDLElBQUksRUFBRTtRQUNaLE9BQU8sQ0FBQyxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUM7S0FDckI7SUFDRCxPQUFPLElBQUksQ0FBQztBQUNoQixDQUFDO0FBQ0QsU0FBUyxpQkFBaUIsQ0FBQyxjQUFzRDtJQUM3RSxJQUFJLGNBQWMsS0FBSyxJQUFJLEVBQUU7UUFDekIsT0FBTyxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsRUFBRSxDQUFDLG9CQUFDLGlCQUFpQixJQUFDLEdBQUcsRUFBRSxNQUFNLEdBQUcsSUFBSSxHQUFHLEVBQUUsR0FBRyxDQUFDO0tBQ3RFO1NBQ0ksSUFBSSxPQUFPLGNBQWMsS0FBSyxRQUFRLEVBQUU7UUFDekMsT0FBTyxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsRUFBRSxDQUFDLEtBQUssQ0FBQyxZQUFZLENBQUMsY0FBYyxFQUFFLEVBQUUsR0FBRyxFQUFFLE1BQU0sR0FBRyxJQUFJLEdBQUcsRUFBRSxFQUFFLENBQUMsQ0FBQztLQUN4RjtTQUNJO1FBQ0QsT0FBTyxjQUFjLENBQUM7S0FDekI7QUFDTCxDQUFDO0FBSUQsU0FBUyxrQkFBa0IsQ0FBQyxLQUFnQjtJQUN4QyxNQUFNLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSxPQUFPLEVBQUUsR0FBRyxLQUFLLENBQUM7SUFDMUMsTUFBTSxVQUFVLEdBQTBCLEVBQUUsQ0FBQztJQUM3QyxNQUFNLE1BQU0sR0FBRyxVQUFVLENBQUMsUUFBUSxFQUFFO1FBQ2hDLElBQUksRUFBRSxPQUFPLElBQUksS0FBSyxRQUFRLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsU0FBUztRQUNqRCxPQUFPLEVBQUUsT0FBTyxPQUFPLEtBQUssUUFBUSxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLFNBQVM7S0FDN0QsQ0FBQyxDQUFDO0lBQ0gsTUFBTSxLQUFLLEdBQUcsS0FBSyxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFLENBQUMsS0FBZ0IsRUFBRSxLQUFLLEVBQUUsRUFBRTtRQUNuRSxNQUFNLFFBQVEsR0FBRyxNQUFNLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ3JDLElBQUksS0FBSyxJQUFJLFFBQVEsRUFBRTtZQUNuQixVQUFVLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQzFCLE1BQU0sRUFBRSxPQUFPLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxPQUFPLEVBQUUsR0FBRyxRQUFRLENBQUM7WUFDbkQsSUFBSSxDQUFDLE9BQU8sSUFBSSxDQUFDLE9BQU8sRUFBRTtnQkFDdEIsT0FBTyxvQkFBQyxjQUFjLFFBQUUsS0FBSyxDQUFrQixDQUFDO2FBQ25EO1lBQ0QsT0FBTyxDQUFDLG9CQUFDLFFBQVEsSUFBQyxFQUFFLEVBQUUsTUFBTSxFQUFFLEVBQUUsRUFBRSxNQUFNLEdBQUcsT0FBTyxFQUFFLEVBQUUsRUFBRSxHQUFHLEVBQUUsRUFBRSxFQUFFLEdBQUcsR0FBRyxPQUFPLEVBQUUsR0FBRyxFQUFFLEtBQUssSUFDekYsS0FBSyxDQUNHLENBQUMsQ0FBQztTQUNkO1FBQ0QsT0FBTyxTQUFTLENBQUM7SUFDckIsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDO0lBQ1QsT0FBTztRQUNILFVBQVU7UUFDVixLQUFLO1FBQ0wsSUFBSSxFQUFFLE9BQU8sSUFBSSxLQUFLLFFBQVEsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxJQUFJLElBQUksTUFBTSxDQUFDLElBQUksQ0FBQztRQUN4RixPQUFPLEVBQUUsT0FBTyxPQUFPLEtBQUssUUFBUSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLE9BQU8sRUFBRSxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLE9BQU8sSUFBSSxNQUFNLENBQUMsT0FBTyxDQUFDO0tBQzdHLENBQUM7QUFDTixDQUFDO0FBQ0QsU0FBUyxhQUFhLENBQUMsS0FBZ0IsRUFBRSxNQUFrQjtJQUN2RCxNQUFNLEVBQUUsY0FBYyxFQUFFLEdBQUcsS0FBSyxDQUFDO0lBQ2pDLE1BQU0sRUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFFLEdBQUcsTUFBTSxDQUFDO0lBQ2pDLE1BQU0sV0FBVyxHQUF1QixFQUFFLENBQUM7SUFDM0MsSUFBSSxjQUFjLEVBQUU7UUFDaEIsTUFBTSxRQUFRLEdBQUcsaUJBQWlCLENBQUMsY0FBYyxDQUFDLENBQUM7UUFDbkQsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQztRQUM3QixNQUFNLFFBQVEsR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDO1FBQ2hDLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxRQUFRLEVBQUUsQ0FBQyxFQUFFLEVBQUU7WUFDL0IsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLFFBQVEsRUFBRSxDQUFDLEVBQUUsRUFBRTtnQkFDL0IsTUFBTSxJQUFJLEdBQUcsUUFBUSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztnQkFDNUIsV0FBVyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQzthQUMxQjtTQUNKO0tBQ0o7SUFDRCxPQUFPLFdBQVcsQ0FBQztBQUN2QixDQUFDO0FBQ0Q7O0dBRUc7QUFDSCxNQUFNLE9BQU8sSUFBSyxTQUFRLEtBQUssQ0FBQyxhQUFtQztJQUMvRCxZQUFZLEtBQWdCO1FBQ3hCLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUNiLE1BQU0sTUFBTSxHQUFHLGtCQUFrQixDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ3pDLElBQUksQ0FBQyxLQUFLLEdBQUc7WUFDVCxNQUFNO1lBQ04sTUFBTSxFQUFFLGFBQWEsQ0FBQyxLQUFLLEVBQUUsTUFBTSxDQUFDO1NBQ3ZDLENBQUM7SUFDTixDQUFDO0lBQ0QsZ0NBQWdDLENBQUMsU0FBb0I7UUFDakQsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUM7UUFDckMsTUFBTSxVQUFVLEdBQUcsa0JBQWtCLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDakQsSUFBSSxDQUFDLFFBQVEsQ0FBQztZQUNWLE1BQU0sRUFBRSxVQUFVO1NBQ3JCLENBQUMsQ0FBQztRQUNILElBQUksU0FBUyxDQUFDLGNBQWMsS0FBSyxJQUFJLENBQUMsS0FBSyxDQUFDLGNBQWM7WUFDdEQsVUFBVSxDQUFDLElBQUksS0FBSyxVQUFVLENBQUMsSUFBSTtZQUNuQyxVQUFVLENBQUMsT0FBTyxLQUFLLFVBQVUsQ0FBQyxPQUFPLEVBQUU7WUFDM0MsSUFBSSxDQUFDLFFBQVEsQ0FBQztnQkFDVixNQUFNLEVBQUUsYUFBYSxDQUFDLFNBQVMsRUFBRSxVQUFVLENBQUM7YUFDL0MsQ0FBQyxDQUFDO1NBQ047SUFDTCxDQUFDO0lBQ0QsTUFBTTtRQUNGLE1BQU0sZUFBcUcsRUFBckcsRUFBRSxJQUFJLEVBQUUsRUFBRSxFQUFFLE9BQU8sRUFBRSxFQUFFLEVBQUUsT0FBTyxHQUFHLENBQUMsRUFBRSxjQUFjLEVBQUUsRUFBRSxFQUFFLFFBQVEsRUFBRSxRQUFRLE9BQXlCLEVBQXZCLDRGQUF1QixDQUFDO1FBQzVHLE1BQU0sRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFFLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQztRQUN0QyxNQUFNLEtBQUssR0FBRyxPQUFPLE9BQU8sS0FBSyxRQUFRLENBQUMsQ0FBQyxDQUFDLEdBQUcsT0FBTyxJQUFJLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQztRQUNyRSxNQUFNLGVBQWUsR0FBRyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDdEMsSUFBSSxPQUFPLFFBQVEsS0FBSyxVQUFVLEVBQUU7WUFDaEMsUUFBUSxDQUFDO2dCQUNMLE1BQU07YUFDVCxDQUFDLENBQUM7U0FDTjtRQUNELE9BQU8sQ0FBQyxvQkFBQyxpQkFBaUIsSUFBQyxHQUFHLEVBQUUsUUFBUTtZQUN2QyxDQUFDLENBQUMsTUFBTSxDQUFDLE1BQU0sSUFBSSxDQUFDLG9CQUFDLFVBQVUsSUFBQyxJQUFJLEVBQUUsTUFBTSxDQUFDLElBQUksRUFBRSxPQUFPLEVBQUUsTUFBTSxDQUFDLE9BQU8sRUFBRSxPQUFPLEVBQUUsZUFBZSxJQUNoRyxNQUFNLENBQ0ksQ0FBQztZQUNoQixvQkFBQyxVQUFVLGtCQUFDLElBQUksRUFBRSxNQUFNLENBQUMsSUFBSSxFQUFFLE9BQU8sRUFBRSxNQUFNLENBQUMsT0FBTyxFQUFFLE9BQU8sRUFBRSxlQUFlLElBQU0sS0FBSyxHQUN4RixNQUFNLENBQUMsS0FBSyxDQUNGLENBQ0ssQ0FBQyxDQUFDO0lBQ3hCLENBQUM7O0FBQ00sVUFBSyxHQUFHO0lBQ1gsSUFBSSxpQkFBaUIsS0FBSyxPQUFPLGlCQUE2QyxDQUFDLENBQUMsQ0FBQztJQUNqRixJQUFJLFVBQVUsS0FBSyxPQUFPLFVBQStCLENBQUMsQ0FBQyxDQUFDO0lBQzVELElBQUksVUFBVSxLQUFLLE9BQU8sVUFBK0IsQ0FBQyxDQUFDLENBQUM7Q0FDL0QsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIFJlYWN0IGZyb20gJ3JlYWN0JztcbmltcG9ydCBzdHlsZWQgZnJvbSAnLi4vLi4vdXRpbHMvc3R5bGVkJztcbmltcG9ydCB7IFN0YW5kYXJkUHJvcHMgfSBmcm9tICcuLi8uLi9jb21tb24nO1xuaW1wb3J0IHsgR3JpZEFyZWFQcm9wcyB9IGZyb20gJy4uL0dyaWRBcmVhJztcbmltcG9ydCB7IGNhbGNMYXlvdXQsIEdyaWRBbGxvY2F0aW9uIH0gZnJvbSAnLi4vLi4vdXRpbHMvZ3JpZExheW91dCc7XG5pbXBvcnQgeyBpc0lFIH0gZnJvbSAnLi4vLi4vdXRpbHMvYnJvd3Nlcic7XG5leHBvcnQgaW50ZXJmYWNlIEVtcHR5Q2VsbFJlbmRlcmVyIHtcbiAgICAocm93OiBudW1iZXIsIGNvbDogbnVtYmVyKTogSlNYLkVsZW1lbnQ7XG59XG5leHBvcnQgaW50ZXJmYWNlIEdyaWRQcm9wcyBleHRlbmRzIFN0YW5kYXJkUHJvcHMge1xuICAgIC8qKlxuICAgICAqIFNldHMgdGhlIG51bWJlciBvZiByb3dzIGluIHRoZSBncmlkLCBvdGhlcndpc2UgZWl0aGVyIDFcbiAgICAgKiAoY29sdW1ucyBub3QgZml4ZWQpIG9yIGR5bmFtaWMgKGNvbHVtbnMgZml4ZWQpLlxuICAgICAqIEEgc3RyaW5nIGluZGljYXRlcyB0aGUgaGVpZ2h0IG9mIHJvd3MgaW4gYSBkeW5hbWljIHNldHRpbmcuXG4gICAgICogQGRlZmF1bHQgMVxuICAgICAqL1xuICAgIHJvd3M/OiBudW1iZXIgfCBzdHJpbmcgfCBBcnJheTxzdHJpbmc+O1xuICAgIC8qKlxuICAgICAqIFNldHMgdGhlIG51bWJlciBvZiBjb2x1bW5zIGluIHRoZSBncmlkLCBvdGhlcndpc2UgZWl0aGVyXG4gICAgICogMSAocm93cyBub3QgZml4ZWQpIG9yIGR5bmFtaWMgKHJvd3MgZml4ZWQpLlxuICAgICAqIEEgc3RyaW5nIGluZGljYXRlcyB0aGUgd2lkdGggb2YgY29sdW1ucyBpbiBhIGR5bmFtaWMgc2V0dGluZy5cbiAgICAgKiBAZGVmYXVsdCAxXG4gICAgICovXG4gICAgY29sdW1ucz86IG51bWJlciB8IHN0cmluZyB8IEFycmF5PHN0cmluZz47XG4gICAgLyoqXG4gICAgICogT3B0aW9uYWxseSBzZXRzIHRoZSBzcGFjaW5nIGJldHdlZW4gdGhlIGdyaWQgY2VsbHMuXG4gICAgICogQnkgZGVmYXVsdCAwLCBvdGhlcndpc2UgYSBzaW5nbGUgdmFsdWUgc2V0cyB0aGVcbiAgICAgKiBzcGFjaW5nIGJldHdlZW4gcm93cyBhbmQgY29sdW1ucywgd2hpbGUgdHdvIHZhbHVlc1xuICAgICAqIHNldCB0aGUgc3BhY2luZyBiZXR3ZWVuIHRoZSByb3dzIGFuZCBjb2x1bW5zXG4gICAgICogcmVzcGVjdGl2ZWx5LlxuICAgICAqIEBkZWZhdWx0IDBcbiAgICAgKi9cbiAgICBzcGFjaW5nPzogbnVtYmVyIHwgc3RyaW5nIHwgW3N0cmluZywgc3RyaW5nXTtcbiAgICAvKipcbiAgICAgKiBTZXRzIHRoZSBncmlkJ3MgY2hpbGRyZW4uXG4gICAgICovXG4gICAgY2hpbGRyZW4/OiBSZWFjdC5SZWFjdE5vZGU7XG4gICAgLyoqXG4gICAgICogQnkgcHJvdmlkaW5nIHRoZSBzaG93IGVtcHR5IGNlbGwgcHJvcGVydHksIHRoZSBncmlkIHdpbGwgYXV0b21hdGljYWxseVxuICAgICAqIHJlbmRlciB0aGUgZW1wdHkgKGkuZS4sIHVudXNlZCkgY2VsbHMgYW5kIHBvcHVsYXRlIHRoZW0gdXNpbmcgdGhpc1xuICAgICAqIGNvbXBvbmVudC5cbiAgICAgKiBAZGVmYXVsdCBmYWxzZVxuICAgICAqL1xuICAgIHNob3dFbXB0eUNlbGxzPzogSlNYLkVsZW1lbnQgfCBFbXB0eUNlbGxSZW5kZXJlciB8IGJvb2xlYW47XG4gICAgLyoqXG4gICAgICogRXZlbnQgZmlyZWQgb25jZSB0aGUgbGF5b3V0IGhhcyBiZWVuIGNvbXB1dGVkLlxuICAgICAqL1xuICAgIG9uTGF5b3V0PyhlOiBHcmlkTGF5b3V0RXZlbnQpOiB2b2lkO1xuICAgIC8qKlxuICAgICAqIEdldHMgdGhlIHJlZmVyZW5jZSB0byB0aGUgdW5kZXJseWluZyBIVE1MIERPTSBlbGVtZW50LlxuICAgICAqL1xuICAgIGlubmVyUmVmPyhpbnN0YW5jZTogSFRNTEVsZW1lbnQgfCBudWxsKTogdm9pZDtcbn1cbmV4cG9ydCBpbnRlcmZhY2UgR3JpZExheW91dEV2ZW50IHtcbiAgICBsYXlvdXQ6IEdyaWRMYXlvdXQ7XG59XG5leHBvcnQgaW50ZXJmYWNlIEdyaWRMYXlvdXQge1xuICAgIGFsbG9jYXRpb246IEFycmF5PEdyaWRBbGxvY2F0aW9uPjtcbiAgICBjZWxsczogQXJyYXk8SlNYLkVsZW1lbnQgfCB1bmRlZmluZWQ+O1xuICAgIHJvd3M6IEFycmF5PHN0cmluZz47XG4gICAgY29sdW1uczogQXJyYXk8c3RyaW5nPjtcbn1cbmV4cG9ydCBpbnRlcmZhY2UgR3JpZFN0YXRlIHtcbiAgICBsYXlvdXQ6IEdyaWRMYXlvdXQ7XG4gICAgdW51c2VkOiBBcnJheTxKU1guRWxlbWVudD47XG59XG5pbnRlcmZhY2UgR3JpZExheW91dFByb3BzIHtcbiAgICByb3dzOiBBcnJheTxzdHJpbmc+O1xuICAgIGNvbHVtbnM6IEFycmF5PHN0cmluZz47XG4gICAgc3BhY2luZzogW3N0cmluZywgc3RyaW5nXTtcbn1cbmNvbnN0IFN0eWxlZEdyaWRXcmFwcGVyID0gc3R5bGVkLmRpdiBgXG4gIHBvc2l0aW9uOiByZWxhdGl2ZTtcbmA7XG5mdW5jdGlvbiBhZGRQeChvcmlnaW5hbDogc3RyaW5nLCBzcGFjZTogbnVtYmVyKSB7XG4gICAgaWYgKG9yaWdpbmFsLmVuZHNXaXRoKCdweCcpKSB7XG4gICAgICAgIGNvbnN0IGRpbSA9ICtvcmlnaW5hbC5yZXBsYWNlKCdweCcsICcnKTtcbiAgICAgICAgcmV0dXJuIGAke2RpbSArIHNwYWNlfXB4YDtcbiAgICB9XG4gICAgcmV0dXJuIG9yaWdpbmFsO1xufVxuZnVuY3Rpb24gY29tcHV0ZUllUm93cyhyb3dzOiBBcnJheTxzdHJpbmc+LCBzcGFjaW5nOiBbc3RyaW5nLCBzdHJpbmddKSB7XG4gICAgaWYgKGlzSUUgPT09ICdJRTExJykge1xuICAgICAgICBjb25zdCBbLCByb3dTcGFjZV0gPSBzcGFjaW5nO1xuICAgICAgICBpZiAocm93U3BhY2UgJiYgcm93U3BhY2UuZW5kc1dpdGgoJ3B4JykpIHtcbiAgICAgICAgICAgIGNvbnN0IHNwYWNlID0gK3Jvd1NwYWNlLnJlcGxhY2UoJ3B4JywgJycpO1xuICAgICAgICAgICAgaWYgKHNwYWNlKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgZW5kID0gcm93cy5sZW5ndGggLSAxO1xuICAgICAgICAgICAgICAgIHJldHVybiByb3dzLm1hcCgocm93LCBpKSA9PiAoaSAhPT0gZW5kID8gYWRkUHgocm93LCBzcGFjZSkgOiByb3cpKS5qb2luKCcgJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHJvd3Muam9pbignICcpO1xufVxuY29uc3QgQmFzaWNHcmlkTGF5b3V0ID0gc3R5bGVkLmRpdjxHcmlkTGF5b3V0UHJvcHM+IGBcbiAgaGVpZ2h0OiAxMDAlO1xuICB3aWR0aDogMTAwJTtcbiAgZGlzcGxheTogLW1zLWdyaWQ7XG4gIGRpc3BsYXk6IGdyaWQ7XG4gIC1tcy1ncmlkLWNvbHVtbnM6ICR7cHJvcHMgPT4gcHJvcHMuY29sdW1ucy5qb2luKCcgJyl9O1xuICBncmlkLXRlbXBsYXRlLWNvbHVtbnM6ICR7cHJvcHMgPT4gcHJvcHMuY29sdW1ucy5qb2luKCcgJyl9O1xuICAtbXMtZ3JpZC1yb3dzOiAke3Byb3BzID0+IGNvbXB1dGVJZVJvd3MocHJvcHMucm93cywgcHJvcHMuc3BhY2luZyl9O1xuICBncmlkLXRlbXBsYXRlLXJvd3M6ICR7cHJvcHMgPT4gcHJvcHMucm93cy5qb2luKCcgJyl9O1xuICBncmlkLWdhcDogJHtwcm9wcyA9PiBwcm9wcy5zcGFjaW5nLmpvaW4oJyAnKX07XG5gO1xuY29uc3QgR3JpZExheW91dCA9IHN0eWxlZChCYXNpY0dyaWRMYXlvdXQpIGBcbiAgb3BhY2l0eTogMC45OTk5O1xuYDtcbmNvbnN0IFNoYWRvd0dyaWQgPSBzdHlsZWQoQmFzaWNHcmlkTGF5b3V0KSBgXG4gIHBvc2l0aW9uOiBhYnNvbHV0ZTtcbmA7XG5jb25zdCBEZWZhdWx0VW51c2VkQ2VsbCA9IHN0eWxlZC5kaXYgYFxuICB3aWR0aDogMTAwJTtcbiAgaGVpZ2h0OiAxMDAlO1xuICBiYWNrZ3JvdW5kOiAjZjFmMWYxO1xuYDtcbmludGVyZmFjZSBHcmlkQ2VsbFByb3BzIHtcbiAgICByaTogbnVtYmVyO1xuICAgIHJmOiBudW1iZXI7XG4gICAgY2k6IG51bWJlcjtcbiAgICBjZjogbnVtYmVyO1xufVxuLy8gUmVtYXJrOlxuLy8gQXQgUFIgIzI1OCBhIGZpeCBmb3IgXCJjb21wbGV4IGNvbnRlbnQgdGhhdCBvdmVyZmxvd3NcIiB3YXMgaW50cm9kdWNlZFxuLy8gd2hpY2ggY2F1c2VkIHNvbWUgcHJvYmxlbS4gSWYgdGhpcyBmaXggc2hvdWxkIGJlIHJlcXVpcmVkIGluIHRoZSBmdXR1cmVcbi8vIGFnYWluIHdlIHNob3VsZCBicmluZyBpbiBzb21ldGhpbmcgbGlrZSB0aGUgZm9sbG93aW5nOlxuLy9cbi8vIGBgYGNzc1xuLy8gb3ZlcmZsb3c6IGF1dG87XG4vLyBtYXJnaW46IC0xZW07XG4vLyBwYWRkaW5nOiAxZW07XG4vLyBgYGBcbmNvbnN0IEdyaWRDZWxsID0gc3R5bGVkLmRpdjxHcmlkQ2VsbFByb3BzPiBgXG4gIC1tcy1ncmlkLXJvdzogJHtwcm9wcyA9PiBwcm9wcy5yaSArIDF9O1xuICAtbXMtZ3JpZC1yb3ctc3BhbjogJHtwcm9wcyA9PiBwcm9wcy5yZiAtIHByb3BzLnJpfTtcbiAgZ3JpZC1yb3c6ICR7cHJvcHMgPT4gcHJvcHMucmkgKyAxfSAvIHNwYW4gJHtwcm9wcyA9PiBwcm9wcy5yZiAtIHByb3BzLnJpfTtcbiAgLW1zLWdyaWQtY29sdW1uOiAke3Byb3BzID0+IHByb3BzLmNpICsgMX07XG4gIC1tcy1ncmlkLWNvbHVtbi1zcGFuOiAke3Byb3BzID0+IHByb3BzLmNmIC0gcHJvcHMuY2l9O1xuICBncmlkLWNvbHVtbjogJHtwcm9wcyA9PiBwcm9wcy5jaSArIDF9IC8gc3BhbiAke3Byb3BzID0+IHByb3BzLmNmIC0gcHJvcHMuY2l9O1xuICBtYXgtd2lkdGg6IDEwMCU7XG5gO1xuY29uc3QgSGlkZGVuR3JpZENlbGwgPSBzdHlsZWQuZGl2IGBcbiAgd2lkdGg6IDA7XG4gIGhlaWdodDogMDtcbiAgb3ZlcmZsb3c6IGhpZGRlbjtcbmA7XG5mdW5jdGlvbiByZXBlYXQobjogbnVtYmVyIHwgQXJyYXk8c3RyaW5nPiB8IHVuZGVmaW5lZCwgZGltID0gJzFmcicpIHtcbiAgICBpZiAodHlwZW9mIG4gPT09ICdudW1iZXInKSB7XG4gICAgICAgIGNvbnN0IGFycjogQXJyYXk8c3RyaW5nPiA9IFtdO1xuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG47IGkrKykge1xuICAgICAgICAgICAgYXJyLnB1c2goZGltKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gYXJyO1xuICAgIH1cbiAgICBlbHNlIGlmICghbikge1xuICAgICAgICByZXR1cm4gW2RpbV07XG4gICAgfVxuICAgIHJldHVybiBuO1xufVxuZnVuY3Rpb24gcGVyaW9kKHVuaXQ6IHN0cmluZyB8IFtzdHJpbmcsIHN0cmluZ10gfCB1bmRlZmluZWQpOiBbc3RyaW5nLCBzdHJpbmddIHtcbiAgICBpZiAodHlwZW9mIHVuaXQgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgIHJldHVybiBbdW5pdCwgdW5pdF07XG4gICAgfVxuICAgIGVsc2UgaWYgKCF1bml0KSB7XG4gICAgICAgIHJldHVybiBbJzAnLCAnMCddO1xuICAgIH1cbiAgICByZXR1cm4gdW5pdDtcbn1cbmZ1bmN0aW9uIGdldEVtcHR5Q29tcG9uZW50KHNob3dFbXB0eUNlbGxzOiBKU1guRWxlbWVudCB8IEVtcHR5Q2VsbFJlbmRlcmVyIHwgdHJ1ZSk6IEVtcHR5Q2VsbFJlbmRlcmVyIHtcbiAgICBpZiAoc2hvd0VtcHR5Q2VsbHMgPT09IHRydWUpIHtcbiAgICAgICAgcmV0dXJuIChyb3csIGNvbCkgPT4gPERlZmF1bHRVbnVzZWRDZWxsIGtleT17YHVjLSR7cm93fS0ke2NvbH1gfS8+O1xuICAgIH1cbiAgICBlbHNlIGlmICh0eXBlb2Ygc2hvd0VtcHR5Q2VsbHMgPT09ICdvYmplY3QnKSB7XG4gICAgICAgIHJldHVybiAocm93LCBjb2wpID0+IFJlYWN0LmNsb25lRWxlbWVudChzaG93RW1wdHlDZWxscywgeyBrZXk6IGB1Yy0ke3Jvd30tJHtjb2x9YCB9KTtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICAgIHJldHVybiBzaG93RW1wdHlDZWxscztcbiAgICB9XG59XG50eXBlIEdyaWRDaGlsZCA9IFJlYWN0LlJlYWN0RWxlbWVudDxHcmlkQXJlYVByb3BzPiAmIHtcbiAgICB0eXBlOiBzdHJpbmc7XG59O1xuZnVuY3Rpb24gY29tcHV0ZUFsbG9jYXRpb25zKHByb3BzOiBHcmlkUHJvcHMpOiBHcmlkTGF5b3V0IHtcbiAgICBjb25zdCB7IGNoaWxkcmVuLCByb3dzLCBjb2x1bW5zIH0gPSBwcm9wcztcbiAgICBjb25zdCBhbGxvY2F0aW9uOiBBcnJheTxHcmlkQWxsb2NhdGlvbj4gPSBbXTtcbiAgICBjb25zdCBsYXlvdXQgPSBjYWxjTGF5b3V0KGNoaWxkcmVuLCB7XG4gICAgICAgIHJvd3M6IHR5cGVvZiByb3dzICE9PSAnc3RyaW5nJyA/IHJvd3MgOiB1bmRlZmluZWQsXG4gICAgICAgIGNvbHVtbnM6IHR5cGVvZiBjb2x1bW5zICE9PSAnc3RyaW5nJyA/IGNvbHVtbnMgOiB1bmRlZmluZWQsXG4gICAgfSk7XG4gICAgY29uc3QgY2VsbHMgPSBSZWFjdC5DaGlsZHJlbi5tYXAoY2hpbGRyZW4sIChjaGlsZDogR3JpZENoaWxkLCBpbmRleCkgPT4ge1xuICAgICAgICBjb25zdCBwb3NpdGlvbiA9IGxheW91dC5jZWxsc1tpbmRleF07XG4gICAgICAgIGlmIChjaGlsZCAmJiBwb3NpdGlvbikge1xuICAgICAgICAgICAgYWxsb2NhdGlvbi5wdXNoKHBvc2l0aW9uKTtcbiAgICAgICAgICAgIGNvbnN0IHsgY29sU3BhbiwgY29sdW1uLCByb3csIHJvd1NwYW4gfSA9IHBvc2l0aW9uO1xuICAgICAgICAgICAgaWYgKCFjb2xTcGFuIHx8ICFyb3dTcGFuKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIDxIaWRkZW5HcmlkQ2VsbD57Y2hpbGR9PC9IaWRkZW5HcmlkQ2VsbD47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gKDxHcmlkQ2VsbCBjaT17Y29sdW1ufSBjZj17Y29sdW1uICsgY29sU3Bhbn0gcmk9e3Jvd30gcmY9e3JvdyArIHJvd1NwYW59IGtleT17aW5kZXh9PlxuICAgICAgICAgICAge2NoaWxkfVxuICAgICAgICAgIDwvR3JpZENlbGw+KTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH0pIHx8IFtdO1xuICAgIHJldHVybiB7XG4gICAgICAgIGFsbG9jYXRpb24sXG4gICAgICAgIGNlbGxzLFxuICAgICAgICByb3dzOiB0eXBlb2Ygcm93cyA9PT0gJ3N0cmluZycgPyByZXBlYXQobGF5b3V0LnJvd3MsIHJvd3MpIDogcmVwZWF0KHJvd3MgfHwgbGF5b3V0LnJvd3MpLFxuICAgICAgICBjb2x1bW5zOiB0eXBlb2YgY29sdW1ucyA9PT0gJ3N0cmluZycgPyByZXBlYXQobGF5b3V0LmNvbHVtbnMsIGNvbHVtbnMpIDogcmVwZWF0KGNvbHVtbnMgfHwgbGF5b3V0LmNvbHVtbnMpLFxuICAgIH07XG59XG5mdW5jdGlvbiBjb21wdXRlVW51c2VkKHByb3BzOiBHcmlkUHJvcHMsIGxheW91dDogR3JpZExheW91dCkge1xuICAgIGNvbnN0IHsgc2hvd0VtcHR5Q2VsbHMgfSA9IHByb3BzO1xuICAgIGNvbnN0IHsgcm93cywgY29sdW1ucyB9ID0gbGF5b3V0O1xuICAgIGNvbnN0IHVudXNlZENlbGxzOiBBcnJheTxKU1guRWxlbWVudD4gPSBbXTtcbiAgICBpZiAoc2hvd0VtcHR5Q2VsbHMpIHtcbiAgICAgICAgY29uc3QgcmVuZGVyZXIgPSBnZXRFbXB0eUNvbXBvbmVudChzaG93RW1wdHlDZWxscyk7XG4gICAgICAgIGNvbnN0IHJvd0NvdW50ID0gcm93cy5sZW5ndGg7XG4gICAgICAgIGNvbnN0IGNvbENvdW50ID0gY29sdW1ucy5sZW5ndGg7XG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcm93Q291bnQ7IGkrKykge1xuICAgICAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCBjb2xDb3VudDsgaisrKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgY2VsbCA9IHJlbmRlcmVyKGksIGopO1xuICAgICAgICAgICAgICAgIHVudXNlZENlbGxzLnB1c2goY2VsbCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHVudXNlZENlbGxzO1xufVxuLyoqXG4gKiBUaGUgYEdyaWRgIGNvbXBvbmVudCByZXByZXNlbnRzIGEgdW5pZm9ybSBncmlkLCBpLmUuLCBhIGdyaWQgdGhhdCBkb2VzIG5vdCBjaGFuZ2UgaXRzIGNvbHVtbiBsYXlvdXQgZnJvbSByb3cgdG8gcm93LlxuICovXG5leHBvcnQgY2xhc3MgR3JpZCBleHRlbmRzIFJlYWN0LlB1cmVDb21wb25lbnQ8R3JpZFByb3BzLCBHcmlkU3RhdGU+IHtcbiAgICBjb25zdHJ1Y3Rvcihwcm9wczogR3JpZFByb3BzKSB7XG4gICAgICAgIHN1cGVyKHByb3BzKTtcbiAgICAgICAgY29uc3QgbGF5b3V0ID0gY29tcHV0ZUFsbG9jYXRpb25zKHByb3BzKTtcbiAgICAgICAgdGhpcy5zdGF0ZSA9IHtcbiAgICAgICAgICAgIGxheW91dCxcbiAgICAgICAgICAgIHVudXNlZDogY29tcHV0ZVVudXNlZChwcm9wcywgbGF5b3V0KSxcbiAgICAgICAgfTtcbiAgICB9XG4gICAgVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMobmV4dFByb3BzOiBHcmlkUHJvcHMpIHtcbiAgICAgICAgY29uc3QgY3VyckxheW91dCA9IHRoaXMuc3RhdGUubGF5b3V0O1xuICAgICAgICBjb25zdCBuZXh0TGF5b3V0ID0gY29tcHV0ZUFsbG9jYXRpb25zKG5leHRQcm9wcyk7XG4gICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgbGF5b3V0OiBuZXh0TGF5b3V0LFxuICAgICAgICB9KTtcbiAgICAgICAgaWYgKG5leHRQcm9wcy5zaG93RW1wdHlDZWxscyAhPT0gdGhpcy5wcm9wcy5zaG93RW1wdHlDZWxscyB8fFxuICAgICAgICAgICAgbmV4dExheW91dC5yb3dzICE9PSBjdXJyTGF5b3V0LnJvd3MgfHxcbiAgICAgICAgICAgIG5leHRMYXlvdXQuY29sdW1ucyAhPT0gY3VyckxheW91dC5jb2x1bW5zKSB7XG4gICAgICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICAgICAgICB1bnVzZWQ6IGNvbXB1dGVVbnVzZWQobmV4dFByb3BzLCBuZXh0TGF5b3V0KSxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfVxuICAgIHJlbmRlcigpIHtcbiAgICAgICAgY29uc3QgeyByb3dzOiBfMCwgY29sdW1uczogXzEsIHNwYWNpbmcgPSAwLCBzaG93RW1wdHlDZWxsczogXzIsIG9uTGF5b3V0LCBpbm5lclJlZiwgLi4ucHJvcHMgfSA9IHRoaXMucHJvcHM7XG4gICAgICAgIGNvbnN0IHsgbGF5b3V0LCB1bnVzZWQgfSA9IHRoaXMuc3RhdGU7XG4gICAgICAgIGNvbnN0IHNwYWNlID0gdHlwZW9mIHNwYWNpbmcgPT09ICdudW1iZXInID8gYCR7c3BhY2luZ31weGAgOiBzcGFjaW5nO1xuICAgICAgICBjb25zdCBzZWxlY3RlZFNwYWNpbmcgPSBwZXJpb2Qoc3BhY2UpO1xuICAgICAgICBpZiAodHlwZW9mIG9uTGF5b3V0ID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICBvbkxheW91dCh7XG4gICAgICAgICAgICAgICAgbGF5b3V0LFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuICg8U3R5bGVkR3JpZFdyYXBwZXIgcmVmPXtpbm5lclJlZn0+XG4gICAgICAgIHshIXVudXNlZC5sZW5ndGggJiYgKDxTaGFkb3dHcmlkIHJvd3M9e2xheW91dC5yb3dzfSBjb2x1bW5zPXtsYXlvdXQuY29sdW1uc30gc3BhY2luZz17c2VsZWN0ZWRTcGFjaW5nfT5cbiAgICAgICAgICAgIHt1bnVzZWR9XG4gICAgICAgICAgPC9TaGFkb3dHcmlkPil9XG4gICAgICAgIDxHcmlkTGF5b3V0IHJvd3M9e2xheW91dC5yb3dzfSBjb2x1bW5zPXtsYXlvdXQuY29sdW1uc30gc3BhY2luZz17c2VsZWN0ZWRTcGFjaW5nfSB7Li4ucHJvcHN9PlxuICAgICAgICAgIHtsYXlvdXQuY2VsbHN9XG4gICAgICAgIDwvR3JpZExheW91dD5cbiAgICAgIDwvU3R5bGVkR3JpZFdyYXBwZXI+KTtcbiAgICB9XG4gICAgc3RhdGljIGlubmVyID0ge1xuICAgICAgICBnZXQgU3R5bGVkR3JpZFdyYXBwZXIoKSB7IHJldHVybiBTdHlsZWRHcmlkV3JhcHBlciBhcyB0eXBlb2YgU3R5bGVkR3JpZFdyYXBwZXI7IH0sXG4gICAgICAgIGdldCBTaGFkb3dHcmlkKCkgeyByZXR1cm4gU2hhZG93R3JpZCBhcyB0eXBlb2YgU2hhZG93R3JpZDsgfSxcbiAgICAgICAgZ2V0IEdyaWRMYXlvdXQoKSB7IHJldHVybiBHcmlkTGF5b3V0IGFzIHR5cGVvZiBHcmlkTGF5b3V0OyB9XG4gICAgfTtcbn1cbiJdfQ==