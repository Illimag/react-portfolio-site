var __rest = (this && this.__rest) || function (s, e) {
    var t = {};
    for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)
        t[p] = s[p];
    if (s != null && typeof Object.getOwnPropertySymbols === "function")
        for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) if (e.indexOf(p[i]) < 0)
            t[p[i]] = s[p[i]];
    return t;
};
import * as React from 'react';
import styled, { themed, css } from '../../utils/styled';
import { showInputInfo } from '../../utils/input';
import { StyledFileImagePreview, StyledFileItem, StyledFileList } from '../../quarks';
import { withFormContext } from '../../hoc/withFormContext';
import { Icon } from '../Icon';
import { IconLink } from '../IconLink';
import { Spinner } from '../Spinner';
import { distance } from '../../distance';
function getFiles(target, files = []) {
    target.push(...files);
    return target;
}
const StyledDropzone = styled.div(themed(({ disabled, active, theme }) => css `
      width: 100%;
      height: 100%;
      min-height: 150px;
      margin: 0 auto;
      padding: ${distance.medium};
      display: flex;
      flex-direction: row;
      justify-content: center;
      align-items: center;
      color: ${disabled ? theme.textDisabled : theme.text3};
      background-repeat: no-repeat;
      background-position: center;
      background-size: contain;
      background-color: ${disabled ? theme.ui3 : active ? theme.ui2 : theme.ui1};
      border: 1px ${disabled ? `solid ${theme.ui1}` : `dashed ${active ? theme.ui0 : theme.ui4}`};
      cursor: ${disabled ? 'no-drop' : 'pointer'};
      box-sizing: border-box;
    `));
const DropzoneLabel = styled.div `
  display: flex;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  flex: 1;
  pointer-events: none;
`;
const StyledLabel = styled.span `
  display: table-cell;
  vertical-align: middle;
  text-align: center;
`;
const StyledAction = styled.div `
  margin-top: ${distance.small};
  visibility: ${props => (props.active || props.disabled ? 'hidden' : 'visible')};
`;
const FileInput = styled.input `
  display: none;
`;
const Remove = styled.div `
  cursor: pointer;
  line-height: 1;
`;
class DropzoneInt extends React.Component {
    constructor(props) {
        super(props);
        this.addFileEntries = (files) => {
            const { multiple, form, name = '' } = this.props;
            if (!this.state.controlled) {
                if (form) {
                    form.change({
                        name,
                        value: multiple ? [...this.state.value, ...files] : files,
                    });
                }
                else {
                    this.setState(prevState => ({
                        value: multiple ? [...prevState.value, ...files] : files,
                        previews: [],
                    }), () => this.notifyChanges(this.state.value));
                }
            }
            else {
                this.notifyChanges(multiple ? [...this.state.value, ...files] : files);
            }
        };
        this.onDragOver = (e) => {
            e.preventDefault();
        };
        this.onDragEnter = () => {
            this.setState({ over: true });
        };
        this.onDragLeave = () => {
            this.setState({ over: false });
        };
        this.onOpenAction = () => {
            const { onOpen } = this.props;
            let open = true;
            if (typeof onOpen === 'function') {
                onOpen({
                    preventDefault() {
                        open = false;
                    },
                });
            }
            return open;
        };
        this.onDrop = (ev) => {
            ev.preventDefault();
            this.setState({ over: false });
            const acceptFiles = this.onOpenAction();
            if (!this.props.disabled && acceptFiles) {
                const droppedFiles = getFiles([], ev.dataTransfer.files);
                const files = this.props.multiple ? droppedFiles : [droppedFiles[0]];
                this.addFileEntries(files);
            }
        };
        this.onClick = (ev) => {
            const files = getFiles([], ev.target.files);
            if (files) {
                this.addFileEntries(files);
            }
            ev.preventDefault();
        };
        this.setInputRef = (el) => {
            this.fileInput = el;
        };
        this.openFilePicker = () => {
            const open = this.onOpenAction();
            if (open && this.fileInput) {
                this.fileInput.click();
            }
        };
        const value = props.value || props.defaultValue || [];
        this.state = {
            over: false,
            controlled: props.value !== undefined,
            value,
            previews: [],
            error: props.error,
        };
    }
    componentDidMount() {
        const { form } = this.props;
        const { controlled } = this.state;
        if (!controlled && form) {
            form.subscribe(this);
        }
    }
    componentWillUnmount() {
        const { form } = this.props;
        const { controlled } = this.state;
        if (!controlled && form) {
            form.unsubscribe(this);
        }
    }
    UNSAFE_componentWillReceiveProps(e) {
        const { controlled, value } = this.state;
        if (controlled && e.value && value !== e.value) {
            this.setState(() => ({
                value: e.value || [],
                previews: [],
                error: e.error,
            }));
        }
    }
    removeFileEntry(f) {
        const { form, name = '' } = this.props;
        if (!this.state.controlled) {
            if (form) {
                form.change({
                    name,
                    value: this.state.value.filter(file => f !== file),
                });
            }
            else {
                this.setState(prevState => ({
                    value: prevState.value.filter(file => f !== file),
                    previews: prevState.previews.filter(preview => preview.file !== f),
                }), () => this.notifyChanges(this.state.value));
            }
        }
        else {
            const files = this.state.value.filter(file => f !== file);
            this.notifyChanges(files);
        }
    }
    notifyChanges(files) {
        const { onChange } = this.props;
        if (typeof onChange === 'function') {
            onChange({
                value: files,
            });
        }
    }
    renderItem(f) {
        return (React.createElement(StyledFileItem, { key: f.name, name: f.name },
            React.createElement(Remove, { onClick: () => this.removeFileEntry(f) },
                React.createElement(Icon, { name: "RemoveCircle", size: 1 }))));
    }
    renderPreview(f) {
        const preview = this.state.previews.filter(preview => preview.file === f)[0];
        if (f.size > 1000000 || !f.type.match(/image/)) {
            return this.renderItem(f);
        }
        if (preview) {
            return (React.createElement(StyledFileImagePreview, { key: f.name, src: preview.data },
                React.createElement(Remove, { onClick: () => this.removeFileEntry(f) },
                    React.createElement(Icon, { name: "RemoveCircle", size: 1 }))));
        }
        const reader = new FileReader();
        reader.onload = (file => () => {
            const result = reader.result;
            typeof result === 'string' &&
                this.setState(prevState => ({
                    previews: [
                        ...prevState.previews,
                        {
                            file,
                            data: result,
                        },
                    ],
                }));
        })(f);
        reader.readAsDataURL(f);
        return (React.createElement(StyledFileImagePreview, { key: f.name },
            React.createElement(Spinner, { size: "small" })));
    }
    render() {
        const { value, over, error } = this.state;
        const _a = this.props, { message = 'Drop files here to upload', multiple, info, icon = 'FileDownload', theme, value: _0, defaultValue: _1, disabled, onChange: _2, preview: _3, onInput: _5, children } = _a, props = __rest(_a, ["message", "multiple", "info", "icon", "theme", "value", "defaultValue", "disabled", "onChange", "preview", "onInput", "children"]);
        return (React.createElement("div", Object.assign({}, props),
            React.createElement(StyledDropzone, { active: over, disabled: disabled, onDrop: this.onDrop, onDragOver: this.onDragOver, onDragLeave: this.onDragLeave, onDragEnter: this.onDragEnter, onClick: this.openFilePicker },
                React.createElement(DropzoneLabel, null,
                    React.createElement(Icon, { name: icon, size: 2 }),
                    React.createElement(StyledLabel, null,
                        message,
                        React.createElement(FileInput, { disabled: disabled, ref: this.setInputRef, type: "file", multiple: multiple, value: "", onChange: this.onClick }),
                        React.createElement(StyledAction, { active: over, disabled: disabled },
                            React.createElement(IconLink, { icon: "Add" }, children))))),
            value && value.length > 0 && (React.createElement(StyledFileList, null, value.map(file => (this.props.preview ? this.renderPreview(file) : this.renderItem(file))))),
            showInputInfo(error, info)));
    }
}
DropzoneInt.inner = {
    get StyledFileItem() { return StyledFileItem; },
    get Remove() { return Remove; },
    get Icon() { return Icon; },
    get StyledFileImagePreview() { return StyledFileImagePreview; },
    get Spinner() { return Spinner; },
    get StyledDropzone() { return StyledDropzone; },
    get DropzoneLabel() { return DropzoneLabel; },
    get StyledLabel() { return StyledLabel; },
    get FileInput() { return FileInput; },
    get StyledAction() { return StyledAction; },
    get IconLink() { return IconLink; },
    get StyledFileList() { return StyledFileList; }
};
export const Dropzone = withFormContext(DropzoneInt);
Dropzone.displayName = 'Dropzone';
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvY29tcG9uZW50cy9Ecm9wem9uZS9pbmRleC50c3giXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBQUEsT0FBTyxLQUFLLEtBQUssTUFBTSxPQUFPLENBQUM7QUFDL0IsT0FBTyxNQUFNLEVBQUUsRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDekQsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQ2xELE9BQU8sRUFBb0Isc0JBQXNCLEVBQUUsY0FBYyxFQUFFLGNBQWMsRUFBRSxNQUFNLGNBQWMsQ0FBQztBQUN4RyxPQUFPLEVBQW9CLGVBQWUsRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBQzlFLE9BQU8sRUFBRSxJQUFJLEVBQVksTUFBTSxTQUFTLENBQUM7QUFHekMsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUN2QyxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sWUFBWSxDQUFDO0FBQ3JDLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQTJCMUMsU0FBUyxRQUFRLENBQUMsTUFBbUIsRUFBRSxRQUFhLEVBQUU7SUFDbEQsTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLEtBQUssQ0FBQyxDQUFDO0lBQ3RCLE9BQU8sTUFBTSxDQUFDO0FBQ2xCLENBQUM7QUFZRCxNQUFNLGNBQWMsR0FBRyxNQUFNLENBQUMsR0FBRyxDQUFzQixNQUFNLENBQUMsQ0FBQyxFQUFFLFFBQVEsRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFLEVBQUUsRUFBRSxDQUFDLEdBQUcsQ0FBQzs7Ozs7aUJBS2xGLFFBQVEsQ0FBQyxNQUFNOzs7OztlQUtqQixRQUFRLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxLQUFLOzs7OzBCQUloQyxRQUFRLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLEdBQUc7b0JBQzNELFFBQVEsQ0FBQyxDQUFDLENBQUMsU0FBUyxLQUFLLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFDLFVBQVUsTUFBTSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxFQUFFO2dCQUNoRixRQUFRLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsU0FBUzs7S0FFM0MsQ0FBQyxDQUFDLENBQUM7QUFDUixNQUFNLGFBQWEsR0FBRyxNQUFNLENBQUMsR0FBRyxDQUFDOzs7Ozs7O0NBT2hDLENBQUM7QUFDRixNQUFNLFdBQVcsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDOzs7O0NBSS9CLENBQUM7QUFLRixNQUFNLFlBQVksR0FBRyxNQUFNLENBQUMsR0FBRyxDQUFvQjtnQkFDbkMsUUFBUSxDQUFDLEtBQUs7Z0JBQ2QsS0FBSyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxNQUFNLElBQUksS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUM7Q0FDL0UsQ0FBQztBQUNGLE1BQU0sU0FBUyxHQUFHLE1BQU0sQ0FBQyxLQUFLLENBQUM7O0NBRTlCLENBQUM7QUFDRixNQUFNLE1BQU0sR0FBRyxNQUFNLENBQUMsR0FBRyxDQUFDOzs7Q0FHekIsQ0FBQztBQUNGLE1BQU0sV0FBWSxTQUFRLEtBQUssQ0FBQyxTQUEwRDtJQUV0RixZQUFZLEtBQW9CO1FBQzVCLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztRQWtDVCxtQkFBYyxHQUFHLENBQUMsS0FBa0IsRUFBRSxFQUFFO1lBQzVDLE1BQU0sRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFFLElBQUksR0FBRyxFQUFFLEVBQUUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDO1lBQ2pELElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLFVBQVUsRUFBRTtnQkFDeEIsSUFBSSxJQUFJLEVBQUU7b0JBQ04sSUFBSSxDQUFDLE1BQU0sQ0FBQzt3QkFDUixJQUFJO3dCQUNKLEtBQUssRUFBRSxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssRUFBRSxHQUFHLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLO3FCQUM1RCxDQUFDLENBQUM7aUJBQ047cUJBQ0k7b0JBQ0QsSUFBSSxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsRUFBRSxDQUFDLENBQUM7d0JBQ3hCLEtBQUssRUFBRSxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxTQUFTLENBQUMsS0FBSyxFQUFFLEdBQUcsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUs7d0JBQ3hELFFBQVEsRUFBRSxFQUFFO3FCQUNmLENBQUMsRUFBRSxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztpQkFDbkQ7YUFDSjtpQkFDSTtnQkFDRCxJQUFJLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxFQUFFLEdBQUcsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDO2FBQzFFO1FBQ0wsQ0FBQyxDQUFDO1FBQ00sZUFBVSxHQUFHLENBQUMsQ0FBa0IsRUFBRSxFQUFFO1lBQ3hDLENBQUMsQ0FBQyxjQUFjLEVBQUUsQ0FBQztRQUN2QixDQUFDLENBQUM7UUFDTSxnQkFBVyxHQUFHLEdBQUcsRUFBRTtZQUN2QixJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxDQUFDLENBQUM7UUFDbEMsQ0FBQyxDQUFDO1FBQ00sZ0JBQVcsR0FBRyxHQUFHLEVBQUU7WUFDdkIsSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDO1FBQ25DLENBQUMsQ0FBQztRQUNNLGlCQUFZLEdBQUcsR0FBRyxFQUFFO1lBQ3hCLE1BQU0sRUFBRSxNQUFNLEVBQUUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDO1lBQzlCLElBQUksSUFBSSxHQUFHLElBQUksQ0FBQztZQUNoQixJQUFJLE9BQU8sTUFBTSxLQUFLLFVBQVUsRUFBRTtnQkFDOUIsTUFBTSxDQUFDO29CQUNILGNBQWM7d0JBQ1YsSUFBSSxHQUFHLEtBQUssQ0FBQztvQkFDakIsQ0FBQztpQkFDSixDQUFDLENBQUM7YUFDTjtZQUNELE9BQU8sSUFBSSxDQUFDO1FBQ2hCLENBQUMsQ0FBQztRQUNNLFdBQU0sR0FBRyxDQUFDLEVBQW1CLEVBQUUsRUFBRTtZQUNyQyxFQUFFLENBQUMsY0FBYyxFQUFFLENBQUM7WUFDcEIsSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDO1lBQy9CLE1BQU0sV0FBVyxHQUFHLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQztZQUN4QyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLElBQUksV0FBVyxFQUFFO2dCQUNyQyxNQUFNLFlBQVksR0FBRyxRQUFRLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FBQyxZQUFZLENBQUMsS0FBSyxDQUFDLENBQUM7Z0JBQ3pELE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQ3JFLElBQUksQ0FBQyxjQUFjLENBQUMsS0FBSyxDQUFDLENBQUM7YUFDOUI7UUFDTCxDQUFDLENBQUM7UUFDTSxZQUFPLEdBQUcsQ0FBQyxFQUF1QyxFQUFFLEVBQUU7WUFDMUQsTUFBTSxLQUFLLEdBQUcsUUFBUSxDQUFDLEVBQUUsRUFBRSxFQUFFLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQzVDLElBQUksS0FBSyxFQUFFO2dCQUNQLElBQUksQ0FBQyxjQUFjLENBQUMsS0FBSyxDQUFDLENBQUM7YUFDOUI7WUFDRCxFQUFFLENBQUMsY0FBYyxFQUFFLENBQUM7UUFDeEIsQ0FBQyxDQUFDO1FBQ00sZ0JBQVcsR0FBRyxDQUFDLEVBQW9CLEVBQUUsRUFBRTtZQUMzQyxJQUFJLENBQUMsU0FBUyxHQUFHLEVBQUUsQ0FBQztRQUN4QixDQUFDLENBQUM7UUFDTSxtQkFBYyxHQUFHLEdBQUcsRUFBRTtZQUMxQixNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsWUFBWSxFQUFFLENBQUM7WUFDakMsSUFBSSxJQUFJLElBQUksSUFBSSxDQUFDLFNBQVMsRUFBRTtnQkFDeEIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLEVBQUUsQ0FBQzthQUMxQjtRQUNMLENBQUMsQ0FBQztRQW5HRSxNQUFNLEtBQUssR0FBRyxLQUFLLENBQUMsS0FBSyxJQUFJLEtBQUssQ0FBQyxZQUFZLElBQUksRUFBRSxDQUFDO1FBQ3RELElBQUksQ0FBQyxLQUFLLEdBQUc7WUFDVCxJQUFJLEVBQUUsS0FBSztZQUNYLFVBQVUsRUFBRSxLQUFLLENBQUMsS0FBSyxLQUFLLFNBQVM7WUFDckMsS0FBSztZQUNMLFFBQVEsRUFBRSxFQUFFO1lBQ1osS0FBSyxFQUFFLEtBQUssQ0FBQyxLQUFLO1NBQ3JCLENBQUM7SUFDTixDQUFDO0lBQ0QsaUJBQWlCO1FBQ2IsTUFBTSxFQUFFLElBQUksRUFBRSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUM7UUFDNUIsTUFBTSxFQUFFLFVBQVUsRUFBRSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUM7UUFDbEMsSUFBSSxDQUFDLFVBQVUsSUFBSSxJQUFJLEVBQUU7WUFDckIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUN4QjtJQUNMLENBQUM7SUFDRCxvQkFBb0I7UUFDaEIsTUFBTSxFQUFFLElBQUksRUFBRSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUM7UUFDNUIsTUFBTSxFQUFFLFVBQVUsRUFBRSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUM7UUFDbEMsSUFBSSxDQUFDLFVBQVUsSUFBSSxJQUFJLEVBQUU7WUFDckIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUMxQjtJQUNMLENBQUM7SUFDRCxnQ0FBZ0MsQ0FBQyxDQUFnQjtRQUM3QyxNQUFNLEVBQUUsVUFBVSxFQUFFLEtBQUssRUFBRSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUM7UUFDekMsSUFBSSxVQUFVLElBQUksQ0FBQyxDQUFDLEtBQUssSUFBSSxLQUFLLEtBQUssQ0FBQyxDQUFDLEtBQUssRUFBRTtZQUM1QyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUM7Z0JBQ2pCLEtBQUssRUFBRSxDQUFDLENBQUMsS0FBSyxJQUFJLEVBQUU7Z0JBQ3BCLFFBQVEsRUFBRSxFQUFFO2dCQUNaLEtBQUssRUFBRSxDQUFDLENBQUMsS0FBSzthQUNqQixDQUFDLENBQUMsQ0FBQztTQUNQO0lBQ0wsQ0FBQztJQW9FTyxlQUFlLENBQUMsQ0FBTztRQUMzQixNQUFNLEVBQUUsSUFBSSxFQUFFLElBQUksR0FBRyxFQUFFLEVBQUUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDO1FBQ3ZDLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLFVBQVUsRUFBRTtZQUN4QixJQUFJLElBQUksRUFBRTtnQkFDTixJQUFJLENBQUMsTUFBTSxDQUFDO29CQUNSLElBQUk7b0JBQ0osS0FBSyxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsS0FBSyxJQUFJLENBQUM7aUJBQ3JELENBQUMsQ0FBQzthQUNOO2lCQUNJO2dCQUNELElBQUksQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLEVBQUUsQ0FBQyxDQUFDO29CQUN4QixLQUFLLEVBQUUsU0FBUyxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLEtBQUssSUFBSSxDQUFDO29CQUNqRCxRQUFRLEVBQUUsU0FBUyxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxPQUFPLENBQUMsSUFBSSxLQUFLLENBQUMsQ0FBQztpQkFDckUsQ0FBQyxFQUFFLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO2FBQ25EO1NBQ0o7YUFDSTtZQUNELE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsS0FBSyxJQUFJLENBQUMsQ0FBQztZQUMxRCxJQUFJLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQyxDQUFDO1NBQzdCO0lBQ0wsQ0FBQztJQUNPLGFBQWEsQ0FBQyxLQUFrQjtRQUNwQyxNQUFNLEVBQUUsUUFBUSxFQUFFLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQztRQUNoQyxJQUFJLE9BQU8sUUFBUSxLQUFLLFVBQVUsRUFBRTtZQUNoQyxRQUFRLENBQUM7Z0JBQ0wsS0FBSyxFQUFFLEtBQUs7YUFDZixDQUFDLENBQUM7U0FDTjtJQUNMLENBQUM7SUFDTyxVQUFVLENBQUMsQ0FBTztRQUN0QixPQUFPLENBQUMsb0JBQUMsY0FBYyxJQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsSUFBSSxFQUFFLElBQUksRUFBRSxDQUFDLENBQUMsSUFBSTtZQUNqRCxvQkFBQyxNQUFNLElBQUMsT0FBTyxFQUFFLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsQ0FBQyxDQUFDO2dCQUM1QyxvQkFBQyxJQUFJLElBQUMsSUFBSSxFQUFDLGNBQWMsRUFBQyxJQUFJLEVBQUUsQ0FBQyxHQUFHLENBQzdCLENBQ00sQ0FBQyxDQUFDO0lBQ3JCLENBQUM7SUFDTyxhQUFhLENBQUMsQ0FBTztRQUN6QixNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxPQUFPLENBQUMsSUFBSSxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQzdFLElBQUksQ0FBQyxDQUFDLElBQUksR0FBRyxPQUFPLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsRUFBRTtZQUM1QyxPQUFPLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUM7U0FDN0I7UUFDRCxJQUFJLE9BQU8sRUFBRTtZQUNULE9BQU8sQ0FBQyxvQkFBQyxzQkFBc0IsSUFBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDLElBQUksRUFBRSxHQUFHLEVBQUUsT0FBTyxDQUFDLElBQUk7Z0JBQ2hFLG9CQUFDLE1BQU0sSUFBQyxPQUFPLEVBQUUsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUM7b0JBQzVDLG9CQUFDLElBQUksSUFBQyxJQUFJLEVBQUMsY0FBYyxFQUFDLElBQUksRUFBRSxDQUFDLEdBQUcsQ0FDN0IsQ0FDYyxDQUFDLENBQUM7U0FDMUI7UUFDRCxNQUFNLE1BQU0sR0FBRyxJQUFJLFVBQVUsRUFBRSxDQUFDO1FBQ2hDLE1BQU0sQ0FBQyxNQUFNLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLEdBQUcsRUFBRTtZQUMxQixNQUFNLE1BQU0sR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDO1lBQzdCLE9BQU8sTUFBTSxLQUFLLFFBQVE7Z0JBQ3RCLElBQUksQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLEVBQUUsQ0FBQyxDQUFDO29CQUN4QixRQUFRLEVBQUU7d0JBQ04sR0FBRyxTQUFTLENBQUMsUUFBUTt3QkFDckI7NEJBQ0ksSUFBSTs0QkFDSixJQUFJLEVBQUUsTUFBTTt5QkFDZjtxQkFDSjtpQkFDSixDQUFDLENBQUMsQ0FBQztRQUNaLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ04sTUFBTSxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUN4QixPQUFPLENBQUMsb0JBQUMsc0JBQXNCLElBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxJQUFJO1lBQzNDLG9CQUFDLE9BQU8sSUFBQyxJQUFJLEVBQUMsT0FBTyxHQUFFLENBQ0EsQ0FBQyxDQUFDO0lBQzdCLENBQUM7SUFDRCxNQUFNO1FBQ0YsTUFBTSxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQztRQUMxQyxNQUFNLGVBQXVNLEVBQXZNLEVBQUUsT0FBTyxHQUFHLDJCQUEyQixFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsSUFBSSxHQUFHLGNBQWMsRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLEVBQUUsRUFBRSxZQUFZLEVBQUUsRUFBRSxFQUFFLFFBQVEsRUFBRSxRQUFRLEVBQUUsRUFBRSxFQUFFLE9BQU8sRUFBRSxFQUFFLEVBQUUsT0FBTyxFQUFFLEVBQUUsRUFBRSxRQUFRLE9BQXlCLEVBQXZCLHVKQUF1QixDQUFDO1FBQzlNLE9BQU8sQ0FBQyw2Q0FBUyxLQUFLO1lBQ3RCLG9CQUFDLGNBQWMsSUFBQyxNQUFNLEVBQUUsSUFBSSxFQUFFLFFBQVEsRUFBRSxRQUFRLEVBQUUsTUFBTSxFQUFFLElBQUksQ0FBQyxNQUFNLEVBQUUsVUFBVSxFQUFFLElBQUksQ0FBQyxVQUFVLEVBQUUsV0FBVyxFQUFFLElBQUksQ0FBQyxXQUFXLEVBQUUsV0FBVyxFQUFFLElBQUksQ0FBQyxXQUFXLEVBQUUsT0FBTyxFQUFFLElBQUksQ0FBQyxjQUFjO2dCQUM1TCxvQkFBQyxhQUFhO29CQUNaLG9CQUFDLElBQUksSUFBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxDQUFDLEdBQUc7b0JBQzVCLG9CQUFDLFdBQVc7d0JBQ1QsT0FBTzt3QkFDUixvQkFBQyxTQUFTLElBQUMsUUFBUSxFQUFFLFFBQVEsRUFBRSxHQUFHLEVBQUUsSUFBSSxDQUFDLFdBQVcsRUFBRSxJQUFJLEVBQUMsTUFBTSxFQUFDLFFBQVEsRUFBRSxRQUFRLEVBQUUsS0FBSyxFQUFDLEVBQUUsRUFBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLE9BQU8sR0FBRzt3QkFDeEgsb0JBQUMsWUFBWSxJQUFDLE1BQU0sRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFLFFBQVE7NEJBQzVDLG9CQUFDLFFBQVEsSUFBQyxJQUFJLEVBQUMsS0FBSyxJQUFFLFFBQVEsQ0FBWSxDQUM3QixDQUNILENBQ0EsQ0FDRDtZQUNoQixLQUFLLElBQUksS0FBSyxDQUFDLE1BQU0sR0FBRyxDQUFDLElBQUksQ0FBQyxvQkFBQyxjQUFjLFFBQ3pDLEtBQUssQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FDNUUsQ0FBQztZQUNuQixhQUFhLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxDQUN2QixDQUFDLENBQUM7SUFDVixDQUFDOztBQUNNLGlCQUFLLEdBQUc7SUFDWCxJQUFJLGNBQWMsS0FBSyxPQUFPLGNBQXVDLENBQUMsQ0FBQyxDQUFDO0lBQ3hFLElBQUksTUFBTSxLQUFLLE9BQU8sTUFBdUIsQ0FBQyxDQUFDLENBQUM7SUFDaEQsSUFBSSxJQUFJLEtBQUssT0FBTyxJQUFtQixDQUFDLENBQUMsQ0FBQztJQUMxQyxJQUFJLHNCQUFzQixLQUFLLE9BQU8sc0JBQXVELENBQUMsQ0FBQyxDQUFDO0lBQ2hHLElBQUksT0FBTyxLQUFLLE9BQU8sT0FBeUIsQ0FBQyxDQUFDLENBQUM7SUFDbkQsSUFBSSxjQUFjLEtBQUssT0FBTyxjQUF1QyxDQUFDLENBQUMsQ0FBQztJQUN4RSxJQUFJLGFBQWEsS0FBSyxPQUFPLGFBQXFDLENBQUMsQ0FBQyxDQUFDO0lBQ3JFLElBQUksV0FBVyxLQUFLLE9BQU8sV0FBaUMsQ0FBQyxDQUFDLENBQUM7SUFDL0QsSUFBSSxTQUFTLEtBQUssT0FBTyxTQUE2QixDQUFDLENBQUMsQ0FBQztJQUN6RCxJQUFJLFlBQVksS0FBSyxPQUFPLFlBQW1DLENBQUMsQ0FBQyxDQUFDO0lBQ2xFLElBQUksUUFBUSxLQUFLLE9BQU8sUUFBMkIsQ0FBQyxDQUFDLENBQUM7SUFDdEQsSUFBSSxjQUFjLEtBQUssT0FBTyxjQUF1QyxDQUFDLENBQUMsQ0FBQztDQUMzRSxDQUFDO0FBRU4sTUFBTSxDQUFDLE1BQU0sUUFBUSxHQUFHLGVBQWUsQ0FBQyxXQUFXLENBQUMsQ0FBQztBQUNyRCxRQUFRLENBQUMsV0FBVyxHQUFHLFVBQVUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIFJlYWN0IGZyb20gJ3JlYWN0JztcbmltcG9ydCBzdHlsZWQsIHsgdGhlbWVkLCBjc3MgfSBmcm9tICcuLi8uLi91dGlscy9zdHlsZWQnO1xuaW1wb3J0IHsgc2hvd0lucHV0SW5mbyB9IGZyb20gJy4uLy4uL3V0aWxzL2lucHV0JztcbmltcG9ydCB7IEZpbGVJbWFnZVByZXZpZXcsIFN0eWxlZEZpbGVJbWFnZVByZXZpZXcsIFN0eWxlZEZpbGVJdGVtLCBTdHlsZWRGaWxlTGlzdCB9IGZyb20gJy4uLy4uL3F1YXJrcyc7XG5pbXBvcnQgeyBGb3JtQ29udGV4dFByb3BzLCB3aXRoRm9ybUNvbnRleHQgfSBmcm9tICcuLi8uLi9ob2Mvd2l0aEZvcm1Db250ZXh0JztcbmltcG9ydCB7IEljb24sIEljb25OYW1lIH0gZnJvbSAnLi4vSWNvbic7XG5pbXBvcnQgeyBJbnB1dENoYW5nZUV2ZW50LCBJbnB1dFByb3BzIH0gZnJvbSAnLi4vLi4vY29tbW9uJztcbmltcG9ydCB7IEZpbGVTZWxlY3RPcGVuRXZlbnQgfSBmcm9tICcuLi9GaWxlU2VsZWN0JztcbmltcG9ydCB7IEljb25MaW5rIH0gZnJvbSAnLi4vSWNvbkxpbmsnO1xuaW1wb3J0IHsgU3Bpbm5lciB9IGZyb20gJy4uL1NwaW5uZXInO1xuaW1wb3J0IHsgZGlzdGFuY2UgfSBmcm9tICcuLi8uLi9kaXN0YW5jZSc7XG5leHBvcnQgdHlwZSBEcm9wem9uZU9wZW5FdmVudCA9IEZpbGVTZWxlY3RPcGVuRXZlbnQ7XG5leHBvcnQgdHlwZSBEcm9wem9uZUNoYW5nZUV2ZW50ID0gSW5wdXRDaGFuZ2VFdmVudDxBcnJheTxGaWxlPj47XG5leHBvcnQgaW50ZXJmYWNlIERyb3B6b25lUHJvcHMgZXh0ZW5kcyBJbnB1dFByb3BzPEFycmF5PEZpbGU+PiB7XG4gICAgLyoqXG4gICAgICogU2hvdyBwcmV2aWV3IGluc3RlYWQgb2YgZmlsZSBsaXN0LlxuICAgICAqL1xuICAgIHByZXZpZXc/OiBib29sZWFuO1xuICAgIC8qKlxuICAgICAqIEFsbG93IGFkZGluZyBtdWx0aXBsZSBmaWxlcy5cbiAgICAgKi9cbiAgICBtdWx0aXBsZT86IGJvb2xlYW47XG4gICAgLyoqXG4gICAgICogT3B0aW9uYWxseSBjaG9vc2VzIGFuIGljb24gdG8gZGlzcGxheS5cbiAgICAgKiBAZGVmYXVsdCBcIkZpbGVEb3dubG9hZFwiXG4gICAgICovXG4gICAgaWNvbj86IEljb25OYW1lO1xuICAgIC8qKlxuICAgICAqIEV2ZW50IGZpcmVkIHdoZW4gdGhlIGZpbGUgcGlja2VyIHNob3VsZCBiZSBvcGVuZWQuXG4gICAgICovXG4gICAgb25PcGVuPyhlOiBEcm9wem9uZU9wZW5FdmVudCk6IHZvaWQ7XG4gICAgLyoqXG4gICAgICogTWVzc2FnZSBmb3IgZHJhZ2dpbmcgZmlsZXMgdG8gc2hvdyBvbiBkcm9wIGFyZWEuXG4gICAgICogQGRlZmF1bHQgXCJEcm9wIGZpbGVzIGhlcmUgdG8gdXBsb2FkXCJcbiAgICAgKi9cbiAgICBtZXNzYWdlPzogc3RyaW5nO1xufVxuZnVuY3Rpb24gZ2V0RmlsZXModGFyZ2V0OiBBcnJheTxGaWxlPiwgZmlsZXM6IGFueSA9IFtdKSB7XG4gICAgdGFyZ2V0LnB1c2goLi4uZmlsZXMpO1xuICAgIHJldHVybiB0YXJnZXQ7XG59XG5leHBvcnQgaW50ZXJmYWNlIERyb3B6b25lU3RhdGUge1xuICAgIHZhbHVlOiBBcnJheTxGaWxlPjtcbiAgICBlcnJvcj86IFJlYWN0LlJlYWN0Q2hpbGQ7XG4gICAgY29udHJvbGxlZDogYm9vbGVhbjtcbiAgICBvdmVyOiBib29sZWFuO1xuICAgIHByZXZpZXdzOiBBcnJheTxGaWxlSW1hZ2VQcmV2aWV3Pjtcbn1cbmludGVyZmFjZSBTdHlsZWREcm9wem9uZVByb3BzIGV4dGVuZHMgUmVhY3QuSFRNTEF0dHJpYnV0ZXM8SFRNTERpdkVsZW1lbnQ+IHtcbiAgICBhY3RpdmU6IGJvb2xlYW47XG4gICAgZGlzYWJsZWQ/OiBib29sZWFuO1xufVxuY29uc3QgU3R5bGVkRHJvcHpvbmUgPSBzdHlsZWQuZGl2PFN0eWxlZERyb3B6b25lUHJvcHM+KHRoZW1lZCgoeyBkaXNhYmxlZCwgYWN0aXZlLCB0aGVtZSB9KSA9PiBjc3MgYFxuICAgICAgd2lkdGg6IDEwMCU7XG4gICAgICBoZWlnaHQ6IDEwMCU7XG4gICAgICBtaW4taGVpZ2h0OiAxNTBweDtcbiAgICAgIG1hcmdpbjogMCBhdXRvO1xuICAgICAgcGFkZGluZzogJHtkaXN0YW5jZS5tZWRpdW19O1xuICAgICAgZGlzcGxheTogZmxleDtcbiAgICAgIGZsZXgtZGlyZWN0aW9uOiByb3c7XG4gICAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjtcbiAgICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7XG4gICAgICBjb2xvcjogJHtkaXNhYmxlZCA/IHRoZW1lLnRleHREaXNhYmxlZCA6IHRoZW1lLnRleHQzfTtcbiAgICAgIGJhY2tncm91bmQtcmVwZWF0OiBuby1yZXBlYXQ7XG4gICAgICBiYWNrZ3JvdW5kLXBvc2l0aW9uOiBjZW50ZXI7XG4gICAgICBiYWNrZ3JvdW5kLXNpemU6IGNvbnRhaW47XG4gICAgICBiYWNrZ3JvdW5kLWNvbG9yOiAke2Rpc2FibGVkID8gdGhlbWUudWkzIDogYWN0aXZlID8gdGhlbWUudWkyIDogdGhlbWUudWkxfTtcbiAgICAgIGJvcmRlcjogMXB4ICR7ZGlzYWJsZWQgPyBgc29saWQgJHt0aGVtZS51aTF9YCA6IGBkYXNoZWQgJHthY3RpdmUgPyB0aGVtZS51aTAgOiB0aGVtZS51aTR9YH07XG4gICAgICBjdXJzb3I6ICR7ZGlzYWJsZWQgPyAnbm8tZHJvcCcgOiAncG9pbnRlcid9O1xuICAgICAgYm94LXNpemluZzogYm9yZGVyLWJveDtcbiAgICBgKSk7XG5jb25zdCBEcm9wem9uZUxhYmVsID0gc3R5bGVkLmRpdiBgXG4gIGRpc3BsYXk6IGZsZXg7XG4gIGFsaWduLWl0ZW1zOiBjZW50ZXI7XG4gIGp1c3RpZnktY29udGVudDogY2VudGVyO1xuICBmbGV4LWRpcmVjdGlvbjogY29sdW1uO1xuICBmbGV4OiAxO1xuICBwb2ludGVyLWV2ZW50czogbm9uZTtcbmA7XG5jb25zdCBTdHlsZWRMYWJlbCA9IHN0eWxlZC5zcGFuIGBcbiAgZGlzcGxheTogdGFibGUtY2VsbDtcbiAgdmVydGljYWwtYWxpZ246IG1pZGRsZTtcbiAgdGV4dC1hbGlnbjogY2VudGVyO1xuYDtcbmludGVyZmFjZSBTdHlsZWRBY3Rpb25Qcm9wcyB7XG4gICAgYWN0aXZlOiBib29sZWFuO1xuICAgIGRpc2FibGVkPzogYm9vbGVhbjtcbn1cbmNvbnN0IFN0eWxlZEFjdGlvbiA9IHN0eWxlZC5kaXY8U3R5bGVkQWN0aW9uUHJvcHM+IGBcbiAgbWFyZ2luLXRvcDogJHtkaXN0YW5jZS5zbWFsbH07XG4gIHZpc2liaWxpdHk6ICR7cHJvcHMgPT4gKHByb3BzLmFjdGl2ZSB8fCBwcm9wcy5kaXNhYmxlZCA/ICdoaWRkZW4nIDogJ3Zpc2libGUnKX07XG5gO1xuY29uc3QgRmlsZUlucHV0ID0gc3R5bGVkLmlucHV0IGBcbiAgZGlzcGxheTogbm9uZTtcbmA7XG5jb25zdCBSZW1vdmUgPSBzdHlsZWQuZGl2IGBcbiAgY3Vyc29yOiBwb2ludGVyO1xuICBsaW5lLWhlaWdodDogMTtcbmA7XG5jbGFzcyBEcm9wem9uZUludCBleHRlbmRzIFJlYWN0LkNvbXBvbmVudDxEcm9wem9uZVByb3BzICYgRm9ybUNvbnRleHRQcm9wcywgRHJvcHpvbmVTdGF0ZT4ge1xuICAgIHByaXZhdGUgZmlsZUlucHV0OiBIVE1MSW5wdXRFbGVtZW50IHwgbnVsbDtcbiAgICBjb25zdHJ1Y3Rvcihwcm9wczogRHJvcHpvbmVQcm9wcykge1xuICAgICAgICBzdXBlcihwcm9wcyk7XG4gICAgICAgIGNvbnN0IHZhbHVlID0gcHJvcHMudmFsdWUgfHwgcHJvcHMuZGVmYXVsdFZhbHVlIHx8IFtdO1xuICAgICAgICB0aGlzLnN0YXRlID0ge1xuICAgICAgICAgICAgb3ZlcjogZmFsc2UsXG4gICAgICAgICAgICBjb250cm9sbGVkOiBwcm9wcy52YWx1ZSAhPT0gdW5kZWZpbmVkLFxuICAgICAgICAgICAgdmFsdWUsXG4gICAgICAgICAgICBwcmV2aWV3czogW10sXG4gICAgICAgICAgICBlcnJvcjogcHJvcHMuZXJyb3IsXG4gICAgICAgIH07XG4gICAgfVxuICAgIGNvbXBvbmVudERpZE1vdW50KCkge1xuICAgICAgICBjb25zdCB7IGZvcm0gfSA9IHRoaXMucHJvcHM7XG4gICAgICAgIGNvbnN0IHsgY29udHJvbGxlZCB9ID0gdGhpcy5zdGF0ZTtcbiAgICAgICAgaWYgKCFjb250cm9sbGVkICYmIGZvcm0pIHtcbiAgICAgICAgICAgIGZvcm0uc3Vic2NyaWJlKHRoaXMpO1xuICAgICAgICB9XG4gICAgfVxuICAgIGNvbXBvbmVudFdpbGxVbm1vdW50KCkge1xuICAgICAgICBjb25zdCB7IGZvcm0gfSA9IHRoaXMucHJvcHM7XG4gICAgICAgIGNvbnN0IHsgY29udHJvbGxlZCB9ID0gdGhpcy5zdGF0ZTtcbiAgICAgICAgaWYgKCFjb250cm9sbGVkICYmIGZvcm0pIHtcbiAgICAgICAgICAgIGZvcm0udW5zdWJzY3JpYmUodGhpcyk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMoZTogRHJvcHpvbmVQcm9wcykge1xuICAgICAgICBjb25zdCB7IGNvbnRyb2xsZWQsIHZhbHVlIH0gPSB0aGlzLnN0YXRlO1xuICAgICAgICBpZiAoY29udHJvbGxlZCAmJiBlLnZhbHVlICYmIHZhbHVlICE9PSBlLnZhbHVlKSB7XG4gICAgICAgICAgICB0aGlzLnNldFN0YXRlKCgpID0+ICh7XG4gICAgICAgICAgICAgICAgdmFsdWU6IGUudmFsdWUgfHwgW10sXG4gICAgICAgICAgICAgICAgcHJldmlld3M6IFtdLFxuICAgICAgICAgICAgICAgIGVycm9yOiBlLmVycm9yLFxuICAgICAgICAgICAgfSkpO1xuICAgICAgICB9XG4gICAgfVxuICAgIHByaXZhdGUgYWRkRmlsZUVudHJpZXMgPSAoZmlsZXM6IEFycmF5PEZpbGU+KSA9PiB7XG4gICAgICAgIGNvbnN0IHsgbXVsdGlwbGUsIGZvcm0sIG5hbWUgPSAnJyB9ID0gdGhpcy5wcm9wcztcbiAgICAgICAgaWYgKCF0aGlzLnN0YXRlLmNvbnRyb2xsZWQpIHtcbiAgICAgICAgICAgIGlmIChmb3JtKSB7XG4gICAgICAgICAgICAgICAgZm9ybS5jaGFuZ2Uoe1xuICAgICAgICAgICAgICAgICAgICBuYW1lLFxuICAgICAgICAgICAgICAgICAgICB2YWx1ZTogbXVsdGlwbGUgPyBbLi4udGhpcy5zdGF0ZS52YWx1ZSwgLi4uZmlsZXNdIDogZmlsZXMsXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLnNldFN0YXRlKHByZXZTdGF0ZSA9PiAoe1xuICAgICAgICAgICAgICAgICAgICB2YWx1ZTogbXVsdGlwbGUgPyBbLi4ucHJldlN0YXRlLnZhbHVlLCAuLi5maWxlc10gOiBmaWxlcyxcbiAgICAgICAgICAgICAgICAgICAgcHJldmlld3M6IFtdLFxuICAgICAgICAgICAgICAgIH0pLCAoKSA9PiB0aGlzLm5vdGlmeUNoYW5nZXModGhpcy5zdGF0ZS52YWx1ZSkpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5ub3RpZnlDaGFuZ2VzKG11bHRpcGxlID8gWy4uLnRoaXMuc3RhdGUudmFsdWUsIC4uLmZpbGVzXSA6IGZpbGVzKTtcbiAgICAgICAgfVxuICAgIH07XG4gICAgcHJpdmF0ZSBvbkRyYWdPdmVyID0gKGU6IFJlYWN0LkRyYWdFdmVudCkgPT4ge1xuICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgfTtcbiAgICBwcml2YXRlIG9uRHJhZ0VudGVyID0gKCkgPT4ge1xuICAgICAgICB0aGlzLnNldFN0YXRlKHsgb3ZlcjogdHJ1ZSB9KTtcbiAgICB9O1xuICAgIHByaXZhdGUgb25EcmFnTGVhdmUgPSAoKSA9PiB7XG4gICAgICAgIHRoaXMuc2V0U3RhdGUoeyBvdmVyOiBmYWxzZSB9KTtcbiAgICB9O1xuICAgIHByaXZhdGUgb25PcGVuQWN0aW9uID0gKCkgPT4ge1xuICAgICAgICBjb25zdCB7IG9uT3BlbiB9ID0gdGhpcy5wcm9wcztcbiAgICAgICAgbGV0IG9wZW4gPSB0cnVlO1xuICAgICAgICBpZiAodHlwZW9mIG9uT3BlbiA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgICAgb25PcGVuKHtcbiAgICAgICAgICAgICAgICBwcmV2ZW50RGVmYXVsdCgpIHtcbiAgICAgICAgICAgICAgICAgICAgb3BlbiA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gb3BlbjtcbiAgICB9O1xuICAgIHByaXZhdGUgb25Ecm9wID0gKGV2OiBSZWFjdC5EcmFnRXZlbnQpID0+IHtcbiAgICAgICAgZXYucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7IG92ZXI6IGZhbHNlIH0pO1xuICAgICAgICBjb25zdCBhY2NlcHRGaWxlcyA9IHRoaXMub25PcGVuQWN0aW9uKCk7XG4gICAgICAgIGlmICghdGhpcy5wcm9wcy5kaXNhYmxlZCAmJiBhY2NlcHRGaWxlcykge1xuICAgICAgICAgICAgY29uc3QgZHJvcHBlZEZpbGVzID0gZ2V0RmlsZXMoW10sIGV2LmRhdGFUcmFuc2Zlci5maWxlcyk7XG4gICAgICAgICAgICBjb25zdCBmaWxlcyA9IHRoaXMucHJvcHMubXVsdGlwbGUgPyBkcm9wcGVkRmlsZXMgOiBbZHJvcHBlZEZpbGVzWzBdXTtcbiAgICAgICAgICAgIHRoaXMuYWRkRmlsZUVudHJpZXMoZmlsZXMpO1xuICAgICAgICB9XG4gICAgfTtcbiAgICBwcml2YXRlIG9uQ2xpY2sgPSAoZXY6IFJlYWN0LkNoYW5nZUV2ZW50PEhUTUxJbnB1dEVsZW1lbnQ+KSA9PiB7XG4gICAgICAgIGNvbnN0IGZpbGVzID0gZ2V0RmlsZXMoW10sIGV2LnRhcmdldC5maWxlcyk7XG4gICAgICAgIGlmIChmaWxlcykge1xuICAgICAgICAgICAgdGhpcy5hZGRGaWxlRW50cmllcyhmaWxlcyk7XG4gICAgICAgIH1cbiAgICAgICAgZXYucHJldmVudERlZmF1bHQoKTtcbiAgICB9O1xuICAgIHByaXZhdGUgc2V0SW5wdXRSZWYgPSAoZWw6IEhUTUxJbnB1dEVsZW1lbnQpID0+IHtcbiAgICAgICAgdGhpcy5maWxlSW5wdXQgPSBlbDtcbiAgICB9O1xuICAgIHByaXZhdGUgb3BlbkZpbGVQaWNrZXIgPSAoKSA9PiB7XG4gICAgICAgIGNvbnN0IG9wZW4gPSB0aGlzLm9uT3BlbkFjdGlvbigpO1xuICAgICAgICBpZiAob3BlbiAmJiB0aGlzLmZpbGVJbnB1dCkge1xuICAgICAgICAgICAgdGhpcy5maWxlSW5wdXQuY2xpY2soKTtcbiAgICAgICAgfVxuICAgIH07XG4gICAgcHJpdmF0ZSByZW1vdmVGaWxlRW50cnkoZjogRmlsZSkge1xuICAgICAgICBjb25zdCB7IGZvcm0sIG5hbWUgPSAnJyB9ID0gdGhpcy5wcm9wcztcbiAgICAgICAgaWYgKCF0aGlzLnN0YXRlLmNvbnRyb2xsZWQpIHtcbiAgICAgICAgICAgIGlmIChmb3JtKSB7XG4gICAgICAgICAgICAgICAgZm9ybS5jaGFuZ2Uoe1xuICAgICAgICAgICAgICAgICAgICBuYW1lLFxuICAgICAgICAgICAgICAgICAgICB2YWx1ZTogdGhpcy5zdGF0ZS52YWx1ZS5maWx0ZXIoZmlsZSA9PiBmICE9PSBmaWxlKSxcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUocHJldlN0YXRlID0+ICh7XG4gICAgICAgICAgICAgICAgICAgIHZhbHVlOiBwcmV2U3RhdGUudmFsdWUuZmlsdGVyKGZpbGUgPT4gZiAhPT0gZmlsZSksXG4gICAgICAgICAgICAgICAgICAgIHByZXZpZXdzOiBwcmV2U3RhdGUucHJldmlld3MuZmlsdGVyKHByZXZpZXcgPT4gcHJldmlldy5maWxlICE9PSBmKSxcbiAgICAgICAgICAgICAgICB9KSwgKCkgPT4gdGhpcy5ub3RpZnlDaGFuZ2VzKHRoaXMuc3RhdGUudmFsdWUpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIGNvbnN0IGZpbGVzID0gdGhpcy5zdGF0ZS52YWx1ZS5maWx0ZXIoZmlsZSA9PiBmICE9PSBmaWxlKTtcbiAgICAgICAgICAgIHRoaXMubm90aWZ5Q2hhbmdlcyhmaWxlcyk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcHJpdmF0ZSBub3RpZnlDaGFuZ2VzKGZpbGVzOiBBcnJheTxGaWxlPikge1xuICAgICAgICBjb25zdCB7IG9uQ2hhbmdlIH0gPSB0aGlzLnByb3BzO1xuICAgICAgICBpZiAodHlwZW9mIG9uQ2hhbmdlID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICBvbkNoYW5nZSh7XG4gICAgICAgICAgICAgICAgdmFsdWU6IGZpbGVzLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcHJpdmF0ZSByZW5kZXJJdGVtKGY6IEZpbGUpIHtcbiAgICAgICAgcmV0dXJuICg8U3R5bGVkRmlsZUl0ZW0ga2V5PXtmLm5hbWV9IG5hbWU9e2YubmFtZX0+XG4gICAgICAgIDxSZW1vdmUgb25DbGljaz17KCkgPT4gdGhpcy5yZW1vdmVGaWxlRW50cnkoZil9PlxuICAgICAgICAgIDxJY29uIG5hbWU9XCJSZW1vdmVDaXJjbGVcIiBzaXplPXsxfS8+XG4gICAgICAgIDwvUmVtb3ZlPlxuICAgICAgPC9TdHlsZWRGaWxlSXRlbT4pO1xuICAgIH1cbiAgICBwcml2YXRlIHJlbmRlclByZXZpZXcoZjogRmlsZSkge1xuICAgICAgICBjb25zdCBwcmV2aWV3ID0gdGhpcy5zdGF0ZS5wcmV2aWV3cy5maWx0ZXIocHJldmlldyA9PiBwcmV2aWV3LmZpbGUgPT09IGYpWzBdO1xuICAgICAgICBpZiAoZi5zaXplID4gMTAwMDAwMCB8fCAhZi50eXBlLm1hdGNoKC9pbWFnZS8pKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5yZW5kZXJJdGVtKGYpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChwcmV2aWV3KSB7XG4gICAgICAgICAgICByZXR1cm4gKDxTdHlsZWRGaWxlSW1hZ2VQcmV2aWV3IGtleT17Zi5uYW1lfSBzcmM9e3ByZXZpZXcuZGF0YX0+XG4gICAgICAgICAgPFJlbW92ZSBvbkNsaWNrPXsoKSA9PiB0aGlzLnJlbW92ZUZpbGVFbnRyeShmKX0+XG4gICAgICAgICAgICA8SWNvbiBuYW1lPVwiUmVtb3ZlQ2lyY2xlXCIgc2l6ZT17MX0vPlxuICAgICAgICAgIDwvUmVtb3ZlPlxuICAgICAgICA8L1N0eWxlZEZpbGVJbWFnZVByZXZpZXc+KTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCByZWFkZXIgPSBuZXcgRmlsZVJlYWRlcigpO1xuICAgICAgICByZWFkZXIub25sb2FkID0gKGZpbGUgPT4gKCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gcmVhZGVyLnJlc3VsdDtcbiAgICAgICAgICAgIHR5cGVvZiByZXN1bHQgPT09ICdzdHJpbmcnICYmXG4gICAgICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZShwcmV2U3RhdGUgPT4gKHtcbiAgICAgICAgICAgICAgICAgICAgcHJldmlld3M6IFtcbiAgICAgICAgICAgICAgICAgICAgICAgIC4uLnByZXZTdGF0ZS5wcmV2aWV3cyxcbiAgICAgICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWxlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGE6IHJlc3VsdCxcbiAgICAgICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgIF0sXG4gICAgICAgICAgICAgICAgfSkpO1xuICAgICAgICB9KShmKTtcbiAgICAgICAgcmVhZGVyLnJlYWRBc0RhdGFVUkwoZik7XG4gICAgICAgIHJldHVybiAoPFN0eWxlZEZpbGVJbWFnZVByZXZpZXcga2V5PXtmLm5hbWV9PlxuICAgICAgICA8U3Bpbm5lciBzaXplPVwic21hbGxcIi8+XG4gICAgICA8L1N0eWxlZEZpbGVJbWFnZVByZXZpZXc+KTtcbiAgICB9XG4gICAgcmVuZGVyKCkge1xuICAgICAgICBjb25zdCB7IHZhbHVlLCBvdmVyLCBlcnJvciB9ID0gdGhpcy5zdGF0ZTtcbiAgICAgICAgY29uc3QgeyBtZXNzYWdlID0gJ0Ryb3AgZmlsZXMgaGVyZSB0byB1cGxvYWQnLCBtdWx0aXBsZSwgaW5mbywgaWNvbiA9ICdGaWxlRG93bmxvYWQnLCB0aGVtZSwgdmFsdWU6IF8wLCBkZWZhdWx0VmFsdWU6IF8xLCBkaXNhYmxlZCwgb25DaGFuZ2U6IF8yLCBwcmV2aWV3OiBfMywgb25JbnB1dDogXzUsIGNoaWxkcmVuLCAuLi5wcm9wcyB9ID0gdGhpcy5wcm9wcztcbiAgICAgICAgcmV0dXJuICg8ZGl2IHsuLi5wcm9wc30+XG4gICAgICAgIDxTdHlsZWREcm9wem9uZSBhY3RpdmU9e292ZXJ9IGRpc2FibGVkPXtkaXNhYmxlZH0gb25Ecm9wPXt0aGlzLm9uRHJvcH0gb25EcmFnT3Zlcj17dGhpcy5vbkRyYWdPdmVyfSBvbkRyYWdMZWF2ZT17dGhpcy5vbkRyYWdMZWF2ZX0gb25EcmFnRW50ZXI9e3RoaXMub25EcmFnRW50ZXJ9IG9uQ2xpY2s9e3RoaXMub3BlbkZpbGVQaWNrZXJ9PlxuICAgICAgICAgIDxEcm9wem9uZUxhYmVsPlxuICAgICAgICAgICAgPEljb24gbmFtZT17aWNvbn0gc2l6ZT17Mn0vPlxuICAgICAgICAgICAgPFN0eWxlZExhYmVsPlxuICAgICAgICAgICAgICB7bWVzc2FnZX1cbiAgICAgICAgICAgICAgPEZpbGVJbnB1dCBkaXNhYmxlZD17ZGlzYWJsZWR9IHJlZj17dGhpcy5zZXRJbnB1dFJlZn0gdHlwZT1cImZpbGVcIiBtdWx0aXBsZT17bXVsdGlwbGV9IHZhbHVlPVwiXCIgb25DaGFuZ2U9e3RoaXMub25DbGlja30vPlxuICAgICAgICAgICAgICA8U3R5bGVkQWN0aW9uIGFjdGl2ZT17b3Zlcn0gZGlzYWJsZWQ9e2Rpc2FibGVkfT5cbiAgICAgICAgICAgICAgICA8SWNvbkxpbmsgaWNvbj1cIkFkZFwiPntjaGlsZHJlbn08L0ljb25MaW5rPlxuICAgICAgICAgICAgICA8L1N0eWxlZEFjdGlvbj5cbiAgICAgICAgICAgIDwvU3R5bGVkTGFiZWw+XG4gICAgICAgICAgPC9Ecm9wem9uZUxhYmVsPlxuICAgICAgICA8L1N0eWxlZERyb3B6b25lPlxuICAgICAgICB7dmFsdWUgJiYgdmFsdWUubGVuZ3RoID4gMCAmJiAoPFN0eWxlZEZpbGVMaXN0PlxuICAgICAgICAgICAge3ZhbHVlLm1hcChmaWxlID0+ICh0aGlzLnByb3BzLnByZXZpZXcgPyB0aGlzLnJlbmRlclByZXZpZXcoZmlsZSkgOiB0aGlzLnJlbmRlckl0ZW0oZmlsZSkpKX1cbiAgICAgICAgICA8L1N0eWxlZEZpbGVMaXN0Pil9XG4gICAgICAgIHtzaG93SW5wdXRJbmZvKGVycm9yLCBpbmZvKX1cbiAgICAgIDwvZGl2Pik7XG4gICAgfVxuICAgIHN0YXRpYyBpbm5lciA9IHtcbiAgICAgICAgZ2V0IFN0eWxlZEZpbGVJdGVtKCkgeyByZXR1cm4gU3R5bGVkRmlsZUl0ZW0gYXMgdHlwZW9mIFN0eWxlZEZpbGVJdGVtOyB9LFxuICAgICAgICBnZXQgUmVtb3ZlKCkgeyByZXR1cm4gUmVtb3ZlIGFzIHR5cGVvZiBSZW1vdmU7IH0sXG4gICAgICAgIGdldCBJY29uKCkgeyByZXR1cm4gSWNvbiBhcyB0eXBlb2YgSWNvbjsgfSxcbiAgICAgICAgZ2V0IFN0eWxlZEZpbGVJbWFnZVByZXZpZXcoKSB7IHJldHVybiBTdHlsZWRGaWxlSW1hZ2VQcmV2aWV3IGFzIHR5cGVvZiBTdHlsZWRGaWxlSW1hZ2VQcmV2aWV3OyB9LFxuICAgICAgICBnZXQgU3Bpbm5lcigpIHsgcmV0dXJuIFNwaW5uZXIgYXMgdHlwZW9mIFNwaW5uZXI7IH0sXG4gICAgICAgIGdldCBTdHlsZWREcm9wem9uZSgpIHsgcmV0dXJuIFN0eWxlZERyb3B6b25lIGFzIHR5cGVvZiBTdHlsZWREcm9wem9uZTsgfSxcbiAgICAgICAgZ2V0IERyb3B6b25lTGFiZWwoKSB7IHJldHVybiBEcm9wem9uZUxhYmVsIGFzIHR5cGVvZiBEcm9wem9uZUxhYmVsOyB9LFxuICAgICAgICBnZXQgU3R5bGVkTGFiZWwoKSB7IHJldHVybiBTdHlsZWRMYWJlbCBhcyB0eXBlb2YgU3R5bGVkTGFiZWw7IH0sXG4gICAgICAgIGdldCBGaWxlSW5wdXQoKSB7IHJldHVybiBGaWxlSW5wdXQgYXMgdHlwZW9mIEZpbGVJbnB1dDsgfSxcbiAgICAgICAgZ2V0IFN0eWxlZEFjdGlvbigpIHsgcmV0dXJuIFN0eWxlZEFjdGlvbiBhcyB0eXBlb2YgU3R5bGVkQWN0aW9uOyB9LFxuICAgICAgICBnZXQgSWNvbkxpbmsoKSB7IHJldHVybiBJY29uTGluayBhcyB0eXBlb2YgSWNvbkxpbms7IH0sXG4gICAgICAgIGdldCBTdHlsZWRGaWxlTGlzdCgpIHsgcmV0dXJuIFN0eWxlZEZpbGVMaXN0IGFzIHR5cGVvZiBTdHlsZWRGaWxlTGlzdDsgfVxuICAgIH07XG59XG5leHBvcnQgY29uc3QgRHJvcHpvbmUgPSB3aXRoRm9ybUNvbnRleHQoRHJvcHpvbmVJbnQpO1xuRHJvcHpvbmUuZGlzcGxheU5hbWUgPSAnRHJvcHpvbmUnO1xuIl19