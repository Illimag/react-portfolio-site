import * as React from 'react';
import styled from '../../utils/styled';
import { StyledFileImagePreview, StyledFileItem, StyledFileList } from '../../quarks';
import { withFormContext } from '../../hoc/withFormContext';
import { Button } from '../Button';
import { Icon } from '../Icon';
import { Spinner } from '../Spinner';
import { showInputInfo } from '../../utils/input';
const FileInput = styled.input `
  display: none;
`;
const Remove = styled.div `
  cursor: pointer;
  line-height: 1;
`;
function getFiles(target, files = []) {
    target.push(...files);
    return target;
}
class FileSelectInt extends React.Component {
    constructor(props) {
        super(props);
        this.addFileEntries = (ev) => {
            const { multiple, form, name = '' } = this.props;
            const files = ev.target.files;
            if (!this.state.controlled) {
                if (form) {
                    form.change({
                        name,
                        value: getFiles(multiple ? [...this.state.value] : [], files),
                    });
                }
                else {
                    this.setState(prevState => ({
                        value: getFiles(multiple ? [...prevState.value] : [], files),
                        previews: [],
                    }), () => this.notifyChanges(this.state.value));
                }
            }
            else {
                this.notifyChanges(getFiles(multiple ? [...this.state.value] : [], files));
            }
        };
        this.setInputRef = (el) => {
            this.fileInput = el;
        };
        this.openFilePicker = () => {
            const { onOpen } = this.props;
            let open = true;
            if (typeof onOpen === 'function') {
                onOpen({
                    preventDefault() {
                        open = false;
                    },
                });
            }
            if (open && this.fileInput) {
                this.fileInput.click();
            }
        };
        const value = props.value || props.defaultValue || [];
        this.state = {
            value,
            controlled: props.value !== undefined,
            previews: [],
            error: props.error,
        };
    }
    componentDidMount() {
        const { form } = this.props;
        const { controlled } = this.state;
        if (!controlled && form) {
            form.subscribe(this);
        }
    }
    componentWillUnmount() {
        const { form } = this.props;
        const { controlled } = this.state;
        if (!controlled && form) {
            form.unsubscribe(this);
        }
    }
    UNSAFE_componentWillReceiveProps({ value = [], error }) {
        if (this.state.controlled && value && this.state.value !== value) {
            this.setState({
                value,
                previews: [],
            });
        }
        this.setState({ error });
    }
    removeFileEntry(f) {
        const { form, name = '' } = this.props;
        if (!this.state.controlled) {
            if (form) {
                form.change({
                    name,
                    value: this.state.value.filter(file => f !== file),
                });
            }
            else {
                this.setState(prevState => ({
                    value: prevState.value.filter(file => f !== file),
                    previews: prevState.previews.filter(preview => preview.file !== f),
                }), () => this.notifyChanges(this.state.value));
            }
        }
        else {
            const files = this.state.value.filter(file => f !== file);
            this.notifyChanges(files);
        }
    }
    notifyChanges(files) {
        const { onChange } = this.props;
        if (typeof onChange === 'function') {
            onChange({
                value: files,
            });
        }
    }
    renderPreview(f) {
        const preview = this.state.previews.filter(preview => preview.file === f)[0];
        if (f.size > 1000000 || !f.type.match(/image/)) {
            return this.renderItem(f);
        }
        if (preview) {
            return (React.createElement(StyledFileImagePreview, { src: preview.data },
                React.createElement(Remove, { onClick: () => this.removeFileEntry(f) },
                    React.createElement(Icon, { name: "RemoveCircle", size: 1 }))));
        }
        const reader = new FileReader();
        reader.onload = (file => () => {
            const result = reader.result;
            typeof result === 'string' &&
                this.setState(prevState => ({
                    previews: [
                        ...prevState.previews,
                        {
                            file,
                            data: result,
                        },
                    ],
                }));
        })(f);
        reader.readAsDataURL(f);
        return (React.createElement(StyledFileImagePreview, null,
            React.createElement(Spinner, { size: "small" })));
    }
    renderItem(f) {
        return (React.createElement(StyledFileItem, { key: f.name, name: f.name },
            React.createElement(Remove, { onClick: () => this.removeFileEntry(f) },
                React.createElement(Icon, { name: "RemoveCircle", size: 1 }))));
    }
    render() {
        const { children, disabled, multiple, info } = this.props;
        const { value, error } = this.state;
        return (React.createElement("div", null,
            React.createElement(Button, { onClick: this.openFilePicker, disabled: disabled, buttonStyle: "secondary", type: "button" }, children),
            React.createElement(FileInput, { ref: this.setInputRef, type: "file", multiple: multiple, onChange: this.addFileEntries, value: "" }),
            value && value.length > 0 && (React.createElement(StyledFileList, null, value.map(file => (this.props.preview ? this.renderPreview(file) : this.renderItem(file))))),
            showInputInfo(error, info)));
    }
}
FileSelectInt.inner = {
    get StyledFileImagePreview() { return StyledFileImagePreview; },
    get Remove() { return Remove; },
    get Icon() { return Icon; },
    get Spinner() { return Spinner; },
    get StyledFileItem() { return StyledFileItem; },
    get Button() { return Button; },
    get FileInput() { return FileInput; },
    get StyledFileList() { return StyledFileList; }
};
/**
 * A custom field for handling file selection.
 */
export const FileSelect = withFormContext(FileSelectInt);
FileSelect.displayName = 'FileSelect';
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvY29tcG9uZW50cy9GaWxlU2VsZWN0L2luZGV4LnRzeCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEtBQUssS0FBSyxNQUFNLE9BQU8sQ0FBQztBQUMvQixPQUFPLE1BQU0sTUFBTSxvQkFBb0IsQ0FBQztBQUN4QyxPQUFPLEVBQW9CLHNCQUFzQixFQUFFLGNBQWMsRUFBRSxjQUFjLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFDeEcsT0FBTyxFQUFvQixlQUFlLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUU5RSxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQ25DLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFDL0IsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLFlBQVksQ0FBQztBQUNyQyxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUE2QmxELE1BQU0sU0FBUyxHQUFHLE1BQU0sQ0FBQyxLQUFLLENBQUM7O0NBRTlCLENBQUM7QUFDRixNQUFNLE1BQU0sR0FBRyxNQUFNLENBQUMsR0FBRyxDQUFDOzs7Q0FHekIsQ0FBQztBQUNGLFNBQVMsUUFBUSxDQUFDLE1BQW1CLEVBQUUsUUFBYSxFQUFFO0lBQ2xELE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxLQUFLLENBQUMsQ0FBQztJQUN0QixPQUFPLE1BQU0sQ0FBQztBQUNsQixDQUFDO0FBQ0QsTUFBTSxhQUFjLFNBQVEsS0FBSyxDQUFDLFNBQThEO0lBRTVGLFlBQVksS0FBc0I7UUFDOUIsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBZ0NULG1CQUFjLEdBQUcsQ0FBQyxFQUF1QyxFQUFFLEVBQUU7WUFDakUsTUFBTSxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsSUFBSSxHQUFHLEVBQUUsRUFBRSxHQUFHLElBQUksQ0FBQyxLQUFLLENB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T0FBTyxjQUF1QyxDQUFDLENBQUMsQ0FBQztJQUN4RSxJQUFJLE1BQU0sS0FBSyxPQUFPLE1BQXVCLENBQUMsQ0FBQyxDQUFDO0lBQ2hELElBQUksU0FBUyxLQUFLLE9BQU8sU0FBNkIsQ0FBQyxDQUFDLENBQUM7SUFDekQsSUFBSSxjQUFjLEtBQUssT0FBTyxjQUF1QyxDQUFDLENBQUMsQ0FBQztDQUMzRSxDQUFDO0FBRU47O0dBRUc7QUFDSCxNQUFNLENBQUMsTUFBTSxVQUFVLEdBQUcsZUFBZSxDQUFDLGFBQWEsQ0FBQyxDQUFDO0FBQ3pELFVBQVUsQ0FBQyxXQUFXLEdBQUcsWUFBWSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgUmVhY3QgZnJvbSAncmVhY3QnO1xuaW1wb3J0IHN0eWxlZCBmcm9tICcuLi8uLi91dGlscy9zdHlsZWQnO1xuaW1wb3J0IHsgRmlsZUltYWdlUHJldmlldywgU3R5bGVkRmlsZUltYWdlUHJldmlldywgU3R5bGVkRmlsZUl0ZW0sIFN0eWxlZEZpbGVMaXN0IH0gZnJvbSAnLi4vLi4vcXVhcmtzJztcbmltcG9ydCB7IEZvcm1Db250ZXh0UHJvcHMsIHdpdGhGb3JtQ29udGV4dCB9IGZyb20gJy4uLy4uL2hvYy93aXRoRm9ybUNvbnRleHQnO1xuaW1wb3J0IHsgSW5wdXRDaGFuZ2VFdmVudCwgSW5wdXRQcm9wcyB9IGZyb20gJy4uLy4uL2NvbW1vbic7XG5pbXBvcnQgeyBCdXR0b24gfSBmcm9tICcuLi9CdXR0b24nO1xuaW1wb3J0IHsgSWNvbiB9IGZyb20gJy4uL0ljb24nO1xuaW1wb3J0IHsgU3Bpbm5lciB9IGZyb20gJy4uL1NwaW5uZXInO1xuaW1wb3J0IHsgc2hvd0lucHV0SW5mbyB9IGZyb20gJy4uLy4uL3V0aWxzL2lucHV0JztcbmV4cG9ydCB0eXBlIEZpbGVTZWxlY3RDaGFuZ2VFdmVudCA9IElucHV0Q2hhbmdlRXZlbnQ8QXJyYXk8RmlsZT4+O1xuZXhwb3J0IGludGVyZmFjZSBGaWxlU2VsZWN0T3BlbkV2ZW50IHtcbiAgICBwcmV2ZW50RGVmYXVsdCgpOiB2b2lkO1xufVxuZXhwb3J0IGludGVyZmFjZSBGaWxlU2VsZWN0UHJvcHMgZXh0ZW5kcyBJbnB1dFByb3BzPEFycmF5PEZpbGU+PiB7XG4gICAgLyoqXG4gICAgICogU2hvdyBwcmV2aWV3IGluc3RlYWQgb2YgZmlsZSBsaXN0LlxuICAgICAqL1xuICAgIHByZXZpZXc/OiBib29sZWFuO1xuICAgIC8qKlxuICAgICAqIEFsbG93IHNlbGVjdGluZyBtdWx0aXBsZSBmaWxlcy5cbiAgICAgKi9cbiAgICBtdWx0aXBsZT86IGJvb2xlYW47XG4gICAgLyoqXG4gICAgICogVGhlIGNvbnRlbnQgb2YgdGhlIGZpbGVzZWxlY3QuXG4gICAgICovXG4gICAgY2hpbGRyZW4/OiBSZWFjdC5SZWFjdE5vZGU7XG4gICAgLyoqXG4gICAgICogRXZlbnQgZmlyZWQgd2hlbiB0aGUgZmlsZSBwaWNrZXIgc2hvdWxkIGJlIG9wZW5lZC5cbiAgICAgKi9cbiAgICBvbk9wZW4/KGU6IEZpbGVTZWxlY3RPcGVuRXZlbnQpOiB2b2lkO1xufVxuZXhwb3J0IGludGVyZmFjZSBGaWxlU2VsZWN0U3RhdGUge1xuICAgIHZhbHVlOiBBcnJheTxGaWxlPjtcbiAgICBlcnJvcj86IFJlYWN0LlJlYWN0Q2hpbGQ7XG4gICAgY29udHJvbGxlZDogYm9vbGVhbjtcbiAgICBwcmV2aWV3czogQXJyYXk8RmlsZUltYWdlUHJldmlldz47XG59XG5jb25zdCBGaWxlSW5wdXQgPSBzdHlsZWQuaW5wdXQgYFxuICBkaXNwbGF5OiBub25lO1xuYDtcbmNvbnN0IFJlbW92ZSA9IHN0eWxlZC5kaXYgYFxuICBjdXJzb3I6IHBvaW50ZXI7XG4gIGxpbmUtaGVpZ2h0OiAxO1xuYDtcbmZ1bmN0aW9uIGdldEZpbGVzKHRhcmdldDogQXJyYXk8RmlsZT4sIGZpbGVzOiBhbnkgPSBbXSkge1xuICAgIHRhcmdldC5wdXNoKC4uLmZpbGVzKTtcbiAgICByZXR1cm4gdGFyZ2V0O1xufVxuY2xhc3MgRmlsZVNlbGVjdEludCBleHRlbmRzIFJlYWN0LkNvbXBvbmVudDxGaWxlU2VsZWN0UHJvcHMgJiBGb3JtQ29udGV4dFByb3BzLCBGaWxlU2VsZWN0U3RhdGU+IHtcbiAgICBwcml2YXRlIGZpbGVJbnB1dDogSFRNTElucHV0RWxlbWVudCB8IG51bGw7XG4gICAgY29uc3RydWN0b3IocHJvcHM6IEZpbGVTZWxlY3RQcm9wcykge1xuICAgICAgICBzdXBlcihwcm9wcyk7XG4gICAgICAgIGNvbnN0IHZhbHVlID0gcHJvcHMudmFsdWUgfHwgcHJvcHMuZGVmYXVsdFZhbHVlIHx8IFtdO1xuICAgICAgICB0aGlzLnN0YXRlID0ge1xuICAgICAgICAgICAgdmFsdWUsXG4gICAgICAgICAgICBjb250cm9sbGVkOiBwcm9wcy52YWx1ZSAhPT0gdW5kZWZpbmVkLFxuICAgICAgICAgICAgcHJldmlld3M6IFtdLFxuICAgICAgICAgICAgZXJyb3I6IHByb3BzLmVycm9yLFxuICAgICAgICB9O1xuICAgIH1cbiAgICBjb21wb25lbnREaWRNb3VudCgpIHtcbiAgICAgICAgY29uc3QgeyBmb3JtIH0gPSB0aGlzLnByb3BzO1xuICAgICAgICBjb25zdCB7IGNvbnRyb2xsZWQgfSA9IHRoaXMuc3RhdGU7XG4gICAgICAgIGlmICghY29udHJvbGxlZCAmJiBmb3JtKSB7XG4gICAgICAgICAgICBmb3JtLnN1YnNjcmliZSh0aGlzKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBjb21wb25lbnRXaWxsVW5tb3VudCgpIHtcbiAgICAgICAgY29uc3QgeyBmb3JtIH0gPSB0aGlzLnByb3BzO1xuICAgICAgICBjb25zdCB7IGNvbnRyb2xsZWQgfSA9IHRoaXMuc3RhdGU7XG4gICAgICAgIGlmICghY29udHJvbGxlZCAmJiBmb3JtKSB7XG4gICAgICAgICAgICBmb3JtLnVuc3Vic2NyaWJlKHRoaXMpO1xuICAgICAgICB9XG4gICAgfVxuICAgIFVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzKHsgdmFsdWUgPSBbXSwgZXJyb3IgfTogRmlsZVNlbGVjdFByb3BzKSB7XG4gICAgICAgIGlmICh0aGlzLnN0YXRlLmNvbnRyb2xsZWQgJiYgdmFsdWUgJiYgdGhpcy5zdGF0ZS52YWx1ZSAhPT0gdmFsdWUpIHtcbiAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgICAgIHZhbHVlLFxuICAgICAgICAgICAgICAgIHByZXZpZXdzOiBbXSxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuc2V0U3RhdGUoeyBlcnJvciB9KTtcbiAgICB9XG4gICAgcHJpdmF0ZSBhZGRGaWxlRW50cmllcyA9IChldjogUmVhY3QuQ2hhbmdlRXZlbnQ8SFRNTElucHV0RWxlbWVudD4pID0+IHtcbiAgICAgICAgY29uc3QgeyBtdWx0aXBsZSwgZm9ybSwgbmFtZSA9ICcnIH0gPSB0aGlzLnByb3BzO1xuICAgICAgICBjb25zdCBmaWxlcyA9IGV2LnRhcmdldC5maWxlcztcbiAgICAgICAgaWYgKCF0aGlzLnN0YXRlLmNvbnRyb2xsZWQpIHtcbiAgICAgICAgICAgIGlmIChmb3JtKSB7XG4gICAgICAgICAgICAgICAgZm9ybS5jaGFuZ2Uoe1xuICAgICAgICAgICAgICAgICAgICBuYW1lLFxuICAgICAgICAgICAgICAgICAgICB2YWx1ZTogZ2V0RmlsZXMobXVsdGlwbGUgPyBbLi4udGhpcy5zdGF0ZS52YWx1ZV0gOiBbXSwgZmlsZXMpLFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZShwcmV2U3RhdGUgPT4gKHtcbiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGdldEZpbGVzKG11bHRpcGxlID8gWy4uLnByZXZTdGF0ZS52YWx1ZV0gOiBbXSwgZmlsZXMpLFxuICAgICAgICAgICAgICAgICAgICBwcmV2aWV3czogW10sXG4gICAgICAgICAgICAgICAgfSksICgpID0+IHRoaXMubm90aWZ5Q2hhbmdlcyh0aGlzLnN0YXRlLnZhbHVlKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICB0aGlzLm5vdGlmeUNoYW5nZXMoZ2V0RmlsZXMobXVsdGlwbGUgPyBbLi4udGhpcy5zdGF0ZS52YWx1ZV0gOiBbXSwgZmlsZXMpKTtcbiAgICAgICAgfVxuICAgIH07XG4gICAgcHJpdmF0ZSByZW1vdmVGaWxlRW50cnkoZjogRmlsZSkge1xuICAgICAgICBjb25zdCB7IGZvcm0sIG5hbWUgPSAnJyB9ID0gdGhpcy5wcm9wcztcbiAgICAgICAgaWYgKCF0aGlzLnN0YXRlLmNvbnRyb2xsZWQpIHtcbiAgICAgICAgICAgIGlmIChmb3JtKSB7XG4gICAgICAgICAgICAgICAgZm9ybS5jaGFuZ2Uoe1xuICAgICAgICAgICAgICAgICAgICBuYW1lLFxuICAgICAgICAgICAgICAgICAgICB2YWx1ZTogdGhpcy5zdGF0ZS52YWx1ZS5maWx0ZXIoZmlsZSA9PiBmICE9PSBmaWxlKSxcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUocHJldlN0YXRlID0+ICh7XG4gICAgICAgICAgICAgICAgICAgIHZhbHVlOiBwcmV2U3RhdGUudmFsdWUuZmlsdGVyKGZpbGUgPT4gZiAhPT0gZmlsZSksXG4gICAgICAgICAgICAgICAgICAgIHByZXZpZXdzOiBwcmV2U3RhdGUucHJldmlld3MuZmlsdGVyKHByZXZpZXcgPT4gcHJldmlldy5maWxlICE9PSBmKSxcbiAgICAgICAgICAgICAgICB9KSwgKCkgPT4gdGhpcy5ub3RpZnlDaGFuZ2VzKHRoaXMuc3RhdGUudmFsdWUpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIGNvbnN0IGZpbGVzID0gdGhpcy5zdGF0ZS52YWx1ZS5maWx0ZXIoZmlsZSA9PiBmICE9PSBmaWxlKTtcbiAgICAgICAgICAgIHRoaXMubm90aWZ5Q2hhbmdlcyhmaWxlcyk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcHJpdmF0ZSBub3RpZnlDaGFuZ2VzKGZpbGVzOiBBcnJheTxGaWxlPikge1xuICAgICAgICBjb25zdCB7IG9uQ2hhbmdlIH0gPSB0aGlzLnByb3BzO1xuICAgICAgICBpZiAodHlwZW9mIG9uQ2hhbmdlID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICBvbkNoYW5nZSh7XG4gICAgICAgICAgICAgICAgdmFsdWU6IGZpbGVzLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcHJpdmF0ZSByZW5kZXJQcmV2aWV3KGY6IEZpbGUpIHtcbiAgICAgICAgY29uc3QgcHJldmlldyA9IHRoaXMuc3RhdGUucHJldmlld3MuZmlsdGVyKHByZXZpZXcgPT4gcHJldmlldy5maWxlID09PSBmKVswXTtcbiAgICAgICAgaWYgKGYuc2l6ZSA+IDEwMDAwMDAgfHwgIWYudHlwZS5tYXRjaCgvaW1hZ2UvKSkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMucmVuZGVySXRlbShmKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAocHJldmlldykge1xuICAgICAgICAgICAgcmV0dXJuICg8U3R5bGVkRmlsZUltYWdlUHJldmlldyBzcmM9e3ByZXZpZXcuZGF0YX0+XG4gICAgICAgICAgPFJlbW92ZSBvbkNsaWNrPXsoKSA9PiB0aGlzLnJlbW92ZUZpbGVFbnRyeShmKX0+XG4gICAgICAgICAgICA8SWNvbiBuYW1lPVwiUmVtb3ZlQ2lyY2xlXCIgc2l6ZT17MX0vPlxuICAgICAgICAgIDwvUmVtb3ZlPlxuICAgICAgICA8L1N0eWxlZEZpbGVJbWFnZVByZXZpZXc+KTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCByZWFkZXIgPSBuZXcgRmlsZVJlYWRlcigpO1xuICAgICAgICByZWFkZXIub25sb2FkID0gKGZpbGUgPT4gKCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gcmVhZGVyLnJlc3VsdDtcbiAgICAgICAgICAgIHR5cGVvZiByZXN1bHQgPT09ICdzdHJpbmcnICYmXG4gICAgICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZShwcmV2U3RhdGUgPT4gKHtcbiAgICAgICAgICAgICAgICAgICAgcHJldmlld3M6IFtcbiAgICAgICAgICAgICAgICAgICAgICAgIC4uLnByZXZTdGF0ZS5wcmV2aWV3cyxcbiAgICAgICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWxlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGE6IHJlc3VsdCxcbiAgICAgICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgIF0sXG4gICAgICAgICAgICAgICAgfSkpO1xuICAgICAgICB9KShmKTtcbiAgICAgICAgcmVhZGVyLnJlYWRBc0RhdGFVUkwoZik7XG4gICAgICAgIHJldHVybiAoPFN0eWxlZEZpbGVJbWFnZVByZXZpZXc+XG4gICAgICAgIDxTcGlubmVyIHNpemU9XCJzbWFsbFwiLz5cbiAgICAgIDwvU3R5bGVkRmlsZUltYWdlUHJldmlldz4pO1xuICAgIH1cbiAgICBwcml2YXRlIHJlbmRlckl0ZW0oZjogRmlsZSkge1xuICAgICAgICByZXR1cm4gKDxTdHlsZWRGaWxlSXRlbSBrZXk9e2YubmFtZX0gbmFtZT17Zi5uYW1lfT5cbiAgICAgICAgPFJlbW92ZSBvbkNsaWNrPXsoKSA9PiB0aGlzLnJlbW92ZUZpbGVFbnRyeShmKX0+XG4gICAgICAgICAgPEljb24gbmFtZT1cIlJlbW92ZUNpcmNsZVwiIHNpemU9ezF9Lz5cbiAgICAgICAgPC9SZW1vdmU+XG4gICAgICA8L1N0eWxlZEZpbGVJdGVtPik7XG4gICAgfVxuICAgIHByaXZhdGUgc2V0SW5wdXRSZWYgPSAoZWw6IEhUTUxJbnB1dEVsZW1lbnQpID0+IHtcbiAgICAgICAgdGhpcy5maWxlSW5wdXQgPSBlbDtcbiAgICB9O1xuICAgIHByaXZhdGUgb3BlbkZpbGVQaWNrZXIgPSAoKSA9PiB7XG4gICAgICAgIGNvbnN0IHsgb25PcGVuIH0gPSB0aGlzLnByb3BzO1xuICAgICAgICBsZXQgb3BlbiA9IHRydWU7XG4gICAgICAgIGlmICh0eXBlb2Ygb25PcGVuID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICBvbk9wZW4oe1xuICAgICAgICAgICAgICAgIHByZXZlbnREZWZhdWx0KCkge1xuICAgICAgICAgICAgICAgICAgICBvcGVuID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIGlmIChvcGVuICYmIHRoaXMuZmlsZUlucHV0KSB7XG4gICAgICAgICAgICB0aGlzLmZpbGVJbnB1dC5jbGljaygpO1xuICAgICAgICB9XG4gICAgfTtcbiAgICByZW5kZXIoKSB7XG4gICAgICAgIGNvbnN0IHsgY2hpbGRyZW4sIGRpc2FibGVkLCBtdWx0aXBsZSwgaW5mbyB9ID0gdGhpcy5wcm9wcztcbiAgICAgICAgY29uc3QgeyB2YWx1ZSwgZXJyb3IgfSA9IHRoaXMuc3RhdGU7XG4gICAgICAgIHJldHVybiAoPGRpdj5cbiAgICAgICAgPEJ1dHRvbiBvbkNsaWNrPXt0aGlzLm9wZW5GaWxlUGlja2VyfSBkaXNhYmxlZD17ZGlzYWJsZWR9IGJ1dHRvblN0eWxlPVwic2Vjb25kYXJ5XCIgdHlwZT1cImJ1dHRvblwiPlxuICAgICAgICAgIHtjaGlsZHJlbn1cbiAgICAgICAgPC9CdXR0b24+XG4gICAgICAgIDxGaWxlSW5wdXQgcmVmPXt0aGlzLnNldElucHV0UmVmfSB0eXBlPVwiZmlsZVwiIG11bHRpcGxlPXttdWx0aXBsZX0gb25DaGFuZ2U9e3RoaXMuYWRkRmlsZUVudHJpZXN9IHZhbHVlPVwiXCIvPlxuICAgICAgICB7dmFsdWUgJiYgdmFsdWUubGVuZ3RoID4gMCAmJiAoPFN0eWxlZEZpbGVMaXN0PlxuICAgICAgICAgICAge3ZhbHVlLm1hcChmaWxlID0+ICh0aGlzLnByb3BzLnByZXZpZXcgPyB0aGlzLnJlbmRlclByZXZpZXcoZmlsZSkgOiB0aGlzLnJlbmRlckl0ZW0oZmlsZSkpKX1cbiAgICAgICAgICA8L1N0eWxlZEZpbGVMaXN0Pil9XG4gICAgICAgIHtzaG93SW5wdXRJbmZvKGVycm9yLCBpbmZvKX1cbiAgICAgIDwvZGl2Pik7XG4gICAgfVxuICAgIHN0YXRpYyBpbm5lciA9IHtcbiAgICAgICAgZ2V0IFN0eWxlZEZpbGVJbWFnZVByZXZpZXcoKSB7IHJldHVybiBTdHlsZWRGaWxlSW1hZ2VQcmV2aWV3IGFzIHR5cGVvZiBTdHlsZWRGaWxlSW1hZ2VQcmV2aWV3OyB9LFxuICAgICAgICBnZXQgUmVtb3ZlKCkgeyByZXR1cm4gUmVtb3ZlIGFzIHR5cGVvZiBSZW1vdmU7IH0sXG4gICAgICAgIGdldCBJY29uKCkgeyByZXR1cm4gSWNvbiBhcyB0eXBlb2YgSWNvbjsgfSxcbiAgICAgICAgZ2V0IFNwaW5uZXIoKSB7IHJldHVybiBTcGlubmVyIGFzIHR5cGVvZiBTcGlubmVyOyB9LFxuICAgICAgICBnZXQgU3R5bGVkRmlsZUl0ZW0oKSB7IHJldHVybiBTdHlsZWRGaWxlSXRlbSBhcyB0eXBlb2YgU3R5bGVkRmlsZUl0ZW07IH0sXG4gICAgICAgIGdldCBCdXR0b24oKSB7IHJldHVybiBCdXR0b24gYXMgdHlwZW9mIEJ1dHRvbjsgfSxcbiAgICAgICAgZ2V0IEZpbGVJbnB1dCgpIHsgcmV0dXJuIEZpbGVJbnB1dCBhcyB0eXBlb2YgRmlsZUlucHV0OyB9LFxuICAgICAgICBnZXQgU3R5bGVkRmlsZUxpc3QoKSB7IHJldHVybiBTdHlsZWRGaWxlTGlzdCBhcyB0eXBlb2YgU3R5bGVkRmlsZUxpc3Q7IH1cbiAgICB9O1xufVxuLyoqXG4gKiBBIGN1c3RvbSBmaWVsZCBmb3IgaGFuZGxpbmcgZmlsZSBzZWxlY3Rpb24uXG4gKi9cbmV4cG9ydCBjb25zdCBGaWxlU2VsZWN0ID0gd2l0aEZvcm1Db250ZXh0KEZpbGVTZWxlY3RJbnQpO1xuRmlsZVNlbGVjdC5kaXNwbGF5TmFtZSA9ICdGaWxlU2VsZWN0JztcbiJdfQ==