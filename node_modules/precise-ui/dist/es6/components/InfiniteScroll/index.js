import * as React from 'react';
import styled from '../../utils/styled';
import { Button } from '../Button';
import { Spinner } from '../Spinner';
import { distance } from '../../distance';
const Container = styled.div `
  height: ${({ height }) => (height ? `${height}px` : 'auto')};
  overflow: ${({ height }) => (height ? 'auto' : 'visible')};
`;
const Footer = styled.div `
  margin-top: ${distance.small};
`;
const DefaultButton = styled(Button) `
  width: 100%;
  display: flex;
  justify-content: center;
`;
export class InfiniteScroll extends React.Component {
    constructor(props) {
        super(props);
        this.handleOnScroll = () => {
            const scrolledToBottom = this.reachedBottom();
            if (scrolledToBottom && this.props.hasMore) {
                this.loadItems();
            }
        };
        this.loadItems = () => {
            const { data } = this.props;
            this.setState({ isLoading: true });
            return this.props.loadItems(data.length);
        };
        this.setContainer = (node) => {
            this.node = node;
            if (this.node) {
                this.node.removeEventListener('scroll', this.handleOnScroll);
            }
            if (node && !this.props.useWindow) {
                node.addEventListener('scroll', this.handleOnScroll);
            }
            this.node = node;
        };
        this.state = {
            isButtonMode: !!this.props.button,
            isLoading: false,
        };
    }
    componentDidMount() {
        const { isButtonMode } = this.state;
        if (!isButtonMode) {
            const { useWindow } = this.props;
            if (useWindow) {
                window.addEventListener('scroll', this.handleOnScroll);
            }
        }
    }
    componentWillUnmount() {
        const { isButtonMode } = this.state;
        if (!isButtonMode) {
            const { useWindow } = this.props;
            if (useWindow) {
                window.removeEventListener('scroll', this.handleOnScroll);
            }
            else if (this.node && !useWindow) {
                this.node.removeEventListener('scroll', this.handleOnScroll);
            }
        }
    }
    UNSAFE_componentWillReceiveProps(nextProps) {
        if (nextProps.data.length !== this.props.data.length || nextProps.hasMore !== this.props.hasMore) {
            this.setState({
                isLoading: false,
            });
        }
    }
    reachedBottom() {
        const edgeOffset = this.props.edgeOffset || 0;
        const { documentElement, body } = document;
        const { useWindow } = this.props;
        const scrollTop = useWindow
            ? (documentElement && documentElement.scrollTop) || body.scrollTop
            : (this.node && this.node.scrollTop) || 0;
        const scrollHeight = useWindow
            ? (documentElement && documentElement.scrollHeight) || body.scrollHeight
            : (this.node && this.node.scrollHeight) || 0;
        const innerHeight = useWindow ? window.innerHeight : (this.node && this.node.clientHeight) || 0;
        const scrolledToBottom = Math.ceil(scrollTop + innerHeight + edgeOffset) >= scrollHeight;
        return scrolledToBottom;
    }
    renderButton() {
        const { data, button: CustomButton, hasMore } = this.props;
        const { isLoading } = this.state;
        if (!hasMore || data.length === 0 || isLoading) {
            return undefined;
        }
        if (CustomButton && typeof CustomButton !== 'boolean' && typeof CustomButton !== 'string') {
            return React.createElement(CustomButton, { onClick: this.loadItems });
        }
        return (React.createElement(DefaultButton, { buttonStyle: "secondary", onClick: this.loadItems, theme: { buttonIconPosition: 'left' }, icon: "Add" }, typeof CustomButton === 'string' ? CustomButton : 'Show more'));
    }
    render() {
        const { host: Host = 'div', data, containerHeight, loadingIndicator } = this.props;
        const { isButtonMode, isLoading } = this.state;
        return (React.createElement(Container, { ref: this.setContainer, height: containerHeight },
            React.createElement(Host, null, data),
            React.createElement(Footer, null,
                isLoading && (loadingIndicator || React.createElement(Spinner, { size: "x-small" })),
                isButtonMode && this.renderButton())));
    }
}
InfiniteScroll.inner = {
    get DefaultButton() { return DefaultButton; },
    get Container() { return Container; },
    get Footer() { return Footer; },
    get Spinner() { return Spinner; }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvY29tcG9uZW50cy9JbmZpbml0ZVNjcm9sbC9pbmRleC50c3giXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxLQUFLLEtBQUssTUFBTSxPQUFPLENBQUM7QUFDL0IsT0FBTyxNQUFNLE1BQU0sb0JBQW9CLENBQUM7QUFDeEMsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUNuQyxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sWUFBWSxDQUFDO0FBQ3JDLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQThEMUMsTUFBTSxTQUFTLEdBQUcsTUFBTSxDQUFDLEdBQUcsQ0FBdUI7WUFDdkMsQ0FBQyxFQUFFLE1BQU0sRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsR0FBRyxNQUFNLElBQUksQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDO2NBQy9DLENBQUMsRUFBRSxNQUFNLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDO0NBQzFELENBQUM7QUFDRixNQUFNLE1BQU0sR0FBRyxNQUFNLENBQUMsR0FBRyxDQUFDO2dCQUNWLFFBQVEsQ0FBQyxLQUFLO0NBQzdCLENBQUM7QUFDRixNQUFNLGFBQWEsR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUM7Ozs7Q0FJcEMsQ0FBQztBQUNGLE1BQU0sT0FBTyxjQUFlLFNBQVEsS0FBSyxDQUFDLFNBQW1EO0lBRXpGLFlBQVksS0FBMEI7UUFDbEMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBa0NULG1CQUFjLEdBQUcsR0FBRyxFQUFFO1lBQzFCLE1BQU0sZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO1lBQzlDLElBQUksZ0JBQWdCLElB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LEtBQUssT0FBTyxNQUF1QixDQUFDLENBQUMsQ0FBQztJQUNoRCxJQUFJLE9BQU8sS0FBSyxPQUFPLE9BQXlCLENBQUMsQ0FBQyxDQUFDO0NBQ3RELENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBSZWFjdCBmcm9tICdyZWFjdCc7XG5pbXBvcnQgc3R5bGVkIGZyb20gJy4uLy4uL3V0aWxzL3N0eWxlZCc7XG5pbXBvcnQgeyBCdXR0b24gfSBmcm9tICcuLi9CdXR0b24nO1xuaW1wb3J0IHsgU3Bpbm5lciB9IGZyb20gJy4uL1NwaW5uZXInO1xuaW1wb3J0IHsgZGlzdGFuY2UgfSBmcm9tICcuLi8uLi9kaXN0YW5jZSc7XG5leHBvcnQgaW50ZXJmYWNlIEluZmluaXRlU2Nyb2xsUHJvcHMge1xuICAgIC8qKlxuICAgICAqIEBpZ25vcmVcbiAgICAgKi9cbiAgICBjaGlsZHJlbj86IHZvaWQ7XG4gICAgLyoqXG4gICAgICogTWV0aG9kIHRvIGxvYWQgbW9yZSBpdGVtcy5cbiAgICAgKi9cbiAgICBsb2FkSXRlbXMob2Zmc2V0OiBudW1iZXIpOiB2b2lkO1xuICAgIC8qKlxuICAgICAqIFNldHMgdGhlIGJ1dHRvbiBtb2RlLiBJZiB0cnVlIHRoZSBjb21wb25lbnQgd2lsbCByZW5kZXIgdGhlIGRlZmF1bHRcbiAgICAgKiAnU2hvdyBNb3JlJyBidXR0b24uIEluIGNhc2UgYSBzdHJpbmcgaXMgc3VwcGxpZWQgdGhlIGRlZmF1bHQgYnV0dG9uXG4gICAgICogd2lsbCBiZSByZW5kZXJlZCB3aXRoIHRoZSBnaXZlbiBzdHJpbmcuIE90aGVyd2lzZSwgaWYgYSBSZWFjdCBjb21wb25lbnRcbiAgICAgKiBpcyBwcm92aWRlZCBpdCB3aWxsIHJlbmRlciB0aGUgcHJvdmlkZWQgY29tcG9uZW50LlxuICAgICAqL1xuICAgIGJ1dHRvbj86IGJvb2xlYW4gfCBzdHJpbmcgfCBSZWFjdC5Db21wb25lbnRUeXBlPExvYWRlckJ1dHRvblByb3BzPjtcbiAgICAvKipcbiAgICAgKiBQaXhlbHMgbGVmdCB0byBib3R0b20gb2YgdGhlIHBhZ2UsIGF0IHdoaWNoIGxvYWRJdGVtcygpIGZ1bmN0aW9uIHdpbGxcbiAgICAgKiBiZSBjYWxsZWQuIFVzZWQgJ3Njcm9sbCcgbW9kZS5cbiAgICAgKiBAZGVmYXVsdCAwcHhcbiAgICAgKi9cbiAgICBlZGdlT2Zmc2V0PzogbnVtYmVyO1xuICAgIC8qKlxuICAgICAqIFRoZSBoZWlnaHQgb2YgdGhlIHNjcm9sbGluZyBjb250YWluZXIgaW4gcGl4ZWxzLiBUaGlzIGlzIGEgcmVxdWlyZWRcbiAgICAgKiBwcm9wIGlmIHVzZVdpbmRvdyBpcyBub3Qgc2V0IHRvIHRydWUuXG4gICAgICogQGRlZmF1bHQgMHB4XG4gICAgICovXG4gICAgY29udGFpbmVySGVpZ2h0PzogbnVtYmVyO1xuICAgIC8qKlxuICAgICAqIFRoaXMgb3B0aW9uIGFsbG93cyB0aGUgd2luZG93IHRvIGJlIHVzZWQgYXMgdGhlIHNjcm9sbCBjb250YWluZXIsIGluc3RlYWRcbiAgICAgKiBvZiBhbiBhcmJpdHJhcnkgZGl2IGNyZWF0ZWQgYnkgdGhpcyBjb21wb25lbnQsIHdoZW4gaXQgaXMgc2V0IHRvIHRydWUuXG4gICAgICogQGRlZmF1bHQgZmFsc2VcbiAgICAgKi9cbiAgICB1c2VXaW5kb3c/OiBib29sZWFuO1xuICAgIC8qKlxuICAgICAqIFRoZSBvcHRpb25hbCBob3N0IGVsZW1lbnQgdG8gYmUgdXNlZC5cbiAgICAgKi9cbiAgICBob3N0Pzogc3RyaW5nIHwgUmVhY3QuQ29tcG9uZW50Q2xhc3MgfCBSZWFjdC5TdGF0ZWxlc3NDb21wb25lbnQ7XG4gICAgLyoqXG4gICAgICogVGhpcyBwcm9wIHJlY2VpdmVzIGRhdGEgdGhhdCBpcyBkaXNwbGF5ZWQgaW4gdGhpcyBjb21wb25lbnQuXG4gICAgICovXG4gICAgZGF0YTogUmVhY3QuUmVhY3ROb2RlQXJyYXk7XG4gICAgLyoqXG4gICAgICogVGhpcyBwcm9wIGxldCdzIGNvbXBvbmVudCBrbm93IGlmIHRoZXJlIGlzIG1vcmUgZGF0YSB0byBsb2FkIGFuZCBjYWxsIGxvYWRJdGVtcyBmdW5jdGlvbiBvbiBzY3JvbGwgb3IgdG8gZGlzcGxheSB0aGUgYnV0dG9uLlxuICAgICAqL1xuICAgIGhhc01vcmU6IGJvb2xlYW47XG4gICAgLyoqXG4gICAgICogQ3VzdG9tIGxvYWRpbmcgaW5kaWNhdG9yXG4gICAgICovXG4gICAgbG9hZGluZ0luZGljYXRvcj86IFJlYWN0LlJlYWN0Tm9kZTtcbn1cbmV4cG9ydCBpbnRlcmZhY2UgSW5maW5pdGVTY3JvbGxTdGF0ZSB7XG4gICAgaXNCdXR0b25Nb2RlOiBib29sZWFuO1xuICAgIGlzTG9hZGluZzogYm9vbGVhbjtcbn1cbmludGVyZmFjZSBTdHlsZWRDb250YWluZXJQcm9wcyB7XG4gICAgaGVpZ2h0PzogbnVtYmVyO1xufVxuZXhwb3J0IGludGVyZmFjZSBMb2FkZXJCdXR0b25Qcm9wcyB7XG4gICAgb25DbGljaygpOiB2b2lkO1xufVxuY29uc3QgQ29udGFpbmVyID0gc3R5bGVkLmRpdjxTdHlsZWRDb250YWluZXJQcm9wcz4gYFxuICBoZWlnaHQ6ICR7KHsgaGVpZ2h0IH0pID0+IChoZWlnaHQgPyBgJHtoZWlnaHR9cHhgIDogJ2F1dG8nKX07XG4gIG92ZXJmbG93OiAkeyh7IGhlaWdodCB9KSA9PiAoaGVpZ2h0ID8gJ2F1dG8nIDogJ3Zpc2libGUnKX07XG5gO1xuY29uc3QgRm9vdGVyID0gc3R5bGVkLmRpdiBgXG4gIG1hcmdpbi10b3A6ICR7ZGlzdGFuY2Uuc21hbGx9O1xuYDtcbmNvbnN0IERlZmF1bHRCdXR0b24gPSBzdHlsZWQoQnV0dG9uKSBgXG4gIHdpZHRoOiAxMDAlO1xuICBkaXNwbGF5OiBmbGV4O1xuICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjtcbmA7XG5leHBvcnQgY2xhc3MgSW5maW5pdGVTY3JvbGwgZXh0ZW5kcyBSZWFjdC5Db21wb25lbnQ8SW5maW5pdGVTY3JvbGxQcm9wcywgSW5maW5pdGVTY3JvbGxTdGF0ZT4ge1xuICAgIHByaXZhdGUgbm9kZTogSFRNTERpdkVsZW1lbnQgfCBudWxsO1xuICAgIGNvbnN0cnVjdG9yKHByb3BzOiBJbmZpbml0ZVNjcm9sbFByb3BzKSB7XG4gICAgICAgIHN1cGVyKHByb3BzKTtcbiAgICAgICAgdGhpcy5zdGF0ZSA9IHtcbiAgICAgICAgICAgIGlzQnV0dG9uTW9kZTogISF0aGlzLnByb3BzLmJ1dHRvbixcbiAgICAgICAgICAgIGlzTG9hZGluZzogZmFsc2UsXG4gICAgICAgIH07XG4gICAgfVxuICAgIGNvbXBvbmVudERpZE1vdW50KCkge1xuICAgICAgICBjb25zdCB7IGlzQnV0dG9uTW9kZSB9ID0gdGhpcy5zdGF0ZTtcbiAgICAgICAgaWYgKCFpc0J1dHRvbk1vZGUpIHtcbiAgICAgICAgICAgIGNvbnN0IHsgdXNlV2luZG93IH0gPSB0aGlzLnByb3BzO1xuICAgICAgICAgICAgaWYgKHVzZVdpbmRvdykge1xuICAgICAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdzY3JvbGwnLCB0aGlzLmhhbmRsZU9uU2Nyb2xsKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICBjb21wb25lbnRXaWxsVW5tb3VudCgpIHtcbiAgICAgICAgY29uc3QgeyBpc0J1dHRvbk1vZGUgfSA9IHRoaXMuc3RhdGU7XG4gICAgICAgIGlmICghaXNCdXR0b25Nb2RlKSB7XG4gICAgICAgICAgICBjb25zdCB7IHVzZVdpbmRvdyB9ID0gdGhpcy5wcm9wcztcbiAgICAgICAgICAgIGlmICh1c2VXaW5kb3cpIHtcbiAgICAgICAgICAgICAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcignc2Nyb2xsJywgdGhpcy5oYW5kbGVPblNjcm9sbCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIGlmICh0aGlzLm5vZGUgJiYgIXVzZVdpbmRvdykge1xuICAgICAgICAgICAgICAgIHRoaXMubm9kZS5yZW1vdmVFdmVudExpc3RlbmVyKCdzY3JvbGwnLCB0aGlzLmhhbmRsZU9uU2Nyb2xsKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICBVTlNBRkVfY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyhuZXh0UHJvcHM6IEluZmluaXRlU2Nyb2xsUHJvcHMpIHtcbiAgICAgICAgaWYgKG5leHRQcm9wcy5kYXRhLmxlbmd0aCAhPT0gdGhpcy5wcm9wcy5kYXRhLmxlbmd0aCB8fCBuZXh0UHJvcHMuaGFzTW9yZSAhPT0gdGhpcy5wcm9wcy5oYXNNb3JlKSB7XG4gICAgICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICAgICAgICBpc0xvYWRpbmc6IGZhbHNlLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcHJpdmF0ZSBoYW5kbGVPblNjcm9sbCA9ICgpID0+IHtcbiAgICAgICAgY29uc3Qgc2Nyb2xsZWRUb0JvdHRvbSA9IHRoaXMucmVhY2hlZEJvdHRvbSgpO1xuICAgICAgICBpZiAoc2Nyb2xsZWRUb0JvdHRvbSAmJiB0aGlzLnByb3BzLmhhc01vcmUpIHtcbiAgICAgICAgICAgIHRoaXMubG9hZEl0ZW1zKCk7XG4gICAgICAgIH1cbiAgICB9O1xuICAgIHByaXZhdGUgcmVhY2hlZEJvdHRvbSgpIHtcbiAgICAgICAgY29uc3QgZWRnZU9mZnNldCA9IHRoaXMucHJvcHMuZWRnZU9mZnNldCB8fCAwO1xuICAgICAgICBjb25zdCB7IGRvY3VtZW50RWxlbWVudCwgYm9keSB9ID0gZG9jdW1lbnQ7XG4gICAgICAgIGNvbnN0IHsgdXNlV2luZG93IH0gPSB0aGlzLnByb3BzO1xuICAgICAgICBjb25zdCBzY3JvbGxUb3AgPSB1c2VXaW5kb3dcbiAgICAgICAgICAgID8gKGRvY3VtZW50RWxlbWVudCAmJiBkb2N1bWVudEVsZW1lbnQuc2Nyb2xsVG9wKSB8fCBib2R5LnNjcm9sbFRvcFxuICAgICAgICAgICAgOiAodGhpcy5ub2RlICYmIHRoaXMubm9kZS5zY3JvbGxUb3ApIHx8IDA7XG4gICAgICAgIGNvbnN0IHNjcm9sbEhlaWdodCA9IHVzZVdpbmRvd1xuICAgICAgICAgICAgPyAoZG9jdW1lbnRFbGVtZW50ICYmIGRvY3VtZW50RWxlbWVudC5zY3JvbGxIZWlnaHQpIHx8IGJvZHkuc2Nyb2xsSGVpZ2h0XG4gICAgICAgICAgICA6ICh0aGlzLm5vZGUgJiYgdGhpcy5ub2RlLnNjcm9sbEhlaWdodCkgfHwgMDtcbiAgICAgICAgY29uc3QgaW5uZXJIZWlnaHQgPSB1c2VXaW5kb3cgPyB3aW5kb3cuaW5uZXJIZWlnaHQgOiAodGhpcy5ub2RlICYmIHRoaXMubm9kZS5jbGllbnRIZWlnaHQpIHx8IDA7XG4gICAgICAgIGNvbnN0IHNjcm9sbGVkVG9Cb3R0b20gPSBNYXRoLmNlaWwoc2Nyb2xsVG9wICsgaW5uZXJIZWlnaHQgKyBlZGdlT2Zmc2V0KSA+PSBzY3JvbGxIZWlnaHQ7XG4gICAgICAgIHJldHVybiBzY3JvbGxlZFRvQm90dG9tO1xuICAgIH1cbiAgICBwcml2YXRlIGxvYWRJdGVtcyA9ICgpID0+IHtcbiAgICAgICAgY29uc3QgeyBkYXRhIH0gPSB0aGlzLnByb3BzO1xuICAgICAgICB0aGlzLnNldFN0YXRlKHsgaXNMb2FkaW5nOiB0cnVlIH0pO1xuICAgICAgICByZXR1cm4gdGhpcy5wcm9wcy5sb2FkSXRlbXMoZGF0YS5sZW5ndGgpO1xuICAgIH07XG4gICAgcHJpdmF0ZSByZW5kZXJCdXR0b24oKSB7XG4gICAgICAgIGNvbnN0IHsgZGF0YSwgYnV0dG9uOiBDdXN0b21CdXR0b24sIGhhc01vcmUgfSA9IHRoaXMucHJvcHM7XG4gICAgICAgIGNvbnN0IHsgaXNMb2FkaW5nIH0gPSB0aGlzLnN0YXRlO1xuICAgICAgICBpZiAoIWhhc01vcmUgfHwgZGF0YS5sZW5ndGggPT09IDAgfHwgaXNMb2FkaW5nKSB7XG4gICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgICAgICB9XG4gICAgICAgIGlmIChDdXN0b21CdXR0b24gJiYgdHlwZW9mIEN1c3RvbUJ1dHRvbiAhPT0gJ2Jvb2xlYW4nICYmIHR5cGVvZiBDdXN0b21CdXR0b24gIT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICByZXR1cm4gPEN1c3RvbUJ1dHRvbiBvbkNsaWNrPXt0aGlzLmxvYWRJdGVtc30vPjtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gKDxEZWZhdWx0QnV0dG9uIGJ1dHRvblN0eWxlPVwic2Vjb25kYXJ5XCIgb25DbGljaz17dGhpcy5sb2FkSXRlbXN9IHRoZW1lPXt7IGJ1dHRvbkljb25Qb3NpdGlvbjogJ2xlZnQnIH19IGljb249XCJBZGRcIj5cbiAgICAgICAge3R5cGVvZiBDdXN0b21CdXR0b24gPT09ICdzdHJpbmcnID8gQ3VzdG9tQnV0dG9uIDogJ1Nob3cgbW9yZSd9XG4gICAgICA8L0RlZmF1bHRCdXR0b24+KTtcbiAgICB9XG4gICAgcHJpdmF0ZSBzZXRDb250YWluZXIgPSAobm9kZTogSFRNTERpdkVsZW1lbnQgfCBudWxsKSA9PiB7XG4gICAgICAgIHRoaXMubm9kZSA9IG5vZGU7XG4gICAgICAgIGlmICh0aGlzLm5vZGUpIHtcbiAgICAgICAgICAgIHRoaXMubm9kZS5yZW1vdmVFdmVudExpc3RlbmVyKCdzY3JvbGwnLCB0aGlzLmhhbmRsZU9uU2Nyb2xsKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAobm9kZSAmJiAhdGhpcy5wcm9wcy51c2VXaW5kb3cpIHtcbiAgICAgICAgICAgIG5vZGUuYWRkRXZlbnRMaXN0ZW5lcignc2Nyb2xsJywgdGhpcy5oYW5kbGVPblNjcm9sbCk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5ub2RlID0gbm9kZTtcbiAgICB9O1xuICAgIHJlbmRlcigpIHtcbiAgICAgICAgY29uc3QgeyBob3N0OiBIb3N0ID0gJ2RpdicsIGRhdGEsIGNvbnRhaW5lckhlaWdodCwgbG9hZGluZ0luZGljYXRvciB9ID0gdGhpcy5wcm9wcztcbiAgICAgICAgY29uc3QgeyBpc0J1dHRvbk1vZGUsIGlzTG9hZGluZyB9ID0gdGhpcy5zdGF0ZTtcbiAgICAgICAgcmV0dXJuICg8Q29udGFpbmVyIHJlZj17dGhpcy5zZXRDb250YWluZXJ9IGhlaWdodD17Y29udGFpbmVySGVpZ2h0fT5cbiAgICAgICAgPEhvc3Q+e2RhdGF9PC9Ib3N0PlxuICAgICAgICA8Rm9vdGVyPlxuICAgICAgICAgIHtpc0xvYWRpbmcgJiYgKGxvYWRpbmdJbmRpY2F0b3IgfHwgPFNwaW5uZXIgc2l6ZT1cIngtc21hbGxcIi8+KX1cbiAgICAgICAgICB7aXNCdXR0b25Nb2RlICYmIHRoaXMucmVuZGVyQnV0dG9uKCl9XG4gICAgICAgIDwvRm9vdGVyPlxuICAgICAgPC9Db250YWluZXI+KTtcbiAgICB9XG4gICAgc3RhdGljIGlubmVyID0ge1xuICAgICAgICBnZXQgRGVmYXVsdEJ1dHRvbigpIHsgcmV0dXJuIERlZmF1bHRCdXR0b24gYXMgdHlwZW9mIERlZmF1bHRCdXR0b247IH0sXG4gICAgICAgIGdldCBDb250YWluZXIoKSB7IHJldHVybiBDb250YWluZXIgYXMgdHlwZW9mIENvbnRhaW5lcjsgfSxcbiAgICAgICAgZ2V0IEZvb3RlcigpIHsgcmV0dXJuIEZvb3RlciBhcyB0eXBlb2YgRm9vdGVyOyB9LFxuICAgICAgICBnZXQgU3Bpbm5lcigpIHsgcmV0dXJuIFNwaW5uZXIgYXMgdHlwZW9mIFNwaW5uZXI7IH1cbiAgICB9O1xufVxuIl19