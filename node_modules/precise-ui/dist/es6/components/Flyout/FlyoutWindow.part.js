var __rest = (this && this.__rest) || function (s, e) {
    var t = {};
    for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)
        t[p] = s[p];
    if (s != null && typeof Object.getOwnPropertySymbols === "function")
        for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) if (e.indexOf(p[i]) < 0)
            t[p[i]] = s[p[i]];
    return t;
};
import * as React from 'react';
import styled, { css, themed } from '../../utils/styled';
import { withResponsive } from '../../hoc/withResponsive';
import { distancePx, distance } from '../../distance';
import { getFontStyle } from '../../textStyles';
const toolTipArrowSize = 18;
function getFlyoutArrowPosition({ mainPosition, secondaryPosition: origSecondaryPosition, offset, targetRect, flyoutRect, }) {
    if (mainPosition && flyoutRect.width) {
        const vertical = isVertical(mainPosition);
        const mainAxisTargetSize = vertical ? targetRect.height : targetRect.width;
        const secondaryAxisTargetSize = vertical ? targetRect.width : targetRect.height;
        const secondaryAxisContnetSize = vertical ? flyoutRect.width : flyoutRect.height;
        const mainPositionValue = mainAxisTargetSize + offset + 1 - toolTipArrowSize / 2;
        let secondaryPosition;
        let secondaryPositionValue;
        if (!origSecondaryPosition) {
            secondaryPosition = vertical ? 'left' : 'top';
            secondaryPositionValue = (secondaryAxisTargetSize - toolTipArrowSize) / 2;
        }
        else {
            secondaryPosition = origSecondaryPosition;
            secondaryPositionValue =
                secondaryAxisTargetSize / 4 > secondaryAxisContnetSize - toolTipArrowSize
                    ? secondaryAxisContnetSize - toolTipArrowSize
                    : secondaryAxisTargetSize / 4;
        }
        const rotate = {
            top: 0,
            left: -90,
            right: 90,
            bottom: 180,
        };
        return {
            rotate: rotate[mainPosition],
            [invertPosition(mainPosition)]: mainPositionValue,
            [secondaryPosition]: secondaryPositionValue,
        };
    }
    return {};
}
function getDetailedPositionInfo({ targetRect, dimensions, flyoutRect, }) {
    const viewportPosition = {
        left: targetRect.left,
        right: dimensions.width - targetRect.right,
        top: targetRect.top,
        bottom: dimensions.height - targetRect.bottom,
    };
    const hasEnoughSpace = {};
    const hasMoreSpace = {};
    for (const position of Object.keys(viewportPosition)) {
        if (isVertical(position)) {
            // There is always enought space for top/bottom flyout when it lays outside of the viewport.
            hasEnoughSpace[position] = targetRect.top > dimensions.height || viewportPosition[position] > flyoutRect.height;
        }
        else {
            hasEnoughSpace[position] = viewportPosition[position] > flyoutRect.width;
        }
        hasMoreSpace[position] = viewportPosition[position] > viewportPosition[invertPosition(position)];
    }
    return {
        viewportPosition,
        hasEnoughSpace,
        hasMoreSpace,
    };
}
function getMainAxisFlyoutPositionAndSize({ direction, targetRect, offset, dimensions, vertical, flyoutRect, }) {
    const targetSize = vertical ? targetRect.height : targetRect.width;
    const flyoutSize = vertical ? flyoutRect.height : flyoutRect.width;
    const { hasEnoughSpace, viewportPosition } = getDetailedPositionInfo({
        targetRect,
        dimensions,
        flyoutRect,
    });
    const sizeValue = hasEnoughSpace[direction]
        ? flyoutSize
        : viewportPosition[direction] - (offset + toolTipArrowSize / 2) - distancePx.medium;
    return {
        position: {
            name: invertPosition(direction),
            value: targetSize + (offset + toolTipArrowSize / 2),
        },
        size: {
            name: vertical ? 'height' : 'width',
            value: sizeValue,
        },
    };
}
function getSecondaryAxisFlyoutPositionAndSize({ direction, targetRect, dimensions, vertical, flyoutRect, }) {
    let positionValue;
    let positionName;
    const sizeName = vertical ? 'width' : 'height';
    const targetSize = vertical ? targetRect.width : targetRect.height;
    const targetPosition = vertical ? targetRect.left : targetRect.top;
    const flyoutSize = vertical ? flyoutRect.width : flyoutRect.height;
    const windowSize = vertical ? dimensions.width : dimensions.height;
    const { viewportPosition } = getDetailedPositionInfo({
        targetRect,
        dimensions,
        flyoutRect,
    });
    let sizeValue = flyoutSize;
    if (direction === undefined) {
        positionName = vertical ? 'left' : 'top';
        const centeredValue = (targetSize - flyoutSize) / 2;
        if (viewportPosition[positionName] > 0 && viewportPosition[positionName] + centeredValue < 0) {
            positionValue = -viewportPosition[positionName] + distancePx.medium;
            sizeValue = flyoutSize > windowSize ? windowSize - distancePx.xlarge : flyoutSize;
        }
        else {
            positionValue = centeredValue;
        }
    }
    else {
        positionName = direction;
        positionValue =
            positionName === 'top' || positionName === 'left'
                ? 0
                : targetPosition - flyoutSize > 0
                    ? targetSize - flyoutSize
                    : -targetPosition + distancePx.medium;
        if (positionName === 'top' || positionName === 'left') {
            sizeValue =
                targetPosition + positionValue + flyoutSize > windowSize
                    ? windowSize - targetPosition + positionValue - distancePx.medium
                    : flyoutSize;
        }
        else {
            sizeValue =
                flyoutSize > targetPosition + targetSize ? targetPosition + targetSize - distancePx.medium : flyoutSize;
            positionName = invertPosition(positionName);
        }
    }
    return {
        position: {
            name: positionName,
            value: positionValue,
        },
        size: {
            name: sizeName,
            value: sizeValue,
        },
    };
}
function invertPosition(position) {
    const invertedPosition = {
        top: 'bottom',
        left: 'right',
        right: 'left',
        bottom: 'top',
    };
    return invertedPosition[position];
}
function isVertical(position) {
    return position === 'top' || position === 'bottom' ? true : false;
}
const StyledFlyoutWindow = styled('div')(themed(({ theme, size, position, noGutter }) => css `
      ${getFontStyle({ size: 'medium' })}

      position: absolute;
      z-index: 100;
      box-sizing: border-box;
      box-shadow: 0 2px 6px 0 rgba(75, 78, 82, 0.2);
      border: 1px solid ${theme.ui4};
      background: ${theme.flyout.background};
      color: ${theme.flyout.textColor};
      max-width: ${theme.flyout.maxWidth};
      max-height: ${theme.flyout.maxHeight};
      ${!noGutter ? `padding: ${distance.small} ${distance.medium};` : ''} box-sizing: border-box;

      ${size && size.width !== undefined ? `width: ${size.width}px` : ''};
      ${size && size.height !== undefined ? `height: ${size.height}px` : ''};
      ${position && position.top !== undefined ? `top: ${position.top}px` : ''};
      ${position && position.left !== undefined ? `left: ${position.left}px` : ''};
      ${position && position.bottom !== undefined ? `bottom: ${position.bottom}px` : ''};
      ${position && position.right !== undefined ? `right: ${position.right}px` : ''};
      overflow: auto;
    `));
const StyledFlyoutArrow = styled('div')(themed(({ top, left, bottom, right, rotate, theme }) => css `
      pointer-events: none;
      position: absolute;
      z-index: 101;
      width: ${toolTipArrowSize}px;
      height: ${toolTipArrowSize}px;

      ${top !== undefined ? `top: ${top}px` : ''};
      ${left !== undefined ? `left: ${left}px` : ''};
      ${bottom !== undefined ? `bottom: ${bottom}px` : ''};
      ${right !== undefined ? `right: ${right}px` : ''};
      ${rotate !== undefined ? `transform: rotate(${rotate}deg)` : ''};

      :before {
        content: ' ';
        position: absolute;
        top: 0;
        left: 0;
        border-style: solid;
        border-width: ${toolTipArrowSize / 2}px;
        border-color: ${theme.ui4} transparent transparent transparent;
      }

      :after {
        content: ' ';
        position: absolute;
        top: 0;
        left: 0;
        border-style: solid;
        border-width: ${toolTipArrowSize / 2 - 1}px;
        margin-left: 1px;
        border-color: ${theme.flyout.background} transparent transparent transparent;
      }
    `));
export class FlyoutWindowInt extends React.Component {
    constructor(props) {
        super(props);
        this.scrollPosition = { top: 0, left: 0 };
        this.setFlyoutRef = (el) => {
            if (this.flyoutContainer) {
                this.flyoutContainer.removeEventListener('scroll', this.onScroll);
            }
            if (el) {
                el.addEventListener('scroll', this.onScroll);
            }
            this.flyoutContainer = el;
        };
        this.onScroll = (e) => {
            if (e.target && e.target instanceof HTMLElement) {
                this.scrollPosition = {
                    top: e.target.scrollTop,
                    left: e.target.scrollLeft,
                };
            }
        };
        this.state = {
            flyoutRect: undefined,
            children: undefined,
        };
    }
    static getDerivedStateFromProps(nextProps, prevState) {
        if (nextProps.children !== prevState.children) {
            return {
                flyoutRect: undefined,
                children: nextProps.children,
            };
        }
        return {
            children: nextProps.children,
        };
    }
    componentDidMount() {
        if (this.flyoutContainer) {
            this.updateMeasurements();
        }
    }
    componentWillUnmount() {
        if (this.flyoutContainer) {
            this.flyoutContainer.removeEventListener('scroll', this.onScroll);
        }
    }
    componentDidUpdate() {
        if (this.flyoutContainer) {
            if (!this.state.flyoutRect) {
                this.updateMeasurements();
            }
            if (this.flyoutContainer.scroll) {
                this.flyoutContainer.scroll({
                    top: this.scrollPosition.top,
                    left: this.scrollPosition.left,
                });
            }
        }
    }
    updateMeasurements() {
        if (this.flyoutContainer) {
            const flyoutRect = this.flyoutContainer.getBoundingClientRect();
            this.setState({
                flyoutRect,
            });
        }
    }
    getFlyoutDimensions() {
        const { flyoutRect } = this.state;
        if (!flyoutRect) {
            return {};
        }
        const { position, defaultPosition = 'bottom', offset = 4, dimensions, targetRect } = this.props;
        const [mainPosition, secondaryPosition] = (position || defaultPosition).split('-');
        if (!dimensions || !mainPosition) {
            return {};
        }
        const vertical = isVertical(mainPosition);
        const { hasMoreSpace, hasEnoughSpace } = getDetailedPositionInfo({
            targetRect,
            dimensions,
            flyoutRect,
        });
        let mainDirection = mainPosition;
        let main = getMainAxisFlyoutPositionAndSize({
            direction: mainDirection,
            targetRect,
            offset,
            dimensions,
            vertical,
            flyoutRect,
        });
        if (!position && !hasEnoughSpace[mainDirection] && !hasMoreSpace[mainDirection]) {
            mainDirection = invertPosition(mainDirection);
            main = getMainAxisFlyoutPositionAndSize({
                direction: mainDirection,
                targetRect,
                offset,
                dimensions,
                vertical,
                flyoutRect,
            });
        }
        let secondaryDirection = secondaryPosition;
        let secondary = getSecondaryAxisFlyoutPositionAndSize({
            direction: secondaryDirection,
            targetRect,
            dimensions,
            vertical,
            flyoutRect,
        });
        if (!position && secondaryDirection && !hasEnoughSpace[secondaryDirection] && hasMoreSpace[secondaryDirection]) {
            secondaryDirection = invertPosition(secondaryDirection);
            secondary = getSecondaryAxisFlyoutPositionAndSize({
                direction: secondaryDirection,
                targetRect,
                dimensions,
                vertical,
                flyoutRect,
            });
        }
        return {
            position: {
                [main.position.name]: main.position.value,
                [secondary.position.name]: secondary.position.value,
            },
            size: {
                [main.size.name]: main.size.value,
                [secondary.size.name]: secondary.size.value,
            },
            arrowPosition: getFlyoutArrowPosition({
                mainPosition: mainDirection,
                secondaryPosition: secondaryDirection,
                offset,
                targetRect,
                flyoutRect,
            }),
        };
    }
    render() {
        const _a = this.props, { children, targetRect: _0, position: _1, offset: _2, dimensions: _3, innerRef: _4 } = _a, props = __rest(_a, ["children", "targetRect", "position", "offset", "dimensions", "innerRef"]);
        const _b = this.getFlyoutDimensions(), { arrowPosition } = _b, flyoutDimensions = __rest(_b, ["arrowPosition"]);
        return (children && (React.createElement(React.Fragment, null,
            React.createElement(StyledFlyoutArrow, Object.assign({}, arrowPosition, { theme: props.theme })),
            React.createElement(StyledFlyoutWindow, Object.assign({}, flyoutDimensions, props, { ref: this.setFlyoutRef }), children))));
    }
}
FlyoutWindowInt.inner = {
    get StyledFlyoutArrow() { return StyledFlyoutArrow; },
    get StyledFlyoutWindow() { return StyledFlyoutWindow; }
};
export const FlyoutWindow = withResponsive(FlyoutWindowInt);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRmx5b3V0V2luZG93LnBhcnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvY29tcG9uZW50cy9GbHlvdXQvRmx5b3V0V2luZG93LnBhcnQudHN4Il0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQUFBLE9BQU8sS0FBSyxLQUFLLE1BQU0sT0FBTyxDQUFDO0FBQy9CLE9BQU8sTUFBTSxFQUFFLEVBQUUsR0FBRyxFQUFFLE1BQU0sRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQ3pELE9BQU8sRUFBRSxjQUFjLEVBQTRCLE1BQU0sMEJBQTBCLENBQUM7QUFFcEYsT0FBTyxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUV0RCxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDaEQsTUFBTSxnQkFBZ0IsR0FBRyxFQUFFLENBQUM7QUF3QjVCLFNBQVMsc0JBQXNCLENBQUMsRUFBRSxZQUFZLEVBQUUsaUJBQWlCLEVBQUUscUJBQXFCLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxVQUFVLEdBTXZIO0lBQ0csSUFBSSxZQUFZLElBQUksVUFBVSxDQUFDLEtBQUssRUFBRTtRQUNsQyxNQUFNLFFBQVEsR0FBRyxVQUFVLENBQUMsWUFBWSxDQUFDLENBQUM7UUFDMUMsTUFBTSxrQkFBa0IsR0FBRyxRQUFRLENBQUMsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUM7UUFDM0UsTUFBTSx1QkFBdUIsR0FBRyxRQUFRLENBQUMsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUM7UUFDaEYsTUFBTSx3QkFBd0IsR0FBRyxRQUFRLENBQUMsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUM7UUFDakYsTUFBTSxpQkFBaUIsR0FBRyxrQkFBa0IsR0FBRyxNQUFNLEdBQUcsQ0FBQyxHQUFHLGdCQUFnQixHQUFHLENBQUMsQ0FBQztRQUNqRixJQUFJLGlCQUF5QixDQUFDO1FBQzlCLElBQUksc0JBQThCLENBQUM7UUFDbkMsSUFBSSxDQUFDLHFCQUFxQixFQUFFO1lBQ3hCLGlCQUFpQixHQUFHLFFBQVEsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUM7WUFDOUMsc0JBQXNCLEdBQUcsQ0FBQyx1QkFBdUIsR0FBRyxnQkFBZ0IsQ0FBQyxHQUFHLENBQUMsQ0FBQztTQUM3RTthQUNJO1lBQ0QsaUJBQWlCLEdBQUcscUJBQXFCLENBQUM7WUFDMUMsc0JBQXNCO2dCQUNsQix1QkFBdUIsR0FBRyxDQUFDLEdBQUcsd0JBQXdCLEdBQUcsZ0JBQWdCO29CQUNyRSxDQUFDLENBQUMsd0JBQXdCLEdBQUcsZ0JBQWdCO29CQUM3QyxDQUFDLENBQUMsdUJBQXVCLEdBQUcsQ0FBQyxDQUFDO1NBQ3pDO1FBQ0QsTUFBTSxNQUFNLEdBQUc7WUFDWCxHQUFHLEVBQUUsQ0FBQztZQUNOLElBQUksRUFBRSxDQUFDLEVBQUU7WUFDVCxLQUFLLEVBQUUsRUFBRTtZQUNULE1BQU0sRUFBRSxHQUFHO1NBQ2QsQ0FBQztRQUNGLE9BQU87WUFDSCxNQUFNLEVBQUUsTUFBTSxDQUFDLFlBQVksQ0FBQztZQUM1QixDQUFDLGNBQWMsQ0FBQyxZQUFZLENBQUMsQ0FBQyxFQUFFLGlCQUFpQjtZQUNqRCxDQUFDLGlCQUFpQixDQUFDLEVBQUUsc0JBQXNCO1NBQzlDLENBQUM7S0FDTDtJQUNELE9BQU8sRUFBRSxDQUFDO0FBQ2QsQ0FBQztBQUNELFNBQVMsdUJBQXVCLENBQUMsRUFBRSxVQUFVLEVBQUUsVUFBVSxFQUFFLFVBQVUsR0FJcEU7SUFDRyxNQUFNLGdCQUFnQixHQUFHO1FBQ3JCLElBQUksRUFBRSxVQUFVLENBQUMsSUFBSTtRQUNyQixLQUFLLEVBQUUsVUFBVSxDQUFDLEtBQUssR0FBRyxVQUFVLENBQUMsS0FBSztRQUMxQyxHQUFHLEVBQUUsVUFBVSxDQUFDLEdBQUc7UUFDbkIsTUFBTSxFQUFFLFVBQVUsQ0FBQyxNQUFNLEdBQUcsVUFBVSxDQUFDLE1BQU07S0FDaEQsQ0FBQztJQUNGLE1BQU0sY0FBYyxHQUFHLEVBQUUsQ0FBQztJQUMxQixNQUFNLFlBQVksR0FBRyxFQUFFLENBQUM7SUFDeEIsS0FBSyxNQUFNLFFBQVEsSUFBSSxNQUFNLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLEVBQUU7UUFDbEQsSUFBSSxVQUFVLENBQUMsUUFBeUIsQ0FBQyxFQUFFO1lBQ3ZDLDRGQUE0RjtZQUM1RixjQUFjLENBQUMsUUFBUSxDQUFDLEdBQUcsVUFBVSxDQUFDLEdBQUcsR0FBRyxVQUFVLENBQUMsTUFBTSxJQUFJLGdCQUFnQixDQUFDLFFBQVEsQ0FBQyxHQUFHLFVBQVUsQ0FBQyxNQUFNLENBQUM7U0FDbkg7YUFDSTtZQUNELGNBQWMsQ0FBQyxRQUFRLENBQUMsR0FBRyxnQkFBZ0IsQ0FBQyxRQUFRLENBQUMsR0FBRyxVQUFVLENBQUMsS0FBSyxDQUFDO1NBQzVFO1FBQ0QsWUFBWSxDQUFDLFFBQVEsQ0FBQyxHQUFHLGdCQUFnQixDQUFDLFFBQVEsQ0FBQyxHQUFHLGdCQUFnQixDQUFDLGNBQWMsQ0FBQyxRQUF5QixDQUFDLENBQUMsQ0FBQztLQUNySDtJQUNELE9BQU87UUFDSCxnQkFBZ0I7UUFDaEIsY0FBYztRQUNkLFlBQVk7S0FDZixDQUFDO0FBQ04sQ0FBQztBQUNELFNBQVMsZ0NBQWdDLENBQUMsRUFBRSxTQUFTLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLFVBQVUsR0FPMUc7SUFDRyxNQUFNLFVBQVUsR0FBRyxRQUFRLENBQUMsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUM7SUFDbkUsTUFBTSxVQUFVLEdBQUcsUUFBUSxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDO0lBQ25FLE1BQU0sRUFBRSxjQUFjLEVBQUUsZ0JBQWdCLEVBQUUsR0FBRyx1QkFBdUIsQ0FBQztRQUNqRSxVQUFVO1FBQ1YsVUFBVTtRQUNWLFVBQVU7S0FDYixDQUFDLENBQUM7SUFDSCxNQUFNLFNBQVMsR0FBRyxjQUFjLENBQUMsU0FBUyxDQUFDO1FBQ3ZDLENBQUMsQ0FBQyxVQUFVO1FBQ1osQ0FBQyxDQUFDLGdCQUFnQixDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsTUFBTSxHQUFHLGdCQUFnQixHQUFHLENBQUMsQ0FBQyxHQUFHLFVBQVUsQ0FBQyxNQUFNLENBQUM7SUFDeEYsT0FBTztRQUNILFFBQVEsRUFBRTtZQUNOLElBQUksRUFBRSxjQUFjLENBQUMsU0FBUyxDQUFDO1lBQy9CLEtBQUssRUFBRSxVQUFVLEdBQUcsQ0FBQyxNQUFNLEdBQUcsZ0JBQWdCLEdBQUcsQ0FBQyxDQUFDO1NBQ3REO1FBQ0QsSUFBSSxFQUFFO1lBQ0YsSUFBSSxFQUFFLFFBQVEsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxPQUFPO1lBQ25DLEtBQUssRUFBRSxTQUFTO1NBQ25CO0tBQ0osQ0FBQztBQUNOLENBQUM7QUFDRCxTQUFTLHFDQUFxQyxDQUFDLEVBQUUsU0FBUyxFQUFFLFVBQVUsRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLFVBQVUsR0FNdkc7SUFDRyxJQUFJLGFBQXFCLENBQUM7SUFDMUIsSUFBSSxZQUEyQixDQUFDO0lBQ2hDLE1BQU0sUUFBUSxHQUFHLFFBQVEsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUM7SUFDL0MsTUFBTSxVQUFVLEdBQUcsUUFBUSxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDO0lBQ25FLE1BQU0sY0FBYyxHQUFHLFFBQVEsQ0FBQyxDQUFDLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQztJQUNuRSxNQUFNLFVBQVUsR0FBRyxRQUFRLENBQUMsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUM7SUFDbkUsTUFBTSxVQUFVLEdBQUcsUUFBUSxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDO0lBQ25FLE1BQU0sRUFBRSxnQkFBZ0IsRUFBRSxHQUFHLHVCQUF1QixDQUFDO1FBQ2pELFVBQVU7UUFDVixVQUFVO1FBQ1YsVUFBVTtLQUNiLENBQUMsQ0FBQztJQUNILElBQUksU0FBUyxHQUFHLFVBQVUsQ0FBQztJQUMzQixJQUFJLFNBQVMsS0FBSyxTQUFTLEVBQUU7UUFDekIsWUFBWSxHQUFHLFFBQVEsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUM7UUFDekMsTUFBTSxhQUFhLEdBQUcsQ0FBQyxVQUFVLEdBQUcsVUFBVSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ3BELElBQUksZ0JBQWdCLENBQUMsWUFBWSxDQUFDLEdBQUcsQ0FBQyxJQUFJLGdCQUFnQixDQUFDLFlBQVksQ0FBQyxHQUFHLGFBQWEsR0FBRyxDQUFDLEVBQUU7WUFDMUYsYUFBYSxHQUFHLENBQUMsZ0JBQWdCLENBQUMsWUFBWSxDQUFDLEdBQUcsVUFBVSxDQUFDLE1BQU0sQ0FBQztZQUNwRSxTQUFTLEdBQUcsVUFBVSxHQUFHLFVBQVUsQ0FBQyxDQUFDLENBQUMsVUFBVSxHQUFHLFVBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLFVBQVUsQ0FBQztTQUNyRjthQUNJO1lBQ0QsYUFBYSxHQUFHLGFBQWEsQ0FBQztTQUNqQztLQUNKO1NBQ0k7UUFDRCxZQUFZLEdBQUcsU0FBUyxDQUFDO1FBQ3pCLGFBQWE7WUFDVCxZQUFZLEtBQUssS0FBSyxJQUFJLFlBQVksS0FBSyxNQUFNO2dCQUM3QyxDQUFDLENBQUMsQ0FBQztnQkFDSCxDQUFDLENBQUMsY0FBYyxHQUFHLFVBQVUsR0FBRyxDQUFDO29CQUM3QixDQUFDLENBQUMsVUFBVSxHQUFHLFVBQVU7b0JBQ3pCLENBQUMsQ0FBQyxDQUFDLGNBQWMsR0FBRyxVQUFVLENBQUMsTUFBTSxDQUFDO1FBQ2xELElBQUksWUFBWSxLQUFLLEtBQUssSUFBSSxZQUFZLEtBQUssTUFBTSxFQUFFO1lBQ25ELFNBQVM7Z0JBQ0wsY0FBYyxHQUFHLGFBQWEsR0FBRyxVQUFVLEdBQUcsVUFBVTtvQkFDcEQsQ0FBQyxDQUFDLFVBQVUsR0FBRyxjQUFjLEdBQUcsYUFBYSxHQUFHLFVBQVUsQ0FBQyxNQUFNO29CQUNqRSxDQUFDLENBQUMsVUFBVSxDQUFDO1NBQ3hCO2FBQ0k7WUFDRCxTQUFTO2dCQUNMLFVBQVUsR0FBRyxjQUFjLEdBQUcsVUFBVSxDQUFDLENBQUMsQ0FBQyxjQUFjLEdBQUcsVUFBVSxHQUFHLFVBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLFVBQVUsQ0FBQztZQUM1RyxZQUFZLEdBQUcsY0FBYyxDQUFDLFlBQVksQ0FBQyxDQUFDO1NBQy9DO0tBQ0o7SUFDRCxPQUFPO1FBQ0gsUUFBUSxFQUFFO1lBQ04sSUFBSSxFQUFFLFlBQVk7WUFDbEIsS0FBSyxFQUFFLGFBQWE7U0FDdkI7UUFDRCxJQUFJLEVBQUU7WUFDRixJQUFJLEVBQUUsUUFBUTtZQUNkLEtBQUssRUFBRSxTQUFTO1NBQ25CO0tBQ0osQ0FBQztBQUNOLENBQUM7QUFDRCxTQUFTLGNBQWMsQ0FBQyxRQUF1QjtJQUMzQyxNQUFNLGdCQUFnQixHQUFxQjtRQUN2QyxHQUFHLEVBQUUsUUFBUTtRQUNiLElBQUksRUFBRSxPQUFPO1FBQ2IsS0FBSyxFQUFFLE1BQU07UUFDYixNQUFNLEVBQUUsS0FBSztLQUNoQixDQUFDO0lBQ0YsT0FBTyxnQkFBZ0IsQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUN0QyxDQUFDO0FBQ0QsU0FBUyxVQUFVLENBQUMsUUFBdUI7SUFDdkMsT0FBTyxRQUFRLEtBQUssS0FBSyxJQUFJLFFBQVEsS0FBSyxRQUFRLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDO0FBQ3RFLENBQUM7QUFTRCxNQUFNLGtCQUFrQixHQUFHLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBMEIsTUFBTSxDQUFDLENBQUMsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLFFBQVEsRUFBRSxRQUFRLEVBQUUsRUFBRSxFQUFFLENBQUMsR0FBRyxDQUFDO1FBQzlHLFlBQVksQ0FBQyxFQUFFLElBQUksRUFBRSxRQUFRLEVBQUUsQ0FBQzs7Ozs7OzBCQU1kLEtBQUssQ0FBQyxHQUFHO29CQUNmLEtBQUssQ0FBQyxNQUFNLENBQUMsVUFBVTtlQUM1QixLQUFLLENBQUMsTUFBTSxDQUFDLFNBQVM7bUJBQ2xCLEtBQUssQ0FBQyxNQUFNLENBQUMsUUFBUTtvQkFDcEIsS0FBSyxDQUFDLE1BQU0sQ0FBQyxTQUFTO1FBQ2xDLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxZQUFZLFFBQVEsQ0FBQyxLQUFLLElBQUksUUFBUSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFOztRQUVqRSxJQUFJLElBQUksSUFBSSxDQUFDLEtBQUssS0FBSyxTQUFTLENBQUMsQ0FBQyxDQUFDLFVBQVUsSUFBSSxDQUFDLEtBQUssSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFO1FBQ2hFLElBQUksSUFBSSxJQUFJLENBQUMsTUFBTSxLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUMsV0FBVyxJQUFJLENBQUMsTUFBTSxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUU7UUFDbkUsUUFBUSxJQUFJLFFBQVEsQ0FBQyxHQUFHLEtBQUssU0FBUyxDQUFDLENBQUMsQ0FBQyxRQUFRLFFBQVEsQ0FBQyxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRTtRQUN0RSxRQUFRLElBQUksUUFBUSxDQUFDLElBQUksS0FBSyxTQUFTLENBQUMsQ0FBQyxDQUFDLFNBQVMsUUFBUSxDQUFDLElBQUksSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFO1FBQ3pFLFFBQVEsSUFBSSxRQUFRLENBQUMsTUFBTSxLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUMsV0FBVyxRQUFRLENBQUMsTUFBTSxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUU7UUFDL0UsUUFBUSxJQUFJLFFBQVEsQ0FBQyxLQUFLLEtBQUssU0FBUyxDQUFDLENBQUMsQ0FBQyxVQUFVLFFBQVEsQ0FBQyxLQUFLLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRTs7S0FFL0UsQ0FBQyxDQUFDLENBQUM7QUFJUixNQUFNLGlCQUFpQixHQUFHLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBeUIsTUFBTSxDQUFDLENBQUMsRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxFQUFFLEVBQUUsQ0FBQyxHQUFHLENBQUM7Ozs7ZUFJN0csZ0JBQWdCO2dCQUNmLGdCQUFnQjs7UUFFeEIsR0FBRyxLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRTtRQUN4QyxJQUFJLEtBQUssU0FBUyxDQUFDLENBQUMsQ0FBQyxTQUFTLElBQUksSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFO1FBQzNDLE1BQU0sS0FBSyxTQUFTLENBQUMsQ0FBQyxDQUFDLFdBQVcsTUFBTSxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUU7UUFDakQsS0FBSyxLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUMsVUFBVSxLQUFLLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRTtRQUM5QyxNQUFNLEtBQUssU0FBUyxDQUFDLENBQUMsQ0FBQyxxQkFBcUIsTUFBTSxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUU7Ozs7Ozs7O3dCQVE3QyxnQkFBZ0IsR0FBRyxDQUFDO3dCQUNwQixLQUFLLENBQUMsR0FBRzs7Ozs7Ozs7O3dCQVNULGdCQUFnQixHQUFHLENBQUMsR0FBRyxDQUFDOzt3QkFFeEIsS0FBSyxDQUFDLE1BQU0sQ0FBQyxVQUFVOztLQUUxQyxDQUFDLENBQUMsQ0FBQztBQVNSLE1BQU0sT0FBTyxlQUFnQixTQUFRLEtBQUssQ0FBQyxTQUErQztJQUd0RixZQUFZLEtBQXdCO1FBQ2hDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUZULG1CQUFjLEdBQW1CLEVBQUUsR0FBRyxFQUFFLENBQUMsRUFBRSxJQUFJLEVBQUUsQ0FBQyxFQUFFLENBQUM7UUFtQnJELGlCQUFZLEdBQUcsQ0FBQyxFQUFrQixFQUFFLEVBQUU7WUFDMUMsSUFBSSxJQUFJLENBQUMsZUFBZSxFQUFFO2dCQUN0QixJQUFJLENBQUMsZUFBZSxDQUFDLG1CQUFtQixDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7YUFDckU7WUFDRCxJQUFJLEVBQUUsRUFBRTtnQkFDSixFQUFFLENBQUMsZ0JBQWdCLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQzthQUNoRDtZQUNELElBQUksQ0FBQyxlQUFlLEdBQUcsRUFBRSxDQUFDO1FBQzlCLENBQUMsQ0FBQztRQUNNLGFBQVEsR0FBRyxDQUFDLENBQVUsRUFBRSxFQUFFO1lBQzlCLElBQUksQ0FBQyxDQUFDLE1BQU0sSUFBSSxDQUFDLENBQUMsTUFBTSxZQUFZLFdBQVcsRUFBRTtnQkFDN0MsSUFBSSxDQUFDLGNBQWMsR0FBRztvQkFDbEIsR0FBRyxFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUMsU0FBUztvQkFDdkIsSUFBSSxFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUMsVUFBVTtpQkFDNUIsQ0FBQzthQUNMO1FBQ0wsQ0FBQyxDQUFDO1FBaENFLElBQUksQ0FBQyxLQUFLLEdBQUc7WUFDVCxVQUFVLEVBQUUsU0FBUztZQUNyQixRQUFRLEVBQUUsU0FBUztTQUN0QixDQUFDO0lBQ04sQ0FBQztJQUNELE1BQU0sQ0FBQyx3QkFBd0IsQ0FBQyxTQUE0QixFQUFFLFNBQTRCO1FBQ3RGLElBQUksU0FBUyxDQUFDLFFBQVEsS0FBSyxTQUFTLENBQUMsUUFBUSxFQUFFO1lBQzNDLE9BQU87Z0JBQ0gsVUFBVSxFQUFFLFNBQVM7Z0JBQ3JCLFFBQVEsRUFBRSxTQUFTLENBQUMsUUFBUTthQUMvQixDQUFDO1NBQ0w7UUFDRCxPQUFPO1lBQ0gsUUFBUSxFQUFFLFNBQVMsQ0FBQyxRQUFRO1NBQy9CLENBQUM7SUFDTixDQUFDO0lBa0JELGlCQUFpQjtRQUNiLElBQUksSUFBSSxDQUFDLGVBQWUsRUFBRTtZQUN0QixJQUFJLENBQUMsa0JBQWtCLEVBQUUsQ0FBQztTQUM3QjtJQUNMLENBQUM7SUFDRCxvQkFBb0I7UUFDaEIsSUFBSSxJQUFJLENBQUMsZUFBZSxFQUFFO1lBQ3RCLElBQUksQ0FBQyxlQUFlLENBQUMsbUJBQW1CLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztTQUNyRTtJQUNMLENBQUM7SUFDRCxrQkFBa0I7UUFDZCxJQUFJLElBQUksQ0FBQyxlQUFlLEVBQUU7WUFDdEIsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsVUFBVSxFQUFFO2dCQUN4QixJQUFJLENBQUMsa0JBQWtCLEVBQUUsQ0FBQzthQUM3QjtZQUNELElBQUksSUFBSSxDQUFDLGVBQWUsQ0FBQyxNQUFNLEVBQUU7Z0JBQzdCLElBQUksQ0FBQyxlQUFlLENBQUMsTUFBTSxDQUFDO29CQUN4QixHQUFHLEVBQUUsSUFBSSxDQUFDLGNBQWMsQ0FBQyxHQUFHO29CQUM1QixJQUFJLEVBQUUsSUFBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJO2lCQUNqQyxDQUFDLENBQUM7YUFDTjtTQUNKO0lBQ0wsQ0FBQztJQUNPLGtCQUFrQjtRQUN0QixJQUFJLElBQUksQ0FBQyxlQUFlLEVBQUU7WUFDdEIsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxxQkFBcUIsRUFBRSxDQUFDO1lBQ2hFLElBQUksQ0FBQyxRQUFRLENBQUM7Z0JBQ1YsVUFBVTthQUNiLENBQUMsQ0FBQztTQUNOO0lBQ0wsQ0FBQztJQUNPLG1CQUFtQjtRQVV2QixNQUFNLEVBQUUsVUFBVSxFQUFFLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQztRQUNsQyxJQUFJLENBQUMsVUFBVSxFQUFFO1lBQ2IsT0FBTyxFQUFFLENBQUM7U0FDYjtRQUNELE1BQU0sRUFBRSxRQUFRLEVBQUUsZUFBZSxHQUFHLFFBQVEsRUFBRSxNQUFNLEdBQUcsQ0FBQyxFQUFFLFVBQVUsRUFBRSxVQUFVLEVBQUUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDO1FBQ2hHLE1BQU0sQ0FBQyxZQUFZLEVBQUUsaUJBQWlCLENBQUMsR0FBRyxDQUFDLFFBQVEsSUFBSSxlQUFlLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUF5QixDQUFDO1FBQzNHLElBQUksQ0FBQyxVQUFVLElBQUksQ0FBQyxZQUFZLEVBQUU7WUFDOUIsT0FBTyxFQUFFLENBQUM7U0FDYjtRQUNELE1BQU0sUUFBUSxHQUFHLFVBQVUsQ0FBQyxZQUFZLENBQUMsQ0FBQztRQUMxQyxNQUFNLEVBQUUsWUFBWSxFQUFFLGNBQWMsRUFBRSxHQUFHLHVCQUF1QixDQUFDO1lBQzdELFVBQVU7WUFDVixVQUFVO1lBQ1YsVUFBVTtTQUNiLENBQUMsQ0FBQztRQUNILElBQUksYUFBYSxHQUFHLFlBQVksQ0FBQztRQUNqQyxJQUFJLElBQUksR0FBRyxnQ0FBZ0MsQ0FBQztZQUN4QyxTQUFTLEVBQUUsYUFBYTtZQUN4QixVQUFVO1lBQ1YsTUFBTTtZQUNOLFVBQVU7WUFDVixRQUFRO1lBQ1IsVUFBVTtTQUNiLENBQUMsQ0FBQztRQUNILElBQUksQ0FBQyxRQUFRLElBQUksQ0FBQyxjQUFjLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsYUFBYSxDQUFDLEVBQUU7WUFDN0UsYUFBYSxHQUFHLGNBQWMsQ0FBQyxhQUFhLENBQUMsQ0FBQztZQUM5QyxJQUFJLEdBQUcsZ0NBQWdDLENBQUM7Z0JBQ3BDLFNBQVMsRUFBRSxhQUFhO2dCQUN4QixVQUFVO2dCQUNWLE1BQU07Z0JBQ04sVUFBVTtnQkFDVixRQUFRO2dCQUNSLFVBQVU7YUFDYixDQUFDLENBQUM7U0FDTjtRQUNELElBQUksa0JBQWtCLEdBQUcsaUJBQWlCLENBQUM7UUFDM0MsSUFBSSxTQUFTLEdBQUcscUNBQXFDLENBQUM7WUFDbEQsU0FBUyxFQUFFLGtCQUFrQjtZQUM3QixVQUFVO1lBQ1YsVUFBVTtZQUNWLFFBQVE7WUFDUixVQUFVO1NBQ2IsQ0FBQyxDQUFDO1FBQ0gsSUFBSSxDQUFDLFFBQVEsSUFBSSxrQkFBa0IsSUFBSSxDQUFDLGNBQWMsQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLFlBQVksQ0FBQyxrQkFBa0IsQ0FBQyxFQUFFO1lBQzVHLGtCQUFrQixHQUFHLGNBQWMsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO1lBQ3hELFNBQVMsR0FBRyxxQ0FBcUMsQ0FBQztnQkFDOUMsU0FBUyxFQUFFLGtCQUFrQjtnQkFDN0IsVUFBVTtnQkFDVixVQUFVO2dCQUNWLFFBQVE7Z0JBQ1IsVUFBVTthQUNiLENBQUMsQ0FBQztTQUNOO1FBQ0QsT0FBTztZQUNILFFBQVEsRUFBRTtnQkFDTixDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLEVBQUUsSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLO2dCQUN6QyxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLEVBQUUsU0FBUyxDQUFDLFFBQVEsQ0FBQyxLQUFLO2FBQ3REO1lBQ0QsSUFBSSxFQUFFO2dCQUNGLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUs7Z0JBQ2pDLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxTQUFTLENBQUMsSUFBSSxDQUFDLEtBQUs7YUFDOUM7WUFDRCxhQUFhLEVBQUUsc0JBQXNCLENBQUM7Z0JBQ2xDLFlBQVksRUFBRSxhQUFhO2dCQUMzQixpQkFBaUIsRUFBRSxrQkFBa0I7Z0JBQ3JDLE1BQU07Z0JBQ04sVUFBVTtnQkFDVixVQUFVO2FBQ2IsQ0FBQztTQUNMLENBQUM7SUFDTixDQUFDO0lBQ0QsTUFBTTtRQUNGLE1BQU0sZUFBMkcsRUFBM0csRUFBRSxRQUFRLEVBQUUsVUFBVSxFQUFFLEVBQUUsRUFBRSxRQUFRLEVBQUUsRUFBRSxFQUFFLE1BQU0sRUFBRSxFQUFFLEVBQUUsVUFBVSxFQUFFLEVBQUUsRUFBRSxRQUFRLEVBQUUsRUFBRSxPQUF5QixFQUF2Qiw4RkFBdUIsQ0FBQztRQUNsSCxNQUFNLCtCQUFtRSxFQUFuRSxFQUFFLGFBQWEsT0FBb0QsRUFBbEQsZ0RBQWtELENBQUM7UUFDMUUsT0FBTyxDQUFDLFFBQVEsSUFBSSxDQUFDO1lBQ25CLG9CQUFDLGlCQUFpQixvQkFBSyxhQUFhLElBQUUsS0FBSyxFQUFFLEtBQUssQ0FBQyxLQUFLLElBQUc7WUFDM0Qsb0JBQUMsa0JBQWtCLG9CQUFLLGdCQUFnQixFQUFNLEtBQUssSUFBRSxHQUFHLEVBQUUsSUFBSSxDQUFDLFlBQVksS0FDeEUsUUFBUSxDQUNVLENBQ3BCLENBQUMsQ0FBQyxDQUFDO0lBQ1YsQ0FBQzs7QUFDTSxxQkFBSyxHQUFHO0lBQ1gsSUFBSSxpQkFBaUIsS0FBSyxPQUFPLGlCQUE2QyxDQUFDLENBQUMsQ0FBQztJQUNqRixJQUFJLGtCQUFrQixLQUFLLE9BQU8sa0JBQStDLENBQUMsQ0FBQyxDQUFDO0NBQ3ZGLENBQUM7QUFFTixNQUFNLENBQUMsTUFBTSxZQUFZLEdBQUcsY0FBYyxDQUFDLGVBQWUsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgUmVhY3QgZnJvbSAncmVhY3QnO1xuaW1wb3J0IHN0eWxlZCwgeyBjc3MsIHRoZW1lZCB9IGZyb20gJy4uLy4uL3V0aWxzL3N0eWxlZCc7XG5pbXBvcnQgeyB3aXRoUmVzcG9uc2l2ZSwgUmVzcG9uc2l2ZUNvbXBvbmVudFByb3BzIH0gZnJvbSAnLi4vLi4vaG9jL3dpdGhSZXNwb25zaXZlJztcbmltcG9ydCB7IEZseW91dFBvc2l0aW9uLCBCYXNpY1Bvc2l0aW9uIH0gZnJvbSAnLi9GbHlvdXQudHlwZXMucGFydCc7XG5pbXBvcnQgeyBkaXN0YW5jZVB4LCBkaXN0YW5jZSB9IGZyb20gJy4uLy4uL2Rpc3RhbmNlJztcbmltcG9ydCB7IFN0YW5kYXJkUHJvcHMgfSBmcm9tICcuLi8uLi9jb21tb24nO1xuaW1wb3J0IHsgZ2V0Rm9udFN0eWxlIH0gZnJvbSAnLi4vLi4vdGV4dFN0eWxlcyc7XG5jb25zdCB0b29sVGlwQXJyb3dTaXplID0gMTg7XG5leHBvcnQgaW50ZXJmYWNlIERpbWVuc2lvbnMge1xuICAgIHdpZHRoOiBudW1iZXI7XG4gICAgaGVpZ2h0OiBudW1iZXI7XG59XG5pbnRlcmZhY2UgSW52ZXJ0ZWRQb3NpdGlvbiB7XG4gICAgdG9wOiAnYm90dG9tJztcbiAgICBsZWZ0OiAncmlnaHQnO1xuICAgIHJpZ2h0OiAnbGVmdCc7XG4gICAgYm90dG9tOiAndG9wJztcbn1cbmV4cG9ydCBpbnRlcmZhY2UgRmx5b3V0V2luZG93UHJvcHMgZXh0ZW5kcyBSZXNwb25zaXZlQ29tcG9uZW50UHJvcHMsIFN0YW5kYXJkUHJvcHMge1xuICAgIHRhcmdldFJlY3Q6IENsaWVudFJlY3Q7XG4gICAgY2hpbGRyZW46IFJlYWN0LlJlYWN0Tm9kZTtcbiAgICBwb3NpdGlvbj86IEZseW91dFBvc2l0aW9uO1xuICAgIGRlZmF1bHRQb3NpdGlvbj86IEZseW91dFBvc2l0aW9uO1xuICAgIG9mZnNldD86IG51bWJlcjtcbn1cbmV4cG9ydCBpbnRlcmZhY2UgUG9zaXRpb24ge1xuICAgIHRvcD86IG51bWJlcjtcbiAgICByaWdodD86IG51bWJlcjtcbiAgICBib3R0b20/OiBudW1iZXI7XG4gICAgbGVmdD86IG51bWJlcjtcbn1cbmZ1bmN0aW9uIGdldEZseW91dEFycm93UG9zaXRpb24oeyBtYWluUG9zaXRpb24sIHNlY29uZGFyeVBvc2l0aW9uOiBvcmlnU2Vjb25kYXJ5UG9zaXRpb24sIG9mZnNldCwgdGFyZ2V0UmVjdCwgZmx5b3V0UmVjdCwgfToge1xuICAgIG1haW5Qb3NpdGlvbjogQmFzaWNQb3NpdGlvbjtcbiAgICBzZWNvbmRhcnlQb3NpdGlvbj86IEJhc2ljUG9zaXRpb247XG4gICAgdGFyZ2V0UmVjdDogQ2xpZW50UmVjdDtcbiAgICBmbHlvdXRSZWN0OiBDbGllbnRSZWN0O1xuICAgIG9mZnNldDogbnVtYmVyO1xufSkge1xuICAgIGlmIChtYWluUG9zaXRpb24gJiYgZmx5b3V0UmVjdC53aWR0aCkge1xuICAgICAgICBjb25zdCB2ZXJ0aWNhbCA9IGlzVmVydGljYWwobWFpblBvc2l0aW9uKTtcbiAgICAgICAgY29uc3QgbWFpbkF4aXNUYXJnZXRTaXplID0gdmVydGljYWwgPyB0YXJnZXRSZWN0LmhlaWdodCA6IHRhcmdldFJlY3Qud2lkdGg7XG4gICAgICAgIGNvbnN0IHNlY29uZGFyeUF4aXNUYXJnZXRTaXplID0gdmVydGljYWwgPyB0YXJnZXRSZWN0LndpZHRoIDogdGFyZ2V0UmVjdC5oZWlnaHQ7XG4gICAgICAgIGNvbnN0IHNlY29uZGFyeUF4aXNDb250bmV0U2l6ZSA9IHZlcnRpY2FsID8gZmx5b3V0UmVjdC53aWR0aCA6IGZseW91dFJlY3QuaGVpZ2h0O1xuICAgICAgICBjb25zdCBtYWluUG9zaXRpb25WYWx1ZSA9IG1haW5BeGlzVGFyZ2V0U2l6ZSArIG9mZnNldCArIDEgLSB0b29sVGlwQXJyb3dTaXplIC8gMjtcbiAgICAgICAgbGV0IHNlY29uZGFyeVBvc2l0aW9uOiBzdHJpbmc7XG4gICAgICAgIGxldCBzZWNvbmRhcnlQb3NpdGlvblZhbHVlOiBudW1iZXI7XG4gICAgICAgIGlmICghb3JpZ1NlY29uZGFyeVBvc2l0aW9uKSB7XG4gICAgICAgICAgICBzZWNvbmRhcnlQb3NpdGlvbiA9IHZlcnRpY2FsID8gJ2xlZnQnIDogJ3RvcCc7XG4gICAgICAgICAgICBzZWNvbmRhcnlQb3NpdGlvblZhbHVlID0gKHNlY29uZGFyeUF4aXNUYXJnZXRTaXplIC0gdG9vbFRpcEFycm93U2l6ZSkgLyAyO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgc2Vjb25kYXJ5UG9zaXRpb24gPSBvcmlnU2Vjb25kYXJ5UG9zaXRpb247XG4gICAgICAgICAgICBzZWNvbmRhcnlQb3NpdGlvblZhbHVlID1cbiAgICAgICAgICAgICAgICBzZWNvbmRhcnlBeGlzVGFyZ2V0U2l6ZSAvIDQgPiBzZWNvbmRhcnlBeGlzQ29udG5ldFNpemUgLSB0b29sVGlwQXJyb3dTaXplXG4gICAgICAgICAgICAgICAgICAgID8gc2Vjb25kYXJ5QXhpc0NvbnRuZXRTaXplIC0gdG9vbFRpcEFycm93U2l6ZVxuICAgICAgICAgICAgICAgICAgICA6IHNlY29uZGFyeUF4aXNUYXJnZXRTaXplIC8gNDtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCByb3RhdGUgPSB7XG4gICAgICAgICAgICB0b3A6IDAsXG4gICAgICAgICAgICBsZWZ0OiAtOTAsXG4gICAgICAgICAgICByaWdodDogOTAsXG4gICAgICAgICAgICBib3R0b206IDE4MCxcbiAgICAgICAgfTtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHJvdGF0ZTogcm90YXRlW21haW5Qb3NpdGlvbl0sXG4gICAgICAgICAgICBbaW52ZXJ0UG9zaXRpb24obWFpblBvc2l0aW9uKV06IG1haW5Qb3NpdGlvblZhbHVlLFxuICAgICAgICAgICAgW3NlY29uZGFyeVBvc2l0aW9uXTogc2Vjb25kYXJ5UG9zaXRpb25WYWx1ZSxcbiAgICAgICAgfTtcbiAgICB9XG4gICAgcmV0dXJuIHt9O1xufVxuZnVuY3Rpb24gZ2V0RGV0YWlsZWRQb3NpdGlvbkluZm8oeyB0YXJnZXRSZWN0LCBkaW1lbnNpb25zLCBmbHlvdXRSZWN0LCB9OiB7XG4gICAgdGFyZ2V0UmVjdDogQ2xpZW50UmVjdDtcbiAgICBkaW1lbnNpb25zOiBEaW1lbnNpb25zO1xuICAgIGZseW91dFJlY3Q6IENsaWVudFJlY3Q7XG59KSB7XG4gICAgY29uc3Qgdmlld3BvcnRQb3NpdGlvbiA9IHtcbiAgICAgICAgbGVmdDogdGFyZ2V0UmVjdC5sZWZ0LFxuICAgICAgICByaWdodDogZGltZW5zaW9ucy53aWR0aCAtIHRhcmdldFJlY3QucmlnaHQsXG4gICAgICAgIHRvcDogdGFyZ2V0UmVjdC50b3AsXG4gICAgICAgIGJvdHRvbTogZGltZW5zaW9ucy5oZWlnaHQgLSB0YXJnZXRSZWN0LmJvdHRvbSxcbiAgICB9O1xuICAgIGNvbnN0IGhhc0Vub3VnaFNwYWNlID0ge307XG4gICAgY29uc3QgaGFzTW9yZVNwYWNlID0ge307XG4gICAgZm9yIChjb25zdCBwb3NpdGlvbiBvZiBPYmplY3Qua2V5cyh2aWV3cG9ydFBvc2l0aW9uKSkge1xuICAgICAgICBpZiAoaXNWZXJ0aWNhbChwb3NpdGlvbiBhcyBCYXNpY1Bvc2l0aW9uKSkge1xuICAgICAgICAgICAgLy8gVGhlcmUgaXMgYWx3YXlzIGVub3VnaHQgc3BhY2UgZm9yIHRvcC9ib3R0b20gZmx5b3V0IHdoZW4gaXQgbGF5cyBvdXRzaWRlIG9mIHRoZSB2aWV3cG9ydC5cbiAgICAgICAgICAgIGhhc0Vub3VnaFNwYWNlW3Bvc2l0aW9uXSA9IHRhcmdldFJlY3QudG9wID4gZGltZW5zaW9ucy5oZWlnaHQgfHwgdmlld3BvcnRQb3NpdGlvbltwb3NpdGlvbl0gPiBmbHlvdXRSZWN0LmhlaWdodDtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIGhhc0Vub3VnaFNwYWNlW3Bvc2l0aW9uXSA9IHZpZXdwb3J0UG9zaXRpb25bcG9zaXRpb25dID4gZmx5b3V0UmVjdC53aWR0aDtcbiAgICAgICAgfVxuICAgICAgICBoYXNNb3JlU3BhY2VbcG9zaXRpb25dID0gdmlld3BvcnRQb3NpdGlvbltwb3NpdGlvbl0gPiB2aWV3cG9ydFBvc2l0aW9uW2ludmVydFBvc2l0aW9uKHBvc2l0aW9uIGFzIEJhc2ljUG9zaXRpb24pXTtcbiAgICB9XG4gICAgcmV0dXJuIHtcbiAgICAgICAgdmlld3BvcnRQb3NpdGlvbixcbiAgICAgICAgaGFzRW5vdWdoU3BhY2UsXG4gICAgICAgIGhhc01vcmVTcGFjZSxcbiAgICB9O1xufVxuZnVuY3Rpb24gZ2V0TWFpbkF4aXNGbHlvdXRQb3NpdGlvbkFuZFNpemUoeyBkaXJlY3Rpb24sIHRhcmdldFJlY3QsIG9mZnNldCwgZGltZW5zaW9ucywgdmVydGljYWwsIGZseW91dFJlY3QsIH06IHtcbiAgICBkaXJlY3Rpb246IEJhc2ljUG9zaXRpb247XG4gICAgdGFyZ2V0UmVjdDogQ2xpZW50UmVjdDtcbiAgICBmbHlvdXRSZWN0OiBDbGllbnRSZWN0O1xuICAgIG9mZnNldDogbnVtYmVyO1xuICAgIGRpbWVuc2lvbnM6IERpbWVuc2lvbnM7XG4gICAgdmVydGljYWw6IGJvb2xlYW47XG59KSB7XG4gICAgY29uc3QgdGFyZ2V0U2l6ZSA9IHZlcnRpY2FsID8gdGFyZ2V0UmVjdC5oZWlnaHQgOiB0YXJnZXRSZWN0LndpZHRoO1xuICAgIGNvbnN0IGZseW91dFNpemUgPSB2ZXJ0aWNhbCA/IGZseW91dFJlY3QuaGVpZ2h0IDogZmx5b3V0UmVjdC53aWR0aDtcbiAgICBjb25zdCB7IGhhc0Vub3VnaFNwYWNlLCB2aWV3cG9ydFBvc2l0aW9uIH0gPSBnZXREZXRhaWxlZFBvc2l0aW9uSW5mbyh7XG4gICAgICAgIHRhcmdldFJlY3QsXG4gICAgICAgIGRpbWVuc2lvbnMsXG4gICAgICAgIGZseW91dFJlY3QsXG4gICAgfSk7XG4gICAgY29uc3Qgc2l6ZVZhbHVlID0gaGFzRW5vdWdoU3BhY2VbZGlyZWN0aW9uXVxuICAgICAgICA/IGZseW91dFNpemVcbiAgICAgICAgOiB2aWV3cG9ydFBvc2l0aW9uW2RpcmVjdGlvbl0gLSAob2Zmc2V0ICsgdG9vbFRpcEFycm93U2l6ZSAvIDIpIC0gZGlzdGFuY2VQeC5tZWRpdW07XG4gICAgcmV0dXJuIHtcbiAgICAgICAgcG9zaXRpb246IHtcbiAgICAgICAgICAgIG5hbWU6IGludmVydFBvc2l0aW9uKGRpcmVjdGlvbiksXG4gICAgICAgICAgICB2YWx1ZTogdGFyZ2V0U2l6ZSArIChvZmZzZXQgKyB0b29sVGlwQXJyb3dTaXplIC8gMiksXG4gICAgICAgIH0sXG4gICAgICAgIHNpemU6IHtcbiAgICAgICAgICAgIG5hbWU6IHZlcnRpY2FsID8gJ2hlaWdodCcgOiAnd2lkdGgnLFxuICAgICAgICAgICAgdmFsdWU6IHNpemVWYWx1ZSxcbiAgICAgICAgfSxcbiAgICB9O1xufVxuZnVuY3Rpb24gZ2V0U2Vjb25kYXJ5QXhpc0ZseW91dFBvc2l0aW9uQW5kU2l6ZSh7IGRpcmVjdGlvbiwgdGFyZ2V0UmVjdCwgZGltZW5zaW9ucywgdmVydGljYWwsIGZseW91dFJlY3QsIH06IHtcbiAgICBkaXJlY3Rpb246IEJhc2ljUG9zaXRpb247XG4gICAgdGFyZ2V0UmVjdDogQ2xpZW50UmVjdDtcbiAgICBkaW1lbnNpb25zOiBEaW1lbnNpb25zO1xuICAgIHZlcnRpY2FsOiBib29sZWFuO1xuICAgIGZseW91dFJlY3Q6IENsaWVudFJlY3Q7XG59KSB7XG4gICAgbGV0IHBvc2l0aW9uVmFsdWU6IG51bWJlcjtcbiAgICBsZXQgcG9zaXRpb25OYW1lOiBCYXNpY1Bvc2l0aW9uO1xuICAgIGNvbnN0IHNpemVOYW1lID0gdmVydGljYWwgPyAnd2lkdGgnIDogJ2hlaWdodCc7XG4gICAgY29uc3QgdGFyZ2V0U2l6ZSA9IHZlcnRpY2FsID8gdGFyZ2V0UmVjdC53aWR0aCA6IHRhcmdldFJlY3QuaGVpZ2h0O1xuICAgIGNvbnN0IHRhcmdldFBvc2l0aW9uID0gdmVydGljYWwgPyB0YXJnZXRSZWN0LmxlZnQgOiB0YXJnZXRSZWN0LnRvcDtcbiAgICBjb25zdCBmbHlvdXRTaXplID0gdmVydGljYWwgPyBmbHlvdXRSZWN0LndpZHRoIDogZmx5b3V0UmVjdC5oZWlnaHQ7XG4gICAgY29uc3Qgd2luZG93U2l6ZSA9IHZlcnRpY2FsID8gZGltZW5zaW9ucy53aWR0aCA6IGRpbWVuc2lvbnMuaGVpZ2h0O1xuICAgIGNvbnN0IHsgdmlld3BvcnRQb3NpdGlvbiB9ID0gZ2V0RGV0YWlsZWRQb3NpdGlvbkluZm8oe1xuICAgICAgICB0YXJnZXRSZWN0LFxuICAgICAgICBkaW1lbnNpb25zLFxuICAgICAgICBmbHlvdXRSZWN0LFxuICAgIH0pO1xuICAgIGxldCBzaXplVmFsdWUgPSBmbHlvdXRTaXplO1xuICAgIGlmIChkaXJlY3Rpb24gPT09IHVuZGVmaW5lZCkge1xuICAgICAgICBwb3NpdGlvbk5hbWUgPSB2ZXJ0aWNhbCA/ICdsZWZ0JyA6ICd0b3AnO1xuICAgICAgICBjb25zdCBjZW50ZXJlZFZhbHVlID0gKHRhcmdldFNpemUgLSBmbHlvdXRTaXplKSAvIDI7XG4gICAgICAgIGlmICh2aWV3cG9ydFBvc2l0aW9uW3Bvc2l0aW9uTmFtZV0gPiAwICYmIHZpZXdwb3J0UG9zaXRpb25bcG9zaXRpb25OYW1lXSArIGNlbnRlcmVkVmFsdWUgPCAwKSB7XG4gICAgICAgICAgICBwb3NpdGlvblZhbHVlID0gLXZpZXdwb3J0UG9zaXRpb25bcG9zaXRpb25OYW1lXSArIGRpc3RhbmNlUHgubWVkaXVtO1xuICAgICAgICAgICAgc2l6ZVZhbHVlID0gZmx5b3V0U2l6ZSA+IHdpbmRvd1NpemUgPyB3aW5kb3dTaXplIC0gZGlzdGFuY2VQeC54bGFyZ2UgOiBmbHlvdXRTaXplO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgcG9zaXRpb25WYWx1ZSA9IGNlbnRlcmVkVmFsdWU7XG4gICAgICAgIH1cbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICAgIHBvc2l0aW9uTmFtZSA9IGRpcmVjdGlvbjtcbiAgICAgICAgcG9zaXRpb25WYWx1ZSA9XG4gICAgICAgICAgICBwb3NpdGlvbk5hbWUgPT09ICd0b3AnIHx8IHBvc2l0aW9uTmFtZSA9PT0gJ2xlZnQnXG4gICAgICAgICAgICAgICAgPyAwXG4gICAgICAgICAgICAgICAgOiB0YXJnZXRQb3NpdGlvbiAtIGZseW91dFNpemUgPiAwXG4gICAgICAgICAgICAgICAgICAgID8gdGFyZ2V0U2l6ZSAtIGZseW91dFNpemVcbiAgICAgICAgICAgICAgICAgICAgOiAtdGFyZ2V0UG9zaXRpb24gKyBkaXN0YW5jZVB4Lm1lZGl1bTtcbiAgICAgICAgaWYgKHBvc2l0aW9uTmFtZSA9PT0gJ3RvcCcgfHwgcG9zaXRpb25OYW1lID09PSAnbGVmdCcpIHtcbiAgICAgICAgICAgIHNpemVWYWx1ZSA9XG4gICAgICAgICAgICAgICAgdGFyZ2V0UG9zaXRpb24gKyBwb3NpdGlvblZhbHVlICsgZmx5b3V0U2l6ZSA+IHdpbmRvd1NpemVcbiAgICAgICAgICAgICAgICAgICAgPyB3aW5kb3dTaXplIC0gdGFyZ2V0UG9zaXRpb24gKyBwb3NpdGlvblZhbHVlIC0gZGlzdGFuY2VQeC5tZWRpdW1cbiAgICAgICAgICAgICAgICAgICAgOiBmbHlvdXRTaXplO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgc2l6ZVZhbHVlID1cbiAgICAgICAgICAgICAgICBmbHlvdXRTaXplID4gdGFyZ2V0UG9zaXRpb24gKyB0YXJnZXRTaXplID8gdGFyZ2V0UG9zaXRpb24gKyB0YXJnZXRTaXplIC0gZGlzdGFuY2VQeC5tZWRpdW0gOiBmbHlvdXRTaXplO1xuICAgICAgICAgICAgcG9zaXRpb25OYW1lID0gaW52ZXJ0UG9zaXRpb24ocG9zaXRpb25OYW1lKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4ge1xuICAgICAgICBwb3NpdGlvbjoge1xuICAgICAgICAgICAgbmFtZTogcG9zaXRpb25OYW1lLFxuICAgICAgICAgICAgdmFsdWU6IHBvc2l0aW9uVmFsdWUsXG4gICAgICAgIH0sXG4gICAgICAgIHNpemU6IHtcbiAgICAgICAgICAgIG5hbWU6IHNpemVOYW1lLFxuICAgICAgICAgICAgdmFsdWU6IHNpemVWYWx1ZSxcbiAgICAgICAgfSxcbiAgICB9O1xufVxuZnVuY3Rpb24gaW52ZXJ0UG9zaXRpb24ocG9zaXRpb246IEJhc2ljUG9zaXRpb24pIHtcbiAgICBjb25zdCBpbnZlcnRlZFBvc2l0aW9uOiBJbnZlcnRlZFBvc2l0aW9uID0ge1xuICAgICAgICB0b3A6ICdib3R0b20nLFxuICAgICAgICBsZWZ0OiAncmlnaHQnLFxuICAgICAgICByaWdodDogJ2xlZnQnLFxuICAgICAgICBib3R0b206ICd0b3AnLFxuICAgIH07XG4gICAgcmV0dXJuIGludmVydGVkUG9zaXRpb25bcG9zaXRpb25dO1xufVxuZnVuY3Rpb24gaXNWZXJ0aWNhbChwb3NpdGlvbjogQmFzaWNQb3NpdGlvbikge1xuICAgIHJldHVybiBwb3NpdGlvbiA9PT0gJ3RvcCcgfHwgcG9zaXRpb24gPT09ICdib3R0b20nID8gdHJ1ZSA6IGZhbHNlO1xufVxuZXhwb3J0IGludGVyZmFjZSBTdHlsZWRGbHlvdXRXaW5kb3dQcm9wcyB7XG4gICAgc2l6ZT86IHtcbiAgICAgICAgd2lkdGg/OiBudW1iZXI7XG4gICAgICAgIGhlaWdodD86IG51bWJlcjtcbiAgICB9O1xuICAgIHBvc2l0aW9uPzogUG9zaXRpb247XG4gICAgbm9HdXR0ZXI/OiBib29sZWFuO1xufVxuY29uc3QgU3R5bGVkRmx5b3V0V2luZG93ID0gc3R5bGVkKCdkaXYnKTxTdHlsZWRGbHlvdXRXaW5kb3dQcm9wcz4odGhlbWVkKCh7IHRoZW1lLCBzaXplLCBwb3NpdGlvbiwgbm9HdXR0ZXIgfSkgPT4gY3NzIGBcbiAgICAgICR7Z2V0Rm9udFN0eWxlKHsgc2l6ZTogJ21lZGl1bScgfSl9XG5cbiAgICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTtcbiAgICAgIHotaW5kZXg6IDEwMDtcbiAgICAgIGJveC1zaXppbmc6IGJvcmRlci1ib3g7XG4gICAgICBib3gtc2hhZG93OiAwIDJweCA2cHggMCByZ2JhKDc1LCA3OCwgODIsIDAuMik7XG4gICAgICBib3JkZXI6IDFweCBzb2xpZCAke3RoZW1lLnVpNH07XG4gICAgICBiYWNrZ3JvdW5kOiAke3RoZW1lLmZseW91dC5iYWNrZ3JvdW5kfTtcbiAgICAgIGNvbG9yOiAke3RoZW1lLmZseW91dC50ZXh0Q29sb3J9O1xuICAgICAgbWF4LXdpZHRoOiAke3RoZW1lLmZseW91dC5tYXhXaWR0aH07XG4gICAgICBtYXgtaGVpZ2h0OiAke3RoZW1lLmZseW91dC5tYXhIZWlnaHR9O1xuICAgICAgJHshbm9HdXR0ZXIgPyBgcGFkZGluZzogJHtkaXN0YW5jZS5zbWFsbH0gJHtkaXN0YW5jZS5tZWRpdW19O2AgOiAnJ30gYm94LXNpemluZzogYm9yZGVyLWJveDtcblxuICAgICAgJHtzaXplICYmIHNpemUud2lkdGggIT09IHVuZGVmaW5lZCA/IGB3aWR0aDogJHtzaXplLndpZHRofXB4YCA6ICcnfTtcbiAgICAgICR7c2l6ZSAmJiBzaXplLmhlaWdodCAhPT0gdW5kZWZpbmVkID8gYGhlaWdodDogJHtzaXplLmhlaWdodH1weGAgOiAnJ307XG4gICAgICAke3Bvc2l0aW9uICYmIHBvc2l0aW9uLnRvcCAhPT0gdW5kZWZpbmVkID8gYHRvcDogJHtwb3NpdGlvbi50b3B9cHhgIDogJyd9O1xuICAgICAgJHtwb3NpdGlvbiAmJiBwb3NpdGlvbi5sZWZ0ICE9PSB1bmRlZmluZWQgPyBgbGVmdDogJHtwb3NpdGlvbi5sZWZ0fXB4YCA6ICcnfTtcbiAgICAgICR7cG9zaXRpb24gJiYgcG9zaXRpb24uYm90dG9tICE9PSB1bmRlZmluZWQgPyBgYm90dG9tOiAke3Bvc2l0aW9uLmJvdHRvbX1weGAgOiAnJ307XG4gICAgICAke3Bvc2l0aW9uICYmIHBvc2l0aW9uLnJpZ2h0ICE9PSB1bmRlZmluZWQgPyBgcmlnaHQ6ICR7cG9zaXRpb24ucmlnaHR9cHhgIDogJyd9O1xuICAgICAgb3ZlcmZsb3c6IGF1dG87XG4gICAgYCkpO1xuaW50ZXJmYWNlIFN0eWxlZEZseW91dEFycm93UHJvcHMgZXh0ZW5kcyBQb3NpdGlvbiB7XG4gICAgcm90YXRlPzogbnVtYmVyO1xufVxuY29uc3QgU3R5bGVkRmx5b3V0QXJyb3cgPSBzdHlsZWQoJ2RpdicpPFN0eWxlZEZseW91dEFycm93UHJvcHM+KHRoZW1lZCgoeyB0b3AsIGxlZnQsIGJvdHRvbSwgcmlnaHQsIHJvdGF0ZSwgdGhlbWUgfSkgPT4gY3NzIGBcbiAgICAgIHBvaW50ZXItZXZlbnRzOiBub25lO1xuICAgICAgcG9zaXRpb246IGFic29sdXRlO1xuICAgICAgei1pbmRleDogMTAxO1xuICAgICAgd2lkdGg6ICR7dG9vbFRpcEFycm93U2l6ZX1weDtcbiAgICAgIGhlaWdodDogJHt0b29sVGlwQXJyb3dTaXplfXB4O1xuXG4gICAgICAke3RvcCAhPT0gdW5kZWZpbmVkID8gYHRvcDogJHt0b3B9cHhgIDogJyd9O1xuICAgICAgJHtsZWZ0ICE9PSB1bmRlZmluZWQgPyBgbGVmdDogJHtsZWZ0fXB4YCA6ICcnfTtcbiAgICAgICR7Ym90dG9tICE9PSB1bmRlZmluZWQgPyBgYm90dG9tOiAke2JvdHRvbX1weGAgOiAnJ307XG4gICAgICAke3JpZ2h0ICE9PSB1bmRlZmluZWQgPyBgcmlnaHQ6ICR7cmlnaHR9cHhgIDogJyd9O1xuICAgICAgJHtyb3RhdGUgIT09IHVuZGVmaW5lZCA/IGB0cmFuc2Zvcm06IHJvdGF0ZSgke3JvdGF0ZX1kZWcpYCA6ICcnfTtcblxuICAgICAgOmJlZm9yZSB7XG4gICAgICAgIGNvbnRlbnQ6ICcgJztcbiAgICAgICAgcG9zaXRpb246IGFic29sdXRlO1xuICAgICAgICB0b3A6IDA7XG4gICAgICAgIGxlZnQ6IDA7XG4gICAgICAgIGJvcmRlci1zdHlsZTogc29saWQ7XG4gICAgICAgIGJvcmRlci13aWR0aDogJHt0b29sVGlwQXJyb3dTaXplIC8gMn1weDtcbiAgICAgICAgYm9yZGVyLWNvbG9yOiAke3RoZW1lLnVpNH0gdHJhbnNwYXJlbnQgdHJhbnNwYXJlbnQgdHJhbnNwYXJlbnQ7XG4gICAgICB9XG5cbiAgICAgIDphZnRlciB7XG4gICAgICAgIGNvbnRlbnQ6ICcgJztcbiAgICAgICAgcG9zaXRpb246IGFic29sdXRlO1xuICAgICAgICB0b3A6IDA7XG4gICAgICAgIGxlZnQ6IDA7XG4gICAgICAgIGJvcmRlci1zdHlsZTogc29saWQ7XG4gICAgICAgIGJvcmRlci13aWR0aDogJHt0b29sVGlwQXJyb3dTaXplIC8gMiAtIDF9cHg7XG4gICAgICAgIG1hcmdpbi1sZWZ0OiAxcHg7XG4gICAgICAgIGJvcmRlci1jb2xvcjogJHt0aGVtZS5mbHlvdXQuYmFja2dyb3VuZH0gdHJhbnNwYXJlbnQgdHJhbnNwYXJlbnQgdHJhbnNwYXJlbnQ7XG4gICAgICB9XG4gICAgYCkpO1xuZXhwb3J0IGludGVyZmFjZSBGbHlvdXRXaW5kb3dTdGF0ZSB7XG4gICAgZmx5b3V0UmVjdD86IENsaWVudFJlY3Q7XG4gICAgY2hpbGRyZW4/OiBSZWFjdC5SZWFjdE5vZGU7XG59XG5pbnRlcmZhY2UgU2Nyb2xsUG9zaXRpb24ge1xuICAgIHRvcDogbnVtYmVyO1xuICAgIGxlZnQ6IG51bWJlcjtcbn1cbmV4cG9ydCBjbGFzcyBGbHlvdXRXaW5kb3dJbnQgZXh0ZW5kcyBSZWFjdC5Db21wb25lbnQ8Rmx5b3V0V2luZG93UHJvcHMsIEZseW91dFdpbmRvd1N0YXRlPiB7XG4gICAgcHJpdmF0ZSBmbHlvdXRDb250YWluZXI6IEhUTUxEaXZFbGVtZW50IHwgbnVsbDtcbiAgICBwcml2YXRlIHNjcm9sbFBvc2l0aW9uOiBTY3JvbGxQb3NpdGlvbiA9IHsgdG9wOiAwLCBsZWZ0OiAwIH07XG4gICAgY29uc3RydWN0b3IocHJvcHM6IEZseW91dFdpbmRvd1Byb3BzKSB7XG4gICAgICAgIHN1cGVyKHByb3BzKTtcbiAgICAgICAgdGhpcy5zdGF0ZSA9IHtcbiAgICAgICAgICAgIGZseW91dFJlY3Q6IHVuZGVmaW5lZCxcbiAgICAgICAgICAgIGNoaWxkcmVuOiB1bmRlZmluZWQsXG4gICAgICAgIH07XG4gICAgfVxuICAgIHN0YXRpYyBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMobmV4dFByb3BzOiBGbHlvdXRXaW5kb3dQcm9wcywgcHJldlN0YXRlOiBGbHlvdXRXaW5kb3dTdGF0ZSkge1xuICAgICAgICBpZiAobmV4dFByb3BzLmNoaWxkcmVuICE9PSBwcmV2U3RhdGUuY2hpbGRyZW4pIHtcbiAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgZmx5b3V0UmVjdDogdW5kZWZpbmVkLFxuICAgICAgICAgICAgICAgIGNoaWxkcmVuOiBuZXh0UHJvcHMuY2hpbGRyZW4sXG4gICAgICAgICAgICB9O1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBjaGlsZHJlbjogbmV4dFByb3BzLmNoaWxkcmVuLFxuICAgICAgICB9O1xuICAgIH1cbiAgICBwcml2YXRlIHNldEZseW91dFJlZiA9IChlbDogSFRNTERpdkVsZW1lbnQpID0+IHtcbiAgICAgICAgaWYgKHRoaXMuZmx5b3V0Q29udGFpbmVyKSB7XG4gICAgICAgICAgICB0aGlzLmZseW91dENvbnRhaW5lci5yZW1vdmVFdmVudExpc3RlbmVyKCdzY3JvbGwnLCB0aGlzLm9uU2Nyb2xsKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoZWwpIHtcbiAgICAgICAgICAgIGVsLmFkZEV2ZW50TGlzdGVuZXIoJ3Njcm9sbCcsIHRoaXMub25TY3JvbGwpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuZmx5b3V0Q29udGFpbmVyID0gZWw7XG4gICAgfTtcbiAgICBwcml2YXRlIG9uU2Nyb2xsID0gKGU6IFVJRXZlbnQpID0+IHtcbiAgICAgICAgaWYgKGUudGFyZ2V0ICYmIGUudGFyZ2V0IGluc3RhbmNlb2YgSFRNTEVsZW1lbnQpIHtcbiAgICAgICAgICAgIHRoaXMuc2Nyb2xsUG9zaXRpb24gPSB7XG4gICAgICAgICAgICAgICAgdG9wOiBlLnRhcmdldC5zY3JvbGxUb3AsXG4gICAgICAgICAgICAgICAgbGVmdDogZS50YXJnZXQuc2Nyb2xsTGVmdCxcbiAgICAgICAgICAgIH07XG4gICAgICAgIH1cbiAgICB9O1xuICAgIGNvbXBvbmVudERpZE1vdW50KCkge1xuICAgICAgICBpZiAodGhpcy5mbHlvdXRDb250YWluZXIpIHtcbiAgICAgICAgICAgIHRoaXMudXBkYXRlTWVhc3VyZW1lbnRzKCk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgY29tcG9uZW50V2lsbFVubW91bnQoKSB7XG4gICAgICAgIGlmICh0aGlzLmZseW91dENvbnRhaW5lcikge1xuICAgICAgICAgICAgdGhpcy5mbHlvdXRDb250YWluZXIucmVtb3ZlRXZlbnRMaXN0ZW5lcignc2Nyb2xsJywgdGhpcy5vblNjcm9sbCk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgY29tcG9uZW50RGlkVXBkYXRlKCkge1xuICAgICAgICBpZiAodGhpcy5mbHlvdXRDb250YWluZXIpIHtcbiAgICAgICAgICAgIGlmICghdGhpcy5zdGF0ZS5mbHlvdXRSZWN0KSB7XG4gICAgICAgICAgICAgICAgdGhpcy51cGRhdGVNZWFzdXJlbWVudHMoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICh0aGlzLmZseW91dENvbnRhaW5lci5zY3JvbGwpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmZseW91dENvbnRhaW5lci5zY3JvbGwoe1xuICAgICAgICAgICAgICAgICAgICB0b3A6IHRoaXMuc2Nyb2xsUG9zaXRpb24udG9wLFxuICAgICAgICAgICAgICAgICAgICBsZWZ0OiB0aGlzLnNjcm9sbFBvc2l0aW9uLmxlZnQsXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgcHJpdmF0ZSB1cGRhdGVNZWFzdXJlbWVudHMoKSB7XG4gICAgICAgIGlmICh0aGlzLmZseW91dENvbnRhaW5lcikge1xuICAgICAgICAgICAgY29uc3QgZmx5b3V0UmVjdCA9IHRoaXMuZmx5b3V0Q29udGFpbmVyLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpO1xuICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICAgICAgZmx5b3V0UmVjdCxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfVxuICAgIHByaXZhdGUgZ2V0Rmx5b3V0RGltZW5zaW9ucygpOiB7XG4gICAgICAgIHNpemU/OiB7XG4gICAgICAgICAgICB3aWR0aD86IG51bWJlcjtcbiAgICAgICAgICAgIGhlaWdodD86IG51bWJlcjtcbiAgICAgICAgfTtcbiAgICAgICAgcG9zaXRpb24/OiBQb3NpdGlvbjtcbiAgICAgICAgYXJyb3dQb3NpdGlvbj86IFBvc2l0aW9uICYge1xuICAgICAgICAgICAgcm90YXRlPzogbnVtYmVyO1xuICAgICAgICB9O1xuICAgIH0ge1xuICAgICAgICBjb25zdCB7IGZseW91dFJlY3QgfSA9IHRoaXMuc3RhdGU7XG4gICAgICAgIGlmICghZmx5b3V0UmVjdCkge1xuICAgICAgICAgICAgcmV0dXJuIHt9O1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHsgcG9zaXRpb24sIGRlZmF1bHRQb3NpdGlvbiA9ICdib3R0b20nLCBvZmZzZXQgPSA0LCBkaW1lbnNpb25zLCB0YXJnZXRSZWN0IH0gPSB0aGlzLnByb3BzO1xuICAgICAgICBjb25zdCBbbWFpblBvc2l0aW9uLCBzZWNvbmRhcnlQb3NpdGlvbl0gPSAocG9zaXRpb24gfHwgZGVmYXVsdFBvc2l0aW9uKS5zcGxpdCgnLScpIGFzIEFycmF5PEJhc2ljUG9zaXRpb24+O1xuICAgICAgICBpZiAoIWRpbWVuc2lvbnMgfHwgIW1haW5Qb3NpdGlvbikge1xuICAgICAgICAgICAgcmV0dXJuIHt9O1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHZlcnRpY2FsID0gaXNWZXJ0aWNhbChtYWluUG9zaXRpb24pO1xuICAgICAgICBjb25zdCB7IGhhc01vcmVTcGFjZSwgaGFzRW5vdWdoU3BhY2UgfSA9IGdldERldGFpbGVkUG9zaXRpb25JbmZvKHtcbiAgICAgICAgICAgIHRhcmdldFJlY3QsXG4gICAgICAgICAgICBkaW1lbnNpb25zLFxuICAgICAgICAgICAgZmx5b3V0UmVjdCxcbiAgICAgICAgfSk7XG4gICAgICAgIGxldCBtYWluRGlyZWN0aW9uID0gbWFpblBvc2l0aW9uO1xuICAgICAgICBsZXQgbWFpbiA9IGdldE1haW5BeGlzRmx5b3V0UG9zaXRpb25BbmRTaXplKHtcbiAgICAgICAgICAgIGRpcmVjdGlvbjogbWFpbkRpcmVjdGlvbixcbiAgICAgICAgICAgIHRhcmdldFJlY3QsXG4gICAgICAgICAgICBvZmZzZXQsXG4gICAgICAgICAgICBkaW1lbnNpb25zLFxuICAgICAgICAgICAgdmVydGljYWwsXG4gICAgICAgICAgICBmbHlvdXRSZWN0LFxuICAgICAgICB9KTtcbiAgICAgICAgaWYgKCFwb3NpdGlvbiAmJiAhaGFzRW5vdWdoU3BhY2VbbWFpbkRpcmVjdGlvbl0gJiYgIWhhc01vcmVTcGFjZVttYWluRGlyZWN0aW9uXSkge1xuICAgICAgICAgICAgbWFpbkRpcmVjdGlvbiA9IGludmVydFBvc2l0aW9uKG1haW5EaXJlY3Rpb24pO1xuICAgICAgICAgICAgbWFpbiA9IGdldE1haW5BeGlzRmx5b3V0UG9zaXRpb25BbmRTaXplKHtcbiAgICAgICAgICAgICAgICBkaXJlY3Rpb246IG1haW5EaXJlY3Rpb24sXG4gICAgICAgICAgICAgICAgdGFyZ2V0UmVjdCxcbiAgICAgICAgICAgICAgICBvZmZzZXQsXG4gICAgICAgICAgICAgICAgZGltZW5zaW9ucyxcbiAgICAgICAgICAgICAgICB2ZXJ0aWNhbCxcbiAgICAgICAgICAgICAgICBmbHlvdXRSZWN0LFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICAgbGV0IHNlY29uZGFyeURpcmVjdGlvbiA9IHNlY29uZGFyeVBvc2l0aW9uO1xuICAgICAgICBsZXQgc2Vjb25kYXJ5ID0gZ2V0U2Vjb25kYXJ5QXhpc0ZseW91dFBvc2l0aW9uQW5kU2l6ZSh7XG4gICAgICAgICAgICBkaXJlY3Rpb246IHNlY29uZGFyeURpcmVjdGlvbixcbiAgICAgICAgICAgIHRhcmdldFJlY3QsXG4gICAgICAgICAgICBkaW1lbnNpb25zLFxuICAgICAgICAgICAgdmVydGljYWwsXG4gICAgICAgICAgICBmbHlvdXRSZWN0LFxuICAgICAgICB9KTtcbiAgICAgICAgaWYgKCFwb3NpdGlvbiAmJiBzZWNvbmRhcnlEaXJlY3Rpb24gJiYgIWhhc0Vub3VnaFNwYWNlW3NlY29uZGFyeURpcmVjdGlvbl0gJiYgaGFzTW9yZVNwYWNlW3NlY29uZGFyeURpcmVjdGlvbl0pIHtcbiAgICAgICAgICAgIHNlY29uZGFyeURpcmVjdGlvbiA9IGludmVydFBvc2l0aW9uKHNlY29uZGFyeURpcmVjdGlvbik7XG4gICAgICAgICAgICBzZWNvbmRhcnkgPSBnZXRTZWNvbmRhcnlBeGlzRmx5b3V0UG9zaXRpb25BbmRTaXplKHtcbiAgICAgICAgICAgICAgICBkaXJlY3Rpb246IHNlY29uZGFyeURpcmVjdGlvbixcbiAgICAgICAgICAgICAgICB0YXJnZXRSZWN0LFxuICAgICAgICAgICAgICAgIGRpbWVuc2lvbnMsXG4gICAgICAgICAgICAgICAgdmVydGljYWwsXG4gICAgICAgICAgICAgICAgZmx5b3V0UmVjdCxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBwb3NpdGlvbjoge1xuICAgICAgICAgICAgICAgIFttYWluLnBvc2l0aW9uLm5hbWVdOiBtYWluLnBvc2l0aW9uLnZhbHVlLFxuICAgICAgICAgICAgICAgIFtzZWNvbmRhcnkucG9zaXRpb24ubmFtZV06IHNlY29uZGFyeS5wb3NpdGlvbi52YWx1ZSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBzaXplOiB7XG4gICAgICAgICAgICAgICAgW21haW4uc2l6ZS5uYW1lXTogbWFpbi5zaXplLnZhbHVlLFxuICAgICAgICAgICAgICAgIFtzZWNvbmRhcnkuc2l6ZS5uYW1lXTogc2Vjb25kYXJ5LnNpemUudmFsdWUsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgYXJyb3dQb3NpdGlvbjogZ2V0Rmx5b3V0QXJyb3dQb3NpdGlvbih7XG4gICAgICAgICAgICAgICAgbWFpblBvc2l0aW9uOiBtYWluRGlyZWN0aW9uLFxuICAgICAgICAgICAgICAgIHNlY29uZGFyeVBvc2l0aW9uOiBzZWNvbmRhcnlEaXJlY3Rpb24sXG4gICAgICAgICAgICAgICAgb2Zmc2V0LFxuICAgICAgICAgICAgICAgIHRhcmdldFJlY3QsXG4gICAgICAgICAgICAgICAgZmx5b3V0UmVjdCxcbiAgICAgICAgICAgIH0pLFxuICAgICAgICB9O1xuICAgIH1cbiAgICByZW5kZXIoKSB7XG4gICAgICAgIGNvbnN0IHsgY2hpbGRyZW4sIHRhcmdldFJlY3Q6IF8wLCBwb3NpdGlvbjogXzEsIG9mZnNldDogXzIsIGRpbWVuc2lvbnM6IF8zLCBpbm5lclJlZjogXzQsIC4uLnByb3BzIH0gPSB0aGlzLnByb3BzO1xuICAgICAgICBjb25zdCB7IGFycm93UG9zaXRpb24sIC4uLmZseW91dERpbWVuc2lvbnMgfSA9IHRoaXMuZ2V0Rmx5b3V0RGltZW5zaW9ucygpO1xuICAgICAgICByZXR1cm4gKGNoaWxkcmVuICYmICg8PlxuICAgICAgICAgIDxTdHlsZWRGbHlvdXRBcnJvdyB7Li4uYXJyb3dQb3NpdGlvbn0gdGhlbWU9e3Byb3BzLnRoZW1lfS8+XG4gICAgICAgICAgPFN0eWxlZEZseW91dFdpbmRvdyB7Li4uZmx5b3V0RGltZW5zaW9uc30gey4uLnByb3BzfSByZWY9e3RoaXMuc2V0Rmx5b3V0UmVmfT5cbiAgICAgICAgICAgIHtjaGlsZHJlbn1cbiAgICAgICAgICA8L1N0eWxlZEZseW91dFdpbmRvdz5cbiAgICAgICAgPC8+KSk7XG4gICAgfVxuICAgIHN0YXRpYyBpbm5lciA9IHtcbiAgICAgICAgZ2V0IFN0eWxlZEZseW91dEFycm93KCkgeyByZXR1cm4gU3R5bGVkRmx5b3V0QXJyb3cgYXMgdHlwZW9mIFN0eWxlZEZseW91dEFycm93OyB9LFxuICAgICAgICBnZXQgU3R5bGVkRmx5b3V0V2luZG93KCkgeyByZXR1cm4gU3R5bGVkRmx5b3V0V2luZG93IGFzIHR5cGVvZiBTdHlsZWRGbHlvdXRXaW5kb3c7IH1cbiAgICB9O1xufVxuZXhwb3J0IGNvbnN0IEZseW91dFdpbmRvdyA9IHdpdGhSZXNwb25zaXZlKEZseW91dFdpbmRvd0ludCk7XG4iXX0=