var __rest = (this && this.__rest) || function (s, e) {
    var t = {};
    for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)
        t[p] = s[p];
    if (s != null && typeof Object.getOwnPropertySymbols === "function")
        for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) if (e.indexOf(p[i]) < 0)
            t[p[i]] = s[p[i]];
    return t;
};
import * as React from 'react';
import styled from '../../utils/styled';
import { Slider } from '../Slider';
import { IndicatorKnob } from '../IndicatorKnob';
import { InteractiveSurface } from '../InteractiveSurface';
import { rgbToHsv, hsvToRgb, parseColor } from '../../utils/colors';
import { withFormContext } from '../../hoc/withFormContext';
import { distance } from '../../distance';
import { PaddedContainer } from '../PaddedContainer';
import { InputNotification } from '../InputNotification';
function rgb(c) {
    return `rgb(${c.r}, ${c.g}, ${c.b})`;
}
function computeColor(color) {
    const fc = color;
    if (typeof color === 'string') {
        color = parseColor(color);
    }
    else if (typeof fc.h === 'number') {
        return {
            hsv: fc,
            color,
            base: hsvToRgb(fc.h, 1, 1),
        };
    }
    else {
        color = {
            r: color.r,
            g: color.g,
            b: color.b,
            a: color.a,
        };
    }
    const hsv = rgbToHsv(color.r, color.g, color.b, color.a);
    return {
        hsv,
        color,
        base: hsvToRgb(hsv.h, 1, 1),
    };
}
const PickerContainer = styled.div `
  margin: ${distance.small};
`;
const PickerSurface = styled(InteractiveSurface) `
  width: ${props => props.width};
  height: ${props => props.height};
  position: relative;
  background-color: ${props => props.color};
`;
const PickerSaturation = styled.div `
  position: absolute;
  left: 0;
  right: 0;
  top: 0;
  bottom: 0;
  background: linear-gradient(to bottom, transparent 0%, black 100%);
`;
const PickerValue = styled.div `
  position: absolute;
  left: 0;
  right: 0;
  top: 0;
  bottom: 0;
  background: linear-gradient(to right, white 0%, transparent 100%);
`;
const ColorSlider = styled(Slider) `
  margin: ${distance.large} 0 -${distance.xsmall} 0;
  background: linear-gradient(
    to left,
    red 0,
    #f09 10%,
    #cd00ff 20%,
    #3200ff 30%,
    #06f 40%,
    #00fffd 50%,
    #0f6 60%,
    #35ff00 70%,
    #cdff00 80%,
    #f90 90%,
    red 100%
  );
`;
const OpacitySlider = styled(Slider) `
  margin: ${distance.large} 0 -${distance.xsmall} 0;
  background: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAJUlEQVQYV2N89erVfwY0ICYmxoguxjgUFKI7GsTH5m4M3w1ChQC1/Ca8i2n1WgAAAABJRU5ErkJggg==');
  &:before {
    background: linear-gradient(to right, transparent 0px, rgba(0, 117, 120, 0.357) 100%);
    border-radius: 10px;
    position: absolute;
    left: 0;
    right: 0;
    top: 0;
    bottom: 0;
    content: '';
  }
`;
const ColorIndicator = styled(IndicatorKnob) `
  box-shadow: 0 0 20px -5px ${props => (props.disabled ? 'transparent' : '#000')};
  border: 2px solid ${props => (props.disabled ? '#ccc' : props.active ? '#eee' : '#fff')};
`;
class ColorPickerInt extends React.PureComponent {
    constructor(props) {
        super(props);
        this.changeColor = (e) => {
            const s = e.x;
            const v = 1 - e.y;
            const notify = this.props.onChange;
            const current = this.state.value;
            const rgb = hsvToRgb(current.h, s, v, current.a);
            const selected = Object.assign({}, current, { s: s, v: v }, rgb);
            if (!this.state.controlled) {
                this.changeTo({
                    value: selected,
                });
            }
            this.setState({
                active: e.active,
            });
            if (typeof notify === 'function') {
                notify({
                    value: selected,
                });
            }
        };
        this.changeBackground = (e) => {
            const h = e.value;
            const notify = this.props.onChange;
            const current = this.state.value;
            const rgb = hsvToRgb(h, current.s, current.v, current.a);
            const selected = Object.assign({}, current, { h, s: current.s, v: current.v }, rgb);
            if (!this.state.controlled) {
                const base = hsvToRgb(h, 1, 1);
                this.changeTo({
                    base,
                    value: selected,
                });
            }
            if (typeof notify === 'function') {
                notify({
                    value: selected,
                });
            }
        };
        this.changeOpacity = (e) => {
            const alpha = e.value;
            const notify = this.props.onChange;
            const current = this.state.value;
            const selected = Object.assign({}, current, { a: alpha });
            if (!this.state.controlled) {
                this.changeTo({
                    value: selected,
                });
            }
            if (typeof notify === 'function') {
                notify({
                    value: selected,
                });
            }
        };
        const { hsv, color, base } = computeColor(props.value || props.defaultValue || { r: 0, g: 0, b: 0 });
        this.state = {
            controlled: props.value !== undefined,
            active: false,
            value: Object.assign({ a: 1 }, color, { h: hsv.h, s: hsv.s, v: hsv.v }),
            base,
            error: props.error,
        };
    }
    UNSAFE_componentWillReceiveProps({ value, error }) {
        if (value && value !== this.state.value) {
            const { hsv, color, base } = computeColor(value || this.state.value);
            this.setState({
                value: Object.assign({ a: 1 }, color, { h: hsv.h, s: hsv.s, v: hsv.v }),
                base,
            });
        }
        this.setState({ error });
    }
    componentDidMount() {
        const { form } = this.props;
        const { controlled } = this.state;
        if (!controlled && form) {
            form.subscribe(this);
        }
    }
    componentWillUnmount() {
        const { form } = this.props;
        const { controlled } = this.state;
        if (!controlled && form) {
            form.unsubscribe(this);
        }
    }
    changeTo(state) {
        const { form, name = '' } = this.props;
        if (form) {
            form.change({
                name,
                value: state.value,
            });
        }
        else {
            this.setState(state);
        }
    }
    render() {
        const { value, active, base, error } = this.state;
        const _a = this.props, { defaultValue: _0, value: _1, onChange: _2, onInput: _3, allowOpacity, hideBar, width = '100%', height = '200px', info } = _a, props = __rest(_a, ["defaultValue", "value", "onChange", "onInput", "allowOpacity", "hideBar", "width", "height", "info"]);
        const baseRgb = rgb(base);
        const currentRgb = rgb(value);
        const surface = {
            color: baseRgb,
            width,
            height,
        };
        return (React.createElement(PickerContainer, Object.assign({}, props),
            React.createElement(PickerSurface, Object.assign({}, surface, { onChange: this.changeColor }),
                React.createElement(PickerValue, null),
                React.createElement(PickerSaturation, null),
                React.createElement(ColorIndicator, { x: value.s, y: 1 - value.v, color: currentRgb, active: active })),
            !hideBar && React.createElement(ColorSlider, { onChange: this.changeBackground, value: value.h, color: baseRgb }),
            allowOpacity && React.createElement(OpacitySlider, { onChange: this.changeOpacity, value: value.a }),
            (error || info) && (React.createElement(PaddedContainer, { top: "small", bottom: "xsmall" },
                React.createElement(InputNotification, { error: error, info: info })))));
    }
}
ColorPickerInt.inner = {
    get PickerContainer() { return PickerContainer; },
    get PickerSurface() { return PickerSurface; },
    get PickerValue() { return PickerValue; },
    get PickerSaturation() { return PickerSaturation; },
    get ColorIndicator() { return ColorIndicator; },
    get ColorSlider() { return ColorSlider; },
    get OpacitySlider() { return OpacitySlider; },
    get PaddedContainer() { return PaddedContainer; },
    get InputNotification() { return InputNotification; }
};
/**
 * A color picker for selecting a color in the UI.
 */
export const ColorPicker = withFormContext(ColorPickerInt);
ColorPicker.displayName = 'ColorPicker';
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvY29tcG9uZW50cy9Db2xvclBpY2tlci9pbmRleC50c3giXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBQUEsT0FBTyxLQUFLLEtBQUssTUFBTSxPQUFPLENBQUM7QUFDL0IsT0FBTyxNQUFNLE1BQU0sb0JBQW9CLENBQUM7QUFFeEMsT0FBTyxFQUFFLE1BQU0sRUFBcUIsTUFBTSxXQUFXLENBQUM7QUFDdEQsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQ2pELE9BQU8sRUFBRSxrQkFBa0IsRUFBaUMsTUFBTSx1QkFBdUIsQ0FBQztBQUMxRixPQUFPLEVBQUUsUUFBUSxFQUFFLFFBQVEsRUFBRSxVQUFVLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUNwRSxPQUFPLEVBQUUsZUFBZSxFQUFvQixNQUFNLDJCQUEyQixDQUFDO0FBRTlFLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUMxQyxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDckQsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFtRXpELFNBQVMsR0FBRyxDQUFDLENBQVk7SUFDckIsT0FBTyxPQUFPLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUM7QUFDekMsQ0FBQztBQUNELFNBQVMsWUFBWSxDQUFDLEtBQXFDO0lBQ3ZELE1BQU0sRUFBRSxHQUFHLEtBQWtCLENBQUM7SUFDOUIsSUFBSSxPQUFPLEtBQUssS0FBSyxRQUFRLEVBQUU7UUFDM0IsS0FBSyxHQUFHLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQztLQUM3QjtTQUNJLElBQUksT0FBTyxFQUFFLENBQUMsQ0FBQyxLQUFLLFFBQVEsRUFBRTtRQUMvQixPQUFPO1lBQ0gs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QUFLLE9BQU8sY0FBdUMsQ0FBQyxDQUFDLENBQUM7SUFDeEUsSUFBSSxXQUFXLEtBQUssT0FBTyxXQUFpQyxDQUFDLENBQUMsQ0FBQztJQUMvRCxJQUFJLGFBQWEsS0FBSyxPQUFPLGFBQXFDLENBQUMsQ0FBQyxDQUFDO0lBQ3JFLElBQUksZUFBZSxLQUFLLE9BQU8sZUFBeUMsQ0FBQyxDQUFDLENBQUM7SUFDM0UsSUFBSSxpQkFBaUIsS0FBSyxPQUFPLGlCQUE2QyxDQUFDLENBQUMsQ0FBQztDQUNwRixDQUFDO0FBRU47O0dBRUc7QUFDSCxNQUFNLENBQUMsTUFBTSxXQUFXLEdBQUcsZUFBZSxDQUFDLGNBQWMsQ0FBQyxDQUFDO0FBQzNELFdBQVcsQ0FBQyxXQUFXLEdBQUcsYUFBYSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgUmVhY3QgZnJvbSAncmVhY3QnO1xuaW1wb3J0IHN0eWxlZCBmcm9tICcuLi8uLi91dGlscy9zdHlsZWQnO1xuaW1wb3J0IHsgSW5wdXRQcm9wcyB9IGZyb20gJy4uLy4uL2NvbW1vbic7XG5pbXBvcnQgeyBTbGlkZXIsIFNsaWRlckNoYW5nZUV2ZW50IH0gZnJvbSAnLi4vU2xpZGVyJztcbmltcG9ydCB7IEluZGljYXRvcktub2IgfSBmcm9tICcuLi9JbmRpY2F0b3JLbm9iJztcbmltcG9ydCB7IEludGVyYWN0aXZlU3VyZmFjZSwgSW50ZXJhY3RpdmVTdXJmYWNlQ2hhbmdlRXZlbnQgfSBmcm9tICcuLi9JbnRlcmFjdGl2ZVN1cmZhY2UnO1xuaW1wb3J0IHsgcmdiVG9Ic3YsIGhzdlRvUmdiLCBwYXJzZUNvbG9yIH0gZnJvbSAnLi4vLi4vdXRpbHMvY29sb3JzJztcbmltcG9ydCB7IHdpdGhGb3JtQ29udGV4dCwgRm9ybUNvbnRleHRQcm9wcyB9IGZyb20gJy4uLy4uL2hvYy93aXRoRm9ybUNvbnRleHQnO1xuaW1wb3J0IHsgc2hvd0lucHV0SW5mbyB9IGZyb20gJy4uLy4uL3V0aWxzL2lucHV0JztcbmltcG9ydCB7IGRpc3RhbmNlIH0gZnJvbSAnLi4vLi4vZGlzdGFuY2UnO1xuaW1wb3J0IHsgUGFkZGVkQ29udGFpbmVyIH0gZnJvbSAnLi4vUGFkZGVkQ29udGFpbmVyJztcbmltcG9ydCB7IElucHV0Tm90aWZpY2F0aW9uIH0gZnJvbSAnLi4vSW5wdXROb3RpZmljYXRpb24nO1xuZXhwb3J0IGludGVyZmFjZSBDb2xvckNoYW5nZUV2ZW50IHtcbiAgICAvKipcbiAgICAgKiBHZXRzIHRoZSBzZWxlY3RlZCBjb2xvci5cbiAgICAgKi9cbiAgICB2YWx1ZTogRnVsbENvbG9yO1xufVxuZXhwb3J0IGludGVyZmFjZSBGdWxsQ29sb3Ige1xuICAgIGg6IG51bWJlcjtcbiAgICBzOiBudW1iZXI7XG4gICAgdjogbnVtYmVyO1xuICAgIHI6IG51bWJlcjtcbiAgICBnOiBudW1iZXI7XG4gICAgYjogbnVtYmVyO1xuICAgIGE6IG51bWJlcjtcbn1cbmV4cG9ydCBpbnRlcmZhY2UgUmdiYUNvbG9yIHtcbiAgICAvKipcbiAgICAgKiBUaGUgcmVkIHBhcnQgb2YgdGhlIGNvbG9yLlxuICAgICAqL1xuICAgIHI6IG51bWJlcjtcbiAgICAvKipcbiAgICAgKiBUaGUgZ3JlZW4gcGFydCBvZiB0aGUgY29sb3IuXG4gICAgICovXG4gICAgZzogbnVtYmVyO1xuICAgIC8qKlxuICAgICAqIFRoZSBibHVlIHBhcnQgb2YgdGhlIGNvbG9yLlxuICAgICAqL1xuICAgIGI6IG51bWJlcjtcbiAgICAvKipcbiAgICAgKiBUaGUgb3B0aW9uYWwgYWxwaGEgcGFydCBvZiB0aGUgY29sb3IgLSBieSBkZWZhdWx0IDEuXG4gICAgICovXG4gICAgYT86IG51bWJlcjtcbn1cbmV4cG9ydCBpbnRlcmZhY2UgQ29sb3JQaWNrZXJQcm9wcyBleHRlbmRzIElucHV0UHJvcHM8RnVsbENvbG9yIHwgUmdiYUNvbG9yIHwgc3RyaW5nPiB7XG4gICAgLyoqXG4gICAgICogU2V0cyBpZiB0aGUgY29sb3Igd2hlZWwgYmFyIHNob3VsZCBiZSBoaWRkZW4uXG4gICAgICovXG4gICAgaGlkZUJhcj86IGJvb2xlYW47XG4gICAgLyoqXG4gICAgICogU2V0cyBpZiB0aGUgdHJhbnNwYXJlbmN5IGNhbiBiZSBjaGFuZ2VkLlxuICAgICAqL1xuICAgIGFsbG93T3BhY2l0eT86IGJvb2xlYW47XG4gICAgLyoqXG4gICAgICogRW1pdHRlZCBvbmNlIGNvbG9yIGNoYW5nZWQuXG4gICAgICovXG4gICAgb25DaGFuZ2U/KGU6IENvbG9yQ2hhbmdlRXZlbnQpOiB2b2lkO1xuICAgIC8qKlxuICAgICAqIFNldHMgdGhlIGhlaWdodCBvZiB0aGUgcGlja2VyIGFyZWEsIHVzdWFsbHkgMjAwcHguXG4gICAgICovXG4gICAgaGVpZ2h0Pzogc3RyaW5nO1xuICAgIC8qKlxuICAgICAqIFNldHMgdGhlIHdpZHRoIG9mIHRoZSBwaWNrZXIgYXJlYSwgdXN1YWxseSAxMDAlLlxuICAgICAqL1xuICAgIHdpZHRoPzogc3RyaW5nO1xuICAgIC8qKlxuICAgICAqIEBpZ25vcmVcbiAgICAgKi9cbiAgICBjaGlsZHJlbj86IHZvaWQ7XG59XG5leHBvcnQgaW50ZXJmYWNlIENvbG9yUGlja2VyU3RhdGUge1xuICAgIGNvbnRyb2xsZWQ6IGJvb2xlYW47XG4gICAgdmFsdWU6IEZ1bGxDb2xvcjtcbiAgICBlcnJvcj86IFJlYWN0LlJlYWN0Q2hpbGQ7XG4gICAgYmFzZTogUmdiYUNvbG9yO1xuICAgIGFjdGl2ZTogYm9vbGVhbjtcbn1cbmZ1bmN0aW9uIHJnYihjOiBSZ2JhQ29sb3IpIHtcbiAgICByZXR1cm4gYHJnYigke2Mucn0sICR7Yy5nfSwgJHtjLmJ9KWA7XG59XG5mdW5jdGlvbiBjb21wdXRlQ29sb3IoY29sb3I6IEZ1bGxDb2xvciB8IFJnYmFDb2xvciB8IHN0cmluZykge1xuICAgIGNvbnN0IGZjID0gY29sb3IgYXMgRnVsbENvbG9yO1xuICAgIGlmICh0eXBlb2YgY29sb3IgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgIGNvbG9yID0gcGFyc2VDb2xvcihjb2xvcik7XG4gICAgfVxuICAgIGVsc2UgaWYgKHR5cGVvZiBmYy5oID09PSAnbnVtYmVyJykge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgaHN2OiBmYyxcbiAgICAgICAgICAgIGNvbG9yLFxuICAgICAgICAgICAgYmFzZTogaHN2VG9SZ2IoZmMuaCwgMSwgMSksXG4gICAgICAgIH07XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgICBjb2xvciA9IHtcbiAgICAgICAgICAgIHI6IGNvbG9yLnIsXG4gICAgICAgICAgICBnOiBjb2xvci5nLFxuICAgICAgICAgICAgYjogY29sb3IuYixcbiAgICAgICAgICAgIGE6IGNvbG9yLmEsXG4gICAgICAgIH07XG4gICAgfVxuICAgIGNvbnN0IGhzdiA9IHJnYlRvSHN2KGNvbG9yLnIsIGNvbG9yLmcsIGNvbG9yLmIsIGNvbG9yLmEpO1xuICAgIHJldHVybiB7XG4gICAgICAgIGhzdixcbiAgICAgICAgY29sb3IsXG4gICAgICAgIGJhc2U6IGhzdlRvUmdiKGhzdi5oLCAxLCAxKSxcbiAgICB9O1xufVxuY29uc3QgUGlja2VyQ29udGFpbmVyID0gc3R5bGVkLmRpdiBgXG4gIG1hcmdpbjogJHtkaXN0YW5jZS5zbWFsbH07XG5gO1xuaW50ZXJmYWNlIFBpY2tlclN1cmZhY2VQcm9wcyB7XG4gICAgY29sb3I6IHN0cmluZztcbiAgICB3aWR0aDogc3RyaW5nO1xuICAgIGhlaWdodDogc3RyaW5nO1xufVxuY29uc3QgUGlja2VyU3VyZmFjZSA9IHN0eWxlZChJbnRlcmFjdGl2ZVN1cmZhY2UpPFBpY2tlclN1cmZhY2VQcm9wcz4gYFxuICB3aWR0aDogJHtwcm9wcyA9PiBwcm9wcy53aWR0aH07XG4gIGhlaWdodDogJHtwcm9wcyA9PiBwcm9wcy5oZWlnaHR9O1xuICBwb3NpdGlvbjogcmVsYXRpdmU7XG4gIGJhY2tncm91bmQtY29sb3I6ICR7cHJvcHMgPT4gcHJvcHMuY29sb3J9O1xuYDtcbmNvbnN0IFBpY2tlclNhdHVyYXRpb24gPSBzdHlsZWQuZGl2IGBcbiAgcG9zaXRpb246IGFic29sdXRlO1xuICBsZWZ0OiAwO1xuICByaWdodDogMDtcbiAgdG9wOiAwO1xuICBib3R0b206IDA7XG4gIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCh0byBib3R0b20sIHRyYW5zcGFyZW50IDAlLCBibGFjayAxMDAlKTtcbmA7XG5jb25zdCBQaWNrZXJWYWx1ZSA9IHN0eWxlZC5kaXYgYFxuICBwb3NpdGlvbjogYWJzb2x1dGU7XG4gIGxlZnQ6IDA7XG4gIHJpZ2h0OiAwO1xuICB0b3A6IDA7XG4gIGJvdHRvbTogMDtcbiAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KHRvIHJpZ2h0LCB3aGl0ZSAwJSwgdHJhbnNwYXJlbnQgMTAwJSk7XG5gO1xuY29uc3QgQ29sb3JTbGlkZXIgPSBzdHlsZWQoU2xpZGVyKSBgXG4gIG1hcmdpbjogJHtkaXN0YW5jZS5sYXJnZX0gMCAtJHtkaXN0YW5jZS54c21hbGx9IDA7XG4gIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudChcbiAgICB0byBsZWZ0LFxuICAgIHJlZCAwLFxuICAgICNmMDkgMTAlLFxuICAgICNjZDAwZmYgMjAlLFxuICAgICMzMjAwZmYgMzAlLFxuICAgICMwNmYgNDAlLFxuICAgICMwMGZmZmQgNTAlLFxuICAgICMwZjYgNjAlLFxuICAgICMzNWZmMDAgNzAlLFxuICAgICNjZGZmMDAgODAlLFxuICAgICNmOTAgOTAlLFxuICAgIHJlZCAxMDAlXG4gICk7XG5gO1xuY29uc3QgT3BhY2l0eVNsaWRlciA9IHN0eWxlZChTbGlkZXIpIGBcbiAgbWFyZ2luOiAke2Rpc3RhbmNlLmxhcmdlfSAwIC0ke2Rpc3RhbmNlLnhzbWFsbH0gMDtcbiAgYmFja2dyb3VuZDogdXJsKCdkYXRhOmltYWdlL3BuZztiYXNlNjQsaVZCT1J3MEtHZ29BQUFBTlNVaEVVZ0FBQUFvQUFBQUtDQVlBQUFDTk1zKzlBQUFBSlVsRVFWUVlWMk44OWVyVmZ3WTBJQ1lteG9ndXhqZ1VGS0k3R3NUSDVtNE0zdzFDaFFDMS9DYThpMm4xV2dBQUFBQkpSVTVFcmtKZ2dnPT0nKTtcbiAgJjpiZWZvcmUge1xuICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCh0byByaWdodCwgdHJhbnNwYXJlbnQgMHB4LCByZ2JhKDAsIDExNywgMTIwLCAwLjM1NykgMTAwJSk7XG4gICAgYm9yZGVyLXJhZGl1czogMTBweDtcbiAgICBwb3NpdGlvbjogYWJzb2x1dGU7XG4gICAgbGVmdDogMDtcbiAgICByaWdodDogMDtcbiAgICB0b3A6IDA7XG4gICAgYm90dG9tOiAwO1xuICAgIGNvbnRlbnQ6ICcnO1xuICB9XG5gO1xuaW50ZXJmYWNlIENvbG9ySW5kaWNhdG9yUHJvcHMge1xuICAgIGRpc2FibGVkPzogYm9vbGVhbjtcbiAgICBhY3RpdmU6IGJvb2xlYW47XG59XG5jb25zdCBDb2xvckluZGljYXRvciA9IHN0eWxlZChJbmRpY2F0b3JLbm9iKTxDb2xvckluZGljYXRvclByb3BzPiBgXG4gIGJveC1zaGFkb3c6IDAgMCAyMHB4IC01cHggJHtwcm9wcyA9PiAocHJvcHMuZGlzYWJsZWQgPyAndHJhbnNwYXJlbnQnIDogJyMwMDAnKX07XG4gIGJvcmRlcjogMnB4IHNvbGlkICR7cHJvcHMgPT4gKHByb3BzLmRpc2FibGVkID8gJyNjY2MnIDogcHJvcHMuYWN0aXZlID8gJyNlZWUnIDogJyNmZmYnKX07XG5gO1xuY2xhc3MgQ29sb3JQaWNrZXJJbnQgZXh0ZW5kcyBSZWFjdC5QdXJlQ29tcG9uZW50PENvbG9yUGlja2VyUHJvcHMgJiBGb3JtQ29udGV4dFByb3BzLCBDb2xvclBpY2tlclN0YXRlPiB7XG4gICAgY29uc3RydWN0b3IocHJvcHM6IENvbG9yUGlja2VyUHJvcHMpIHtcbiAgICAgICAgc3VwZXIocHJvcHMpO1xuICAgICAgICBjb25zdCB7IGhzdiwgY29sb3IsIGJhc2UgfSA9IGNvbXB1dGVDb2xvcihwcm9wcy52YWx1ZSB8fCBwcm9wcy5kZWZhdWx0VmFsdWUgfHwgeyByOiAwLCBnOiAwLCBiOiAwIH0pO1xuICAgICAgICB0aGlzLnN0YXRlID0ge1xuICAgICAgICAgICAgY29udHJvbGxlZDogcHJvcHMudmFsdWUgIT09IHVuZGVmaW5lZCxcbiAgICAgICAgICAgIGFjdGl2ZTogZmFsc2UsXG4gICAgICAgICAgICB2YWx1ZToge1xuICAgICAgICAgICAgICAgIGE6IDEsXG4gICAgICAgICAgICAgICAgLi4uY29sb3IsXG4gICAgICAgICAgICAgICAgaDogaHN2LmgsXG4gICAgICAgICAgICAgICAgczogaHN2LnMsXG4gICAgICAgICAgICAgICAgdjogaHN2LnYsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgYmFzZSxcbiAgICAgICAgICAgIGVycm9yOiBwcm9wcy5lcnJvcixcbiAgICAgICAgfTtcbiAgICB9XG4gICAgVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMoeyB2YWx1ZSwgZXJyb3IgfTogQ29sb3JQaWNrZXJQcm9wcykge1xuICAgICAgICBpZiAodmFsdWUgJiYgdmFsdWUgIT09IHRoaXMuc3RhdGUudmFsdWUpIHtcbiAgICAgICAgICAgIGNvbnN0IHsgaHN2LCBjb2xvciwgYmFzZSB9ID0gY29tcHV0ZUNvbG9yKHZhbHVlIHx8IHRoaXMuc3RhdGUudmFsdWUpO1xuICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICAgICAgdmFsdWU6IHtcbiAgICAgICAgICAgICAgICAgICAgYTogMSxcbiAgICAgICAgICAgICAgICAgICAgLi4uY29sb3IsXG4gICAgICAgICAgICAgICAgICAgIGg6IGhzdi5oLFxuICAgICAgICAgICAgICAgICAgICBzOiBoc3YucyxcbiAgICAgICAgICAgICAgICAgICAgdjogaHN2LnYsXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBiYXNlLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7IGVycm9yIH0pO1xuICAgIH1cbiAgICBjb21wb25lbnREaWRNb3VudCgpIHtcbiAgICAgICAgY29uc3QgeyBmb3JtIH0gPSB0aGlzLnByb3BzO1xuICAgICAgICBjb25zdCB7IGNvbnRyb2xsZWQgfSA9IHRoaXMuc3RhdGU7XG4gICAgICAgIGlmICghY29udHJvbGxlZCAmJiBmb3JtKSB7XG4gICAgICAgICAgICBmb3JtLnN1YnNjcmliZSh0aGlzKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBjb21wb25lbnRXaWxsVW5tb3VudCgpIHtcbiAgICAgICAgY29uc3QgeyBmb3JtIH0gPSB0aGlzLnByb3BzO1xuICAgICAgICBjb25zdCB7IGNvbnRyb2xsZWQgfSA9IHRoaXMuc3RhdGU7XG4gICAgICAgIGlmICghY29udHJvbGxlZCAmJiBmb3JtKSB7XG4gICAgICAgICAgICBmb3JtLnVuc3Vic2NyaWJlKHRoaXMpO1xuICAgICAgICB9XG4gICAgfVxuICAgIHByaXZhdGUgY2hhbmdlVG88SyBleHRlbmRzIGtleW9mIENvbG9yUGlja2VyU3RhdGU+KHN0YXRlOiBQaWNrPENvbG9yUGlja2VyU3RhdGUsIEs+KSB7XG4gICAgICAgIGNvbnN0IHsgZm9ybSwgbmFtZSA9ICcnIH0gPSB0aGlzLnByb3BzO1xuICAgICAgICBpZiAoZm9ybSkge1xuICAgICAgICAgICAgZm9ybS5jaGFuZ2Uoe1xuICAgICAgICAgICAgICAgIG5hbWUsXG4gICAgICAgICAgICAgICAgdmFsdWU6IChzdGF0ZSBhcyBQaWNrPENvbG9yUGlja2VyU3RhdGUsICd2YWx1ZSc+KS52YWx1ZSxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZShzdGF0ZSk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcHJpdmF0ZSBjaGFuZ2VDb2xvciA9IChlOiBJbnRlcmFjdGl2ZVN1cmZhY2VDaGFuZ2VFdmVudCkgPT4ge1xuICAgICAgICBjb25zdCBzID0gZS54O1xuICAgICAgICBjb25zdCB2ID0gMSAtIGUueTtcbiAgICAgICAgY29uc3Qgbm90aWZ5ID0gdGhpcy5wcm9wcy5vbkNoYW5nZTtcbiAgICAgICAgY29uc3QgY3VycmVudCA9IHRoaXMuc3RhdGUudmFsdWU7XG4gICAgICAgIGNvbnN0IHJnYiA9IGhzdlRvUmdiKGN1cnJlbnQuaCwgcywgdiwgY3VycmVudC5hKTtcbiAgICAgICAgY29uc3Qgc2VsZWN0ZWQgPSB7XG4gICAgICAgICAgICAuLi5jdXJyZW50LFxuICAgICAgICAgICAgczogcyxcbiAgICAgICAgICAgIHY6IHYsXG4gICAgICAgICAgICAuLi5yZ2IsXG4gICAgICAgIH07XG4gICAgICAgIGlmICghdGhpcy5zdGF0ZS5jb250cm9sbGVkKSB7XG4gICAgICAgICAgICB0aGlzLmNoYW5nZVRvKHtcbiAgICAgICAgICAgICAgICB2YWx1ZTogc2VsZWN0ZWQsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICAgIGFjdGl2ZTogZS5hY3RpdmUsXG4gICAgICAgIH0pO1xuICAgICAgICBpZiAodHlwZW9mIG5vdGlmeSA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgICAgbm90aWZ5KHtcbiAgICAgICAgICAgICAgICB2YWx1ZTogc2VsZWN0ZWQsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH07XG4gICAgcHJpdmF0ZSBjaGFuZ2VCYWNrZ3JvdW5kID0gKGU6IFNsaWRlckNoYW5nZUV2ZW50KSA9PiB7XG4gICAgICAgIGNvbnN0IGggPSBlLnZhbHVlO1xuICAgICAgICBjb25zdCBub3RpZnkgPSB0aGlzLnByb3BzLm9uQ2hhbmdlO1xuICAgICAgICBjb25zdCBjdXJyZW50ID0gdGhpcy5zdGF0ZS52YWx1ZTtcbiAgICAgICAgY29uc3QgcmdiID0gaHN2VG9SZ2IoaCwgY3VycmVudC5zLCBjdXJyZW50LnYsIGN1cnJlbnQuYSk7XG4gICAgICAgIGNvbnN0IHNlbGVjdGVkID0ge1xuICAgICAgICAgICAgLi4uY3VycmVudCxcbiAgICAgICAgICAgIGgsXG4gICAgICAgICAgICBzOiBjdXJyZW50LnMsXG4gICAgICAgICAgICB2OiBjdXJyZW50LnYsXG4gICAgICAgICAgICAuLi5yZ2IsXG4gICAgICAgIH07XG4gICAgICAgIGlmICghdGhpcy5zdGF0ZS5jb250cm9sbGVkKSB7XG4gICAgICAgICAgICBjb25zdCBiYXNlID0gaHN2VG9SZ2IoaCwgMSwgMSk7XG4gICAgICAgICAgICB0aGlzLmNoYW5nZVRvKHtcbiAgICAgICAgICAgICAgICBiYXNlLFxuICAgICAgICAgICAgICAgIHZhbHVlOiBzZWxlY3RlZCxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0eXBlb2Ygbm90aWZ5ID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICBub3RpZnkoe1xuICAgICAgICAgICAgICAgIHZhbHVlOiBzZWxlY3RlZCxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfTtcbiAgICBwcml2YXRlIGNoYW5nZU9wYWNpdHkgPSAoZTogU2xpZGVyQ2hhbmdlRXZlbnQpID0+IHtcbiAgICAgICAgY29uc3QgYWxwaGEgPSBlLnZhbHVlO1xuICAgICAgICBjb25zdCBub3RpZnkgPSB0aGlzLnByb3BzLm9uQ2hhbmdlO1xuICAgICAgICBjb25zdCBjdXJyZW50ID0gdGhpcy5zdGF0ZS52YWx1ZTtcbiAgICAgICAgY29uc3Qgc2VsZWN0ZWQgPSB7XG4gICAgICAgICAgICAuLi5jdXJyZW50LFxuICAgICAgICAgICAgYTogYWxwaGEsXG4gICAgICAgIH07XG4gICAgICAgIGlmICghdGhpcy5zdGF0ZS5jb250cm9sbGVkKSB7XG4gICAgICAgICAgICB0aGlzLmNoYW5nZVRvKHtcbiAgICAgICAgICAgICAgICB2YWx1ZTogc2VsZWN0ZWQsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodHlwZW9mIG5vdGlmeSA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgICAgbm90aWZ5KHtcbiAgICAgICAgICAgICAgICB2YWx1ZTogc2VsZWN0ZWQsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH07XG4gICAgcmVuZGVyKCkge1xuICAgICAgICBjb25zdCB7IHZhbHVlLCBhY3RpdmUsIGJhc2UsIGVycm9yIH0gPSB0aGlzLnN0YXRlO1xuICAgICAgICBjb25zdCB7IGRlZmF1bHRWYWx1ZTogXzAsIHZhbHVlOiBfMSwgb25DaGFuZ2U6IF8yLCBvbklucHV0OiBfMywgYWxsb3dPcGFjaXR5LCBoaWRlQmFyLCB3aWR0aCA9ICcxMDAlJywgaGVpZ2h0ID0gJzIwMHB4JywgaW5mbywgLi4ucHJvcHMgfSA9IHRoaXMucHJvcHM7XG4gICAgICAgIGNvbnN0IGJhc2VSZ2IgPSByZ2IoYmFzZSk7XG4gICAgICAgIGNvbnN0IGN1cnJlbnRSZ2IgPSByZ2IodmFsdWUpO1xuICAgICAgICBjb25zdCBzdXJmYWNlID0ge1xuICAgICAgICAgICAgY29sb3I6IGJhc2VSZ2IsXG4gICAgICAgICAgICB3aWR0aCxcbiAgICAgICAgICAgIGhlaWdodCxcbiAgICAgICAgfTtcbiAgICAgICAgcmV0dXJuICg8UGlja2VyQ29udGFpbmVyIHsuLi5wcm9wc30+XG4gICAgICAgIDxQaWNrZXJTdXJmYWNlIHsuLi5zdXJmYWNlfSBvbkNoYW5nZT17dGhpcy5jaGFuZ2VDb2xvcn0+XG4gICAgICAgICAgPFBpY2tlclZhbHVlIC8+XG4gICAgICAgICAgPFBpY2tlclNhdHVyYXRpb24gLz5cbiAgICAgICAgICA8Q29sb3JJbmRpY2F0b3IgeD17dmFsdWUuc30geT17MSAtIHZhbHVlLnZ9IGNvbG9yPXtjdXJyZW50UmdifSBhY3RpdmU9e2FjdGl2ZX0vPlxuICAgICAgICA8L1BpY2tlclN1cmZhY2U+XG4gICAgICAgIHshaGlkZUJhciAmJiA8Q29sb3JTbGlkZXIgb25DaGFuZ2U9e3RoaXMuY2hhbmdlQmFja2dyb3VuZH0gdmFsdWU9e3ZhbHVlLmh9IGNvbG9yPXtiYXNlUmdifS8+fVxuICAgICAgICB7YWxsb3dPcGFjaXR5ICYmIDxPcGFjaXR5U2xpZGVyIG9uQ2hhbmdlPXt0aGlzLmNoYW5nZU9wYWNpdHl9IHZhbHVlPXt2YWx1ZS5hfS8+fVxuICAgICAgICB7KGVycm9yIHx8IGluZm8pICYmICg8UGFkZGVkQ29udGFpbmVyIHRvcD1cInNtYWxsXCIgYm90dG9tPVwieHNtYWxsXCI+XG4gICAgICAgICAgICA8SW5wdXROb3RpZmljYXRpb24gZXJyb3I9e2Vycm9yfSBpbmZvPXtpbmZvfS8+XG4gICAgICAgICAgPC9QYWRkZWRDb250YWluZXI+KX1cbiAgICAgIDwvUGlja2VyQ29udGFpbmVyPik7XG4gICAgfVxuICAgIHN0YXRpYyBpbm5lciA9IHtcbiAgICAgICAgZ2V0IFBpY2tlckNvbnRhaW5lcigpIHsgcmV0dXJuIFBpY2tlckNvbnRhaW5lciBhcyB0eXBlb2YgUGlja2VyQ29udGFpbmVyOyB9LFxuICAgICAgICBnZXQgUGlja2VyU3VyZmFjZSgpIHsgcmV0dXJuIFBpY2tlclN1cmZhY2UgYXMgdHlwZW9mIFBpY2tlclN1cmZhY2U7IH0sXG4gICAgICAgIGdldCBQaWNrZXJWYWx1ZSgpIHsgcmV0dXJuIFBpY2tlclZhbHVlIGFzIHR5cGVvZiBQaWNrZXJWYWx1ZTsgfSxcbiAgICAgICAgZ2V0IFBpY2tlclNhdHVyYXRpb24oKSB7IHJldHVybiBQaWNrZXJTYXR1cmF0aW9uIGFzIHR5cGVvZiBQaWNrZXJTYXR1cmF0aW9uOyB9LFxuICAgICAgICBnZXQgQ29sb3JJbmRpY2F0b3IoKSB7IHJldHVybiBDb2xvckluZGljYXRvciBhcyB0eXBlb2YgQ29sb3JJbmRpY2F0b3I7IH0sXG4gICAgICAgIGdldCBDb2xvclNsaWRlcigpIHsgcmV0dXJuIENvbG9yU2xpZGVyIGFzIHR5cGVvZiBDb2xvclNsaWRlcjsgfSxcbiAgICAgICAgZ2V0IE9wYWNpdHlTbGlkZXIoKSB7IHJldHVybiBPcGFjaXR5U2xpZGVyIGFzIHR5cGVvZiBPcGFjaXR5U2xpZGVyOyB9LFxuICAgICAgICBnZXQgUGFkZGVkQ29udGFpbmVyKCkgeyByZXR1cm4gUGFkZGVkQ29udGFpbmVyIGFzIHR5cGVvZiBQYWRkZWRDb250YWluZXI7IH0sXG4gICAgICAgIGdldCBJbnB1dE5vdGlmaWNhdGlvbigpIHsgcmV0dXJuIElucHV0Tm90aWZpY2F0aW9uIGFzIHR5cGVvZiBJbnB1dE5vdGlmaWNhdGlvbjsgfVxuICAgIH07XG59XG4vKipcbiAqIEEgY29sb3IgcGlja2VyIGZvciBzZWxlY3RpbmcgYSBjb2xvciBpbiB0aGUgVUkuXG4gKi9cbmV4cG9ydCBjb25zdCBDb2xvclBpY2tlciA9IHdpdGhGb3JtQ29udGV4dChDb2xvclBpY2tlckludCk7XG5Db2xvclBpY2tlci5kaXNwbGF5TmFtZSA9ICdDb2xvclBpY2tlcic7XG4iXX0=