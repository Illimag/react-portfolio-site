import format from 'date-fns/esm/format';
import isAfter from 'date-fns/esm/isAfter';
import isValidDate from 'date-fns/esm/isValid';
import parse from 'date-fns/esm/parse';
const longFormatters = require('date-fns/_lib/format/longFormatters');
// This RegExp catches symbols escaped by quotes, and also
// sequences of symbols P, p, and the combinations like `PPPPPPPppppp`
const longFormattingTokensRegExp = /P+p+|P+|p+|''|'(''|[^'])+('|$)|./g;
/**
 * Date parsing
 * @param value
 * @param dateFormat
 * @param locale
 * @param strictParsing
 */
export function parseDate(value, dateFormat, locale, strictParsing) {
    // tslint:disable-next-line
    let parsedDate = null;
    const localeObject = getLocaleObject(locale || '') || getDefaultLocale();
    let strictParsingValueMatch = true;
    if (Array.isArray(dateFormat)) {
        dateFormat.forEach(df => {
            const tryParseDate = parse(value, df, new Date(), { locale: localeObject });
            if (strictParsing) {
                strictParsingValueMatch = isValid(tryParseDate) && value === format(tryParseDate, df);
            }
            if (isValid(tryParseDate) && strictParsingValueMatch) {
                parsedDate = tryParseDate;
            }
        });
        return parsedDate;
    }
    parsedDate = parse(value, dateFormat, new Date(), { locale: localeObject });
    if (strictParsing) {
        strictParsingValueMatch = isValid(parsedDate) && value === format(parsedDate, dateFormat);
    }
    else if (!isValid(parsedDate)) {
        const match = dateFormat.match(longFormattingTokensRegExp);
        const updatedDateFormat = match
            ? match
                .map(substring => {
                const firstCharacter = substring[0];
                if (firstCharacter === 'p' || firstCharacter === 'P') {
                    const longFormatter = longFormatters[firstCharacter];
                    return localeObject ? longFormatter(substring, localeObject.formatLong) : firstCharacter;
                }
                return substring;
            })
                .join('')
            : dateFormat;
        if (value.length > 0) {
            parsedDate = parse(value, updatedDateFormat.slice(0, value.length), new Date());
        }
        if (!isValid(parsedDate)) {
            parsedDate = new Date(value);
        }
    }
    // tslint:disable-next-line
    return isValid(parsedDate) && strictParsingValueMatch ? parsedDate : null;
}
export function getIsoDateFormat() {
    return 'yyyy-MM-dd';
}
function getLocaleObject(localeSpec) {
    if (typeof localeSpec === 'string') {
        // Treat it as a locale name registered by registerLocale
        // tslint:disable-next-line
        return window.__localeData__ ? window.__localeData__[localeSpec] : null;
    }
    else {
        // Treat it as a raw date-fns locale object
        return localeSpec;
    }
}
function getDefaultLocale() {
    return window.__localeId__;
}
function isValid(date) {
    return isValidDate(date) && isAfter(date, new Date('1/1/1000'));
}
/**
 * Date Formatting
 * @param date Date
 * @param formatStr string
 * @param locale string
 */
function formatDate(date, formatStr, locale = '') {
    if (locale === 'en') {
        return format(date, formatStr);
    }
    let localeObj = getLocaleObject(locale);
    if (locale && !localeObj) {
        console.warn(`A locale object was not found for the provided string ["${locale}"].`);
    }
    if (!localeObj && !!getDefaultLocale() && !!getLocaleObject(getDefaultLocale())) {
        localeObj = getLocaleObject(getDefaultLocale());
    }
    return format(date, formatStr, {
        // tslint:disable-next-line
        locale: localeObj ? localeObj : null,
    });
}
export function safeDateFormat(date, { dateFormat, locale }) {
    return (date && formatDate(date, Array.isArray(dateFormat) ? dateFormat[0] : dateFormat, locale)) || '';
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0ZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy91dGlscy9kYXRlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sTUFBTSxNQUFNLHFCQUFxQixDQUFDO0FBQ3pDLE9BQU8sT0FBTyxNQUFNLHNCQUFzQixDQUFDO0FBQzNDLE9BQU8sV0FBVyxNQUFNLHNCQUFzQixDQUFDO0FBQy9DLE9BQU8sS0FBSyxNQUFNLG9CQUFvQixDQUFDO0FBRXZDLE1BQU0sY0FBYyxHQUFHLE9BQU8sQ0FBQyxxQ0FBcUMsQ0FBQyxDQUFDO0FBU3RFLDBEQUEwRDtBQUMxRCxzRUFBc0U7QUFDdEUsTUFBTSwwQkFBMEIsR0FBRyxtQ0FBbUMsQ0FBQztBQUV2RTs7Ozs7O0dBTUc7QUFDSCxNQUFNLFVBQVUsU0FBUyxDQUN2QixLQUFhLEVBQ2IsVUFBa0MsRUFDbEMsTUFBd0IsRUFDeEIsYUFBdUI7SUFFdkIsMkJBQTJCO0lBQzNCLElBQUksVUFBVSxHQUFHLElBQUksQ0FBQztJQUN0QixNQUFNLFlBQVksR0FBRyxlQUFlLENBQUMsTUFBTSxJQUFJLEVBQUUsQ0FBQyxJQUFJLGdCQUFnQixFQUFFLENBQUM7SUFDekUsSUFBSSx1QkFBdUIsR0FBRyxJQUFJLENBQUM7SUFDbkMsSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxFQUFFO1FBQzdCLFVBQVUsQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLEVBQUU7WUFDdEIsTUFBTSxZQUFZLEdBQUcsS0FBSyxDQUFDLEtBQUssRUFBRSxFQUFFLEVBQUUsSUFBSSxJQUFJLEVBQUUsRUFBRSxFQUFFLE1BQU0sRUFBRSxZQUFZLEVBQUUsQ0FBQyxDQUFDO1lBQzVFLElBQUksYUFBYSxFQUFFO2dCQUNqQix1QkFBdUIsR0FBRyxPQUFPLENBQUMsWUFBWSxDQUFDLElBQUksS0FBSyxLQUFLLE1BQU0sQ0FBQyxZQUFZLEVBQUUsRUFBRSxDQUFDLENBQUM7YUFDdkY7WUFDRCxJQUFJ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UUFDbkIsT0FBTyxNQUFNLENBQUMsSUFBSSxFQUFFLFNBQVMsQ0FBQyxDQUFDO0tBQ2hDO0lBQ0QsSUFBSSxTQUFTLEdBQUcsZUFBZSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ3hDLElBQUksTUFBTSxJQUFJLENBQUMsU0FBUyxFQUFFO1FBQ3hCLE9BQU8sQ0FBQyxJQUFJLENBQUMsMkRBQTJELE1BQU0sS0FBSyxDQUFDLENBQUM7S0FDdEY7SUFDRCxJQUFJLENBQUMsU0FBUyxJQUFJLENBQUMsQ0FBQyxnQkFBZ0IsRUFBRSxJQUFJLENBQUMsQ0FBQyxlQUFlLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQyxFQUFFO1FBQy9FLFNBQVMsR0FBRyxlQUFlLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQyxDQUFDO0tBQ2pEO0lBQ0QsT0FBTyxNQUFNLENBQUMsSUFBSSxFQUFFLFNBQVMsRUFBRTtRQUM3QiwyQkFBMkI7UUFDM0IsTUFBTSxFQUFFLFNBQVMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxJQUFJO0tBQ3JDLENBQUMsQ0FBQztBQUNMLENBQUM7QUFFRCxNQUFNLFVBQVUsY0FBYyxDQUM1QixJQUFzQixFQUN0QixFQUFFLFVBQVUsRUFBRSxNQUFNLEVBQW9FO0lBRXhGLE9BQU8sQ0FBQyxJQUFJLElBQUksVUFBVSxDQUFDLElBQUksRUFBRSxLQUFLLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLFVBQVUsRUFBRSxNQUFNLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQztBQUMxRyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTG9jYWxlIH0gZnJvbSAnZGF0ZS1mbnMnO1xuaW1wb3J0IGZvcm1hdCBmcm9tICdkYXRlLWZucy9lc20vZm9ybWF0JztcbmltcG9ydCBpc0FmdGVyIGZyb20gJ2RhdGUtZm5zL2VzbS9pc0FmdGVyJztcbmltcG9ydCBpc1ZhbGlkRGF0ZSBmcm9tICdkYXRlLWZucy9lc20vaXNWYWxpZCc7XG5pbXBvcnQgcGFyc2UgZnJvbSAnZGF0ZS1mbnMvZXNtL3BhcnNlJztcblxuY29uc3QgbG9uZ0Zvcm1hdHRlcnMgPSByZXF1aXJlKCdkYXRlLWZucy9fbGliL2Zvcm1hdC9sb25nRm9ybWF0dGVycycpO1xuXG5kZWNsYXJlIGdsb2JhbCB7XG4gIGludGVyZmFjZSBXaW5kb3cge1xuICAgIF9fbG9jYWxlRGF0YV9fOiBPYmplY3Q7XG4gICAgX19sb2NhbGVJZF9fOiBzdHJpbmc7XG4gIH1cbn1cblxuLy8gVGhpcyBSZWdFeHAgY2F0Y2hlcyBzeW1ib2xzIGVzY2FwZWQgYnkgcXVvdGVzLCBhbmQgYWxzb1xuLy8gc2VxdWVuY2VzIG9mIHN5bWJvbHMgUCwgcCwgYW5kIHRoZSBjb21iaW5hdGlvbnMgbGlrZSBgUFBQUFBQUHBwcHBwYFxuY29uc3QgbG9uZ0Zvcm1hdHRpbmdUb2tlbnNSZWdFeHAgPSAvUCtwK3xQK3xwK3wnJ3wnKCcnfFteJ10pKygnfCQpfC4vZztcblxuLyoqXG4gKiBEYXRlIHBhcnNpbmdcbiAqIEBwYXJhbSB2YWx1ZVxuICogQHBhcmFtIGRhdGVGb3JtYXRcbiAqIEBwYXJhbSBsb2NhbGVcbiAqIEBwYXJhbSBzdHJpY3RQYXJzaW5nXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBwYXJzZURhdGUoXG4gIHZhbHVlOiBzdHJpbmcsXG4gIGRhdGVGb3JtYXQ6IHN0cmluZyB8IEFycmF5PHN0cmluZz4sXG4gIGxvY2FsZT86IExvY2FsZSB8IHN0cmluZyxcbiAgc3RyaWN0UGFyc2luZz86IGJvb2xlYW4sXG4pIHtcbiAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lXG4gIGxldCBwYXJzZWREYXRlID0gbnVsbDtcbiAgY29uc3QgbG9jYWxlT2JqZWN0ID0gZ2V0TG9jYWxlT2JqZWN0KGxvY2FsZSB8fCAnJykgfHwgZ2V0RGVmYXVsdExvY2FsZSgpO1xuICBsZXQgc3RyaWN0UGFyc2luZ1ZhbHVlTWF0Y2ggPSB0cnVlO1xuICBpZiAoQXJyYXkuaXNBcnJheShkYXRlRm9ybWF0KSkge1xuICAgIGRhdGVGb3JtYXQuZm9yRWFjaChkZiA9PiB7XG4gICAgICBjb25zdCB0cnlQYXJzZURhdGUgPSBwYXJzZSh2YWx1ZSwgZGYsIG5ldyBEYXRlKCksIHsgbG9jYWxlOiBsb2NhbGVPYmplY3QgfSk7XG4gICAgICBpZiAoc3RyaWN0UGFyc2luZykge1xuICAgICAgICBzdHJpY3RQYXJzaW5nVmFsdWVNYXRjaCA9IGlzVmFsaWQodHJ5UGFyc2VEYXRlKSAmJiB2YWx1ZSA9PT0gZm9ybWF0KHRyeVBhcnNlRGF0ZSwgZGYpO1xuICAgICAgfVxuICAgICAgaWYgKGlzVmFsaWQodHJ5UGFyc2VEYXRlKSAmJiBzdHJpY3RQYXJzaW5nVmFsdWVNYXRjaCkge1xuICAgICAgICBwYXJzZWREYXRlID0gdHJ5UGFyc2VEYXRlO1xuICAgICAgfVxuICAgIH0pO1xuICAgIHJldHVybiBwYXJzZWREYXRlO1xuICB9XG5cbiAgcGFyc2VkRGF0ZSA9IHBhcnNlKHZhbHVlLCBkYXRlRm9ybWF0LCBuZXcgRGF0ZSgpLCB7IGxvY2FsZTogbG9jYWxlT2JqZWN0IH0pO1xuXG4gIGlmIChzdHJpY3RQYXJzaW5nKSB7XG4gICAgc3RyaWN0UGFyc2luZ1ZhbHVlTWF0Y2ggPSBpc1ZhbGlkKHBhcnNlZERhdGUpICYmIHZhbHVlID09PSBmb3JtYXQocGFyc2VkRGF0ZSwgZGF0ZUZvcm1hdCk7XG4gIH0gZWxzZSBpZiAoIWlzVmFsaWQocGFyc2VkRGF0ZSkpIHtcbiAgICBjb25zdCBtYXRjaCA9IGRhdGVGb3JtYXQubWF0Y2gobG9uZ0Zvcm1hdHRpbmdUb2tlbnNSZWdFeHApO1xuICAgIGNvbnN0IHVwZGF0ZWREYXRlRm9ybWF0ID0gbWF0Y2hcbiAgICAgID8gbWF0Y2hcbiAgICAgICAgICAubWFwKHN1YnN0cmluZyA9PiB7XG4gICAgICAgICAgICBjb25zdCBmaXJzdENoYXJhY3RlciA9IHN1YnN0cmluZ1swXTtcbiAgICAgICAgICAgIGlmIChmaXJzdENoYXJhY3RlciA9PT0gJ3AnIHx8IGZpcnN0Q2hhcmFjdGVyID09PSAnUCcpIHtcbiAgICAgICAgICAgICAgY29uc3QgbG9uZ0Zvcm1hdHRlciA9IGxvbmdGb3JtYXR0ZXJzW2ZpcnN0Q2hhcmFjdGVyXTtcbiAgICAgICAgICAgICAgcmV0dXJuIGxvY2FsZU9iamVjdCA/IGxvbmdGb3JtYXR0ZXIoc3Vic3RyaW5nLCBsb2NhbGVPYmplY3QuZm9ybWF0TG9uZykgOiBmaXJzdENoYXJhY3RlcjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBzdWJzdHJpbmc7XG4gICAgICAgICAgfSlcbiAgICAgICAgICAuam9pbignJylcbiAgICAgIDogZGF0ZUZvcm1hdDtcblxuICAgIGlmICh2YWx1ZS5sZW5ndGggPiAwKSB7XG4gICAgICBwYXJzZWREYXRlID0gcGFyc2UodmFsdWUsIHVwZGF0ZWREYXRlRm9ybWF0LnNsaWNlKDAsIHZhbHVlLmxlbmd0aCksIG5ldyBEYXRlKCkpO1xuICAgIH1cblxuICAgIGlmICghaXNWYWxpZChwYXJzZWREYXRlKSkge1xuICAgICAgcGFyc2VkRGF0ZSA9IG5ldyBEYXRlKHZhbHVlKTtcbiAgICB9XG4gIH1cblxuICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmVcbiAgcmV0dXJuIGlzVmFsaWQocGFyc2VkRGF0ZSkgJiYgc3RyaWN0UGFyc2luZ1ZhbHVlTWF0Y2ggPyBwYXJzZWREYXRlIDogbnVsbDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldElzb0RhdGVGb3JtYXQoKSB7XG4gIHJldHVybiAneXl5eS1NTS1kZCc7XG59XG5cbmZ1bmN0aW9uIGdldExvY2FsZU9iamVjdChsb2NhbGVTcGVjOiBzdHJpbmcgfCBMb2NhbGUpIHtcbiAgaWYgKHR5cGVvZiBsb2NhbGVTcGVjID09PSAnc3RyaW5nJykge1xuICAgIC8vIFRyZWF0IGl0IGFzIGEgbG9jYWxlIG5hbWUgcmVnaXN0ZXJlZCBieSByZWdpc3RlckxvY2FsZVxuICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZVxuICAgIHJldHVybiB3aW5kb3cuX19sb2NhbGVEYXRhX18gPyB3aW5kb3cuX19sb2NhbGVEYXRhX19bbG9jYWxlU3BlY10gOiBudWxsO1xuICB9IGVsc2Uge1xuICAgIC8vIFRyZWF0IGl0IGFzIGEgcmF3IGRhdGUtZm5zIGxvY2FsZSBvYmplY3RcbiAgICByZXR1cm4gbG9jYWxlU3BlYztcbiAgfVxufVxuXG5mdW5jdGlvbiBnZXREZWZhdWx0TG9jYWxlKCkge1xuICByZXR1cm4gd2luZG93Ll9fbG9jYWxlSWRfXztcbn1cblxuZnVuY3Rpb24gaXNWYWxpZChkYXRlOiBEYXRlKSB7XG4gIHJldHVybiBpc1ZhbGlkRGF0ZShkYXRlKSAmJiBpc0FmdGVyKGRhdGUsIG5ldyBEYXRlKCcxLzEvMTAwMCcpKTtcbn1cblxuLyoqXG4gKiBEYXRlIEZvcm1hdHRpbmdcbiAqIEBwYXJhbSBkYXRlIERhdGVcbiAqIEBwYXJhbSBmb3JtYXRTdHIgc3RyaW5nXG4gKiBAcGFyYW0gbG9jYWxlIHN0cmluZ1xuICovXG5mdW5jdGlvbiBmb3JtYXREYXRlKGRhdGU6IERhdGUsIGZvcm1hdFN0cjogc3RyaW5nLCBsb2NhbGU6IHN0cmluZyB8IExvY2FsZSA9ICcnKSB7XG4gIGlmIChsb2NhbGUgPT09ICdlbicpIHtcbiAgICByZXR1cm4gZm9ybWF0KGRhdGUsIGZvcm1hdFN0cik7XG4gIH1cbiAgbGV0IGxvY2FsZU9iaiA9IGdldExvY2FsZU9iamVjdChsb2NhbGUpO1xuICBpZiAobG9jYWxlICYmICFsb2NhbGVPYmopIHtcbiAgICBjb25zb2xlLndhcm4oYEEgbG9jYWxlIG9iamVjdCB3YXMgbm90IGZvdW5kIGZvciB0aGUgcHJvdmlkZWQgc3RyaW5nIFtcIiR7bG9jYWxlfVwiXS5gKTtcbiAgfVxuICBpZiAoIWxvY2FsZU9iaiAmJiAhIWdldERlZmF1bHRMb2NhbGUoKSAmJiAhIWdldExvY2FsZU9iamVjdChnZXREZWZhdWx0TG9jYWxlKCkpKSB7XG4gICAgbG9jYWxlT2JqID0gZ2V0TG9jYWxlT2JqZWN0KGdldERlZmF1bHRMb2NhbGUoKSk7XG4gIH1cbiAgcmV0dXJuIGZvcm1hdChkYXRlLCBmb3JtYXRTdHIsIHtcbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmVcbiAgICBsb2NhbGU6IGxvY2FsZU9iaiA/IGxvY2FsZU9iaiA6IG51bGwsXG4gIH0pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gc2FmZURhdGVGb3JtYXQoXG4gIGRhdGU6IERhdGUgfCB1bmRlZmluZWQsXG4gIHsgZGF0ZUZvcm1hdCwgbG9jYWxlIH06IHsgZGF0ZUZvcm1hdDogc3RyaW5nIHwgQXJyYXk8c3RyaW5nPjsgbG9jYWxlPzogc3RyaW5nIHwgTG9jYWxlIH0sXG4pIHtcbiAgcmV0dXJuIChkYXRlICYmIGZvcm1hdERhdGUoZGF0ZSwgQXJyYXkuaXNBcnJheShkYXRlRm9ybWF0KSA/IGRhdGVGb3JtYXRbMF0gOiBkYXRlRm9ybWF0LCBsb2NhbGUpKSB8fCAnJztcbn1cbiJdfQ==