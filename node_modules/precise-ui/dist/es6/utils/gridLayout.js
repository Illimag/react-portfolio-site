import * as React from 'react';
export function checkAllocation(layout, row, col, rowSpan, colSpan) {
    const { allocations, flexCols, flexRows } = layout;
    for (let r = row, l = row + rowSpan; r < l; r++) {
        if (r >= allocations.length && !flexRows) {
            return false;
        }
        const allocation = allocations[r];
        for (let c = col, l = col + colSpan; c < l; c++) {
            if (allocation) {
                if ((c >= allocation.length && !flexCols) || allocation[c]) {
                    return false;
                }
            }
        }
    }
    return true;
}
export function findAllocation(layout, proposedAllocation = {}) {
    const { colSpan = 1, rowSpan = 1, row, column: col } = proposedAllocation;
    if (row === undefined || col === undefined) {
        const { allocations, flexCols, flexRows } = layout;
        const infty = Number.POSITIVE_INFINITY;
        const maxRows = flexRows ? infty : allocations.length - 1;
        const maxCols = flexCols ? infty : allocations[0].length - 1;
        for (let r = row || 0; r <= (row || maxRows); r++) {
            for (let c = col || 0; c <= (col || maxCols); c++) {
                if (checkAllocation(layout, r, c, rowSpan, colSpan)) {
                    return {
                        ci: c,
                        cf: c + colSpan,
                        ri: r,
                        rf: r + rowSpan,
                    };
                }
            }
        }
    }
    else {
        return {
            ci: col,
            cf: col + colSpan,
            ri: row,
            rf: row + rowSpan,
        };
    }
    return undefined;
}
export function updateAllocation(allocations, allocation) {
    while (allocations.length < allocation.ri) {
        appendRow(allocations);
    }
    while (allocations[0].length < allocation.ci) {
        appendColumn(allocations);
    }
    for (let row = allocation.ri; row < allocation.rf; row++) {
        if (row === allocations.length) {
            appendRow(allocations);
        }
        for (let col = allocation.ci; col < allocation.cf; col++) {
            if (col === allocations[0].length) {
                appendColumn(allocations);
            }
            allocations[row][col] = true;
        }
    }
}
export function createAllocations(dim) {
    const allocations = [];
    const rows = Array.isArray(dim.rows) ? dim.rows.length : dim.rows || 1;
    const cols = Array.isArray(dim.columns) ? dim.columns.length : dim.columns || 1;
    for (let row = 0; row < rows; ++row) {
        const allocation = createRow(cols);
        allocations.push(allocation);
    }
    return {
        allocations,
        flexRows: dim.rows === undefined && dim.columns !== undefined,
        flexCols: dim.columns === undefined,
    };
}
function appendColumn(allocations) {
    for (const row of allocations) {
        row.push(false);
    }
}
function appendRow(allocations) {
    const newRow = createRow(allocations[0].length);
    allocations.push(newRow);
}
function createRow(cols) {
    const allocation = [];
    for (let col = 0; col < cols; ++col) {
        allocation.push(false);
    }
    return allocation;
}
function createCell(layout, proposed) {
    if (!proposed.hidden) {
        const foundAllocation = findAllocation(layout, proposed);
        if (foundAllocation) {
            updateAllocation(layout.allocations, foundAllocation);
            return {
                column: foundAllocation.ci,
                row: foundAllocation.ri,
                colSpan: foundAllocation.cf - foundAllocation.ci,
                rowSpan: foundAllocation.rf - foundAllocation.ri,
            };
        }
        return undefined;
    }
    return {
        column: 0,
        row: 0,
        colSpan: 0,
        rowSpan: 0,
    };
}
export function calcLayout(children, dim) {
    const layout = createAllocations(dim);
    const cells = [];
    React.Children.forEach(children, (child, index) => {
        if (typeof child === 'object' && child) {
            const { row, column } = child.props;
            if (row !== undefined && column !== undefined) {
                cells[index] = createCell(layout, child.props);
            }
        }
    });
    React.Children.forEach(children, (child, index) => {
        if (typeof child === 'object' && child && !cells[index]) {
            cells[index] = createCell(layout, child.props);
        }
    });
    return {
        cells,
        rows: layout.allocations.length,
        columns: layout.allocations[0].length,
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ3JpZExheW91dC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy91dGlscy9ncmlkTGF5b3V0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sS0FBSyxLQUFLLE1BQU0sT0FBTyxDQUFDO0FBb0QvQixNQUFNLFVBQVUsZUFBZSxDQUM3QixNQUE0QixFQUM1QixHQUFXLEVBQ1gsR0FBVyxFQUNYLE9BQWUsRUFDZixPQUFlO0lBRWYsTUFBTSxFQUFFLFdBQVcsRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFFLEdBQUcsTUFBTSxDQUFDO0lBRW5ELEtBQUssSUFBSSxDQUFDLEdBQUcsR0FBRyxFQUFFLENBQUMsR0FBRyxHQUFHLEdBQUcsT0FBTyxFQUFFLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUU7UUFDL0MsSUFBSSxDQUFDLElBQUksV0FBVyxDQUFDLE1BQU0sSUFBSSxDQUFDLFFBQVEsRUFBRTtZQUN4QyxPQUFPLEtBQUssQ0FBQztTQUNkO1FBRUQsTUFBTSxVQUFVLEdBQUcsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBRWxDLEtBQUssSUFBSSxDQUFDLEdBQUcsR0FBRyxFQUFFLENBQUMsR0FBRyxHQUFHLEdBQUcsT0FBTyxFQUFFLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUU7WUFDL0MsSUFBSSxVQUFVLEVBQUU7Z0JBQ2QsSUFBSSxDQUFDLENBQUMsSUFBSSxVQUFVLENBQUMsTUFBTSxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksVUFBVSxDQUFDLENBQUMsQ0FBQyxFQUFFO29CQUMxRCxPQUFPLEtBQUssQ0FBQztpQkFDZDthQUNGO1NBQ0Y7S0FDRjtJQUVELE9BQU8sSUFBSSxDQUFDO0FBQ2QsQ0FBQztBQUVELE1BQU0sVUFBVSxjQUFjLENBQUMsTUFBNEIsRUFBRSxxQkFBOEMsRUFBRTtJQUMzRyxNQUFNLEVBQUUsT0FBTyxHQUFHLENBQUMsRUFBRSxPQUFPLEdBQUcs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RSxHQUFHLEVBQUUsTUFBTSxFQUFFLEdBQUksS0FBYSxDQUFDLEtBQUssQ0FBQztZQUU3QyxJQUFJLEdBQUcsS0FBSyxTQUFTLElBQUksTUFBTSxLQUFLLFNBQVMsRUFBRTtnQkFDN0MsS0FBSyxDQUFDLEtBQUssQ0FBQyxHQUFHLFVBQVUsQ0FBQyxNQUFNLEVBQUcsS0FBYSxDQUFDLEtBQUssQ0FBQyxDQUFDO2FBQ3pEO1NBQ0Y7SUFDSCxDQUFDLENBQUMsQ0FBQztJQUVILEtBQUssQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLFFBQVEsRUFBRSxDQUFDLEtBQUssRUFBRSxLQUFLLEVBQUUsRUFBRTtRQUNoRCxJQUFJLE9BQU8sS0FBSyxLQUFLLFFBQVEsSUFBSSxLQUFLLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLEVBQUU7WUFDdkQsS0FBSyxDQUFDLEtBQUssQ0FBQyxHQUFHLFVBQVUsQ0FBQyxNQUFNLEVBQUcsS0FBYSxDQUFDLEtBQUssQ0FBQyxDQUFDO1NBQ3pEO0lBQ0gsQ0FBQyxDQUFDLENBQUM7SUFFSCxPQUFPO1FBQ0wsS0FBSztRQUNMLElBQUksRUFBRSxNQUFNLENBQUMsV0FBVyxDQUFDLE1BQU07UUFDL0IsT0FBTyxFQUFFLE1BQU0sQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTTtLQUN0QyxDQUFDO0FBQ0osQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIFJlYWN0IGZyb20gJ3JlYWN0JztcblxuZXhwb3J0IGludGVyZmFjZSBHcmlkQ2VsbERlZmluaXRpb24ge1xuICAvKipcbiAgICogVGhlIG9wdGlvbmFsIG51bWJlciBvZiBzcGFubmVkIGNvbHVtbnMuIEJ5IGRlZmF1bHQgb25seSAxIGNvbHVtbiBpcyBzcGFubmVkLlxuICAgKiBAZGVmYXVsdCAxXG4gICAqL1xuICBjb2xTcGFuPzogbnVtYmVyO1xuICAvKipcbiAgICogVGhlIG9wdGlvbmFsIG51bWJlciBvZiBzcGFubmVkIGNvbHVtbnMuIEJ5IGRlZmF1bHQgb25seSAxIHJvdyBpcyBzcGFubmVkLlxuICAgKiBAZGVmYXVsdCAxXG4gICAqL1xuICByb3dTcGFuPzogbnVtYmVyO1xuICAvKipcbiAgICogVGhlIDAtYmFzZWQgY29sdW1uIHdoZXJlIHRoZSBhcmVhIHNob3VsZCBiZSBkaXNwbGF5ZWQuXG4gICAqL1xuICBjb2x1bW4/OiBudW1iZXI7XG4gIC8qKlxuICAgKiBUaGUgMC1iYXNlZCByb3cgd2hlcmUgdGhlIGFyZWEgc2hvdWxkIGJlIGRpc3BsYXllZC5cbiAgICovXG4gIHJvdz86IG51bWJlcjtcbiAgLyoqXG4gICAqIE9wdGlvbmFsbHkgc2V0cyB0aGUgdGlsZSB0byBiZSBoaWRkZW4sIHNvIHRoYXQgaXQgZG9lcyBub3QgY29uc3VtZSBzcGFjZS5cbiAgICovXG4gIGhpZGRlbj86IGJvb2xlYW47XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgR3JpZExheW91dENlbGwge1xuICByaTogbnVtYmVyO1xuICByZjogbnVtYmVyO1xuICBjaTogbnVtYmVyO1xuICBjZjogbnVtYmVyO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEdyaWRBbGxvY2F0aW9uIHtcbiAgY29sdW1uOiBudW1iZXI7XG4gIHJvdzogbnVtYmVyO1xuICBjb2xTcGFuOiBudW1iZXI7XG4gIHJvd1NwYW46IG51bWJlcjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBHcmlkQWxsb2NhdGlvbkxheW91dCB7XG4gIGFsbG9jYXRpb25zOiBBcnJheTxBcnJheTxib29sZWFuPj47XG4gIGZsZXhSb3dzOiBib29sZWFuO1xuICBmbGV4Q29sczogYm9vbGVhbjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBHcmlkRGltZW5zaW9uIHtcbiAgcm93cz86IG51bWJlciB8IEFycmF5PHN0cmluZz47XG4gIGNvbHVtbnM/OiBudW1iZXIgfCBBcnJheTxzdHJpbmc+O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gY2hlY2tBbGxvY2F0aW9uKFxuICBsYXlvdXQ6IEdyaWRBbGxvY2F0aW9uTGF5b3V0LFxuICByb3c6IG51bWJlcixcbiAgY29sOiBudW1iZXIsXG4gIHJvd1NwYW46IG51bWJlcixcbiAgY29sU3BhbjogbnVtYmVyLFxuKSB7XG4gIGNvbnN0IHsgYWxsb2NhdGlvbnMsIGZsZXhDb2xzLCBmbGV4Um93cyB9ID0gbGF5b3V0O1xuXG4gIGZvciAobGV0IHIgPSByb3csIGwgPSByb3cgKyByb3dTcGFuOyByIDwgbDsgcisrKSB7XG4gICAgaWYgKHIgPj0gYWxsb2NhdGlvbnMubGVuZ3RoICYmICFmbGV4Um93cykge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIGNvbnN0IGFsbG9jYXRpb24gPSBhbGxvY2F0aW9uc1tyXTtcblxuICAgIGZvciAobGV0IGMgPSBjb2wsIGwgPSBjb2wgKyBjb2xTcGFuOyBjIDwgbDsgYysrKSB7XG4gICAgICBpZiAoYWxsb2NhdGlvbikge1xuICAgICAgICBpZiAoKGMgPj0gYWxsb2NhdGlvbi5sZW5ndGggJiYgIWZsZXhDb2xzKSB8fCBhbGxvY2F0aW9uW2NdKSB7XG4gICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIHRydWU7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBmaW5kQWxsb2NhdGlvbihsYXlvdXQ6IEdyaWRBbGxvY2F0aW9uTGF5b3V0LCBwcm9wb3NlZEFsbG9jYXRpb246IFBhcnRpYWw8R3JpZEFsbG9jYXRpb24+ID0ge30pIHtcbiAgY29uc3QgeyBjb2xTcGFuID0gMSwgcm93U3BhbiA9IDEsIHJvdywgY29sdW1uOiBjb2wgfSA9IHByb3Bvc2VkQWxsb2NhdGlvbjtcblxuICBpZiAocm93ID09PSB1bmRlZmluZWQgfHwgY29sID09PSB1bmRlZmluZWQpIHtcbiAgICBjb25zdCB7IGFsbG9jYXRpb25zLCBmbGV4Q29scywgZmxleFJvd3MgfSA9IGxheW91dDtcbiAgICBjb25zdCBpbmZ0eSA9IE51bWJlci5QT1NJVElWRV9JTkZJTklUWTtcbiAgICBjb25zdCBtYXhSb3dzID0gZmxleFJvd3MgPyBpbmZ0eSA6IGFsbG9jYXRpb25zLmxlbmd0aCAtIDE7XG4gICAgY29uc3QgbWF4Q29scyA9IGZsZXhDb2xzID8gaW5mdHkgOiBhbGxvY2F0aW9uc1swXS5sZW5ndGggLSAxO1xuXG4gICAgZm9yIChsZXQgciA9IHJvdyB8fCAwOyByIDw9IChyb3cgfHwgbWF4Um93cyk7IHIrKykge1xuICAgICAgZm9yIChsZXQgYyA9IGNvbCB8fCAwOyBjIDw9IChjb2wgfHwgbWF4Q29scyk7IGMrKykge1xuICAgICAgICBpZiAoY2hlY2tBbGxvY2F0aW9uKGxheW91dCwgciwgYywgcm93U3BhbiwgY29sU3BhbikpIHtcbiAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgY2k6IGMsXG4gICAgICAgICAgICBjZjogYyArIGNvbFNwYW4sXG4gICAgICAgICAgICByaTogcixcbiAgICAgICAgICAgIHJmOiByICsgcm93U3BhbixcbiAgICAgICAgICB9O1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIHJldHVybiB7XG4gICAgICBjaTogY29sLFxuICAgICAgY2Y6IGNvbCArIGNvbFNwYW4sXG4gICAgICByaTogcm93LFxuICAgICAgcmY6IHJvdyArIHJvd1NwYW4sXG4gICAgfTtcbiAgfVxuXG4gIHJldHVybiB1bmRlZmluZWQ7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiB1cGRhdGVBbGxvY2F0aW9uKGFsbG9jYXRpb25zOiBBcnJheTxBcnJheTxib29sZWFuPj4sIGFsbG9jYXRpb246IEdyaWRMYXlvdXRDZWxsKSB7XG4gIHdoaWxlIChhbGxvY2F0aW9ucy5sZW5ndGggPCBhbGxvY2F0aW9uLnJpKSB7XG4gICAgYXBwZW5kUm93KGFsbG9jYXRpb25zKTtcbiAgfVxuXG4gIHdoaWxlIChhbGxvY2F0aW9uc1swXS5sZW5ndGggPCBhbGxvY2F0aW9uLmNpKSB7XG4gICAgYXBwZW5kQ29sdW1uKGFsbG9jYXRpb25zKTtcbiAgfVxuXG4gIGZvciAobGV0IHJvdyA9IGFsbG9jYXRpb24ucmk7IHJvdyA8IGFsbG9jYXRpb24ucmY7IHJvdysrKSB7XG4gICAgaWYgKHJvdyA9PT0gYWxsb2NhdGlvbnMubGVuZ3RoKSB7XG4gICAgICBhcHBlbmRSb3coYWxsb2NhdGlvbnMpO1xuICAgIH1cblxuICAgIGZvciAobGV0IGNvbCA9IGFsbG9jYXRpb24uY2k7IGNvbCA8IGFsbG9jYXRpb24uY2Y7IGNvbCsrKSB7XG4gICAgICBpZiAoY29sID09PSBhbGxvY2F0aW9uc1swXS5sZW5ndGgpIHtcbiAgICAgICAgYXBwZW5kQ29sdW1uKGFsbG9jYXRpb25zKTtcbiAgICAgIH1cblxuICAgICAgYWxsb2NhdGlvbnNbcm93XVtjb2xdID0gdHJ1ZTtcbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZUFsbG9jYXRpb25zKGRpbTogR3JpZERpbWVuc2lvbikge1xuICBjb25zdCBhbGxvY2F0aW9uczogQXJyYXk8QXJyYXk8Ym9vbGVhbj4+ID0gW107XG4gIGNvbnN0IHJvd3MgPSBBcnJheS5pc0FycmF5KGRpbS5yb3dzKSA/IGRpbS5yb3dzLmxlbmd0aCA6IGRpbS5yb3dzIHx8IDE7XG4gIGNvbnN0IGNvbHMgPSBBcnJheS5pc0FycmF5KGRpbS5jb2x1bW5zKSA/IGRpbS5jb2x1bW5zLmxlbmd0aCA6IGRpbS5jb2x1bW5zIHx8IDE7XG5cbiAgZm9yIChsZXQgcm93ID0gMDsgcm93IDwgcm93czsgKytyb3cpIHtcbiAgICBjb25zdCBhbGxvY2F0aW9uID0gY3JlYXRlUm93KGNvbHMpO1xuICAgIGFsbG9jYXRpb25zLnB1c2goYWxsb2NhdGlvbik7XG4gIH1cblxuICByZXR1cm4ge1xuICAgIGFsbG9jYXRpb25zLFxuICAgIGZsZXhSb3dzOiBkaW0ucm93cyA9PT0gdW5kZWZpbmVkICYmIGRpbS5jb2x1bW5zICE9PSB1bmRlZmluZWQsXG4gICAgZmxleENvbHM6IGRpbS5jb2x1bW5zID09PSB1bmRlZmluZWQsXG4gIH07XG59XG5cbmZ1bmN0aW9uIGFwcGVuZENvbHVtbihhbGxvY2F0aW9uczogQXJyYXk8QXJyYXk8Ym9vbGVhbj4+KSB7XG4gIGZvciAoY29uc3Qgcm93IG9mIGFsbG9jYXRpb25zKSB7XG4gICAgcm93LnB1c2goZmFsc2UpO1xuICB9XG59XG5cbmZ1bmN0aW9uIGFwcGVuZFJvdyhhbGxvY2F0aW9uczogQXJyYXk8QXJyYXk8Ym9vbGVhbj4+KSB7XG4gIGNvbnN0IG5ld1JvdyA9IGNyZWF0ZVJvdyhhbGxvY2F0aW9uc1swXS5sZW5ndGgpO1xuICBhbGxvY2F0aW9ucy5wdXNoKG5ld1Jvdyk7XG59XG5cbmZ1bmN0aW9uIGNyZWF0ZVJvdyhjb2xzOiBudW1iZXIpIHtcbiAgY29uc3QgYWxsb2NhdGlvbjogQXJyYXk8Ym9vbGVhbj4gPSBbXTtcblxuICBmb3IgKGxldCBjb2wgPSAwOyBjb2wgPCBjb2xzOyArK2NvbCkge1xuICAgIGFsbG9jYXRpb24ucHVzaChmYWxzZSk7XG4gIH1cblxuICByZXR1cm4gYWxsb2NhdGlvbjtcbn1cblxuZnVuY3Rpb24gY3JlYXRlQ2VsbChsYXlvdXQ6IEdyaWRBbGxvY2F0aW9uTGF5b3V0LCBwcm9wb3NlZDogR3JpZENlbGxEZWZpbml0aW9uKTogR3JpZEFsbG9jYXRpb24gfCB1bmRlZmluZWQge1xuICBpZiAoIXByb3Bvc2VkLmhpZGRlbikge1xuICAgIGNvbnN0IGZvdW5kQWxsb2NhdGlvbiA9IGZpbmRBbGxvY2F0aW9uKGxheW91dCwgcHJvcG9zZWQpO1xuXG4gICAgaWYgKGZvdW5kQWxsb2NhdGlvbikge1xuICAgICAgdXBkYXRlQWxsb2NhdGlvbihsYXlvdXQuYWxsb2NhdGlvbnMsIGZvdW5kQWxsb2NhdGlvbik7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBjb2x1bW46IGZvdW5kQWxsb2NhdGlvbi5jaSxcbiAgICAgICAgcm93OiBmb3VuZEFsbG9jYXRpb24ucmksXG4gICAgICAgIGNvbFNwYW46IGZvdW5kQWxsb2NhdGlvbi5jZiAtIGZvdW5kQWxsb2NhdGlvbi5jaSxcbiAgICAgICAgcm93U3BhbjogZm91bmRBbGxvY2F0aW9uLnJmIC0gZm91bmRBbGxvY2F0aW9uLnJpLFxuICAgICAgfTtcbiAgICB9XG5cbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9XG5cbiAgcmV0dXJuIHtcbiAgICBjb2x1bW46IDAsXG4gICAgcm93OiAwLFxuICAgIGNvbFNwYW46IDAsXG4gICAgcm93U3BhbjogMCxcbiAgfTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNhbGNMYXlvdXQoY2hpbGRyZW46IFJlYWN0LlJlYWN0Tm9kZSwgZGltOiBHcmlkRGltZW5zaW9uKSB7XG4gIGNvbnN0IGxheW91dCA9IGNyZWF0ZUFsbG9jYXRpb25zKGRpbSk7XG4gIGNvbnN0IGNlbGxzOiBBcnJheTxHcmlkQWxsb2NhdGlvbiB8IHVuZGVmaW5lZD4gPSBbXTtcblxuICBSZWFjdC5DaGlsZHJlbi5mb3JFYWNoKGNoaWxkcmVuLCAoY2hpbGQsIGluZGV4KSA9PiB7XG4gICAgaWYgKHR5cGVvZiBjaGlsZCA9PT0gJ29iamVjdCcgJiYgY2hpbGQpIHtcbiAgICAgIGNvbnN0IHsgcm93LCBjb2x1bW4gfSA9IChjaGlsZCBhcyBhbnkpLnByb3BzO1xuXG4gICAgICBpZiAocm93ICE9PSB1bmRlZmluZWQgJiYgY29sdW1uICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgY2VsbHNbaW5kZXhdID0gY3JlYXRlQ2VsbChsYXlvdXQsIChjaGlsZCBhcyBhbnkpLnByb3BzKTtcbiAgICAgIH1cbiAgICB9XG4gIH0pO1xuXG4gIFJlYWN0LkNoaWxkcmVuLmZvckVhY2goY2hpbGRyZW4sIChjaGlsZCwgaW5kZXgpID0+IHtcbiAgICBpZiAodHlwZW9mIGNoaWxkID09PSAnb2JqZWN0JyAmJiBjaGlsZCAmJiAhY2VsbHNbaW5kZXhdKSB7XG4gICAgICBjZWxsc1tpbmRleF0gPSBjcmVhdGVDZWxsKGxheW91dCwgKGNoaWxkIGFzIGFueSkucHJvcHMpO1xuICAgIH1cbiAgfSk7XG5cbiAgcmV0dXJuIHtcbiAgICBjZWxscyxcbiAgICByb3dzOiBsYXlvdXQuYWxsb2NhdGlvbnMubGVuZ3RoLFxuICAgIGNvbHVtbnM6IGxheW91dC5hbGxvY2F0aW9uc1swXS5sZW5ndGgsXG4gIH07XG59XG4iXX0=