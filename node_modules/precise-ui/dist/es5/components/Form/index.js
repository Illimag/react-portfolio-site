"use strict";
var __makeTemplateObject = (this && this.__makeTemplateObject) || function (cooked, raw) {
    if (Object.defineProperty) { Object.defineProperty(cooked, "raw", { value: raw }); } else { cooked.raw = raw; }
    return cooked;
};
var __extends = (this && this.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var __assign = (this && this.__assign) || function () {
    __assign = Object.assign || function(t) {
        for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
        }
        return t;
    };
    return __assign.apply(this, arguments);
};
var __rest = (this && this.__rest) || function (s, e) {
    var t = {};
    for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)
        t[p] = s[p];
    if (s != null && typeof Object.getOwnPropertySymbols === "function")
        for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) if (e.indexOf(p[i]) < 0)
            t[p[i]] = s[p[i]];
    return t;
};
Object.defineProperty(exports, "__esModule", { value: true });
var React = require("react");
var styled_1 = require("../../utils/styled");
var Prompt_1 = require("../Prompt");
var contexts_1 = require("../../contexts");
var StyledForm = styled_1.default.form(templateObject_1 || (templateObject_1 = __makeTemplateObject(["\n  margin: 0;\n"], ["\n  margin: 0;\n"])));
function isDifferent(a, b) {
    if (a !== b) {
        if (Array.isArray(a) && Array.isArray(b)) {
            if (a.length === b.length) {
                for (var i = 0; i < a.length; i++) {
                    if (isDifferent(a[i], b[i])) {
                        return true;
                    }
                }
                return false;
            }
        }
        else if (typeof a === 'object' && typeof b === 'object') {
            var keysA = Object.keys(a);
            var keysB = Object.keys(b);
            if (keysA.length === keysB.length) {
                for (var _i = 0, keysA_1 = keysA; _i < keysA_1.length; _i++) {
                    var key = keysA_1[_i];
                    if (isDifferent(a[key], b[key])) {
                        return true;
                    }
                }
                return false;
            }
        }
        return true;
    }
    return false;
}
function isChanged(initial, current) {
    var keys = Object.keys(current);
    for (var _i = 0, keys_1 = keys; _i < keys_1.length; _i++) {
        var key = keys_1[_i];
        if (isDifferent(current[key], initial[key])) {
            return true;
        }
    }
    return false;
}
/**
 * Represents a field aggregator that enables easily creating forms.
 */
var Form = /** @class */ (function (_super) {
    __extends(Form, _super);
    function Form(props) {
        var _this = _super.call(this, props) || this;
        _this.fields = [];
        _this.ctx = _this.createContext();
        _this.submit = function (e) {
            var _a = _this.props, onSubmit = _a.onSubmit, disabled = _a.disabled;
            var _b = _this.state, current = _b.current, changed = _b.changed, errors = _b.errors;
            _this.setErrors(current);
            if (!disabled && typeof onSubmit === 'function') {
                var arrayErrors_1 = Object.keys(errors).reduce(function (arrayErrors, field) {
                    var error = errors[field];
                    if (error) {
                        arrayErrors.push({ field: field, error: error });
                    }
                    return arrayErrors;
                }, []);
                _this.setState({
                    changed: false,
                    initial: current,
                }, function () { return onSubmit({
                    data: current,
                    errors: arrayErrors_1,
                    changed: changed,
                }); });
            }
            e.preventDefault();
            return false;
        };
        var data = props.value || props.defaultValue || {};
        _this.state = {
            changed: false,
            controlled: props.value !== undefined,
            initial: data,
            current: data,
            errors: {},
        };
        return _this;
    }
    Form.prototype.UNSAFE_componentWillReceiveProps = function (nextProps) {
        var _a = this.state, controlled = _a.controlled, initial = _a.initial;
        if (controlled) {
            var _b = nextProps.value, value = _b === void 0 ? {} : _b;
            var changed = isChanged(initial, value);
            this.setValues(value, changed);
        }
    };
    Form.prototype.setValues = function (current, changed) {
        var keys = Object.keys(current);
        this.setState({
            current: current,
            changed: changed,
        });
        for (var _i = 0, keys_2 = keys; _i < keys_2.length; _i++) {
            var key = keys_2[_i];
            var value = current[key];
            for (var _a = 0, _b = this.fields; _a < _b.length; _a++) {
                var field = _b[_a];
                if (field.props.name === key && field.state.value !== value) {
                    field.setState({
                        value: value,
                    });
                }
            }
        }
    };
    Form.prototype.getError = function (name, value) {
        var validator = this.props.validationRules && this.props.validationRules[name];
        var validationResult = validator ? validator(value) : true;
        var error = validationResult === true ? undefined : validationResult;
        return error;
    };
    Form.prototype.setFieldError = function (name, error) {
        for (var _i = 0, _a = this.fields; _i < _a.length; _i++) {
            var fieldEntity = _a[_i];
            if (fieldEntity.props.name === name) {
                fieldEntity.setState({ error: error });
                return;
            }
        }
    };
    Form.prototype.setError = function (_a) {
        var name = _a.name, value = _a.value;
        var _b;
        var error = this.getError(name, value);
        this.setFieldError(name, error);
        this.setState({ errors: __assign({}, this.state.errors, (_b = {}, _b[name] = error, _b)) });
    };
    Form.prototype.setErrors = function (current) {
        var keys = Object.keys(current);
        var errors = __assign({}, this.state.errors);
        for (var _i = 0, keys_3 = keys; _i < keys_3.length; _i++) {
            var key = keys_3[_i];
            var value = current[key];
            var error = this.getError(key, value);
            errors[key] = error;
            this.setFieldError(key, error);
        }
        this.setState({ errors: errors });
    };
    Form.prototype.createContext = function () {
        var _this = this;
        return {
            change: function (field) {
                var _a;
                var onChange = _this.props.onChange;
                var _b = _this.state, controlled = _b.controlled, current = _b.current, initial = _b.initial;
                var proposed = __assign({}, current, (_a = {}, _a[field.name] = field.value, _a));
                var changed = isChanged(initial, proposed);
                if (!controlled) {
                    _this.setValues(proposed, changed);
                }
                _this.setError(field);
                if (typeof onChange === 'function') {
                    onChange({
                        changed: changed,
                        value: proposed,
                    });
                }
            },
            subscribe: function (field) {
                var _a;
                var _b = _this.state, current = _b.current, _c = _b.errors, errors = _c === void 0 ? {} : _c;
                var name = field.props.name;
                if (name) {
                    _this.fields.push(field);
                    var error = void 0;
                    if (name in current) {
                        var value = current[name];
                        error = _this.getError(name, value);
                        field.setState({
                            value: value,
                        });
                    }
                    else {
                        var value = field.state.value;
                        current[name] = value;
                        error = _this.getError(name, value);
                    }
                    if (error) {
                        _this.setState({ errors: __assign({}, errors, (_a = {}, _a[name] = error, _a)) });
                    }
                }
            },
            unsubscribe: function (field) {
                var index = _this.fields.indexOf(field);
                index >= 0 && _this.fields.splice(index, 1);
            },
        };
    };
    Form.prototype.render = function () {
        var _a = this.props, _0 = _a.value, _1 = _a.defaultValue, _2 = _a.onChange, _3 = _a.onSubmit, _4 = _a.disabled, children = _a.children, prompt = _a.prompt, rest = __rest(_a, ["value", "defaultValue", "onChange", "onSubmit", "disabled", "children", "prompt"]);
        var changed = this.state.changed;
        return (React.createElement(StyledForm, __assign({}, rest, { onSubmit: this.submit }),
            prompt && (typeof prompt === 'function' ? prompt(changed) : React.createElement(Prompt_1.Prompt, { when: changed, message: prompt })),
            React.createElement(contexts_1.FormContext.Provider, { value: this.ctx }, children)));
    };
    Form.inner = {
        get StyledForm() { return StyledForm; },
        get Prompt() { return Prompt_1.Prompt; }
    };
    return Form;
}(React.Component));
exports.Form = Form;
var templateObject_1;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvY29tcG9uZW50cy9Gb3JtL2luZGV4LnRzeCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSw2QkFBK0I7QUFDL0IsNkNBQXdDO0FBQ3hDLG9DQUFtQztBQUNuQywyQ0FBa0c7QUE2RWxHLElBQU0sVUFBVSxHQUFHLGdCQUFNLENBQUMsSUFBSSxxRkFBQyxrQkFFOUIsSUFBQSxDQUFDO0FBQ0YsU0FBUyxXQUFXLENBQUMsQ0FBTSxFQUFFLENBQU07SUFDL0IsSUFBSSxDQUFDLEtBQUssQ0FBQyxFQUFFO1FBQ1QsSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEVBQUU7WUFDdEMsSUFBSSxDQUFDLENBQUMsTUFBTSxLQUFLLENBQUMsQ0FBQyxNQUFNLEVBQUU7Z0JBQ3ZCLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFO29CQUMvQixJQUFJLFdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUU7d0JBQ3pCLE9BQU8sSUFBSSxDQUFDO3FCQUNmO2lCQUNKO2dCQUNELE9BQU8sS0FBSyxDQUFDO2FBQ2hCO1NBQ0o7YUFDSSxJQUFJLE9BQU8sQ0FBQyxLQUFLLFFBQVEsSUFBSSxPQUFPLENBQUMsS0FBSyxRQUFRLEVBQUU7WUFDckQsSUFBTSxLQUFLLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUM3QixJQUFNLEtBQUssR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzdCLElBQUksS0FBSyxDQUFDLE1BQU0sS0FB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TixDQUFDO0lBeUJELHFCQUFNLEdBQU47UUFDSSxJQUFNLGVBQWlILEVBQS9HLGFBQVMsRUFBRSxvQkFBZ0IsRUFBRSxnQkFBWSxFQUFFLGdCQUFZLEVBQUUsZ0JBQVksRUFBRSxzQkFBUSxFQUFFLGtCQUFNLEVBQUUsc0dBQXNCLENBQUM7UUFDaEgsSUFBQSw0QkFBTyxDQUFnQjtRQUMvQixPQUFPLENBQUMsb0JBQUMsVUFBVSxlQUFLLElBQUksSUFBRSxRQUFRLEVBQUUsSUFBSSxDQUFDLE1BQU07WUFDbEQsTUFBTSxJQUFJLENBQUMsT0FBTyxNQUFNLEtBQUssVUFBVSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLG9CQUFDLGVBQU0sSUFBQyxJQUFJLEVBQUUsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLEdBQUcsQ0FBQztZQUN2RyxvQkFBQyxzQkFBVyxDQUFDLFFBQVEsSUFBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLEdBQUcsSUFBRyxRQUFRLENBQXdCLENBQzdELENBQUMsQ0FBQztJQUNqQixDQUFDO0lBQ00sVUFBSyxHQUFHO1FBQ1gsSUFBSSxVQUFVLEtBQUssT0FBTyxVQUErQixDQUFDLENBQUMsQ0FBQztRQUM1RCxJQUFJLE1BQU0sS0FBSyxPQUFPLGVBQXVCLENBQUMsQ0FBQyxDQUFDO0tBQ25ELENBQUM7SUFDTixXQUFDO0NBQUEsQUEzSkQsQ0FBeUQsS0FBSyxDQUFDLFNBQVMsR0EySnZFO0FBM0pZLG9CQUFJIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgUmVhY3QgZnJvbSAncmVhY3QnO1xuaW1wb3J0IHN0eWxlZCBmcm9tICcuLi8uLi91dGlscy9zdHlsZWQnO1xuaW1wb3J0IHsgUHJvbXB0IH0gZnJvbSAnLi4vUHJvbXB0JztcbmltcG9ydCB7IEZvcm1Db250ZXh0LCBGb3JtQ29udGV4dFR5cGUsIEZvcm1WYWx1ZU5vdGlmaWVyLCBGb3JtVmFsdWVDaGFuZ2UgfSBmcm9tICcuLi8uLi9jb250ZXh0cyc7XG5pbXBvcnQgeyBTdGFuZGFyZFByb3BzIH0gZnJvbSAnLi4vLi4vY29tbW9uJztcbmV4cG9ydCBpbnRlcmZhY2UgRm9ybVN1Ym1pdEV2ZW50IHtcbiAgICAvKipcbiAgICAgKiBUaGUgZGF0YSB0byBiZSBzdWJtaXR0ZWQuXG4gICAgICovXG4gICAgZGF0YTogRm9ybVZhbHVlc0RhdGE7XG4gICAgLyoqXG4gICAgICogVmFsaWRhdGlvbiBlcnJvcnNcbiAgICAgKi9cbiAgICBlcnJvcnM/OiBBcnJheTxGb3JtVmFsaWRhdGlvbkVycm9yPjtcbiAgICAvKipcbiAgICAgKiBJbmRpY2F0ZXMgd2hldGhlciB0aGUgZGF0YSBoYXMgY2hhbmdlZCBmcm9tIHRoZSBpbml0aWFsIHN0YXRlLlxuICAgICAqL1xuICAgIGNoYW5nZWQ6IGJvb2xlYW47XG59XG5leHBvcnQgaW50ZXJmYWNlIEZvcm1DaGFuZ2VFdmVudCB7XG4gICAgLyoqXG4gICAgICogVGhlIGN1cnJlbnQgdmFsdWVzIG9mIHRoZSBmb3JtIGZpZWxkcy5cbiAgICAgKi9cbiAgICB2YWx1ZTogRm9ybVZhbHVlc0RhdGE7XG4gICAgLyoqXG4gICAgICogSW5kaWNhdGVzIHdoZXRoZXIgdGhlIGRhdGEgaGFzIGNoYW5nZWQgZnJvbSB0aGUgaW5pdGlhbCBzdGF0ZS5cbiAgICAgKi9cbiAgICBjaGFuZ2VkOiBib29sZWFuO1xufVxuZXhwb3J0IGludGVyZmFjZSBGb3JtVmFsdWVzRGF0YSB7XG4gICAgW25hbWU6IHN0cmluZ106IGFueTtcbn1cbmV4cG9ydCBpbnRlcmZhY2UgRm9ybVZhbGlkYXRpb25FcnJvciB7XG4gICAgZmllbGQ6IHN0cmluZztcbiAgICBlcnJvcjogUmVhY3QuUmVhY3RDaGlsZDtcbn1cbmV4cG9ydCBpbnRlcmZhY2UgRm9ybVByb3BzPEZvcm1WYWx1ZXM+IGV4dGVuZHMgU3RhbmRhcmRQcm9wcyB7XG4gICAgLyoqXG4gICAgICogU2hvd3MgdGhlIGdpdmVuIG1lc3NhZ2UgaWYgdGhlIHVzZXIgd2FudHMgdG8gbmF2aWdhdGVcbiAgICAgKiB3aXRoIGNoYW5nZXMgYmVpbmcgbWFkZSBvciByZW5kZXJzIGN1c3RvbSBjb21wb25lbnQgd2l0aCBtZXNzYWdlIGlmIHByb3ZpZGVkLlxuICAgICAqL1xuICAgIHByb21wdD86ICgoY2hhbmdlZDogYm9vbGVhbikgPT4gUmVhY3QuUmVhY3RDaGlsZCkgfCBzdHJpbmc7XG4gICAgLyoqXG4gICAgICogVGhlIHZhbHVlIG9mIHRoZSBmb3JtIHRvIGJlIHVzZWQgaW4gY29udHJvbGxlZCBtb2RlLlxuICAgICAqL1xuICAgIHZhbHVlPzogRm9ybVZhbHVlcztcbiAgICAvKipcbiAgICAgKiBUaGUgaW5pdGlhbCB2YWx1ZSBvZiB0aGUgZm9ybSB0byBiZSB1c2VkIGluIG1hbmFnZWQgbW9kZS5cbiAgICAgKi9cbiAgICBkZWZhdWx0VmFsdWU/OiBGb3JtVmFsdWVzO1xuICAgIC8qKlxuICAgICAqIFJ1bGVzIGZvciB2YWxpZGF0aW5nIGZpZWxkcyB2YWx1ZXMuXG4gICAgICovXG4gICAgdmFsaWRhdGlvblJ1bGVzPzoge1xuICAgICAgICBbVCBpbiBrZXlvZiBGb3JtVmFsdWVzXT86ICh2YWx1ZTogYW55KSA9PiBSZWFjdC5SZWFjdENoaWxkIHwgdHJ1ZTtcbiAgICB9O1xuICAgIC8qKlxuICAgICAqIEV2ZW50IGVtaXR0ZWQgd2hlbiBhIGZpZWxkIG9mIHRoZSBmb3JtIGNoYW5nZWQuXG4gICAgICovXG4gICAgb25DaGFuZ2U/KGU6IEZvcm1DaGFuZ2VFdmVudCk6IHZvaWQ7XG4gICAgLyoqXG4gICAgICogRXZlbnQgZW1pdHRlZCB3aGVuIHRoZSBmb3JtIGlzIHN1Ym1pdHRlZC5cbiAgICAgKi9cbiAgICBvblN1Ym1pdD8oZTogRm9ybVN1Ym1pdEV2ZW50KTogdm9pZDtcbiAgICAvKipcbiAgICAgKiBEaXNhYmxlcyB0aGUgZm9ybSBpbiBjYXNlIG9mIGludmFsaWQgaW5wdXQuIEVmZmVjdGl2ZWx5XG4gICAgICogZGlzYWJsZXMgdGhlIHBvc3NpYmlsaXR5IG9mIHN1Ym1pdHRpbmcgZm9ybXMuXG4gICAgICogQGRlZmF1bHQgZmFsc2VcbiAgICAgKi9cbiAgICBkaXNhYmxlZD86IGJvb2xlYW47XG59XG5leHBvcnQgaW50ZXJmYWNlIEZvcm1TdGF0ZTxGb3JtVmFsdWVzPiB7XG4gICAgY2hhbmdlZDogYm9vbGVhbjtcbiAgICBpbml0aWFsOiBGb3JtVmFsdWVzO1xuICAgIGNvbnRyb2xsZWQ6IGJvb2xlYW47XG4gICAgY3VycmVudDogRm9ybVZhbHVlcztcbiAgICBlcnJvcnM6IFBhcnRpYWw8e1xuICAgICAgICBbVCBpbiBrZXlvZiBGb3JtVmFsdWVzXTogUmVhY3QuUmVhY3RDaGlsZDtcbiAgICB9Pjtcbn1cbmNvbnN0IFN0eWxlZEZvcm0gPSBzdHlsZWQuZm9ybSBgXG4gIG1hcmdpbjogMDtcbmA7XG5mdW5jdGlvbiBpc0RpZmZlcmVudChhOiBhbnksIGI6IGFueSkge1xuICAgIGlmIChhICE9PSBiKSB7XG4gICAgICAgIGlmIChBcnJheS5pc0FycmF5KGEpICYmIEFycmF5LmlzQXJyYXkoYikpIHtcbiAgICAgICAgICAgIGlmIChhLmxlbmd0aCA9PT0gYi5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGEubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGlzRGlmZmVyZW50KGFbaV0sIGJbaV0pKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSBpZiAodHlwZW9mIGEgPT09ICdvYmplY3QnICYmIHR5cGVvZiBiID09PSAnb2JqZWN0Jykge1xuICAgICAgICAgICAgY29uc3Qga2V5c0EgPSBPYmplY3Qua2V5cyhhKTtcbiAgICAgICAgICAgIGNvbnN0IGtleXNCID0gT2JqZWN0LmtleXMoYik7XG4gICAgICAgICAgICBpZiAoa2V5c0EubGVuZ3RoID09PSBrZXlzQi5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IGtleSBvZiBrZXlzQSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoaXNEaWZmZXJlbnQoYVtrZXldLCBiW2tleV0pKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICAgIHJldHVybiBmYWxzZTtcbn1cbmZ1bmN0aW9uIGlzQ2hhbmdlZChpbml0aWFsOiBGb3JtVmFsdWVzRGF0YSwgY3VycmVudDogRm9ybVZhbHVlc0RhdGEpIHtcbiAgICBjb25zdCBrZXlzID0gT2JqZWN0LmtleXMoY3VycmVudCk7XG4gICAgZm9yIChjb25zdCBrZXkgb2Yga2V5cykge1xuICAgICAgICBpZiAoaXNEaWZmZXJlbnQoY3VycmVudFtrZXldLCBpbml0aWFsW2tleV0pKSB7XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG59XG4vKipcbiAqIFJlcHJlc2VudHMgYSBmaWVsZCBhZ2dyZWdhdG9yIHRoYXQgZW5hYmxlcyBlYXNpbHkgY3JlYXRpbmcgZm9ybXMuXG4gKi9cbmV4cG9ydCBjbGFzcyBGb3JtPFZhbHVlcyBleHRlbmRzIEZvcm1WYWx1ZXNEYXRhPiBleHRlbmRzIFJlYWN0LkNvbXBvbmVudDxGb3JtUHJvcHM8VmFsdWVzPiwgRm9ybVN0YXRlPFZhbHVlcz4+IHtcbiAgICBwcml2YXRlIHJlYWRvbmx5IGZpZWxkczogQXJyYXk8Rm9ybVZhbHVlTm90aWZpZXI+ID0gW107XG4gICAgcHJpdmF0ZSByZWFkb25seSBjdHg6IEZvcm1Db250ZXh0VHlwZSA9IHRoaXMuY3JlYXRlQ29udGV4dCgpO1xuICAgIGNvbnN0cnVjdG9yKHByb3BzOiBGb3JtUHJvcHM8VmFsdWVzPikge1xuICAgICAgICBzdXBlcihwcm9wcyk7XG4gICAgICAgIGNvbnN0IGRhdGEgPSBwcm9wcy52YWx1ZSB8fCBwcm9wcy5kZWZhdWx0VmFsdWUgfHwge307XG4gICAgICAgIHRoaXMuc3RhdGUgPSB7XG4gICAgICAgICAgICBjaGFuZ2VkOiBmYWxzZSxcbiAgICAgICAgICAgIGNvbnRyb2xsZWQ6IHByb3BzLnZhbHVlICE9PSB1bmRlZmluZWQsXG4gICAgICAgICAgICBpbml0aWFsOiBkYXRhIGFzIFZhbHVlcyxcbiAgICAgICAgICAgIGN1cnJlbnQ6IGRhdGEgYXMgVmFsdWVzLFxuICAgICAgICAgICAgZXJyb3JzOiB7fSxcbiAgICAgICAgfTtcbiAgICB9XG4gICAgVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMobmV4dFByb3BzOiBGb3JtUHJvcHM8VmFsdWVzPikge1xuICAgICAgICBjb25zdCB7IGNvbnRyb2xsZWQsIGluaXRpYWwgfSA9IHRoaXMuc3RhdGU7XG4gICAgICAgIGlmIChjb250cm9sbGVkKSB7XG4gICAgICAgICAgICBjb25zdCB7IHZhbHVlID0ge30gfSA9IG5leHRQcm9wcyBhcyBWYWx1ZXM7XG4gICAgICAgICAgICBjb25zdCBjaGFuZ2VkID0gaXNDaGFuZ2VkKGluaXRpYWwsIHZhbHVlKTtcbiAgICAgICAgICAgIHRoaXMuc2V0VmFsdWVzKHZhbHVlLCBjaGFuZ2VkKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBwcml2YXRlIHNldFZhbHVlcyhjdXJyZW50OiBWYWx1ZXMsIGNoYW5nZWQ6IGJvb2xlYW4pIHtcbiAgICAgICAgY29uc3Qga2V5cyA9IE9iamVjdC5rZXlzKGN1cnJlbnQpO1xuICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICAgIGN1cnJlbnQsXG4gICAgICAgICAgICBjaGFuZ2VkLFxuICAgICAgICB9KTtcbiAgICAgICAgZm9yIChjb25zdCBrZXkgb2Yga2V5cykge1xuICAgICAgICAgICAgY29uc3QgdmFsdWUgPSBjdXJyZW50W2tleV07XG4gICAgICAgICAgICBmb3IgKGNvbnN0IGZpZWxkIG9mIHRoaXMuZmllbGRzKSB7XG4gICAgICAgICAgICAgICAgaWYgKGZpZWxkLnByb3BzLm5hbWUgPT09IGtleSAmJiBmaWVsZC5zdGF0ZS52YWx1ZSAhPT0gdmFsdWUpIHtcbiAgICAgICAgICAgICAgICAgICAgZmllbGQuc2V0U3RhdGUoe1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUsXG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICBwcml2YXRlIGdldEVycm9yKG5hbWU6IHN0cmluZywgdmFsdWU6IGFueSkge1xuICAgICAgICBjb25zdCB2YWxpZGF0b3IgPSB0aGlzLnByb3BzLnZhbGlkYXRpb25SdWxlcyAmJiB0aGlzLnByb3BzLnZhbGlkYXRpb25SdWxlc1tuYW1lXTtcbiAgICAgICAgY29uc3QgdmFsaWRhdGlvblJlc3VsdCA9IHZhbGlkYXRvciA/IHZhbGlkYXRvcih2YWx1ZSkgOiB0cnVlO1xuICAgICAgICBjb25zdCBlcnJvciA9IHZhbGlkYXRpb25SZXN1bHQgPT09IHRydWUgPyB1bmRlZmluZWQgOiB2YWxpZGF0aW9uUmVzdWx0O1xuICAgICAgICByZXR1cm4gZXJyb3I7XG4gICAgfVxuICAgIHByaXZhdGUgc2V0RmllbGRFcnJvcihuYW1lOiBrZXlvZiBWYWx1ZXMsIGVycm9yPzogUmVhY3QuUmVhY3RDaGlsZCkge1xuICAgICAgICBmb3IgKGNvbnN0IGZpZWxkRW50aXR5IG9mIHRoaXMuZmllbGRzKSB7XG4gICAgICAgICAgICBpZiAoZmllbGRFbnRpdHkucHJvcHMubmFtZSA9PT0gbmFtZSkge1xuICAgICAgICAgICAgICAgIGZpZWxkRW50aXR5LnNldFN0YXRlKHsgZXJyb3IgfSk7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIHByaXZhdGUgc2V0RXJyb3IoeyBuYW1lLCB2YWx1ZSB9OiBGb3JtVmFsdWVDaGFuZ2UpIHtcbiAgICAgICAgY29uc3QgZXJyb3IgPSB0aGlzLmdldEVycm9yKG5hbWUsIHZhbHVlKTtcbiAgICAgICAgdGhpcy5zZXRGaWVsZEVycm9yKG5hbWUsIGVycm9yKTtcbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7IGVycm9yczogeyAuLi50aGlzLnN0YXRlLmVycm9ycywgW25hbWVdOiBlcnJvciB9IH0pO1xuICAgIH1cbiAgICBwcml2YXRlIHNldEVycm9ycyhjdXJyZW50OiBWYWx1ZXMpIHtcbiAgICAgICAgY29uc3Qga2V5cyA9IE9iamVjdC5rZXlzKGN1cnJlbnQpO1xuICAgICAgICBjb25zdCBlcnJvcnMgPSB7IC4uLnRoaXMuc3RhdGUuZXJyb3JzIH07XG4gICAgICAgIGZvciAoY29uc3Qga2V5IG9mIGtleXMpIHtcbiAgICAgICAgICAgIGNvbnN0IHZhbHVlID0gY3VycmVudFtrZXldO1xuICAgICAgICAgICAgY29uc3QgZXJyb3IgPSB0aGlzLmdldEVycm9yKGtleSwgdmFsdWUpO1xuICAgICAgICAgICAgZXJyb3JzW2tleV0gPSBlcnJvcjtcbiAgICAgICAgICAgIHRoaXMuc2V0RmllbGRFcnJvcihrZXksIGVycm9yKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnNldFN0YXRlKHsgZXJyb3JzIH0pO1xuICAgIH1cbiAgICBwcml2YXRlIGNyZWF0ZUNvbnRleHQoKTogRm9ybUNvbnRleHRUeXBlIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIGNoYW5nZTogKGZpZWxkOiBGb3JtVmFsdWVDaGFuZ2UpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCB7IG9uQ2hhbmdlIH0gPSB0aGlzLnByb3BzO1xuICAgICAgICAgICAgICAgIGNvbnN0IHsgY29udHJvbGxlZCwgY3VycmVudCwgaW5pdGlhbCB9ID0gdGhpcy5zdGF0ZTtcbiAgICAgICAgICAgICAgICBjb25zdCBwcm9wb3NlZCA9IHtcbiAgICAgICAgICAgICAgICAgICAgLi4uY3VycmVudCxcbiAgICAgICAgICAgICAgICAgICAgW2ZpZWxkLm5hbWVdOiBmaWVsZC52YWx1ZSxcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIGNvbnN0IGNoYW5nZWQgPSBpc0NoYW5nZWQoaW5pdGlhbCwgcHJvcG9zZWQpO1xuICAgICAgICAgICAgICAgIGlmICghY29udHJvbGxlZCkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnNldFZhbHVlcyhwcm9wb3NlZCwgY2hhbmdlZCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHRoaXMuc2V0RXJyb3IoZmllbGQpO1xuICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygb25DaGFuZ2UgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgICAgICAgICAgICAgb25DaGFuZ2Uoe1xuICAgICAgICAgICAgICAgICAgICAgICAgY2hhbmdlZCxcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBwcm9wb3NlZCxcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHN1YnNjcmliZTogKGZpZWxkOiBGb3JtVmFsdWVOb3RpZmllcikgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IHsgY3VycmVudCwgZXJyb3JzID0ge30gfSA9IHRoaXMuc3RhdGU7XG4gICAgICAgICAgICAgICAgY29uc3QgeyBuYW1lIH0gPSBmaWVsZC5wcm9wcztcbiAgICAgICAgICAgICAgICBpZiAobmFtZSkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmZpZWxkcy5wdXNoKGZpZWxkKTtcbiAgICAgICAgICAgICAgICAgICAgbGV0IGVycm9yO1xuICAgICAgICAgICAgICAgICAgICBpZiAobmFtZSBpbiBjdXJyZW50KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB2YWx1ZSA9IGN1cnJlbnRbbmFtZV07XG4gICAgICAgICAgICAgICAgICAgICAgICBlcnJvciA9IHRoaXMuZ2V0RXJyb3IobmFtZSwgdmFsdWUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgZmllbGQuc2V0U3RhdGUoe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlLFxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB2YWx1ZSA9IGZpZWxkLnN0YXRlLnZhbHVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudFtuYW1lXSA9IHZhbHVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3IgPSB0aGlzLmdldEVycm9yKG5hbWUsIHZhbHVlKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAoZXJyb3IpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoeyBlcnJvcnM6IHsgLi4uZXJyb3JzLCBbbmFtZV06IGVycm9yIH0gYXMgRm9ybVN0YXRlPFZhbHVlcz5bJ2Vycm9ycyddIH0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHVuc3Vic2NyaWJlOiAoZmllbGQ6IEZvcm1WYWx1ZU5vdGlmaWVyKSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgaW5kZXggPSB0aGlzLmZpZWxkcy5pbmRleE9mKGZpZWxkKTtcbiAgICAgICAgICAgICAgICBpbmRleCA+PSAwICYmIHRoaXMuZmllbGRzLnNwbGljZShpbmRleCwgMSk7XG4gICAgICAgICAgICB9LFxuICAgICAgICB9O1xuICAgIH1cbiAgICBwcml2YXRlIHN1Ym1pdCA9IChlOiBSZWFjdC5Gb3JtRXZlbnQ8SFRNTEZvcm1FbGVtZW50PikgPT4ge1xuICAgICAgICBjb25zdCB7IG9uU3VibWl0LCBkaXNhYmxlZCB9ID0gdGhpcy5wcm9wcztcbiAgICAgICAgY29uc3QgeyBjdXJyZW50LCBjaGFuZ2VkLCBlcnJvcnMgfSA9IHRoaXMuc3RhdGU7XG4gICAgICAgIHRoaXMuc2V0RXJyb3JzKGN1cnJlbnQpO1xuICAgICAgICBpZiAoIWRpc2FibGVkICYmIHR5cGVvZiBvblN1Ym1pdCA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgICAgY29uc3QgYXJyYXlFcnJvcnMgPSBPYmplY3Qua2V5cyhlcnJvcnMpLnJlZHVjZTxBcnJheTxGb3JtVmFsaWRhdGlvbkVycm9yPj4oKGFycmF5RXJyb3JzLCBmaWVsZCkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IGVycm9yID0gZXJyb3JzW2ZpZWxkXTtcbiAgICAgICAgICAgICAgICBpZiAoZXJyb3IpIHtcbiAgICAgICAgICAgICAgICAgICAgYXJyYXlFcnJvcnMucHVzaCh7IGZpZWxkLCBlcnJvciB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIGFycmF5RXJyb3JzO1xuICAgICAgICAgICAgfSwgW10pO1xuICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICAgICAgY2hhbmdlZDogZmFsc2UsXG4gICAgICAgICAgICAgICAgaW5pdGlhbDogY3VycmVudCxcbiAgICAgICAgICAgIH0sICgpID0+IG9uU3VibWl0KHtcbiAgICAgICAgICAgICAgICBkYXRhOiBjdXJyZW50LFxuICAgICAgICAgICAgICAgIGVycm9yczogYXJyYXlFcnJvcnMsXG4gICAgICAgICAgICAgICAgY2hhbmdlZCxcbiAgICAgICAgICAgIH0pKTtcbiAgICAgICAgfVxuICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9O1xuICAgIHJlbmRlcigpIHtcbiAgICAgICAgY29uc3QgeyB2YWx1ZTogXzAsIGRlZmF1bHRWYWx1ZTogXzEsIG9uQ2hhbmdlOiBfMiwgb25TdWJtaXQ6IF8zLCBkaXNhYmxlZDogXzQsIGNoaWxkcmVuLCBwcm9tcHQsIC4uLnJlc3QgfSA9IHRoaXMucHJvcHM7XG4gICAgICAgIGNvbnN0IHsgY2hhbmdlZCB9ID0gdGhpcy5zdGF0ZTtcbiAgICAgICAgcmV0dXJuICg8U3R5bGVkRm9ybSB7Li4ucmVzdH0gb25TdWJtaXQ9e3RoaXMuc3VibWl0fT5cbiAgICAgICAge3Byb21wdCAmJiAodHlwZW9mIHByb21wdCA9PT0gJ2Z1bmN0aW9uJyA/IHByb21wdChjaGFuZ2VkKSA6IDxQcm9tcHQgd2hlbj17Y2hhbmdlZH0gbWVzc2FnZT17cHJvbXB0fS8+KX1cbiAgICAgICAgPEZvcm1Db250ZXh0LlByb3ZpZGVyIHZhbHVlPXt0aGlzLmN0eH0+e2NoaWxkcmVufTwvRm9ybUNvbnRleHQuUHJvdmlkZXI+XG4gICAgICA8L1N0eWxlZEZvcm0+KTtcbiAgICB9XG4gICAgc3RhdGljIGlubmVyID0ge1xuICAgICAgICBnZXQgU3R5bGVkRm9ybSgpIHsgcmV0dXJuIFN0eWxlZEZvcm0gYXMgdHlwZW9mIFN0eWxlZEZvcm07IH0sXG4gICAgICAgIGdldCBQcm9tcHQoKSB7IHJldHVybiBQcm9tcHQgYXMgdHlwZW9mIFByb21wdDsgfVxuICAgIH07XG59XG4iXX0=