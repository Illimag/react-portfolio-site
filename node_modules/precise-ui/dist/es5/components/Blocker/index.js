"use strict";
var __makeTemplateObject = (this && this.__makeTemplateObject) || function (cooked, raw) {
    if (Object.defineProperty) { Object.defineProperty(cooked, "raw", { value: raw }); } else { cooked.raw = raw; }
    return cooked;
};
var __extends = (this && this.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var __assign = (this && this.__assign) || function () {
    __assign = Object.assign || function(t) {
        for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
        }
        return t;
    };
    return __assign.apply(this, arguments);
};
var __rest = (this && this.__rest) || function (s, e) {
    var t = {};
    for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)
        t[p] = s[p];
    if (s != null && typeof Object.getOwnPropertySymbols === "function")
        for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) if (e.indexOf(p[i]) < 0)
            t[p[i]] = s[p[i]];
    return t;
};
Object.defineProperty(exports, "__esModule", { value: true });
var React = require("react");
var styled_1 = require("../../utils/styled");
var utils_1 = require("../../utils");
var colors_1 = require("../../colors");
var FixedContainer = styled_1.default.div(templateObject_1 || (templateObject_1 = __makeTemplateObject(["\n  top: 0;\n  left: 0;\n  right: 0;\n  bottom: 0;\n  position: fixed;\n  z-index: 10000;\n  overflow-x: hidden;\n  overflow-y: auto;\n"], ["\n  top: 0;\n  left: 0;\n  right: 0;\n  bottom: 0;\n  position: fixed;\n  z-index: 10000;\n  overflow-x: hidden;\n  overflow-y: auto;\n"])));
var FocusKeeper = styled_1.default.a(templateObject_2 || (templateObject_2 = __makeTemplateObject(["\n  height: 0;\n  width: 0;\n  overflow: hidden;\n"], ["\n  height: 0;\n  width: 0;\n  overflow: hidden;\n"])));
var StyledModalBackground = styled_1.default(FixedContainer)(templateObject_3 || (templateObject_3 = __makeTemplateObject(["\n  overflow: hidden;\n  z-index: 9999;\n  background: ", ";\n"], ["\n  overflow: hidden;\n  z-index: 9999;\n  background: ", ";\n"])), utils_1.transparentize(colors_1.dark, 0.4));
/**
 * Defines a generic content blocking overlay element, e.g., for a modal dialog.
 */
var Blocker = /** @class */ (function (_super) {
    __extends(Blocker, _super);
    function Blocker() {
        var _this = _super !== null && _super.apply(this, arguments) || this;
        _this.keepFirstFocus = function () {
            _this.keepFocus('first');
        };
        _this.keepLastFocus = function () {
            _this.keepFocus('last');
        };
        _this.setElement = function (node) {
            if (node && node !== _this.modalNode) {
                var el = node.querySelector('*[tabindex]');
                (el || node).focus();
            }
            _this.modalNode = node;
        };
        _this.onContainerClick = function (e) {
            e.stopPropagation();
            if (!_this.onScrollbarClick(e) &&
                (e.target === e.currentTarget || (e.target instanceof HTMLElement && e.target.parentElement === e.currentTarget))) {
                _this.notifyClose(e);
            }
        };
        _this.onScrollbarClick = function (e) {
            return e.target instanceof HTMLElement && e.target.offsetLeft + e.target.scrollWidth < e.clientX;
        };
        _this.onKeyPress = function (e) {
            if (e.keyCode === 27 /* escape */) {
                _this.notifyClose(e);
            }
        };
        return _this;
    }
    Blocker.prototype.getFocusables = function () {
        if (this.modalNode) {
            return this.modalNode.querySelectorAll('a[href], area[href], input:not([disabled]), select:not([disabled]), textarea:not([disabled]), button:not([disabled]), iframe, object, embed, *[tabindex], *[contenteditable]');
        }
        return undefined;
    };
    Blocker.prototype.componentDidMount = function () {
        this.changeBodyOverflow(true);
    };
    Blocker.prototype.componentWillUnmount = function () {
        this.changeBodyOverflow(false);
    };
    Blocker.prototype.changeBodyOverflow = function (open) {
        var body = document.querySelector('body');
        if (body) {
            if (open) {
                body.style.setProperty('overflow', 'hidden');
            }
            else {
                body.style.removeProperty('overflow');
            }
        }
    };
    Blocker.prototype.keepFocus = function (position) {
        var focusables = this.getFocusables();
        if (focusables && focusables.length > 2) {
            var nextElement = (position === 'first' ? focusables[1] : focusables[focusables.length - 2]);
            nextElement.focus();
        }
    };
    Blocker.prototype.notifyClose = function (e) {
        var onClose = this.props.onClose;
        if (typeof onClose === 'function') {
            onClose(e);
        }
    };
    Blocker.prototype.render = function () {
        var _a = this.props, children = _a.children, onClose = _a.onClose, props = __rest(_a, ["children", "onClose"]);
        return (React.createElement(React.Fragment, null,
            React.createElement(FixedContainer, __assign({ ref: this.setElement, onMouseDown: this.onContainerClick, onKeyDown: this.onKeyPress }, props),
                React.createElement(FocusKeeper, { href: "#", onFocus: this.keepLastFocus }),
                children,
                React.createElement(FocusKeeper, { href: "#", onFocus: this.keepFirstFocus })),
            React.createElement(StyledModalBackground, __assign({}, props))));
    };
    Blocker.inner = {
        get FixedContainer() { return FixedContainer; },
        get FocusKeeper() { return FocusKeeper; },
        get StyledModalBackground() { return StyledModalBackground; }
    };
    return Blocker;
}(React.Component));
exports.Blocker = Blocker;
var templateObject_1, templateObject_2, templateObject_3;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvY29tcG9uZW50cy9CbG9ja2VyL2luZGV4LnRzeCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSw2QkFBK0I7QUFDL0IsNkNBQXdDO0FBRXhDLHFDQUF1RDtBQUN2RCx1Q0FBb0M7QUFPcEMsSUFBTSxjQUFjLEdBQUcsZ0JBQU0sQ0FBQyxHQUFHLDRNQUFDLHlJQVNqQyxJQUFBLENBQUM7QUFDRixJQUFNLFdBQVcsR0FBRyxnQkFBTSxDQUFDLENBQUMsdUhBQUMsb0RBSTVCLElBQUEsQ0FBQztBQUNGLElBQU0scUJBQXFCLEdBQUcsZ0JBQU0sQ0FBQyxjQUFjLENBQUMsbUlBQUMseURBR3JDLEVBQXlCLEtBQ3hDLEtBRGUsc0JBQWMsQ0FBQyxhQUFJLEVBQUUsR0FBRyxDQUFDLENBQ3hDLENBQUM7QUFDRjs7R0FFRztBQUNIO0lBQTZCLDJCQUE2QjtJQUExRDtRQUFBLHFFQWtGQztRQWxEVyxvQkFBYyxHQUFHO1lBQ3JCLEtBQUksQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDNUIsQ0FBQyxDQUFDO1FBQ00sbUJBQWEsR0FBRztZQUNwQixLQUFJLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQzNCLENBQUMsQ0FBQztRQUNNLGdCQUFVLEdBQUcsVUFBQyxJQUEyQjtZQUM3QyxJQUFJLElBQUksSUFBSSxJQUFJLEtBQUssS0FBSSxDQUFDLFNBQVMsRUFBRTtnQkFDakMsSUFBTSxFQUFFLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxhQUFhLENBQWdCLENBQUM7Z0JBQzVELENBQUMsRUFBRSxJQUFJLElBQUksQ0FBQyxDQUFDLEtBQUssRUFBRSxDQUFDO2FBQ3hCO1lBQ0QsS0FBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUM7UUFDMUIsQ0FBQyxDQUFDO1FBT00sc0JB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QUUsSUFBSSxDQUFDLFVBQVUsSUFBTSxLQUFLO2dCQUM3RyxvQkFBQyxXQUFXLElBQUMsSUFBSSxFQUFDLEdBQUcsRUFBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLGFBQWEsR0FBRztnQkFDbkQsUUFBUTtnQkFDVCxvQkFBQyxXQUFXLElBQUMsSUFBSSxFQUFDLEdBQUcsRUFBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLGNBQWMsR0FBRyxDQUN0QztZQUNqQixvQkFBQyxxQkFBcUIsZUFBSyxLQUFLLEVBQUcsQ0FDbEMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQUNNLGFBQUssR0FBRztRQUNYLElBQUksY0FBYyxLQUFLLE9BQU8sY0FBdUMsQ0FBQyxDQUFDLENBQUM7UUFDeEUsSUFBSSxXQUFXLEtBQUssT0FBTyxXQUFpQyxDQUFDLENBQUMsQ0FBQztRQUMvRCxJQUFJLHFCQUFxQixLQUFLLE9BQU8scUJBQXFELENBQUMsQ0FBQyxDQUFDO0tBQ2hHLENBQUM7SUFDTixjQUFDO0NBQUEsQUFsRkQsQ0FBNkIsS0FBSyxDQUFDLFNBQVMsR0FrRjNDO0FBbEZZLDBCQUFPIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgUmVhY3QgZnJvbSAncmVhY3QnO1xuaW1wb3J0IHN0eWxlZCBmcm9tICcuLi8uLi91dGlscy9zdHlsZWQnO1xuaW1wb3J0IHsgU3RhbmRhcmRQcm9wcyB9IGZyb20gJy4uLy4uL2NvbW1vbic7XG5pbXBvcnQgeyBLZXlDb2RlcywgdHJhbnNwYXJlbnRpemUgfSBmcm9tICcuLi8uLi91dGlscyc7XG5pbXBvcnQgeyBkYXJrIH0gZnJvbSAnLi4vLi4vY29sb3JzJztcbmV4cG9ydCBpbnRlcmZhY2UgQmxvY2tlclByb3BzIGV4dGVuZHMgU3RhbmRhcmRQcm9wcyB7XG4gICAgLyoqXG4gICAgICogRXZlbnQgZW1pdHRlZCB3aGVuIHRoZSB1c2VyIHdhbnRzIHRvIHJlbW92ZSB0aGUgYmxvY2tlci5cbiAgICAgKi9cbiAgICBvbkNsb3NlPyhlOiBSZWFjdC5TeW50aGV0aWNFdmVudDxIVE1MRWxlbWVudD4pOiB2b2lkO1xufVxuY29uc3QgRml4ZWRDb250YWluZXIgPSBzdHlsZWQuZGl2IGBcbiAgdG9wOiAwO1xuICBsZWZ0OiAwO1xuICByaWdodDogMDtcbiAgYm90dG9tOiAwO1xuICBwb3NpdGlvbjogZml4ZWQ7XG4gIHotaW5kZXg6IDEwMDAwO1xuICBvdmVyZmxvdy14OiBoaWRkZW47XG4gIG92ZXJmbG93LXk6IGF1dG87XG5gO1xuY29uc3QgRm9jdXNLZWVwZXIgPSBzdHlsZWQuYSBgXG4gIGhlaWdodDogMDtcbiAgd2lkdGg6IDA7XG4gIG92ZXJmbG93OiBoaWRkZW47XG5gO1xuY29uc3QgU3R5bGVkTW9kYWxCYWNrZ3JvdW5kID0gc3R5bGVkKEZpeGVkQ29udGFpbmVyKSBgXG4gIG92ZXJmbG93OiBoaWRkZW47XG4gIHotaW5kZXg6IDk5OTk7XG4gIGJhY2tncm91bmQ6ICR7dHJhbnNwYXJlbnRpemUoZGFyaywgMC40KX07XG5gO1xuLyoqXG4gKiBEZWZpbmVzIGEgZ2VuZXJpYyBjb250ZW50IGJsb2NraW5nIG92ZXJsYXkgZWxlbWVudCwgZS5nLiwgZm9yIGEgbW9kYWwgZGlhbG9nLlxuICovXG5leHBvcnQgY2xhc3MgQmxvY2tlciBleHRlbmRzIFJlYWN0LkNvbXBvbmVudDxCbG9ja2VyUHJvcHM+IHtcbiAgICBwcml2YXRlIG1vZGFsTm9kZTogSFRNTERpdkVsZW1lbnQgfCBudWxsO1xuICAgIHByaXZhdGUgZ2V0Rm9jdXNhYmxlcygpOiBOb2RlTGlzdE9mPEVsZW1lbnQ+IHwgdW5kZWZpbmVkIHtcbiAgICAgICAgaWYgKHRoaXMubW9kYWxOb2RlKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5tb2RhbE5vZGUucXVlcnlTZWxlY3RvckFsbCgnYVtocmVmXSwgYXJlYVtocmVmXSwgaW5wdXQ6bm90KFtkaXNhYmxlZF0pLCBzZWxlY3Q6bm90KFtkaXNhYmxlZF0pLCB0ZXh0YXJlYTpub3QoW2Rpc2FibGVkXSksIGJ1dHRvbjpub3QoW2Rpc2FibGVkXSksIGlmcmFtZSwgb2JqZWN0LCBlbWJlZCwgKlt0YWJpbmRleF0sICpbY29udGVudGVkaXRhYmxlXScpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfVxuICAgIGNvbXBvbmVudERpZE1vdW50KCkge1xuICAgICAgICB0aGlzLmNoYW5nZUJvZHlPdmVyZmxvdyh0cnVlKTtcbiAgICB9XG4gICAgY29tcG9uZW50V2lsbFVubW91bnQoKSB7XG4gICAgICAgIHRoaXMuY2hhbmdlQm9keU92ZXJmbG93KGZhbHNlKTtcbiAgICB9XG4gICAgcHJpdmF0ZSBjaGFuZ2VCb2R5T3ZlcmZsb3cob3BlbjogYm9vbGVhbikge1xuICAgICAgICBjb25zdCBib2R5ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignYm9keScpO1xuICAgICAgICBpZiAoYm9keSkge1xuICAgICAgICAgICAgaWYgKG9wZW4pIHtcbiAgICAgICAgICAgICAgICBib2R5LnN0eWxlLnNldFByb3BlcnR5KCdvdmVyZmxvdycsICdoaWRkZW4nKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIGJvZHkuc3R5bGUucmVtb3ZlUHJvcGVydHkoJ292ZXJmbG93Jyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgcHJpdmF0ZSBrZWVwRm9jdXMocG9zaXRpb246ICdmaXJzdCcgfCAnbGFzdCcpIHtcbiAgICAgICAgY29uc3QgZm9jdXNhYmxlcyA9IHRoaXMuZ2V0Rm9jdXNhYmxlcygpO1xuICAgICAgICBpZiAoZm9jdXNhYmxlcyAmJiBmb2N1c2FibGVzLmxlbmd0aCA+IDIpIHtcbiAgICAgICAgICAgIGNvbnN0IG5leHRFbGVtZW50ID0gKHBvc2l0aW9uID09PSAnZmlyc3QnID8gZm9jdXNhYmxlc1sxXSA6IGZvY3VzYWJsZXNbZm9jdXNhYmxlcy5sZW5ndGggLSAyXSkgYXMgSFRNTEVsZW1lbnQ7XG4gICAgICAgICAgICBuZXh0RWxlbWVudC5mb2N1cygpO1xuICAgICAgICB9XG4gICAgfVxuICAgIHByaXZhdGUga2VlcEZpcnN0Rm9jdXMgPSAoKSA9PiB7XG4gICAgICAgIHRoaXMua2VlcEZvY3VzKCdmaXJzdCcpO1xuICAgIH07XG4gICAgcHJpdmF0ZSBrZWVwTGFzdEZvY3VzID0gKCkgPT4ge1xuICAgICAgICB0aGlzLmtlZXBGb2N1cygnbGFzdCcpO1xuICAgIH07XG4gICAgcHJpdmF0ZSBzZXRFbGVtZW50ID0gKG5vZGU6IEhUTUxEaXZFbGVtZW50IHwgbnVsbCkgPT4ge1xuICAgICAgICBpZiAobm9kZSAmJiBub2RlICE9PSB0aGlzLm1vZGFsTm9kZSkge1xuICAgICAgICAgICAgY29uc3QgZWwgPSBub2RlLnF1ZXJ5U2VsZWN0b3IoJypbdGFiaW5kZXhdJykgYXMgSFRNTEVsZW1lbnQ7XG4gICAgICAgICAgICAoZWwgfHwgbm9kZSkuZm9jdXMoKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLm1vZGFsTm9kZSA9IG5vZGU7XG4gICAgfTtcbiAgICBwcml2YXRlIG5vdGlmeUNsb3NlKGU6IFJlYWN0LlN5bnRoZXRpY0V2ZW50PEhUTUxFbGVtZW50Pikge1xuICAgICAgICBjb25zdCB7IG9uQ2xvc2UgfSA9IHRoaXMucHJvcHM7XG4gICAgICAgIGlmICh0eXBlb2Ygb25DbG9zZSA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgICAgb25DbG9zZShlKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBwcml2YXRlIG9uQ29udGFpbmVyQ2xpY2sgPSAoZTogUmVhY3QuTW91c2VFdmVudDxIVE1MRWxlbWVudD4pID0+IHtcbiAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgaWYgKCF0aGlzLm9uU2Nyb2xsYmFyQ2xpY2soZSkgJiZcbiAgICAgICAgICAgIChlLnRhcmdldCA9PT0gZS5jdXJyZW50VGFyZ2V0IHx8IChlLnRhcmdldCBpbnN0YW5jZW9mIEhUTUxFbGVtZW50ICYmIGUudGFyZ2V0LnBhcmVudEVsZW1lbnQgPT09IGUuY3VycmVudFRhcmdldCkpKSB7XG4gICAgICAgICAgICB0aGlzLm5vdGlmeUNsb3NlKGUpO1xuICAgICAgICB9XG4gICAgfTtcbiAgICBwcml2YXRlIG9uU2Nyb2xsYmFyQ2xpY2sgPSAoZTogUmVhY3QuTW91c2VFdmVudDxIVE1MRWxlbWVudD4pID0+IHtcbiAgICAgICAgcmV0dXJuIGUudGFyZ2V0IGluc3RhbmNlb2YgSFRNTEVsZW1lbnQgJiYgZS50YXJnZXQub2Zmc2V0TGVmdCArIGUudGFyZ2V0LnNjcm9sbFdpZHRoIDwgZS5jbGllbnRYO1xuICAgIH07XG4gICAgcHJpdmF0ZSBvbktleVByZXNzID0gKGU6IFJlYWN0LktleWJvYXJkRXZlbnQ8SFRNTEVsZW1lbnQ+KSA9PiB7XG4gICAgICAgIGlmIChlLmtleUNvZGUgPT09IEtleUNvZGVzLmVzY2FwZSkge1xuICAgICAgICAgICAgdGhpcy5ub3RpZnlDbG9zZShlKTtcbiAgICAgICAgfVxuICAgIH07XG4gICAgcmVuZGVyKCkge1xuICAgICAgICBjb25zdCB7IGNoaWxkcmVuLCBvbkNsb3NlLCAuLi5wcm9wcyB9ID0gdGhpcy5wcm9wcztcbiAgICAgICAgcmV0dXJuICg8PlxuICAgICAgICA8Rml4ZWRDb250YWluZXIgcmVmPXt0aGlzLnNldEVsZW1lbnR9IG9uTW91c2VEb3duPXt0aGlzLm9uQ29udGFpbmVyQ2xpY2t9IG9uS2V5RG93bj17dGhpcy5vbktleVByZXNzfSB7Li4ucHJvcHN9PlxuICAgICAgICAgIDxGb2N1c0tlZXBlciBocmVmPVwiI1wiIG9uRm9jdXM9e3RoaXMua2VlcExhc3RGb2N1c30vPlxuICAgICAgICAgIHtjaGlsZHJlbn1cbiAgICAgICAgICA8Rm9jdXNLZWVwZXIgaHJlZj1cIiNcIiBvbkZvY3VzPXt0aGlzLmtlZXBGaXJzdEZvY3VzfS8+XG4gICAgICAgIDwvRml4ZWRDb250YWluZXI+XG4gICAgICAgIDxTdHlsZWRNb2RhbEJhY2tncm91bmQgey4uLnByb3BzfS8+XG4gICAgICA8Lz4pO1xuICAgIH1cbiAgICBzdGF0aWMgaW5uZXIgPSB7XG4gICAgICAgIGdldCBGaXhlZENvbnRhaW5lcigpIHsgcmV0dXJuIEZpeGVkQ29udGFpbmVyIGFzIHR5cGVvZiBGaXhlZENvbnRhaW5lcjsgfSxcbiAgICAgICAgZ2V0IEZvY3VzS2VlcGVyKCkgeyByZXR1cm4gRm9jdXNLZWVwZXIgYXMgdHlwZW9mIEZvY3VzS2VlcGVyOyB9LFxuICAgICAgICBnZXQgU3R5bGVkTW9kYWxCYWNrZ3JvdW5kKCkgeyByZXR1cm4gU3R5bGVkTW9kYWxCYWNrZ3JvdW5kIGFzIHR5cGVvZiBTdHlsZWRNb2RhbEJhY2tncm91bmQ7IH1cbiAgICB9O1xufVxuIl19