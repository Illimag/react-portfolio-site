"use strict";
var __extends = (this && this.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var __assign = (this && this.__assign) || function () {
    __assign = Object.assign || function(t) {
        for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
        }
        return t;
    };
    return __assign.apply(this, arguments);
};
var __rest = (this && this.__rest) || function (s, e) {
    var t = {};
    for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)
        t[p] = s[p];
    if (s != null && typeof Object.getOwnPropertySymbols === "function")
        for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) if (e.indexOf(p[i]) < 0)
            t[p[i]] = s[p[i]];
    return t;
};
Object.defineProperty(exports, "__esModule", { value: true });
var React = require("react");
/**
 * The functional component to handle tabs.
 * DEPRECATED: Please use `withTabControl` instead.
 * @deprecated
 */
var TabControl = /** @class */ (function (_super) {
    __extends(TabControl, _super);
    function TabControl(props) {
        var _this = _super.call(this, props) || this;
        _this.selects = [];
        _this.changeIndex = function (target) {
            var change = _this.props.onTabChange;
            if (typeof change === 'function') {
                change({
                    previousIndex: _this.state.selectedIndex,
                    selectedIndex: target,
                });
            }
            if (!_this.state.controlled) {
                _this.setState({
                    selectedIndex: target,
                });
            }
        };
        _this.state = {
            selectedIndex: props.selectedIndex || props.defaultIndex || 0,
            controlled: props.selectedIndex !== undefined,
        };
        return _this;
    }
    TabControl.prototype.UNSAFE_componentWillReceiveProps = function (nextProps) {
        var selectedIndex = nextProps.selectedIndex;
        if (this.state.controlled && typeof selectedIndex === 'number') {
            this.setState({
                selectedIndex: selectedIndex,
            });
        }
    };
    TabControl.prototype.render = function () {
        var _this = this;
        var selectedIndex = this.state.selectedIndex;
        var _a = this.props, children = _a.children, render = _a.render;
        var items = [];
        var selects = this.selects;
        React.Children.forEach(children, function (element, index) {
            if (element && React.isValidElement(element)) {
                var active = index === selectedIndex;
                if (selects[index] === undefined) {
                    selects[index] = function () { return _this.changeIndex(index); };
                }
                items.push({
                    onSelect: selects[index],
                    active: active,
                    element: element,
                });
            }
        });
        return render(items);
    };
    return TabControl;
}(React.PureComponent));
exports.TabControl = TabControl;
function isTabPage(child) {
    return !!child;
}
function useTabControl(_a) {
    var children = _a.children, selectedIndex = _a.selectedIndex, defaultIndex = _a.defaultIndex, onTabChange = _a.onTabChange;
    var controlled = React.useState(selectedIndex !== undefined)[0];
    var _b = React.useState(selectedIndex || defaultIndex || 0), activeTabIndex = _b[0], setActiveTabIndex = _b[1];
    React.useEffect(function () {
        if (controlled && typeof selectedIndex === 'number') {
            setActiveTabIndex(selectedIndex);
        }
    }, [selectedIndex]);
    var elements = React.useMemo(function () { return (React.Children.map(children, function (child) { return (React.isValidElement(child) ? child : undefined); }) || []).filter(isTabPage); }, [children]);
    var headers = React.useMemo(function () { return elements.map(function (child) { return child.props.header; }); }, [elements]);
    var onSelect = React.useCallback(function (selectedIndex) {
        setActiveTabIndex(function (previousIndex) {
            if (typeof onTabChange === 'function') {
                onTabChange({
                    previousIndex: previousIndex,
                    selectedIndex: selectedIndex,
                });
            }
            return controlled ? previousIndex : selectedIndex;
        });
    }, [onTabChange, controlled]);
    return {
        elements: elements,
        headers: headers,
        activeTabIndex: activeTabIndex,
        onSelect: onSelect,
        isActive: function (index) {
            return activeTabIndex === index;
        },
    };
}
function withTabControl(Component) {
    var TabControl = Object.assign((function (_a) {
        var children = _a.children, Element = _a.tabItemRenderer, rest = __rest(_a, ["children", "tabItemRenderer"]);
        var _b = useTabControl(__assign({ children: children }, rest)), elements = _b.elements, headers = _b.headers, activeTabIndex = _b.activeTabIndex, isActive = _b.isActive, onSelect = _b.onSelect;
        return (React.createElement(Component, __assign({}, rest, { headers: headers, activeIndex: activeTabIndex, onSelect: onSelect }), elements.map(function (child, i) { return (React.createElement(Element, { key: "item-" + i, active: isActive(i) }, child)); })));
    }), { inner: {
            get Component() { return Component; }
        } });
    return TabControl;
}
exports.withTabControl = withTabControl;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvY29tcG9uZW50cy9UYWJDb250cm9sL2luZGV4LnRzeCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLDZCQUErQjtBQWdFL0I7Ozs7R0FJRztBQUNIO0lBQWdDLDhCQUFxRDtJQUVqRixvQkFBWSxLQUFzQjtRQUFsQyxZQUNJLGtCQUFNLEtBQUssQ0FBQyxTQUtmO1FBUE8sYUFBTyxHQUFzQixFQUFFLENBQUM7UUFnQmhDLGlCQUFXLEdBQUcsVUFBQyxNQUFjO1lBQ2pDLElBQU0sTUFBTSxHQUFHLEtBQUksQ0FBQyxLQUFLLENBQUMsV0FBVyxDQUFDO1lBQ3RDLElBQUksT0FBTyxNQUFNLEtBQUssVUFBVSxFQUFFO2dCQUM5QixNQUFNLENBQUM7b0JBQ0gsYUFBYSxFQUFFLEtBQUksQ0FBQyxLQUFLLENBQUMsYUFBYTtvQkFDdkMsYUFBYSxFQUFFLE1BQU07aUJBQ3hCLENBQUMsQ0FBQzthQUNOO1lBQ0QsSUFBSSxDQUFDLEtBQUksQ0FBQyxLQUFLLENBQUMsVUFBVSxFQUFFO2dCQUN4QixLQUFJLENBQUMsUUFBUSxDQUFDO29CQUNWLGFBQWEsRUFBRSxNQUFNO2lCQUN4QixDQUFDLENBQUM7YUFDTjtRQUNMLENBQUMsQ0FBQztRQTFCRSxLQUFJLENBQUMsS0FBSyxHQUFHO1lBQ1QsYUFBYSxFQUFFLEtBQUssQ0FBQyxhQUFhLElBQUksS0FBSyxDQUFDLFlBQVksSUFBSSxDQUFDO1lBQzdELFVBQVUsRUFBRSxLQUFLLENBQUMsYUFBYSxLQUFLLFNBQVM7U0FDaEQsQ0FBQzs7SUFDTixDQUFDO0lBQ0QscURBQWdDLEdBQWhDLFVBQWlDLFNBQTBCO1FBQ3ZELElBQU0sYUFBYSxHQUFHLFNBQVMsQ0FBQyxhQUFhLENBQUM7UUFDOUMsSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLFVBQVUsSUFBSSxPQUFP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NkIsQ0FBQyxDQUFDLENBQUM7U0FDNUQsRUFBRSxDQUFDLENBQUM7SUFDVCxPQUFPLFVBQVUsQ0FBQztBQUN0QixDQUFDO0FBZkQsd0NBZUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBSZWFjdCBmcm9tICdyZWFjdCc7XG5pbXBvcnQgeyBUYWJQYWdlUHJvcHMgfSBmcm9tICcuLi9UYWJQYWdlJztcbmltcG9ydCB7IE9taXQgfSBmcm9tICcuLi8uLi9jb21tb24nO1xuaW1wb3J0IHsgVGFiSXRlbVByb3BzIH0gZnJvbSAnLi4vQ29udGVudFN3aXRjaC9Db250ZW50U3dpdGNoLnBhcnQnO1xuZXhwb3J0IGludGVyZmFjZSBUYWJDb250cm9sSXRlbSB7XG4gICAgLyoqXG4gICAgICogVGhlIGVsZW1lbnQgdG8gYmUgc2hvd24uXG4gICAgICovXG4gICAgZWxlbWVudDogUmVhY3QuUmVhY3ROb2RlO1xuICAgIC8qKlxuICAgICAqIEdldHMgaWYgdGhlIGl0ZW0gaXMgY3VycmVudGx5IGFjdGl2ZS5cbiAgICAgKi9cbiAgICBhY3RpdmU6IGJvb2xlYW47XG4gICAgLyoqXG4gICAgICogQ2FsbGJhY2sgdG8gdXNlIHdoZW4gdGhlIGl0ZW0gc2hvdWxkIGJlIGFjdGl2ZS5cbiAgICAgKi9cbiAgICBvblNlbGVjdCgpOiB2b2lkO1xufVxuZXhwb3J0IGludGVyZmFjZSBUYWJDaGFuZ2VFdmVudCB7XG4gICAgLyoqXG4gICAgICogVGhlIHByZXZpb3VzbHkgc2VsZWN0ZWQgdGFiIC8gaW5kZXguXG4gICAgICovXG4gICAgcHJldmlvdXNJbmRleDogbnVtYmVyO1xuICAgIC8qKlxuICAgICAqIFRoZSBjdXJyZW50bHkgc2VsZWN0ZWQgdGFiIC8gaW5kZXguXG4gICAgICovXG4gICAgc2VsZWN0ZWRJbmRleDogbnVtYmVyO1xufVxuZXhwb3J0IGludGVyZmFjZSBUYWJPcHRpb25zIHtcbiAgICAvKipcbiAgICAgKiBUaGUgZGVmYXVsdCBpbmRleCAtIG9ubHkgc2V0IGZvciB1c2UgaW4gYXV0b21hdGljIG1vZGUuXG4gICAgICovXG4gICAgZGVmYXVsdEluZGV4PzogbnVtYmVyO1xuICAgIC8qKlxuICAgICAqIFRoZSBjdXJyZW50bHkgc2VsZWN0ZWQgaW5kZXggLSB1c2VkIGluIHRoZSBjb250cm9sbGVkIG1vZGUuXG4gICAgICovXG4gICAgc2VsZWN0ZWRJbmRleD86IG51bWJlcjtcbiAgICAvKipcbiAgICAgKiBOb3RpZmljYXRpb24gY2FsbGJhY2sgaWYgdGhlIHNlbGVjdGVkIHRhYiBpbmRleCBzaG91bGQgY2hhbmdlLlxuICAgICAqL1xuICAgIG9uVGFiQ2hhbmdlPyhlOiBUYWJDaGFuZ2VFdmVudCk6IHZvaWQ7XG59XG4vKipcbiAqIEBkZXByZWNhdGVkXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgVGFiQ29udHJvbFByb3BzIGV4dGVuZHMgVGFiT3B0aW9ucyB7XG4gICAgLyoqXG4gICAgICogVGhlIGNoaWxkcmVuLCB1c3VhbGx5IHBhc3NlZCBhcyBhIGNvbGxlY3Rpb24gb2YgVGFiUGFnZSBlbGVtZW50cy5cbiAgICAgKi9cbiAgICByZW5kZXIoaXRlbXM6IEFycmF5PFRhYkNvbnRyb2xJdGVtPik6IFJlYWN0LlJlYWN0Tm9kZTtcbn1cbi8qKlxuICogQGRlcHJlY2F0ZWRcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBUYWJDb250cm9sU3RhdGUge1xuICAgIC8qKlxuICAgICAqIFRoZSBjdXJyZW50bHkgc2VsZWN0ZWQgaW5kZXguXG4gICAgICovXG4gICAgc2VsZWN0ZWRJbmRleDogbnVtYmVyO1xuICAgIC8qKlxuICAgICAqIERldGVybWluZXMgaWYgdGhlIHRhYiBjb21wb25lbnQgaXMgY29udHJvbGxlZCBmcm9tIHRoZSBvdXRzaWRlIG9yIG5vdC5cbiAgICAgKi9cbiAgICBjb250cm9sbGVkOiBib29sZWFuO1xufVxuLyoqXG4gKiBUaGUgZnVuY3Rpb25hbCBjb21wb25lbnQgdG8gaGFuZGxlIHRhYnMuXG4gKiBERVBSRUNBVEVEOiBQbGVhc2UgdXNlIGB3aXRoVGFiQ29udHJvbGAgaW5zdGVhZC5cbiAqIEBkZXByZWNhdGVkXG4gKi9cbmV4cG9ydCBjbGFzcyBUYWJDb250cm9sIGV4dGVuZHMgUmVhY3QuUHVyZUNvbXBvbmVudDxUYWJDb250cm9sUHJvcHMsIFRhYkNvbnRyb2xTdGF0ZT4ge1xuICAgIHByaXZhdGUgc2VsZWN0czogQXJyYXk8KCkgPT4gdm9pZD4gPSBbXTtcbiAgICBjb25zdHJ1Y3Rvcihwcm9wczogVGFiQ29udHJvbFByb3BzKSB7XG4gICAgICAgIHN1cGVyKHByb3BzKTtcbiAgICAgICAgdGhpcy5zdGF0ZSA9IHtcbiAgICAgICAgICAgIHNlbGVjdGVkSW5kZXg6IHByb3BzLnNlbGVjdGVkSW5kZXggfHwgcHJvcHMuZGVmYXVsdEluZGV4IHx8IDAsXG4gICAgICAgICAgICBjb250cm9sbGVkOiBwcm9wcy5zZWxlY3RlZEluZGV4ICE9PSB1bmRlZmluZWQsXG4gICAgICAgIH07XG4gICAgfVxuICAgIFVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzKG5leHRQcm9wczogVGFiQ29udHJvbFByb3BzKSB7XG4gICAgICAgIGNvbnN0IHNlbGVjdGVkSW5kZXggPSBuZXh0UHJvcHMuc2VsZWN0ZWRJbmRleDtcbiAgICAgICAgaWYgKHRoaXMuc3RhdGUuY29udHJvbGxlZCAmJiB0eXBlb2Ygc2VsZWN0ZWRJbmRleCA9PT0gJ251bWJlcicpIHtcbiAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgICAgIHNlbGVjdGVkSW5kZXgsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBwcml2YXRlIGNoYW5nZUluZGV4ID0gKHRhcmdldDogbnVtYmVyKSA9PiB7XG4gICAgICAgIGNvbnN0IGNoYW5nZSA9IHRoaXMucHJvcHMub25UYWJDaGFuZ2U7XG4gICAgICAgIGlmICh0eXBlb2YgY2hhbmdlID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICBjaGFuZ2Uoe1xuICAgICAgICAgICAgICAgIHByZXZpb3VzSW5kZXg6IHRoaXMuc3RhdGUuc2VsZWN0ZWRJbmRleCxcbiAgICAgICAgICAgICAgICBzZWxlY3RlZEluZGV4OiB0YXJnZXQsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoIXRoaXMuc3RhdGUuY29udHJvbGxlZCkge1xuICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICAgICAgc2VsZWN0ZWRJbmRleDogdGFyZ2V0LFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9O1xuICAgIHJlbmRlcigpIHtcbiAgICAgICAgY29uc3Qgc2VsZWN0ZWRJbmRleCA9IHRoaXMuc3RhdGUuc2VsZWN0ZWRJbmRleDtcbiAgICAgICAgY29uc3QgeyBjaGlsZHJlbiwgcmVuZGVyIH0gPSB0aGlzLnByb3BzO1xuICAgICAgICBjb25zdCBpdGVtczogQXJyYXk8VGFiQ29udHJvbEl0ZW0+ID0gW107XG4gICAgICAgIGNvbnN0IHNlbGVjdHMgPSB0aGlzLnNlbGVjdHM7XG4gICAgICAgIFJlYWN0LkNoaWxkcmVuLmZvckVhY2goY2hpbGRyZW4sIChlbGVtZW50OiBSZWFjdC5SZWFjdEVsZW1lbnQ8YW55PiwgaW5kZXgpID0+IHtcbiAgICAgICAgICAgIGlmIChlbGVtZW50ICYmIFJlYWN0LmlzVmFsaWRFbGVtZW50KGVsZW1lbnQpKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgYWN0aXZlID0gaW5kZXggPT09IHNlbGVjdGVkSW5kZXg7XG4gICAgICAgICAgICAgICAgaWYgKHNlbGVjdHNbaW5kZXhdID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgc2VsZWN0c1tpbmRleF0gPSAoKSA9PiB0aGlzLmNoYW5nZUluZGV4KGluZGV4KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaXRlbXMucHVzaCh7XG4gICAgICAgICAgICAgICAgICAgIG9uU2VsZWN0OiBzZWxlY3RzW2luZGV4XSxcbiAgICAgICAgICAgICAgICAgICAgYWN0aXZlLFxuICAgICAgICAgICAgICAgICAgICBlbGVtZW50LFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIHJlbmRlcihpdGVtcyk7XG4gICAgfVxufVxuZnVuY3Rpb24gaXNUYWJQYWdlKGNoaWxkOiBSZWFjdC5SZWFjdEVsZW1lbnQ8VGFiUGFnZVByb3BzPik6IGNoaWxkIGlzIFJlYWN0LlJlYWN0RWxlbWVudDxUYWJQYWdlUHJvcHM+IHtcbiAgICByZXR1cm4gISFjaGlsZDtcbn1cbmludGVyZmFjZSBVc2VUYWJTd2l0Y2hlclBhcmFtcyB7XG4gICAgY2hpbGRyZW46IFJlYWN0LlJlYWN0Tm9kZTtcbiAgICBzZWxlY3RlZEluZGV4PzogbnVtYmVyO1xuICAgIGRlZmF1bHRJbmRleD86IG51bWJlcjtcbiAgICBvblRhYkNoYW5nZT8oZTogVGFiQ2hhbmdlRXZlbnQpOiB2b2lkO1xufVxuZnVuY3Rpb24gdXNlVGFiQ29udHJvbCh7IGNoaWxkcmVuLCBzZWxlY3RlZEluZGV4LCBkZWZhdWx0SW5kZXgsIG9uVGFiQ2hhbmdlIH06IFVzZVRhYlN3aXRjaGVyUGFyYW1zKSB7XG4gICAgY29uc3QgW2NvbnRyb2xsZWRdID0gUmVhY3QudXNlU3RhdGUoc2VsZWN0ZWRJbmRleCAhPT0gdW5kZWZpbmVkKTtcbiAgICBjb25zdCBbYWN0aXZlVGFiSW5kZXgsIHNldEFjdGl2ZVRhYkluZGV4XSA9IFJlYWN0LnVzZVN0YXRlKHNlbGVjdGVkSW5kZXggfHwgZGVmYXVsdEluZGV4IHx8IDApO1xuICAgIFJlYWN0LnVzZUVmZmVjdCgoKSA9PiB7XG4gICAgICAgIGlmIChjb250cm9sbGVkICYmIHR5cGVvZiBzZWxlY3RlZEluZGV4ID09PSAnbnVtYmVyJykge1xuICAgICAgICAgICAgc2V0QWN0aXZlVGFiSW5kZXgoc2VsZWN0ZWRJbmRleCk7XG4gICAgICAgIH1cbiAgICB9LCBbc2VsZWN0ZWRJbmRleF0pO1xuICAgIGNvbnN0IGVsZW1lbnRzID0gUmVhY3QudXNlTWVtbygoKSA9PiAoUmVhY3QuQ2hpbGRyZW4ubWFwKGNoaWxkcmVuLCBjaGlsZCA9PiAoUmVhY3QuaXNWYWxpZEVsZW1lbnQoY2hpbGQpID8gY2hpbGQgOiB1bmRlZmluZWQpKSB8fCBbXSkuZmlsdGVyKGlzVGFiUGFnZSksIFtjaGlsZHJlbl0pO1xuICAgIGNvbnN0IGhlYWRlcnMgPSBSZWFjdC51c2VNZW1vKCgpID0+IGVsZW1lbnRzLm1hcChjaGlsZCA9PiBjaGlsZC5wcm9wcy5oZWFkZXIpLCBbZWxlbWVudHNdKTtcbiAgICBjb25zdCBvblNlbGVjdCA9IFJlYWN0LnVzZUNhbGxiYWNrKChzZWxlY3RlZEluZGV4OiBudW1iZXIpID0+IHtcbiAgICAgICAgc2V0QWN0aXZlVGFiSW5kZXgocHJldmlvdXNJbmRleCA9PiB7XG4gICAgICAgICAgICBpZiAodHlwZW9mIG9uVGFiQ2hhbmdlID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICAgICAgb25UYWJDaGFuZ2Uoe1xuICAgICAgICAgICAgICAgICAgICBwcmV2aW91c0luZGV4LFxuICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZEluZGV4LFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIGNvbnRyb2xsZWQgPyBwcmV2aW91c0luZGV4IDogc2VsZWN0ZWRJbmRleDtcbiAgICAgICAgfSk7XG4gICAgfSwgW29uVGFiQ2hhbmdlLCBjb250cm9sbGVkXSk7XG4gICAgcmV0dXJuIHtcbiAgICAgICAgZWxlbWVudHMsXG4gICAgICAgIGhlYWRlcnMsXG4gICAgICAgIGFjdGl2ZVRhYkluZGV4LFxuICAgICAgICBvblNlbGVjdCxcbiAgICAgICAgaXNBY3RpdmUoaW5kZXg6IG51bWJlcikge1xuICAgICAgICAgICAgcmV0dXJuIGFjdGl2ZVRhYkluZGV4ID09PSBpbmRleDtcbiAgICAgICAgfSxcbiAgICB9O1xufVxuZXhwb3J0IGludGVyZmFjZSBUYWJDb250cm9sSG9sZGVyUHJvcHMge1xuICAgIGhlYWRlcnM6IEFycmF5PFJlYWN0LlJlYWN0Q2hpbGQ+O1xuICAgIGFjdGl2ZUluZGV4PzogbnVtYmVyO1xuICAgIG9uU2VsZWN0KGluZGV4OiBudW1iZXIpOiB2b2lkO1xufVxuZXhwb3J0IGludGVyZmFjZSBXaXRoVGFiQ29udHJvbFByb3BzIHtcbiAgICB0YWJJdGVtUmVuZGVyZXI6IFJlYWN0LkVsZW1lbnRUeXBlPFRhYkl0ZW1Qcm9wcz47XG59XG5leHBvcnQgZnVuY3Rpb24gd2l0aFRhYkNvbnRyb2w8VCBleHRlbmRzIFRhYkNvbnRyb2xIb2xkZXJQcm9wcz4oQ29tcG9uZW50OiBSZWFjdC5Db21wb25lbnRUeXBlPFQ+KSB7XG4gICAgY29uc3QgVGFiQ29udHJvbCA9IE9iamVjdC5hc3NpZ24oKCgoeyBjaGlsZHJlbiwgdGFiSXRlbVJlbmRlcmVyOiBFbGVtZW50LCAuLi5yZXN0IH0pID0+IHtcbiAgICAgICAgY29uc3QgeyBlbGVtZW50cywgaGVhZGVycywgYWN0aXZlVGFiSW5kZXgsIGlzQWN0aXZlLCBvblNlbGVjdCB9ID0gdXNlVGFiQ29udHJvbCh7XG4gICAgICAgICAgICBjaGlsZHJlbixcbiAgICAgICAgICAgIC4uLnJlc3QsXG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gKDxDb21wb25lbnQgey4uLnJlc3QgYXMgYW55fSBoZWFkZXJzPXtoZWFkZXJzfSBhY3RpdmVJbmRleD17YWN0aXZlVGFiSW5kZXh9IG9uU2VsZWN0PXtvblNlbGVjdH0+XG4gICAgICAgIHtlbGVtZW50cy5tYXAoKGNoaWxkLCBpKSA9PiAoPEVsZW1lbnQga2V5PXtgaXRlbS0ke2l9YH0gYWN0aXZlPXtpc0FjdGl2ZShpKX0+XG4gICAgICAgICAgICB7Y2hpbGR9XG4gICAgICAgICAgPC9FbGVtZW50PikpfVxuICAgICAgPC9Db21wb25lbnQ+KTtcbiAgICB9KSBhcyBSZWFjdC5GQzxUYWJPcHRpb25zICYgV2l0aFRhYkNvbnRyb2xQcm9wcyAmIE9taXQ8VCwga2V5b2YgVGFiQ29udHJvbEhvbGRlclByb3BzPj4pLCB7IGlubmVyOiB7XG4gICAgICAgICAgICBnZXQgQ29tcG9uZW50KCkgeyByZXR1cm4gQ29tcG9uZW50IGFzIHR5cGVvZiBDb21wb25lbnQ7IH1cbiAgICAgICAgfSB9KTtcbiAgICByZXR1cm4gVGFiQ29udHJvbDtcbn1cbiJdfQ==