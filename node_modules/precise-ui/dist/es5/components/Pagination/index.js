"use strict";
var __extends = (this && this.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var __assign = (this && this.__assign) || function () {
    __assign = Object.assign || function(t) {
        for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
        }
        return t;
    };
    return __assign.apply(this, arguments);
};
var __rest = (this && this.__rest) || function (s, e) {
    var t = {};
    for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)
        t[p] = s[p];
    if (s != null && typeof Object.getOwnPropertySymbols === "function")
        for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) if (e.indexOf(p[i]) < 0)
            t[p[i]] = s[p[i]];
    return t;
};
Object.defineProperty(exports, "__esModule", { value: true });
var React = require("react");
var PaginationBar_1 = require("../PaginationBar");
var PaginationLayout_part_1 = require("./PaginationLayout.part");
/**
 * The Pagination component allows generic pagination of arbitrary components.
 */
var Pagination = /** @class */ (function (_super) {
    __extends(Pagination, _super);
    function Pagination(props) {
        var _this = _super.call(this, props) || this;
        _this.handlePageChange = function (_a) {
            var page = _a.page;
            var _b = _this.props, onChange = _b.onChange, value = _b.value;
            if (value === undefined) {
                _this.setState({
                    current: page,
                });
            }
            if (typeof onChange === 'function') {
                onChange({
                    value: page,
                });
            }
        };
        _this.handleSizeChange = function (_a) {
            var size = _a.size;
            var children = _this.props.children;
            var current = _this.state.current;
            var total = React.Children.count(children);
            var maxPageCount = Math.max(Math.ceil(total / size) - 1, 0);
            _this.setState({
                size: size,
                current: Math.min(current, maxPageCount),
            });
        };
        var value = props.value, defaultValue = props.defaultValue, _a = props.size, size = _a === void 0 ? 20 : _a;
        _this.state = {
            current: value || defaultValue || 0,
            size: Array.isArray(size) ? size[0] : size,
        };
        return _this;
    }
    Pagination.prototype.getDim = function (count) {
        var _a = this.state, current = _a.current, sizeState = _a.size;
        var min = current * sizeState;
        if (min < count) {
            return {
                current: current,
                min: min,
                max: min + sizeState,
                sizeState: sizeState,
            };
        }
        else {
            var previous = ~~((count - 1) / sizeState);
            return {
                current: previous,
                min: previous * sizeState,
                max: (previous + 1) * sizeState,
                sizeState: sizeState,
            };
        }
    };
    Pagination.prototype.render = function () {
        var _a = this.props, children = _a.children, host = _a.host, sizeProp = _a.size, itemsInfo = _a.itemsInfo, pagesInfo = _a.pagesInfo, label = _a.label, render = _a.render, props = __rest(_a, ["children", "host", "size", "itemsInfo", "pagesInfo", "label", "render"]);
        var count = React.Children.count(children);
        var _b = this.getDim(count), current = _b.current, min = _b.min, max = _b.max, sizeState = _b.sizeState;
        var content = count < sizeState
            ? children
            : React.Children.map(children, function (child, index) {
                if (index >= min && index < max) {
                    return child;
                }
                return undefined;
            });
        if (typeof render === 'function') {
            return render({
                current: current,
                min: min,
                max: max,
                count: count,
                content: content,
                sizeChanged: this.handleSizeChange,
                pageChanged: this.handlePageChange,
            });
        }
        return (React.createElement(PaginationLayout_part_1.PaginationLayout, __assign({}, props, { host: host, content: content, controls: React.createElement(PaginationBar_1.PaginationBar, { selectedPage: current, itemsInfo: itemsInfo, itemsPerPageLabel: label, pagesInfo: pagesInfo, size: sizeState, items: count, onSizeChanged: this.handleSizeChange, onPageChanged: this.handlePageChange, availableSizes: Array.isArray(sizeProp) ? sizeProp : [] }) })));
    };
    Pagination.inner = {
        get PaginationLayout() { return PaginationLayout_part_1.PaginationLayout; }
    };
    return Pagination;
}(React.Component));
exports.Pagination = Pagination;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvY29tcG9uZW50cy9QYWdpbmF0aW9uL2luZGV4LnRzeCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLDZCQUErQjtBQUUvQixrREFBK0c7QUFDL0csaUVBQTJEO0FBeUYzRDs7R0FFRztBQUNIO0lBQWdDLDhCQUFpRDtJQUM3RSxvQkFBWSxLQUFzQjtRQUFsQyxZQUNJLGtCQUFNLEtBQUssQ0FBQyxTQU1mO1FBQ08sc0JBQWdCLEdBQUcsVUFBQyxFQUF1QztnQkFBckMsY0FBSTtZQUN4QixJQUFBLGdCQUFnQyxFQUE5QixzQkFBUSxFQUFFLGdCQUFvQixDQUFDO1lBQ3ZDLElBQUksS0FBSyxLQUFLLFNBQVMsRUFBRTtnQkFDckIsS0FBSSxDQUFDLFFBQVEsQ0FBQztvQkFDVixPQUFPLEVBQUUsSUFBSTtpQkFDaEIsQ0FBQyxDQUFDO2FBQ047WUFDRCxJQUFJLE9BQU8sUUFBUSxLQUFLLFVBQVUsRUFBRTtnQkFDaEMsUUFBUSxDQUFDO29CQUNMLEtBQUssRUFBRSxJQUFJO2lCQUNkLENBQUMsQ0FBQzthQUNOO1FBQ0wsQ0FBQyxDQUFDO1FBQ00sc0JBQWdCLEdBQUcsVUFBQyxFQUF1QztnQkFBckMsY0FBSTtZQUN0QixJQUFBLCtCQUFRLENBQWdCO1lBQ3hCLElBQUEsNkJBQU8sQ0FBZ0I7WUFDL0IsSUFBTSxLQUFLLEdBQUcsS0FBSyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDN0MsSUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7WUFDOUQsS0FBSSxDQUFDLFFBQVEsQ0FBQztnQkFDVixJQUFJLE1BQUE7Z0JBQ0osT0FBTyxF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LGdCQUFnQixFQUFFLGFBQWEsRUFBRSxJQUFJLENBQUMsZ0JBQWdCLEVBQUUsY0FBYyxFQUFFLEtBQUssQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsRUFBRSxHQUFHLElBQUcsQ0FBQyxDQUFDO0lBQ3ZXLENBQUM7SUFDTSxnQkFBSyxHQUFHO1FBQ1gsSUFBSSxnQkFBZ0IsS0FBSyxPQUFPLHdDQUEyQyxDQUFDLENBQUMsQ0FBQztLQUNqRixDQUFDO0lBQ04saUJBQUM7Q0FBQSxBQWpGRCxDQUFnQyxLQUFLLENBQUMsU0FBUyxHQWlGOUM7QUFqRlksZ0NBQVUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBSZWFjdCBmcm9tICdyZWFjdCc7XG5pbXBvcnQgeyBTdGFuZGFyZFByb3BzIH0gZnJvbSAnLi4vLi4vY29tbW9uJztcbmltcG9ydCB7IFBhZ2luYXRpb25CYXIsIFBhZ2luYXRpb25CYXJTaXplQ2hhbmdlZEV2ZW50LCBQYWdpbmF0aW9uQmFyUGFnZUNoYW5nZWRFdmVudCB9IGZyb20gJy4uL1BhZ2luYXRpb25CYXInO1xuaW1wb3J0IHsgUGFnaW5hdGlvbkxheW91dCB9IGZyb20gJy4vUGFnaW5hdGlvbkxheW91dC5wYXJ0JztcbmV4cG9ydCBpbnRlcmZhY2UgUGFnaW5hdGlvbkNoYW5nZUV2ZW50IHtcbiAgICAvKipcbiAgICAgKiBUaGUgY3VycmVudCBwYWdlIGluZGV4LlxuICAgICAqL1xuICAgIHZhbHVlOiBudW1iZXI7XG59XG5leHBvcnQgaW50ZXJmYWNlIFBhZ2luYXRpb25TdGF0ZSB7XG4gICAgY3VycmVudDogbnVtYmVyO1xuICAgIHNpemU6IG51bWJlcjtcbn1cbmV4cG9ydCBpbnRlcmZhY2UgUGFnaW5hdGlvblJlbmRlckV2ZW50IHtcbiAgICAvKipcbiAgICAgKiBUaGUgY3VycmVudCBwYWdlIGluZGV4LlxuICAgICAqL1xuICAgIGN1cnJlbnQ6IG51bWJlcjtcbiAgICAvKipcbiAgICAgKiBUaGUgbWluaW11bSBpbmRleCBmb3IgdGhlIGVudHJ5IHRvIGJlIGluIHRoZSBjdXJyZW50IHBhZ2UuXG4gICAgICovXG4gICAgbWluOiBudW1iZXI7XG4gICAgLyoqXG4gICAgICogVGhlIG1heGltdW0gaW5kZXggZm9yIHRoZSBlbnRyeSB0byBiZSBpbiB0aGUgY3VycmVudCBwYWdlLlxuICAgICAqL1xuICAgIG1heDogbnVtYmVyO1xuICAgIC8qKlxuICAgICAqIFRoZSB0b3RhbCBudW1iZXIgb2YgZW50cmllcy5cbiAgICAgKi9cbiAgICBjb3VudDogbnVtYmVyO1xuICAgIC8qKlxuICAgICAqIFRoZSByZW5kZXJlZCBlbnRyaWVzLlxuICAgICAqL1xuICAgIGNvbnRlbnQ6IFJlYWN0LlJlYWN0Tm9kZTtcbiAgICAvKipcbiAgICAgKiBDYWxsYmFjayBmb3IgZW1pdHRpbmcgYW4gaXRlbXMgcGVyIHBhZ2UgY2hhbmdlLlxuICAgICAqL1xuICAgIHNpemVDaGFuZ2VkKGU6IFBhZ2luYXRpb25CYXJTaXplQ2hhbmdlZEV2ZW50KTogdm9pZDtcbiAgICAvKipcbiAgICAgKiBDYWxsYmFjayBmb3IgZW1pdHRpbmcgYSBjaGFuZ2Ugb2YgdGhlIGN1cnJlbnQgcGFnZSBpbmRleC5cbiAgICAgKi9cbiAgICBwYWdlQ2hhbmdlZChlOiBQYWdpbmF0aW9uQmFyUGFnZUNoYW5nZWRFdmVudCk6IHZvaWQ7XG59XG5leHBvcnQgaW50ZXJmYWNlIFBhZ2luYXRpb25Qcm9wcyBleHRlbmRzIFN0YW5kYXJkUHJvcHMge1xuICAgIC8qKlxuICAgICAqIFRoZSBpbml0aWFsLCBpLmUuLCBkZWZhdWx0LCBwYWdlIGluZGV4IHVzZWQgaW4gbWFuYWdlZCBtb2RlLlxuICAgICAqL1xuICAgIGRlZmF1bHRWYWx1ZT86IG51bWJlcjtcbiAgICAvKipcbiAgICAgKiBUaGUgY3VycmVudCBwYWdlIGluZGV4IGxlYWRpbmcgdG8gY29udHJvbGxlZCBtb2RlLlxuICAgICAqL1xuICAgIHZhbHVlPzogbnVtYmVyO1xuICAgIC8qKlxuICAgICAqIFRoZSBtYXhpbXVtIG51bWJlciBvZiBlbnRyaWVzIHBlciBwYWdlLiBCeSBkZWZhdWx0IHNldCB0byAyMC5cbiAgICAgKiBAZGVmYXVsdCAyMFxuICAgICAqL1xuICAgIHNpemU/OiBudW1iZXIgfCBBcnJheTxudW1iZXI+O1xuICAgIC8qKlxuICAgICAqIFRoZSBvcHRpb25hbCBob3N0IGVsZW1lbnQgdG8gYmUgdXNlZC5cbiAgICAgKi9cbiAgICBob3N0Pzogc3RyaW5nIHwgUmVhY3QuQ29tcG9uZW50Q2xhc3MgfCBSZWFjdC5TdGF0ZWxlc3NDb21wb25lbnQ7XG4gICAgLyoqXG4gICAgICogRXZlbnQgZmlyZWQgd2hlbiB0aGUgc2VsZWN0ZWQgcGFnZSBjaGFuZ2VzLlxuICAgICAqL1xuICAgIG9uQ2hhbmdlPyhlOiBQYWdpbmF0aW9uQ2hhbmdlRXZlbnQpOiB2b2lkO1xuICAgIC8qKlxuICAgICAqIFRoZSBvcHRpb25hbCBmb290ZXIgaW5mbyBsYWJlbCBvdmVycmlkZSwgZS5nLiwgZm9yIGxvY2FsaXphdGlvbi5cbiAgICAgKi9cbiAgICBsYWJlbD86IHN0cmluZztcbiAgICAvKipcbiAgICAgKiBPcHRpb25hbCBmdW5jdGlvbiB0byBjb21wdXRlIHRoZSBpdGVtcyBpbmZvIGxhYmVsLlxuICAgICAqIEBwYXJhbSBzdGFydCBUaGUgaW5jbHVzaXZlIHN0YXJ0IG51bWJlciBvZiBlbnRyaWVzLlxuICAgICAqIEBwYXJhbSBlbmQgVGhlIGluY2x1c2l2ZSBlbmQgbnVtYmVyIG9mIGVudHJpZXMuXG4gICAgICogQHBhcmFtIHRvdGFsIFRoZSB0b3RhbCBudW1iZXIgb2YgcGFnZXMuXG4gICAgICovXG4gICAgaXRlbXNJbmZvPyhzdGFydDogbnVtYmVyLCBlbmQ6IG51bWJlciwgdG90YWw6IG51bWJlcik6IFJlYWN0LlJlYWN0Q2hpbGQ7XG4gICAgLyoqXG4gICAgICogT3B0aW9uYWwgZnVuY3Rpb24gdG8gY29tcHV0ZSB0aGUgcGFnZXMgaW5mbyBsYWJlbC5cbiAgICAgKiBAcGFyYW0gc3RhcnQgVGhlIGluY2x1c2l2ZSBzdGFydCBudW1iZXIgb2YgZW50cmllcy5cbiAgICAgKiBAcGFyYW0gZW5kIFRoZSBpbmNsdXNpdmUgZW5kIG51bWJlciBvZiBlbnRyaWVzLlxuICAgICAqL1xuICAgIHBhZ2VzSW5mbz8oc3RhcnQ6IG51bWJlciwgZW5kOiBudW1iZXIpOiBSZWFjdC5SZWFjdENoaWxkO1xuICAgIC8qKlxuICAgICAqIENhbGxiYWNrIHRvIG92ZXJyaWRlIHRoZSByZW5kZXJpbmcgb2YgdGhlIHBhZ2luYXRpb24uXG4gICAgICovXG4gICAgcmVuZGVyPyhlOiBQYWdpbmF0aW9uUmVuZGVyRXZlbnQpOiBSZWFjdC5SZWFjdE5vZGU7XG4gICAgLyoqXG4gICAgICogVGhlIGNvbnRlbnQgb2YgdGhlIGNvbXBvbmVudC4gV2lsbCBiZSBjcm9wcGVkIGlmIHBhZ2luYXRpb24gYXBwbGllcy5cbiAgICAgKi9cbiAgICBjaGlsZHJlbj86IFJlYWN0LlJlYWN0Tm9kZTtcbn1cbi8qKlxuICogVGhlIFBhZ2luYXRpb24gY29tcG9uZW50IGFsbG93cyBnZW5lcmljIHBhZ2luYXRpb24gb2YgYXJiaXRyYXJ5IGNvbXBvbmVudHMuXG4gKi9cbmV4cG9ydCBjbGFzcyBQYWdpbmF0aW9uIGV4dGVuZHMgUmVhY3QuQ29tcG9uZW50PFBhZ2luYXRpb25Qcm9wcywgUGFnaW5hdGlvblN0YXRlPiB7XG4gICAgY29uc3RydWN0b3IocHJvcHM6IFBhZ2luYXRpb25Qcm9wcykge1xuICAgICAgICBzdXBlcihwcm9wcyk7XG4gICAgICAgIGNvbnN0IHsgdmFsdWUsIGRlZmF1bHRWYWx1ZSwgc2l6ZSA9IDIwIH0gPSBwcm9wcztcbiAgICAgICAgdGhpcy5zdGF0ZSA9IHtcbiAgICAgICAgICAgIGN1cnJlbnQ6IHZhbHVlIHx8IGRlZmF1bHRWYWx1ZSB8fCAwLFxuICAgICAgICAgICAgc2l6ZTogQXJyYXkuaXNBcnJheShzaXplKSA/IHNpemVbMF0gOiBzaXplLFxuICAgICAgICB9O1xuICAgIH1cbiAgICBwcml2YXRlIGhhbmRsZVBhZ2VDaGFuZ2UgPSAoeyBwYWdlIH06IFBhZ2luYXRpb25CYXJQYWdlQ2hhbmdlZEV2ZW50KSA9PiB7XG4gICAgICAgIGNvbnN0IHsgb25DaGFuZ2UsIHZhbHVlIH0gPSB0aGlzLnByb3BzO1xuICAgICAgICBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICAgICAgY3VycmVudDogcGFnZSxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0eXBlb2Ygb25DaGFuZ2UgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgICAgIG9uQ2hhbmdlKHtcbiAgICAgICAgICAgICAgICB2YWx1ZTogcGFnZSxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfTtcbiAgICBwcml2YXRlIGhhbmRsZVNpemVDaGFuZ2UgPSAoeyBzaXplIH06IFBhZ2luYXRpb25CYXJTaXplQ2hhbmdlZEV2ZW50KSA9PiB7XG4gICAgICAgIGNvbnN0IHsgY2hpbGRyZW4gfSA9IHRoaXMucHJvcHM7XG4gICAgICAgIGNvbnN0IHsgY3VycmVudCB9ID0gdGhpcy5zdGF0ZTtcbiAgICAgICAgY29uc3QgdG90YWwgPSBSZWFjdC5DaGlsZHJlbi5jb3VudChjaGlsZHJlbik7XG4gICAgICAgIGNvbnN0IG1heFBhZ2VDb3VudCA9IE1hdGgubWF4KE1hdGguY2VpbCh0b3RhbCAvIHNpemUpIC0gMSwgMCk7XG4gICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgc2l6ZSxcbiAgICAgICAgICAgIGN1cnJlbnQ6IE1hdGgubWluKGN1cnJlbnQsIG1heFBhZ2VDb3VudCksXG4gICAgICAgIH0pO1xuICAgIH07XG4gICAgcHJpdmF0ZSBnZXREaW0oY291bnQ6IG51bWJlcikge1xuICAgICAgICBjb25zdCB7IGN1cnJlbnQsIHNpemU6IHNpemVTdGF0ZSB9ID0gdGhpcy5zdGF0ZTtcbiAgICAgICAgY29uc3QgbWluID0gY3VycmVudCAqIHNpemVTdGF0ZTtcbiAgICAgICAgaWYgKG1pbiA8IGNvdW50KSB7XG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgIGN1cnJlbnQsXG4gICAgICAgICAgICAgICAgbWluLFxuICAgICAgICAgICAgICAgIG1heDogbWluICsgc2l6ZVN0YXRlLFxuICAgICAgICAgICAgICAgIHNpemVTdGF0ZSxcbiAgICAgICAgICAgIH07XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICBjb25zdCBwcmV2aW91cyA9IH5+KChjb3VudCAtIDEpIC8gc2l6ZVN0YXRlKTtcbiAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgY3VycmVudDogcHJldmlvdXMsXG4gICAgICAgICAgICAgICAgbWluOiBwcmV2aW91cyAqIHNpemVTdGF0ZSxcbiAgICAgICAgICAgICAgICBtYXg6IChwcmV2aW91cyArIDEpICogc2l6ZVN0YXRlLFxuICAgICAgICAgICAgICAgIHNpemVTdGF0ZSxcbiAgICAgICAgICAgIH07XG4gICAgICAgIH1cbiAgICB9XG4gICAgcmVuZGVyKCkge1xuICAgICAgICBjb25zdCB7IGNoaWxkcmVuLCBob3N0LCBzaXplOiBzaXplUHJvcCwgaXRlbXNJbmZvLCBwYWdlc0luZm8sIGxhYmVsLCByZW5kZXIsIC4uLnByb3BzIH0gPSB0aGlzLnByb3BzO1xuICAgICAgICBjb25zdCBjb3VudCA9IFJlYWN0LkNoaWxkcmVuLmNvdW50KGNoaWxkcmVuKTtcbiAgICAgICAgY29uc3QgeyBjdXJyZW50LCBtaW4sIG1heCwgc2l6ZVN0YXRlIH0gPSB0aGlzLmdldERpbShjb3VudCk7XG4gICAgICAgIGNvbnN0IGNvbnRlbnQgPSBjb3VudCA8IHNpemVTdGF0ZVxuICAgICAgICAgICAgPyBjaGlsZHJlblxuICAgICAgICAgICAgOiBSZWFjdC5DaGlsZHJlbi5tYXAoY2hpbGRyZW4sIChjaGlsZCwgaW5kZXgpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoaW5kZXggPj0gbWluICYmIGluZGV4IDwgbWF4KSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBjaGlsZDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICBpZiAodHlwZW9mIHJlbmRlciA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgICAgcmV0dXJuIHJlbmRlcih7XG4gICAgICAgICAgICAgICAgY3VycmVudCxcbiAgICAgICAgICAgICAgICBtaW4sXG4gICAgICAgICAgICAgICAgbWF4LFxuICAgICAgICAgICAgICAgIGNvdW50LFxuICAgICAgICAgICAgICAgIGNvbnRlbnQsXG4gICAgICAgICAgICAgICAgc2l6ZUNoYW5nZWQ6IHRoaXMuaGFuZGxlU2l6ZUNoYW5nZSxcbiAgICAgICAgICAgICAgICBwYWdlQ2hhbmdlZDogdGhpcy5oYW5kbGVQYWdlQ2hhbmdlLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuICg8UGFnaW5hdGlvbkxheW91dCB7Li4ucHJvcHN9IGhvc3Q9e2hvc3R9IGNvbnRlbnQ9e2NvbnRlbnR9IGNvbnRyb2xzPXs8UGFnaW5hdGlvbkJhciBzZWxlY3RlZFBhZ2U9e2N1cnJlbnR9IGl0ZW1zSW5mbz17aXRlbXNJbmZvfSBpdGVtc1BlclBhZ2VMYWJlbD17bGFiZWx9IHBhZ2VzSW5mbz17cGFnZXNJbmZvfSBzaXplPXtzaXplU3RhdGV9IGl0ZW1zPXtjb3VudH0gb25TaXplQ2hhbmdlZD17dGhpcy5oYW5kbGVTaXplQ2hhbmdlfSBvblBhZ2VDaGFuZ2VkPXt0aGlzLmhhbmRsZVBhZ2VDaGFuZ2V9IGF2YWlsYWJsZVNpemVzPXtBcnJheS5pc0FycmF5KHNpemVQcm9wKSA/IHNpemVQcm9wIDogW119Lz59Lz4pO1xuICAgIH1cbiAgICBzdGF0aWMgaW5uZXIgPSB7XG4gICAgICAgIGdldCBQYWdpbmF0aW9uTGF5b3V0KCkgeyByZXR1cm4gUGFnaW5hdGlvbkxheW91dCBhcyB0eXBlb2YgUGFnaW5hdGlvbkxheW91dDsgfVxuICAgIH07XG59XG4iXX0=