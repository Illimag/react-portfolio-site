"use strict";
var __makeTemplateObject = (this && this.__makeTemplateObject) || function (cooked, raw) {
    if (Object.defineProperty) { Object.defineProperty(cooked, "raw", { value: raw }); } else { cooked.raw = raw; }
    return cooked;
};
var __extends = (this && this.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var __assign = (this && this.__assign) || function () {
    __assign = Object.assign || function(t) {
        for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
        }
        return t;
    };
    return __assign.apply(this, arguments);
};
var __rest = (this && this.__rest) || function (s, e) {
    var t = {};
    for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)
        t[p] = s[p];
    if (s != null && typeof Object.getOwnPropertySymbols === "function")
        for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) if (e.indexOf(p[i]) < 0)
            t[p[i]] = s[p[i]];
    return t;
};
Object.defineProperty(exports, "__esModule", { value: true });
var React = require("react");
var styled_1 = require("../../utils/styled");
var gridLayout_1 = require("../../utils/gridLayout");
var browser_1 = require("../../utils/browser");
var StyledGridWrapper = styled_1.default.div(templateObject_1 || (templateObject_1 = __makeTemplateObject(["\n  position: relative;\n"], ["\n  position: relative;\n"])));
function addPx(original, space) {
    if (original.endsWith('px')) {
        var dim = +original.replace('px', '');
        return dim + space + "px";
    }
    return original;
}
function computeIeRows(rows, spacing) {
    if (browser_1.isIE === 'IE11') {
        var rowSpace = spacing[1];
        if (rowSpace && rowSpace.endsWith('px')) {
            var space_1 = +rowSpace.replace('px', '');
            if (space_1) {
                var end_1 = rows.length - 1;
                return rows.map(function (row, i) { return (i !== end_1 ? addPx(row, space_1) : row); }).join(' ');
            }
        }
    }
    return rows.join(' ');
}
var BasicGridLayout = styled_1.default.div(templateObject_2 || (templateObject_2 = __makeTemplateObject(["\n  height: 100%;\n  width: 100%;\n  display: -ms-grid;\n  display: grid;\n  -ms-grid-columns: ", ";\n  grid-template-columns: ", ";\n  -ms-grid-rows: ", ";\n  grid-template-rows: ", ";\n  grid-gap: ", ";\n"], ["\n  height: 100%;\n  width: 100%;\n  display: -ms-grid;\n  display: grid;\n  -ms-grid-columns: ", ";\n  grid-template-columns: ", ";\n  -ms-grid-rows: ", ";\n  grid-template-rows: ", ";\n  grid-gap: ", ";\n"])), function (props) { return props.columns.join(' '); }, function (props) { return props.columns.join(' '); }, function (props) { return computeIeRows(props.rows, props.spacing); }, function (props) { return props.rows.join(' '); }, function (props) { return props.spacing.join(' '); });
var GridLayout = styled_1.default(BasicGridLayout)(templateObject_3 || (templateObject_3 = __makeTemplateObject(["\n  opacity: 0.9999;\n"], ["\n  opacity: 0.9999;\n"])));
var ShadowGrid = styled_1.default(BasicGridLayout)(templateObject_4 || (templateObject_4 = __makeTemplateObject(["\n  position: absolute;\n"], ["\n  position: absolute;\n"])));
var DefaultUnusedCell = styled_1.default.div(templateObject_5 || (templateObject_5 = __makeTemplateObject(["\n  width: 100%;\n  height: 100%;\n  background: #f1f1f1;\n"], ["\n  width: 100%;\n  height: 100%;\n  background: #f1f1f1;\n"])));
// Remark:
// At PR #258 a fix for "complex content that overflows" was introduced
// which caused some problem. If this fix should be required in the future
// again we should bring in something like the following:
//
// ```css
// overflow: auto;
// margin: -1em;
// padding: 1em;
// ```
var GridCell = styled_1.default.div(templateObject_6 || (templateObject_6 = __makeTemplateObject(["\n  -ms-grid-row: ", ";\n  -ms-grid-row-span: ", ";\n  grid-row: ", " / span ", ";\n  -ms-grid-column: ", ";\n  -ms-grid-column-span: ", ";\n  grid-column: ", " / span ", ";\n  max-width: 100%;\n"], ["\n  -ms-grid-row: ", ";\n  -ms-grid-row-span: ", ";\n  grid-row: ", " / span ", ";\n  -ms-grid-column: ", ";\n  -ms-grid-column-span: ", ";\n  grid-column: ", " / span ", ";\n  max-width: 100%;\n"])), function (props) { return props.ri + 1; }, function (props) { return props.rf - props.ri; }, function (props) { return props.ri + 1; }, function (props) { return props.rf - props.ri; }, function (props) { return props.ci + 1; }, function (props) { return props.cf - props.ci; }, function (props) { return props.ci + 1; }, function (props) { return props.cf - props.ci; });
var HiddenGridCell = styled_1.default.div(templateObject_7 || (templateObject_7 = __makeTemplateObject(["\n  width: 0;\n  height: 0;\n  overflow: hidden;\n"], ["\n  width: 0;\n  height: 0;\n  overflow: hidden;\n"])));
function repeat(n, dim) {
    if (dim === void 0) { dim = '1fr'; }
    if (typeof n === 'number') {
        var arr = [];
        for (var i = 0; i < n; i++) {
            arr.push(dim);
        }
        return arr;
    }
    else if (!n) {
        return [dim];
    }
    return n;
}
function period(unit) {
    if (typeof unit === 'string') {
        return [unit, unit];
    }
    else if (!unit) {
        return ['0', '0'];
    }
    return unit;
}
function getEmptyComponent(showEmptyCells) {
    if (showEmptyCells === true) {
        return function (row, col) { return React.createElement(DefaultUnusedCell, { key: "uc-" + row + "-" + col }); };
    }
    else if (typeof showEmptyCells === 'object') {
        return function (row, col) { return React.cloneElement(showEmptyCells, { key: "uc-" + row + "-" + col }); };
    }
    else {
        return showEmptyCells;
    }
}
function computeAllocations(props) {
    var children = props.children, rows = props.rows, columns = props.columns;
    var allocation = [];
    var layout = gridLayout_1.calcLayout(children, {
        rows: typeof rows !== 'string' ? rows : undefined,
        columns: typeof columns !== 'string' ? columns : undefined,
    });
    var cells = React.Children.map(children, function (child, index) {
        var position = layout.cells[index];
        if (child && position) {
            allocation.push(position);
            var colSpan = position.colSpan, column = position.column, row = position.row, rowSpan = position.rowSpan;
            if (!colSpan || !rowSpan) {
                return React.createElement(HiddenGridCell, null, child);
            }
            return (React.createElement(GridCell, { ci: column, cf: column + colSpan, ri: row, rf: row + rowSpan, key: index }, child));
        }
        return undefined;
    }) || [];
    return {
        allocation: allocation,
        cells: cells,
        rows: typeof rows === 'string' ? repeat(layout.rows, rows) : repeat(rows || layout.rows),
        columns: typeof columns === 'string' ? repeat(layout.columns, columns) : repeat(columns || layout.columns),
    };
}
function computeUnused(props, layout) {
    var showEmptyCells = props.showEmptyCells;
    var rows = layout.rows, columns = layout.columns;
    var unusedCells = [];
    if (showEmptyCells) {
        var renderer = getEmptyComponent(showEmptyCells);
        var rowCount = rows.length;
        var colCount = columns.length;
        for (var i = 0; i < rowCount; i++) {
            for (var j = 0; j < colCount; j++) {
                var cell = renderer(i, j);
                unusedCells.push(cell);
            }
        }
    }
    return unusedCells;
}
/**
 * The `Grid` component represents a uniform grid, i.e., a grid that does not change its column layout from row to row.
 */
var Grid = /** @class */ (function (_super) {
    __extends(Grid, _super);
    function Grid(props) {
        var _this = _super.call(this, props) || this;
        var layout = computeAllocations(props);
        _this.state = {
            layout: layout,
            unused: computeUnused(props, layout),
        };
        return _this;
    }
    Grid.prototype.UNSAFE_componentWillReceiveProps = function (nextProps) {
        var currLayout = this.state.layout;
        var nextLayout = computeAllocations(nextProps);
        this.setState({
            layout: nextLayout,
        });
        if (nextProps.showEmptyCells !== this.props.showEmptyCells ||
            nextLayout.rows !== currLayout.rows ||
            nextLayout.columns !== currLayout.columns) {
            this.setState({
                unused: computeUnused(nextProps, nextLayout),
            });
        }
    };
    Grid.prototype.render = function () {
        var _a = this.props, _0 = _a.rows, _1 = _a.columns, _b = _a.spacing, spacing = _b === void 0 ? 0 : _b, _2 = _a.showEmptyCells, onLayout = _a.onLayout, innerRef = _a.innerRef, props = __rest(_a, ["rows", "columns", "spacing", "showEmptyCells", "onLayout", "innerRef"]);
        var _c = this.state, layout = _c.layout, unused = _c.unused;
        var space = typeof spacing === 'number' ? spacing + "px" : spacing;
        var selectedSpacing = period(space);
        if (typeof onLayout === 'function') {
            onLayout({
                layout: layout,
            });
        }
        return (React.createElement(StyledGridWrapper, { ref: innerRef },
            !!unused.length && (React.createElement(ShadowGrid, { rows: layout.rows, columns: layout.columns, spacing: selectedSpacing }, unused)),
            React.createElement(GridLayout, __assign({ rows: layout.rows, columns: layout.columns, spacing: selectedSpacing }, props), layout.cells)));
    };
    Grid.inner = {
        get StyledGridWrapper() { return StyledGridWrapper; },
        get ShadowGrid() { return ShadowGrid; },
        get GridLayout() { return GridLayout; }
    };
    return Grid;
}(React.PureComponent));
exports.Grid = Grid;
var templateObject_1, templateObject_2, templateObject_3, templateObject_4, templateObject_5, templateObject_6, templateObject_7;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvY29tcG9uZW50cy9HcmlkL2luZGV4LnRzeCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSw2QkFBK0I7QUFDL0IsNkNBQXdDO0FBR3hDLHFEQUFvRTtBQUNwRSwrQ0FBMkM7QUFrRTNDLElBQU0saUJBQWlCLEdBQUcsZ0JBQU0sQ0FBQyxHQUFHLDhGQUFDLDJCQUVwQyxJQUFBLENBQUM7QUFDRixTQUFTLEtBQUssQ0FBQyxRQUFnQixFQUFFLEtBQWE7SUFDMUMsSUFBSSxRQUFRLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxFQUFFO1FBQ3pCLElBQU0sR0FBRyxHQUFHLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFDeEMsT0FBVSxHQUFHLEdBQUcsS0FBSyxPQUFJLENBQUM7S0FDN0I7SUFDRCxPQUFPLFFBQVEsQ0FBQztBQUNwQixDQUFDO0FBQ0QsU0FBUyxhQUFhLENBQUMsSUFBbUIsRUFBRSxPQUF5QjtJQUNqRSxJQUFJLGNBQUksS0FBSyxNQUFNLEVBQUU7UUFDUixJQUFBLHFCQUFRLENBQVk7UUFDN0IsSUFBSSxRQUFRLElBQUksUUFBUSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsRUFBRTtZQUNyQyxJQUFNLE9BQUssR0FBRyxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxDQUFDO1lBQzFDLElBQUksT0FBSyxFQUFFO2dCQUNQLElBQU0sS0FBRyxHQUFHLElBQUksQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDO2dCQUM1QixPQUFPLElBQUksQ0FBQyxHQUFHLENBQUMsVUFBQyxHQUFHLEVBQUUsQ0FBQyxJQUFLLE9BQUEsQ0FBQyxDQUFDLEtBQUssS0FBRyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMs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QUFRLENBQUMsQ0FBQyxDQUFJLE9BQU8sT0FBSSxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUM7UUFDckUsSUFBTSxlQUFlLEdBQUcsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ3RDLElBQUksT0FBTyxRQUFRLEtBQUssVUFBVSxFQUFFO1lBQ2hDLFFBQVEsQ0FBQztnQkFDTCxNQUFNLFFBQUE7YUFDVCxDQUFDLENBQUM7U0FDTjtRQUNELE9BQU8sQ0FBQyxvQkFBQyxpQkFBaUIsSUFBQyxHQUFHLEVBQUUsUUFBUTtZQUN2QyxDQUFDLENBQUMsTUFBTSxDQUFDLE1BQU0sSUFBSSxDQUFDLG9CQUFDLFVBQVUsSUFBQyxJQUFJLEVBQUUsTUFBTSxDQUFDLElBQUksRUFBRSxPQUFPLEVBQUUsTUFBTSxDQUFDLE9BQU8sRUFBRSxPQUFPLEVBQUUsZUFBZSxJQUNoRyxNQUFNLENBQ0ksQ0FBQztZQUNoQixvQkFBQyxVQUFVLGFBQUMsSUFBSSxFQUFFLE1BQU0sQ0FBQyxJQUFJLEVBQUUsT0FBTyxFQUFFLE1BQU0sQ0FBQyxPQUFPLEVBQUUsT0FBTyxFQUFFLGVBQWUsSUFBTSxLQUFLLEdBQ3hGLE1BQU0sQ0FBQyxLQUFLLENBQ0YsQ0FDSyxDQUFDLENBQUM7SUFDeEIsQ0FBQztJQUNNLFVBQUssR0FBRztRQUNYLElBQUksaUJBQWlCLEtBQUssT0FBTyxpQkFBNkMsQ0FBQyxDQUFDLENBQUM7UUFDakYsSUFBSSxVQUFVLEtBQUssT0FBTyxVQUErQixDQUFDLENBQUMsQ0FBQztRQUM1RCxJQUFJLFVBQVUsS0FBSyxPQUFPLFVBQStCLENBQUMsQ0FBQyxDQUFDO0tBQy9ELENBQUM7SUFDTixXQUFDO0NBQUEsQUEvQ0QsQ0FBMEIsS0FBSyxDQUFDLGFBQWEsR0ErQzVDO0FBL0NZLG9CQUFJIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgUmVhY3QgZnJvbSAncmVhY3QnO1xuaW1wb3J0IHN0eWxlZCBmcm9tICcuLi8uLi91dGlscy9zdHlsZWQnO1xuaW1wb3J0IHsgU3RhbmRhcmRQcm9wcyB9IGZyb20gJy4uLy4uL2NvbW1vbic7XG5pbXBvcnQgeyBHcmlkQXJlYVByb3BzIH0gZnJvbSAnLi4vR3JpZEFyZWEnO1xuaW1wb3J0IHsgY2FsY0xheW91dCwgR3JpZEFsbG9jYXRpb24gfSBmcm9tICcuLi8uLi91dGlscy9ncmlkTGF5b3V0JztcbmltcG9ydCB7IGlzSUUgfSBmcm9tICcuLi8uLi91dGlscy9icm93c2VyJztcbmV4cG9ydCBpbnRlcmZhY2UgRW1wdHlDZWxsUmVuZGVyZXIge1xuICAgIChyb3c6IG51bWJlciwgY29sOiBudW1iZXIpOiBKU1guRWxlbWVudDtcbn1cbmV4cG9ydCBpbnRlcmZhY2UgR3JpZFByb3BzIGV4dGVuZHMgU3RhbmRhcmRQcm9wcyB7XG4gICAgLyoqXG4gICAgICogU2V0cyB0aGUgbnVtYmVyIG9mIHJvd3MgaW4gdGhlIGdyaWQsIG90aGVyd2lzZSBlaXRoZXIgMVxuICAgICAqIChjb2x1bW5zIG5vdCBmaXhlZCkgb3IgZHluYW1pYyAoY29sdW1ucyBmaXhlZCkuXG4gICAgICogQSBzdHJpbmcgaW5kaWNhdGVzIHRoZSBoZWlnaHQgb2Ygcm93cyBpbiBhIGR5bmFtaWMgc2V0dGluZy5cbiAgICAgKiBAZGVmYXVsdCAxXG4gICAgICovXG4gICAgcm93cz86IG51bWJlciB8IHN0cmluZyB8IEFycmF5PHN0cmluZz47XG4gICAgLyoqXG4gICAgICogU2V0cyB0aGUgbnVtYmVyIG9mIGNvbHVtbnMgaW4gdGhlIGdyaWQsIG90aGVyd2lzZSBlaXRoZXJcbiAgICAgKiAxIChyb3dzIG5vdCBmaXhlZCkgb3IgZHluYW1pYyAocm93cyBmaXhlZCkuXG4gICAgICogQSBzdHJpbmcgaW5kaWNhdGVzIHRoZSB3aWR0aCBvZiBjb2x1bW5zIGluIGEgZHluYW1pYyBzZXR0aW5nLlxuICAgICAqIEBkZWZhdWx0IDFcbiAgICAgKi9cbiAgICBjb2x1bW5zPzogbnVtYmVyIHwgc3RyaW5nIHwgQXJyYXk8c3RyaW5nPjtcbiAgICAvKipcbiAgICAgKiBPcHRpb25hbGx5IHNldHMgdGhlIHNwYWNpbmcgYmV0d2VlbiB0aGUgZ3JpZCBjZWxscy5cbiAgICAgKiBCeSBkZWZhdWx0IDAsIG90aGVyd2lzZSBhIHNpbmdsZSB2YWx1ZSBzZXRzIHRoZVxuICAgICAqIHNwYWNpbmcgYmV0d2VlbiByb3dzIGFuZCBjb2x1bW5zLCB3aGlsZSB0d28gdmFsdWVzXG4gICAgICogc2V0IHRoZSBzcGFjaW5nIGJldHdlZW4gdGhlIHJvd3MgYW5kIGNvbHVtbnNcbiAgICAgKiByZXNwZWN0aXZlbHkuXG4gICAgICogQGRlZmF1bHQgMFxuICAgICAqL1xuICAgIHNwYWNpbmc/OiBudW1iZXIgfCBzdHJpbmcgfCBbc3RyaW5nLCBzdHJpbmddO1xuICAgIC8qKlxuICAgICAqIFNldHMgdGhlIGdyaWQncyBjaGlsZHJlbi5cbiAgICAgKi9cbiAgICBjaGlsZHJlbj86IFJlYWN0LlJlYWN0Tm9kZTtcbiAgICAvKipcbiAgICAgKiBCeSBwcm92aWRpbmcgdGhlIHNob3cgZW1wdHkgY2VsbCBwcm9wZXJ0eSwgdGhlIGdyaWQgd2lsbCBhdXRvbWF0aWNhbGx5XG4gICAgICogcmVuZGVyIHRoZSBlbXB0eSAoaS5lLiwgdW51c2VkKSBjZWxscyBhbmQgcG9wdWxhdGUgdGhlbSB1c2luZyB0aGlzXG4gICAgICogY29tcG9uZW50LlxuICAgICAqIEBkZWZhdWx0IGZhbHNlXG4gICAgICovXG4gICAgc2hvd0VtcHR5Q2VsbHM/OiBKU1guRWxlbWVudCB8IEVtcHR5Q2VsbFJlbmRlcmVyIHwgYm9vbGVhbjtcbiAgICAvKipcbiAgICAgKiBFdmVudCBmaXJlZCBvbmNlIHRoZSBsYXlvdXQgaGFzIGJlZW4gY29tcHV0ZWQuXG4gICAgICovXG4gICAgb25MYXlvdXQ/KGU6IEdyaWRMYXlvdXRFdmVudCk6IHZvaWQ7XG4gICAgLyoqXG4gICAgICogR2V0cyB0aGUgcmVmZXJlbmNlIHRvIHRoZSB1bmRlcmx5aW5nIEhUTUwgRE9NIGVsZW1lbnQuXG4gICAgICovXG4gICAgaW5uZXJSZWY/KGluc3RhbmNlOiBIVE1MRWxlbWVudCB8IG51bGwpOiB2b2lkO1xufVxuZXhwb3J0IGludGVyZmFjZSBHcmlkTGF5b3V0RXZlbnQge1xuICAgIGxheW91dDogR3JpZExheW91dDtcbn1cbmV4cG9ydCBpbnRlcmZhY2UgR3JpZExheW91dCB7XG4gICAgYWxsb2NhdGlvbjogQXJyYXk8R3JpZEFsbG9jYXRpb24+O1xuICAgIGNlbGxzOiBBcnJheTxKU1guRWxlbWVudCB8IHVuZGVmaW5lZD47XG4gICAgcm93czogQXJyYXk8c3RyaW5nPjtcbiAgICBjb2x1bW5zOiBBcnJheTxzdHJpbmc+O1xufVxuZXhwb3J0IGludGVyZmFjZSBHcmlkU3RhdGUge1xuICAgIGxheW91dDogR3JpZExheW91dDtcbiAgICB1bnVzZWQ6IEFycmF5PEpTWC5FbGVtZW50Pjtcbn1cbmludGVyZmFjZSBHcmlkTGF5b3V0UHJvcHMge1xuICAgIHJvd3M6IEFycmF5PHN0cmluZz47XG4gICAgY29sdW1uczogQXJyYXk8c3RyaW5nPjtcbiAgICBzcGFjaW5nOiBbc3RyaW5nLCBzdHJpbmddO1xufVxuY29uc3QgU3R5bGVkR3JpZFdyYXBwZXIgPSBzdHlsZWQuZGl2IGBcbiAgcG9zaXRpb246IHJlbGF0aXZlO1xuYDtcbmZ1bmN0aW9uIGFkZFB4KG9yaWdpbmFsOiBzdHJpbmcsIHNwYWNlOiBudW1iZXIpIHtcbiAgICBpZiAob3JpZ2luYWwuZW5kc1dpdGgoJ3B4JykpIHtcbiAgICAgICAgY29uc3QgZGltID0gK29yaWdpbmFsLnJlcGxhY2UoJ3B4JywgJycpO1xuICAgICAgICByZXR1cm4gYCR7ZGltICsgc3BhY2V9cHhgO1xuICAgIH1cbiAgICByZXR1cm4gb3JpZ2luYWw7XG59XG5mdW5jdGlvbiBjb21wdXRlSWVSb3dzKHJvd3M6IEFycmF5PHN0cmluZz4sIHNwYWNpbmc6IFtzdHJpbmcsIHN0cmluZ10pIHtcbiAgICBpZiAoaXNJRSA9PT0gJ0lFMTEnKSB7XG4gICAgICAgIGNvbnN0IFssIHJvd1NwYWNlXSA9IHNwYWNpbmc7XG4gICAgICAgIGlmIChyb3dTcGFjZSAmJiByb3dTcGFjZS5lbmRzV2l0aCgncHgnKSkge1xuICAgICAgICAgICAgY29uc3Qgc3BhY2UgPSArcm93U3BhY2UucmVwbGFjZSgncHgnLCAnJyk7XG4gICAgICAgICAgICBpZiAoc3BhY2UpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBlbmQgPSByb3dzLmxlbmd0aCAtIDE7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHJvd3MubWFwKChyb3csIGkpID0+IChpICE9PSBlbmQgPyBhZGRQeChyb3csIHNwYWNlKSA6IHJvdykpLmpvaW4oJyAnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gcm93cy5qb2luKCcgJyk7XG59XG5jb25zdCBCYXNpY0dyaWRMYXlvdXQgPSBzdHlsZWQuZGl2PEdyaWRMYXlvdXRQcm9wcz4gYFxuICBoZWlnaHQ6IDEwMCU7XG4gIHdpZHRoOiAxMDAlO1xuICBkaXNwbGF5OiAtbXMtZ3JpZDtcbiAgZGlzcGxheTogZ3JpZDtcbiAgLW1zLWdyaWQtY29sdW1uczogJHtwcm9wcyA9PiBwcm9wcy5jb2x1bW5zLmpvaW4oJyAnKX07XG4gIGdyaWQtdGVtcGxhdGUtY29sdW1uczogJHtwcm9wcyA9PiBwcm9wcy5jb2x1bW5zLmpvaW4oJyAnKX07XG4gIC1tcy1ncmlkLXJvd3M6ICR7cHJvcHMgPT4gY29tcHV0ZUllUm93cyhwcm9wcy5yb3dzLCBwcm9wcy5zcGFjaW5nKX07XG4gIGdyaWQtdGVtcGxhdGUtcm93czogJHtwcm9wcyA9PiBwcm9wcy5yb3dzLmpvaW4oJyAnKX07XG4gIGdyaWQtZ2FwOiAke3Byb3BzID0+IHByb3BzLnNwYWNpbmcuam9pbignICcpfTtcbmA7XG5jb25zdCBHcmlkTGF5b3V0ID0gc3R5bGVkKEJhc2ljR3JpZExheW91dCkgYFxuICBvcGFjaXR5OiAwLjk5OTk7XG5gO1xuY29uc3QgU2hhZG93R3JpZCA9IHN0eWxlZChCYXNpY0dyaWRMYXlvdXQpIGBcbiAgcG9zaXRpb246IGFic29sdXRlO1xuYDtcbmNvbnN0IERlZmF1bHRVbnVzZWRDZWxsID0gc3R5bGVkLmRpdiBgXG4gIHdpZHRoOiAxMDAlO1xuICBoZWlnaHQ6IDEwMCU7XG4gIGJhY2tncm91bmQ6ICNmMWYxZjE7XG5gO1xuaW50ZXJmYWNlIEdyaWRDZWxsUHJvcHMge1xuICAgIHJpOiBudW1iZXI7XG4gICAgcmY6IG51bWJlcjtcbiAgICBjaTogbnVtYmVyO1xuICAgIGNmOiBudW1iZXI7XG59XG4vLyBSZW1hcms6XG4vLyBBdCBQUiAjMjU4IGEgZml4IGZvciBcImNvbXBsZXggY29udGVudCB0aGF0IG92ZXJmbG93c1wiIHdhcyBpbnRyb2R1Y2VkXG4vLyB3aGljaCBjYXVzZWQgc29tZSBwcm9ibGVtLiBJZiB0aGlzIGZpeCBzaG91bGQgYmUgcmVxdWlyZWQgaW4gdGhlIGZ1dHVyZVxuLy8gYWdhaW4gd2Ugc2hvdWxkIGJyaW5nIGluIHNvbWV0aGluZyBsaWtlIHRoZSBmb2xsb3dpbmc6XG4vL1xuLy8gYGBgY3NzXG4vLyBvdmVyZmxvdzogYXV0bztcbi8vIG1hcmdpbjogLTFlbTtcbi8vIHBhZGRpbmc6IDFlbTtcbi8vIGBgYFxuY29uc3QgR3JpZENlbGwgPSBzdHlsZWQuZGl2PEdyaWRDZWxsUHJvcHM+IGBcbiAgLW1zLWdyaWQtcm93OiAke3Byb3BzID0+IHByb3BzLnJpICsgMX07XG4gIC1tcy1ncmlkLXJvdy1zcGFuOiAke3Byb3BzID0+IHByb3BzLnJmIC0gcHJvcHMucml9O1xuICBncmlkLXJvdzogJHtwcm9wcyA9PiBwcm9wcy5yaSArIDF9IC8gc3BhbiAke3Byb3BzID0+IHByb3BzLnJmIC0gcHJvcHMucml9O1xuICAtbXMtZ3JpZC1jb2x1bW46ICR7cHJvcHMgPT4gcHJvcHMuY2kgKyAxfTtcbiAgLW1zLWdyaWQtY29sdW1uLXNwYW46ICR7cHJvcHMgPT4gcHJvcHMuY2YgLSBwcm9wcy5jaX07XG4gIGdyaWQtY29sdW1uOiAke3Byb3BzID0+IHByb3BzLmNpICsgMX0gLyBzcGFuICR7cHJvcHMgPT4gcHJvcHMuY2YgLSBwcm9wcy5jaX07XG4gIG1heC13aWR0aDogMTAwJTtcbmA7XG5jb25zdCBIaWRkZW5HcmlkQ2VsbCA9IHN0eWxlZC5kaXYgYFxuICB3aWR0aDogMDtcbiAgaGVpZ2h0OiAwO1xuICBvdmVyZmxvdzogaGlkZGVuO1xuYDtcbmZ1bmN0aW9uIHJlcGVhdChuOiBudW1iZXIgfCBBcnJheTxzdHJpbmc+IHwgdW5kZWZpbmVkLCBkaW0gPSAnMWZyJykge1xuICAgIGlmICh0eXBlb2YgbiA9PT0gJ251bWJlcicpIHtcbiAgICAgICAgY29uc3QgYXJyOiBBcnJheTxzdHJpbmc+ID0gW107XG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbjsgaSsrKSB7XG4gICAgICAgICAgICBhcnIucHVzaChkaW0pO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBhcnI7XG4gICAgfVxuICAgIGVsc2UgaWYgKCFuKSB7XG4gICAgICAgIHJldHVybiBbZGltXTtcbiAgICB9XG4gICAgcmV0dXJuIG47XG59XG5mdW5jdGlvbiBwZXJpb2QodW5pdDogc3RyaW5nIHwgW3N0cmluZywgc3RyaW5nXSB8IHVuZGVmaW5lZCk6IFtzdHJpbmcsIHN0cmluZ10ge1xuICAgIGlmICh0eXBlb2YgdW5pdCA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgcmV0dXJuIFt1bml0LCB1bml0XTtcbiAgICB9XG4gICAgZWxzZSBpZiAoIXVuaXQpIHtcbiAgICAgICAgcmV0dXJuIFsnMCcsICcwJ107XG4gICAgfVxuICAgIHJldHVybiB1bml0O1xufVxuZnVuY3Rpb24gZ2V0RW1wdHlDb21wb25lbnQoc2hvd0VtcHR5Q2VsbHM6IEpTWC5FbGVtZW50IHwgRW1wdHlDZWxsUmVuZGVyZXIgfCB0cnVlKTogRW1wdHlDZWxsUmVuZGVyZXIge1xuICAgIGlmIChzaG93RW1wdHlDZWxscyA9PT0gdHJ1ZSkge1xuICAgICAgICByZXR1cm4gKHJvdywgY29sKSA9PiA8RGVmYXVsdFVudXNlZENlbGwga2V5PXtgdWMtJHtyb3d9LSR7Y29sfWB9Lz47XG4gICAgfVxuICAgIGVsc2UgaWYgKHR5cGVvZiBzaG93RW1wdHlDZWxscyA9PT0gJ29iamVjdCcpIHtcbiAgICAgICAgcmV0dXJuIChyb3csIGNvbCkgPT4gUmVhY3QuY2xvbmVFbGVtZW50KHNob3dFbXB0eUNlbGxzLCB7IGtleTogYHVjLSR7cm93fS0ke2NvbH1gIH0pO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgICAgcmV0dXJuIHNob3dFbXB0eUNlbGxzO1xuICAgIH1cbn1cbnR5cGUgR3JpZENoaWxkID0gUmVhY3QuUmVhY3RFbGVtZW50PEdyaWRBcmVhUHJvcHM+ICYge1xuICAgIHR5cGU6IHN0cmluZztcbn07XG5mdW5jdGlvbiBjb21wdXRlQWxsb2NhdGlvbnMocHJvcHM6IEdyaWRQcm9wcyk6IEdyaWRMYXlvdXQge1xuICAgIGNvbnN0IHsgY2hpbGRyZW4sIHJvd3MsIGNvbHVtbnMgfSA9IHByb3BzO1xuICAgIGNvbnN0IGFsbG9jYXRpb246IEFycmF5PEdyaWRBbGxvY2F0aW9uPiA9IFtdO1xuICAgIGNvbnN0IGxheW91dCA9IGNhbGNMYXlvdXQoY2hpbGRyZW4sIHtcbiAgICAgICAgcm93czogdHlwZW9mIHJvd3MgIT09ICdzdHJpbmcnID8gcm93cyA6IHVuZGVmaW5lZCxcbiAgICAgICAgY29sdW1uczogdHlwZW9mIGNvbHVtbnMgIT09ICdzdHJpbmcnID8gY29sdW1ucyA6IHVuZGVmaW5lZCxcbiAgICB9KTtcbiAgICBjb25zdCBjZWxscyA9IFJlYWN0LkNoaWxkcmVuLm1hcChjaGlsZHJlbiwgKGNoaWxkOiBHcmlkQ2hpbGQsIGluZGV4KSA9PiB7XG4gICAgICAgIGNvbnN0IHBvc2l0aW9uID0gbGF5b3V0LmNlbGxzW2luZGV4XTtcbiAgICAgICAgaWYgKGNoaWxkICYmIHBvc2l0aW9uKSB7XG4gICAgICAgICAgICBhbGxvY2F0aW9uLnB1c2gocG9zaXRpb24pO1xuICAgICAgICAgICAgY29uc3QgeyBjb2xTcGFuLCBjb2x1bW4sIHJvdywgcm93U3BhbiB9ID0gcG9zaXRpb247XG4gICAgICAgICAgICBpZiAoIWNvbFNwYW4gfHwgIXJvd1NwYW4pIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gPEhpZGRlbkdyaWRDZWxsPntjaGlsZH08L0hpZGRlbkdyaWRDZWxsPjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiAoPEdyaWRDZWxsIGNpPXtjb2x1bW59IGNmPXtjb2x1bW4gKyBjb2xTcGFufSByaT17cm93fSByZj17cm93ICsgcm93U3Bhbn0ga2V5PXtpbmRleH0+XG4gICAgICAgICAgICB7Y2hpbGR9XG4gICAgICAgICAgPC9HcmlkQ2VsbD4pO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfSkgfHwgW107XG4gICAgcmV0dXJuIHtcbiAgICAgICAgYWxsb2NhdGlvbixcbiAgICAgICAgY2VsbHMsXG4gICAgICAgIHJvd3M6IHR5cGVvZiByb3dzID09PSAnc3RyaW5nJyA/IHJlcGVhdChsYXlvdXQucm93cywgcm93cykgOiByZXBlYXQocm93cyB8fCBsYXlvdXQucm93cyksXG4gICAgICAgIGNvbHVtbnM6IHR5cGVvZiBjb2x1bW5zID09PSAnc3RyaW5nJyA/IHJlcGVhdChsYXlvdXQuY29sdW1ucywgY29sdW1ucykgOiByZXBlYXQoY29sdW1ucyB8fCBsYXlvdXQuY29sdW1ucyksXG4gICAgfTtcbn1cbmZ1bmN0aW9uIGNvbXB1dGVVbnVzZWQocHJvcHM6IEdyaWRQcm9wcywgbGF5b3V0OiBHcmlkTGF5b3V0KSB7XG4gICAgY29uc3QgeyBzaG93RW1wdHlDZWxscyB9ID0gcHJvcHM7XG4gICAgY29uc3QgeyByb3dzLCBjb2x1bW5zIH0gPSBsYXlvdXQ7XG4gICAgY29uc3QgdW51c2VkQ2VsbHM6IEFycmF5PEpTWC5FbGVtZW50PiA9IFtdO1xuICAgIGlmIChzaG93RW1wdHlDZWxscykge1xuICAgICAgICBjb25zdCByZW5kZXJlciA9IGdldEVtcHR5Q29tcG9uZW50KHNob3dFbXB0eUNlbGxzKTtcbiAgICAgICAgY29uc3Qgcm93Q291bnQgPSByb3dzLmxlbmd0aDtcbiAgICAgICAgY29uc3QgY29sQ291bnQgPSBjb2x1bW5zLmxlbmd0aDtcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCByb3dDb3VudDsgaSsrKSB7XG4gICAgICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IGNvbENvdW50OyBqKyspIHtcbiAgICAgICAgICAgICAgICBjb25zdCBjZWxsID0gcmVuZGVyZXIoaSwgaik7XG4gICAgICAgICAgICAgICAgdW51c2VkQ2VsbHMucHVzaChjZWxsKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gdW51c2VkQ2VsbHM7XG59XG4vKipcbiAqIFRoZSBgR3JpZGAgY29tcG9uZW50IHJlcHJlc2VudHMgYSB1bmlmb3JtIGdyaWQsIGkuZS4sIGEgZ3JpZCB0aGF0IGRvZXMgbm90IGNoYW5nZSBpdHMgY29sdW1uIGxheW91dCBmcm9tIHJvdyB0byByb3cuXG4gKi9cbmV4cG9ydCBjbGFzcyBHcmlkIGV4dGVuZHMgUmVhY3QuUHVyZUNvbXBvbmVudDxHcmlkUHJvcHMsIEdyaWRTdGF0ZT4ge1xuICAgIGNvbnN0cnVjdG9yKHByb3BzOiBHcmlkUHJvcHMpIHtcbiAgICAgICAgc3VwZXIocHJvcHMpO1xuICAgICAgICBjb25zdCBsYXlvdXQgPSBjb21wdXRlQWxsb2NhdGlvbnMocHJvcHMpO1xuICAgICAgICB0aGlzLnN0YXRlID0ge1xuICAgICAgICAgICAgbGF5b3V0LFxuICAgICAgICAgICAgdW51c2VkOiBjb21wdXRlVW51c2VkKHByb3BzLCBsYXlvdXQpLFxuICAgICAgICB9O1xuICAgIH1cbiAgICBVTlNBRkVfY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyhuZXh0UHJvcHM6IEdyaWRQcm9wcykge1xuICAgICAgICBjb25zdCBjdXJyTGF5b3V0ID0gdGhpcy5zdGF0ZS5sYXlvdXQ7XG4gICAgICAgIGNvbnN0IG5leHRMYXlvdXQgPSBjb21wdXRlQWxsb2NhdGlvbnMobmV4dFByb3BzKTtcbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICBsYXlvdXQ6IG5leHRMYXlvdXQsXG4gICAgICAgIH0pO1xuICAgICAgICBpZiAobmV4dFByb3BzLnNob3dFbXB0eUNlbGxzICE9PSB0aGlzLnByb3BzLnNob3dFbXB0eUNlbGxzIHx8XG4gICAgICAgICAgICBuZXh0TGF5b3V0LnJvd3MgIT09IGN1cnJMYXlvdXQucm93cyB8fFxuICAgICAgICAgICAgbmV4dExheW91dC5jb2x1bW5zICE9PSBjdXJyTGF5b3V0LmNvbHVtbnMpIHtcbiAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgICAgIHVudXNlZDogY29tcHV0ZVVudXNlZChuZXh0UHJvcHMsIG5leHRMYXlvdXQpLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcmVuZGVyKCkge1xuICAgICAgICBjb25zdCB7IHJvd3M6IF8wLCBjb2x1bW5zOiBfMSwgc3BhY2luZyA9IDAsIHNob3dFbXB0eUNlbGxzOiBfMiwgb25MYXlvdXQsIGlubmVyUmVmLCAuLi5wcm9wcyB9ID0gdGhpcy5wcm9wcztcbiAgICAgICAgY29uc3QgeyBsYXlvdXQsIHVudXNlZCB9ID0gdGhpcy5zdGF0ZTtcbiAgICAgICAgY29uc3Qgc3BhY2UgPSB0eXBlb2Ygc3BhY2luZyA9PT0gJ251bWJlcicgPyBgJHtzcGFjaW5nfXB4YCA6IHNwYWNpbmc7XG4gICAgICAgIGNvbnN0IHNlbGVjdGVkU3BhY2luZyA9IHBlcmlvZChzcGFjZSk7XG4gICAgICAgIGlmICh0eXBlb2Ygb25MYXlvdXQgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgICAgIG9uTGF5b3V0KHtcbiAgICAgICAgICAgICAgICBsYXlvdXQsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gKDxTdHlsZWRHcmlkV3JhcHBlciByZWY9e2lubmVyUmVmfT5cbiAgICAgICAgeyEhdW51c2VkLmxlbmd0aCAmJiAoPFNoYWRvd0dyaWQgcm93cz17bGF5b3V0LnJvd3N9IGNvbHVtbnM9e2xheW91dC5jb2x1bW5zfSBzcGFjaW5nPXtzZWxlY3RlZFNwYWNpbmd9PlxuICAgICAgICAgICAge3VudXNlZH1cbiAgICAgICAgICA8L1NoYWRvd0dyaWQ+KX1cbiAgICAgICAgPEdyaWRMYXlvdXQgcm93cz17bGF5b3V0LnJvd3N9IGNvbHVtbnM9e2xheW91dC5jb2x1bW5zfSBzcGFjaW5nPXtzZWxlY3RlZFNwYWNpbmd9IHsuLi5wcm9wc30+XG4gICAgICAgICAge2xheW91dC5jZWxsc31cbiAgICAgICAgPC9HcmlkTGF5b3V0PlxuICAgICAgPC9TdHlsZWRHcmlkV3JhcHBlcj4pO1xuICAgIH1cbiAgICBzdGF0aWMgaW5uZXIgPSB7XG4gICAgICAgIGdldCBTdHlsZWRHcmlkV3JhcHBlcigpIHsgcmV0dXJuIFN0eWxlZEdyaWRXcmFwcGVyIGFzIHR5cGVvZiBTdHlsZWRHcmlkV3JhcHBlcjsgfSxcbiAgICAgICAgZ2V0IFNoYWRvd0dyaWQoKSB7IHJldHVybiBTaGFkb3dHcmlkIGFzIHR5cGVvZiBTaGFkb3dHcmlkOyB9LFxuICAgICAgICBnZXQgR3JpZExheW91dCgpIHsgcmV0dXJuIEdyaWRMYXlvdXQgYXMgdHlwZW9mIEdyaWRMYXlvdXQ7IH1cbiAgICB9O1xufVxuIl19