"use strict";
var __extends = (this && this.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var __assign = (this && this.__assign) || function () {
    __assign = Object.assign || function(t) {
        for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
        }
        return t;
    };
    return __assign.apply(this, arguments);
};
Object.defineProperty(exports, "__esModule", { value: true });
var React = require("react");
var eventManager_1 = require("../../utils/eventManager");
var Dropzone_1 = require("../Dropzone");
var FileUploaderDetails_1 = require("../FileUploaderDetails");
var helpers_1 = require("./helpers");
var UploadData = /** @class */ (function () {
    function UploadData(events) {
        var _this = this;
        this.filesChanged = function (_a) {
            var files = _a.files;
            var filteredFiles = files.filter(function (item) { return item.uploaderId === _this.id; });
            if (filteredFiles.length > 0) {
                var ids = filteredFiles.map(function (item) { return item.fileId; });
                var changed = false;
                for (var _i = 0, _b = _this.files; _i < _b.length; _i++) {
                    var file = _b[_i];
                    var index = ids.indexOf(file.id);
                    if (index !== -1) {
                        var updatedFile = filteredFiles[index];
                        var updatedStatus = helpers_1.getSimpleStatus(updatedFile);
                        var hasChanged = updatedFile.data !== file.data || updatedFile.progress !== file.progress || file.status !== updatedStatus;
                        if (hasChanged) {
                            changed = true;
                            file.data = updatedFile.data;
                            file.progress = updatedFile.progress;
                            file.status = updatedStatus;
                        }
                    }
                }
                if (changed) {
                    _this.emit('change');
                    if (_this.ready) {
                        _this.emit('ready');
                    }
                }
            }
        };
        this.id = helpers_1.generateId();
        this.events = events || eventManager_1.eventManagers[0];
        this.files = [];
        this.notifications = [];
    }
    Object.defineProperty(UploadData.prototype, "completedFiles", {
        get: function () {
            return this.files.filter(function (m) { return m.status === 'complete'; });
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(UploadData.prototype, "ready", {
        get: function () {
            return this.files.reduce(function (prev, curr) { return prev && (curr.status === 'complete' || curr.status === 'canceled'); }, true);
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(UploadData.prototype, "total", {
        get: function () {
            return this.files.filter(function (file) { return file.status !== 'canceled'; }).length;
        },
        enumerable: true,
        configurable: true
    });
    UploadData.prototype.commit = function (cb) {
        var _this = this;
        var handler = function () { return cb(_this.completedFiles); };
        if (this.ready) {
            handler();
        }
        else {
            this.once('ready', handler);
        }
    };
    UploadData.prototype.once = function (type, cb) {
        var _this = this;
        var handler = function () {
            _this.off(type, handler);
            cb();
        };
        this.on(type, handler);
    };
    UploadData.prototype.on = function (type, cb) {
        if (this.notifications.length === 0) {
            this.connect();
        }
        this.notifications.push({ type: type, cb: cb });
    };
    UploadData.prototype.off = function (type, cb) {
        for (var i = this.notifications.length; i--;) {
            var notification = this.notifications[i];
            if (notification.type === type && notification.cb === cb) {
                this.notifications.splice(i, 1);
            }
        }
        if (this.notifications.length === 0) {
            this.disconnect();
        }
    };
    UploadData.prototype.connect = function () {
        var em = this.events;
        em.on(FileUploaderDetails_1.FileUploadActions.uploadProgress, this.filesChanged);
        em.on(FileUploaderDetails_1.FileUploadActions.uploadFailure, this.filesChanged);
        em.on(FileUploaderDetails_1.FileUploadActions.uploadSuccess, this.filesChanged);
    };
    UploadData.prototype.disconnect = function () {
        var em = this.events;
        em.off(FileUploaderDetails_1.FileUploadActions.uploadProgress, this.filesChanged);
        em.off(FileUploaderDetails_1.FileUploadActions.uploadFailure, this.filesChanged);
        em.off(FileUploaderDetails_1.FileUploadActions.uploadSuccess, this.filesChanged);
        em.emit(FileUploaderDetails_1.FileUploadActions.clearUploads, this.id);
    };
    UploadData.prototype.emit = function (type) {
        for (var _i = 0, _a = this.notifications; _i < _a.length; _i++) {
            var notification = _a[_i];
            if (notification.type === type) {
                notification.cb();
            }
        }
    };
    UploadData.prototype.push = function (files) {
        /**
         * TODO:
         * Update `FileSelect` component to assign generated id
         * to a file to enable multiple selection of the same file
         */
        var names = this.files.map(function (item) { return (item.status !== 'canceled' ? item.name : ''); });
        var newUploadFiles = [];
        for (var _i = 0, files_1 = files; _i < files_1.length; _i++) {
            var file = files_1[_i];
            if (names.indexOf(file.name) === -1) {
                var id = helpers_1.generateId();
                var added = new Date();
                var data = {};
                newUploadFiles.push({
                    name: file.name,
                    fileId: id,
                    content: file,
                    type: file.type,
                    uploaderId: this.id,
                    timestamp: added,
                    data: data,
                });
                this.files.push({
                    id: id,
                    added: added,
                    status: 'new',
                    data: data,
                    name: file.name,
                    progress: 0,
                    type: file.type,
                });
            }
        }
        if (newUploadFiles.length) {
            this.emit('change');
            this.events.emit(FileUploaderDetails_1.FileUploadActions.startUpload, { files: newUploadFiles });
        }
    };
    return UploadData;
}());
exports.UploadData = UploadData;
/**
 * The file uploader component that passes selected files to global uploader. Should be used with `FileUploaderDetails` component.
 */
var FileUploader = /** @class */ (function (_super) {
    __extends(FileUploader, _super);
    function FileUploader(props) {
        var _this = _super.call(this, props) || this;
        _this.emitChange = function () {
            var onChange = _this.props.onChange;
            if (typeof onChange === 'function') {
                var _a = _this.data, files = _a.files, ready = _a.ready, total = _a.total;
                onChange({
                    files: files.map(function (file) { return ({
                        data: file.data,
                        id: file.id,
                        name: file.name,
                        progress: file.progress,
                        state: file.status,
                        type: file.type,
                    }); }),
                    ready: ready,
                    total: total,
                });
            }
        };
        _this.filesAdded = function (e) {
            _this.data.push(e.value);
        };
        _this.fileSelect = function (e) {
            var multiple = _this.props.multiple;
            var _a = _this.data, files = _a.files, events = _a.events;
            var notCanceledFiles = files.filter(function (file) { return file.status !== 'canceled'; });
            if (!multiple && notCanceledFiles.length === 1) {
                var completedFiles = notCanceledFiles.filter(function (file) { return file.status === 'complete'; });
                if (completedFiles.length === 0) {
                    e.preventDefault();
                    events.emit(FileUploaderDetails_1.FileUploadActions.showUploads, {});
                }
            }
        };
        var _a = props.data, data = _a === void 0 ? new UploadData() : _a;
        _this.data = data;
        return _this;
    }
    FileUploader.prototype.componentDidMount = function () {
        this.data.on('change', this.emitChange);
    };
    FileUploader.prototype.componentWillUnmount = function () {
        this.data.off('change', this.emitChange);
    };
    FileUploader.prototype.render = function () {
        var _a = this.props, multiple = _a.multiple, message = _a.message, children = _a.children, showFileList = _a.showFileList;
        var additionalProps = !showFileList ? { value: [] } : {};
        return (React.createElement(Dropzone_1.Dropzone, __assign({ multiple: multiple, onChange: this.filesAdded, onOpen: this.fileSelect, message: message }, additionalProps), children));
    };
    FileUploader.inner = {
        get Dropzone() { return Dropzone_1.Dropzone; }
    };
    return FileUploader;
}(React.Component));
exports.FileUploader = FileUploader;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvY29tcG9uZW50cy9GaWxlVXBsb2FkZXIvaW5kZXgudHN4Il0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsNkJBQStCO0FBQy9CLHlEQUF1RTtBQUN2RSx3Q0FBK0U7QUFDL0UsOERBQTZHO0FBQzdHLHFDQUF3RDtBQWtGeEQ7SUFLSSxvQkFBWSxNQUFxQjtRQUFqQyxpQkFLQztRQStETyxpQkFBWSxHQUFHLFVBQUMsRUFBaUQ7Z0JBQS9DLGdCQUFLO1lBQzNCLElBQU0sYUFBYSxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUMsVUFBQSxJQUFJLElBQUksT0FBQSxJQUFJLENBQUMsVUFBVSxLQUFLLEtBQUksQ0FBQyxFQUFFLEVBQTNCLENBQTJCLENBQUMsQ0FBQztZQUN4RSxJQUFJLGFBQWEsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO2dCQUMxQixJQUFNLEdBQUcsR0FBRyxhQUFhLENBQUMsR0FBRyxDQUFDLFVBQUEsSUFBSSxJQUFJLE9BQUEsSUFBSSxDQUFDLE1BQU0sRUFBWCxDQUFXLENBQUMsQ0FBQztnQkFDbkQsSUFBSSxPQUFPLEdBQUcsS0FBSyxDQUFDO2dCQUNwQixLQUFtQixVQUFVLEVBQVYsS0FBQSxLQUFJLENBQUMsS0FBSyxFQUFWLGNBQVUsRUFBVixJQUFVLEVBQUU7b0JBQTFCLElBQU0sSUFBSSxTQUFBO29CQUNYLElBQU0sS0FBSyxHQUFHLEdBQUcsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO29CQUNuQyxJQUFJLEtBQUssS0FBSyxDQUFDLENBQUMsRUFBRTt3QkFDZCxJQUFNLFdBQVcsR0FBRyxhQUFhLENBQUMsS0FBSyxDQUFDLENBQUM7d0JBQ3pDLElBQU0sYUFBYSxHQUFHLHlCQUFlLENBQUMsV0FBVyxDQUFDLENBQUM7d0JBQ25ELElBQU0sVUFBVSxHQUFHLFdB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IjpbImltcG9ydCAqIGFzIFJlYWN0IGZyb20gJ3JlYWN0JztcbmltcG9ydCB7IEV2ZW50TWFuYWdlciwgZXZlbnRNYW5hZ2VycyB9IGZyb20gJy4uLy4uL3V0aWxzL2V2ZW50TWFuYWdlcic7XG5pbXBvcnQgeyBEcm9wem9uZSwgRHJvcHpvbmVPcGVuRXZlbnQsIERyb3B6b25lQ2hhbmdlRXZlbnQgfSBmcm9tICcuLi9Ecm9wem9uZSc7XG5pbXBvcnQgeyBGaWxlVXBsb2FkQWN0aW9ucywgRmlsZUl0ZW0sIEZpbGVQcm9ncmVzcywgRmlsZVVwbG9hZGVyRGV0YWlsc0V2ZW50IH0gZnJvbSAnLi4vRmlsZVVwbG9hZGVyRGV0YWlscyc7XG5pbXBvcnQgeyBnZW5lcmF0ZUlkLCBnZXRTaW1wbGVTdGF0dXMgfSBmcm9tICcuL2hlbHBlcnMnO1xuZXhwb3J0IHR5cGUgVXBsb2FkRmlsZVN0YXRlID0gJ25ldycgfCAnYWN0aXZlJyB8ICdjYW5jZWxlZCcgfCAnY29tcGxldGUnO1xuZXhwb3J0IGludGVyZmFjZSBVcGxvYWRGaWxlU3RhdHVzIHtcbiAgICAvKipcbiAgICAgKiBUaGUgaWQgb2YgdGhlIGZpbGUgZm9yIGlkZW50aWZpY2F0aW9uLlxuICAgICAqL1xuICAgIGlkOiBzdHJpbmc7XG4gICAgLyoqXG4gICAgICogVGhlIG5hbWUgb2YgdGhlIGZpbGUuXG4gICAgICovXG4gICAgbmFtZTogc3RyaW5nO1xuICAgIC8qKlxuICAgICAqIFRoZSBjb250ZW50LXR5cGUgb2YgdGhlIGZpbGUuXG4gICAgICovXG4gICAgdHlwZTogc3RyaW5nO1xuICAgIC8qKlxuICAgICAqIFRoZSBjdXJyZW50IHByb2dyZXNzIG9mIHRoZSBmaWxlLlxuICAgICAqL1xuICAgIHByb2dyZXNzOiBudW1iZXI7XG4gICAgLyoqXG4gICAgICogVGhlIGN1cnJlbnQgc3RhdGUgb2YgdGhlIGZpbGUuXG4gICAgICovXG4gICAgc3RhdGU6IFVwbG9hZEZpbGVTdGF0ZTtcbiAgICAvKipcbiAgICAgKiBBcmJpdHJhcnkgZGF0YSBhc3NvY2lhdGVkIHdpdGggdGhlIGZpbGUsIHdoaWNoIGlzIHNldCBieSB0aGUgdXBsb2FkIGhvc3QuXG4gICAgICovXG4gICAgZGF0YTogYW55O1xufVxuZXhwb3J0IGludGVyZmFjZSBGaWxlVXBsb2FkZXJDaGFuZ2VFdmVudCB7XG4gICAgLyoqXG4gICAgICogVGhlIGZpbGVzIHRoYXQgY2hhbmdlZC5cbiAgICAgKi9cbiAgICBmaWxlczogQXJyYXk8VXBsb2FkRmlsZVN0YXR1cz47XG4gICAgLyoqXG4gICAgICogVGhlIHRvdGFsIG51bWJlciBvZiBzZWxlY3RlZCBmaWxlcy5cbiAgICAgKi9cbiAgICB0b3RhbDogbnVtYmVyO1xuICAgIC8qKlxuICAgICAqIFN0YXR1cyBpZiB0aGUgc2VsZWN0ZWQgZmlsZXMgYXJlIGFsbCB1cGxvYWRlZCBhbmQgdmVyaWZpZWQuXG4gICAgICovXG4gICAgcmVhZHk6IGJvb2xlYW47XG59XG5leHBvcnQgaW50ZXJmYWNlIEZpbGVVcGxvYWRlclByb3BzIHtcbiAgICAvKipcbiAgICAgKiBBbGxvdyBzZWxlY3RpbmcgbXVsdGlwbGUgZmlsZXMuXG4gICAgICovXG4gICAgbXVsdGlwbGU/OiBib29sZWFuO1xuICAgIC8qKlxuICAgICAqIEV2ZW50IGVtaXR0ZWQgd2hlbiBmaWxlIHVwbG9hZCBjaGFuZ2VzLlxuICAgICAqL1xuICAgIG9uQ2hhbmdlPyhlOiBGaWxlVXBsb2FkZXJDaGFuZ2VFdmVudCk6IHZvaWQ7XG4gICAgLyoqXG4gICAgICogT3B0aW9uYWxseSB1c2VzIGFuIGV4cGxpY2l0IHVwbG9hZCBkYXRhIGNvbm5lY3Rvci5cbiAgICAgKi9cbiAgICBkYXRhPzogVXBsb2FkRGF0YTtcbiAgICAvKipcbiAgICAgKiBNZXNzYWdlIGZvciBkcmFnZ2luZyBmaWxlcyB0byBzaG93IG9uIGRyb3AgYXJlYS5cbiAgICAgKiBAZGVmYXVsdCBcIkRyb3AgZmlsZXMgaGVyZSB0byB1cGxvYWRcIlxuICAgICAqL1xuICAgIG1lc3NhZ2U/OiBzdHJpbmc7XG4gICAgLyoqXG4gICAgICogU2hvdyB0aGUgZmlsZSBsaXN0IHVuZGVyIHRoZSBkcm9wIHpvbmVcbiAgICAgKi9cbiAgICBzaG93RmlsZUxpc3Q/OiBib29sZWFuO1xufVxuZXhwb3J0IGludGVyZmFjZSBVcGxvYWRGaWxlIHtcbiAgICBpZDogc3RyaW5nO1xuICAgIG5hbWU6IHN0cmluZztcbiAgICB0eXBlOiBzdHJpbmc7XG4gICAgcHJvZ3Jlc3M6IG51bWJlcjtcbiAgICBkYXRhOiBhbnk7XG4gICAgYWRkZWQ6IERhdGU7XG4gICAgc3RhdHVzOiBVcGxvYWRGaWxlU3RhdGU7XG59XG5leHBvcnQgdHlwZSBVcGxvYWREYXRhRXZlbnRUeXBlID0gJ2NoYW5nZScgfCAncmVhZHknO1xuZXhwb3J0IGludGVyZmFjZSBVcGxvYWREYXRhRXZlbnRMaXN0ZW5lciB7XG4gICAgKCk6IHZvaWQ7XG59XG5pbnRlcmZhY2UgVXBsb2FkRGF0YU5vdGlmaWNhdGlvbiB7XG4gICAgdHlwZTogVXBsb2FkRGF0YUV2ZW50VHlwZTtcbiAgICBjYjogVXBsb2FkRGF0YUV2ZW50TGlzdGVuZXI7XG59XG5leHBvcnQgY2xhc3MgVXBsb2FkRGF0YSB7XG4gICAgcmVhZG9ubHkgaWQ6IHN0cmluZztcbiAgICByZWFkb25seSBldmVudHM6IEV2ZW50TWFuYWdlcjtcbiAgICByZWFkb25seSBmaWxlczogQXJyYXk8VXBsb2FkRmlsZT47XG4gICAgcHJpdmF0ZSByZWFkb25seSBub3RpZmljYXRpb25zOiBBcnJheTxVcGxvYWREYXRhTm90aWZpY2F0aW9uPjtcbiAgICBjb25zdHJ1Y3RvcihldmVudHM/OiBFdmVudE1hbmFnZXIpIHtcbiAgICAgICAgdGhpcy5pZCA9IGdlbmVyYXRlSWQoKTtcbiAgICAgICAgdGhpcy5ldmVudHMgPSBldmVudHMgfHwgZXZlbnRNYW5hZ2Vyc1swXTtcbiAgICAgICAgdGhpcy5maWxlcyA9IFtdO1xuICAgICAgICB0aGlzLm5vdGlmaWNhdGlvbnMgPSBbXTtcbiAgICB9XG4gICAgZ2V0IGNvbXBsZXRlZEZpbGVzKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5maWxlcy5maWx0ZXIobSA9PiBtLnN0YXR1cyA9PT0gJ2NvbXBsZXRlJyk7XG4gICAgfVxuICAgIGdldCByZWFkeSgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZmlsZXMucmVkdWNlKChwcmV2LCBjdXJyKSA9PiBwcmV2ICYmIChjdXJyLnN0YXR1cyA9PT0gJ2NvbXBsZXRlJyB8fCBjdXJyLnN0YXR1cyA9PT0gJ2NhbmNlbGVkJyksIHRydWUpO1xuICAgIH1cbiAgICBnZXQgdG90YWwoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmZpbGVzLmZpbHRlcihmaWxlID0+IGZpbGUuc3RhdHVzICE9PSAnY2FuY2VsZWQnKS5sZW5ndGg7XG4gICAgfVxuICAgIGNvbW1pdChjYjogKGNvbXBsZXRlZEZpbGVzOiBBcnJheTxVcGxvYWRGaWxlPikgPT4gdm9pZCkge1xuICAgICAgICBjb25zdCBoYW5kbGVyID0gKCkgPT4gY2IodGhpcy5jb21wbGV0ZWRGaWxlcyk7XG4gICAgICAgIGlmICh0aGlzLnJlYWR5KSB7XG4gICAgICAgICAgICBoYW5kbGVyKCk7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICB0aGlzLm9uY2UoJ3JlYWR5JywgaGFuZGxlcik7XG4gICAgICAgIH1cbiAgICB9XG4gICAgb25jZSh0eXBlOiBVcGxvYWREYXRhRXZlbnRUeXBlLCBjYjogVXBsb2FkRGF0YUV2ZW50TGlzdGVuZXIpIHtcbiAgICAgICAgY29uc3QgaGFuZGxlciA9ICgpID0+IHtcbiAgICAgICAgICAgIHRoaXMub2ZmKHR5cGUsIGhhbmRsZXIpO1xuICAgICAgICAgICAgY2IoKTtcbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy5vbih0eXBlLCBoYW5kbGVyKTtcbiAgICB9XG4gICAgb24odHlwZTogVXBsb2FkRGF0YUV2ZW50VHlwZSwgY2I6IFVwbG9hZERhdGFFdmVudExpc3RlbmVyKSB7XG4gICAgICAgIGlmICh0aGlzLm5vdGlmaWNhdGlvbnMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICB0aGlzLmNvbm5lY3QoKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLm5vdGlmaWNhdGlvbnMucHVzaCh7IHR5cGUsIGNiIH0pO1xuICAgIH1cbiAgICBvZmYodHlwZTogVXBsb2FkRGF0YUV2ZW50VHlwZSwgY2I6IFVwbG9hZERhdGFFdmVudExpc3RlbmVyKSB7XG4gICAgICAgIGZvciAobGV0IGkgPSB0aGlzLm5vdGlmaWNhdGlvbnMubGVuZ3RoOyBpLS07KSB7XG4gICAgICAgICAgICBjb25zdCBub3RpZmljYXRpb24gPSB0aGlzLm5vdGlmaWNhdGlvbnNbaV07XG4gICAgICAgICAgICBpZiAobm90aWZpY2F0aW9uLnR5cGUgPT09IHR5cGUgJiYgbm90aWZpY2F0aW9uLmNiID09PSBjYikge1xuICAgICAgICAgICAgICAgIHRoaXMubm90aWZpY2F0aW9ucy5zcGxpY2UoaSwgMSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMubm90aWZpY2F0aW9ucy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgIHRoaXMuZGlzY29ubmVjdCgpO1xuICAgICAgICB9XG4gICAgfVxuICAgIHByaXZhdGUgY29ubmVjdCgpIHtcbiAgICAgICAgY29uc3QgZW0gPSB0aGlzLmV2ZW50cztcbiAgICAgICAgZW0ub24oRmlsZVVwbG9hZEFjdGlvbnMudXBsb2FkUHJvZ3Jlc3MsIHRoaXMuZmlsZXNDaGFuZ2VkKTtcbiAgICAgICAgZW0ub24oRmlsZVVwbG9hZEFjdGlvbnMudXBsb2FkRmFpbHVyZSwgdGhpcy5maWxlc0NoYW5nZWQpO1xuICAgICAgICBlbS5vbihGaWxlVXBsb2FkQWN0aW9ucy51cGxvYWRTdWNjZXNzLCB0aGlzLmZpbGVzQ2hhbmdlZCk7XG4gICAgfVxuICAgIHByaXZhdGUgZGlzY29ubmVjdCgpIHtcbiAgICAgICAgY29uc3QgZW0gPSB0aGlzLmV2ZW50cztcbiAgICAgICAgZW0ub2ZmKEZpbGVVcGxvYWRBY3Rpb25zLnVwbG9hZFByb2dyZXNzLCB0aGlzLmZpbGVzQ2hhbmdlZCk7XG4gICAgICAgIGVtLm9mZihGaWxlVXBsb2FkQWN0aW9ucy51cGxvYWRGYWlsdXJlLCB0aGlzLmZpbGVzQ2hhbmdlZCk7XG4gICAgICAgIGVtLm9mZihGaWxlVXBsb2FkQWN0aW9ucy51cGxvYWRTdWNjZXNzLCB0aGlzLmZpbGVzQ2hhbmdlZCk7XG4gICAgICAgIGVtLmVtaXQoRmlsZVVwbG9hZEFjdGlvbnMuY2xlYXJVcGxvYWRzLCB0aGlzLmlkKTtcbiAgICB9XG4gICAgcHJpdmF0ZSBlbWl0KHR5cGU6IFVwbG9hZERhdGFFdmVudFR5cGUpIHtcbiAgICAgICAgZm9yIChjb25zdCBub3RpZmljYXRpb24gb2YgdGhpcy5ub3RpZmljYXRpb25zKSB7XG4gICAgICAgICAgICBpZiAobm90aWZpY2F0aW9uLnR5cGUgPT09IHR5cGUpIHtcbiAgICAgICAgICAgICAgICBub3RpZmljYXRpb24uY2IoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICBwcml2YXRlIGZpbGVzQ2hhbmdlZCA9ICh7IGZpbGVzIH06IEZpbGVVcGxvYWRlckRldGFpbHNFdmVudDxGaWxlUHJvZ3Jlc3M+KSA9PiB7XG4gICAgICAgIGNvbnN0IGZpbHRlcmVkRmlsZXMgPSBmaWxlcy5maWx0ZXIoaXRlbSA9PiBpdGVtLnVwbG9hZGVySWQgPT09IHRoaXMuaWQpO1xuICAgICAgICBpZiAoZmlsdGVyZWRGaWxlcy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICBjb25zdCBpZHMgPSBmaWx0ZXJlZEZpbGVzLm1hcChpdGVtID0+IGl0ZW0uZmlsZUlkKTtcbiAgICAgICAgICAgIGxldCBjaGFuZ2VkID0gZmFsc2U7XG4gICAgICAgICAgICBmb3IgKGNvbnN0IGZpbGUgb2YgdGhpcy5maWxlcykge1xuICAgICAgICAgICAgICAgIGNvbnN0IGluZGV4ID0gaWRzLmluZGV4T2YoZmlsZS5pZCk7XG4gICAgICAgICAgICAgICAgaWYgKGluZGV4ICE9PSAtMSkge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCB1cGRhdGVkRmlsZSA9IGZpbHRlcmVkRmlsZXNbaW5kZXhdO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCB1cGRhdGVkU3RhdHVzID0gZ2V0U2ltcGxlU3RhdHVzKHVwZGF0ZWRGaWxlKTtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgaGFzQ2hhbmdlZCA9IHVwZGF0ZWRGaWxlLmRhdGEgIT09IGZpbGUuZGF0YSB8fCB1cGRhdGVkRmlsZS5wcm9ncmVzcyAhPT0gZmlsZS5wcm9ncmVzcyB8fCBmaWxlLnN0YXR1cyAhPT0gdXBkYXRlZFN0YXR1cztcbiAgICAgICAgICAgICAgICAgICAgaWYgKGhhc0NoYW5nZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNoYW5nZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgZmlsZS5kYXRhID0gdXBkYXRlZEZpbGUuZGF0YTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZpbGUucHJvZ3Jlc3MgPSB1cGRhdGVkRmlsZS5wcm9ncmVzcztcbiAgICAgICAgICAgICAgICAgICAgICAgIGZpbGUuc3RhdHVzID0gdXBkYXRlZFN0YXR1cztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChjaGFuZ2VkKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5lbWl0KCdjaGFuZ2UnKTtcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5yZWFkeSkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmVtaXQoJ3JlYWR5Jyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfTtcbiAgICBwdXNoKGZpbGVzOiBBcnJheTxGaWxlPikge1xuICAgICAgICAvKipcbiAgICAgICAgICogVE9ETzpcbiAgICAgICAgICogVXBkYXRlIGBGaWxlU2VsZWN0YCBjb21wb25lbnQgdG8gYXNzaWduIGdlbmVyYXRlZCBpZFxuICAgICAgICAgKiB0byBhIGZpbGUgdG8gZW5hYmxlIG11bHRpcGxlIHNlbGVjdGlvbiBvZiB0aGUgc2FtZSBmaWxlXG4gICAgICAgICAqL1xuICAgICAgICBjb25zdCBuYW1lcyA9IHRoaXMuZmlsZXMubWFwKGl0ZW0gPT4gKGl0ZW0uc3RhdHVzICE9PSAnY2FuY2VsZWQnID8gaXRlbS5uYW1lIDogJycpKTtcbiAgICAgICAgY29uc3QgbmV3VXBsb2FkRmlsZXM6IEFycmF5PEZpbGVJdGVtPiA9IFtdO1xuICAgICAgICBmb3IgKGNvbnN0IGZpbGUgb2YgZmlsZXMpIHtcbiAgICAgICAgICAgIGlmIChuYW1lcy5pbmRleE9mKGZpbGUubmFtZSkgPT09IC0xKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgaWQgPSBnZW5lcmF0ZUlkKCk7XG4gICAgICAgICAgICAgICAgY29uc3QgYWRkZWQgPSBuZXcgRGF0ZSgpO1xuICAgICAgICAgICAgICAgIGNvbnN0IGRhdGEgPSB7fTtcbiAgICAgICAgICAgICAgICBuZXdVcGxvYWRGaWxlcy5wdXNoKHtcbiAgICAgICAgICAgICAgICAgICAgbmFtZTogZmlsZS5uYW1lLFxuICAgICAgICAgICAgICAgICAgICBmaWxlSWQ6IGlkLFxuICAgICAgICAgICAgICAgICAgICBjb250ZW50OiBmaWxlLFxuICAgICAgICAgICAgICAgICAgICB0eXBlOiBmaWxlLnR5cGUsXG4gICAgICAgICAgICAgICAgICAgIHVwbG9hZGVySWQ6IHRoaXMuaWQsXG4gICAgICAgICAgICAgICAgICAgIHRpbWVzdGFtcDogYWRkZWQsXG4gICAgICAgICAgICAgICAgICAgIGRhdGEsXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgdGhpcy5maWxlcy5wdXNoKHtcbiAgICAgICAgICAgICAgICAgICAgaWQsXG4gICAgICAgICAgICAgICAgICAgIGFkZGVkLFxuICAgICAgICAgICAgICAgICAgICBzdGF0dXM6ICduZXcnLFxuICAgICAgICAgICAgICAgICAgICBkYXRhLFxuICAgICAgICAgICAgICAgICAgICBuYW1lOiBmaWxlLm5hbWUsXG4gICAgICAgICAgICAgICAgICAgIHByb2dyZXNzOiAwLFxuICAgICAgICAgICAgICAgICAgICB0eXBlOiBmaWxlLnR5cGUsXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKG5ld1VwbG9hZEZpbGVzLmxlbmd0aCkge1xuICAgICAgICAgICAgdGhpcy5lbWl0KCdjaGFuZ2UnKTtcbiAgICAgICAgICAgIHRoaXMuZXZlbnRzLmVtaXQoRmlsZVVwbG9hZEFjdGlvbnMuc3RhcnRVcGxvYWQsIHsgZmlsZXM6IG5ld1VwbG9hZEZpbGVzIH0pO1xuICAgICAgICB9XG4gICAgfVxufVxuLyoqXG4gKiBUaGUgZmlsZSB1cGxvYWRlciBjb21wb25lbnQgdGhhdCBwYXNzZXMgc2VsZWN0ZWQgZmlsZXMgdG8gZ2xvYmFsIHVwbG9hZGVyLiBTaG91bGQgYmUgdXNlZCB3aXRoIGBGaWxlVXBsb2FkZXJEZXRhaWxzYCBjb21wb25lbnQuXG4gKi9cbmV4cG9ydCBjbGFzcyBGaWxlVXBsb2FkZXIgZXh0ZW5kcyBSZWFjdC5Db21wb25lbnQ8RmlsZVVwbG9hZGVyUHJvcHM+IHtcbiAgICBwcml2YXRlIHJlYWRvbmx5IGRhdGE6IFVwbG9hZERhdGE7XG4gICAgY29uc3RydWN0b3IocHJvcHM6IEZpbGVVcGxvYWRlclByb3BzKSB7XG4gICAgICAgIHN1cGVyKHByb3BzKTtcbiAgICAgICAgY29uc3QgeyBkYXRhID0gbmV3IFVwbG9hZERhdGEoKSB9ID0gcHJvcHM7XG4gICAgICAgIHRoaXMuZGF0YSA9IGRhdGE7XG4gICAgfVxuICAgIGNvbXBvbmVudERpZE1vdW50KCkge1xuICAgICAgICB0aGlzLmRhdGEub24oJ2NoYW5nZScsIHRoaXMuZW1pdENoYW5nZSk7XG4gICAgfVxuICAgIGNvbXBvbmVudFdpbGxVbm1vdW50KCkge1xuICAgICAgICB0aGlzLmRhdGEub2ZmKCdjaGFuZ2UnLCB0aGlzLmVtaXRDaGFuZ2UpO1xuICAgIH1cbiAgICBwcml2YXRlIGVtaXRDaGFuZ2UgPSAoKSA9PiB7XG4gICAgICAgIGNvbnN0IHsgb25DaGFuZ2UgfSA9IHRoaXMucHJvcHM7XG4gICAgICAgIGlmICh0eXBlb2Ygb25DaGFuZ2UgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgICAgIGNvbnN0IHsgZmlsZXMsIHJlYWR5LCB0b3RhbCB9ID0gdGhpcy5kYXRhO1xuICAgICAgICAgICAgb25DaGFuZ2Uoe1xuICAgICAgICAgICAgICAgIGZpbGVzOiBmaWxlcy5tYXA8VXBsb2FkRmlsZVN0YXR1cz4oZmlsZSA9PiAoe1xuICAgICAgICAgICAgICAgICAgICBkYXRhOiBmaWxlLmRhdGEsXG4gICAgICAgICAgICAgICAgICAgIGlkOiBmaWxlLmlkLFxuICAgICAgICAgICAgICAgICAgICBuYW1lOiBmaWxlLm5hbWUsXG4gICAgICAgICAgICAgICAgICAgIHByb2dyZXNzOiBmaWxlLnByb2dyZXNzLFxuICAgICAgICAgICAgICAgICAgICBzdGF0ZTogZmlsZS5zdGF0dXMsXG4gICAgICAgICAgICAgICAgICAgIHR5cGU6IGZpbGUudHlwZSxcbiAgICAgICAgICAgICAgICB9KSksXG4gICAgICAgICAgICAgICAgcmVhZHksXG4gICAgICAgICAgICAgICAgdG90YWwsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH07XG4gICAgcHJpdmF0ZSBmaWxlc0FkZGVkID0gKGU6IERyb3B6b25lQ2hhbmdlRXZlbnQpID0+IHtcbiAgICAgICAgdGhpcy5kYXRhLnB1c2goZS52YWx1ZSk7XG4gICAgfTtcbiAgICBwcml2YXRlIGZpbGVTZWxlY3QgPSAoZTogRHJvcHpvbmVPcGVuRXZlbnQpID0+IHtcbiAgICAgICAgY29uc3QgeyBtdWx0aXBsZSB9ID0gdGhpcy5wcm9wcztcbiAgICAgICAgY29uc3QgeyBmaWxlcywgZXZlbnRzIH0gPSB0aGlzLmRhdGE7XG4gICAgICAgIGNvbnN0IG5vdENhbmNlbGVkRmlsZXMgPSBmaWxlcy5maWx0ZXIoZmlsZSA9PiBmaWxlLnN0YXR1cyAhPT0gJ2NhbmNlbGVkJyk7XG4gICAgICAgIGlmICghbXVsdGlwbGUgJiYgbm90Q2FuY2VsZWRGaWxlcy5sZW5ndGggPT09IDEpIHtcbiAgICAgICAgICAgIGNvbnN0IGNvbXBsZXRlZEZpbGVzID0gbm90Q2FuY2VsZWRGaWxlcy5maWx0ZXIoZmlsZSA9PiBmaWxlLnN0YXR1cyA9PT0gJ2NvbXBsZXRlJyk7XG4gICAgICAgICAgICBpZiAoY29tcGxldGVkRmlsZXMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgICAgIGV2ZW50cy5lbWl0KEZpbGVVcGxvYWRBY3Rpb25zLnNob3dVcGxvYWRzLCB7fSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9O1xuICAgIHJlbmRlcigpIHtcbiAgICAgICAgY29uc3QgeyBtdWx0aXBsZSwgbWVzc2FnZSwgY2hpbGRyZW4sIHNob3dGaWxlTGlzdCB9ID0gdGhpcy5wcm9wcztcbiAgICAgICAgY29uc3QgYWRkaXRpb25hbFByb3BzID0gIXNob3dGaWxlTGlzdCA/IHsgdmFsdWU6IFtdIH0gOiB7fTtcbiAgICAgICAgcmV0dXJuICg8RHJvcHpvbmUgbXVsdGlwbGU9e211bHRpcGxlfSBvbkNoYW5nZT17dGhpcy5maWxlc0FkZGVkfSBvbk9wZW49e3RoaXMuZmlsZVNlbGVjdH0gbWVzc2FnZT17bWVzc2FnZX0gey4uLmFkZGl0aW9uYWxQcm9wc30+XG4gICAgICAgIHtjaGlsZHJlbn1cbiAgICAgIDwvRHJvcHpvbmU+KTtcbiAgICB9XG4gICAgc3RhdGljIGlubmVyID0ge1xuICAgICAgICBnZXQgRHJvcHpvbmUoKSB7IHJldHVybiBEcm9wem9uZSBhcyB0eXBlb2YgRHJvcHpvbmU7IH1cbiAgICB9O1xufVxuIl19