"use strict";
var __extends = (this && this.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var __assign = (this && this.__assign) || function () {
    __assign = Object.assign || function(t) {
        for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
        }
        return t;
    };
    return __assign.apply(this, arguments);
};
var __rest = (this && this.__rest) || function (s, e) {
    var t = {};
    for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)
        t[p] = s[p];
    if (s != null && typeof Object.getOwnPropertySymbols === "function")
        for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) if (e.indexOf(p[i]) < 0)
            t[p[i]] = s[p[i]];
    return t;
};
Object.defineProperty(exports, "__esModule", { value: true });
var React = require("react");
var memoize_one_1 = require("memoize-one");
var utils_1 = require("../../utils");
var TagBuilder_1 = require("../TagBuilder");
var Autocomplete_1 = require("../Autocomplete");
var AutocompleteTagBuilderInt = /** @class */ (function (_super) {
    __extends(AutocompleteTagBuilderInt, _super);
    function AutocompleteTagBuilderInt(props) {
        var _this = _super.call(this, props) || this;
        _this.removeValueByIndex = function (index) {
            var value = _this.state.value;
            var keys = Array.from(value.keys());
            index = index >= 0 ? index : keys.length + index;
            if (index >= 0 && index < keys.length) {
                value.splice(index, 1);
                var newValue = value.slice();
                _this.updateValue(newValue);
            }
        };
        _this.getTagsArray = memoize_one_1.default(function (value) {
            return value.map(function (x) { return _this.getSuggestionValue(x); });
        });
        _this.tagRemoveHandler = function (index) {
            _this.removeValueByIndex(index);
        };
        _this.suggestionSelectedHandler = function (e) {
            _this.addSuggestion(e.value);
        };
        _this.inputChangeHandler = function (e) {
            _this.changeInputValue(e.value);
        };
        _this.inputRefHandler = function (node) {
            _this._inputNode = node;
        };
        _this.tagBuilderRenderer = function (inputProps) {
            var _a = _this.props, disabled = _a.disabled, tagRenderer = _a.tagRenderer, _b = _a.borderless, borderless = _b === void 0 ? false : _b;
            var value = _this.state.value;
            var onChange = inputProps.onChange, inputValue = inputProps.value, restProps = __rest(inputProps, ["onChange", "value"]);
            var tagBuilderValue = _this.getTagsArray(value);
            return (React.createElement(TagBuilder_1.TagBuilder, __assign({}, restProps, { disabled: disabled, inputValue: inputValue, onInput: onChange, value: tagBuilderValue, tagRenderer: tagRenderer, borderless: borderless, onBeforeTagRemove: _this.tagRemoveHandler })));
        };
        var _a = _this.props, nullableValue = _a.value, defaultValue = _a.defaultValue, onInputChange = _a.onInputChange, inputValue = _a.inputValue, _b = _a.delay, delay = _b === void 0 ? 0 : _b;
        var value = nullableValue || defaultValue || [];
        _this.state = {
            value: value,
            inputValue: inputValue || '',
            controlled: props.value !== undefined || inputValue !== undefined,
        };
        _this._fireOnInputChange = utils_1.debounce(function (value) {
            onInputChange && onInputChange({ value: value });
        }, delay);
        return _this;
    }
    AutocompleteTagBuilderInt.prototype.UNSAFE_componentWillReceiveProps = function (nextProps) {
        if (this.state.controlled) {
            var value = nextProps.value, inputValue = nextProps.inputValue;
            this.setState({
                value: value || [],
                inputValue: inputValue || '',
            });
        }
    };
    AutocompleteTagBuilderInt.prototype.componentDidMount = function () {
        var form = this.props.form;
        var controlled = this.state.controlled;
        if (!controlled && form) {
            form.subscribe(this);
        }
    };
    AutocompleteTagBuilderInt.prototype.componentWillUnmount = function () {
        var form = this.props.form;
        var controlled = this.state.controlled;
        if (!controlled && form) {
            form.unsubscribe(this);
        }
    };
    AutocompleteTagBuilderInt.prototype.addSuggestion = function (suggestion) {
        var _this = this;
        var value = this.state.value;
        var key = this.getSuggestionKey(suggestion);
        var suggestionAlreadyAdded = value.some(function (x) { return _this.getSuggestionKey(x) === key; });
        if (!suggestionAlreadyAdded) {
            var newValue = value.slice();
            newValue.push(suggestion);
            this.updateValue(newValue);
        }
        this.changeInputValue('');
    };
    AutocompleteTagBuilderInt.prototype.updateValue = function (newValue) {
        var _a = this.props, onChange = _a.onChange, _b = _a.name, name = _b === void 0 ? '' : _b, form = _a.form;
        if (!this.state.controlled) {
            if (form) {
                form.change({
                    name: name,
                    value: newValue,
                });
            }
            else {
                this.setState({
                    value: newValue,
                });
            }
        }
        if (this._inputNode) {
            this._inputNode.focus();
        }
        if (typeof onChange === 'function') {
            onChange({ value: newValue });
        }
    };
    AutocompleteTagBuilderInt.prototype.changeInputValue = function (newValue) {
        if (!this.state.controlled) {
            this.setState({
                inputValue: newValue,
            });
        }
        this._fireOnInputChange(newValue);
    };
    AutocompleteTagBuilderInt.prototype.getSuggestionValue = function (item) {
        var getSuggestionValue = this.props.getSuggestionValue;
        if (typeof item === 'string') {
            return item;
        }
        else if (typeof getSuggestionValue === 'function') {
            return getSuggestionValue(item);
        }
        else {
            throw new Error('Get suggestion value should be specified');
        }
    };
    AutocompleteTagBuilderInt.prototype.getSuggestionKey = function (item) {
        var getSuggestionKey = this.props.getSuggestionKey;
        if (typeof item === 'string') {
            return item;
        }
        else if (typeof getSuggestionKey === 'function') {
            return getSuggestionKey(item);
        }
        else {
            throw new Error('Get suggestion key should be specified');
        }
    };
    AutocompleteTagBuilderInt.prototype.defaultSuggestionRenderer = function (suggestion) {
        return {
            content: this.getSuggestionValue(suggestion),
            key: this.getSuggestionKey(suggestion),
        };
    };
    AutocompleteTagBuilderInt.prototype.render = function () {
        var _this = this;
        var _a = this.props, _b = _a.suggestions, suggestions = _b === void 0 ? [] : _b, noSuggestionsMessage = _a.noSuggestionsMessage, disabled = _a.disabled, _c = _a.renderSuggestion, renderSuggestion = _c === void 0 ? function (item) { return _this.defaultSuggestionRenderer(item); } : _c, label = _a.label, placeholder = _a.placeholder, info = _a.info, _d = _a.borderless, borderless = _d === void 0 ? false : _d, error = _a.error, onBlur = _a.onBlur, onFocus = _a.onFocus;
        var inputValue = this.state.inputValue;
        return (React.createElement(Autocomplete_1.Autocomplete, { noSuggestionsMessage: noSuggestionsMessage, suggestions: suggestions, inputRenderer: this.tagBuilderRenderer, renderSuggestion: renderSuggestion, disabled: disabled, value: inputValue, onChange: this.inputChangeHandler, onSuggestionSelected: this.suggestionSelectedHandler, inputRef: this.inputRefHandler, label: label, placeholder: placeholder, info: info, error: error, borderless: borderless, onBlur: onBlur, onFocus: onFocus }));
    };
    AutocompleteTagBuilderInt.inner = {
        get TagBuilder() { return TagBuilder_1.TagBuilder; },
        get Autocomplete() { return Autocomplete_1.Autocomplete; }
    };
    return AutocompleteTagBuilderInt;
}(React.Component));
exports.AutocompleteTagBuilderInt = AutocompleteTagBuilderInt;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQXV0b2NvbXBsZXRlVGFnQnVpbGRlci5pbnQucGFydC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL0F1dG9jb21wbGV0ZVRhZ0J1aWxkZXIvQXV0b2NvbXBsZXRlVGFnQnVpbGRlci5pbnQucGFydC50c3giXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSw2QkFBK0I7QUFDL0IsMkNBQWtDO0FBSWxDLHFDQUF1QztBQUN2Qyw0Q0FBMkM7QUFDM0MsZ0RBQStGO0FBQy9GO0lBQWtELDZDQUFrRztJQUdoSixtQ0FBbUIsS0FBcUM7UUFBeEQsWUFDSSxrQkFBTSxLQUFLLENBQUMsU0FXZjtRQW1DTyx3QkFBa0IsR0FBRyxVQUFDLEtBQWE7WUFDL0IsSUFBQSx5QkFBSyxDQUFnQjtZQUM3QixJQUFNLElBQUksR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDO1lBQ3RDLEtBQUssR0FBRyxLQUFLLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLEdBQUcsS0FBSyxDQUFDO1lBQ2pELElBQUksS0FBSyxJQUFJLENBQUMsSUFBSSxLQUFLLEdBQUcsSUFBSSxDQUFDLE1BQU0sRUFBRTtnQkFDbkMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDLENBQUM7Z0JBQ3ZCLElBQU0sUUFBUSxHQUFPLEtBQUssUUFBQyxDQUFDO2dCQUM1QixLQUFJLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxDQUFDO2FBQzlCO1FBQ0wsQ0FBQyxDQUFDO1FBdURNLGtCQUFZLEdBQUcscUJBQU8sQ0FBQyxVQUFDLEtBQWU7WUFDM0MsT0FBTyxLQUFLLENBQUMsR0FBRyxDQUFDLFVBQUEsQ0FBQyxJQUFJLE9BQUEsS0FBSSxDQUFDLGtCQUFr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aEU7QUF2SlksOERBQXlCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgUmVhY3QgZnJvbSAncmVhY3QnO1xuaW1wb3J0IG1lbW9pemUgZnJvbSAnbWVtb2l6ZS1vbmUnO1xuaW1wb3J0IHsgRm9ybUNvbnRleHRQcm9wcyB9IGZyb20gJy4uLy4uL2hvYy93aXRoRm9ybUNvbnRleHQnO1xuaW1wb3J0IHsgSW5wdXRDaGFuZ2VFdmVudCB9IGZyb20gJy4uLy4uL2NvbW1vbic7XG5pbXBvcnQgeyBBdXRvY29tcGxldGVUYWdCdWlsZGVyUHJvcHMsIEF1dG9jb21wbGV0ZVRhZ0J1aWxkZXJTdGF0ZSB9IGZyb20gJy4vQXV0b2NvbXBsZXRlVGFnQnVpbGRlci50eXBlcy5wYXJ0JztcbmltcG9ydCB7IGRlYm91bmNlIH0gZnJvbSAnLi4vLi4vdXRpbHMnO1xuaW1wb3J0IHsgVGFnQnVpbGRlciB9IGZyb20gJy4uL1RhZ0J1aWxkZXInO1xuaW1wb3J0IHsgQXV0b2NvbXBsZXRlLCBBdXRvY29tcGxldGVJbnB1dFByb3BzLCBBdXRvc3VnZ2VzdFNlbGVjdEV2ZW50IH0gZnJvbSAnLi4vQXV0b2NvbXBsZXRlJztcbmV4cG9ydCBjbGFzcyBBdXRvY29tcGxldGVUYWdCdWlsZGVySW50PFQ+IGV4dGVuZHMgUmVhY3QuQ29tcG9uZW50PEF1dG9jb21wbGV0ZVRhZ0J1aWxkZXJQcm9wczxUPiAmIEZvcm1Db250ZXh0UHJvcHMsIEF1dG9jb21wbGV0ZVRhZ0J1aWxkZXJTdGF0ZTxUPj4ge1xuICAgIHByaXZhdGUgX2ZpcmVPbklucHV0Q2hhbmdlOiAocTogc3RyaW5nKSA9PiB2b2lkO1xuICAgIHByaXZhdGUgX2lucHV0Tm9kZTogSFRNTEVsZW1lbnQgfCBudWxsO1xuICAgIHB1YmxpYyBjb25zdHJ1Y3Rvcihwcm9wczogQXV0b2NvbXBsZXRlVGFnQnVpbGRlclByb3BzPFQ+KSB7XG4gICAgICAgIHN1cGVyKHByb3BzKTtcbiAgICAgICAgY29uc3QgeyB2YWx1ZTogbnVsbGFibGVWYWx1ZSwgZGVmYXVsdFZhbHVlLCBvbklucHV0Q2hhbmdlLCBpbnB1dFZhbHVlLCBkZWxheSA9IDAgfSA9IHRoaXMucHJvcHM7XG4gICAgICAgIGNvbnN0IHZhbHVlID0gbnVsbGFibGVWYWx1ZSB8fCBkZWZhdWx0VmFsdWUgfHwgW107XG4gICAgICAgIHRoaXMuc3RhdGUgPSB7XG4gICAgICAgICAgICB2YWx1ZTogdmFsdWUsXG4gICAgICAgICAgICBpbnB1dFZhbHVlOiBpbnB1dFZhbHVlIHx8ICcnLFxuICAgICAgICAgICAgY29udHJvbGxlZDogcHJvcHMudmFsdWUgIT09IHVuZGVmaW5lZCB8fCBpbnB1dFZhbHVlICE9PSB1bmRlZmluZWQsXG4gICAgICAgIH07XG4gICAgICAgIHRoaXMuX2ZpcmVPbklucHV0Q2hhbmdlID0gZGVib3VuY2UoKHZhbHVlOiBzdHJpbmcpID0+IHtcbiAgICAgICAgICAgIG9uSW5wdXRDaGFuZ2UgJiYgb25JbnB1dENoYW5nZSh7IHZhbHVlIH0pO1xuICAgICAgICB9LCBkZWxheSk7XG4gICAgfVxuICAgIHB1YmxpYyBVTlNBRkVfY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyhuZXh0UHJvcHM6IEF1dG9jb21wbGV0ZVRhZ0J1aWxkZXJQcm9wczxUPikge1xuICAgICAgICBpZiAodGhpcy5zdGF0ZS5jb250cm9sbGVkKSB7XG4gICAgICAgICAgICBjb25zdCB7IHZhbHVlLCBpbnB1dFZhbHVlIH0gPSBuZXh0UHJvcHM7XG4gICAgICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICAgICAgICB2YWx1ZTogdmFsdWUgfHwgW10sXG4gICAgICAgICAgICAgICAgaW5wdXRWYWx1ZTogaW5wdXRWYWx1ZSB8fCAnJyxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfVxuICAgIHB1YmxpYyBjb21wb25lbnREaWRNb3VudCgpIHtcbiAgICAgICAgY29uc3QgeyBmb3JtIH0gPSB0aGlzLnByb3BzO1xuICAgICAgICBjb25zdCB7IGNvbnRyb2xsZWQgfSA9IHRoaXMuc3RhdGU7XG4gICAgICAgIGlmICghY29udHJvbGxlZCAmJiBmb3JtKSB7XG4gICAgICAgICAgICBmb3JtLnN1YnNjcmliZSh0aGlzKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBwdWJsaWMgY29tcG9uZW50V2lsbFVubW91bnQoKSB7XG4gICAgICAgIGNvbnN0IHsgZm9ybSB9ID0gdGhpcy5wcm9wcztcbiAgICAgICAgY29uc3QgeyBjb250cm9sbGVkIH0gPSB0aGlzLnN0YXRlO1xuICAgICAgICBpZiAoIWNvbnRyb2xsZWQgJiYgZm9ybSkge1xuICAgICAgICAgICAgZm9ybS51bnN1YnNjcmliZSh0aGlzKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBwcml2YXRlIGFkZFN1Z2dlc3Rpb24oc3VnZ2VzdGlvbjogVCkge1xuICAgICAgICBjb25zdCB7IHZhbHVlIH0gPSB0aGlzLnN0YXRlO1xuICAgICAgICBjb25zdCBrZXkgPSB0aGlzLmdldFN1Z2dlc3Rpb25LZXkoc3VnZ2VzdGlvbik7XG4gICAgICAgIGNvbnN0IHN1Z2dlc3Rpb25BbHJlYWR5QWRkZWQgPSB2YWx1ZS5zb21lKHggPT4gdGhpcy5nZXRTdWdnZXN0aW9uS2V5KHgpID09PSBrZXkpO1xuICAgICAgICBpZiAoIXN1Z2dlc3Rpb25BbHJlYWR5QWRkZWQpIHtcbiAgICAgICAgICAgIGNvbnN0IG5ld1ZhbHVlID0gWy4uLnZhbHVlXTtcbiAgICAgICAgICAgIG5ld1ZhbHVlLnB1c2goc3VnZ2VzdGlvbik7XG4gICAgICAgICAgICB0aGlzLnVwZGF0ZVZhbHVlKG5ld1ZhbHVlKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmNoYW5nZUlucHV0VmFsdWUoJycpO1xuICAgIH1cbiAgICBwcml2YXRlIHJlbW92ZVZhbHVlQnlJbmRleCA9IChpbmRleDogbnVtYmVyKSA9PiB7XG4gICAgICAgIGNvbnN0IHsgdmFsdWUgfSA9IHRoaXMuc3RhdGU7XG4gICAgICAgIGNvbnN0IGtleXMgPSBBcnJheS5mcm9tKHZhbHVlLmtleXMoKSk7XG4gICAgICAgIGluZGV4ID0gaW5kZXggPj0gMCA/IGluZGV4IDoga2V5cy5sZW5ndGggKyBpbmRleDtcbiAgICAgICAgaWYgKGluZGV4ID49IDAgJiYgaW5kZXggPCBrZXlzLmxlbmd0aCkge1xuICAgICAgICAgICAgdmFsdWUuc3BsaWNlKGluZGV4LCAxKTtcbiAgICAgICAgICAgIGNvbnN0IG5ld1ZhbHVlID0gWy4uLnZhbHVlXTtcbiAgICAgICAgICAgIHRoaXMudXBkYXRlVmFsdWUobmV3VmFsdWUpO1xuICAgICAgICB9XG4gICAgfTtcbiAgICBwcml2YXRlIHVwZGF0ZVZhbHVlKG5ld1ZhbHVlOiBBcnJheTxUPikge1xuICAgICAgICBjb25zdCB7IG9uQ2hhbmdlLCBuYW1lID0gJycsIGZvcm0gfSA9IHRoaXMucHJvcHM7XG4gICAgICAgIGlmICghdGhpcy5zdGF0ZS5jb250cm9sbGVkKSB7XG4gICAgICAgICAgICBpZiAoZm9ybSkge1xuICAgICAgICAgICAgICAgIGZvcm0uY2hhbmdlKHtcbiAgICAgICAgICAgICAgICAgICAgbmFtZSxcbiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IG5ld1ZhbHVlLFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICAgICAgICAgIHZhbHVlOiBuZXdWYWx1ZSxcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy5faW5wdXROb2RlKSB7XG4gICAgICAgICAgICB0aGlzLl9pbnB1dE5vZGUuZm9jdXMoKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodHlwZW9mIG9uQ2hhbmdlID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICBvbkNoYW5nZSh7IHZhbHVlOiBuZXdWYWx1ZSB9KTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBwcml2YXRlIGNoYW5nZUlucHV0VmFsdWUobmV3VmFsdWU6IHN0cmluZykge1xuICAgICAgICBpZiAoIXRoaXMuc3RhdGUuY29udHJvbGxlZCkge1xuICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICAgICAgaW5wdXRWYWx1ZTogbmV3VmFsdWUsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLl9maXJlT25JbnB1dENoYW5nZShuZXdWYWx1ZSk7XG4gICAgfVxuICAgIHByaXZhdGUgZ2V0U3VnZ2VzdGlvblZhbHVlKGl0ZW06IFQpIHtcbiAgICAgICAgY29uc3QgeyBnZXRTdWdnZXN0aW9uVmFsdWUgfSA9IHRoaXMucHJvcHM7XG4gICAgICAgIGlmICh0eXBlb2YgaXRlbSA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgICAgIHJldHVybiBpdGVtO1xuICAgICAgICB9XG4gICAgICAgIGVsc2UgaWYgKHR5cGVvZiBnZXRTdWdnZXN0aW9uVmFsdWUgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgICAgIHJldHVybiBnZXRTdWdnZXN0aW9uVmFsdWUoaXRlbSk7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0dldCBzdWdnZXN0aW9uIHZhbHVlIHNob3VsZCBiZSBzcGVjaWZpZWQnKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBwcml2YXRlIGdldFN1Z2dlc3Rpb25LZXkoaXRlbTogVCkge1xuICAgICAgICBjb25zdCB7IGdldFN1Z2dlc3Rpb25LZXkgfSA9IHRoaXMucHJvcHM7XG4gICAgICAgIGlmICh0eXBlb2YgaXRlbSA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgICAgIHJldHVybiBpdGVtO1xuICAgICAgICB9XG4gICAgICAgIGVsc2UgaWYgKHR5cGVvZiBnZXRTdWdnZXN0aW9uS2V5ID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICByZXR1cm4gZ2V0U3VnZ2VzdGlvbktleShpdGVtKTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignR2V0IHN1Z2dlc3Rpb24ga2V5IHNob3VsZCBiZSBzcGVjaWZpZWQnKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBwcml2YXRlIGdldFRhZ3NBcnJheSA9IG1lbW9pemUoKHZhbHVlOiBBcnJheTxUPikgPT4ge1xuICAgICAgICByZXR1cm4gdmFsdWUubWFwKHggPT4gdGhpcy5nZXRTdWdnZXN0aW9uVmFsdWUoeCkpO1xuICAgIH0pO1xuICAgIHByaXZhdGUgZGVmYXVsdFN1Z2dlc3Rpb25SZW5kZXJlcihzdWdnZXN0aW9uOiBUKSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBjb250ZW50OiB0aGlzLmdldFN1Z2dlc3Rpb25WYWx1ZShzdWdnZXN0aW9uKSxcbiAgICAgICAgICAgIGtleTogdGhpcy5nZXRTdWdnZXN0aW9uS2V5KHN1Z2dlc3Rpb24pLFxuICAgICAgICB9O1xuICAgIH1cbiAgICBwcml2YXRlIHRhZ1JlbW92ZUhhbmRsZXIgPSAoaW5kZXg6IG51bWJlcikgPT4ge1xuICAgICAgICB0aGlzLnJlbW92ZVZhbHVlQnlJbmRleChpbmRleCk7XG4gICAgfTtcbiAgICBwcml2YXRlIHN1Z2dlc3Rpb25TZWxlY3RlZEhhbmRsZXIgPSAoZTogQXV0b3N1Z2dlc3RTZWxlY3RFdmVudDxUPikgPT4ge1xuICAgICAgICB0aGlzLmFkZFN1Z2dlc3Rpb24oZS52YWx1ZSk7XG4gICAgfTtcbiAgICBwcml2YXRlIGlucHV0Q2hhbmdlSGFuZGxlciA9IChlOiBJbnB1dENoYW5nZUV2ZW50PHN0cmluZz4pID0+IHtcbiAgICAgICAgdGhpcy5jaGFuZ2VJbnB1dFZhbHVlKGUudmFsdWUpO1xuICAgIH07XG4gICAgcHJpdmF0ZSBpbnB1dFJlZkhhbmRsZXIgPSAobm9kZTogSFRNTEVsZW1lbnQgfCBudWxsKSA9PiB7XG4gICAgICAgIHRoaXMuX2lucHV0Tm9kZSA9IG5vZGU7XG4gICAgfTtcbiAgICBwcml2YXRlIHRhZ0J1aWxkZXJSZW5kZXJlciA9IChpbnB1dFByb3BzOiBBdXRvY29tcGxldGVJbnB1dFByb3BzKSA9PiB7XG4gICAgICAgIGNvbnN0IHsgZGlzYWJsZWQsIHRhZ1JlbmRlcmVyLCBib3JkZXJsZXNzID0gZmFsc2UgfSA9IHRoaXMucHJvcHM7XG4gICAgICAgIGNvbnN0IHsgdmFsdWUgfSA9IHRoaXMuc3RhdGU7XG4gICAgICAgIGNvbnN0IHsgb25DaGFuZ2UsIHZhbHVlOiBpbnB1dFZhbHVlLCAuLi5yZXN0UHJvcHMgfSA9IGlucHV0UHJvcHM7XG4gICAgICAgIGNvbnN0IHRhZ0J1aWxkZXJWYWx1ZSA9IHRoaXMuZ2V0VGFnc0FycmF5KHZhbHVlKTtcbiAgICAgICAgcmV0dXJuICg8VGFnQnVpbGRlciB7Li4ucmVzdFByb3BzfSBkaXNhYmxlZD17ZGlzYWJsZWR9IGlucHV0VmFsdWU9e2lucHV0VmFsdWV9IG9uSW5wdXQ9e29uQ2hhbmdlfSB2YWx1ZT17dGFnQnVpbGRlclZhbHVlfSB0YWdSZW5kZXJlcj17dGFnUmVuZGVyZXJ9IGJvcmRlcmxlc3M9e2JvcmRlcmxlc3N9IG9uQmVmb3JlVGFnUmVtb3ZlPXt0aGlzLnRhZ1JlbW92ZUhhbmRsZXJ9Lz4pO1xuICAgIH07XG4gICAgcHVibGljIHJlbmRlcigpIHtcbiAgICAgICAgY29uc3QgeyBzdWdnZXN0aW9ucyA9IFtdLCBub1N1Z2dlc3Rpb25zTWVzc2FnZSwgZGlzYWJsZWQsIHJlbmRlclN1Z2dlc3Rpb24gPSAoaXRlbTogVCkgPT4gdGhpcy5kZWZhdWx0U3VnZ2VzdGlvblJlbmRlcmVyKGl0ZW0pLCBsYWJlbCwgcGxhY2Vob2xkZXIsIGluZm8sIGJvcmRlcmxlc3MgPSBmYWxzZSwgZXJyb3IsIG9uQmx1ciwgb25Gb2N1cywgfSA9IHRoaXMucHJvcHM7XG4gICAgICAgIGNvbnN0IHsgaW5wdXRWYWx1ZSB9ID0gdGhpcy5zdGF0ZTtcbiAgICAgICAgcmV0dXJuICg8QXV0b2NvbXBsZXRlIG5vU3VnZ2VzdGlvbnNNZXNzYWdlPXtub1N1Z2dlc3Rpb25zTWVzc2FnZX0gc3VnZ2VzdGlvbnM9e3N1Z2dlc3Rpb25zfSBpbnB1dFJlbmRlcmVyPXt0aGlzLnRhZ0J1aWxkZXJSZW5kZXJlcn0gcmVuZGVyU3VnZ2VzdGlvbj17cmVuZGVyU3VnZ2VzdGlvbn0gZGlzYWJsZWQ9e2Rpc2FibGVkfSB2YWx1ZT17aW5wdXRWYWx1ZX0gb25DaGFuZ2U9e3RoaXMuaW5wdXRDaGFuZ2VIYW5kbGVyfSBvblN1Z2dlc3Rpb25TZWxlY3RlZD17dGhpcy5zdWdnZXN0aW9uU2VsZWN0ZWRIYW5kbGVyfSBpbnB1dFJlZj17dGhpcy5pbnB1dFJlZkhhbmRsZXJ9IGxhYmVsPXtsYWJlbH0gcGxhY2Vob2xkZXI9e3BsYWNlaG9sZGVyfSBpbmZvPXtpbmZvfSBlcnJvcj17ZXJyb3J9IGJvcmRlcmxlc3M9e2JvcmRlcmxlc3N9IG9uQmx1cj17b25CbHVyfSBvbkZvY3VzPXtvbkZvY3VzfS8+KTtcbiAgICB9XG4gICAgc3RhdGljIGlubmVyID0ge1xuICAgICAgICBnZXQgVGFnQnVpbGRlcigpIHsgcmV0dXJuIFRhZ0J1aWxkZXIgYXMgdHlwZW9mIFRhZ0J1aWxkZXI7IH0sXG4gICAgICAgIGdldCBBdXRvY29tcGxldGUoKSB7IHJldHVybiBBdXRvY29tcGxldGUgYXMgdHlwZW9mIEF1dG9jb21wbGV0ZTsgfVxuICAgIH07XG59XG4iXX0=