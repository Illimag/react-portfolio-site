"use strict";
var __makeTemplateObject = (this && this.__makeTemplateObject) || function (cooked, raw) {
    if (Object.defineProperty) { Object.defineProperty(cooked, "raw", { value: raw }); } else { cooked.raw = raw; }
    return cooked;
};
var __extends = (this && this.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var __assign = (this && this.__assign) || function () {
    __assign = Object.assign || function(t) {
        for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
        }
        return t;
    };
    return __assign.apply(this, arguments);
};
var __rest = (this && this.__rest) || function (s, e) {
    var t = {};
    for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)
        t[p] = s[p];
    if (s != null && typeof Object.getOwnPropertySymbols === "function")
        for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) if (e.indexOf(p[i]) < 0)
            t[p[i]] = s[p[i]];
    return t;
};
Object.defineProperty(exports, "__esModule", { value: true });
var React = require("react");
var styled_1 = require("../../utils/styled");
var remCalc_1 = require("../../utils/remCalc");
var InteractiveSurface_1 = require("../InteractiveSurface");
var Icon_1 = require("../Icon");
var distance_1 = require("../../distance");
var textStyles_1 = require("../../textStyles");
var shiftThreshold = 0.3;
var animationDuration = '0.3s';
var animationFunction = 'ease-in-out';
var RootContainer = styled_1.default.div(templateObject_1 || (templateObject_1 = __makeTemplateObject(["\n  outline: none;\n"], ["\n  outline: none;\n"])));
var DefaultBulletsContainer = styled_1.default.div(templateObject_2 || (templateObject_2 = __makeTemplateObject(["\n  box-sizing: border-box;\n  display: flex;\n  justify-content: center;\n"], ["\n  box-sizing: border-box;\n  display: flex;\n  justify-content: center;\n"])));
var ActiveBullet = styled_1.css(templateObject_3 || (templateObject_3 = __makeTemplateObject(["\n  background-color: rgba(116, 118, 120, 1);\n"], ["\n  background-color: rgba(116, 118, 120, 1);\n"])));
var DefaultBullet = styled_1.default.div(templateObject_4 || (templateObject_4 = __makeTemplateObject(["\n  height: ", ";\n  width: ", ";\n  background-color: rgba(224, 225, 221, 1);\n  border-radius: 50%;\n  display: inline-block;\n  cursor: pointer;\n  margin: ", ";\n  ", ";\n"], ["\n  height: ", ";\n  width: ", ";\n  background-color: rgba(224, 225, 221, 1);\n  border-radius: 50%;\n  display: inline-block;\n  cursor: pointer;\n  margin: ", ";\n  ", ";\n"])), remCalc_1.remCalc('12px'), remCalc_1.remCalc('12px'), distance_1.distance.xsmall, function (props) { return (props.active ? ActiveBullet : ''); });
var PageItem = styled_1.default.div(templateObject_5 || (templateObject_5 = __makeTemplateObject(["\n  min-width: 100%;\n"], ["\n  min-width: 100%;\n"])));
var PagesContainer = styled_1.default.div(templateObject_6 || (templateObject_6 = __makeTemplateObject(["\n  box-sizing: border-box;\n  display: flex;\n  position: relative;\n  left: ", "%;\n  transition: left ", " ", ";\n"], ["\n  box-sizing: border-box;\n  display: flex;\n  position: relative;\n  left: ", "%;\n  transition: left ", " ", ";\n"])), function (props) { return -props.selectedIndex * 100; }, animationDuration, animationFunction);
var Mask = styled_1.default.div(templateObject_7 || (templateObject_7 = __makeTemplateObject(["\n  position: relative;\n  box-sizing: border-box;\n  overflow: hidden;\n"], ["\n  position: relative;\n  box-sizing: border-box;\n  overflow: hidden;\n"])));
var Arrow = styled_1.default.button(templateObject_8 || (templateObject_8 = __makeTemplateObject(["\n  ", "\n\n  position: absolute;\n  top: 50%;\n  transform: translateY(-50%);\n  background-color: transparent;\n  padding: 0;\n  border: none;\n  align-self: start;\n  cursor: pointer;\n  > i {\n    vertical-align: middle;\n  }\n"], ["\n  ", "\n\n  position: absolute;\n  top: 50%;\n  transform: translateY(-50%);\n  background-color: transparent;\n  padding: 0;\n  border: none;\n  align-self: start;\n  cursor: pointer;\n  > i {\n    vertical-align: middle;\n  }\n"])), textStyles_1.getFontStyle({ size: 'medium' }));
var ArrowLeft = styled_1.default(Arrow)(templateObject_9 || (templateObject_9 = __makeTemplateObject(["\n  left: 8px;\n"], ["\n  left: 8px;\n"])));
var ArrowRight = styled_1.default(Arrow)(templateObject_10 || (templateObject_10 = __makeTemplateObject(["\n  right: 8px;\n"], ["\n  right: 8px;\n"])));
function calcNextPage(currentPage, totalPages, infinite) {
    if (infinite === void 0) { infinite = false; }
    var maxIndex = totalPages - 1;
    var nextPage = currentPage + 1;
    return infinite && nextPage > maxIndex ? 0 : Math.min(nextPage, maxIndex);
}
function calcPrevPage(currentPage, totalPages, infinite) {
    if (infinite === void 0) { infinite = false; }
    var prevPage = currentPage - 1;
    var maxIndex = totalPages - 1;
    return infinite && prevPage < 0 ? maxIndex : Math.max(prevPage, 0);
}
function calcLeftShiftPercent(selectedIndex) {
    return selectedIndex * -100;
}
var defaultAutoPlayTime = 3000;
/**
 * The Carousel component displays a toggling list of content. Page can be changed using bullet
 * controls or swiping gestures.
 */
var Carousel = /** @class */ (function (_super) {
    __extends(Carousel, _super);
    function Carousel(props) {
        var _this = _super.call(this, props) || this;
        _this.selects = [];
        _this.resume = function () {
            if (!_this.autoPlayTimeout) {
                _this.tryToPlay();
            }
        };
        _this.dragTile = function (e) {
            var _a = _this.state, controlled = _a.controlled, selectedIndex = _a.selectedIndex, dragStatus = _a.dragStatus;
            var shift = dragStatus.start ? e.x - dragStatus.start.x : 0;
            if (controlled) {
                e.release();
            }
            if (_this.pagesContainer) {
                if (e.active) {
                    if (!dragStatus.isDragging) {
                        _this.setState({ dragStatus: { isDragging: true, start: { x: e.x, y: e.y } } });
                        _this.setDragStyle(_this.pagesContainer);
                    }
                    _this.pagesContainer.style.left = calcLeftShiftPercent(selectedIndex) + shift * 100 + "%";
                }
                else {
                    _this.setState({ dragStatus: { isDragging: false, start: undefined } });
                    _this.resetInitialStyle(_this.pagesContainer);
                    _this.checkPageChange(shift);
                }
            }
        };
        _this.swipeLeft = function () {
            _this.swipe(-1, true);
        };
        _this.swipeRight = function () {
            _this.swipe(1, true);
        };
        _this.swipeRightAuto = function () {
            _this.swipe(1, false);
        };
        _this.handleKeyDown = function (e) {
            var _a = _this.props, children = _a.children, infinite = _a.infinite;
            var selectedIndex = _this.state.selectedIndex;
            var childrenCount = React.Children.count(children);
            var nextIndex = selectedIndex;
            switch (e.keyCode) {
                case 37 /* left */:
                    nextIndex = calcPrevPage(selectedIndex, childrenCount, infinite);
                    break;
                case 39 /* right */:
                    nextIndex = calcNextPage(selectedIndex, childrenCount, infinite);
                    break;
                case 35 /* end */:
                    nextIndex = childrenCount - 1;
                    break;
                case 36 /* home */:
                    nextIndex = 0;
                    break;
                default:
                    return;
            }
            _this.changePage(nextIndex);
        };
        _this.state = {
            selectedIndex: props.selectedIndex || props.defaultIndex || 0,
            controlled: props.selectedIndex !== undefined,
            dragStatus: { isDragging: false },
        };
        return _this;
    }
    Carousel.prototype.UNSAFE_componentWillReceiveProps = function (nextProps) {
        var selectedIndex = nextProps.selectedIndex;
        var controlled = this.state.controlled;
        if (controlled && typeof selectedIndex === 'number') {
            this.setState({
                selectedIndex: selectedIndex,
            });
        }
    };
    Carousel.prototype.componentDidMount = function () {
        this.tryToPlay();
    };
    Carousel.prototype.componentWillUnmount = function () {
        this.stop();
    };
    Carousel.prototype.tryToPlay = function () {
        this.stop();
        var autoplay = this.props.autoplay;
        if (autoplay) {
            this.play(typeof autoplay === 'number' ? autoplay : defaultAutoPlayTime);
        }
    };
    Carousel.prototype.play = function (time) {
        this.autoPlayTimeout = setInterval(this.swipeRightAuto, time);
    };
    Carousel.prototype.stop = function () {
        this.autoPlayTimeout = clearInterval(this.autoPlayTimeout);
    };
    Carousel.prototype.changePage = function (target, manual) {
        if (manual === void 0) { manual = true; }
        var _a = this.props, onPageChange = _a.onPageChange, onStop = _a.onStop, children = _a.children;
        var childrenCount = React.Children.count(children);
        var _b = this.state, controlled = _b.controlled, selectedIndex = _b.selectedIndex;
        var shouldStop = target >= childrenCount || target < 0;
        if (manual || shouldStop) {
            if (this.autoPlayTimeout) {
                this.stop();
                if (typeof onStop === 'function') {
                    onStop({
                        reason: manual ? 'manual' : 'ended',
                        resume: this.resume,
                    });
                }
            }
        }
        if (!shouldStop) {
            if (typeof onPageChange === 'function') {
                onPageChange({
                    previousIndex: selectedIndex,
                    selectedIndex: target,
                });
            }
            if (!controlled) {
                this.setState(function () { return ({
                    selectedIndex: target,
                }); });
            }
        }
    };
    Carousel.prototype.checkPageChange = function (shift) {
        var selectedIndex = this.state.selectedIndex;
        if (shift <= -shiftThreshold) {
            var nextIndex = calcNextPage(selectedIndex, React.Children.count(this.props.children), this.props.infinite);
            this.changePage(nextIndex);
        }
        else if (shift >= shiftThreshold) {
            var prevIndex = calcPrevPage(selectedIndex, React.Children.count(this.props.children), this.props.infinite);
            this.changePage(prevIndex);
        }
    };
    Carousel.prototype.setDragStyle = function (node) {
        var style = node.style;
        style.transitionProperty = 'unset';
        style.transitionDuration = 'unset';
        style.transitionTimingFunction = 'unset';
    };
    Carousel.prototype.resetInitialStyle = function (node) {
        var style = node.style;
        // tslint:disable-next-line
        style.left = null;
        style.transitionProperty = 'left';
        style.transitionDuration = animationDuration;
        style.transitionTimingFunction = animationFunction;
    };
    Carousel.prototype.swipe = function (direction, manual) {
        var selectedIndex = this.state.selectedIndex;
        var _a = this.props, children = _a.children, infinite = _a.infinite;
        var childrenCount = React.Children.count(children);
        var nextIndex = selectedIndex;
        if (direction === 1) {
            nextIndex = calcNextPage(selectedIndex, childrenCount, infinite);
        }
        else if (direction === -1) {
            nextIndex = calcPrevPage(selectedIndex, childrenCount, infinite);
        }
        this.changePage(nextIndex, manual);
    };
    Carousel.prototype.render = function () {
        var _this = this;
        var selectedIndex = this.state.selectedIndex;
        var _a = this.props, children = _a.children, theme = _a.theme, _0 = _a.selectedIndex, _1 = _a.defaultIndex, _2 = _a.onPageChange, CustomBulletsContainer = _a.bulletsContainer, CustomBullet = _a.bullet, _b = _a.arrows, arrows = _b === void 0 ? false : _b, _c = _a.infinite, infinite = _c === void 0 ? false : _c, _d = _a.opaque, opaque = _d === void 0 ? false : _d, props = __rest(_a, ["children", "theme", "selectedIndex", "defaultIndex", "onPageChange", "bulletsContainer", "bullet", "arrows", "infinite", "opaque"]);
        var childrenCount = React.Children.count(children);
        var bullets = [];
        var items = [];
        var selects = this.selects;
        var BulletsContainer = CustomBulletsContainer || DefaultBulletsContainer;
        var Bullet = CustomBullet || DefaultBullet;
        React.Children.forEach(children, function (element, index) {
            if (element && React.isValidElement(element)) {
                var active = index === selectedIndex;
                if (selects[index] === undefined) {
                    selects[index] = function () { return _this.changePage(index); };
                }
                bullets.push(React.createElement(Bullet, { theme: theme, key: "bullet-" + index, active: active, index: index, onClick: selects[index] }));
                items.push(React.createElement(PageItem, { key: "item-" + index }, element));
            }
        });
        var disableLeft = !infinite && selectedIndex < 1;
        var disableRight = !infinite && selectedIndex > childrenCount - 2;
        return (React.createElement(RootContainer, __assign({}, props, { onKeyDown: this.handleKeyDown, tabIndex: 0 }),
            React.createElement(Mask, null,
                React.createElement(InteractiveSurface_1.InteractiveSurface, { theme: theme, onChange: this.dragTile, opaque: opaque },
                    React.createElement(PagesContainer, { ref: function (node) { return (_this.pagesContainer = node); }, selectedIndex: selectedIndex }, items)),
                arrows && (React.createElement("div", null,
                    React.createElement(ArrowLeft, { onClick: this.swipeLeft, disabled: disableLeft, type: "button" },
                        React.createElement(Icon_1.Icon, { name: "KeyboardArrowLeft", size: 2 })),
                    React.createElement(ArrowRight, { onClick: this.swipeRight, disabled: disableRight, type: "button" },
                        React.createElement(Icon_1.Icon, { name: "KeyboardArrowRight", size: 2 }))))),
            React.createElement(BulletsContainer, null, bullets)));
    };
    Carousel.inner = {
        get PageItem() { return PageItem; },
        get RootContainer() { return RootContainer; },
        get Mask() { return Mask; },
        get InteractiveSurface() { return InteractiveSurface_1.InteractiveSurface; },
        get PagesContainer() { return PagesContainer; },
        get ArrowLeft() { return ArrowLeft; },
        get Icon() { return Icon_1.Icon; },
        get ArrowRight() { return ArrowRight; }
    };
    return Carousel;
}(React.PureComponent));
exports.Carousel = Carousel;
var templateObject_1, templateObject_2, templateObject_3, templateObject_4, templateObject_5, templateObject_6, templateObject_7, templateObject_8, templateObject_9, templateObject_10;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvY29tcG9uZW50cy9DYXJvdXNlbC9pbmRleC50c3giXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsNkJBQStCO0FBQy9CLDZDQUFpRDtBQUVqRCwrQ0FBOEM7QUFDOUMsNERBQW1IO0FBQ25ILGdDQUErQjtBQUUvQiwyQ0FBMEM7QUFDMUMsK0NBQWdEO0FBOEZoRCxJQUFNLGNBQWMsR0FBRyxHQUFHLENBQUM7QUFDM0IsSUFBTSxpQkFBaUIsR0FBRyxNQUFNLENBQUM7QUFDakMsSUFBTSxpQkFBaUIsR0FBRyxhQUFhLENBQUM7QUFDeEMsSUFBTSxhQUFhLEdBQUcsZ0JBQU0sQ0FBQyxHQUFHLHlGQUFDLHNCQUVoQyxJQUFBLENBQUM7QUFDRixJQUFNLHVCQUF1QixHQUFHLGdCQUFNLENBQUMsR0FBRyxnSkFBQyw2RUFJMUMsSUFBQSxDQUFDO0FBZUYsSUFBTSxZQUFZLEdBQUcsWUFBRyxvSEFBQyxpREFFeEIsSUFBQSxDQUFDO0FBQ0YsSUFBTSxhQUFhLEdBQUcsZ0JBQU0sQ0FBQyxHQUFHLG9QQUFjLGNBQ2xDLEVBQWUsY0FDaEIsRUFBZSxpSUFLZCxFQUFlLE9BQ3ZCLEVBQTJDLEtBQzlDLEtBUlcsaUJBQU8sQ0FBQyxNQUFNLENBQUMsRUFDaEIsaUJBQU8sQ0FBQyxNQUFNLENBQUMsRUFLZCxtQkFBUSxDQUFDLE1BQU0sRUFDdkIsVUFBQSxLQUFLLElBQUksT0FBQSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQWxDLENBQWtDLENBQzlDLENBQUM7QUFDRixJQUFNLFFBQVEsR0FBRyxnQkFBTSxDQUFDLEdBQUcsMkZBQUMsd0JBRTNCLElBQUEsQ0FBQztBQUlGLElBQU0sY0FBYyxHQUFHLGdCQUFNLENBQUMsR0FB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QUcsQ0FDL0IsQ0FDVCxDQUFDLENBQ0o7WUFDUCxvQkFBQyxnQkFBZ0IsUUFBRSxPQUFPLENBQW9CLENBQ2hDLENBQUMsQ0FBQztJQUNwQixDQUFDO0lBQ00sY0FBSyxHQUFHO1FBQ1gsSUFBSSxRQUFRLEtBQUssT0FBTyxRQUEyQixDQUFDLENBQUMsQ0FBQztRQUN0RCxJQUFJLGFBQWEsS0FBSyxPQUFPLGFBQXFDLENBQUMsQ0FBQyxDQUFDO1FBQ3JFLElBQUksSUFBSSxLQUFLLE9BQU8sSUFBbUIsQ0FBQyxDQUFDLENBQUM7UUFDMUMsSUFBSSxrQkFBa0IsS0FBSyxPQUFPLHVDQUErQyxDQUFDLENBQUMsQ0FBQztRQUNwRixJQUFJLGNBQWMsS0FBSyxPQUFPLGNBQXVDLENBQUMsQ0FBQyxDQUFDO1FBQ3hFLElBQUksU0FBUyxLQUFLLE9BQU8sU0FBNkIsQ0FBQyxDQUFDLENBQUM7UUFDekQsSUFBSSxJQUFJLEtBQUssT0FBTyxXQUFtQixDQUFDLENBQUMsQ0FBQztRQUMxQyxJQUFJLFVBQVUsS0FBSyxPQUFPLFVBQStCLENBQUMsQ0FBQyxDQUFDO0tBQy9ELENBQUM7SUFDTixlQUFDO0NBQUEsQUF4TkQsQ0FBOEIsS0FBSyxDQUFDLGFBQWEsR0F3TmhEO0FBeE5ZLDRCQUFRIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgUmVhY3QgZnJvbSAncmVhY3QnO1xuaW1wb3J0IHN0eWxlZCwgeyBjc3MgfSBmcm9tICcuLi8uLi91dGlscy9zdHlsZWQnO1xuaW1wb3J0IHsgS2V5Q29kZXMgfSBmcm9tICcuLi8uLi91dGlscy9rZXlDb2Rlcyc7XG5pbXBvcnQgeyByZW1DYWxjIH0gZnJvbSAnLi4vLi4vdXRpbHMvcmVtQ2FsYyc7XG5pbXBvcnQgeyBJbnRlcmFjdGl2ZVN1cmZhY2UsIEludGVyYWN0aXZlU3VyZmFjZUNoYW5nZUV2ZW50LCBJbnRlcmFjdGl2ZVN1cmZhY2VQcm9wcyB9IGZyb20gJy4uL0ludGVyYWN0aXZlU3VyZmFjZSc7XG5pbXBvcnQgeyBJY29uIH0gZnJvbSAnLi4vSWNvbic7XG5pbXBvcnQgeyBTdGFuZGFyZFByb3BzIH0gZnJvbSAnLi4vLi4vY29tbW9uJztcbmltcG9ydCB7IGRpc3RhbmNlIH0gZnJvbSAnLi4vLi4vZGlzdGFuY2UnO1xuaW1wb3J0IHsgZ2V0Rm9udFN0eWxlIH0gZnJvbSAnLi4vLi4vdGV4dFN0eWxlcyc7XG5leHBvcnQgaW50ZXJmYWNlIENhcm91c2VsQ2hhbmdlRXZlbnQge1xuICAgIC8qKlxuICAgICAqIFRoZSBwcmV2aW91c2x5IHNlbGVjdGVkIHBhZ2UgaW5kZXguXG4gICAgICovXG4gICAgcHJldmlvdXNJbmRleDogbnVtYmVyO1xuICAgIC8qKlxuICAgICAqIFRoZSBjdXJyZW50bHkgc2VsZWN0ZWQgcGFnZSBpbmRleC5cbiAgICAgKi9cbiAgICBzZWxlY3RlZEluZGV4OiBudW1iZXI7XG59XG5leHBvcnQgaW50ZXJmYWNlIENhcm91c2VsU3RvcEV2ZW50IHtcbiAgICAvKipcbiAgICAgKiBUaGUgcmVhc29uIGZvciBzdG9wcGluZyB0aGUgYXV0b3BsYXkgbW9kZS5cbiAgICAgKi9cbiAgICByZWFzb246ICdlbmRlZCcgfCAnbWFudWFsJztcbiAgICAvKipcbiAgICAgKiBSZXN1bWVzIGV4ZWN1dGlvbiBvZiB0aGUgYXV0b3BsYXkgbW9kZS5cbiAgICAgKi9cbiAgICByZXN1bWUoKTogdm9pZDtcbn1cbmV4cG9ydCBpbnRlcmZhY2UgQ2Fyb3VzZWxQcm9wcyBleHRlbmRzIFN0YW5kYXJkUHJvcHMge1xuICAgIC8qKlxuICAgICAqIFRoZSBkZWZhdWx0IHBhZ2UgaW5kZXggLSBvbmx5IHNldCBmb3IgdXNlIGluIGF1dG9tYXRpYyBtb2RlLlxuICAgICAqL1xuICAgIGRlZmF1bHRJbmRleD86IG51bWJlcjtcbiAgICAvKipcbiAgICAgKiBUaGUgY3VycmVudGx5IHNlbGVjdGVkIHBhZ2UgaW5kZXggLSB1c2VkIGluIHRoZSBjb250cm9sbGVkIG1vZGUuXG4gICAgICovXG4gICAgc2VsZWN0ZWRJbmRleD86IG51bWJlcjtcbiAgICAvKipcbiAgICAgKiBOb3RpZmljYXRpb24gY2FsbGJhY2sgaWYgdGhlIHNlbGVjdGVkIHBhZ2UgaW5kZXggc2hvdWxkIGNoYW5nZS5cbiAgICAgKi9cbiAgICBvblBhZ2VDaGFuZ2U/KGU6IENhcm91c2VsQ2hhbmdlRXZlbnQpOiB2b2lkO1xuICAgIC8qKlxuICAgICAqIFRoZSBjaGlsZHJlbiwgdXN1YWxseSBwYXNzZWQgYXMgYSBjb2xsZWN0aW9uIG9mIGVsZW1lbnRzLlxuICAgICAqL1xuICAgIGNoaWxkcmVuPzogUmVhY3QuUmVhY3ROb2RlO1xuICAgIC8qKlxuICAgICAqIE92ZXJyaWRlcyB0aGUgZGVmYXVsdCBjb250YWluZXIgZm9yIGJ1bGxldHMuXG4gICAgICovXG4gICAgYnVsbGV0c0NvbnRhaW5lcj86IFJlYWN0LkNvbXBvbmVudFR5cGU7XG4gICAgLyoqXG4gICAgICogT3ZlcnJpZGVzIHRoZSBkZWZhdWx0IGJ1bGxldCBwb2ludCBjb21wb25lbnQuXG4gICAgICovXG4gICAgYnVsbGV0PzogUmVhY3QuQ29tcG9uZW50VHlwZTxCdWxsZXRQcm9wcz47XG4gICAgLyoqXG4gICAgICogRGlzcGxheXMgdGhlIHByZXZpb3VzIC8gbmV4dCBhcnJvdy4gQnkgZGVmYXVsdCBkaXNhYmxlZC5cbiAgICAgKiBAZGVmYXVsdCBmYWxzZVxuICAgICAqL1xuICAgIGFycm93cz86IGJvb2xlYW47XG4gICAgLyoqXG4gICAgICogRXZlbnQgZW1pdHRlZCBvbmNlIHRoZSBDYXJvdXNlbCBhdXRvcGxheSBzdG9wcy5cbiAgICAgKi9cbiAgICBvblN0b3A/KGU6IENhcm91c2VsU3RvcEV2ZW50KTogdm9pZDtcbiAgICAvKipcbiAgICAgKiBBY3RpdmF0ZSB0aGUgYXV0b3BsYXkgbW9kZSwgcG90ZW50aWFsbHkgd2l0aCB0aGUgdGltZSBwZXIgc2xpZGVcbiAgICAgKiBpbiBtaWxsaXNlY29uZHMuIEJ5IGRlZmF1bHQgMzAwMC5cbiAgICAgKiBAZGVmYXVsdCBmYWxzZVxuICAgICAqL1xuICAgIGF1dG9wbGF5PzogYm9vbGVhbiB8IG51bWJlcjtcbiAgICAvKipcbiAgICAgKiBXaGV0aGVyIHRoZSBDYXJvdXNlbCBjYW4gbG9vcCB3aXRob3V0IHN0b3BwaW5nLlxuICAgICAqIEBkZWZhdWx0IGZhbHNlXG4gICAgICovXG4gICAgaW5maW5pdGU/OiBib29sZWFuO1xuICAgIC8qKlxuICAgICAqIFdoZXRoZXIgdGhlIENhcm91c2VsIGNhbiBzdG9wIHByb3BhZ2F0aW9uIHNvIHRoYXQgbGlua3MgY2FuIGJlIGNsaWNrZWRcbiAgICAgKiBAZGVmYXVsdCBmYWxzZVxuICAgICAqL1xuICAgIG9wYXF1ZT86IEludGVyYWN0aXZlU3VyZmFjZVByb3BzWydvcGFxdWUnXTtcbn1cbmV4cG9ydCBpbnRlcmZhY2UgRHJhZ1N0YXR1cyB7XG4gICAgaXNEcmFnZ2luZzogYm9vbGVhbjtcbiAgICBzdGFydD86IFBvaW50O1xufVxuZXhwb3J0IGludGVyZmFjZSBQb2ludCB7XG4gICAgeDogbnVtYmVyO1xuICAgIHk6IG51bWJlcjtcbn1cbmV4cG9ydCBpbnRlcmZhY2UgQ2Fyb3VzZWxTdGF0ZSB7XG4gICAgLyoqXG4gICAgICogVGhlIGN1cnJlbnRseSBzZWxlY3RlZCBwYWdlIGluZGV4LlxuICAgICAqL1xuICAgIHNlbGVjdGVkSW5kZXg6IG51bWJlcjtcbiAgICAvKipcbiAgICAgKiBEZXRlcm1pbmVzIGlmIHRoZSB0YWIgY29tcG9uZW50IGlzIGNvbnRyb2xsZWQgZnJvbSB0aGUgb3V0c2lkZSBvciBub3QuXG4gICAgICovXG4gICAgY29udHJvbGxlZDogYm9vbGVhbjtcbiAgICAvKipcbiAgICAgKiBTdGF0dXMgb2YgdGhlIGN1cnJlbnQgc3dpcGUgbW92ZS5cbiAgICAgKi9cbiAgICBkcmFnU3RhdHVzOiBEcmFnU3RhdHVzO1xufVxuY29uc3Qgc2hpZnRUaHJlc2hvbGQgPSAwLjM7XG5jb25zdCBhbmltYXRpb25EdXJhdGlvbiA9ICcwLjNzJztcbmNvbnN0IGFuaW1hdGlvbkZ1bmN0aW9uID0gJ2Vhc2UtaW4tb3V0JztcbmNvbnN0IFJvb3RDb250YWluZXIgPSBzdHlsZWQuZGl2IGBcbiAgb3V0bGluZTogbm9uZTtcbmA7XG5jb25zdCBEZWZhdWx0QnVsbGV0c0NvbnRhaW5lciA9IHN0eWxlZC5kaXYgYFxuICBib3gtc2l6aW5nOiBib3JkZXItYm94O1xuICBkaXNwbGF5OiBmbGV4O1xuICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjtcbmA7XG5leHBvcnQgaW50ZXJmYWNlIEJ1bGxldFByb3BzIGV4dGVuZHMgU3RhbmRhcmRQcm9wcyB7XG4gICAgLyoqXG4gICAgICogRGV0ZXJtaW5lcyBpZiB0aGUgYnVsbGV0IGlzIGFjdGl2ZSBvciBub3QuXG4gICAgICovXG4gICAgYWN0aXZlOiBib29sZWFuO1xuICAgIC8qKlxuICAgICAqIEZpcmVkIG9uY2UgdGhlIGJ1bGxldCBoYXMgYmVlbiBjbGlja2VkLlxuICAgICAqL1xuICAgIG9uQ2xpY2soKTogdm9pZDtcbiAgICAvKipcbiAgICAgKiBTZXRzIHRoZSBidWxsZXQncyBpbmRleC5cbiAgICAgKi9cbiAgICBpbmRleDogbnVtYmVyO1xufVxuY29uc3QgQWN0aXZlQnVsbGV0ID0gY3NzIGBcbiAgYmFja2dyb3VuZC1jb2xvcjogcmdiYSgxMTYsIDExOCwgMTIwLCAxKTtcbmA7XG5jb25zdCBEZWZhdWx0QnVsbGV0ID0gc3R5bGVkLmRpdjxCdWxsZXRQcm9wcz4gYFxuICBoZWlnaHQ6ICR7cmVtQ2FsYygnMTJweCcpfTtcbiAgd2lkdGg6ICR7cmVtQ2FsYygnMTJweCcpfTtcbiAgYmFja2dyb3VuZC1jb2xvcjogcmdiYSgyMjQsIDIyNSwgMjIxLCAxKTtcbiAgYm9yZGVyLXJhZGl1czogNTAlO1xuICBkaXNwbGF5OiBpbmxpbmUtYmxvY2s7XG4gIGN1cnNvcjogcG9pbnRlcjtcbiAgbWFyZ2luOiAke2Rpc3RhbmNlLnhzbWFsbH07XG4gICR7cHJvcHMgPT4gKHByb3BzLmFjdGl2ZSA/IEFjdGl2ZUJ1bGxldCA6ICcnKX07XG5gO1xuY29uc3QgUGFnZUl0ZW0gPSBzdHlsZWQuZGl2IGBcbiAgbWluLXdpZHRoOiAxMDAlO1xuYDtcbmludGVyZmFjZSBQYWdlc0NvbnRhaW5lclByb3BzIGV4dGVuZHMgU3RhbmRhcmRQcm9wcyB7XG4gICAgc2VsZWN0ZWRJbmRleDogbnVtYmVyO1xufVxuY29uc3QgUGFnZXNDb250YWluZXIgPSBzdHlsZWQuZGl2PFBhZ2VzQ29udGFpbmVyUHJvcHM+IGBcbiAgYm94LXNpemluZzogYm9yZGVyLWJveDtcbiAgZGlzcGxheTogZmxleDtcbiAgcG9zaXRpb246IHJlbGF0aXZlO1xuICBsZWZ0OiAke3Byb3BzID0+IC1wcm9wcy5zZWxlY3RlZEluZGV4ICogMTAwfSU7XG4gIHRyYW5zaXRpb246IGxlZnQgJHthbmltYXRpb25EdXJhdGlvbn0gJHthbmltYXRpb25GdW5jdGlvbn07XG5gO1xuY29uc3QgTWFzayA9IHN0eWxlZC5kaXYgYFxuICBwb3NpdGlvbjogcmVsYXRpdmU7XG4gIGJveC1zaXppbmc6IGJvcmRlci1ib3g7XG4gIG92ZXJmbG93OiBoaWRkZW47XG5gO1xuY29uc3QgQXJyb3cgPSBzdHlsZWQuYnV0dG9uIGBcbiAgJHtnZXRGb250U3R5bGUoeyBzaXplOiAnbWVkaXVtJyB9KX1cblxuICBwb3NpdGlvbjogYWJzb2x1dGU7XG4gIHRvcDogNTAlO1xuICB0cmFuc2Zvcm06IHRyYW5zbGF0ZVkoLTUwJSk7XG4gIGJhY2tncm91bmQtY29sb3I6IHRyYW5zcGFyZW50O1xuICBwYWRkaW5nOiAwO1xuICBib3JkZXI6IG5vbmU7XG4gIGFsaWduLXNlbGY6IHN0YXJ0O1xuICBjdXJzb3I6IHBvaW50ZXI7XG4gID4gaSB7XG4gICAgdmVydGljYWwtYWxpZ246IG1pZGRsZTtcbiAgfVxuYDtcbmNvbnN0IEFycm93TGVmdCA9IHN0eWxlZChBcnJvdykgYFxuICBsZWZ0OiA4cHg7XG5gO1xuY29uc3QgQXJyb3dSaWdodCA9IHN0eWxlZChBcnJvdykgYFxuICByaWdodDogOHB4O1xuYDtcbmZ1bmN0aW9uIGNhbGNOZXh0UGFnZShjdXJyZW50UGFnZTogbnVtYmVyLCB0b3RhbFBhZ2VzOiBudW1iZXIsIGluZmluaXRlOiBib29sZWFuID0gZmFsc2UpIHtcbiAgICBjb25zdCBtYXhJbmRleCA9IHRvdGFsUGFnZXMgLSAxO1xuICAgIGNvbnN0IG5leHRQYWdlID0gY3VycmVudFBhZ2UgKyAxO1xuICAgIHJldHVybiBpbmZpbml0ZSAmJiBuZXh0UGFnZSA+IG1heEluZGV4ID8gMCA6IE1hdGgubWluKG5leHRQYWdlLCBtYXhJbmRleCk7XG59XG5mdW5jdGlvbiBjYWxjUHJldlBhZ2UoY3VycmVudFBhZ2U6IG51bWJlciwgdG90YWxQYWdlczogbnVtYmVyLCBpbmZpbml0ZTogYm9vbGVhbiA9IGZhbHNlKSB7XG4gICAgY29uc3QgcHJldlBhZ2UgPSBjdXJyZW50UGFnZSAtIDE7XG4gICAgY29uc3QgbWF4SW5kZXggPSB0b3RhbFBhZ2VzIC0gMTtcbiAgICByZXR1cm4gaW5maW5pdGUgJiYgcHJldlBhZ2UgPCAwID8gbWF4SW5kZXggOiBNYXRoLm1heChwcmV2UGFnZSwgMCk7XG59XG5mdW5jdGlvbiBjYWxjTGVmdFNoaWZ0UGVyY2VudChzZWxlY3RlZEluZGV4OiBudW1iZXIpIHtcbiAgICByZXR1cm4gc2VsZWN0ZWRJbmRleCAqIC0xMDA7XG59XG5jb25zdCBkZWZhdWx0QXV0b1BsYXlUaW1lID0gMzAwMDtcbi8qKlxuICogVGhlIENhcm91c2VsIGNvbXBvbmVudCBkaXNwbGF5cyBhIHRvZ2dsaW5nIGxpc3Qgb2YgY29udGVudC4gUGFnZSBjYW4gYmUgY2hhbmdlZCB1c2luZyBidWxsZXRcbiAqIGNvbnRyb2xzIG9yIHN3aXBpbmcgZ2VzdHVyZXMuXG4gKi9cbmV4cG9ydCBjbGFzcyBDYXJvdXNlbCBleHRlbmRzIFJlYWN0LlB1cmVDb21wb25lbnQ8Q2Fyb3VzZWxQcm9wcywgQ2Fyb3VzZWxTdGF0ZT4ge1xuICAgIHByaXZhdGUgc2VsZWN0czogQXJyYXk8KCkgPT4gdm9pZD4gPSBbXTtcbiAgICBwcml2YXRlIHBhZ2VzQ29udGFpbmVyOiBIVE1MRGl2RWxlbWVudCB8IG51bGw7XG4gICAgcHJpdmF0ZSBhdXRvUGxheVRpbWVvdXQ6IGFueTtcbiAgICBjb25zdHJ1Y3Rvcihwcm9wczogQ2Fyb3VzZWxQcm9wcykge1xuICAgICAgICBzdXBlcihwcm9wcyk7XG4gICAgICAgIHRoaXMuc3RhdGUgPSB7XG4gICAgICAgICAgICBzZWxlY3RlZEluZGV4OiBwcm9wcy5zZWxlY3RlZEluZGV4IHx8IHByb3BzLmRlZmF1bHRJbmRleCB8fCAwLFxuICAgICAgICAgICAgY29udHJvbGxlZDogcHJvcHMuc2VsZWN0ZWRJbmRleCAhPT0gdW5kZWZpbmVkLFxuICAgICAgICAgICAgZHJhZ1N0YXR1czogeyBpc0RyYWdnaW5nOiBmYWxzZSB9LFxuICAgICAgICB9O1xuICAgIH1cbiAgICBVTlNBRkVfY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyhuZXh0UHJvcHM6IENhcm91c2VsUHJvcHMpIHtcbiAgICAgICAgY29uc3QgeyBzZWxlY3RlZEluZGV4IH0gPSBuZXh0UHJvcHM7XG4gICAgICAgIGNvbnN0IHsgY29udHJvbGxlZCB9ID0gdGhpcy5zdGF0ZTtcbiAgICAgICAgaWYgKGNvbnRyb2xsZWQgJiYgdHlwZW9mIHNlbGVjdGVkSW5kZXggPT09ICdudW1iZXInKSB7XG4gICAgICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICAgICAgICBzZWxlY3RlZEluZGV4LFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgY29tcG9uZW50RGlkTW91bnQoKSB7XG4gICAgICAgIHRoaXMudHJ5VG9QbGF5KCk7XG4gICAgfVxuICAgIGNvbXBvbmVudFdpbGxVbm1vdW50KCkge1xuICAgICAgICB0aGlzLnN0b3AoKTtcbiAgICB9XG4gICAgcHJpdmF0ZSB0cnlUb1BsYXkoKSB7XG4gICAgICAgIHRoaXMuc3RvcCgpO1xuICAgICAgICBjb25zdCB7IGF1dG9wbGF5IH0gPSB0aGlzLnByb3BzO1xuICAgICAgICBpZiAoYXV0b3BsYXkpIHtcbiAgICAgICAgICAgIHRoaXMucGxheSh0eXBlb2YgYXV0b3BsYXkgPT09ICdudW1iZXInID8gYXV0b3BsYXkgOiBkZWZhdWx0QXV0b1BsYXlUaW1lKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBwcml2YXRlIHBsYXkodGltZTogbnVtYmVyKSB7XG4gICAgICAgIHRoaXMuYXV0b1BsYXlUaW1lb3V0ID0gc2V0SW50ZXJ2YWwodGhpcy5zd2lwZVJpZ2h0QXV0bywgdGltZSk7XG4gICAgfVxuICAgIHByaXZhdGUgc3RvcCgpIHtcbiAgICAgICAgdGhpcy5hdXRvUGxheVRpbWVvdXQgPSBjbGVhckludGVydmFsKHRoaXMuYXV0b1BsYXlUaW1lb3V0KTtcbiAgICB9XG4gICAgcHJpdmF0ZSByZXN1bWUgPSAoKSA9PiB7XG4gICAgICAgIGlmICghdGhpcy5hdXRvUGxheVRpbWVvdXQpIHtcbiAgICAgICAgICAgIHRoaXMudHJ5VG9QbGF5KCk7XG4gICAgICAgIH1cbiAgICB9O1xuICAgIHByaXZhdGUgY2hhbmdlUGFnZSh0YXJnZXQ6IG51bWJlciwgbWFudWFsID0gdHJ1ZSkge1xuICAgICAgICBjb25zdCB7IG9uUGFnZUNoYW5nZSwgb25TdG9wLCBjaGlsZHJlbiB9ID0gdGhpcy5wcm9wcztcbiAgICAgICAgY29uc3QgY2hpbGRyZW5Db3VudCA9IFJlYWN0LkNoaWxkcmVuLmNvdW50KGNoaWxkcmVuKTtcbiAgICAgICAgY29uc3QgeyBjb250cm9sbGVkLCBzZWxlY3RlZEluZGV4IH0gPSB0aGlzLnN0YXRlO1xuICAgICAgICBjb25zdCBzaG91bGRTdG9wID0gdGFyZ2V0ID49IGNoaWxkcmVuQ291bnQgfHwgdGFyZ2V0IDwgMDtcbiAgICAgICAgaWYgKG1hbnVhbCB8fCBzaG91bGRTdG9wKSB7XG4gICAgICAgICAgICBpZiAodGhpcy5hdXRvUGxheVRpbWVvdXQpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnN0b3AoKTtcbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIG9uU3RvcCA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgICAgICAgICAgICBvblN0b3Aoe1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVhc29uOiBtYW51YWwgPyAnbWFudWFsJyA6ICdlbmRlZCcsXG4gICAgICAgICAgICAgICAgICAgICAgICByZXN1bWU6IHRoaXMucmVzdW1lLFxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCFzaG91bGRTdG9wKSB7XG4gICAgICAgICAgICBpZiAodHlwZW9mIG9uUGFnZUNoYW5nZSA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgICAgICAgIG9uUGFnZUNoYW5nZSh7XG4gICAgICAgICAgICAgICAgICAgIHByZXZpb3VzSW5kZXg6IHNlbGVjdGVkSW5kZXgsXG4gICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkSW5kZXg6IHRhcmdldCxcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICghY29udHJvbGxlZCkge1xuICAgICAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoKCkgPT4gKHtcbiAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWRJbmRleDogdGFyZ2V0LFxuICAgICAgICAgICAgICAgIH0pKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICBwcml2YXRlIGRyYWdUaWxlID0gKGU6IEludGVyYWN0aXZlU3VyZmFjZUNoYW5nZUV2ZW50KSA9PiB7XG4gICAgICAgIGNvbnN0IHsgY29udHJvbGxlZCwgc2VsZWN0ZWRJbmRleCwgZHJhZ1N0YXR1cyB9ID0gdGhpcy5zdGF0ZTtcbiAgICAgICAgY29uc3Qgc2hpZnQgPSBkcmFnU3RhdHVzLnN0YXJ0ID8gZS54IC0gZHJhZ1N0YXR1cy5zdGFydC54IDogMDtcbiAgICAgICAgaWYgKGNvbnRyb2xsZWQpIHtcbiAgICAgICAgICAgIGUucmVsZWFzZSgpO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLnBhZ2VzQ29udGFpbmVyKSB7XG4gICAgICAgICAgICBpZiAoZS5hY3RpdmUpIHtcbiAgICAgICAgICAgICAgICBpZiAoIWRyYWdTdGF0dXMuaXNEcmFnZ2luZykge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnNldFN0YXRlKHsgZHJhZ1N0YXR1czogeyBpc0RyYWdnaW5nOiB0cnVlLCBzdGFydDogeyB4OiBlLngsIHk6IGUueSB9IH0gfSk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0RHJhZ1N0eWxlKHRoaXMucGFnZXNDb250YWluZXIpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB0aGlzLnBhZ2VzQ29udGFpbmVyLnN0eWxlLmxlZnQgPSBgJHtjYWxjTGVmdFNoaWZ0UGVyY2VudChzZWxlY3RlZEluZGV4KSArIHNoaWZ0ICogMTAwfSVgO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7IGRyYWdTdGF0dXM6IHsgaXNEcmFnZ2luZzogZmFsc2UsIHN0YXJ0OiB1bmRlZmluZWQgfSB9KTtcbiAgICAgICAgICAgICAgICB0aGlzLnJlc2V0SW5pdGlhbFN0eWxlKHRoaXMucGFnZXNDb250YWluZXIpO1xuICAgICAgICAgICAgICAgIHRoaXMuY2hlY2tQYWdlQ2hhbmdlKHNoaWZ0KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH07XG4gICAgcHJpdmF0ZSBjaGVja1BhZ2VDaGFuZ2Uoc2hpZnQ6IG51bWJlcikge1xuICAgICAgICBjb25zdCB7IHNlbGVjdGVkSW5kZXggfSA9IHRoaXMuc3RhdGU7XG4gICAgICAgIGlmIChzaGlmdCA8PSAtc2hpZnRUaHJlc2hvbGQpIHtcbiAgICAgICAgICAgIGNvbnN0IG5leHRJbmRleCA9IGNhbGNOZXh0UGFnZShzZWxlY3RlZEluZGV4LCBSZWFjdC5DaGlsZHJlbi5jb3VudCh0aGlzLnByb3BzLmNoaWxkcmVuKSwgdGhpcy5wcm9wcy5pbmZpbml0ZSk7XG4gICAgICAgICAgICB0aGlzLmNoYW5nZVBhZ2UobmV4dEluZGV4KTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIGlmIChzaGlmdCA+PSBzaGlmdFRocmVzaG9sZCkge1xuICAgICAgICAgICAgY29uc3QgcHJldkluZGV4ID0gY2FsY1ByZXZQYWdlKHNlbGVjdGVkSW5kZXgsIFJlYWN0LkNoaWxkcmVuLmNvdW50KHRoaXMucHJvcHMuY2hpbGRyZW4pLCB0aGlzLnByb3BzLmluZmluaXRlKTtcbiAgICAgICAgICAgIHRoaXMuY2hhbmdlUGFnZShwcmV2SW5kZXgpO1xuICAgICAgICB9XG4gICAgfVxuICAgIHByaXZhdGUgc2V0RHJhZ1N0eWxlKG5vZGU6IEhUTUxFbGVtZW50KSB7XG4gICAgICAgIGNvbnN0IHN0eWxlID0gbm9kZS5zdHlsZTtcbiAgICAgICAgc3R5bGUudHJhbnNpdGlvblByb3BlcnR5ID0gJ3Vuc2V0JztcbiAgICAgICAgc3R5bGUudHJhbnNpdGlvbkR1cmF0aW9uID0gJ3Vuc2V0JztcbiAgICAgICAgc3R5bGUudHJhbnNpdGlvblRpbWluZ0Z1bmN0aW9uID0gJ3Vuc2V0JztcbiAgICB9XG4gICAgcHJpdmF0ZSByZXNldEluaXRpYWxTdHlsZShub2RlOiBIVE1MRWxlbWVudCkge1xuICAgICAgICBjb25zdCBzdHlsZSA9IG5vZGUuc3R5bGU7XG4gICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZVxuICAgICAgICBzdHlsZS5sZWZ0ID0gbnVsbDtcbiAgICAgICAgc3R5bGUudHJhbnNpdGlvblByb3BlcnR5ID0gJ2xlZnQnO1xuICAgICAgICBzdHlsZS50cmFuc2l0aW9uRHVyYXRpb24gPSBhbmltYXRpb25EdXJhdGlvbjtcbiAgICAgICAgc3R5bGUudHJhbnNpdGlvblRpbWluZ0Z1bmN0aW9uID0gYW5pbWF0aW9uRnVuY3Rpb247XG4gICAgfVxuICAgIHByaXZhdGUgc3dpcGUoZGlyZWN0aW9uOiBudW1iZXIsIG1hbnVhbDogYm9vbGVhbikge1xuICAgICAgICBjb25zdCB7IHNlbGVjdGVkSW5kZXggfSA9IHRoaXMuc3RhdGU7XG4gICAgICAgIGNvbnN0IHsgY2hpbGRyZW4sIGluZmluaXRlIH0gPSB0aGlzLnByb3BzO1xuICAgICAgICBjb25zdCBjaGlsZHJlbkNvdW50ID0gUmVhY3QuQ2hpbGRyZW4uY291bnQoY2hpbGRyZW4pO1xuICAgICAgICBsZXQgbmV4dEluZGV4ID0gc2VsZWN0ZWRJbmRleDtcbiAgICAgICAgaWYgKGRpcmVjdGlvbiA9PT0gMSkge1xuICAgICAgICAgICAgbmV4dEluZGV4ID0gY2FsY05leHRQYWdlKHNlbGVjdGVkSW5kZXgsIGNoaWxkcmVuQ291bnQsIGluZmluaXRlKTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIGlmIChkaXJlY3Rpb24gPT09IC0xKSB7XG4gICAgICAgICAgICBuZXh0SW5kZXggPSBjYWxjUHJldlBhZ2Uoc2VsZWN0ZWRJbmRleCwgY2hpbGRyZW5Db3VudCwgaW5maW5pdGUpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuY2hhbmdlUGFnZShuZXh0SW5kZXgsIG1hbnVhbCk7XG4gICAgfVxuICAgIHByaXZhdGUgc3dpcGVMZWZ0ID0gKCkgPT4ge1xuICAgICAgICB0aGlzLnN3aXBlKC0xLCB0cnVlKTtcbiAgICB9O1xuICAgIHByaXZhdGUgc3dpcGVSaWdodCA9ICgpID0+IHtcbiAgICAgICAgdGhpcy5zd2lwZSgxLCB0cnVlKTtcbiAgICB9O1xuICAgIHByaXZhdGUgc3dpcGVSaWdodEF1dG8gPSAoKSA9PiB7XG4gICAgICAgIHRoaXMuc3dpcGUoMSwgZmFsc2UpO1xuICAgIH07XG4gICAgcHJpdmF0ZSBoYW5kbGVLZXlEb3duID0gKGU6IFJlYWN0LktleWJvYXJkRXZlbnQ8SFRNTERpdkVsZW1lbnQ+KSA9PiB7XG4gICAgICAgIGNvbnN0IHsgY2hpbGRyZW4sIGluZmluaXRlIH0gPSB0aGlzLnByb3BzO1xuICAgICAgICBjb25zdCB7IHNlbGVjdGVkSW5kZXggfSA9IHRoaXMuc3RhdGU7XG4gICAgICAgIGNvbnN0IGNoaWxkcmVuQ291bnQgPSBSZWFjdC5DaGlsZHJlbi5jb3VudChjaGlsZHJlbik7XG4gICAgICAgIGxldCBuZXh0SW5kZXggPSBzZWxlY3RlZEluZGV4O1xuICAgICAgICBzd2l0Y2ggKGUua2V5Q29kZSkge1xuICAgICAgICAgICAgY2FzZSBLZXlDb2Rlcy5sZWZ0OlxuICAgICAgICAgICAgICAgIG5leHRJbmRleCA9IGNhbGNQcmV2UGFnZShzZWxlY3RlZEluZGV4LCBjaGlsZHJlbkNvdW50LCBpbmZpbml0ZSk7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlIEtleUNvZGVzLnJpZ2h0OlxuICAgICAgICAgICAgICAgIG5leHRJbmRleCA9IGNhbGNOZXh0UGFnZShzZWxlY3RlZEluZGV4LCBjaGlsZHJlbkNvdW50LCBpbmZpbml0ZSk7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlIEtleUNvZGVzLmVuZDpcbiAgICAgICAgICAgICAgICBuZXh0SW5kZXggPSBjaGlsZHJlbkNvdW50IC0gMTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgS2V5Q29kZXMuaG9tZTpcbiAgICAgICAgICAgICAgICBuZXh0SW5kZXggPSAwO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5jaGFuZ2VQYWdlKG5leHRJbmRleCk7XG4gICAgfTtcbiAgICByZW5kZXIoKSB7XG4gICAgICAgIGNvbnN0IHsgc2VsZWN0ZWRJbmRleCB9ID0gdGhpcy5zdGF0ZTtcbiAgICAgICAgY29uc3QgeyBjaGlsZHJlbiwgdGhlbWUsIHNlbGVjdGVkSW5kZXg6IF8wLCBkZWZhdWx0SW5kZXg6IF8xLCBvblBhZ2VDaGFuZ2U6IF8yLCBidWxsZXRzQ29udGFpbmVyOiBDdXN0b21CdWxsZXRzQ29udGFpbmVyLCBidWxsZXQ6IEN1c3RvbUJ1bGxldCwgYXJyb3dzID0gZmFsc2UsIGluZmluaXRlID0gZmFsc2UsIG9wYXF1ZSA9IGZhbHNlLCAuLi5wcm9wcyB9ID0gdGhpcy5wcm9wcztcbiAgICAgICAgY29uc3QgY2hpbGRyZW5Db3VudCA9IFJlYWN0LkNoaWxkcmVuLmNvdW50KGNoaWxkcmVuKTtcbiAgICAgICAgY29uc3QgYnVsbGV0czogQXJyYXk8UmVhY3QuUmVhY3RDaGlsZD4gPSBbXTtcbiAgICAgICAgY29uc3QgaXRlbXM6IEFycmF5PFJlYWN0LlJlYWN0Q2hpbGQ+ID0gW107XG4gICAgICAgIGNvbnN0IHNlbGVjdHMgPSB0aGlzLnNlbGVjdHM7XG4gICAgICAgIGNvbnN0IEJ1bGxldHNDb250YWluZXIgPSBDdXN0b21CdWxsZXRzQ29udGFpbmVyIHx8IERlZmF1bHRCdWxsZXRzQ29udGFpbmVyO1xuICAgICAgICBjb25zdCBCdWxsZXQgPSBDdXN0b21CdWxsZXQgfHwgRGVmYXVsdEJ1bGxldDtcbiAgICAgICAgUmVhY3QuQ2hpbGRyZW4uZm9yRWFjaChjaGlsZHJlbiwgKGVsZW1lbnQsIGluZGV4KSA9PiB7XG4gICAgICAgICAgICBpZiAoZWxlbWVudCAmJiBSZWFjdC5pc1ZhbGlkRWxlbWVudChlbGVtZW50KSkge1xuICAgICAgICAgICAgICAgIGNvbnN0IGFjdGl2ZSA9IGluZGV4ID09PSBzZWxlY3RlZEluZGV4O1xuICAgICAgICAgICAgICAgIGlmIChzZWxlY3RzW2luZGV4XSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAgICAgICAgIHNlbGVjdHNbaW5kZXhdID0gKCkgPT4gdGhpcy5jaGFuZ2VQYWdlKGluZGV4KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgYnVsbGV0cy5wdXNoKDxCdWxsZXQgdGhlbWU9e3RoZW1lfSBrZXk9e2BidWxsZXQtJHtpbmRleH1gfSBhY3RpdmU9e2FjdGl2ZX0gaW5kZXg9e2luZGV4fSBvbkNsaWNrPXtzZWxlY3RzW2luZGV4XX0vPik7XG4gICAgICAgICAgICAgICAgaXRlbXMucHVzaCg8UGFnZUl0ZW0ga2V5PXtgaXRlbS0ke2luZGV4fWB9PntlbGVtZW50fTwvUGFnZUl0ZW0+KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIGNvbnN0IGRpc2FibGVMZWZ0ID0gIWluZmluaXRlICYmIHNlbGVjdGVkSW5kZXggPCAxO1xuICAgICAgICBjb25zdCBkaXNhYmxlUmlnaHQgPSAhaW5maW5pdGUgJiYgc2VsZWN0ZWRJbmRleCA+IGNoaWxkcmVuQ291bnQgLSAyO1xuICAgICAgICByZXR1cm4gKDxSb290Q29udGFpbmVyIHsuLi5wcm9wc30gb25LZXlEb3duPXt0aGlzLmhhbmRsZUtleURvd259IHRhYkluZGV4PXswfT5cbiAgICAgICAgPE1hc2s+XG4gICAgICAgICAgPEludGVyYWN0aXZlU3VyZmFjZSB0aGVtZT17dGhlbWV9IG9uQ2hhbmdlPXt0aGlzLmRyYWdUaWxlfSBvcGFxdWU9e29wYXF1ZX0+XG4gICAgICAgICAgICA8UGFnZXNDb250YWluZXIgcmVmPXtub2RlID0+ICh0aGlzLnBhZ2VzQ29udGFpbmVyID0gbm9kZSl9IHNlbGVjdGVkSW5kZXg9e3NlbGVjdGVkSW5kZXh9PlxuICAgICAgICAgICAgICB7aXRlbXN9XG4gICAgICAgICAgICA8L1BhZ2VzQ29udGFpbmVyPlxuICAgICAgICAgIDwvSW50ZXJhY3RpdmVTdXJmYWNlPlxuICAgICAgICAgIHthcnJvd3MgJiYgKDxkaXY+XG4gICAgICAgICAgICAgIDxBcnJvd0xlZnQgb25DbGljaz17dGhpcy5zd2lwZUxlZnR9IGRpc2FibGVkPXtkaXNhYmxlTGVmdH0gdHlwZT1cImJ1dHRvblwiPlxuICAgICAgICAgICAgICAgIDxJY29uIG5hbWU9XCJLZXlib2FyZEFycm93TGVmdFwiIHNpemU9ezJ9Lz5cbiAgICAgICAgICAgICAgPC9BcnJvd0xlZnQ+XG4gICAgICAgICAgICAgIDxBcnJvd1JpZ2h0IG9uQ2xpY2s9e3RoaXMuc3dpcGVSaWdodH0gZGlzYWJsZWQ9e2Rpc2FibGVSaWdodH0gdHlwZT1cImJ1dHRvblwiPlxuICAgICAgICAgICAgICAgIDxJY29uIG5hbWU9XCJLZXlib2FyZEFycm93UmlnaHRcIiBzaXplPXsyfS8+XG4gICAgICAgICAgICAgIDwvQXJyb3dSaWdodD5cbiAgICAgICAgICAgIDwvZGl2Pil9XG4gICAgICAgIDwvTWFzaz5cbiAgICAgICAgPEJ1bGxldHNDb250YWluZXI+e2J1bGxldHN9PC9CdWxsZXRzQ29udGFpbmVyPlxuICAgICAgPC9Sb290Q29udGFpbmVyPik7XG4gICAgfVxuICAgIHN0YXRpYyBpbm5lciA9IHtcbiAgICAgICAgZ2V0IFBhZ2VJdGVtKCkgeyByZXR1cm4gUGFnZUl0ZW0gYXMgdHlwZW9mIFBhZ2VJdGVtOyB9LFxuICAgICAgICBnZXQgUm9vdENvbnRhaW5lcigpIHsgcmV0dXJuIFJvb3RDb250YWluZXIgYXMgdHlwZW9mIFJvb3RDb250YWluZXI7IH0sXG4gICAgICAgIGdldCBNYXNrKCkgeyByZXR1cm4gTWFzayBhcyB0eXBlb2YgTWFzazsgfSxcbiAgICAgICAgZ2V0IEludGVyYWN0aXZlU3VyZmFjZSgpIHsgcmV0dXJuIEludGVyYWN0aXZlU3VyZmFjZSBhcyB0eXBlb2YgSW50ZXJhY3RpdmVTdXJmYWNlOyB9LFxuICAgICAgICBnZXQgUGFnZXNDb250YWluZXIoKSB7IHJldHVybiBQYWdlc0NvbnRhaW5lciBhcyB0eXBlb2YgUGFnZXNDb250YWluZXI7IH0sXG4gICAgICAgIGdldCBBcnJvd0xlZnQoKSB7IHJldHVybiBBcnJvd0xlZnQgYXMgdHlwZW9mIEFycm93TGVmdDsgfSxcbiAgICAgICAgZ2V0IEljb24oKSB7IHJldHVybiBJY29uIGFzIHR5cGVvZiBJY29uOyB9LFxuICAgICAgICBnZXQgQXJyb3dSaWdodCgpIHsgcmV0dXJuIEFycm93UmlnaHQgYXMgdHlwZW9mIEFycm93UmlnaHQ7IH1cbiAgICB9O1xufVxuIl19