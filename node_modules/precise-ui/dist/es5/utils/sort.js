"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
function compareGeneralNormal(a, b) {
    return a < b;
}
function compareGeneralReverse(a, b) {
    return b < a;
}
function compareArrayNormal(a, b) {
    // treat empty array like undefined
    var aIsUndefined = !a || a.length === 0;
    var bIsUndefined = !b || b.length === 0;
    if (aIsUndefined && bIsUndefined) {
        return false;
    }
    else {
        if (aIsUndefined) {
            return false;
        }
        else if (bIsUndefined) {
            return true;
        }
        else {
            return !!a && !!b && a < b; // double checking for not undefined is needed to satisfy typescript
        }
    }
}
exports.compareArrayNormal = compareArrayNormal;
function compareArrayReverse(a, b) {
    return compareArrayNormal(b, a);
}
function compareStringNormal(a, b) {
    if (!a && !b) {
        return false;
    }
    else {
        if (!a) {
            return false;
        }
        else if (!b) {
            return true;
        }
        else {
            return a.localeCompare(b) === -1;
        }
    }
}
function compareStringReverse(a, b) {
    if (!a && !b) {
        return false;
    }
    else {
        if (!b) {
            return true;
        }
        else if (!a) {
            return false;
        }
        else {
            return b.localeCompare(a) === -1;
        }
    }
}
function compareNumberNormal(a, b) {
    if (a === b) {
        return false;
    }
    if (a === 0) {
        return !b || a < b;
    }
    if (!a) {
        return false;
    }
    if (!b && b !== 0) {
        return true;
    }
    return a < b;
}
exports.compareNumberNormal = compareNumberNormal;
function compareNumberReverse(a, b) {
    return compareNumberNormal(b, a);
}
function getComparer(exampleValue, reverse) {
    if (typeof exampleValue === 'string') {
        return reverse ? compareStringReverse : compareStringNormal;
    }
    if (typeof exampleValue === 'number') {
        return reverse ? compareNumberReverse : compareNumberNormal;
    }
    if (Array.isArray(exampleValue)) {
        return reverse ? compareArrayReverse : compareArrayNormal;
    }
    return reverse ? compareGeneralReverse : compareGeneralNormal;
}
function getCombinedComparer(keyValues, groupValues, reverse) {
    var hasGroups = groupValues && groupValues.length;
    var keycomparer = getComparer(keyValues.find(function (item) { return !!item; }), reverse);
    if (hasGroups) {
        var groupcomparer_1 = getComparer(groupValues.find(function (item) { return !!item; }), false); // Group order is always ascending
        return function (a, b) {
            return groupcomparer_1(groupValues[a], groupValues[b]) ||
                (groupValues[a] === groupValues[b] && keycomparer(keyValues[a], keyValues[b]));
        };
    }
    else {
        return function (a, b) { return keycomparer(keyValues[a], keyValues[b]); };
    }
}
function sorter(indices, items, key, groupBy, reverse) {
    if (reverse === void 0) { reverse = false; }
    var keyValues = items.map(function (item) { return item[key]; });
    var n = keyValues.length;
    if (n > 1) {
        var groupValues = groupBy ? items.map(function (item) { return item[groupBy]; }) : [];
        var comparer = getCombinedComparer(keyValues, groupValues, reverse);
        for (var i = 1; i < n; i++) {
            for (var j = 0; j < i; j++) {
                var ij = indices[j];
                var ii = indices[i];
                if (comparer(ii, ij)) {
                    indices[i] = ij;
                    indices[j] = ii;
                }
            }
        }
    }
}
function sortObjectList(items, sortBy, order, groupBy) {
    if (order === void 0) { order = 'ascending'; }
    var result = items.map(function (_, index) { return index; });
    if (sortBy) {
        sorter(result, items, sortBy, groupBy, order === 'descending');
    }
    else if (groupBy) {
        sorter(result, items, groupBy, undefined, order === 'descending');
    }
    return result;
}
exports.sortObjectList = sortObjectList;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic29ydC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy91dGlscy9zb3J0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsU0FBUyxvQkFBb0IsQ0FBQyxDQUFNLEVBQUUsQ0FBTTtJQUMxQyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUM7QUFDZixDQUFDO0FBRUQsU0FBUyxxQkFBcUIsQ0FBQyxDQUFNLEVBQUUsQ0FBTTtJQUMzQyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUM7QUFDZixDQUFDO0FBRUQsU0FBZ0Isa0JBQWtCLENBQUMsQ0FBeUIsRUFBRSxDQUF5QjtJQUNyRixtQ0FBbUM7SUFDbkMsSUFBTSxZQUFZLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLE1BQU0sS0FBSyxDQUFDLENBQUM7SUFDMUMsSUFBTSxZQUFZLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLE1BQU0sS0FBSyxDQUFDLENBQUM7SUFFMUMsSUFBSSxZQUFZLElBQUksWUFBWSxFQUFFO1FBQ2hDLE9BQU8sS0FBSyxDQUFDO0tBQ2Q7U0FBTTtRQUNMLElBQUksWUFBWSxFQUFFO1lBQ2hCLE9BQU8sS0FBSyxDQUFDO1NBQ2Q7YUFBTSxJQUFJLFlBQVksRUFBRTtZQUN2QixPQUFPLElBQUksQ0FBQztTQUNiO2FBQU07WUFDTCxPQUFPLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsb0VBQW9FO1NBQ2pHO0tBQ0Y7QUFDSCxDQUFDO0FBaEJELGdEQWdCQztBQUVELFNBQVMsbUJBQW1CLENBQUMsQ0FBeUIsRUFBRSxDQUF5QjtJQUMvRSxPQUFPLGtCQUFrQixDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztBQUNsQyxDQUFDO0FBRUQsU0FBUyxtQkFBbUIsQ0FBQyxDQUFxQixFQUFFLENBQXFCO0lBQ3ZFLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFD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QUFDLEVBQUUsRUFBRTtZQUMxQixLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFO2dCQUMxQixJQUFNLEVBQUUsR0FBRyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQ3RCLElBQU0sRUFBRSxHQUFHLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFFdEIsSUFBSSxRQUFRLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FBQyxFQUFFO29CQUNwQixPQUFPLENBQUMsQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDO29CQUNoQixPQUFPLENBQUMsQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDO2lCQUNqQjthQUNGO1NBQ0Y7S0FDRjtBQUNILENBQUM7QUFFRCxTQUFnQixjQUFjLENBQzVCLEtBQWUsRUFDZixNQUFnQixFQUNoQixLQUErQyxFQUMvQyxPQUFpQjtJQURqQixzQkFBQSxFQUFBLG1CQUErQztJQUcvQyxJQUFNLE1BQU0sR0FBRyxLQUFLLENBQUMsR0FBRyxDQUFDLFVBQUMsQ0FBQyxFQUFFLEtBQUssSUFBSyxPQUFBLEtBQUssRUFBTCxDQUFLLENBQUMsQ0FBQztJQUU5QyxJQUFJLE1BQU0sRUFBRTtRQUNWLE1BQU0sQ0FBQyxNQUFNLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRSxPQUFPLEVBQUUsS0FBSyxLQUFLLFlBQVksQ0FBQyxDQUFDO0tBQ2hFO1NBQU0sSUFBSSxPQUFPLEVBQUU7UUFDbEIsTUFBTSxDQUFDLE1BQU0sRUFBRSxLQUFLLEVBQUUsT0FBTyxFQUFFLFNBQVMsRUFBRSxLQUFLLEtBQUssWUFBWSxDQUFDLENBQUM7S0FDbkU7SUFFRCxPQUFPLE1BQU0sQ0FBQztBQUNoQixDQUFDO0FBZkQsd0NBZUMiLCJzb3VyY2VzQ29udGVudCI6WyJmdW5jdGlvbiBjb21wYXJlR2VuZXJhbE5vcm1hbChhOiBhbnksIGI6IGFueSkge1xuICByZXR1cm4gYSA8IGI7XG59XG5cbmZ1bmN0aW9uIGNvbXBhcmVHZW5lcmFsUmV2ZXJzZShhOiBhbnksIGI6IGFueSkge1xuICByZXR1cm4gYiA8IGE7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjb21wYXJlQXJyYXlOb3JtYWwoYTogQXJyYXk8YW55PiB8IHVuZGVmaW5lZCwgYjogQXJyYXk8YW55PiB8IHVuZGVmaW5lZCkge1xuICAvLyB0cmVhdCBlbXB0eSBhcnJheSBsaWtlIHVuZGVmaW5lZFxuICBjb25zdCBhSXNVbmRlZmluZWQgPSAhYSB8fCBhLmxlbmd0aCA9PT0gMDtcbiAgY29uc3QgYklzVW5kZWZpbmVkID0gIWIgfHwgYi5sZW5ndGggPT09IDA7XG5cbiAgaWYgKGFJc1VuZGVmaW5lZCAmJiBiSXNVbmRlZmluZWQpIHtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH0gZWxzZSB7XG4gICAgaWYgKGFJc1VuZGVmaW5lZCkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH0gZWxzZSBpZiAoYklzVW5kZWZpbmVkKSB7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuICEhYSAmJiAhIWIgJiYgYSA8IGI7IC8vIGRvdWJsZSBjaGVja2luZyBmb3Igbm90IHVuZGVmaW5lZCBpcyBuZWVkZWQgdG8gc2F0aXNmeSB0eXBlc2NyaXB0XG4gICAgfVxuICB9XG59XG5cbmZ1bmN0aW9uIGNvbXBhcmVBcnJheVJldmVyc2UoYTogQXJyYXk8YW55PiB8IHVuZGVmaW5lZCwgYjogQXJyYXk8YW55PiB8IHVuZGVmaW5lZCkge1xuICByZXR1cm4gY29tcGFyZUFycmF5Tm9ybWFsKGIsIGEpO1xufVxuXG5mdW5jdGlvbiBjb21wYXJlU3RyaW5nTm9ybWFsKGE6IHN0cmluZyB8IHVuZGVmaW5lZCwgYjogc3RyaW5nIHwgdW5kZWZpbmVkKSB7XG4gIGlmICghYSAmJiAhYikge1xuICAgIHJldHVybiBmYWxzZTtcbiAgfSBlbHNlIHtcbiAgICBpZiAoIWEpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9IGVsc2UgaWYgKCFiKSB7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIGEubG9jYWxlQ29tcGFyZShiKSA9PT0gLTE7XG4gICAgfVxuICB9XG59XG5cbmZ1bmN0aW9uIGNvbXBhcmVTdHJpbmdSZXZlcnNlKGE6IHN0cmluZyB8IHVuZGVmaW5lZCwgYjogc3RyaW5nIHwgdW5kZWZpbmVkKSB7XG4gIGlmICghYSAmJiAhYikge1xuICAgIHJldHVybiBmYWxzZTtcbiAgfSBlbHNlIHtcbiAgICBpZiAoIWIpIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH0gZWxzZSBpZiAoIWEpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIGIubG9jYWxlQ29tcGFyZShhKSA9PT0gLTE7XG4gICAgfVxuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjb21wYXJlTnVtYmVyTm9ybWFsKGE6IG51bWJlciB8IHVuZGVmaW5lZCwgYjogbnVtYmVyIHwgdW5kZWZpbmVkKTogYm9vbGVhbiB7XG4gIGlmIChhID09PSBiKSB7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgaWYgKGEgPT09IDApIHtcbiAgICByZXR1cm4gIWIgfHwgYSA8IGI7XG4gIH1cblxuICBpZiAoIWEpIHtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICBpZiAoIWIgJiYgYiAhPT0gMCkge1xuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgcmV0dXJuIGEgPCBiO1xufVxuXG5mdW5jdGlvbiBjb21wYXJlTnVtYmVyUmV2ZXJzZShhOiBudW1iZXIgfCB1bmRlZmluZWQsIGI6IG51bWJlciB8IHVuZGVmaW5lZCk6IGJvb2xlYW4ge1xuICByZXR1cm4gY29tcGFyZU51bWJlck5vcm1hbChiLCBhKTtcbn1cblxuZnVuY3Rpb24gZ2V0Q29tcGFyZXIoZXhhbXBsZVZhbHVlOiBhbnksIHJldmVyc2U6IGJvb2xlYW4pOiAoYTogYW55LCBiOiBhbnkpID0+IGJvb2xlYW4ge1xuICBpZiAodHlwZW9mIGV4YW1wbGVWYWx1ZSA9PT0gJ3N0cmluZycpIHtcbiAgICByZXR1cm4gcmV2ZXJzZSA/IGNvbXBhcmVTdHJpbmdSZXZlcnNlIDogY29tcGFyZVN0cmluZ05vcm1hbDtcbiAgfVxuXG4gIGlmICh0eXBlb2YgZXhhbXBsZVZhbHVlID09PSAnbnVtYmVyJykge1xuICAgIHJldHVybiByZXZlcnNlID8gY29tcGFyZU51bWJlclJldmVyc2UgOiBjb21wYXJlTnVtYmVyTm9ybWFsO1xuICB9XG5cbiAgaWYgKEFycmF5LmlzQXJyYXkoZXhhbXBsZVZhbHVlKSkge1xuICAgIHJldHVybiByZXZlcnNlID8gY29tcGFyZUFycmF5UmV2ZXJzZSA6IGNvbXBhcmVBcnJheU5vcm1hbDtcbiAgfVxuXG4gIHJldHVybiByZXZlcnNlID8gY29tcGFyZUdlbmVyYWxSZXZlcnNlIDogY29tcGFyZUdlbmVyYWxOb3JtYWw7XG59XG5cbmZ1bmN0aW9uIGdldENvbWJpbmVkQ29tcGFyZXI8VD4oa2V5VmFsdWVzOiBBcnJheTxUW2tleW9mIFRdPiwgZ3JvdXBWYWx1ZXM6IEFycmF5PFRba2V5b2YgVF0+LCByZXZlcnNlOiBib29sZWFuKSB7XG4gIGNvbnN0IGhhc0dyb3VwcyA9IGdyb3VwVmFsdWVzICYmIGdyb3VwVmFsdWVzLmxlbmd0aDtcbiAgY29uc3Qga2V5Y29tcGFyZXIgPSBnZXRDb21wYXJlcihrZXlWYWx1ZXMuZmluZChpdGVtID0+ICEhaXRlbSksIHJldmVyc2UpO1xuXG4gIGlmIChoYXNHcm91cHMpIHtcbiAgICBjb25zdCBncm91cGNvbXBhcmVyID0gZ2V0Q29tcGFyZXIoZ3JvdXBWYWx1ZXMuZmluZChpdGVtID0+ICEhaXRlbSksIGZhbHNlKTsgLy8gR3JvdXAgb3JkZXIgaXMgYWx3YXlzIGFzY2VuZGluZ1xuXG4gICAgcmV0dXJuIChhOiBudW1iZXIsIGI6IG51bWJlcikgPT5cbiAgICAgIGdyb3VwY29tcGFyZXIoZ3JvdXBWYWx1ZXNbYV0sIGdyb3VwVmFsdWVzW2JdKSB8fFxuICAgICAgKGdyb3VwVmFsdWVzW2FdID09PSBncm91cFZhbHVlc1tiXSAmJiBrZXljb21wYXJlcihrZXlWYWx1ZXNbYV0sIGtleVZhbHVlc1tiXSkpO1xuICB9IGVsc2Uge1xuICAgIHJldHVybiAoYTogbnVtYmVyLCBiOiBudW1iZXIpID0+IGtleWNvbXBhcmVyKGtleVZhbHVlc1thXSwga2V5VmFsdWVzW2JdKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBzb3J0ZXI8VCBleHRlbmRzIHt9PihcbiAgaW5kaWNlczogQXJyYXk8bnVtYmVyPixcbiAgaXRlbXM6IEFycmF5PFQ+LFxuICBrZXk6IGtleW9mIFQsXG4gIGdyb3VwQnk/OiBrZXlvZiBULFxuICByZXZlcnNlID0gZmFsc2UsXG4pIHtcbiAgY29uc3Qga2V5VmFsdWVzID0gaXRlbXMubWFwKGl0ZW0gPT4gaXRlbVtrZXldKTtcbiAgY29uc3QgbiA9IGtleVZhbHVlcy5sZW5ndGg7XG5cbiAgaWYgKG4gPiAxKSB7XG4gICAgY29uc3QgZ3JvdXBWYWx1ZXMgPSBncm91cEJ5ID8gaXRlbXMubWFwKGl0ZW0gPT4gaXRlbVtncm91cEJ5XSkgOiBbXTtcbiAgICBjb25zdCBjb21wYXJlciA9IGdldENvbWJpbmVkQ29tcGFyZXIoa2V5VmFsdWVzLCBncm91cFZhbHVlcywgcmV2ZXJzZSk7XG5cbiAgICBmb3IgKGxldCBpID0gMTsgaSA8IG47IGkrKykge1xuICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCBpOyBqKyspIHtcbiAgICAgICAgY29uc3QgaWogPSBpbmRpY2VzW2pdO1xuICAgICAgICBjb25zdCBpaSA9IGluZGljZXNbaV07XG5cbiAgICAgICAgaWYgKGNvbXBhcmVyKGlpLCBpaikpIHtcbiAgICAgICAgICBpbmRpY2VzW2ldID0gaWo7XG4gICAgICAgICAgaW5kaWNlc1tqXSA9IGlpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBzb3J0T2JqZWN0TGlzdDxUIGV4dGVuZHMge30+KFxuICBpdGVtczogQXJyYXk8VD4sXG4gIHNvcnRCeT86IGtleW9mIFQsXG4gIG9yZGVyOiAnYXNjZW5kaW5nJyB8ICdkZXNjZW5kaW5nJyA9ICdhc2NlbmRpbmcnLFxuICBncm91cEJ5Pzoga2V5b2YgVCxcbikge1xuICBjb25zdCByZXN1bHQgPSBpdGVtcy5tYXAoKF8sIGluZGV4KSA9PiBpbmRleCk7XG5cbiAgaWYgKHNvcnRCeSkge1xuICAgIHNvcnRlcihyZXN1bHQsIGl0ZW1zLCBzb3J0QnksIGdyb3VwQnksIG9yZGVyID09PSAnZGVzY2VuZGluZycpO1xuICB9IGVsc2UgaWYgKGdyb3VwQnkpIHtcbiAgICBzb3J0ZXIocmVzdWx0LCBpdGVtcywgZ3JvdXBCeSwgdW5kZWZpbmVkLCBvcmRlciA9PT0gJ2Rlc2NlbmRpbmcnKTtcbiAgfVxuXG4gIHJldHVybiByZXN1bHQ7XG59XG4iXX0=