"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var React = require("react");
function checkAllocation(layout, row, col, rowSpan, colSpan) {
    var allocations = layout.allocations, flexCols = layout.flexCols, flexRows = layout.flexRows;
    for (var r = row, l = row + rowSpan; r < l; r++) {
        if (r >= allocations.length && !flexRows) {
            return false;
        }
        var allocation = allocations[r];
        for (var c = col, l_1 = col + colSpan; c < l_1; c++) {
            if (allocation) {
                if ((c >= allocation.length && !flexCols) || allocation[c]) {
                    return false;
                }
            }
        }
    }
    return true;
}
exports.checkAllocation = checkAllocation;
function findAllocation(layout, proposedAllocation) {
    if (proposedAllocation === void 0) { proposedAllocation = {}; }
    var _a = proposedAllocation.colSpan, colSpan = _a === void 0 ? 1 : _a, _b = proposedAllocation.rowSpan, rowSpan = _b === void 0 ? 1 : _b, row = proposedAllocation.row, col = proposedAllocation.column;
    if (row === undefined || col === undefined) {
        var allocations = layout.allocations, flexCols = layout.flexCols, flexRows = layout.flexRows;
        var infty = Number.POSITIVE_INFINITY;
        var maxRows = flexRows ? infty : allocations.length - 1;
        var maxCols = flexCols ? infty : allocations[0].length - 1;
        for (var r = row || 0; r <= (row || maxRows); r++) {
            for (var c = col || 0; c <= (col || maxCols); c++) {
                if (checkAllocation(layout, r, c, rowSpan, colSpan)) {
                    return {
                        ci: c,
                        cf: c + colSpan,
                        ri: r,
                        rf: r + rowSpan,
                    };
                }
            }
        }
    }
    else {
        return {
            ci: col,
            cf: col + colSpan,
            ri: row,
            rf: row + rowSpan,
        };
    }
    return undefined;
}
exports.findAllocation = findAllocation;
function updateAllocation(allocations, allocation) {
    while (allocations.length < allocation.ri) {
        appendRow(allocations);
    }
    while (allocations[0].length < allocation.ci) {
        appendColumn(allocations);
    }
    for (var row = allocation.ri; row < allocation.rf; row++) {
        if (row === allocations.length) {
            appendRow(allocations);
        }
        for (var col = allocation.ci; col < allocation.cf; col++) {
            if (col === allocations[0].length) {
                appendColumn(allocations);
            }
            allocations[row][col] = true;
        }
    }
}
exports.updateAllocation = updateAllocation;
function createAllocations(dim) {
    var allocations = [];
    var rows = Array.isArray(dim.rows) ? dim.rows.length : dim.rows || 1;
    var cols = Array.isArray(dim.columns) ? dim.columns.length : dim.columns || 1;
    for (var row = 0; row < rows; ++row) {
        var allocation = createRow(cols);
        allocations.push(allocation);
    }
    return {
        allocations: allocations,
        flexRows: dim.rows === undefined && dim.columns !== undefined,
        flexCols: dim.columns === undefined,
    };
}
exports.createAllocations = createAllocations;
function appendColumn(allocations) {
    for (var _i = 0, allocations_1 = allocations; _i < allocations_1.length; _i++) {
        var row = allocations_1[_i];
        row.push(false);
    }
}
function appendRow(allocations) {
    var newRow = createRow(allocations[0].length);
    allocations.push(newRow);
}
function createRow(cols) {
    var allocation = [];
    for (var col = 0; col < cols; ++col) {
        allocation.push(false);
    }
    return allocation;
}
function createCell(layout, proposed) {
    if (!proposed.hidden) {
        var foundAllocation = findAllocation(layout, proposed);
        if (foundAllocation) {
            updateAllocation(layout.allocations, foundAllocation);
            return {
                column: foundAllocation.ci,
                row: foundAllocation.ri,
                colSpan: foundAllocation.cf - foundAllocation.ci,
                rowSpan: foundAllocation.rf - foundAllocation.ri,
            };
        }
        return undefined;
    }
    return {
        column: 0,
        row: 0,
        colSpan: 0,
        rowSpan: 0,
    };
}
function calcLayout(children, dim) {
    var layout = createAllocations(dim);
    var cells = [];
    React.Children.forEach(children, function (child, index) {
        if (typeof child === 'object' && child) {
            var _a = child.props, row = _a.row, column = _a.column;
            if (row !== undefined && column !== undefined) {
                cells[index] = createCell(layout, child.props);
            }
        }
    });
    React.Children.forEach(children, function (child, index) {
        if (typeof child === 'object' && child && !cells[index]) {
            cells[index] = createCell(layout, child.props);
        }
    });
    return {
        cells: cells,
        rows: layout.allocations.length,
        columns: layout.allocations[0].length,
    };
}
exports.calcLayout = calcLayout;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ3JpZExheW91dC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy91dGlscy9ncmlkTGF5b3V0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsNkJBQStCO0FBb0QvQixTQUFnQixlQUFlLENBQzdCLE1BQTRCLEVBQzVCLEdBQVcsRUFDWCxHQUFXLEVBQ1gsT0FBZSxFQUNmLE9BQWU7SUFFUCxJQUFBLGdDQUFXLEVBQUUsMEJBQVEsRUFBRSwwQkFBUSxDQUFZO0lBRW5ELEtBQUssSUFBSSxDQUFDLEdBQUcsR0FBRyxFQUFFLENBQUMsR0FBRyxHQUFHLEdBQUcsT0FBTyxFQUFFLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUU7UUFDL0MsSUFBSSxDQUFDLElBQUksV0FBVyxDQUFDLE1BQU0sSUFBSSxDQUFDLFFBQVEsRUFBRTtZQUN4QyxPQUFPLEtBQUssQ0FBQztTQUNkO1FBRUQsSUFBTSxVQUFVLEdBQUcsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBRWxDLEtBQUssSUFBSSxDQUFDLEdBQUcsR0FBRyxFQUFFLEdBQUMsR0FBRyxHQUFHLEdBQUcsT0FBTyxFQUFFLENBQUMsR0FBRyxHQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUU7WUFDL0MsSUFBSSxVQUFVLEVBQUU7Z0JBQ2QsSUFBSSxDQUFDLENBQUMsSUFBSSxVQUFVLENBQUMsTUFBTSxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksVUFBVSxDQUFDLENBQUMsQ0FBQyxFQUFFO29CQUMxRCxPQUFPLEtBQUssQ0FBQztpQkFDZDthQUNGO1NBQ0Y7S0FDRjtJQUVELE9BQU8sSUFBSSxDQUFDO0FBQ2QsQ0FBQztBQTFCRCwwQ0EwQkM7QUFFRCxTQUFnQixjQUFjLENBQUMsTUFBNEIsRUFBRSxrQkFBZ0Q7SUFBaEQsbUNBQUEsRUFBQSx1QkFBZ0Q7SUFDbkcsSUFBQSwrQkFBVyxFQUFYLGdDQUFXLEVBQUUsK0JBQVcsRUFBWCxnQ0FBVyxFQUFFLDRCQUFH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Z0JBQXNDLEVBQXBDLFlBQUcsRUFBRSxrQkFBK0IsQ0FBQztZQUU3QyxJQUFJLEdBQUcsS0FBSyxTQUFTLElBQUksTUFBTSxLQUFLLFNBQVMsRUFBRTtnQkFDN0MsS0FBSyxDQUFDLEtBQUssQ0FBQyxHQUFHLFVBQVUsQ0FBQyxNQUFNLEVBQUcsS0FBYSxDQUFDLEtBQUssQ0FBQyxDQUFDO2FBQ3pEO1NBQ0Y7SUFDSCxDQUFDLENBQUMsQ0FBQztJQUVILEtBQUssQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLFFBQVEsRUFBRSxVQUFDLEtBQUssRUFBRSxLQUFLO1FBQzVDLElBQUksT0FBTyxLQUFLLEtBQUssUUFBUSxJQUFJLEtBQUssSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsRUFBRTtZQUN2RCxLQUFLLENBQUMsS0FBSyxDQUFDLEdBQUcsVUFBVSxDQUFDLE1BQU0sRUFBRyxLQUFhLENBQUMsS0FBSyxDQUFDLENBQUM7U0FDekQ7SUFDSCxDQUFDLENBQUMsQ0FBQztJQUVILE9BQU87UUFDTCxLQUFLLE9BQUE7UUFDTCxJQUFJLEVBQUUsTUFBTSxDQUFDLFdBQVcsQ0FBQyxNQUFNO1FBQy9CLE9BQU8sRUFBRSxNQUFNLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU07S0FDdEMsQ0FBQztBQUNKLENBQUM7QUF6QkQsZ0NBeUJDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgUmVhY3QgZnJvbSAncmVhY3QnO1xuXG5leHBvcnQgaW50ZXJmYWNlIEdyaWRDZWxsRGVmaW5pdGlvbiB7XG4gIC8qKlxuICAgKiBUaGUgb3B0aW9uYWwgbnVtYmVyIG9mIHNwYW5uZWQgY29sdW1ucy4gQnkgZGVmYXVsdCBvbmx5IDEgY29sdW1uIGlzIHNwYW5uZWQuXG4gICAqIEBkZWZhdWx0IDFcbiAgICovXG4gIGNvbFNwYW4/OiBudW1iZXI7XG4gIC8qKlxuICAgKiBUaGUgb3B0aW9uYWwgbnVtYmVyIG9mIHNwYW5uZWQgY29sdW1ucy4gQnkgZGVmYXVsdCBvbmx5IDEgcm93IGlzIHNwYW5uZWQuXG4gICAqIEBkZWZhdWx0IDFcbiAgICovXG4gIHJvd1NwYW4/OiBudW1iZXI7XG4gIC8qKlxuICAgKiBUaGUgMC1iYXNlZCBjb2x1bW4gd2hlcmUgdGhlIGFyZWEgc2hvdWxkIGJlIGRpc3BsYXllZC5cbiAgICovXG4gIGNvbHVtbj86IG51bWJlcjtcbiAgLyoqXG4gICAqIFRoZSAwLWJhc2VkIHJvdyB3aGVyZSB0aGUgYXJlYSBzaG91bGQgYmUgZGlzcGxheWVkLlxuICAgKi9cbiAgcm93PzogbnVtYmVyO1xuICAvKipcbiAgICogT3B0aW9uYWxseSBzZXRzIHRoZSB0aWxlIHRvIGJlIGhpZGRlbiwgc28gdGhhdCBpdCBkb2VzIG5vdCBjb25zdW1lIHNwYWNlLlxuICAgKi9cbiAgaGlkZGVuPzogYm9vbGVhbjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBHcmlkTGF5b3V0Q2VsbCB7XG4gIHJpOiBudW1iZXI7XG4gIHJmOiBudW1iZXI7XG4gIGNpOiBudW1iZXI7XG4gIGNmOiBudW1iZXI7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgR3JpZEFsbG9jYXRpb24ge1xuICBjb2x1bW46IG51bWJlcjtcbiAgcm93OiBudW1iZXI7XG4gIGNvbFNwYW46IG51bWJlcjtcbiAgcm93U3BhbjogbnVtYmVyO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEdyaWRBbGxvY2F0aW9uTGF5b3V0IHtcbiAgYWxsb2NhdGlvbnM6IEFycmF5PEFycmF5PGJvb2xlYW4+PjtcbiAgZmxleFJvd3M6IGJvb2xlYW47XG4gIGZsZXhDb2xzOiBib29sZWFuO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEdyaWREaW1lbnNpb24ge1xuICByb3dzPzogbnVtYmVyIHwgQXJyYXk8c3RyaW5nPjtcbiAgY29sdW1ucz86IG51bWJlciB8IEFycmF5PHN0cmluZz47XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjaGVja0FsbG9jYXRpb24oXG4gIGxheW91dDogR3JpZEFsbG9jYXRpb25MYXlvdXQsXG4gIHJvdzogbnVtYmVyLFxuICBjb2w6IG51bWJlcixcbiAgcm93U3BhbjogbnVtYmVyLFxuICBjb2xTcGFuOiBudW1iZXIsXG4pIHtcbiAgY29uc3QgeyBhbGxvY2F0aW9ucywgZmxleENvbHMsIGZsZXhSb3dzIH0gPSBsYXlvdXQ7XG5cbiAgZm9yIChsZXQgciA9IHJvdywgbCA9IHJvdyArIHJvd1NwYW47IHIgPCBsOyByKyspIHtcbiAgICBpZiAociA+PSBhbGxvY2F0aW9ucy5sZW5ndGggJiYgIWZsZXhSb3dzKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgY29uc3QgYWxsb2NhdGlvbiA9IGFsbG9jYXRpb25zW3JdO1xuXG4gICAgZm9yIChsZXQgYyA9IGNvbCwgbCA9IGNvbCArIGNvbFNwYW47IGMgPCBsOyBjKyspIHtcbiAgICAgIGlmIChhbGxvY2F0aW9uKSB7XG4gICAgICAgIGlmICgoYyA+PSBhbGxvY2F0aW9uLmxlbmd0aCAmJiAhZmxleENvbHMpIHx8IGFsbG9jYXRpb25bY10pIHtcbiAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICByZXR1cm4gdHJ1ZTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGZpbmRBbGxvY2F0aW9uKGxheW91dDogR3JpZEFsbG9jYXRpb25MYXlvdXQsIHByb3Bvc2VkQWxsb2NhdGlvbjogUGFydGlhbDxHcmlkQWxsb2NhdGlvbj4gPSB7fSkge1xuICBjb25zdCB7IGNvbFNwYW4gPSAxLCByb3dTcGFuID0gMSwgcm93LCBjb2x1bW46IGNvbCB9ID0gcHJvcG9zZWRBbGxvY2F0aW9uO1xuXG4gIGlmIChyb3cgPT09IHVuZGVmaW5lZCB8fCBjb2wgPT09IHVuZGVmaW5lZCkge1xuICAgIGNvbnN0IHsgYWxsb2NhdGlvbnMsIGZsZXhDb2xzLCBmbGV4Um93cyB9ID0gbGF5b3V0O1xuICAgIGNvbnN0IGluZnR5ID0gTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZO1xuICAgIGNvbnN0IG1heFJvd3MgPSBmbGV4Um93cyA/IGluZnR5IDogYWxsb2NhdGlvbnMubGVuZ3RoIC0gMTtcbiAgICBjb25zdCBtYXhDb2xzID0gZmxleENvbHMgPyBpbmZ0eSA6IGFsbG9jYXRpb25zWzBdLmxlbmd0aCAtIDE7XG5cbiAgICBmb3IgKGxldCByID0gcm93IHx8IDA7IHIgPD0gKHJvdyB8fCBtYXhSb3dzKTsgcisrKSB7XG4gICAgICBmb3IgKGxldCBjID0gY29sIHx8IDA7IGMgPD0gKGNvbCB8fCBtYXhDb2xzKTsgYysrKSB7XG4gICAgICAgIGlmIChjaGVja0FsbG9jYXRpb24obGF5b3V0LCByLCBjLCByb3dTcGFuLCBjb2xTcGFuKSkge1xuICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBjaTogYyxcbiAgICAgICAgICAgIGNmOiBjICsgY29sU3BhbixcbiAgICAgICAgICAgIHJpOiByLFxuICAgICAgICAgICAgcmY6IHIgKyByb3dTcGFuLFxuICAgICAgICAgIH07XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIGNpOiBjb2wsXG4gICAgICBjZjogY29sICsgY29sU3BhbixcbiAgICAgIHJpOiByb3csXG4gICAgICByZjogcm93ICsgcm93U3BhbixcbiAgICB9O1xuICB9XG5cbiAgcmV0dXJuIHVuZGVmaW5lZDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHVwZGF0ZUFsbG9jYXRpb24oYWxsb2NhdGlvbnM6IEFycmF5PEFycmF5PGJvb2xlYW4+PiwgYWxsb2NhdGlvbjogR3JpZExheW91dENlbGwpIHtcbiAgd2hpbGUgKGFsbG9jYXRpb25zLmxlbmd0aCA8IGFsbG9jYXRpb24ucmkpIHtcbiAgICBhcHBlbmRSb3coYWxsb2NhdGlvbnMpO1xuICB9XG5cbiAgd2hpbGUgKGFsbG9jYXRpb25zWzBdLmxlbmd0aCA8IGFsbG9jYXRpb24uY2kpIHtcbiAgICBhcHBlbmRDb2x1bW4oYWxsb2NhdGlvbnMpO1xuICB9XG5cbiAgZm9yIChsZXQgcm93ID0gYWxsb2NhdGlvbi5yaTsgcm93IDwgYWxsb2NhdGlvbi5yZjsgcm93KyspIHtcbiAgICBpZiAocm93ID09PSBhbGxvY2F0aW9ucy5sZW5ndGgpIHtcbiAgICAgIGFwcGVuZFJvdyhhbGxvY2F0aW9ucyk7XG4gICAgfVxuXG4gICAgZm9yIChsZXQgY29sID0gYWxsb2NhdGlvbi5jaTsgY29sIDwgYWxsb2NhdGlvbi5jZjsgY29sKyspIHtcbiAgICAgIGlmIChjb2wgPT09IGFsbG9jYXRpb25zWzBdLmxlbmd0aCkge1xuICAgICAgICBhcHBlbmRDb2x1bW4oYWxsb2NhdGlvbnMpO1xuICAgICAgfVxuXG4gICAgICBhbGxvY2F0aW9uc1tyb3ddW2NvbF0gPSB0cnVlO1xuICAgIH1cbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlQWxsb2NhdGlvbnMoZGltOiBHcmlkRGltZW5zaW9uKSB7XG4gIGNvbnN0IGFsbG9jYXRpb25zOiBBcnJheTxBcnJheTxib29sZWFuPj4gPSBbXTtcbiAgY29uc3Qgcm93cyA9IEFycmF5LmlzQXJyYXkoZGltLnJvd3MpID8gZGltLnJvd3MubGVuZ3RoIDogZGltLnJvd3MgfHwgMTtcbiAgY29uc3QgY29scyA9IEFycmF5LmlzQXJyYXkoZGltLmNvbHVtbnMpID8gZGltLmNvbHVtbnMubGVuZ3RoIDogZGltLmNvbHVtbnMgfHwgMTtcblxuICBmb3IgKGxldCByb3cgPSAwOyByb3cgPCByb3dzOyArK3Jvdykge1xuICAgIGNvbnN0IGFsbG9jYXRpb24gPSBjcmVhdGVSb3coY29scyk7XG4gICAgYWxsb2NhdGlvbnMucHVzaChhbGxvY2F0aW9uKTtcbiAgfVxuXG4gIHJldHVybiB7XG4gICAgYWxsb2NhdGlvbnMsXG4gICAgZmxleFJvd3M6IGRpbS5yb3dzID09PSB1bmRlZmluZWQgJiYgZGltLmNvbHVtbnMgIT09IHVuZGVmaW5lZCxcbiAgICBmbGV4Q29sczogZGltLmNvbHVtbnMgPT09IHVuZGVmaW5lZCxcbiAgfTtcbn1cblxuZnVuY3Rpb24gYXBwZW5kQ29sdW1uKGFsbG9jYXRpb25zOiBBcnJheTxBcnJheTxib29sZWFuPj4pIHtcbiAgZm9yIChjb25zdCByb3cgb2YgYWxsb2NhdGlvbnMpIHtcbiAgICByb3cucHVzaChmYWxzZSk7XG4gIH1cbn1cblxuZnVuY3Rpb24gYXBwZW5kUm93KGFsbG9jYXRpb25zOiBBcnJheTxBcnJheTxib29sZWFuPj4pIHtcbiAgY29uc3QgbmV3Um93ID0gY3JlYXRlUm93KGFsbG9jYXRpb25zWzBdLmxlbmd0aCk7XG4gIGFsbG9jYXRpb25zLnB1c2gobmV3Um93KTtcbn1cblxuZnVuY3Rpb24gY3JlYXRlUm93KGNvbHM6IG51bWJlcikge1xuICBjb25zdCBhbGxvY2F0aW9uOiBBcnJheTxib29sZWFuPiA9IFtdO1xuXG4gIGZvciAobGV0IGNvbCA9IDA7IGNvbCA8IGNvbHM7ICsrY29sKSB7XG4gICAgYWxsb2NhdGlvbi5wdXNoKGZhbHNlKTtcbiAgfVxuXG4gIHJldHVybiBhbGxvY2F0aW9uO1xufVxuXG5mdW5jdGlvbiBjcmVhdGVDZWxsKGxheW91dDogR3JpZEFsbG9jYXRpb25MYXlvdXQsIHByb3Bvc2VkOiBHcmlkQ2VsbERlZmluaXRpb24pOiBHcmlkQWxsb2NhdGlvbiB8IHVuZGVmaW5lZCB7XG4gIGlmICghcHJvcG9zZWQuaGlkZGVuKSB7XG4gICAgY29uc3QgZm91bmRBbGxvY2F0aW9uID0gZmluZEFsbG9jYXRpb24obGF5b3V0LCBwcm9wb3NlZCk7XG5cbiAgICBpZiAoZm91bmRBbGxvY2F0aW9uKSB7XG4gICAgICB1cGRhdGVBbGxvY2F0aW9uKGxheW91dC5hbGxvY2F0aW9ucywgZm91bmRBbGxvY2F0aW9uKTtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIGNvbHVtbjogZm91bmRBbGxvY2F0aW9uLmNpLFxuICAgICAgICByb3c6IGZvdW5kQWxsb2NhdGlvbi5yaSxcbiAgICAgICAgY29sU3BhbjogZm91bmRBbGxvY2F0aW9uLmNmIC0gZm91bmRBbGxvY2F0aW9uLmNpLFxuICAgICAgICByb3dTcGFuOiBmb3VuZEFsbG9jYXRpb24ucmYgLSBmb3VuZEFsbG9jYXRpb24ucmksXG4gICAgICB9O1xuICAgIH1cblxuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cblxuICByZXR1cm4ge1xuICAgIGNvbHVtbjogMCxcbiAgICByb3c6IDAsXG4gICAgY29sU3BhbjogMCxcbiAgICByb3dTcGFuOiAwLFxuICB9O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gY2FsY0xheW91dChjaGlsZHJlbjogUmVhY3QuUmVhY3ROb2RlLCBkaW06IEdyaWREaW1lbnNpb24pIHtcbiAgY29uc3QgbGF5b3V0ID0gY3JlYXRlQWxsb2NhdGlvbnMoZGltKTtcbiAgY29uc3QgY2VsbHM6IEFycmF5PEdyaWRBbGxvY2F0aW9uIHwgdW5kZWZpbmVkPiA9IFtdO1xuXG4gIFJlYWN0LkNoaWxkcmVuLmZvckVhY2goY2hpbGRyZW4sIChjaGlsZCwgaW5kZXgpID0+IHtcbiAgICBpZiAodHlwZW9mIGNoaWxkID09PSAnb2JqZWN0JyAmJiBjaGlsZCkge1xuICAgICAgY29uc3QgeyByb3csIGNvbHVtbiB9ID0gKGNoaWxkIGFzIGFueSkucHJvcHM7XG5cbiAgICAgIGlmIChyb3cgIT09IHVuZGVmaW5lZCAmJiBjb2x1bW4gIT09IHVuZGVmaW5lZCkge1xuICAgICAgICBjZWxsc1tpbmRleF0gPSBjcmVhdGVDZWxsKGxheW91dCwgKGNoaWxkIGFzIGFueSkucHJvcHMpO1xuICAgICAgfVxuICAgIH1cbiAgfSk7XG5cbiAgUmVhY3QuQ2hpbGRyZW4uZm9yRWFjaChjaGlsZHJlbiwgKGNoaWxkLCBpbmRleCkgPT4ge1xuICAgIGlmICh0eXBlb2YgY2hpbGQgPT09ICdvYmplY3QnICYmIGNoaWxkICYmICFjZWxsc1tpbmRleF0pIHtcbiAgICAgIGNlbGxzW2luZGV4XSA9IGNyZWF0ZUNlbGwobGF5b3V0LCAoY2hpbGQgYXMgYW55KS5wcm9wcyk7XG4gICAgfVxuICB9KTtcblxuICByZXR1cm4ge1xuICAgIGNlbGxzLFxuICAgIHJvd3M6IGxheW91dC5hbGxvY2F0aW9ucy5sZW5ndGgsXG4gICAgY29sdW1uczogbGF5b3V0LmFsbG9jYXRpb25zWzBdLmxlbmd0aCxcbiAgfTtcbn1cbiJdfQ==